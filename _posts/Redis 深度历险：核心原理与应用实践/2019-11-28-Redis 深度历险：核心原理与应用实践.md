---
layout: post
title:  Redis æ·±åº¦å†é™©ï¼šæ ¸å¿ƒåŸç†ä¸åº”ç”¨å®è·µ
categories: Redis
description: Redis æ·±åº¦å†é™©ï¼šæ ¸å¿ƒåŸç†ä¸åº”ç”¨å®è·µ
keywords: Redis
---
# å¼€ç¯‡ï¼šæˆäººä»¥é±¼ä¸è‹¥æˆäººä»¥æ¸” â€”â€” Redis å¯ä»¥ç”¨æ¥åšä»€ä¹ˆï¼Ÿ

Redis æ˜¯äº’è”ç½‘æŠ€æœ¯é¢†åŸŸä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„å­˜å‚¨ä¸­é—´ä»¶ï¼Œå®ƒæ˜¯ã€Œ**Re**mote **Di**ctionary **S**erviceã€çš„é¦–å­—æ¯ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯ã€Œè¿œç¨‹å­—å…¸æœåŠ¡ã€ã€‚Redis ä»¥å…¶è¶…é«˜çš„æ€§èƒ½ã€å®Œç¾çš„æ–‡æ¡£ã€ç®€æ´æ˜“æ‡‚çš„æºç å’Œä¸°å¯Œçš„å®¢æˆ·ç«¯åº“æ”¯æŒåœ¨å¼€æºä¸­é—´ä»¶é¢†åŸŸå¹¿å—å¥½è¯„ã€‚å›½å†…å¤–å¾ˆå¤šå¤§å‹äº’è”ç½‘å…¬å¸éƒ½åœ¨ä½¿ç”¨ Redisï¼Œæ¯”å¦‚ Twitterã€YouPornã€æš´é›ªå¨±ä¹ã€Githubã€StackOverflowã€è…¾è®¯ã€é˜¿é‡Œã€äº¬ä¸œã€åä¸ºã€æ–°æµªå¾®åšç­‰ç­‰ï¼Œå¾ˆå¤šä¸­å°å‹å…¬å¸ä¹Ÿéƒ½æœ‰åº”ç”¨ã€‚ä¹Ÿå¯ä»¥è¯´ï¼Œå¯¹ Redis çš„äº†è§£å’Œåº”ç”¨å®è·µå·²æˆä¸ºå½“ä¸‹ä¸­é«˜çº§åç«¯å¼€å‘è€…ç»•ä¸å¼€çš„å¿…å¤‡æŠ€èƒ½ã€‚

## ç”± Redis é¢è¯•æƒ³åˆ°çš„

åœ¨é¢è¯•åç«¯å·¥ç¨‹å¸ˆ Redis æŠ€èƒ½çš„æ—¶å€™ï¼Œé¢è¯•å®˜é€šå¸¸é—®çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯â€œRedis èƒ½ç”¨æ¥åšä»€ä¹ˆï¼Ÿâ€ï¼Œç¬¬ä¸€ä¸ªå›ç­”å¾€å¾€éƒ½ä¼šæ˜¯ã€Œç¼“å­˜ã€ã€‚ç¼“å­˜ç¡®å®æ˜¯ Redis ä½¿ç”¨æœ€å¤šçš„é¢†åŸŸï¼Œå®ƒç›¸æ¯” Memcache è€Œè¨€æ›´åŠ æ˜“äºç†è§£ã€ä½¿ç”¨å’Œæ§åˆ¶ã€‚

å¯æ˜¯å¦‚æœå†è¿›ä¸€æ­¥é—®â€œè¿˜æœ‰å‘¢ï¼Ÿâ€ï¼Œå¤§å¤šæ•°åŒå­¦å°±ä¼šå¼€å§‹çš±çœ‰å¤´ï¼Œåªæœ‰ä¸€å°éƒ¨åˆ†äººä¼šå›ç­”ã€Œåˆ†å¸ƒå¼é”ã€ã€‚å¦‚æœä½ å°±åˆ†å¸ƒå¼é”å†æ·±å…¥é—®ä¸‹å»ï¼Œä»–ä»¬åŸºæœ¬å°±ä¼šå¼€å§‹æ‘‡å¤´ï¼šæˆ‘ä»¬é¡¹ç›®é‡Œé¢ Redis çš„é”æ–¹æ³•éƒ½æ˜¯åˆ«äººï¼ˆåº”è¯¥æ˜¯æ¶æ„å¸ˆï¼‰å°è£…å¥½çš„ï¼Œæ‹¿è¿‡æ¥ç›´æ¥ä½¿ç”¨ï¼Œå†…éƒ¨ç»†èŠ‚æ²¡æœ‰å»äº†è§£è¿‡ï¼Œä¹Ÿæ²¡æœ‰å¿…è¦äº†è§£ã€‚

å¯¹ç±»ä¼¼çš„åœºæ™¯ï¼Œæˆ‘æ·±æœ‰ä½“ä¼šã€‚å› ä¸ºå…³äº Redis çš„é¢è¯•é¢˜ï¼Œä¹‹å‰å‡†å¤‡äº†å¾ˆå¤šï¼Œä½†æ˜¯çœŸæ­£èƒ½ç”¨ä¸Šçš„å´å¾ˆå°‘ã€‚å½“é¢è¯•çš„åŒå­¦é¢‘ç¹åœ°å›å¤ã€Œä¸çŸ¥é“ã€æ²¡ç”¨è¿‡ã€çš„æ—¶å€™ï¼Œå†ç»§ç»­æ·±å…¥è¿½é—®å·²ç»æ¯«æ— æ„ä¹‰ï¼Œè¿™æ—¶å€™å°±éœ€è¦åˆ‡æ¢è¯é¢˜äº†ã€‚å¶å°”é‡ä¸Šå‡ ä¸ªèƒ½æŒç»­å¾ˆå¤šå›åˆçš„åŒå­¦ï¼Œä»–ä»¬æ€»èƒ½ä½¿äººçœ¼å‰ä¸€äº®ã€‚å¦‚æœå†æ‹“å±•ä¸€ä¸‹å‘¨è¾¹çŸ¥è¯†ç‚¹ï¼Œå°±ä¼šå‘ç°è¿™äº›äººå¾€å¾€ä¹Ÿä¼šæœ‰æ‰€æ¶‰çŒï¼Œè¿™æ—¶æˆ‘åœ¨å¿ƒä¸­å·²ç»æš—æš—åœ°å¯¹è¿™ä½åŒå­¦ä¼¸å‡ºäº†å¤§æ‹‡æŒ‡ã€‚

è¿™æ ·çš„é¢è¯•ç»å†äº‹åä¹Ÿè®©æˆ‘æ·±åˆ»åæ€ï¼šæ¶æ„å¸ˆçš„æŠ€èƒ½å¾ˆé«˜ï¼Œå¯¹æå‡å›¢é˜Ÿç ”å‘æ•ˆç‡å¾ˆæœ‰å¸®åŠ©ï¼Œæˆ‘ä»¬éå¸¸é’¦ä½©å’Œç¾¡æ…•ã€‚ä½†æ˜¯æ™®é€šå¼€å‘è€…å¦‚æœä¹ æƒ¯äºåœ¨æ¶æ„å¸ˆå°è£…å¥½çš„ä¸œè¥¿ä¹‹ä¸Šï¼Œåªä¸“æ³¨äºåšä¸šåŠ¡å¼€å‘ï¼Œé‚£ä¹…è€Œä¹…ä¹‹ï¼Œåœ¨æŠ€æœ¯ç†è§£å’Œæˆé•¿ä¸Šå°±ä¼šå˜å¾—è¿Ÿé’ç”šè‡³éº»æœ¨ã€‚ä»è¿™ä¸ªè§’åº¦çœ‹ï¼Œæ¶æ„å¸ˆä¹Ÿå¯èƒ½æˆä¸ºæ™®é€šå¼€å‘è€…çš„â€œæ•Œäººâ€ï¼Œä»–çš„å¼ºå¤§èƒ½åŠ›ä¼šè®©å¤§å®¶å˜æˆâ€œæ¸©å®¤çš„èŠ±æœµâ€ï¼Œä¸€æ—¦é‡åˆ°ç¯å¢ƒå˜åŒ–å°±ä¼šä¸çŸ¥æ‰€æªã€‚

![](http://user-gold-cdn.xitu.io/2018/7/9/1647e75e1b3fba53?w=420&h=263&f=jpeg&s=30938)

å…¶å®å¾ˆå¤šä¸šåŠ¡åœºæ™¯ï¼Œå¦‚æœä»…ä»…æ˜¯ä¼šä½¿ç”¨æŸé¡¹æŠ€æœ¯ã€æ¡†æ¶ï¼Œé‚£æ˜¯å†ç®€å•ä¸è¿‡äº†ã€‚ä½†éšç€ä¸šåŠ¡å‘å±•ï¼Œç³»ç»Ÿçš„ç”¨æˆ·é‡ã€å¹¶å‘é‡æ¶¨ä¸Šæ¥ä¹‹åï¼Œç°æœ‰ç³»ç»Ÿçš„é—®é¢˜å°±ä¼šå±‚å‡ºä¸ç©·åœ°æš´éœ²å‡ºæ¥ã€‚å¦‚æœä¸èƒ½æ·±å…¥åœ°äº†è§£ç³»ç»Ÿã€æŠ€æœ¯å’Œæ¡†æ¶èƒŒåçš„æ·±å±‚åŸç†ï¼Œå¾ˆå¤šé—®é¢˜æ ¹æœ¬æ— æ³•ç†è§£åˆ°æœ¬è´¨ï¼Œæ›´è°ˆä¸ä¸Šè§£å†³ï¼Œä¸´æ—¶æŠ±ä½›è„šä¹Ÿäºäº‹æ— è¡¥ã€‚


æ‰€è°“ã€Œæˆäººä»¥é±¼ä¸è‹¥æˆäººä»¥æ¸”ã€ï¼Œæœ¬å°å†Œçš„åˆè¡·å’Œç›®æ ‡å°±æ˜¯å¸®åŠ©åç«¯å¼€å‘è€…è¾ƒä¸ºæ·±å…¥çš„ç†è§£ Redis èƒŒåçš„åŸç†å’Œå®è·µç»éªŒï¼Œåšåˆ°çŸ¥å…¶ç„¶ä¹ŸçŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œä¸ºæœªæ¥è¿›é˜¶æˆé•¿ä¸ºæ¶æ„å¸ˆåšå¥½å‡†å¤‡ã€‚

## å°å†Œçš„å†…å®¹èŒƒå›´

æœ¬å°å†Œä¸»è¦è®²è§£ç¬”è€…ä»å®æˆ˜ä¸­æ‘¸ç´¢æ€»ç»“çš„ Redis æœ€å¸¸ç”¨æœ€æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼Œä½†é™äºç¯‡å¹…å’Œç²¾åŠ›ï¼Œå¹¶æ²¡æœ‰æ¶µç›– Redis å…¨éƒ¨çš„å†…å®¹çŸ¥è¯†ç‚¹ï¼Œæ¯”å¦‚ Redis å†…ç½®çš„ Lua è„šæœ¬å¼•æ“å°±å®Œå…¨æ²¡æœ‰æåˆ°ã€‚ä¹‹æ‰€ä»¥ä¸è®²ï¼Œæ˜¯å› ä¸ºåœ¨å¹³æ—¶çš„å·¥ä½œä¸­ç¡®å®ä»æ¥æ²¡æœ‰ä½¿ç”¨è¿‡ï¼Œå®ƒå°±å¥½æ¯”å…³ç³»æ•°æ®åº“çš„å­˜å‚¨è¿‡ç¨‹ï¼Œè™½ç„¶åŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œä½†æ˜¯ç¡®å®å¾ˆå°‘ä½¿ç”¨ï¼Œè€Œä¸”ä¹Ÿä¸æ˜“ç»´æŠ¤ï¼Œæ‰€ä»¥å°±ä¸æ¨èè¯»è€…ä½¿ç”¨äº†ã€‚

å¯¹äºå¾ˆå¤šå°ä¼ä¸šæ¥è¯´ï¼Œæœ¬å°å†Œçš„å¾ˆå¤šå†…å®¹éƒ½æ˜¯ç”¨ä¸ä¸Šçš„ï¼Œå› ä¸ºç³»ç»Ÿçš„å¹¶å‘é‡æ²¡æœ‰åˆ°ä¸€å®šçš„é‡çº§ï¼Œè¿™äº›é«˜çº§åŠŸèƒ½æ ¹æœ¬æ²¡å¿…è¦ä½¿ç”¨ã€‚ä¸è¿‡æœºä¼šæ€»æ˜¯ç•™ç»™é‚£äº›æœ‰å‡†å¤‡çš„å­©å­ä»¬ï¼Œå¦‚æœçªç„¶æœ‰ä¸€å¤©æµé‡æ¶¨ä¸Šæ¥äº†ï¼ŒRedis çš„è¿™äº›ç¨€æœ‰çš„é«˜çº§åŠŸèƒ½åŠ¿å¿…èƒ½ç«‹å³æ´¾ä¸Šç”¨åœºã€‚

è¯»è€…ä»¬è‚¯å®šä¹Ÿæ³¨æ„åˆ°ï¼Œå°å†Œæ‰€æœ‰çš„æ ‡é¢˜éƒ½æœ‰ä½¿ç”¨ç‰¹å®šçš„æˆè¯­æ¥æè¿°ã€‚è¿™äº›æˆè¯­ä¸æ˜¯éšä¾¿å†™çš„ï¼Œè€Œæ˜¯ç²¾ç¡®è€ƒé‡äº†æˆè¯­çš„å«ä¹‰å’ŒæŠ€æœ¯ç‚¹çš„ç›¸å…³æ€§ç²¾å¿ƒæŒ‘é€‰å‡ºæ¥çš„ï¼Œç›¸ä¿¡è¯»è€…åœ¨ç†è§£äº†æ¯ä¸ªå°èŠ‚çš„å†…å®¹ä¹‹åï¼Œè‚¯å®šå¯ä»¥æ˜ç™½å†…å®¹å’Œæˆè¯­å«ä¹‰çš„ç›¸å…³æ€§ã€‚ä¹‹æ‰€ä»¥è¦ä½¿ç”¨æˆè¯­ä¹Ÿæ˜¯ä¸ºäº†åˆ¶é€ æ‚¬å¿µï¼Œå¸å¼•è¯»è€…æ¢ç©¶ä¸ºä»€ä¹ˆè¿™ä¸ªæŠ€æœ¯ç‚¹ä¼šå’Œè¿™ä¸ªæˆè¯­ç›¸å…³ã€‚è€é’±çš„è¯­æ–‡æ°´å¹³ä¸é«˜ï¼Œåœ¨é€‰æ‹©æˆè¯­æ—¶ï¼Œåå¤ä½¿ç”¨äº†æœç´¢å¼•æ“ã€‚å¦‚æœè¯»è€…æ‰¾åˆ°äº†æ›´è´´åˆ‡çš„æˆè¯­ï¼Œä¸€å®šè¦å³æ—¶åœ¨è¯„è®ºåŒºç•™è¨€å‘ŠçŸ¥ã€‚å¦‚æœè¢«é‡‡çº³ï¼Œä¼šè€ƒè™‘ç¦åˆ©åé¦ˆã€‚ğŸ˜„

å¥½äº†ï¼Œæ·±å…¥ç†è§£ Redis çš„å­¦ä¹ ä¹‹æ—…æ­£å¼å¼€å§‹ã€‚

## Redis å¯ä»¥åšä»€ä¹ˆï¼Ÿ

Redisçš„ä¸šåŠ¡åº”ç”¨èŒƒå›´éå¸¸å¹¿æ³›ï¼Œè®©æˆ‘ä»¬ä»¥æ˜é‡‘æŠ€æœ¯ç¤¾åŒºï¼ˆjuejin.imï¼‰çš„å¸–å­æ¨¡å—ä¸ºå®ä¾‹ï¼Œæ¢³ç†ä¸€ä¸‹ï¼ŒRedis å¯ä»¥ç”¨åœ¨å“ªäº›åœ°æ–¹ï¼Ÿ

![](https://user-gold-cdn.xitu.io/2018/7/10/1648240fd6997ada?w=679&h=156&f=png&s=35476)

1. è®°å½•å¸–å­çš„ç‚¹èµæ•°ã€è¯„è®ºæ•°å’Œç‚¹å‡»æ•° (hash)ã€‚
2. è®°å½•ç”¨æˆ·çš„å¸–å­ ID åˆ—è¡¨ (æ’åº)ï¼Œä¾¿äºå¿«é€Ÿæ˜¾ç¤ºç”¨æˆ·çš„å¸–å­åˆ—è¡¨ (zset)ã€‚
3. è®°å½•å¸–å­çš„æ ‡é¢˜ã€æ‘˜è¦ã€ä½œè€…å’Œå°é¢ä¿¡æ¯ï¼Œç”¨äºåˆ—è¡¨é¡µå±•ç¤º (hash)ã€‚
4. è®°å½•å¸–å­çš„ç‚¹èµç”¨æˆ· ID åˆ—è¡¨ï¼Œè¯„è®º ID åˆ—è¡¨ï¼Œç”¨äºæ˜¾ç¤ºå’Œå»é‡è®¡æ•° (zset)ã€‚
5. ç¼“å­˜è¿‘æœŸçƒ­å¸–å†…å®¹ (å¸–å­å†…å®¹ç©ºé—´å ç”¨æ¯”è¾ƒå¤§)ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ› (hash)ã€‚
6. è®°å½•å¸–å­çš„ç›¸å…³æ–‡ç«  IDï¼Œæ ¹æ®å†…å®¹æ¨èç›¸å…³å¸–å­ (list)ã€‚
7. å¦‚æœå¸–å­ ID æ˜¯æ•´æ•°è‡ªå¢çš„ï¼Œå¯ä»¥ä½¿ç”¨ Redis æ¥åˆ†é…å¸–å­ ID(è®¡æ•°å™¨)ã€‚
8. æ”¶è—é›†å’Œå¸–å­ä¹‹é—´çš„å…³ç³» (zset)ã€‚
9. è®°å½•çƒ­æ¦œå¸–å­ ID åˆ—è¡¨ï¼Œæ€»çƒ­æ¦œå’Œåˆ†ç±»çƒ­æ¦œ (zset)ã€‚
10. ç¼“å­˜ç”¨æˆ·è¡Œä¸ºå†å²ï¼Œè¿›è¡Œæ¶æ„è¡Œä¸ºè¿‡æ»¤ (zset,hash)ã€‚

å½“ç„¶ï¼Œå®é™…æƒ…å†µä¸‹éœ€æ±‚å¯èƒ½ä¹Ÿæ²¡è¿™ä¹ˆå¤šï¼Œå› ä¸ºåœ¨è¯·æ±‚å‹åŠ›ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œå¾ˆå¤šæ•°æ®éƒ½æ˜¯å¯ä»¥ç›´æ¥ä»æ•°æ®åº“ä¸­æŸ¥è¯¢çš„ã€‚ä½†è¯·æ±‚å‹åŠ›ä¸€å¤§ï¼Œä»¥å‰é€šè¿‡æ•°æ®åº“ç›´æ¥å­˜å–çš„æ•°æ®åˆ™å¿…é¡»è¦æŒªåˆ°ç¼“å­˜é‡Œæ¥ã€‚

ä»¥ä¸Šæåˆ°çš„åªæ˜¯ Redis çš„åŸºç¡€åº”ç”¨ï¼Œä¹Ÿæ˜¯æ—¥å¸¸å¼€å‘ä¸­æœ€å¸¸è§çš„åº”ç”¨ï¼ˆå¦‚æœä½ çš„ Redis åŸºç¡€å’Œç»éªŒä¸è¶³ï¼Œå¯èƒ½éœ€è¦é˜…è¯»å®Œä¸‹ä¸€èŠ‚ä¹‹åæ‰èƒ½å›è¿‡å¤´æ¥æ€è€ƒè¿™ä¸ªé—®é¢˜ï¼‰ã€‚é™¤äº†åŸºç¡€åº”ç”¨ä¹‹å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶å®ƒçš„ Redis é«˜çº§åº”ç”¨ï¼Œå¤§å¤šæ•°åŒå­¦å¯èƒ½ä»æœªæ¥è§¦è¿‡ï¼Œè¿™éƒ¨åˆ†æˆ‘ä¼šåœ¨åç»­çš„ç« èŠ‚ä¸­é™†ç»­è®²è§£ã€‚

## å°ç»“

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿‡ä¸€é Redis çš„åŸºç¡€çŸ¥è¯†ï¼Œè¿™éƒ¨åˆ†å†…å®¹ä¼°è®¡æœ¬å°å†Œå¤§å¤šæ•°è¯»è€…éƒ½å·²ç»éå¸¸äº†è§£ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿä¸æµªè´¹å¤ªå¤šç¬”å¢¨ï¼Œåªè®¡åˆ’ç”¨ä¸€èŠ‚çš„ç¯‡å¹…å¿«é€Ÿè®²å®Œã€‚å¦‚æœè¯»è€…å¯¹ Redis åŸºç¡€æ•°æ®ç»“æ„å·²ç»äº†ç„¶äºèƒ¸ï¼Œå¯ä»¥ç›´æ¥è·³åˆ°ä¸‹ä¸€ç« èŠ‚é˜…è¯» Redis çš„é«˜çº§çŸ¥è¯†ã€‚

å¦ï¼Œåœ¨é˜…è¯»å°å†Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœä½ è¢«æŸäº›ç« èŠ‚å¡ä½äº†ï¼Œä¸€ä¸‹ç†è§£ä¸äº†ï¼Œå¯ä»¥å…ˆæ·¡å®šçš„æ‘¸ç€èƒ¸å£å‘Šè¯‰è‡ªå·±â€œä¸è¦æ…Œï¼Œä¸€åˆ‡éƒ½æ˜¯æ­£å¸¸çš„ï¼â€ï¼Œç„¶åä¸´æ—¶è·³è¿‡å¹¶ç»§ç»­é˜…è¯»åé¢çš„ç« èŠ‚ã€‚ä½†è¯·å„ä½è¯»è€…åŠ¡å¿…åšæŒåˆ°æœ€åï¼Œç›¸ä¿¡ä½ ä¼šæ˜æ˜¾æ„Ÿå—åˆ°æŠ€æœ¯èƒ½åŠ›çš„å‡åã€‚**å¤§å®¶åŠ æ²¹**!â›½ï¸

## æ‰©å±•é˜…è¯»

#### 1. [ã€Šå¤©ä¸‹æ— éš¾è¯•ä¹‹ Redis é¢è¯•é¢˜åˆéš¾å¤§å…¨ã€‹](https://mp.weixin.qq.com/s/-y1zvqWEJ3Tt4h39Z0WBJg)
è¿™ç¯‡æ–‡ç« æ˜¯è€é’±ä¹‹å‰å°± Redis é¢è¯•æ€»ç»“çš„ä¸€ç¯‡åŸåˆ›åˆ†äº«ï¼Œä¾›å¤§å®¶å‚è€ƒé˜…è¯»ï¼Œè¿™ç¯‡æ–‡ç« ä¹Ÿè¢« IT æŠ€æœ¯åœˆå¤§å·ã€Œé«˜å¯ç”¨æ¶æ„ã€è½¬è½½ã€‚

#### 2. ã€ŠRedis ä½œè€… Antirez å…¶äººè¶£äº‹ï¼šä¸ºä»€ä¹ˆ Redis çš„é»˜è®¤ç«¯å£æ˜¯ 6379ï¼Ÿã€‹

![](https://user-gold-cdn.xitu.io/2018/7/20/164b579f0d98b52d?w=320&h=350&f=jpeg&s=38110)

Redis ç”±æ„å¤§åˆ©äºº Salvatore Sanfilippoï¼ˆç½‘å Antirezï¼‰ å¼€å‘ï¼Œä¸Šå›¾æ˜¯ä»–çš„ä¸ªäººç…§ç‰‡ã€‚Antirez ä¸ä»…å¸…çš„ä¸åƒå®åŠ›æ´¾ï¼Œä¹Ÿéå¸¸æœ‰è¶£ã€‚ä»–å‡ºç”Ÿåœ¨éè‹±è¯­ç³»å›½å®¶ï¼Œè‹±è¯­èƒ½åŠ›é•¿æœŸä»¥æ¥æ˜¯ä¸€ä¸ªçŸ­æ¿ï¼Œä»–æ›¾ç»ä¸“é—¨ä¸ºè‡ªå·±è¹©è„šçš„è‹±è¯­èƒ½åŠ›å†™è¿‡ä¸€ç¯‡åšæ–‡ã€Šè‹±è¯­ä¼¤ç—› 15 å¹´ã€‹ï¼Œç”¨è‡ªå·±çš„æˆé•¿ç»å†æ¥é¼“åŠ±é‚£äº›éè‹±è¯­ç³»çš„æŠ€æœ¯å¼€å‘è€…ä»¬åŠªåŠ›æ”»å…‹è‹±è¯­éš¾å…³ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/20/164b5954ba398db7?w=370&h=245&f=png&s=30220)

æˆ‘ä»¬éƒ½çŸ¥é“ Redis çš„é»˜è®¤ç«¯å£æ˜¯ 6379ï¼Œè¿™ä¸ªç«¯å£å·ä¹Ÿä¸æ˜¯éšæœºé€‰çš„ï¼Œè€Œæ˜¯ç”±æ‰‹æœºé”®ç›˜å­—æ¯ã€ŒMERZã€çš„ä½ç½®å†³å®šçš„ã€‚ã€ŒMERZã€åœ¨ Antirez çš„æœ‹å‹åœˆè¯­è¨€ä¸­æ˜¯ã€Œæ„šè ¢ã€çš„ä»£åè¯ï¼Œå®ƒæºäºæ„å¤§åˆ©å¹¿å‘Šå¥³éƒã€ŒAlessia Merzã€åœ¨ç”µè§†èŠ‚ç›®ä¸Šè¯´äº†ä¸€å †æ„šè ¢çš„è¯ï¼Œæƒ³åˆ°è¿™é‡Œæˆ‘ä¸ç¦å¼€å§‹æ„Ÿè§‰åˆ° Antirez çš„æœ‹å‹åœˆä¼¼ä¹æœ‰é‚£ä¹ˆç‚¹çŒ¥çã€‚ğŸ˜

Antirez ä»Šå¹´å·²ç»å››åå²äº†ï¼Œä¾æ—§åœ¨å­œå­œä¸å€¦åœ°å†™ä»£ç ï¼Œä¸º Redis çš„å¼€æºäº‹ä¸šæŒç»­è´¡çŒ®åŠ›é‡ã€‚

----

>ä¸‹é¢ä¸¤ç¯‡æ–‡ç« æ˜¯è€é’±åœ¨ç¿»é˜…äº† Redis ä½œè€… Antirez çš„æ—©æœŸåšå®¢ä¹‹åï¼ŒæŒ‘äº†å‡ ä¸ªæœ‰è¶£çš„æ•…äº‹åšäº†ç¿»è¯‘ï¼Œä¹Ÿåˆ†äº«ç»™å¹¿å¤§è¯»è€…ä»¬ã€‚
#### 3. [ã€Šæˆ‘ä¸º Redis æ‰¾åˆ°äº†ä¸€ä¸ªæ–°å®¶â€”â€” VMWareã€‹](https://juejin.im/post/5b55cba6f265da0fa00a1be7)

#### 4. [ã€ŠRedis ä½œè€… Antirez ç»å†çš„ã€Œæ€§åˆ«æ­§è§†ã€é£æ³¢ã€‹](https://juejin.im/post/5b580cc2e51d451915571071)
# åŸºç¡€ï¼šä¸‡ä¸ˆé«˜æ¥¼å¹³åœ°èµ· â€”â€” Redis åŸºç¡€æ•°æ®ç»“æ„

åƒé‡Œä¹‹è¡Œï¼Œå§‹äºè¶³ä¸‹ã€‚æœ¬èŠ‚æˆ‘ä»¬çš„å­¦ä¹ ç›®æ ‡æ˜¯ï¼šå¿«é€Ÿç†è§£å¹¶æŒæ¡ Redis çš„åŸºç¡€çŸ¥è¯†ã€‚

ç”±äºæœ¬èŠ‚å†…å®¹æ˜¯ Redis æœ€ç®€å•æœ€å®¹æ˜“æŒæ¡çš„çŸ¥è¯†ï¼Œå¦‚æœè¯»è€…å·²ç»å¾ˆç†Ÿæ‚‰ Redis çš„åŸºç¡€æ•°æ®ç»“æ„ï¼Œä»çæƒœç”Ÿå‘½çš„è§’åº¦å‡ºå‘ï¼Œä½ å¯ä»¥ç•¥è¿‡æœ¬èŠ‚å†…å®¹ï¼Œè·³åˆ°ä¸‹ä¸€èŠ‚ç»§ç»­é˜…è¯»ã€‚å¦‚æœä½ è§‰å¾—æœ¬èŠ‚çš„åŠ¨ç”»æœ‰ç‚¹æ™ƒçœ¼ï¼Œé˜…è¯»èµ·æ¥ä¸é‚£ä¹ˆèˆ’æœï¼Œå¯ä»¥çœ‹çœ‹ä½œè€…çš„å¦ä¸€ç¯‡æ–‡ç« [ã€ŠRedis æ•°æ®ç»“æ„åŸºç¡€æ•™ç¨‹ã€‹](https://juejin.im/post/5b53ee7e5188251aaa2d2e16)ã€‚

è¦ä½“éªŒ Redisï¼Œæˆ‘ä»¬å…ˆä» Redis å®‰è£…è¯´èµ·ã€‚

## Redis å®‰è£…
ä½“éªŒ Redis éœ€è¦ä½¿ç”¨ Linux æˆ–è€… Mac ç¯å¢ƒï¼Œå¦‚æœæ˜¯ Windows å¯ä»¥è€ƒè™‘ä½¿ç”¨è™šæ‹Ÿæœºã€‚ä¸»è¦æ–¹å¼æœ‰å››ç§ï¼š
1. ä½¿ç”¨ Docker å®‰è£…ã€‚
2. é€šè¿‡ Github æºç ç¼–è¯‘ã€‚
3. ç›´æ¥å®‰è£… apt-get install(Ubuntu)ã€yum install(RedHat) æˆ–è€… brew install(Mac)ã€‚
4. å¦‚æœè¯»è€…æ‡’äºå®‰è£…æ“ä½œï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç½‘é¡µç‰ˆçš„ [Web Redis](https://try.redis.io/) ç›´æ¥ä½“éªŒã€‚

å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š

**Docker æ–¹å¼**
```
# æ‹‰å– redis é•œåƒ
> docker pull redis
# è¿è¡Œ redis å®¹å™¨
> docker run --name myredis -d -p6379:6379 redis
# æ‰§è¡Œå®¹å™¨ä¸­çš„ redis-cliï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å‘½ä»¤è¡Œæ“ä½œ redis
> docker exec -it myredis redis-cli
```

**Github æºç ç¼–è¯‘æ–¹å¼**
```
# ä¸‹è½½æºç 
> git clone --branch 2.8 --depth 1 git@github.com:antirez/redis.git
> cd redis
# ç¼–è¯‘
> make
> cd src
# è¿è¡ŒæœåŠ¡å™¨ï¼Œdaemonizeè¡¨ç¤ºåœ¨åå°è¿è¡Œ
> ./redis-server --daemonize yes
# è¿è¡Œå‘½ä»¤è¡Œ
> ./redis-cli
```

**ç›´æ¥å®‰è£…æ–¹å¼**
```
# mac
> brew install redis
# ubuntu
> apt-get install redis
# redhat
> yum install redis
# è¿è¡Œå®¢æˆ·ç«¯
> redis-cli
```

## Redis åŸºç¡€æ•°æ®ç»“æ„
Redis æœ‰ 5 ç§åŸºç¡€æ•°æ®ç»“æ„ï¼Œåˆ†åˆ«ä¸ºï¼šstring (å­—ç¬¦ä¸²)ã€list (åˆ—è¡¨)ã€set (é›†åˆ)ã€hash (å“ˆå¸Œ) å’Œ zset (æœ‰åºé›†åˆ)ã€‚ç†Ÿç»ƒæŒæ¡è¿™ 5 ç§åŸºæœ¬æ•°æ®ç»“æ„çš„ä½¿ç”¨æ˜¯ Redis çŸ¥è¯†æœ€åŸºç¡€ä¹Ÿæœ€é‡è¦çš„éƒ¨åˆ†ï¼Œå®ƒä¹Ÿæ˜¯åœ¨ Redis é¢è¯•é¢˜ä¸­é—®åˆ°æœ€å¤šçš„å†…å®¹ã€‚

æœ¬èŠ‚å°†å¸¦é¢† Redis åˆå­¦è€…å¿«é€Ÿé€šå…³è¿™ 5 ç§åŸºæœ¬æ•°æ®ç»“æ„ã€‚è€ƒè™‘åˆ° Redis çš„å‘½ä»¤éå¸¸å¤šï¼Œè¿™é‡Œåªé€‰å–é‚£äº›æœ€å¸¸è§çš„æŒ‡ä»¤è¿›è¡Œè®²è§£ï¼Œå¦‚æœæœ‰é—æ¼å¸¸è§æŒ‡ä»¤ï¼Œè¯»è€…å¯ä»¥åœ¨è¯„è®ºå»ç•™è¨€ã€‚


## string (å­—ç¬¦ä¸²)

å­—ç¬¦ä¸² string æ˜¯ Redis æœ€ç®€å•çš„æ•°æ®ç»“æ„ã€‚Redis æ‰€æœ‰çš„æ•°æ®ç»“æ„éƒ½æ˜¯ä»¥å”¯ä¸€çš„ key å­—ç¬¦ä¸²ä½œä¸ºåç§°ï¼Œç„¶åé€šè¿‡è¿™ä¸ªå”¯ä¸€ key å€¼æ¥è·å–ç›¸åº”çš„ value æ•°æ®ã€‚ä¸åŒç±»å‹çš„æ•°æ®ç»“æ„çš„å·®å¼‚å°±åœ¨äº value çš„ç»“æ„ä¸ä¸€æ ·ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/2/16458d666d851a12?w=400&h=90&f=gif&s=8003)

å­—ç¬¦ä¸²ç»“æ„ä½¿ç”¨éå¸¸å¹¿æ³›ï¼Œä¸€ä¸ªå¸¸è§çš„ç”¨é€”å°±æ˜¯ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ã€‚æˆ‘ä»¬å°†ç”¨æˆ·ä¿¡æ¯ç»“æ„ä½“ä½¿ç”¨ JSON åºåˆ—åŒ–æˆå­—ç¬¦ä¸²ï¼Œç„¶åå°†åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²å¡è¿› Redis æ¥ç¼“å­˜ã€‚åŒæ ·ï¼Œå–ç”¨æˆ·ä¿¡æ¯ä¼šç»è¿‡ä¸€æ¬¡ååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚


![](https://user-gold-cdn.xitu.io/2018/7/24/164caaff402d2617?w=572&h=169&f=png&s=8854)

Redis çš„å­—ç¬¦ä¸²æ˜¯åŠ¨æ€å­—ç¬¦ä¸²ï¼Œæ˜¯å¯ä»¥ä¿®æ”¹çš„å­—ç¬¦ä¸²ï¼Œå†…éƒ¨ç»“æ„å®ç°ä¸Šç±»ä¼¼äº Java çš„ ArrayListï¼Œé‡‡ç”¨é¢„åˆ†é…å†—ä½™ç©ºé—´çš„æ–¹å¼æ¥å‡å°‘å†…å­˜çš„é¢‘ç¹åˆ†é…ï¼Œå¦‚å›¾ä¸­æ‰€ç¤ºï¼Œå†…éƒ¨ä¸ºå½“å‰å­—ç¬¦ä¸²å®é™…åˆ†é…çš„ç©ºé—´ capacity ä¸€èˆ¬è¦é«˜äºå®é™…å­—ç¬¦ä¸²é•¿åº¦ lenã€‚å½“å­—ç¬¦ä¸²é•¿åº¦å°äº 1M æ—¶ï¼Œæ‰©å®¹éƒ½æ˜¯åŠ å€ç°æœ‰çš„ç©ºé—´ï¼Œå¦‚æœè¶…è¿‡  1Mï¼Œæ‰©å®¹æ—¶ä¸€æ¬¡åªä¼šå¤šæ‰© 1M çš„ç©ºé—´ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å­—ç¬¦ä¸²æœ€å¤§é•¿åº¦ä¸º 512Mã€‚

**é”®å€¼å¯¹**
```
> set name codehole
OK
> get name
"codehole"
> exists name
(integer) 1
> del name
(integer) 1
> get name
(nil)
```

**æ‰¹é‡é”®å€¼å¯¹**

å¯ä»¥æ‰¹é‡å¯¹å¤šä¸ªå­—ç¬¦ä¸²è¿›è¡Œè¯»å†™ï¼ŒèŠ‚çœç½‘ç»œè€—æ—¶å¼€é”€ã€‚
```
> set name1 codehole
OK
> set name2 holycoder
OK
> mget name1 name2 name3 # è¿”å›ä¸€ä¸ªåˆ—è¡¨
1) "codehole"
2) "holycoder"
3) (nil)
> mset name1 boy name2 girl name3 unknown
> mget name1 name2 name3
1) "boy"
2) "girl"
3) "unknown"
```

**è¿‡æœŸå’Œ set å‘½ä»¤æ‰©å±•** 

å¯ä»¥å¯¹ key è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œåˆ°ç‚¹è‡ªåŠ¨åˆ é™¤ï¼Œè¿™ä¸ªåŠŸèƒ½å¸¸ç”¨æ¥æ§åˆ¶ç¼“å­˜çš„å¤±æ•ˆæ—¶é—´ã€‚ä¸è¿‡è¿™ä¸ªã€Œè‡ªåŠ¨åˆ é™¤ã€çš„æœºåˆ¶æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå¦‚æœä½ æ„Ÿå…´è¶£ï¼Œå¯ä»¥ç»§ç»­æ·±å…¥é˜…è¯»ç¬¬ 26 èŠ‚[ã€Šæœç”Ÿæš®æ­»â€”â€”è¿‡æœŸç­–ç•¥ã€‹](https://juejin.im/book/5afc2e5f6fb9a07a9b362527/section/5b4c42405188251b3950d251)
```
> set name codehole
> get name
"codehole"
> expire name 5  # 5s åè¿‡æœŸ
...  # wait for 5s
> get name
(nil)

> setex name 5 codehole  # 5s åè¿‡æœŸï¼Œç­‰ä»·äº set+expire
> get name
"codehole"
... # wait for 5s
> get name
(nil)

> setnx name codehole  # å¦‚æœ name ä¸å­˜åœ¨å°±æ‰§è¡Œ set åˆ›å»º
(integer) 1
> get name
"codehole"
> setnx name holycoder
(integer) 0  # å› ä¸º name å·²ç»å­˜åœ¨ï¼Œæ‰€ä»¥ set åˆ›å»ºä¸æˆåŠŸ
> get name
"codehole"  # æ²¡æœ‰æ”¹å˜
```

**è®¡æ•°** 

å¦‚æœ value å€¼æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œè¿˜å¯ä»¥å¯¹å®ƒè¿›è¡Œè‡ªå¢æ“ä½œã€‚è‡ªå¢æ˜¯æœ‰èŒƒå›´çš„ï¼Œå®ƒçš„èŒƒå›´æ˜¯ signed long çš„æœ€å¤§æœ€å°å€¼ï¼Œè¶…è¿‡äº†è¿™ä¸ªå€¼ï¼ŒRedis ä¼šæŠ¥é”™ã€‚

```
> set age 30
OK
> incr age
(integer) 31
> incrby age 5
(integer) 36
> incrby age -5
(integer) 31
> set codehole 9223372036854775807  # Long.Max
OK
> incr codehole
(error) ERR increment or decrement would overflow
```

å­—ç¬¦ä¸²æ˜¯ç”±å¤šä¸ªå­—èŠ‚ç»„æˆï¼Œæ¯ä¸ªå­—èŠ‚åˆæ˜¯ç”± 8 ä¸ª bit ç»„æˆï¼Œå¦‚æ­¤ä¾¿å¯ä»¥å°†ä¸€ä¸ªå­—ç¬¦ä¸²çœ‹æˆå¾ˆå¤š bit çš„ç»„åˆï¼Œè¿™ä¾¿æ˜¯ bitmapã€Œä½å›¾ã€æ•°æ®ç»“æ„ï¼Œä½å›¾çš„å…·ä½“ä½¿ç”¨ä¼šæ”¾åˆ°åé¢çš„ç« èŠ‚æ¥è®²ã€‚

å…³äºå­—ç¬¦ä¸²çš„å†…éƒ¨ç»“æ„å®ç°ï¼Œè¯·é˜…è¯»ç¬¬ 32 èŠ‚[ã€Šæåº¦æ·±å¯’ â€”â€” æ¢ç´¢ã€Œå­—ç¬¦ä¸²ã€å†…éƒ¨ã€‹](https://juejin.im/book/5afc2e5f6fb9a07a9b362527/section/5b5af9d96fb9a04f83465ada)

## list (åˆ—è¡¨)

Redis çš„åˆ—è¡¨ç›¸å½“äº Java è¯­è¨€é‡Œé¢çš„ LinkedListï¼Œæ³¨æ„å®ƒæ˜¯é“¾è¡¨è€Œä¸æ˜¯æ•°ç»„ã€‚è¿™æ„å‘³ç€ list çš„æ’å…¥å’Œåˆ é™¤æ“ä½œéå¸¸å¿«ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œä½†æ˜¯ç´¢å¼•å®šä½å¾ˆæ…¢ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼Œè¿™ç‚¹è®©äººéå¸¸æ„å¤–ã€‚

å½“åˆ—è¡¨å¼¹å‡ºäº†æœ€åä¸€ä¸ªå…ƒç´ ä¹‹åï¼Œè¯¥æ•°æ®ç»“æ„è‡ªåŠ¨è¢«åˆ é™¤ï¼Œå†…å­˜è¢«å›æ”¶ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/2/1645918c2cdf772e?w=484&h=120&f=gif&s=122736)

Redis çš„åˆ—è¡¨ç»“æ„å¸¸ç”¨æ¥åšå¼‚æ­¥é˜Ÿåˆ—ä½¿ç”¨ã€‚å°†éœ€è¦å»¶åå¤„ç†çš„ä»»åŠ¡ç»“æ„ä½“åºåˆ—åŒ–æˆå­—ç¬¦ä¸²å¡è¿› Redis çš„åˆ—è¡¨ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä»è¿™ä¸ªåˆ—è¡¨ä¸­è½®è¯¢æ•°æ®è¿›è¡Œå¤„ç†ã€‚

**å³è¾¹è¿›å·¦è¾¹å‡ºï¼šé˜Ÿåˆ—**
```
> rpush books python java golang
(integer) 3
> llen books
(integer) 3
> lpop books
"python"
> lpop books
"java"
> lpop books
"golang"
> lpop books
(nil)
```

**å³è¾¹è¿›å³è¾¹å‡ºï¼šæ ˆ**
```
> rpush books python java golang
(integer) 3
> rpop books
"golang"
> rpop books
"java"
> rpop books
"python"
> rpop books
(nil)
```

**æ…¢æ“ä½œ**

lindex ç›¸å½“äº Java é“¾è¡¨çš„```get(int index)```æ–¹æ³•ï¼Œå®ƒéœ€è¦å¯¹é“¾è¡¨è¿›è¡Œéå†ï¼Œæ€§èƒ½éšç€å‚æ•°```index```å¢å¤§è€Œå˜å·®ã€‚

ltrim å’Œå­—é¢ä¸Šçš„å«ä¹‰ä¸å¤ªä¸€æ ·ï¼Œä¸ªäººè§‰å¾—å®ƒå« lretain(ä¿ç•™) æ›´åˆé€‚ä¸€äº›ï¼Œå› ä¸º ltrim è·Ÿçš„ä¸¤ä¸ªå‚æ•°```start_index```å’Œ```end_index```å®šä¹‰äº†ä¸€ä¸ªåŒºé—´ï¼Œåœ¨è¿™ä¸ªåŒºé—´å†…çš„å€¼ï¼Œltrim è¦ä¿ç•™ï¼ŒåŒºé—´ä¹‹å¤–ç»Ÿç»Ÿç æ‰ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ltrimæ¥å®ç°ä¸€ä¸ªå®šé•¿çš„é“¾è¡¨ï¼Œè¿™ä¸€ç‚¹éå¸¸æœ‰ç”¨ã€‚

index å¯ä»¥ä¸ºè´Ÿæ•°ï¼Œ```index=-1```è¡¨ç¤ºå€’æ•°ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ŒåŒæ ·```index=-2```è¡¨ç¤ºå€’æ•°ç¬¬äºŒä¸ªå…ƒç´ ã€‚

```
> rpush books python java golang
(integer) 3
> lindex books 1  # O(n) æ…ç”¨
"java"
> lrange books 0 -1  # è·å–æ‰€æœ‰å…ƒç´ ï¼ŒO(n) æ…ç”¨
1) "python"
2) "java"
3) "golang"
> ltrim books 1 -1 # O(n) æ…ç”¨
OK
> lrange books 0 -1
1) "java"
2) "golang"
> ltrim books 1 0 # è¿™å…¶å®æ˜¯æ¸…ç©ºäº†æ•´ä¸ªåˆ—è¡¨ï¼Œå› ä¸ºåŒºé—´èŒƒå›´é•¿åº¦ä¸ºè´Ÿ
OK
> llen books
(integer) 0
```
**å¿«é€Ÿåˆ—è¡¨**

![](https://user-gold-cdn.xitu.io/2018/7/27/164d975cac9559c5?w=1568&h=148&f=png&s=17643)

å¦‚æœå†æ·±å…¥ä¸€ç‚¹ï¼Œä½ ä¼šå‘ç° Redis åº•å±‚å­˜å‚¨çš„è¿˜ä¸æ˜¯ä¸€ä¸ªç®€å•çš„ `linkedlist`ï¼Œè€Œæ˜¯ç§°ä¹‹ä¸ºå¿«é€Ÿé“¾è¡¨ `quicklist` çš„ä¸€ä¸ªç»“æ„ã€‚

é¦–å…ˆåœ¨åˆ—è¡¨å…ƒç´ è¾ƒå°‘çš„æƒ…å†µä¸‹ä¼šä½¿ç”¨ä¸€å—è¿ç»­çš„å†…å­˜å­˜å‚¨ï¼Œè¿™ä¸ªç»“æ„æ˜¯ `ziplist`ï¼Œä¹Ÿå³æ˜¯å‹ç¼©åˆ—è¡¨ã€‚å®ƒå°†æ‰€æœ‰çš„å…ƒç´ ç´§æŒ¨ç€ä¸€èµ·å­˜å‚¨ï¼Œåˆ†é…çš„æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ã€‚å½“æ•°æ®é‡æ¯”è¾ƒå¤šçš„æ—¶å€™æ‰ä¼šæ”¹æˆ `quicklist`ã€‚å› ä¸ºæ™®é€šçš„é“¾è¡¨éœ€è¦çš„é™„åŠ æŒ‡é’ˆç©ºé—´å¤ªå¤§ï¼Œä¼šæ¯”è¾ƒæµªè´¹ç©ºé—´ï¼Œè€Œä¸”ä¼šåŠ é‡å†…å­˜çš„ç¢ç‰‡åŒ–ã€‚æ¯”å¦‚è¿™ä¸ªåˆ—è¡¨é‡Œå­˜çš„åªæ˜¯ `int` ç±»å‹çš„æ•°æ®ï¼Œç»“æ„ä¸Šè¿˜éœ€è¦ä¸¤ä¸ªé¢å¤–çš„æŒ‡é’ˆ `prev` å’Œ `next` ã€‚æ‰€ä»¥ Redis å°†é“¾è¡¨å’Œ `ziplist` ç»“åˆèµ·æ¥ç»„æˆäº† `quicklist`ã€‚ä¹Ÿå°±æ˜¯å°†å¤šä¸ª `ziplist` ä½¿ç”¨åŒå‘æŒ‡é’ˆä¸²èµ·æ¥ä½¿ç”¨ã€‚è¿™æ ·æ—¢æ»¡è¶³äº†å¿«é€Ÿçš„æ’å…¥åˆ é™¤æ€§èƒ½ï¼Œåˆä¸ä¼šå‡ºç°å¤ªå¤§çš„ç©ºé—´å†—ä½™ã€‚

å…³äºåˆ—è¡¨çš„å†…éƒ¨ç»“æ„å®ç°ï¼Œè¯·é˜…è¯»ç¬¬ 34 èŠ‚[ã€Šæåº¦æ·±å¯’ â€”â€” æ¢ç´¢ã€Œå‹ç¼©åˆ—è¡¨ã€å†…éƒ¨ã€‹](https://juejin.im/book/5afc2e5f6fb9a07a9b362527/section/5b5c95226fb9a04fa42fc3f6)å’Œç¬¬ 35 èŠ‚[ã€Šæåº¦æ·±å¯’ â€”â€” æ¢ç´¢ã€Œå¿«é€Ÿåˆ—è¡¨ã€å†…éƒ¨ã€‹](https://juejin.im/book/5afc2e5f6fb9a07a9b362527/section/5b5c963be51d45199154e82e)

## hash (å­—å…¸)

Redis çš„å­—å…¸ç›¸å½“äº Java è¯­è¨€é‡Œé¢çš„ HashMapï¼Œå®ƒæ˜¯æ— åºå­—å…¸ã€‚å†…éƒ¨å®ç°ç»“æ„ä¸ŠåŒ Java çš„ HashMap ä¹Ÿæ˜¯ä¸€è‡´çš„ï¼ŒåŒæ ·çš„æ•°ç»„ + é“¾è¡¨äºŒç»´ç»“æ„ã€‚ç¬¬ä¸€ç»´ hash çš„æ•°ç»„ä½ç½®ç¢°æ’æ—¶ï¼Œå°±ä¼šå°†ç¢°æ’çš„å…ƒç´ ä½¿ç”¨é“¾è¡¨ä¸²æ¥èµ·æ¥ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/9/1647e419af9e3a87?w=579&h=277&f=png&s=11839)

ä¸åŒçš„æ˜¯ï¼ŒRedis çš„å­—å…¸çš„å€¼åªèƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œå¦å¤–å®ƒä»¬ rehash çš„æ–¹å¼ä¸ä¸€æ ·ï¼Œå› ä¸º Java çš„ HashMap åœ¨å­—å…¸å¾ˆå¤§æ—¶ï¼Œrehash æ˜¯ä¸ªè€—æ—¶çš„æ“ä½œï¼Œéœ€è¦ä¸€æ¬¡æ€§å…¨éƒ¨ rehashã€‚Redis ä¸ºäº†é«˜æ€§èƒ½ï¼Œä¸èƒ½å µå¡æœåŠ¡ï¼Œæ‰€ä»¥é‡‡ç”¨äº†æ¸è¿›å¼ rehash ç­–ç•¥ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/28/164dc873b2a899a8?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

æ¸è¿›å¼ rehash ä¼šåœ¨ rehash çš„åŒæ—¶ï¼Œä¿ç•™æ–°æ—§ä¸¤ä¸ª hash ç»“æ„ï¼ŒæŸ¥è¯¢æ—¶ä¼šåŒæ—¶æŸ¥è¯¢ä¸¤ä¸ª hash ç»“æ„ï¼Œç„¶ååœ¨åç»­çš„å®šæ—¶ä»»åŠ¡ä¸­ä»¥åŠ hash æ“ä½œæŒ‡ä»¤ä¸­ï¼Œå¾ªåºæ¸è¿›åœ°å°†æ—§ hash çš„å†…å®¹ä¸€ç‚¹ç‚¹è¿ç§»åˆ°æ–°çš„ hash ç»“æ„ä¸­ã€‚å½“æ¬è¿å®Œæˆäº†ï¼Œå°±ä¼šä½¿ç”¨æ–°çš„hashç»“æ„å–è€Œä»£ä¹‹ã€‚



å½“ hash ç§»é™¤äº†æœ€åä¸€ä¸ªå…ƒç´ ä¹‹åï¼Œè¯¥æ•°æ®ç»“æ„è‡ªåŠ¨è¢«åˆ é™¤ï¼Œå†…å­˜è¢«å›æ”¶ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/2/16458ef82907e5e1?w=450&h=160&f=gif&s=100250)

hash ç»“æ„ä¹Ÿå¯ä»¥ç”¨æ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œä¸åŒäºå­—ç¬¦ä¸²ä¸€æ¬¡æ€§éœ€è¦å…¨éƒ¨åºåˆ—åŒ–æ•´ä¸ªå¯¹è±¡ï¼Œhash å¯ä»¥å¯¹ç”¨æˆ·ç»“æ„ä¸­çš„æ¯ä¸ªå­—æ®µå•ç‹¬å­˜å‚¨ã€‚è¿™æ ·å½“æˆ‘ä»¬éœ€è¦è·å–ç”¨æˆ·ä¿¡æ¯æ—¶å¯ä»¥è¿›è¡Œéƒ¨åˆ†è·å–ã€‚è€Œä»¥æ•´ä¸ªå­—ç¬¦ä¸²çš„å½¢å¼å»ä¿å­˜ç”¨æˆ·ä¿¡æ¯çš„è¯å°±åªèƒ½ä¸€æ¬¡æ€§å…¨éƒ¨è¯»å–ï¼Œè¿™æ ·å°±ä¼šæ¯”è¾ƒæµªè´¹ç½‘ç»œæµé‡ã€‚

hash ä¹Ÿæœ‰ç¼ºç‚¹ï¼Œhash ç»“æ„çš„å­˜å‚¨æ¶ˆè€—è¦é«˜äºå•ä¸ªå­—ç¬¦ä¸²ï¼Œåˆ°åº•è¯¥ä½¿ç”¨ hash è¿˜æ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µå†ä¸‰æƒè¡¡ã€‚

```
> hset books java "think in java"  # å‘½ä»¤è¡Œçš„å­—ç¬¦ä¸²å¦‚æœåŒ…å«ç©ºæ ¼ï¼Œè¦ç”¨å¼•å·æ‹¬èµ·æ¥
(integer) 1
> hset books golang "concurrency in go"
(integer) 1
> hset books python "python cookbook"
(integer) 1
> hgetall books  # entries()ï¼Œkey å’Œ value é—´éš”å‡ºç°
1) "java"
2) "think in java"
3) "golang"
4) "concurrency in go"
5) "python"
6) "python cookbook"
> hlen books
(integer) 3
> hget books java
"think in java"
> hset books golang "learning go programming"  # å› ä¸ºæ˜¯æ›´æ–°æ“ä½œï¼Œæ‰€ä»¥è¿”å› 0
(integer) 0
> hget books golang
"learning go programming"
> hmset books java "effective java" python "learning python" golang "modern golang programming"  # æ‰¹é‡ set
OK
```

åŒå­—ç¬¦ä¸²å¯¹è±¡ä¸€æ ·ï¼Œhash ç»“æ„ä¸­çš„å•ä¸ªå­ key ä¹Ÿå¯ä»¥è¿›è¡Œè®¡æ•°ï¼Œå®ƒå¯¹åº”çš„æŒ‡ä»¤æ˜¯ `hincrby`ï¼Œå’Œ `incr` ä½¿ç”¨åŸºæœ¬ä¸€æ ·ã€‚
```
# è€é’±åˆè€äº†ä¸€å²
> hincrby user-laoqian age 1
(integer) 30
```

å…³äºå­—å…¸çš„å†…éƒ¨ç»“æ„å®ç°ï¼Œè¯·é˜…è¯»ç¬¬ 33 èŠ‚[ã€Šæåº¦æ·±å¯’ â€”â€” æ¢ç´¢ã€Œå­—å…¸ã€å†…éƒ¨ã€‹](https://juejin.im/book/5afc2e5f6fb9a07a9b362527/section/5b5bdbbd5188251ac22b5bf7)ã€‚

## set (é›†åˆ)

Redis çš„é›†åˆç›¸å½“äº Java è¯­è¨€é‡Œé¢çš„ HashSetï¼Œå®ƒå†…éƒ¨çš„é”®å€¼å¯¹æ˜¯æ— åºçš„å”¯ä¸€çš„ã€‚å®ƒçš„å†…éƒ¨å®ç°ç›¸å½“äºä¸€ä¸ªç‰¹æ®Šçš„å­—å…¸ï¼Œå­—å…¸ä¸­æ‰€æœ‰çš„ value éƒ½æ˜¯ä¸€ä¸ªå€¼`NULL`ã€‚

å½“é›†åˆä¸­æœ€åä¸€ä¸ªå…ƒç´ ç§»é™¤ä¹‹åï¼Œæ•°æ®ç»“æ„è‡ªåŠ¨åˆ é™¤ï¼Œå†…å­˜è¢«å›æ”¶ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/2/16458e2da04f1a2d?w=484&h=200&f=gif&s=127699)

set ç»“æ„å¯ä»¥ç”¨æ¥å­˜å‚¨æ´»åŠ¨ä¸­å¥–çš„ç”¨æˆ· IDï¼Œå› ä¸ºæœ‰å»é‡åŠŸèƒ½ï¼Œå¯ä»¥ä¿è¯åŒä¸€ä¸ªç”¨æˆ·ä¸ä¼šä¸­å¥–ä¸¤æ¬¡ã€‚

```
> sadd books python
(integer) 1
> sadd books python  #  é‡å¤
(integer) 0
> sadd books java golang
(integer) 2
> smembers books  # æ³¨æ„é¡ºåºï¼Œå’Œæ’å…¥çš„å¹¶ä¸ä¸€è‡´ï¼Œå› ä¸º set æ˜¯æ— åºçš„
1) "java"
2) "python"
3) "golang"
> sismember books java  # æŸ¥è¯¢æŸä¸ª value æ˜¯å¦å­˜åœ¨ï¼Œç›¸å½“äº contains(o)
(integer) 1
> sismember books rust
(integer) 0
> scard books  # è·å–é•¿åº¦ç›¸å½“äº count()
(integer) 3
> spop books  # å¼¹å‡ºä¸€ä¸ª
"java"
```

## zset (æœ‰åºé›†åˆ)

zset å¯èƒ½æ˜¯ Redis æä¾›çš„æœ€ä¸ºç‰¹è‰²çš„æ•°æ®ç»“æ„ï¼Œå®ƒä¹Ÿæ˜¯åœ¨é¢è¯•ä¸­é¢è¯•å®˜æœ€çˆ±é—®çš„æ•°æ®ç»“æ„ã€‚å®ƒç±»ä¼¼äº Java çš„ SortedSet å’Œ HashMap çš„ç»“åˆä½“ï¼Œä¸€æ–¹é¢å®ƒæ˜¯ä¸€ä¸ª setï¼Œä¿è¯äº†å†…éƒ¨ value çš„å”¯ä¸€æ€§ï¼Œå¦ä¸€æ–¹é¢å®ƒå¯ä»¥ç»™æ¯ä¸ª value èµ‹äºˆä¸€ä¸ª scoreï¼Œä»£è¡¨è¿™ä¸ª value çš„æ’åºæƒé‡ã€‚å®ƒçš„å†…éƒ¨å®ç°ç”¨çš„æ˜¯ä¸€ç§å«åšã€Œè·³è·ƒåˆ—è¡¨ã€çš„æ•°æ®ç»“æ„ã€‚

zset ä¸­æœ€åä¸€ä¸ª value è¢«ç§»é™¤åï¼Œæ•°æ®ç»“æ„è‡ªåŠ¨åˆ é™¤ï¼Œå†…å­˜è¢«å›æ”¶ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/2/16458f9f679a8bb0?w=400&h=160&f=gif&s=68631)

zset å¯ä»¥ç”¨æ¥å­˜ç²‰ä¸åˆ—è¡¨ï¼Œvalue å€¼æ˜¯ç²‰ä¸çš„ç”¨æˆ· IDï¼Œscore æ˜¯å…³æ³¨æ—¶é—´ã€‚æˆ‘ä»¬å¯ä»¥å¯¹ç²‰ä¸åˆ—è¡¨æŒ‰å…³æ³¨æ—¶é—´è¿›è¡Œæ’åºã€‚

zset è¿˜å¯ä»¥ç”¨æ¥å­˜å‚¨å­¦ç”Ÿçš„æˆç»©ï¼Œvalue å€¼æ˜¯å­¦ç”Ÿçš„ IDï¼Œscore æ˜¯ä»–çš„è€ƒè¯•æˆç»©ã€‚æˆ‘ä»¬å¯ä»¥å¯¹æˆç»©æŒ‰åˆ†æ•°è¿›è¡Œæ’åºå°±å¯ä»¥å¾—åˆ°ä»–çš„åæ¬¡ã€‚

```
> zadd books 9.0 "think in java"
(integer) 1
> zadd books 8.9 "java concurrency"
(integer) 1
> zadd books 8.6 "java cookbook"
(integer) 1
> zrange books 0 -1  # æŒ‰ score æ’åºåˆ—å‡ºï¼Œå‚æ•°åŒºé—´ä¸ºæ’åèŒƒå›´
1) "java cookbook"
2) "java concurrency"
3) "think in java"
> zrevrange books 0 -1  # æŒ‰ score é€†åºåˆ—å‡ºï¼Œå‚æ•°åŒºé—´ä¸ºæ’åèŒƒå›´
1) "think in java"
2) "java concurrency"
3) "java cookbook"
> zcard books  # ç›¸å½“äº count()
(integer) 3
> zscore books "java concurrency"  # è·å–æŒ‡å®š value çš„ score
"8.9000000000000004"  # å†…éƒ¨ score ä½¿ç”¨ double ç±»å‹è¿›è¡Œå­˜å‚¨ï¼Œæ‰€ä»¥å­˜åœ¨å°æ•°ç‚¹ç²¾åº¦é—®é¢˜
> zrank books "java concurrency"  # æ’å
(integer) 1
> zrangebyscore books 0 8.91  # æ ¹æ®åˆ†å€¼åŒºé—´éå† zset
1) "java cookbook"
2) "java concurrency"
> zrangebyscore books -inf 8.91 withscores # æ ¹æ®åˆ†å€¼åŒºé—´ (-âˆ, 8.91] éå† zsetï¼ŒåŒæ—¶è¿”å›åˆ†å€¼ã€‚inf ä»£è¡¨ infiniteï¼Œæ— ç©·å¤§çš„æ„æ€ã€‚
1) "java cookbook"
2) "8.5999999999999996"
3) "java concurrency"
4) "8.9000000000000004"
> zrem books "java concurrency"  # åˆ é™¤ value
(integer) 1
> zrange books 0 -1
1) "java cookbook"
2) "think in java"
```

**è·³è·ƒåˆ—è¡¨**

zset å†…éƒ¨çš„æ’åºåŠŸèƒ½æ˜¯é€šè¿‡ã€Œè·³è·ƒåˆ—è¡¨ã€æ•°æ®ç»“æ„æ¥å®ç°çš„ï¼Œå®ƒçš„ç»“æ„éå¸¸ç‰¹æ®Šï¼Œä¹Ÿæ¯”è¾ƒå¤æ‚ã€‚

å› ä¸º zset è¦æ”¯æŒéšæœºçš„æ’å…¥å’Œåˆ é™¤ï¼Œæ‰€ä»¥å®ƒä¸å¥½ä½¿ç”¨æ•°ç»„æ¥è¡¨ç¤ºã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªæ™®é€šçš„é“¾è¡¨ç»“æ„ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/23/164c5a90442cd51a?w=2032&h=174&f=png&s=25070)

æˆ‘ä»¬éœ€è¦è¿™ä¸ªé“¾è¡¨æŒ‰ç…§ score å€¼è¿›è¡Œæ’åºã€‚è¿™æ„å‘³ç€å½“æœ‰æ–°å…ƒç´ éœ€è¦æ’å…¥æ—¶ï¼Œè¦å®šä½åˆ°ç‰¹å®šä½ç½®çš„æ’å…¥ç‚¹ï¼Œè¿™æ ·æ‰å¯ä»¥ç»§ç»­ä¿è¯é“¾è¡¨æ˜¯æœ‰åºçš„ã€‚é€šå¸¸æˆ‘ä»¬ä¼šé€šè¿‡äºŒåˆ†æŸ¥æ‰¾æ¥æ‰¾åˆ°æ’å…¥ç‚¹ï¼Œä½†æ˜¯äºŒåˆ†æŸ¥æ‰¾çš„å¯¹è±¡å¿…é¡»æ˜¯æ•°ç»„ï¼Œåªæœ‰æ•°ç»„æ‰å¯ä»¥æ”¯æŒå¿«é€Ÿä½ç½®å®šä½ï¼Œé“¾è¡¨åšä¸åˆ°ï¼Œé‚£è¯¥æ€ä¹ˆåŠï¼Ÿ

æƒ³æƒ³ä¸€ä¸ªåˆ›ä¸šå…¬å¸ï¼Œåˆšå¼€å§‹åªæœ‰å‡ ä¸ªäººï¼Œå›¢é˜Ÿæˆå‘˜ä¹‹é—´äººäººå¹³ç­‰ï¼Œéƒ½æ˜¯è”åˆåˆ›å§‹äººã€‚éšç€å…¬å¸çš„æˆé•¿ï¼Œäººæ•°æ¸æ¸å˜å¤šï¼Œå›¢é˜Ÿæ²Ÿé€šæˆæœ¬éšä¹‹å¢åŠ ã€‚è¿™æ—¶å€™å°±ä¼šå¼•å…¥ç»„é•¿åˆ¶ï¼Œå¯¹å›¢é˜Ÿè¿›è¡Œåˆ’åˆ†ã€‚æ¯ä¸ªå›¢é˜Ÿä¼šæœ‰ä¸€ä¸ªç»„é•¿ã€‚å¼€ä¼šçš„æ—¶å€™åˆ†å›¢é˜Ÿè¿›è¡Œï¼Œå¤šä¸ªç»„é•¿ä¹‹é—´è¿˜ä¼šæœ‰è‡ªå·±çš„ä¼šè®®å®‰æ’ã€‚å…¬å¸è§„æ¨¡è¿›ä¸€æ­¥æ‰©å±•ï¼Œéœ€è¦å†å¢åŠ ä¸€ä¸ªå±‚çº§ â€”â€” éƒ¨é—¨ï¼Œæ¯ä¸ªéƒ¨é—¨ä¼šä»ç»„é•¿åˆ—è¡¨ä¸­æ¨é€‰å‡ºä¸€ä¸ªä»£è¡¨æ¥ä½œä¸ºéƒ¨é•¿ã€‚éƒ¨é•¿ä»¬ä¹‹é—´è¿˜ä¼šæœ‰è‡ªå·±çš„é«˜å±‚ä¼šè®®å®‰æ’ã€‚

è·³è·ƒåˆ—è¡¨å°±æ˜¯ç±»ä¼¼äºè¿™ç§å±‚çº§åˆ¶ï¼Œæœ€ä¸‹é¢ä¸€å±‚æ‰€æœ‰çš„å…ƒç´ éƒ½ä¼šä¸²èµ·æ¥ã€‚ç„¶åæ¯éš”å‡ ä¸ªå…ƒç´ æŒ‘é€‰å‡ºä¸€ä¸ªä»£è¡¨æ¥ï¼Œå†å°†è¿™å‡ ä¸ªä»£è¡¨ä½¿ç”¨å¦å¤–ä¸€çº§æŒ‡é’ˆä¸²èµ·æ¥ã€‚ç„¶ååœ¨è¿™äº›ä»£è¡¨é‡Œå†æŒ‘å‡ºäºŒçº§ä»£è¡¨ï¼Œå†ä¸²èµ·æ¥ã€‚æœ€ç»ˆå°±å½¢æˆäº†é‡‘å­—å¡”ç»“æ„ã€‚

æƒ³æƒ³ä½ è€å®¶åœ¨ä¸–ç•Œåœ°å›¾ä¸­çš„ä½ç½®ï¼šäºšæ´²-->ä¸­å›½->å®‰å¾½çœ->å®‰åº†å¸‚->æé˜³å¿->æ±¤æ²Ÿé•‡->ç”°é—´æ‘->xxxxå·ï¼Œä¹Ÿæ˜¯è¿™æ ·ä¸€ä¸ªç±»ä¼¼çš„ç»“æ„ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/23/164c5bb13c6da230?w=1151&h=225&f=png&s=17916)

ã€Œè·³è·ƒåˆ—è¡¨ã€ä¹‹æ‰€ä»¥ã€Œè·³è·ƒã€ï¼Œæ˜¯å› ä¸ºå†…éƒ¨çš„å…ƒç´ å¯èƒ½ã€Œèº«å…¼æ•°èŒã€ï¼Œæ¯”å¦‚ä¸Šå›¾ä¸­é—´çš„è¿™ä¸ªå…ƒç´ ï¼ŒåŒæ—¶å¤„äº L0ã€L1 å’Œ L2 å±‚ï¼Œå¯ä»¥å¿«é€Ÿåœ¨ä¸åŒå±‚æ¬¡ä¹‹é—´è¿›è¡Œã€Œè·³è·ƒã€ã€‚

å®šä½æ’å…¥ç‚¹æ—¶ï¼Œå…ˆåœ¨é¡¶å±‚è¿›è¡Œå®šä½ï¼Œç„¶åä¸‹æ½œåˆ°ä¸‹ä¸€çº§å®šä½ï¼Œä¸€ç›´ä¸‹æ½œåˆ°æœ€åº•å±‚æ‰¾åˆ°åˆé€‚çš„ä½ç½®ï¼Œå°†æ–°å…ƒç´ æ’è¿›å»ã€‚ä½ ä¹Ÿè®¸ä¼šé—®ï¼Œé‚£æ–°æ’å…¥çš„å…ƒç´ å¦‚ä½•æ‰æœ‰æœºä¼šã€Œèº«å…¼æ•°èŒã€å‘¢ï¼Ÿ

è·³è·ƒåˆ—è¡¨é‡‡å–ä¸€ä¸ªéšæœºç­–ç•¥æ¥å†³å®šæ–°å…ƒç´ å¯ä»¥å…¼èŒåˆ°ç¬¬å‡ å±‚ã€‚

é¦–å…ˆ L0 å±‚è‚¯å®šæ˜¯ 100% äº†ï¼ŒL1 å±‚åªæœ‰ 50% çš„æ¦‚ç‡ï¼ŒL2 å±‚åªæœ‰ 25% çš„æ¦‚ç‡ï¼ŒL3 å±‚åªæœ‰ 12.5% çš„æ¦‚ç‡ï¼Œä¸€ç›´éšæœºåˆ°æœ€é¡¶å±‚ L31 å±‚ã€‚ç»å¤§å¤šæ•°å…ƒç´ éƒ½è¿‡ä¸äº†å‡ å±‚ï¼Œåªæœ‰æå°‘æ•°å…ƒç´ å¯ä»¥æ·±å…¥åˆ°é¡¶å±‚ã€‚åˆ—è¡¨ä¸­çš„å…ƒç´ è¶Šå¤šï¼Œèƒ½å¤Ÿæ·±å…¥çš„å±‚æ¬¡å°±è¶Šæ·±ï¼Œèƒ½è¿›å…¥åˆ°é¡¶å±‚çš„æ¦‚ç‡å°±ä¼šè¶Šå¤§ã€‚

è¿™è¿˜æŒºå…¬å¹³çš„ï¼Œèƒ½ä¸èƒ½è¿›å…¥ä¸­å¤®ä¸æ˜¯é æ‹¼çˆ¹ï¼Œè€Œæ˜¯çœ‹è¿æ°”ã€‚

å…³äºè·³è·ƒåˆ—è¡¨çš„å†…éƒ¨ç»“æ„å®ç°ï¼Œè¯·é˜…è¯»ç¬¬ 36 èŠ‚[ã€Šæåº¦æ·±å¯’ â€”â€” æ¢ç´¢ã€Œè·³è·ƒåˆ—è¡¨ã€å†…éƒ¨ç»“æ„ã€‹](https://juejin.im/book/5afc2e5f6fb9a07a9b362527/section/5b5ac63d5188256255299d9c)

## å®¹å™¨å‹æ•°æ®ç»“æ„çš„é€šç”¨è§„åˆ™

list/set/hash/zset è¿™å››ç§æ•°æ®ç»“æ„æ˜¯å®¹å™¨å‹æ•°æ®ç»“æ„ï¼Œå®ƒä»¬å…±äº«ä¸‹é¢ä¸¤æ¡é€šç”¨è§„åˆ™ï¼š

1. create if not exists 

    å¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œé‚£å°±åˆ›å»ºä¸€ä¸ªï¼Œå†è¿›è¡Œæ“ä½œã€‚æ¯”å¦‚ rpush æ“ä½œåˆšå¼€å§‹æ˜¯æ²¡æœ‰åˆ—è¡¨çš„ï¼ŒRedis å°±ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªï¼Œç„¶åå† rpush è¿›å»æ–°å…ƒç´ ã€‚

2. drop if no elements

    å¦‚æœå®¹å™¨é‡Œå…ƒç´ æ²¡æœ‰äº†ï¼Œé‚£ä¹ˆç«‹å³åˆ é™¤å…ƒç´ ï¼Œé‡Šæ”¾å†…å­˜ã€‚è¿™æ„å‘³ç€ lpop æ“ä½œåˆ°æœ€åä¸€ä¸ªå…ƒç´ ï¼Œåˆ—è¡¨å°±æ¶ˆå¤±äº†ã€‚
    
## è¿‡æœŸæ—¶é—´

Redis æ‰€æœ‰çš„æ•°æ®ç»“æ„éƒ½å¯ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ—¶é—´åˆ°äº†ï¼ŒRedis ä¼šè‡ªåŠ¨åˆ é™¤ç›¸åº”çš„å¯¹è±¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿‡æœŸæ˜¯ä»¥å¯¹è±¡ä¸ºå•ä½ï¼Œæ¯”å¦‚ä¸€ä¸ª hash ç»“æ„çš„è¿‡æœŸæ˜¯æ•´ä¸ª hash å¯¹è±¡çš„è¿‡æœŸï¼Œè€Œä¸æ˜¯å…¶ä¸­çš„æŸä¸ªå­ keyã€‚

è¿˜æœ‰ä¸€ä¸ªéœ€è¦ç‰¹åˆ«æ³¨æ„çš„åœ°æ–¹æ˜¯å¦‚æœä¸€ä¸ªå­—ç¬¦ä¸²å·²ç»è®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œç„¶åä½ è°ƒç”¨äº† set æ–¹æ³•ä¿®æ”¹äº†å®ƒï¼Œå®ƒçš„è¿‡æœŸæ—¶é—´ä¼šæ¶ˆå¤±ã€‚

```
127.0.0.1:6379> set codehole yoyo
OK
127.0.0.1:6379> expire codehole 600
(integer) 1
127.0.0.1:6379> ttl codehole
(integer) 597
127.0.0.1:6379> set codehole yoyo
OK
127.0.0.1:6379> ttl codehole
(integer) -1
```

## æ€è€ƒ & ä½œä¸š

1. å¦‚æœä½ æ˜¯ Java ç”¨æˆ·ï¼Œè¯·å®šä¹‰ä¸€ä¸ªç”¨æˆ·ä¿¡æ¯ç»“æ„ä½“ï¼Œç„¶åä½¿ç”¨ `fastjson` å¯¹ç”¨æˆ·ä¿¡æ¯å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå†ä½¿ç”¨ Jedis å¯¹ Redis ç¼“å­˜çš„ç”¨æˆ·ä¿¡æ¯è¿›è¡Œå­˜å’Œå–ã€‚

2. å¦‚æœä½ æ˜¯ Python ç”¨æˆ·ï¼Œä½¿ç”¨å†…ç½®çš„ JSON åŒ…å°±å¯ä»¥äº†ã€‚ç„¶åé€šè¿‡ redis-py æ¥å¯¹ Redis ç¼“å­˜çš„ç”¨æˆ·ä¿¡æ¯è¿›è¡Œå­˜å’Œå–ã€‚

3. æƒ³æƒ³å¦‚æœè¦æ”¹æˆç”¨ hash ç»“æ„æ¥ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œä½ è¯¥å¦‚ä½•å°è£…æ¯”è¾ƒåˆé€‚ï¼Ÿ

4. æƒ³æƒ³å¹³æ—¶è¿˜æœ‰å“ªäº›æŒ‡ä»¤ä½ å¹³æ—¶ç”¨è¿‡è€Œæœ¬å°èŠ‚æ²¡æœ‰æåˆ°çš„ï¼Ÿ

5. å›æƒ³ä¸€ä¸‹æ˜é‡‘ç¤¾åŒºçš„åŠŸèƒ½æ¨¡å—ä¸­åˆ†åˆ«ä¼šä½¿ç”¨åˆ°å“ªäº›æ•°æ®ç»“æ„ï¼Ÿ


## æ‰©å±•é˜…è¯»
- [ã€Šå­˜ç»“æ„ä½“ä¿¡æ¯åˆ°åº•è¯¥ä½¿ç”¨ hash è¿˜æ˜¯ stringï¼Ÿã€‹](https://stackoverflow.com/questions/16375188/redis-strings-vs-redis-hashes-to-represent-json-efficiency)
# åº”ç”¨ 1ï¼šåƒå¸†ç«å‘ â€”â€” åˆ†å¸ƒå¼é”

åˆ†å¸ƒå¼åº”ç”¨è¿›è¡Œé€»è¾‘å¤„ç†æ—¶ç»å¸¸ä¼šé‡åˆ°å¹¶å‘é—®é¢˜ã€‚

æ¯”å¦‚ä¸€ä¸ªæ“ä½œè¦ä¿®æ”¹ç”¨æˆ·çš„çŠ¶æ€ï¼Œä¿®æ”¹çŠ¶æ€éœ€è¦å…ˆè¯»å‡ºç”¨æˆ·çš„çŠ¶æ€ï¼Œåœ¨å†…å­˜é‡Œè¿›è¡Œä¿®æ”¹ï¼Œæ”¹å®Œäº†å†å­˜å›å»ã€‚å¦‚æœè¿™æ ·çš„æ“ä½œåŒæ—¶è¿›è¡Œäº†ï¼Œå°±ä¼šå‡ºç°å¹¶å‘é—®é¢˜ï¼Œå› ä¸ºè¯»å–å’Œä¿å­˜çŠ¶æ€è¿™ä¸¤ä¸ªæ“ä½œä¸æ˜¯åŸå­çš„ã€‚ï¼ˆWiki è§£é‡Šï¼šæ‰€è°“**åŸå­æ“ä½œ**æ˜¯æŒ‡ä¸ä¼šè¢«çº¿ç¨‹è°ƒåº¦æœºåˆ¶æ‰“æ–­çš„æ“ä½œï¼›è¿™ç§æ“ä½œä¸€æ—¦å¼€å§‹ï¼Œå°±ä¸€ç›´è¿è¡Œåˆ°ç»“æŸï¼Œä¸­é—´ä¸ä¼šæœ‰ä»»ä½• context switch çº¿ç¨‹åˆ‡æ¢ã€‚ï¼‰

![](https://user-gold-cdn.xitu.io/2018/7/10/164824791aa796fa?w=1156&h=482&f=png&s=48904)

è¿™ä¸ªæ—¶å€™å°±è¦ä½¿ç”¨åˆ°åˆ†å¸ƒå¼é”æ¥é™åˆ¶ç¨‹åºçš„å¹¶å‘æ‰§è¡Œã€‚Redis åˆ†å¸ƒå¼é”ä½¿ç”¨éå¸¸å¹¿æ³›ï¼Œå®ƒæ˜¯é¢è¯•çš„é‡è¦è€ƒç‚¹ä¹‹ä¸€ï¼Œå¾ˆå¤šåŒå­¦éƒ½çŸ¥é“è¿™ä¸ªçŸ¥è¯†ï¼Œä¹Ÿå¤§è‡´çŸ¥é“åˆ†å¸ƒå¼é”çš„åŸç†ï¼Œä½†æ˜¯å…·ä½“åˆ°ç»†èŠ‚çš„ä½¿ç”¨ä¸Šå¾€å¾€å¹¶ä¸å®Œå…¨æ­£ç¡®ã€‚

åˆ†å¸ƒå¼é”
--
åˆ†å¸ƒå¼é”æœ¬è´¨ä¸Šè¦å®ç°çš„ç›®æ ‡å°±æ˜¯åœ¨ Redis é‡Œé¢å ä¸€ä¸ªâ€œèŒ…å‘â€ï¼Œå½“åˆ«çš„è¿›ç¨‹ä¹Ÿè¦æ¥å æ—¶ï¼Œå‘ç°å·²ç»æœ‰äººè¹²åœ¨é‚£é‡Œäº†ï¼Œå°±åªå¥½æ”¾å¼ƒæˆ–è€…ç¨åå†è¯•ã€‚

å å‘ä¸€èˆ¬æ˜¯ä½¿ç”¨ setnx(set if not exists) æŒ‡ä»¤ï¼Œåªå…è®¸è¢«ä¸€ä¸ªå®¢æˆ·ç«¯å å‘ã€‚å…ˆæ¥å…ˆå ï¼Œ
ç”¨å®Œäº†ï¼Œå†è°ƒç”¨ del æŒ‡ä»¤é‡Šæ”¾èŒ…å‘ã€‚
```
// è¿™é‡Œçš„å†’å·:å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å­—ç¬¦ï¼Œæ²¡ç‰¹åˆ«å«ä¹‰ï¼Œå®ƒå¯ä»¥æ˜¯ä»»æ„å…¶å®ƒå­—ç¬¦ï¼Œä¸è¦è¯¯è§£
> setnx lock:codehole true
OK
... do something critical ...
> del lock:codehole
(integer) 1
```

ä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœé€»è¾‘æ‰§è¡Œåˆ°ä¸­é—´å‡ºç°å¼‚å¸¸äº†ï¼Œå¯èƒ½ä¼šå¯¼è‡´ del æŒ‡ä»¤æ²¡æœ‰è¢«è°ƒç”¨ï¼Œè¿™æ ·å°±ä¼šé™·å…¥æ­»é”ï¼Œé”æ°¸è¿œå¾—ä¸åˆ°é‡Šæ”¾ã€‚

äºæ˜¯æˆ‘ä»¬åœ¨æ‹¿åˆ°é”ä¹‹åï¼Œå†ç»™é”åŠ ä¸Šä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚ 5sï¼Œè¿™æ ·å³ä½¿ä¸­é—´å‡ºç°å¼‚å¸¸ä¹Ÿå¯ä»¥ä¿è¯ 5 ç§’ä¹‹åé”ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚
```
> setnx lock:codehole true
OK
> expire lock:codehole 5
... do something critical ...
> del lock:codehole
(integer) 1
```
ä½†æ˜¯ä»¥ä¸Šé€»è¾‘è¿˜æœ‰é—®é¢˜ã€‚å¦‚æœåœ¨ setnx å’Œ expire ä¹‹é—´æœåŠ¡å™¨è¿›ç¨‹çªç„¶æŒ‚æ‰äº†ï¼Œå¯èƒ½æ˜¯å› ä¸ºæœºå™¨æ‰ç”µæˆ–è€…æ˜¯è¢«äººä¸ºæ€æ‰çš„ï¼Œå°±ä¼šå¯¼è‡´ expire å¾—ä¸åˆ°æ‰§è¡Œï¼Œä¹Ÿä¼šé€ æˆæ­»é”ã€‚

è¿™ç§é—®é¢˜çš„æ ¹æºå°±åœ¨äº setnx å’Œ expire æ˜¯ä¸¤æ¡æŒ‡ä»¤è€Œä¸æ˜¯åŸå­æŒ‡ä»¤ã€‚å¦‚æœè¿™ä¸¤æ¡æŒ‡ä»¤å¯ä»¥ä¸€èµ·æ‰§è¡Œå°±ä¸ä¼šå‡ºç°é—®é¢˜ã€‚ä¹Ÿè®¸ä½ ä¼šæƒ³åˆ°ç”¨ Redis äº‹åŠ¡æ¥è§£å†³ã€‚ä½†æ˜¯è¿™é‡Œä¸è¡Œï¼Œå› ä¸º expire æ˜¯ä¾èµ–äº setnx çš„æ‰§è¡Œç»“æœçš„ï¼Œå¦‚æœ setnx æ²¡æŠ¢åˆ°é”ï¼Œexpire æ˜¯ä¸åº”è¯¥æ‰§è¡Œçš„ã€‚äº‹åŠ¡é‡Œæ²¡æœ‰ if-else åˆ†æ”¯é€»è¾‘ï¼Œäº‹åŠ¡çš„ç‰¹ç‚¹æ˜¯ä¸€å£æ°”æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œè¦ä¹ˆä¸€ä¸ªéƒ½ä¸æ‰§è¡Œã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªç–‘éš¾ï¼ŒRedis å¼€æºç¤¾åŒºæ¶Œç°äº†ä¸€å †åˆ†å¸ƒå¼é”çš„ libraryï¼Œä¸“é—¨ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å®ç°æ–¹æ³•æä¸ºå¤æ‚ï¼Œå°ç™½ç”¨æˆ·ä¸€èˆ¬è¦è´¹å¾ˆå¤§çš„ç²¾åŠ›æ‰å¯ä»¥ææ‡‚ã€‚å¦‚æœä½ éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œæ„å‘³ç€ä½ ä¸èƒ½ä»…ä»…ä½¿ç”¨ Jedis æˆ–è€… redis-py å°±è¡Œäº†ï¼Œè¿˜å¾—å¼•å…¥åˆ†å¸ƒå¼é”çš„ libraryã€‚

![](https://user-gold-cdn.xitu.io/2018/7/2/16459b393843f7ae?w=512&h=200&f=gif&s=218111)

ä¸ºäº†æ²»ç†è¿™ä¸ªä¹±è±¡ï¼ŒRedis 2.8 ç‰ˆæœ¬ä¸­ä½œè€…åŠ å…¥äº† set æŒ‡ä»¤çš„æ‰©å±•å‚æ•°ï¼Œä½¿å¾— setnx å’Œ expire æŒ‡ä»¤å¯ä»¥ä¸€èµ·æ‰§è¡Œï¼Œå½»åº•è§£å†³äº†åˆ†å¸ƒå¼é”çš„ä¹±è±¡ã€‚ä»æ­¤ä»¥åæ‰€æœ‰çš„ç¬¬ä¸‰æ–¹åˆ†å¸ƒå¼é” library å¯ä»¥ä¼‘æ¯äº†ã€‚
```
> set lock:codehole true ex 5 nx
OK
... do something critical ...
> del lock:codehole
```
ä¸Šé¢è¿™ä¸ªæŒ‡ä»¤å°±æ˜¯ setnx å’Œ expire ç»„åˆåœ¨ä¸€èµ·çš„åŸå­æŒ‡ä»¤ï¼Œå®ƒå°±æ˜¯åˆ†å¸ƒå¼é”çš„å¥¥ä¹‰æ‰€åœ¨ã€‚

## è¶…æ—¶é—®é¢˜

Redis çš„åˆ†å¸ƒå¼é”ä¸èƒ½è§£å†³è¶…æ—¶é—®é¢˜ï¼Œå¦‚æœåœ¨åŠ é”å’Œé‡Šæ”¾é”ä¹‹é—´çš„é€»è¾‘æ‰§è¡Œçš„å¤ªé•¿ï¼Œä»¥è‡³äºè¶…å‡ºäº†é”çš„è¶…æ—¶é™åˆ¶ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚å› ä¸ºè¿™æ—¶å€™ç¬¬ä¸€ä¸ªçº¿ç¨‹æŒæœ‰çš„é”è¿‡æœŸäº†ï¼Œä¸´ç•ŒåŒºçš„é€»è¾‘è¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼Œè¿™ä¸ªæ—¶å€™ç¬¬äºŒä¸ªçº¿ç¨‹å°±æå‰é‡æ–°æŒæœ‰äº†è¿™æŠŠé”ï¼Œå¯¼è‡´ä¸´ç•ŒåŒºä»£ç ä¸èƒ½å¾—åˆ°ä¸¥æ ¼çš„ä¸²è¡Œæ‰§è¡Œã€‚

ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼ŒRedis åˆ†å¸ƒå¼é”ä¸è¦ç”¨äºè¾ƒé•¿æ—¶é—´çš„ä»»åŠ¡ã€‚å¦‚æœçœŸçš„å¶å°”å‡ºç°äº†ï¼Œæ•°æ®å‡ºç°çš„å°æ³¢é”™ä¹±å¯èƒ½éœ€è¦äººå·¥ä»‹å…¥è§£å†³ã€‚

```py
tag = random.nextint()  # éšæœºæ•°
if redis.set(key, tag, nx=True, ex=5):
    do_something()
    redis.delifequals(key, tag)  # å‡æƒ³çš„ delifequals æŒ‡ä»¤
```

æœ‰ä¸€ä¸ªç¨å¾®å®‰å…¨ä¸€ç‚¹çš„æ–¹æ¡ˆæ˜¯ä¸º set æŒ‡ä»¤çš„ value å‚æ•°è®¾ç½®ä¸ºä¸€ä¸ªéšæœºæ•°ï¼Œé‡Šæ”¾é”æ—¶å…ˆåŒ¹é…éšæœºæ•°æ˜¯å¦ä¸€è‡´ï¼Œç„¶åå†åˆ é™¤ keyï¼Œè¿™æ˜¯ä¸ºäº†ç¡®ä¿å½“å‰çº¿ç¨‹å æœ‰çš„é”ä¸ä¼šè¢«å…¶å®ƒçº¿ç¨‹é‡Šæ”¾ï¼Œé™¤éè¿™ä¸ªé”æ˜¯è¿‡æœŸäº†è¢«æœåŠ¡å™¨è‡ªåŠ¨é‡Šæ”¾çš„ã€‚
ä½†æ˜¯åŒ¹é… value å’Œåˆ é™¤ key ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼ŒRedis ä¹Ÿæ²¡æœ‰æä¾›ç±»ä¼¼äº```delifequals```è¿™æ ·çš„æŒ‡ä»¤ï¼Œè¿™å°±éœ€è¦ä½¿ç”¨ Lua è„šæœ¬æ¥å¤„ç†äº†ï¼Œå› ä¸º Lua è„šæœ¬å¯ä»¥ä¿è¯è¿ç»­å¤šä¸ªæŒ‡ä»¤çš„åŸå­æ€§æ‰§è¡Œã€‚
```lua
# delifequals
if redis.call("get",KEYS[1]) == ARGV[1] then
    return redis.call("del",KEYS[1])
else
    return 0
end
```
ä½†æ˜¯è¿™ä¹Ÿä¸æ˜¯ä¸€ä¸ªå®Œç¾çš„æ–¹æ¡ˆï¼Œå®ƒåªæ˜¯ç›¸å¯¹å®‰å…¨ä¸€ç‚¹ï¼Œå› ä¸ºå¦‚æœçœŸçš„è¶…æ—¶äº†ï¼Œå½“å‰çº¿ç¨‹çš„é€»è¾‘æ²¡æœ‰æ‰§è¡Œå®Œï¼Œå…¶å®ƒçº¿ç¨‹ä¹Ÿä¼šä¹˜è™šè€Œå…¥ã€‚

## å¯é‡å…¥æ€§

å¯é‡å…¥æ€§æ˜¯æŒ‡çº¿ç¨‹åœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹å†æ¬¡è¯·æ±‚åŠ é”ï¼Œå¦‚æœä¸€ä¸ªé”æ”¯æŒåŒä¸€ä¸ªçº¿ç¨‹çš„å¤šæ¬¡åŠ é”ï¼Œé‚£ä¹ˆè¿™ä¸ªé”å°±æ˜¯å¯é‡å…¥çš„ã€‚æ¯”å¦‚ Java è¯­è¨€é‡Œæœ‰ä¸ª ReentrantLock å°±æ˜¯å¯é‡å…¥é”ã€‚Redis åˆ†å¸ƒå¼é”å¦‚æœè¦æ”¯æŒå¯é‡å…¥ï¼Œéœ€è¦å¯¹å®¢æˆ·ç«¯çš„ set æ–¹æ³•è¿›è¡ŒåŒ…è£…ï¼Œä½¿ç”¨çº¿ç¨‹çš„ Threadlocal å˜é‡å­˜å‚¨å½“å‰æŒæœ‰é”çš„è®¡æ•°ã€‚
```py
# -*- coding: utf-8
import redis
import threading


locks = threading.local()
locks.redis = {}

def key_for(user_id):
    return "account_{}".format(user_id)

def _lock(client, key):
    return bool(client.set(key, True, nx=True, ex=5))

def _unlock(client, key):
    client.delete(key)

def lock(client, user_id):
    key = key_for(user_id)
    if key in locks.redis:
        locks.redis[key] += 1
        return True
    ok = _lock(client, key)
    if not ok:
        return False
    locks.redis[key] = 1
    return True

def unlock(client, user_id):
    key = key_for(user_id)
    if key in locks.redis:
        locks.redis[key] -= 1
        if locks.redis[key] <= 0:
            del locks.redis[key]
            self._unlock(key)
        return True
    return False

client = redis.StrictRedis()
print "lock", lock(client, "codehole")
print "lock", lock(client, "codehole")
print "unlock", unlock(client, "codehole")
print "unlock", unlock(client, "codehole")

```
ä»¥ä¸Šè¿˜ä¸æ˜¯å¯é‡å…¥é”çš„å…¨éƒ¨ï¼Œç²¾ç¡®ä¸€ç‚¹è¿˜éœ€è¦è€ƒè™‘å†…å­˜é”è®¡æ•°çš„è¿‡æœŸæ—¶é—´ï¼Œä»£ç å¤æ‚åº¦å°†ä¼šç»§ç»­å‡é«˜ã€‚è€é’±ä¸æ¨èä½¿ç”¨å¯é‡å…¥é”ï¼Œå®ƒåŠ é‡äº†å®¢æˆ·ç«¯çš„å¤æ‚æ€§ï¼Œåœ¨ç¼–å†™ä¸šåŠ¡æ–¹æ³•æ—¶æ³¨æ„åœ¨é€»è¾‘ç»“æ„ä¸Šè¿›è¡Œè°ƒæ•´å®Œå…¨å¯ä»¥ä¸ä½¿ç”¨å¯é‡å…¥é”ã€‚ä¸‹é¢æ˜¯ Java ç‰ˆæœ¬çš„å¯é‡å…¥é”ã€‚
```java
public class RedisWithReentrantLock {

  private ThreadLocal<Map<String, Integer>> lockers = new ThreadLocal<>();

  private Jedis jedis;

  public RedisWithReentrantLock(Jedis jedis) {
    this.jedis = jedis;
  }

  private boolean _lock(String key) {
    return jedis.set(key, "", "nx", "ex", 5L) != null;
  }

  private void _unlock(String key) {
    jedis.del(key);
  }

  private Map<String, Integer> currentLockers() {
    Map<String, Integer> refs = lockers.get();
    if (refs != null) {
      return refs;
    }
    lockers.set(new HashMap<>());
    return lockers.get();
  }

  public boolean lock(String key) {
    Map<String, Integer> refs = currentLockers();
    Integer refCnt = refs.get(key);
    if (refCnt != null) {
      refs.put(key, refCnt + 1);
      return true;
    }
    boolean ok = this._lock(key);
    if (!ok) {
      return false;
    }
    refs.put(key, 1);
    return true;
  }

  public boolean unlock(String key) {
    Map<String, Integer> refs = currentLockers();
    Integer refCnt = refs.get(key);
    if (refCnt == null) {
      return false;
    }
    refCnt -= 1;
    if (refCnt > 0) {
      refs.put(key, refCnt);
    } else {
      refs.remove(key);
      this._unlock(key);
    }
    return true;
  }

  public static void main(String[] args) {
    Jedis jedis = new Jedis();
    RedisWithReentrantLock redis = new RedisWithReentrantLock(jedis);
    System.out.println(redis.lock("codehole"));
    System.out.println(redis.lock("codehole"));
    System.out.println(redis.unlock("codehole"));
    System.out.println(redis.unlock("codehole"));
  }

}
```
è·Ÿ Python ç‰ˆæœ¬åŒºåˆ«ä¸å¤§ï¼Œä¹Ÿæ˜¯åŸºäº ThreadLocal å’Œå¼•ç”¨è®¡æ•°ã€‚

ä»¥ä¸Šè¿˜ä¸æ˜¯åˆ†å¸ƒå¼é”çš„å…¨éƒ¨ï¼Œåœ¨å°å†Œçš„æ‹“å±•ç¯‡[ã€Šæ‹¾é—æ¼è¡¥ â€”â€” å†è°ˆåˆ†å¸ƒå¼é”ã€‹](https://juejin.im/book/5afc2e5f6fb9a07a9b362527/section/5b4c19216fb9a04fb8773ed1)ï¼Œæˆ‘ä»¬è¿˜ä¼šç»§ç»­å¯¹åˆ†å¸ƒå¼é”åšè¿›ä¸€æ­¥çš„æ·±å…¥ç†è§£ã€‚

## æ€è€ƒé¢˜
1. Review ä¸‹ä½ è‡ªå·±çš„é¡¹ç›®ä»£ç ä¸­çš„åˆ†å¸ƒå¼é”ï¼Œå®ƒçš„ä½¿ç”¨æ–¹å¼æ˜¯å¦æ ‡å‡†æ­£ç¡®ï¼Ÿ
2. å¦‚æœä½ è¿˜æ²¡ç”¨è¿‡åˆ†å¸ƒå¼é”ï¼Œæƒ³æƒ³è‡ªå·±çš„é¡¹ç›®ä¸­æ˜¯å¦å¯ä»¥ç”¨ä¸Šï¼Ÿ
# åº”ç”¨ 2ï¼šç¼“å…µä¹‹è®¡ â€”â€” å»¶æ—¶é˜Ÿåˆ—

æˆ‘ä»¬å¹³æ—¶ä¹ æƒ¯äºä½¿ç”¨ Rabbitmq å’Œ Kafka ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œæ¥ç»™åº”ç”¨ç¨‹åºä¹‹é—´å¢åŠ å¼‚æ­¥æ¶ˆæ¯ä¼ é€’åŠŸèƒ½ã€‚è¿™ä¸¤ä¸ªä¸­é—´ä»¶éƒ½æ˜¯ä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œç‰¹æ€§ä¹‹å¤šè¶…å‡ºäº†å¤§å¤šæ•°äººçš„ç†è§£èƒ½åŠ›ã€‚

ä½¿ç”¨è¿‡ Rabbitmq çš„åŒå­¦çŸ¥é“å®ƒä½¿ç”¨èµ·æ¥æœ‰å¤šå¤æ‚ï¼Œå‘æ¶ˆæ¯ä¹‹å‰è¦åˆ›å»º Exchangeï¼Œå†åˆ›å»º Queueï¼Œè¿˜è¦å°† Queue å’Œ Exchange é€šè¿‡æŸç§è§„åˆ™ç»‘å®šèµ·æ¥ï¼Œå‘æ¶ˆæ¯çš„æ—¶å€™è¦æŒ‡å®š routing-keyï¼Œè¿˜è¦æ§åˆ¶å¤´éƒ¨ä¿¡æ¯ã€‚æ¶ˆè´¹è€…åœ¨æ¶ˆè´¹æ¶ˆæ¯ä¹‹å‰ä¹Ÿè¦è¿›è¡Œä¸Šé¢ä¸€ç³»åˆ—çš„ç¹çè¿‡ç¨‹ã€‚ä½†æ˜¯ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè™½ç„¶æˆ‘ä»¬çš„æ¶ˆæ¯é˜Ÿåˆ—åªæœ‰ä¸€ç»„æ¶ˆè´¹è€…ï¼Œä½†è¿˜æ˜¯éœ€è¦ç»å†ä¸Šé¢è¿™äº›ç¹ççš„è¿‡ç¨‹ã€‚

æœ‰äº† Redisï¼Œå®ƒå°±å¯ä»¥è®©æˆ‘ä»¬è§£è„±å‡ºæ¥ï¼Œå¯¹äºé‚£äº›åªæœ‰ä¸€ç»„æ¶ˆè´¹è€…çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½¿ç”¨ Redis å°±å¯ä»¥éå¸¸è½»æ¾çš„æå®šã€‚Redis çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸æ˜¯ä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ƒæ²¡æœ‰éå¸¸å¤šçš„é«˜çº§ç‰¹æ€§ï¼Œæ²¡æœ‰ ack ä¿è¯ï¼Œå¦‚æœå¯¹æ¶ˆæ¯çš„å¯é æ€§æœ‰ç€æè‡´çš„è¿½æ±‚ï¼Œé‚£ä¹ˆå®ƒå°±ä¸é€‚åˆä½¿ç”¨ã€‚

å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—
--
Redis çš„ list(åˆ—è¡¨) æ•°æ®ç»“æ„å¸¸ç”¨æ¥ä½œä¸ºå¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨ï¼Œä½¿ç”¨```rpush/lpush```æ“ä½œå…¥é˜Ÿåˆ—ï¼Œä½¿ç”¨```lpop å’Œ rpop```æ¥å‡ºé˜Ÿåˆ—ã€‚


![](https://user-gold-cdn.xitu.io/2018/7/10/1648229e1dbfd776?w=862&h=179&f=png&s=17012)
```
> rpush notify-queue apple banana pear
(integer) 3
> llen notify-queue
(integer) 3
> lpop notify-queue
"apple"
> llen notify-queue
(integer) 2
> lpop notify-queue
"banana"
> llen notify-queue
(integer) 1
> lpop notify-queue
"pear"
> llen notify-queue
(integer) 0
> lpop notify-queue
(nil)
```

ä¸Šé¢æ˜¯ rpush å’Œ lpop ç»“åˆä½¿ç”¨çš„ä¾‹å­ã€‚è¿˜å¯ä»¥ä½¿ç”¨ lpush å’Œ rpop ç»“åˆä½¿ç”¨ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚è¿™é‡Œä¸å†èµ˜è¿°ã€‚

é˜Ÿåˆ—ç©ºäº†æ€ä¹ˆåŠï¼Ÿ
--
å®¢æˆ·ç«¯æ˜¯é€šè¿‡é˜Ÿåˆ—çš„ pop æ“ä½œæ¥è·å–æ¶ˆæ¯ï¼Œç„¶åè¿›è¡Œå¤„ç†ã€‚å¤„ç†å®Œäº†å†æ¥ç€è·å–æ¶ˆæ¯ï¼Œå†è¿›è¡Œå¤„ç†ã€‚å¦‚æ­¤å¾ªç¯å¾€å¤ï¼Œè¿™ä¾¿æ˜¯ä½œä¸ºé˜Ÿåˆ—æ¶ˆè´¹è€…çš„å®¢æˆ·ç«¯çš„ç”Ÿå‘½å‘¨æœŸã€‚

å¯æ˜¯å¦‚æœé˜Ÿåˆ—ç©ºäº†ï¼Œå®¢æˆ·ç«¯å°±ä¼šé™·å…¥ pop çš„æ­»å¾ªç¯ï¼Œä¸åœåœ° popï¼Œæ²¡æœ‰æ•°æ®ï¼Œæ¥ç€å† popï¼Œåˆæ²¡æœ‰æ•°æ®ã€‚è¿™å°±æ˜¯æµªè´¹ç”Ÿå‘½çš„ç©ºè½®è¯¢ã€‚ç©ºè½®è¯¢ä¸ä½†æ‹‰é«˜äº†å®¢æˆ·ç«¯çš„ CPUï¼Œredis çš„ QPS ä¹Ÿä¼šè¢«æ‹‰é«˜ï¼Œå¦‚æœè¿™æ ·ç©ºè½®è¯¢çš„å®¢æˆ·ç«¯æœ‰å‡ åæ¥ä¸ªï¼ŒRedis çš„æ…¢æŸ¥è¯¢å¯èƒ½ä¼šæ˜¾è‘—å¢å¤šã€‚

é€šå¸¸æˆ‘ä»¬ä½¿ç”¨ sleep æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè®©çº¿ç¨‹ç¡ä¸€ä¼šï¼Œç¡ä¸ª 1s é’Ÿå°±å¯ä»¥äº†ã€‚ä¸ä½†å®¢æˆ·ç«¯çš„ CPU èƒ½é™ä¸‹æ¥ï¼ŒRedis çš„ QPS ä¹Ÿé™ä¸‹æ¥äº†ã€‚
```
time.sleep(1)  # python ç¡ 1s
Thread.sleep(1000)  # java ç¡ 1s
```

![](https://user-gold-cdn.xitu.io/2018/7/10/164822ccec7ccb85?w=808&h=266&f=png&s=31608)

é˜Ÿåˆ—å»¶è¿Ÿ
--
ç”¨ä¸Šé¢ç¡çœ çš„åŠæ³•å¯ä»¥è§£å†³é—®é¢˜ã€‚ä½†æ˜¯æœ‰ä¸ªå°é—®é¢˜ï¼Œé‚£å°±æ˜¯ç¡çœ ä¼šå¯¼è‡´æ¶ˆæ¯çš„å»¶è¿Ÿå¢å¤§ã€‚å¦‚æœåªæœ‰ 1 ä¸ªæ¶ˆè´¹è€…ï¼Œé‚£ä¹ˆè¿™ä¸ªå»¶è¿Ÿå°±æ˜¯ 1sã€‚å¦‚æœæœ‰å¤šä¸ªæ¶ˆè´¹è€…ï¼Œè¿™ä¸ªå»¶è¿Ÿä¼šæœ‰æ‰€ä¸‹é™ï¼Œå› ä¸ºæ¯ä¸ªæ¶ˆè´¹è€…çš„ç¡è§‰æ—¶é—´æ˜¯å²”å¼€æ¥çš„ã€‚

æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•èƒ½æ˜¾è‘—é™ä½å»¶è¿Ÿå‘¢ï¼Ÿä½ å½“ç„¶å¯ä»¥å¾ˆå¿«æƒ³åˆ°ï¼šé‚£å°±æŠŠç¡è§‰çš„æ—¶é—´ç¼©çŸ­ç‚¹ã€‚è¿™ç§æ–¹å¼å½“ç„¶å¯ä»¥ï¼Œä¸è¿‡æœ‰æ²¡æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿå½“ç„¶ä¹Ÿæœ‰ï¼Œé‚£å°±æ˜¯ blpop/brpopã€‚

è¿™ä¸¤ä¸ªæŒ‡ä»¤çš„å‰ç¼€å­—ç¬¦```b```ä»£è¡¨çš„æ˜¯```blocking```ï¼Œä¹Ÿå°±æ˜¯é˜»å¡è¯»ã€‚

é˜»å¡è¯»åœ¨é˜Ÿåˆ—æ²¡æœ‰æ•°æ®çš„æ—¶å€™ï¼Œä¼šç«‹å³è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œä¸€æ—¦æ•°æ®åˆ°æ¥ï¼Œåˆ™ç«‹åˆ»é†’è¿‡æ¥ã€‚æ¶ˆæ¯çš„å»¶è¿Ÿå‡ ä¹ä¸ºé›¶ã€‚ç”¨```blpop/brpop```æ›¿ä»£å‰é¢çš„```lpop/rpop```ï¼Œå°±å®Œç¾è§£å†³äº†ä¸Šé¢çš„é—®é¢˜ã€‚

ç©ºé—²è¿æ¥è‡ªåŠ¨æ–­å¼€
--
ä½ ä»¥ä¸ºä¸Šé¢çš„æ–¹æ¡ˆçœŸçš„å¾ˆå®Œç¾ä¹ˆï¼Ÿå…ˆåˆ«æ€¥ç€å¼€å¿ƒï¼Œå…¶å®ä»–è¿˜æœ‰ä¸ªé—®é¢˜éœ€è¦è§£å†³ã€‚

ä»€ä¹ˆé—®é¢˜ï¼Ÿâ€”â€” **ç©ºé—²è¿æ¥**çš„é—®é¢˜ã€‚

å¦‚æœçº¿ç¨‹ä¸€ç›´é˜»å¡åœ¨å“ªé‡Œï¼ŒRedis çš„å®¢æˆ·ç«¯è¿æ¥å°±æˆäº†é—²ç½®è¿æ¥ï¼Œé—²ç½®è¿‡ä¹…ï¼ŒæœåŠ¡å™¨ä¸€èˆ¬ä¼šä¸»åŠ¨æ–­å¼€è¿æ¥ï¼Œå‡å°‘é—²ç½®èµ„æºå ç”¨ã€‚è¿™ä¸ªæ—¶å€™```blpop/brpop```ä¼šæŠ›å‡ºå¼‚å¸¸æ¥ã€‚

æ‰€ä»¥ç¼–å†™å®¢æˆ·ç«¯æ¶ˆè´¹è€…çš„æ—¶å€™è¦å°å¿ƒï¼Œæ³¨æ„æ•è·å¼‚å¸¸ï¼Œè¿˜è¦é‡è¯•ã€‚

é”å†²çªå¤„ç†
--
ä¸ŠèŠ‚è¯¾æˆ‘ä»¬è®²äº†åˆ†å¸ƒå¼é”çš„é—®é¢˜ï¼Œä½†æ˜¯æ²¡æœ‰æåˆ°å®¢æˆ·ç«¯åœ¨å¤„ç†è¯·æ±‚æ—¶åŠ é”æ²¡åŠ æˆåŠŸæ€ä¹ˆåŠã€‚ä¸€èˆ¬æœ‰ 3 ç§ç­–ç•¥æ¥å¤„ç†åŠ é”å¤±è´¥ï¼š
1. ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œé€šçŸ¥ç”¨æˆ·ç¨åé‡è¯•ï¼›
2. sleep ä¸€ä¼šå†é‡è¯•ï¼›
3. å°†è¯·æ±‚è½¬ç§»è‡³å»¶æ—¶é˜Ÿåˆ—ï¼Œè¿‡ä¸€ä¼šå†è¯•ï¼›

**ç›´æ¥æŠ›å‡ºç‰¹å®šç±»å‹çš„å¼‚å¸¸**

è¿™ç§æ–¹å¼æ¯”è¾ƒé€‚åˆç”±ç”¨æˆ·ç›´æ¥å‘èµ·çš„è¯·æ±‚ï¼Œç”¨æˆ·çœ‹åˆ°é”™è¯¯å¯¹è¯æ¡†åï¼Œä¼šå…ˆé˜…è¯»å¯¹è¯æ¡†çš„å†…å®¹ï¼Œå†ç‚¹å‡»é‡è¯•ï¼Œè¿™æ ·å°±å¯ä»¥èµ·åˆ°äººå·¥å»¶æ—¶çš„æ•ˆæœã€‚å¦‚æœè€ƒè™‘åˆ°ç”¨æˆ·ä½“éªŒï¼Œå¯ä»¥ç”±å‰ç«¯çš„ä»£ç æ›¿ä»£ç”¨æˆ·è‡ªå·±æ¥è¿›è¡Œå»¶æ—¶é‡è¯•æ§åˆ¶ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯å¯¹å½“å‰è¯·æ±‚çš„æ”¾å¼ƒï¼Œç”±ç”¨æˆ·å†³å®šæ˜¯å¦é‡æ–°å‘èµ·æ–°çš„è¯·æ±‚ã€‚

**sleep**

sleep ä¼šé˜»å¡å½“å‰çš„æ¶ˆæ¯å¤„ç†çº¿ç¨‹ï¼Œä¼šå¯¼è‡´é˜Ÿåˆ—çš„åç»­æ¶ˆæ¯å¤„ç†å‡ºç°å»¶è¿Ÿã€‚å¦‚æœç¢°æ’çš„æ¯”è¾ƒé¢‘ç¹æˆ–è€…é˜Ÿåˆ—é‡Œæ¶ˆæ¯æ¯”è¾ƒå¤šï¼Œsleep å¯èƒ½å¹¶ä¸åˆé€‚ã€‚å¦‚æœå› ä¸ºä¸ªåˆ«æ­»é”çš„ key å¯¼è‡´åŠ é”ä¸æˆåŠŸï¼Œçº¿ç¨‹ä¼šå½»åº•å µæ­»ï¼Œå¯¼è‡´åç»­æ¶ˆæ¯æ°¸è¿œå¾—ä¸åˆ°åŠæ—¶å¤„ç†ã€‚

**å»¶æ—¶é˜Ÿåˆ—**

è¿™ç§æ–¹å¼æ¯”è¾ƒé€‚åˆå¼‚æ­¥æ¶ˆæ¯å¤„ç†ï¼Œå°†å½“å‰å†²çªçš„è¯·æ±‚æ‰”åˆ°å¦ä¸€ä¸ªé˜Ÿåˆ—å»¶åå¤„ç†ä»¥é¿å¼€å†²çªã€‚

å»¶æ—¶é˜Ÿåˆ—çš„å®ç°
--
å»¶æ—¶é˜Ÿåˆ—å¯ä»¥é€šè¿‡ Redis çš„ zset(æœ‰åºåˆ—è¡¨) æ¥å®ç°ã€‚æˆ‘ä»¬å°†æ¶ˆæ¯åºåˆ—åŒ–æˆä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸º zset çš„```value```ï¼Œè¿™ä¸ªæ¶ˆæ¯çš„åˆ°æœŸå¤„ç†æ—¶é—´ä½œä¸º```score```ï¼Œç„¶åç”¨å¤šä¸ªçº¿ç¨‹è½®è¯¢ zset è·å–åˆ°æœŸçš„ä»»åŠ¡è¿›è¡Œå¤„ç†ï¼Œå¤šä¸ªçº¿ç¨‹æ˜¯ä¸ºäº†ä¿éšœå¯ç”¨æ€§ï¼Œä¸‡ä¸€æŒ‚äº†ä¸€ä¸ªçº¿ç¨‹è¿˜æœ‰å…¶å®ƒçº¿ç¨‹å¯ä»¥ç»§ç»­å¤„ç†ã€‚å› ä¸ºæœ‰å¤šä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥éœ€è¦è€ƒè™‘å¹¶å‘äº‰æŠ¢ä»»åŠ¡ï¼Œç¡®ä¿ä»»åŠ¡ä¸èƒ½è¢«å¤šæ¬¡æ‰§è¡Œã€‚

```py
def delay(msg):
    msg.id = str(uuid.uuid4())  # ä¿è¯ value å€¼å”¯ä¸€
    value = json.dumps(msg)
    retry_ts = time.time() + 5  # 5 ç§’åé‡è¯•
    redis.zadd("delay-queue", retry_ts, value)


def loop():
    while True:
        # æœ€å¤šå– 1 æ¡
        values = redis.zrangebyscore("delay-queue", 0, time.time(), start=0, num=1)
        if not values:
            time.sleep(1)  # å»¶æ—¶é˜Ÿåˆ—ç©ºçš„ï¼Œä¼‘æ¯ 1s
            continue
        value = values[0]  # æ‹¿ç¬¬ä¸€æ¡ï¼Œä¹Ÿåªæœ‰ä¸€æ¡
        success = redis.zrem("delay-queue", value)  # ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç§»é™¤è¯¥æ¶ˆæ¯
        if success:  # å› ä¸ºæœ‰å¤šè¿›ç¨‹å¹¶å‘çš„å¯èƒ½ï¼Œæœ€ç»ˆåªä¼šæœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æŠ¢åˆ°æ¶ˆæ¯
            msg = json.loads(value)
            handle_msg(msg)
```
Redis çš„ zrem æ–¹æ³•æ˜¯å¤šçº¿ç¨‹å¤šè¿›ç¨‹äº‰æŠ¢ä»»åŠ¡çš„å…³é”®ï¼Œå®ƒçš„è¿”å›å€¼å†³å®šäº†å½“å‰å®ä¾‹æœ‰æ²¡æœ‰æŠ¢åˆ°ä»»åŠ¡ï¼Œå› ä¸º loop æ–¹æ³•å¯èƒ½ä¼šè¢«å¤šä¸ªçº¿ç¨‹ã€å¤šä¸ªè¿›ç¨‹è°ƒç”¨ï¼ŒåŒä¸€ä¸ªä»»åŠ¡å¯èƒ½ä¼šè¢«å¤šä¸ªè¿›ç¨‹çº¿ç¨‹æŠ¢åˆ°ï¼Œé€šè¿‡ zrem æ¥å†³å®šå”¯ä¸€çš„å±ä¸»ã€‚

åŒæ—¶ï¼Œæˆ‘ä»¬è¦æ³¨æ„ä¸€å®šè¦å¯¹ handle_msg è¿›è¡Œå¼‚å¸¸æ•è·ï¼Œé¿å…å› ä¸ºä¸ªåˆ«ä»»åŠ¡å¤„ç†é—®é¢˜å¯¼è‡´å¾ªç¯å¼‚å¸¸é€€å‡ºã€‚ä»¥ä¸‹æ˜¯ Java ç‰ˆæœ¬çš„å»¶æ—¶é˜Ÿåˆ—å®ç°ï¼Œå› ä¸ºè¦ä½¿ç”¨åˆ° Json åºåˆ—åŒ–ï¼Œæ‰€ä»¥è¿˜éœ€è¦ fastjson åº“çš„æ”¯æŒã€‚
```java
import java.lang.reflect.Type;
import java.util.Set;
import java.util.UUID;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.TypeReference;

import redis.clients.jedis.Jedis;

public class RedisDelayingQueue<T> {

  static class TaskItem<T> {
    public String id;
    public T msg;
  }

  // fastjson åºåˆ—åŒ–å¯¹è±¡ä¸­å­˜åœ¨ generic ç±»å‹æ—¶ï¼Œéœ€è¦ä½¿ç”¨ TypeReference
  private Type TaskType = new TypeReference<TaskItem<T>>() {
  }.getType();

  private Jedis jedis;
  private String queueKey;

  public RedisDelayingQueue(Jedis jedis, String queueKey) {
    this.jedis = jedis;
    this.queueKey = queueKey;
  }

  public void delay(T msg) {
    TaskItem<T> task = new TaskItem<T>();
    task.id = UUID.randomUUID().toString(); // åˆ†é…å”¯ä¸€çš„ uuid
    task.msg = msg;
    String s = JSON.toJSONString(task); // fastjson åºåˆ—åŒ–
    jedis.zadd(queueKey, System.currentTimeMillis() + 5000, s); // å¡å…¥å»¶æ—¶é˜Ÿåˆ— ,5s åå†è¯•
  }

  public void loop() {
    while (!Thread.interrupted()) {
      // åªå–ä¸€æ¡
      Set<String> values = jedis.zrangeByScore(queueKey, 0, System.currentTimeMillis(), 0, 1);
      if (values.isEmpty()) {
        try {
          Thread.sleep(500); // æ­‡ä¼šç»§ç»­
        } catch (InterruptedException e) {
          break;
        }
        continue;
      }
      String s = values.iterator().next();
      if (jedis.zrem(queueKey, s) > 0) { // æŠ¢åˆ°äº†
        TaskItem<T> task = JSON.parseObject(s, TaskType); // fastjson ååºåˆ—åŒ–
        this.handleMsg(task.msg);
      }
    }
  }

  public void handleMsg(T msg) {
    System.out.println(msg);
  }

  public static void main(String[] args) {
    Jedis jedis = new Jedis();
    RedisDelayingQueue<String> queue = new RedisDelayingQueue<>(jedis, "q-demo");
    Thread producer = new Thread() {

      public void run() {
        for (int i = 0; i < 10; i++) {
          queue.delay("codehole" + i);
        }
      }

    };
    Thread consumer = new Thread() {

      public void run() {
        queue.loop();
      }

    };
    producer.start();
    consumer.start();
    try {
      producer.join();
      Thread.sleep(6000);
      consumer.interrupt();
      consumer.join();
    } catch (InterruptedException e) {
    }
  }
}
```

## è¿›ä¸€æ­¥ä¼˜åŒ–
ä¸Šé¢çš„ç®—æ³•ä¸­åŒä¸€ä¸ªä»»åŠ¡å¯èƒ½ä¼šè¢«å¤šä¸ªè¿›ç¨‹å–åˆ°ä¹‹åå†ä½¿ç”¨ zrem è¿›è¡Œäº‰æŠ¢ï¼Œé‚£äº›æ²¡æŠ¢åˆ°çš„è¿›ç¨‹éƒ½æ˜¯ç™½å–äº†ä¸€æ¬¡ä»»åŠ¡ï¼Œè¿™æ˜¯æµªè´¹ã€‚å¯ä»¥è€ƒè™‘ä½¿ç”¨ lua scripting æ¥ä¼˜åŒ–ä¸€ä¸‹è¿™ä¸ªé€»è¾‘ï¼Œå°† zrangebyscore å’Œ zrem ä¸€åŒæŒªåˆ°æœåŠ¡å™¨ç«¯è¿›è¡ŒåŸå­åŒ–æ“ä½œï¼Œè¿™æ ·å¤šä¸ªè¿›ç¨‹ä¹‹é—´äº‰æŠ¢ä»»åŠ¡æ—¶å°±ä¸ä¼šå‡ºç°è¿™ç§æµªè´¹äº†ã€‚

æ€è€ƒ
--
1. Redis ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ä¸ºä»€ä¹ˆä¸èƒ½ä¿è¯ 100% çš„å¯é æ€§ï¼Ÿ
2. ä½¿ç”¨ Lua Scripting æ¥ä¼˜åŒ–å»¶æ—¶é˜Ÿåˆ—çš„é€»è¾‘ã€‚
# åº”ç”¨ 3ï¼šèŠ‚è¡£ç¼©é£Ÿ â€”â€” ä½å›¾

åœ¨æˆ‘ä»¬å¹³æ—¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰ä¸€äº› bool å‹æ•°æ®éœ€è¦å­˜å–ï¼Œæ¯”å¦‚ç”¨æˆ·ä¸€å¹´çš„ç­¾åˆ°è®°å½•ï¼Œç­¾äº†æ˜¯ 1ï¼Œæ²¡ç­¾æ˜¯ 0ï¼Œè¦è®°å½• 365 å¤©ã€‚å¦‚æœä½¿ç”¨æ™®é€šçš„ key/valueï¼Œæ¯ä¸ªç”¨æˆ·è¦è®°å½• 365 ä¸ªï¼Œå½“ç”¨æˆ·ä¸Šäº¿çš„æ—¶å€™ï¼Œéœ€è¦çš„å­˜å‚¨ç©ºé—´æ˜¯æƒŠäººçš„ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedis æä¾›äº†ä½å›¾æ•°æ®ç»“æ„ï¼Œè¿™æ ·æ¯å¤©çš„ç­¾åˆ°è®°å½•åªå æ®ä¸€ä¸ªä½ï¼Œ365 å¤©å°±æ˜¯ 365 ä¸ªä½ï¼Œ46 ä¸ªå­—èŠ‚ (ä¸€ä¸ªç¨é•¿ä¸€ç‚¹çš„å­—ç¬¦ä¸²) å°±å¯ä»¥å®Œå…¨å®¹çº³ä¸‹ï¼Œè¿™å°±å¤§å¤§èŠ‚çº¦äº†å­˜å‚¨ç©ºé—´ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/2/1645926f4520d0ce?w=512&h=64&f=gif&s=28880)

ä½å›¾ä¸æ˜¯ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼Œå®ƒçš„å†…å®¹å…¶å®å°±æ˜¯æ™®é€šçš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯ byte æ•°ç»„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ™®é€šçš„ get/set ç›´æ¥è·å–å’Œè®¾ç½®æ•´ä¸ªä½å›¾çš„å†…å®¹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä½å›¾æ“ä½œ getbit/setbit ç­‰å°† byte æ•°ç»„çœ‹æˆã€Œä½æ•°ç»„ã€æ¥å¤„ç†ã€‚

å½“æˆ‘ä»¬è¦ç»Ÿè®¡æœˆæ´»çš„æ—¶å€™ï¼Œå› ä¸ºéœ€è¦å»é‡ï¼Œéœ€è¦ä½¿ç”¨ set æ¥è®°å½•æ‰€æœ‰æ´»è·ƒç”¨æˆ·çš„ idï¼Œè¿™éå¸¸æµªè´¹å†…å­˜ã€‚è¿™æ—¶å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨ä½å›¾æ¥æ ‡è®°ç”¨æˆ·çš„æ´»è·ƒçŠ¶æ€ã€‚æ¯ä¸ªç”¨æˆ·ä¼šéƒ½åœ¨è¿™ä¸ªä½å›¾çš„ä¸€ä¸ªç¡®å®šä½ç½®ä¸Šï¼Œ0 è¡¨ç¤ºä¸æ´»è·ƒï¼Œ1 è¡¨ç¤ºæ´»è·ƒã€‚ç„¶ååˆ°æœˆåº•éå†ä¸€æ¬¡ä½å›¾å°±å¯ä»¥å¾—åˆ°æœˆåº¦æ´»è·ƒç”¨æˆ·æ•°ã€‚ä¸è¿‡è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯æœ‰æ¡ä»¶çš„ï¼Œé‚£å°±æ˜¯ userid æ˜¯æ•´æ•°è¿ç»­çš„ï¼Œå¹¶ä¸”æ´»è·ƒå æ¯”è¾ƒé«˜ï¼Œå¦åˆ™å¯èƒ½å¾—ä¸å¿å¤±ã€‚

æœ¬èŠ‚ç•¥æ˜¾æ¯ç‡¥ï¼Œå¦‚æœè¯»è€…çœ‹çš„æœ‰ç‚¹è’™ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œè¯»è€…å¯ä»¥è·³è¿‡é˜…è¯»ä¸‹ä¸€èŠ‚ã€‚ä»¥è€é’±çš„ç»éªŒï¼Œåœ¨é¢è¯•ä¸­æœ‰ Redis ä½å›¾ä½¿ç”¨ç»éªŒçš„åŒå­¦å¾ˆå°‘ï¼Œå¦‚æœä½ å¯¹ Redis çš„ä½å›¾æœ‰æ‰€äº†è§£ï¼Œå®ƒå°†ä¼šæ˜¯ä½ çš„é¢è¯•åŠ åˆ†é¡¹ã€‚

## åŸºæœ¬ä½¿ç”¨
Redis çš„ä½æ•°ç»„æ˜¯è‡ªåŠ¨æ‰©å±•ï¼Œå¦‚æœè®¾ç½®äº†æŸä¸ªåç§»ä½ç½®è¶…å‡ºäº†ç°æœ‰çš„å†…å®¹èŒƒå›´ï¼Œå°±ä¼šè‡ªåŠ¨å°†ä½æ•°ç»„è¿›è¡Œé›¶æ‰©å……ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ä½æ“ä½œå°†å­—ç¬¦ä¸²è®¾ç½®ä¸º hello (ä¸æ˜¯ç›´æ¥ä½¿ç”¨ set æŒ‡ä»¤)ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å¾—åˆ° hello çš„ ASCII ç ï¼Œç”¨ Python å‘½ä»¤è¡Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¾—åˆ°æ¯ä¸ªå­—ç¬¦çš„ ASCII ç çš„äºŒè¿›åˆ¶å€¼ã€‚
```
>>> bin(ord('h'))
'0b1101000'   # é«˜ä½ -> ä½ä½
>>> bin(ord('e'))
'0b1100101'
>>> bin(ord('l'))
'0b1101100'
>>> bin(ord('l'))
'0b1101100'
>>> bin(ord('o'))
'0b1101111'
```

![](https://user-gold-cdn.xitu.io/2018/7/2/16459860644097de?w=512&h=300&f=gif&s=291045)

æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ redis-cli è®¾ç½®ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯ä½æ•°ç»„çš„å‰ 8 ä½ï¼Œæˆ‘ä»¬åªéœ€è¦è®¾ç½®å€¼ä¸º 1 çš„ä½ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œh å­—ç¬¦åªæœ‰ 1/2/4 ä½éœ€è¦è®¾ç½®ï¼Œe å­—ç¬¦åªæœ‰ 9/10/13/15 ä½éœ€è¦è®¾ç½®ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ä½æ•°ç»„çš„é¡ºåºå’Œå­—ç¬¦çš„ä½é¡ºåºæ˜¯ç›¸åçš„ã€‚
```
127.0.0.1:6379> setbit s 1 1
(integer) 0
127.0.0.1:6379> setbit s 2 1
(integer) 0
127.0.0.1:6379> setbit s 4 1
(integer) 0
127.0.0.1:6379> setbit s 9 1
(integer) 0
127.0.0.1:6379> setbit s 10 1
(integer) 0
127.0.0.1:6379> setbit s 13 1
(integer) 0
127.0.0.1:6379> setbit s 15 1
(integer) 0
127.0.0.1:6379> get s
"he"
```
ä¸Šé¢è¿™ä¸ªä¾‹å­å¯ä»¥ç†è§£ä¸ºã€Œé›¶å­˜æ•´å–ã€ï¼ŒåŒæ ·æˆ‘ä»¬è¿˜ä¹Ÿå¯ä»¥ã€Œé›¶å­˜é›¶å–ã€ï¼Œã€Œæ•´å­˜é›¶å–ã€ã€‚ã€Œé›¶å­˜ã€å°±æ˜¯ä½¿ç”¨ setbit å¯¹ä½å€¼è¿›è¡Œé€ä¸ªè®¾ç½®ï¼Œã€Œæ•´å­˜ã€å°±æ˜¯ä½¿ç”¨å­—ç¬¦ä¸²ä¸€æ¬¡æ€§å¡«å……æ‰€æœ‰ä½æ•°ç»„ï¼Œè¦†ç›–æ‰æ—§å€¼ã€‚

**é›¶å­˜é›¶å–**
```
127.0.0.1:6379> setbit w 1 1
(integer) 0
127.0.0.1:6379> setbit w 2 1
(integer) 0
127.0.0.1:6379> setbit w 4 1
(integer) 0
127.0.0.1:6379> getbit w 1  # è·å–æŸä¸ªå…·ä½“ä½ç½®çš„å€¼ 0/1
(integer) 1
127.0.0.1:6379> getbit w 2
(integer) 1
127.0.0.1:6379> getbit w 4
(integer) 1
127.0.0.1:6379> getbit w 5
(integer) 0
```

**æ•´å­˜é›¶å–**

```
127.0.0.1:6379> set w h  # æ•´å­˜
(integer) 0
127.0.0.1:6379> getbit w 1
(integer) 1
127.0.0.1:6379> getbit w 2
(integer) 1
127.0.0.1:6379> getbit w 4
(integer) 1
127.0.0.1:6379> getbit w 5
(integer) 0
```

å¦‚æœå¯¹åº”ä½çš„å­—èŠ‚æ˜¯ä¸å¯æ‰“å°å­—ç¬¦ï¼Œredis-cli ä¼šæ˜¾ç¤ºè¯¥å­—ç¬¦çš„ 16 è¿›åˆ¶å½¢å¼ã€‚
```
127.0.0.1:6379> setbit x 0 1
(integer) 0
127.0.0.1:6379> setbit x 1 1
(integer) 0
127.0.0.1:6379> get x
"\xc0"
```

## ç»Ÿè®¡å’ŒæŸ¥æ‰¾
Redis æä¾›äº†ä½å›¾ç»Ÿè®¡æŒ‡ä»¤ bitcount å’Œä½å›¾æŸ¥æ‰¾æŒ‡ä»¤ bitposï¼Œbitcount ç”¨æ¥ç»Ÿè®¡æŒ‡å®šä½ç½®èŒƒå›´å†… 1 çš„ä¸ªæ•°ï¼Œbitpos ç”¨æ¥æŸ¥æ‰¾æŒ‡å®šèŒƒå›´å†…å‡ºç°çš„ç¬¬ä¸€ä¸ª 0 æˆ– 1ã€‚

æ¯”å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ bitcount ç»Ÿè®¡ç”¨æˆ·ä¸€å…±ç­¾åˆ°äº†å¤šå°‘å¤©ï¼Œé€šè¿‡ bitpos æŒ‡ä»¤æŸ¥æ‰¾ç”¨æˆ·ä»å“ªä¸€å¤©å¼€å§‹ç¬¬ä¸€æ¬¡ç­¾åˆ°ã€‚å¦‚æœæŒ‡å®šäº†èŒƒå›´å‚æ•°` [start, end]`ï¼Œå°±å¯ä»¥ç»Ÿè®¡åœ¨æŸä¸ªæ—¶é—´èŒƒå›´å†…ç”¨æˆ·ç­¾åˆ°äº†å¤šå°‘å¤©ï¼Œç”¨æˆ·è‡ªæŸå¤©ä»¥åçš„å“ªå¤©å¼€å§‹ç­¾åˆ°ã€‚

é—æ†¾çš„æ˜¯ï¼Œ start å’Œ end å‚æ•°æ˜¯å­—èŠ‚ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯è¯´æŒ‡å®šçš„ä½èŒƒå›´å¿…é¡»æ˜¯ 8 çš„å€æ•°ï¼Œè€Œä¸èƒ½ä»»æ„æŒ‡å®šã€‚è¿™å¾ˆå¥‡æ€ªï¼Œæˆ‘è¡¨ç¤ºä¸æ˜¯å¾ˆèƒ½ç†è§£ Antirez ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ã€‚å› ä¸ºè¿™ä¸ªè®¾è®¡ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥è®¡ç®—æŸä¸ªæœˆå†…ç”¨æˆ·ç­¾åˆ°äº†å¤šå°‘å¤©ï¼Œè€Œå¿…é¡»è¦å°†è¿™ä¸ªæœˆæ‰€è¦†ç›–çš„å­—èŠ‚å†…å®¹å…¨éƒ¨å–å‡ºæ¥ (getrange å¯ä»¥å–å‡ºå­—ç¬¦ä¸²çš„å­ä¸²) ç„¶ååœ¨å†…å­˜é‡Œè¿›è¡Œç»Ÿè®¡ï¼Œè¿™ä¸ªéå¸¸ç¹çã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ç®€å•è¯•ç”¨ä¸€ä¸‹ bitcount æŒ‡ä»¤å’Œ bitpos æŒ‡ä»¤:
```
127.0.0.1:6379> set w hello
OK
127.0.0.1:6379> bitcount w
(integer) 21
127.0.0.1:6379> bitcount w 0 0  # ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸­ 1 çš„ä½æ•°
(integer) 3
127.0.0.1:6379> bitcount w 0 1  # å‰ä¸¤ä¸ªå­—ç¬¦ä¸­ 1 çš„ä½æ•°
(integer) 7
127.0.0.1:6379> bitpos w 0  # ç¬¬ä¸€ä¸ª 0 ä½
(integer) 0
127.0.0.1:6379> bitpos w 1  # ç¬¬ä¸€ä¸ª 1 ä½
(integer) 1
127.0.0.1:6379> bitpos w 1 1 1  # ä»ç¬¬äºŒä¸ªå­—ç¬¦ç®—èµ·ï¼Œç¬¬ä¸€ä¸ª 1 ä½
(integer) 9
127.0.0.1:6379> bitpos w 1 2 2  # ä»ç¬¬ä¸‰ä¸ªå­—ç¬¦ç®—èµ·ï¼Œç¬¬ä¸€ä¸ª 1 ä½
(integer) 17
```

## é­”æœ¯æŒ‡ä»¤ bitfield
å‰æ–‡æˆ‘ä»¬è®¾ç½® (setbit) å’Œè·å– (getbit) æŒ‡å®šä½çš„å€¼éƒ½æ˜¯å•ä¸ªä½çš„ï¼Œå¦‚æœè¦ä¸€æ¬¡æ“ä½œå¤šä¸ªä½ï¼Œå°±å¿…é¡»ä½¿ç”¨ç®¡é“æ¥å¤„ç†ã€‚

ä¸è¿‡ Redis çš„ 3.2 ç‰ˆæœ¬ä»¥åæ–°å¢äº†ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„æŒ‡ä»¤ï¼Œæœ‰äº†è¿™æ¡æŒ‡ä»¤ï¼Œä¸ç”¨ç®¡é“ä¹Ÿå¯ä»¥ä¸€æ¬¡è¿›è¡Œå¤šä¸ªä½çš„æ“ä½œã€‚

bitfield æœ‰ä¸‰ä¸ªå­æŒ‡ä»¤ï¼Œåˆ†åˆ«æ˜¯ get/set/incrbyï¼Œå®ƒä»¬éƒ½å¯ä»¥å¯¹æŒ‡å®šä½ç‰‡æ®µè¿›è¡Œè¯»å†™ï¼Œä½†æ˜¯æœ€å¤šåªèƒ½å¤„ç† 64 ä¸ªè¿ç»­çš„ä½ï¼Œå¦‚æœè¶…è¿‡ 64 ä½ï¼Œå°±å¾—ä½¿ç”¨å¤šä¸ªå­æŒ‡ä»¤ï¼Œbitfield å¯ä»¥ä¸€æ¬¡æ‰§è¡Œå¤šä¸ªå­æŒ‡ä»¤ã€‚


![](https://user-gold-cdn.xitu.io/2018/7/2/1645987653a2b337?w=732&h=400&f=png&s=24057)

æ¥ä¸‹æ¥æˆ‘ä»¬å¯¹ç…§ç€ä¸Šé¢çš„å›¾çœ‹ä¸ªç®€å•çš„ä¾‹å­:
```
127.0.0.1:6379> set w hello
OK
127.0.0.1:6379> bitfield w get u4 0  # ä»ç¬¬ä¸€ä¸ªä½å¼€å§‹å– 4 ä¸ªä½ï¼Œç»“æœæ˜¯æ— ç¬¦å·æ•° (u)
(integer) 6
127.0.0.1:6379> bitfield w get u3 2  # ä»ç¬¬ä¸‰ä¸ªä½å¼€å§‹å– 3 ä¸ªä½ï¼Œç»“æœæ˜¯æ— ç¬¦å·æ•° (u)
(integer) 5
127.0.0.1:6379> bitfield w get i4 0  # ä»ç¬¬ä¸€ä¸ªä½å¼€å§‹å– 4 ä¸ªä½ï¼Œç»“æœæ˜¯æœ‰ç¬¦å·æ•° (i)
1) (integer) 6
127.0.0.1:6379> bitfield w get i3 2  # ä»ç¬¬ä¸‰ä¸ªä½å¼€å§‹å– 3 ä¸ªä½ï¼Œç»“æœæ˜¯æœ‰ç¬¦å·æ•° (i)
1) (integer) -3
```
æ‰€è°“æœ‰ç¬¦å·æ•°æ˜¯æŒ‡è·å–çš„ä½æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªä½æ˜¯ç¬¦å·ä½ï¼Œå‰©ä¸‹çš„æ‰æ˜¯å€¼ã€‚å¦‚æœç¬¬ä¸€ä½æ˜¯ 1ï¼Œé‚£å°±æ˜¯è´Ÿæ•°ã€‚æ— ç¬¦å·æ•°è¡¨ç¤ºéè´Ÿæ•°ï¼Œæ²¡æœ‰ç¬¦å·ä½ï¼Œè·å–çš„ä½æ•°ç»„å…¨éƒ¨éƒ½æ˜¯å€¼ã€‚æœ‰ç¬¦å·æ•°æœ€å¤šå¯ä»¥è·å– 64 ä½ï¼Œæ— ç¬¦å·æ•°åªèƒ½è·å– 63 ä½ (å› ä¸º Redis åè®®ä¸­çš„ integer æ˜¯æœ‰ç¬¦å·æ•°ï¼Œæœ€å¤§ 64 ä½ï¼Œä¸èƒ½ä¼ é€’ 64 ä½æ— ç¬¦å·å€¼)ã€‚å¦‚æœè¶…å‡ºä½æ•°é™åˆ¶ï¼ŒRedis å°±ä¼šå‘Šè¯‰ä½ å‚æ•°é”™è¯¯ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€æ¬¡æ‰§è¡Œå¤šä¸ªå­æŒ‡ä»¤:
```
127.0.0.1:6379> bitfield w get u4 0 get u3 2 get i4 0 get i3 2
1) (integer) 6
2) (integer) 5
3) (integer) 6
4) (integer) -3
```
wowï¼Œå¾ˆé­”æ³•æœ‰æ²¡æœ‰ï¼

ç„¶åæˆ‘ä»¬ä½¿ç”¨ set å­æŒ‡ä»¤å°†ç¬¬äºŒä¸ªå­—ç¬¦ e æ”¹æˆ aï¼Œa çš„ ASCII ç æ˜¯ 97ï¼Œè¿”å›æ—§å€¼ã€‚
```
127.0.0.1:6379> bitfield w set u8 8 97  # ä»ç¬¬ 9 ä¸ªä½å¼€å§‹ï¼Œå°†æ¥ä¸‹æ¥çš„ 8 ä¸ªä½ç”¨æ— ç¬¦å·æ•° 97 æ›¿æ¢
1) (integer) 101
127.0.0.1:6379> get w
"hallo"
```

å†çœ‹ç¬¬ä¸‰ä¸ªå­æŒ‡ä»¤ incrbyï¼Œå®ƒç”¨æ¥å¯¹æŒ‡å®šèŒƒå›´çš„ä½è¿›è¡Œè‡ªå¢æ“ä½œã€‚æ—¢ç„¶æåˆ°è‡ªå¢ï¼Œå°±æœ‰å¯èƒ½å‡ºç°æº¢å‡ºã€‚å¦‚æœå¢åŠ äº†æ­£æ•°ï¼Œä¼šå‡ºç°ä¸Šæº¢ï¼Œå¦‚æœå¢åŠ çš„æ˜¯è´Ÿæ•°ï¼Œå°±ä¼šå‡ºç°ä¸‹æº¢å‡ºã€‚Redis é»˜è®¤çš„å¤„ç†æ˜¯æŠ˜è¿”ã€‚å¦‚æœå‡ºç°äº†æº¢å‡ºï¼Œå°±å°†æº¢å‡ºçš„ç¬¦å·ä½ä¸¢æ‰ã€‚å¦‚æœæ˜¯ 8 ä½æ— ç¬¦å·æ•° 255ï¼ŒåŠ  1 åå°±ä¼šæº¢å‡ºï¼Œä¼šå…¨éƒ¨å˜é›¶ã€‚å¦‚æœæ˜¯ 8 ä½æœ‰ç¬¦å·æ•° 127ï¼ŒåŠ  1 åå°±ä¼šæº¢å‡ºå˜æˆ -128ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å®è·µä¸€ä¸‹è¿™ä¸ªå­æŒ‡ä»¤ incrby :
```
127.0.0.1:6379> set w hello
OK
127.0.0.1:6379> bitfield w incrby u4 2 1  # ä»ç¬¬ä¸‰ä¸ªä½å¼€å§‹ï¼Œå¯¹æ¥ä¸‹æ¥çš„ 4 ä½æ— ç¬¦å·æ•° +1
1) (integer) 11
127.0.0.1:6379> bitfield w incrby u4 2 1
1) (integer) 12
127.0.0.1:6379> bitfield w incrby u4 2 1
1) (integer) 13
127.0.0.1:6379> bitfield w incrby u4 2 1
1) (integer) 14
127.0.0.1:6379> bitfield w incrby u4 2 1
1) (integer) 15
127.0.0.1:6379> bitfield w incrby u4 2 1  # æº¢å‡ºæŠ˜è¿”äº†
1) (integer) 0
```

bitfield æŒ‡ä»¤æä¾›äº†æº¢å‡ºç­–ç•¥å­æŒ‡ä»¤ overflowï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©æº¢å‡ºè¡Œä¸ºï¼Œé»˜è®¤æ˜¯æŠ˜è¿” (wrap)ï¼Œè¿˜å¯ä»¥é€‰æ‹©å¤±è´¥ (fail) æŠ¥é”™ä¸æ‰§è¡Œï¼Œä»¥åŠé¥±å’Œæˆªæ–­ (sat)ï¼Œè¶…è¿‡äº†èŒƒå›´å°±åœç•™åœ¨æœ€å¤§æœ€å°å€¼ã€‚overflow æŒ‡ä»¤åªå½±å“æ¥ä¸‹æ¥çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Œè¿™æ¡æŒ‡ä»¤æ‰§è¡Œå®Œåæº¢å‡ºç­–ç•¥ä¼šå˜æˆé»˜è®¤å€¼æŠ˜è¿” (wrap)ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†åˆ«è¯•è¯•è¿™ä¸¤ä¸ªç­–ç•¥çš„è¡Œä¸º

**é¥±å’Œæˆªæ–­ SAT**
```
127.0.0.1:6379> set w hello
OK
127.0.0.1:6379> bitfield w overflow sat incrby u4 2 1
1) (integer) 11
127.0.0.1:6379> bitfield w overflow sat incrby u4 2 1
1) (integer) 12
127.0.0.1:6379> bitfield w overflow sat incrby u4 2 1
1) (integer) 13
127.0.0.1:6379> bitfield w overflow sat incrby u4 2 1
1) (integer) 14
127.0.0.1:6379> bitfield w overflow sat incrby u4 2 1
1) (integer) 15
127.0.0.1:6379> bitfield w overflow sat incrby u4 2 1  # ä¿æŒæœ€å¤§å€¼
1) (integer) 15
```
**å¤±è´¥ä¸æ‰§è¡Œ FAIL**
```
127.0.0.1:6379> set w hello
OK
127.0.0.1:6379> bitfield w overflow fail incrby u4 2 1
1) (integer) 11
127.0.0.1:6379> bitfield w overflow fail incrby u4 2 1
1) (integer) 12
127.0.0.1:6379> bitfield w overflow fail incrby u4 2 1
1) (integer) 13
127.0.0.1:6379> bitfield w overflow fail incrby u4 2 1
1) (integer) 14
127.0.0.1:6379> bitfield w overflow fail incrby u4 2 1
1) (integer) 15
127.0.0.1:6379> bitfield w overflow fail incrby u4 2 1  # ä¸æ‰§è¡Œ
1) (nil)
```

æ€è€ƒ & ä½œä¸š
--
1. æ–‡ä¸­æˆ‘ä»¬ä½¿ç”¨ä½æ“ä½œè®¾ç½®äº† he ä¸¤ä¸ªå­—ç¬¦ï¼Œè¯·è¯»è€…å°†å®Œæ•´çš„ hello å•è¯ä¸­ 5 ä¸ªå­—ç¬¦éƒ½ä½¿ç”¨ä½æ“ä½œè®¾ç½®ä¸€ä¸‹ã€‚
2. bitfield å¯ä»¥åŒæ—¶æ··åˆæ‰§è¡Œå¤šä¸ª set/get/incrby å­æŒ‡ä»¤ï¼Œè¯·è¯»è€…å°è¯•å®Œæˆã€‚
# åº”ç”¨ 4ï¼šå››ä¸¤æ‹¨åƒæ–¤ â€”â€” HyperLogLog

åœ¨å¼€å§‹è¿™ä¸€èŠ‚ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ€è€ƒä¸€ä¸ªå¸¸è§çš„ä¸šåŠ¡é—®é¢˜ï¼šå¦‚æœä½ è´Ÿè´£å¼€å‘ç»´æŠ¤ä¸€ä¸ªå¤§å‹çš„ç½‘ç«™ï¼Œæœ‰ä¸€å¤©è€æ¿æ‰¾äº§å“ç»ç†è¦ç½‘ç«™æ¯ä¸ªç½‘é¡µæ¯å¤©çš„ UV æ•°æ®ï¼Œç„¶åè®©ä½ æ¥å¼€å‘è¿™ä¸ªç»Ÿè®¡æ¨¡å—ï¼Œä½ ä¼šå¦‚ä½•å®ç°ï¼Ÿ

![](https://user-gold-cdn.xitu.io/2018/7/12/1648f065e38200cb?w=400&h=128&f=gif&s=250971)

å¦‚æœç»Ÿè®¡ PV é‚£éå¸¸å¥½åŠï¼Œç»™æ¯ä¸ªç½‘é¡µä¸€ä¸ªç‹¬ç«‹çš„ Redis è®¡æ•°å™¨å°±å¯ä»¥äº†ï¼Œè¿™ä¸ªè®¡æ•°å™¨çš„ key åç¼€åŠ ä¸Šå½“å¤©çš„æ—¥æœŸã€‚è¿™æ ·æ¥ä¸€ä¸ªè¯·æ±‚ï¼Œincrby ä¸€æ¬¡ï¼Œæœ€ç»ˆå°±å¯ä»¥ç»Ÿè®¡å‡ºæ‰€æœ‰çš„ PV æ•°æ®ã€‚

ä½†æ˜¯ UV ä¸ä¸€æ ·ï¼Œå®ƒè¦å»é‡ï¼ŒåŒä¸€ä¸ªç”¨æˆ·ä¸€å¤©ä¹‹å†…çš„å¤šæ¬¡è®¿é—®è¯·æ±‚åªèƒ½è®¡æ•°ä¸€æ¬¡ã€‚è¿™å°±è¦æ±‚æ¯ä¸€ä¸ªç½‘é¡µè¯·æ±‚éƒ½éœ€è¦å¸¦ä¸Šç”¨æˆ·çš„ IDï¼Œæ— è®ºæ˜¯ç™»é™†ç”¨æˆ·è¿˜æ˜¯æœªç™»é™†ç”¨æˆ·éƒ½éœ€è¦ä¸€ä¸ªå”¯ä¸€ ID æ¥æ ‡è¯†ã€‚

ä½ ä¹Ÿè®¸å·²ç»æƒ³åˆ°äº†ä¸€ä¸ªç®€å•çš„æ–¹æ¡ˆï¼Œé‚£å°±æ˜¯ä¸ºæ¯ä¸€ä¸ªé¡µé¢ä¸€ä¸ªç‹¬ç«‹çš„ set é›†åˆæ¥å­˜å‚¨æ‰€æœ‰å½“å¤©è®¿é—®è¿‡æ­¤é¡µé¢çš„ç”¨æˆ· IDã€‚å½“ä¸€ä¸ªè¯·æ±‚è¿‡æ¥æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ sadd å°†ç”¨æˆ· ID å¡è¿›å»å°±å¯ä»¥äº†ã€‚é€šè¿‡ scard å¯ä»¥å–å‡ºè¿™ä¸ªé›†åˆçš„å¤§å°ï¼Œè¿™ä¸ªæ•°å­—å°±æ˜¯è¿™ä¸ªé¡µé¢çš„ UV æ•°æ®ã€‚æ²¡é”™ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„æ–¹æ¡ˆã€‚

ä½†æ˜¯ï¼Œå¦‚æœä½ çš„é¡µé¢è®¿é—®é‡éå¸¸å¤§ï¼Œæ¯”å¦‚ä¸€ä¸ªçˆ†æ¬¾é¡µé¢å‡ åƒä¸‡çš„ UVï¼Œä½ éœ€è¦ä¸€ä¸ªå¾ˆå¤§çš„ set é›†åˆæ¥ç»Ÿè®¡ï¼Œè¿™å°±éå¸¸æµªè´¹ç©ºé—´ã€‚å¦‚æœè¿™æ ·çš„é¡µé¢å¾ˆå¤šï¼Œé‚£æ‰€éœ€è¦çš„å­˜å‚¨ç©ºé—´æ˜¯æƒŠäººçš„ã€‚ä¸ºè¿™æ ·ä¸€ä¸ªå»é‡åŠŸèƒ½å°±è€—è´¹è¿™æ ·å¤šçš„å­˜å‚¨ç©ºé—´ï¼Œå€¼å¾—ä¹ˆï¼Ÿå…¶å®è€æ¿éœ€è¦çš„æ•°æ®åˆä¸éœ€è¦å¤ªç²¾ç¡®ï¼Œ105w å’Œ 106w è¿™ä¸¤ä¸ªæ•°å­—å¯¹äºè€æ¿ä»¬æ¥è¯´å¹¶æ²¡æœ‰å¤šå¤§åŒºåˆ«ï¼ŒSoï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿ

è¿™å°±æ˜¯æœ¬èŠ‚è¦å¼•å…¥çš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼ŒRedis æä¾›äº† HyperLogLog æ•°æ®ç»“æ„å°±æ˜¯ç”¨æ¥è§£å†³è¿™ç§ç»Ÿè®¡é—®é¢˜çš„ã€‚HyperLogLog æä¾›ä¸ç²¾ç¡®çš„å»é‡è®¡æ•°æ–¹æ¡ˆï¼Œè™½ç„¶ä¸ç²¾ç¡®ä½†æ˜¯ä¹Ÿä¸æ˜¯éå¸¸ä¸ç²¾ç¡®ï¼Œæ ‡å‡†è¯¯å·®æ˜¯ 0.81%ï¼Œè¿™æ ·çš„ç²¾ç¡®åº¦å·²ç»å¯ä»¥æ»¡è¶³ä¸Šé¢çš„ UV ç»Ÿè®¡éœ€æ±‚äº†ã€‚

HyperLogLog æ•°æ®ç»“æ„æ˜¯ Redis çš„é«˜çº§æ•°æ®ç»“æ„ï¼Œå®ƒéå¸¸æœ‰ç”¨ï¼Œä½†æ˜¯ä»¤äººæ„Ÿåˆ°æ„å¤–çš„æ˜¯ï¼Œä½¿ç”¨è¿‡å®ƒçš„äººéå¸¸å°‘ã€‚

## ä½¿ç”¨æ–¹æ³•

HyperLogLog æä¾›äº†ä¸¤ä¸ªæŒ‡ä»¤ pfadd å’Œ pfcountï¼Œæ ¹æ®å­—é¢æ„ä¹‰å¾ˆå¥½ç†è§£ï¼Œä¸€ä¸ªæ˜¯å¢åŠ è®¡æ•°ï¼Œä¸€ä¸ªæ˜¯è·å–è®¡æ•°ã€‚pfadd ç”¨æ³•å’Œ set é›†åˆçš„ sadd æ˜¯ä¸€æ ·çš„ï¼Œæ¥ä¸€ä¸ªç”¨æˆ· IDï¼Œå°±å°†ç”¨æˆ· ID å¡è¿›å»å°±æ˜¯ã€‚pfcount å’Œ scard ç”¨æ³•æ˜¯ä¸€æ ·çš„ï¼Œç›´æ¥è·å–è®¡æ•°å€¼ã€‚

```bash
127.0.0.1:6379> pfadd codehole user1
(integer) 1
127.0.0.1:6379> pfcount codehole
(integer) 1
127.0.0.1:6379> pfadd codehole user2
(integer) 1
127.0.0.1:6379> pfcount codehole
(integer) 2
127.0.0.1:6379> pfadd codehole user3
(integer) 1
127.0.0.1:6379> pfcount codehole
(integer) 3
127.0.0.1:6379> pfadd codehole user4
(integer) 1
127.0.0.1:6379> pfcount codehole
(integer) 4
127.0.0.1:6379> pfadd codehole user5
(integer) 1
127.0.0.1:6379> pfcount codehole
(integer) 5
127.0.0.1:6379> pfadd codehole user6
(integer) 1
127.0.0.1:6379> pfcount codehole
(integer) 6
127.0.0.1:6379> pfadd codehole user7 user8 user9 user10
(integer) 1
127.0.0.1:6379> pfcount codehole
(integer) 10
```

ç®€å•è¯•äº†ä¸€ä¸‹ï¼Œå‘ç°è¿˜è›®ç²¾ç¡®çš„ï¼Œä¸€ä¸ªæ²¡å¤šä¹Ÿä¸€ä¸ªæ²¡å°‘ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨è„šæœ¬ï¼Œå¾€é‡Œé¢çŒæ›´å¤šçš„æ•°æ®ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦è¿˜å¯ä»¥ç»§ç»­ç²¾ç¡®ä¸‹å»ï¼Œå¦‚æœä¸èƒ½ç²¾ç¡®ï¼Œå·®è·æœ‰å¤šå¤§ã€‚äººç”Ÿè‹¦çŸ­ï¼Œæˆ‘ç”¨ Pythonï¼Python è„šæœ¬èµ°èµ·æ¥ï¼ğŸ˜„

```py
# coding: utf-8

import redis

client = redis.StrictRedis()
for i in range(1000):
    client.pfadd("codehole", "user%d" % i)
    total = client.pfcount("codehole")
    if total != i+1:
        print total, i+1
        break
```

å½“ç„¶ Java ä¹Ÿä¸é”™ï¼Œå¤§åŒå°å¼‚ï¼Œä¸‹é¢æ˜¯ Java ç‰ˆæœ¬ï¼š

```java
public class PfTest {
  public static void main(String[] args) {
    Jedis jedis = new Jedis();
    for (int i = 0; i < 1000; i++) {
      jedis.pfadd("codehole", "user" + i);
      long total = jedis.pfcount("codehole");
      if (total != i + 1) {
        System.out.printf("%d %d\n", total, i + 1);
        break;
      }
    }
    jedis.close();
  }
}
```

æˆ‘ä»¬æ¥çœ‹ä¸‹è¾“å‡ºï¼š

```
> python pftest.py
99 100
```

å½“æˆ‘ä»¬åŠ å…¥ç¬¬ 100 ä¸ªå…ƒç´ æ—¶ï¼Œç»“æœå¼€å§‹å‡ºç°äº†ä¸ä¸€è‡´ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ•°æ®å¢åŠ åˆ° 10w ä¸ªï¼Œçœ‹çœ‹æ€»é‡å·®è·æœ‰å¤šå¤§ã€‚

```
# coding: utf-8

import redis

client = redis.StrictRedis()
for i in range(100000):
    client.pfadd("codehole", "user%d" % i)
print 100000, client.pfcount("codehole")
```

Java ç‰ˆï¼š

```java
public class JedisTest {
  public static void main(String[] args) {
    Jedis jedis = new Jedis();
    for (int i = 0; i < 100000; i++) {
      jedis.pfadd("codehole", "user" + i);
    }
    long total = jedis.pfcount("codehole");
    System.out.printf("%d %d\n", 100000, total);
    jedis.close();
  }
}
```

è·‘äº†çº¦åŠåˆ†é’Ÿï¼Œæˆ‘ä»¬çœ‹è¾“å‡ºï¼š

```
> python pftest.py
100000 99723
```

å·®äº† 277 ä¸ªï¼ŒæŒ‰ç™¾åˆ†æ¯”æ˜¯ 0.277%ï¼Œå¯¹äºä¸Šé¢çš„ UV ç»Ÿè®¡éœ€æ±‚æ¥è¯´ï¼Œè¯¯å·®ç‡ä¹Ÿä¸ç®—é«˜ã€‚ç„¶åæˆ‘ä»¬æŠŠä¸Šé¢çš„è„šæœ¬å†è·‘ä¸€è¾¹ï¼Œä¹Ÿå°±ç›¸å½“äºå°†æ•°æ®é‡å¤åŠ å…¥ä¸€è¾¹ï¼ŒæŸ¥çœ‹è¾“å‡ºï¼Œå¯ä»¥å‘ç°ï¼Œpfcount çš„ç»“æœæ²¡æœ‰ä»»ä½•æ”¹å˜ï¼Œè¿˜æ˜¯ 99723ï¼Œè¯´æ˜å®ƒç¡®å®å…·å¤‡å»é‡åŠŸèƒ½ã€‚

## pfadd è¿™ä¸ª pf æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

å®ƒæ˜¯ HyperLogLog è¿™ä¸ªæ•°æ®ç»“æ„çš„å‘æ˜äºº Philippe Flajolet çš„é¦–å­—æ¯ç¼©å†™ï¼Œè€å¸ˆè§‰å¾—ä»–å‘å‹å¾ˆé…·ï¼Œçœ‹èµ·æ¥æ˜¯ä¸ªä½›ç³»æ•™æˆã€‚

![](https://user-gold-cdn.xitu.io/2018/7/12/1648f09fa1a77152?w=300&h=242&f=jpeg&s=24061)

## pfmerge é€‚åˆä»€ä¹ˆåœºåˆç”¨ï¼Ÿ

HyperLogLog é™¤äº†ä¸Šé¢çš„ pfadd å’Œ pfcount ä¹‹å¤–ï¼Œè¿˜æä¾›äº†ç¬¬ä¸‰ä¸ªæŒ‡ä»¤ pfmergeï¼Œç”¨äºå°†å¤šä¸ª pf è®¡æ•°å€¼ç´¯åŠ åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªæ–°çš„ pf å€¼ã€‚

æ¯”å¦‚åœ¨ç½‘ç«™ä¸­æˆ‘ä»¬æœ‰ä¸¤ä¸ªå†…å®¹å·®ä¸å¤šçš„é¡µé¢ï¼Œè¿è¥è¯´éœ€è¦è¿™ä¸¤ä¸ªé¡µé¢çš„æ•°æ®è¿›è¡Œåˆå¹¶ã€‚å…¶ä¸­é¡µé¢çš„ UV è®¿é—®é‡ä¹Ÿéœ€è¦åˆå¹¶ï¼Œé‚£è¿™ä¸ªæ—¶å€™ pfmerge å°±å¯ä»¥æ´¾ä¸Šç”¨åœºäº†ã€‚

## æ³¨æ„äº‹é¡¹

HyperLogLog è¿™ä¸ªæ•°æ®ç»“æ„ä¸æ˜¯å…è´¹çš„ï¼Œä¸æ˜¯è¯´ä½¿ç”¨è¿™ä¸ªæ•°æ®ç»“æ„è¦èŠ±é’±ï¼Œå®ƒéœ€è¦å æ®ä¸€å®š 12k çš„å­˜å‚¨ç©ºé—´ï¼Œæ‰€ä»¥å®ƒä¸é€‚åˆç»Ÿè®¡å•ä¸ªç”¨æˆ·ç›¸å…³çš„æ•°æ®ã€‚å¦‚æœä½ çš„ç”¨æˆ·ä¸Šäº¿ï¼Œå¯ä»¥ç®—ç®—ï¼Œè¿™ä¸ªç©ºé—´æˆæœ¬æ˜¯éå¸¸æƒŠäººçš„ã€‚ä½†æ˜¯ç›¸æ¯” set å­˜å‚¨æ–¹æ¡ˆï¼ŒHyperLogLog æ‰€ä½¿ç”¨çš„ç©ºé—´é‚£çœŸæ˜¯å¯ä»¥ä½¿ç”¨åƒæ–¤å¯¹æ¯”å››ä¸¤æ¥å½¢å®¹äº†ã€‚

ä¸è¿‡ä½ ä¹Ÿä¸å¿…è¿‡äºæ‹…å¿ƒï¼Œå› ä¸º Redis å¯¹ HyperLogLog çš„å­˜å‚¨è¿›è¡Œäº†ä¼˜åŒ–ï¼Œåœ¨è®¡æ•°æ¯”è¾ƒå°æ—¶ï¼Œå®ƒçš„å­˜å‚¨ç©ºé—´é‡‡ç”¨ç¨€ç–çŸ©é˜µå­˜å‚¨ï¼Œç©ºé—´å ç”¨å¾ˆå°ï¼Œä»…ä»…åœ¨è®¡æ•°æ…¢æ…¢å˜å¤§ï¼Œç¨€ç–çŸ©é˜µå ç”¨ç©ºé—´æ¸æ¸è¶…è¿‡äº†é˜ˆå€¼æ—¶æ‰ä¼šä¸€æ¬¡æ€§è½¬å˜æˆç¨ å¯†çŸ©é˜µï¼Œæ‰ä¼šå ç”¨ 12k çš„ç©ºé—´ã€‚

## HyperLogLog å®ç°åŸç†

HyperLogLog çš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œä½†æ˜¯å®ç°åŸç†æ¯”è¾ƒå¤æ‚ï¼Œå¦‚æœè¯»è€…æ²¡æœ‰ç‰¹åˆ«çš„å…´è¶£ï¼Œä¸‹é¢çš„å†…å®¹æš‚æ—¶å¯ä»¥è·³è¿‡ä¸çœ‹ã€‚

ä¸ºäº†æ–¹ä¾¿ç†è§£ HyperLogLog çš„å†…éƒ¨å®ç°åŸç†ï¼Œæˆ‘ç”»äº†ä¸‹é¢è¿™å¼ å›¾

![](https://user-gold-cdn.xitu.io/2018/7/12/1648f0af2621881b?w=1102&h=692&f=png&s=53467)

è¿™å¼ å›¾çš„æ„æ€æ˜¯ï¼Œç»™å®šä¸€ç³»åˆ—çš„éšæœºæ•´æ•°ï¼Œæˆ‘ä»¬è®°å½•ä¸‹ä½ä½è¿ç»­é›¶ä½çš„æœ€å¤§é•¿åº¦ kï¼Œé€šè¿‡è¿™ä¸ª k å€¼å¯ä»¥ä¼°ç®—å‡ºéšæœºæ•°çš„æ•°é‡ã€‚
é¦–å…ˆä¸é—®ä¸ºä»€ä¹ˆï¼Œæˆ‘ä»¬ç¼–å†™ä»£ç åšä¸€ä¸ªå®éªŒï¼Œè§‚å¯Ÿä¸€ä¸‹éšæœºæ•´æ•°çš„æ•°é‡å’Œ k å€¼çš„å…³ç³»ã€‚

```py
import math
import random

# ç®—ä½ä½é›¶çš„ä¸ªæ•°
def low_zeros(value):
    for i in xrange(1, 32):
        if value >> i << i != value:
            break
    return i - 1


# é€šè¿‡éšæœºæ•°è®°å½•æœ€å¤§çš„ä½ä½é›¶çš„ä¸ªæ•°
class BitKeeper(object):

    def __init__(self):
        self.maxbits = 0

    def random(self):
        value = random.randint(0, 2**32-1)
        bits = low_zeros(value)
        if bits > self.maxbits:
            self.maxbits = bits


class Experiment(object):

    def __init__(self, n):
        self.n = n
        self.keeper = BitKeeper()

    def do(self):
        for i in range(self.n):
            self.keeper.random()

    def debug(self):
        print self.n, '%.2f' % math.log(self.n, 2), self.keeper.maxbits


for i in range(1000, 100000, 100):
    exp = Experiment(i)
    exp.do()
    exp.debug()
```

Java ç‰ˆï¼š

```java
public class PfTest {

  static class BitKeeper {
    private int maxbits;

    public void random() {
      long value = ThreadLocalRandom.current().nextLong(2L << 32);
      int bits = lowZeros(value);
      if (bits > this.maxbits) {
        this.maxbits = bits;
      }
    }

    private int lowZeros(long value) {
      int i = 1;
      for (; i < 32; i++) {
        if (value >> i << i != value) {
          break;
        }
      }
      return i - 1;
    }
  }

  static class Experiment {
    private int n;
    private BitKeeper keeper;

    public Experiment(int n) {
      this.n = n;
      this.keeper = new BitKeeper();
    }

    public void work() {
      for (int i = 0; i < n; i++) {
        this.keeper.random();
      }
    }

    public void debug() {
      System.out.printf("%d %.2f %d\n", this.n, Math.log(this.n) / Math.log(2), this.keeper.maxbits);
    }
  }

  public static void main(String[] args) {
    for (int i = 1000; i < 100000; i += 100) {
      Experiment exp = new Experiment(i);
      exp.work();
      exp.debug();
    }
  }

}
```
è¿è¡Œè§‚å¯Ÿè¾“å‡ºï¼š
```
36400 15.15 13
36500 15.16 16
36600 15.16 13
36700 15.16 14
36800 15.17 15
36900 15.17 18
37000 15.18 16
37100 15.18 15
37200 15.18 13
37300 15.19 14
37400 15.19 16
37500 15.19 14
37600 15.20 15
```

é€šè¿‡è¿™å®éªŒå¯ä»¥å‘ç° K å’Œ N çš„å¯¹æ•°ä¹‹é—´å­˜åœ¨æ˜¾è‘—çš„çº¿æ€§ç›¸å…³æ€§ï¼š

```
N=2^K  # çº¦ç­‰äº
```

å¦‚æœ N ä»‹äº 2^K å’Œ 2^(K+1) ä¹‹é—´ï¼Œç”¨è¿™ç§æ–¹å¼ä¼°è®¡çš„å€¼éƒ½ç­‰äº 2^Kï¼Œè¿™æ˜æ˜¾æ˜¯ä¸åˆç†çš„ã€‚è¿™é‡Œå¯ä»¥é‡‡ç”¨å¤šä¸ª BitKeeperï¼Œç„¶åè¿›è¡ŒåŠ æƒä¼°è®¡ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªæ¯”è¾ƒå‡†ç¡®çš„å€¼ã€‚

```py
import math
import random

def low_zeros(value):
    for i in xrange(1, 32):
        if value >> i << i != value:
            break
    return i - 1


class BitKeeper(object):

    def __init__(self):
        self.maxbits = 0

    def random(self, m):
        bits = low_zeros(m)
        if bits > self.maxbits:
            self.maxbits = bits


class Experiment(object):

    def __init__(self, n, k=1024):
        self.n = n
        self.k = k
        self.keepers = [BitKeeper() for i in range(k)]

    def do(self):
        for i in range(self.n):
            m = random.randint(0, 1<<32-1)
            # ç¡®ä¿åŒä¸€ä¸ªæ•´æ•°è¢«åˆ†é…åˆ°åŒä¸€ä¸ªæ¡¶é‡Œé¢ï¼Œæ‘˜å–é«˜ä½åå–æ¨¡
            keeper = self.keepers[((m & 0xfff0000) >> 16) % len(self.keepers)]
            keeper.random(m)

    def estimate(self):
        sumbits_inverse = 0  # é›¶ä½æ•°å€’æ•°
        for keeper in self.keepers:
            sumbits_inverse += 1.0/float(keeper.maxbits)
        avgbits = float(self.k)/sumbits_inverse  # å¹³å‡é›¶ä½æ•°
        return 2**avgbits * self.k  # æ ¹æ®æ¡¶çš„æ•°é‡å¯¹ä¼°è®¡å€¼è¿›è¡Œæ”¾å¤§


for i in range(100000, 1000000, 100000):
    exp = Experiment(i)
    exp.do()
    est = exp.estimate()
    print i, '%.2f' % est, '%.2f' % (abs(est-i) / i)
```
ä¸‹é¢æ˜¯ Java ç‰ˆï¼š
```java
public class PfTest {

  static class BitKeeper {
    private int maxbits;

    public void random(long value) {
      int bits = lowZeros(value);
      if (bits > this.maxbits) {
        this.maxbits = bits;
      }
    }

    private int lowZeros(long value) {
      int i = 1;
      for (; i < 32; i++) {
        if (value >> i << i != value) {
          break;
        }
      }
      return i - 1;
    }
  }

  static class Experiment {
    private int n;
    private int k;
    private BitKeeper[] keepers;

    public Experiment(int n) {
      this(n, 1024);
    }

    public Experiment(int n, int k) {
      this.n = n;
      this.k = k;
      this.keepers = new BitKeeper[k];
      for (int i = 0; i < k; i++) {
        this.keepers[i] = new BitKeeper();
      }
    }

    public void work() {
      for (int i = 0; i < this.n; i++) {
        long m = ThreadLocalRandom.current().nextLong(1L << 32);
        BitKeeper keeper = keepers[(int) (((m & 0xfff0000) >> 16) % keepers.length)];
        keeper.random(m);
      }
    }

    public double estimate() {
      double sumbitsInverse = 0.0;
      for (BitKeeper keeper : keepers) {
        sumbitsInverse += 1.0 / (float) keeper.maxbits;
      }
      double avgBits = (float) keepers.length / sumbitsInverse;
      return Math.pow(2, avgBits) * this.k;
    }
  }

  public static void main(String[] args) {
    for (int i = 100000; i < 1000000; i += 100000) {
      Experiment exp = new Experiment(i);
      exp.work();
      double est = exp.estimate();
      System.out.printf("%d %.2f %.2f\n", i, est, Math.abs(est - i) / i);
    }
  }

}
```
ä»£ç ä¸­åˆ†äº† 1024 ä¸ªæ¡¶ï¼Œè®¡ç®—å¹³å‡æ•°ä½¿ç”¨äº†è°ƒå’Œå¹³å‡ (å€’æ•°çš„å¹³å‡)ã€‚æ™®é€šçš„å¹³å‡æ³•å¯èƒ½å› ä¸ºä¸ªåˆ«ç¦»ç¾¤å€¼å¯¹å¹³å‡ç»“æœäº§ç”Ÿè¾ƒå¤§çš„å½±å“ï¼Œè°ƒå’Œå¹³å‡å¯ä»¥æœ‰æ•ˆå¹³æ»‘ç¦»ç¾¤å€¼çš„å½±å“ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/12/1648f0fa8841ceb1?w=565&h=171&f=png&s=14049)

è§‚å¯Ÿè„šæœ¬çš„è¾“å‡ºï¼Œè¯¯å·®ç‡æ§åˆ¶åœ¨ç™¾åˆ†æ¯”ä¸ªä½æ•°ï¼š
```
100000 97287.38 0.03
200000 189369.02 0.05
300000 287770.04 0.04
400000 401233.52 0.00
500000 491704.97 0.02
600000 604233.92 0.01
700000 721127.67 0.03
800000 832308.12 0.04
900000 870954.86 0.03
1000000 1075497.64 0.08
```
çœŸå®çš„ HyperLogLog è¦æ¯”ä¸Šé¢çš„ç¤ºä¾‹ä»£ç æ›´åŠ å¤æ‚ä¸€äº›ï¼Œä¹Ÿæ›´åŠ ç²¾ç¡®ä¸€äº›ã€‚ä¸Šé¢çš„è¿™ä¸ªç®—æ³•åœ¨éšæœºæ¬¡æ•°å¾ˆå°‘çš„æƒ…å†µä¸‹ä¼šå‡ºç°é™¤é›¶é”™è¯¯ï¼Œå› ä¸º maxbits=0 æ˜¯ä¸å¯ä»¥æ±‚å€’æ•°çš„ã€‚

## pf çš„å†…å­˜å ç”¨ä¸ºä»€ä¹ˆæ˜¯ 12kï¼Ÿ
æˆ‘ä»¬åœ¨ä¸Šé¢çš„ç®—æ³•ä¸­ä½¿ç”¨äº† 1024 ä¸ªæ¡¶è¿›è¡Œç‹¬ç«‹è®¡æ•°ï¼Œä¸è¿‡åœ¨ Redis çš„ HyperLogLog å®ç°ä¸­ç”¨åˆ°çš„æ˜¯ 16384 ä¸ªæ¡¶ï¼Œä¹Ÿå°±æ˜¯ 2^14ï¼Œæ¯ä¸ªæ¡¶çš„ maxbits éœ€è¦ 6 ä¸ª bits æ¥å­˜å‚¨ï¼Œæœ€å¤§å¯ä»¥è¡¨ç¤º maxbits=63ï¼Œäºæ˜¯æ€»å…±å ç”¨å†…å­˜å°±æ˜¯```2^14 * 6 / 8 = 12k```å­—èŠ‚ã€‚

## æ€è€ƒ & ä½œä¸š
å°è¯•å°†ä¸€å †æ•°æ®è¿›è¡Œåˆ†ç»„ï¼Œåˆ†åˆ«è¿›è¡Œè®¡æ•°ï¼Œå†ä½¿ç”¨ pfmerge åˆå¹¶åˆ°ä¸€èµ·ï¼Œè§‚å¯Ÿ pfcount è®¡æ•°å€¼ï¼Œä¸ä¸åˆ†ç»„çš„æƒ…å†µä¸‹çš„ç»Ÿè®¡ç»“æœè¿›è¡Œæ¯”è¾ƒï¼Œè§‚å¯Ÿæœ‰æ²¡æœ‰å·®å¼‚ã€‚

## æ‰©å±•é˜…è¯»
- HyperLogLog å¤æ‚çš„å…¬å¼æ¨å¯¼è¯·é˜…è¯» [Count-Distinct Problem](https://www.slideshare.net/KaiZhang130/countdistinct-problem-88329470)ï¼Œå¦‚æœä½ çš„æ¦‚ç‡è®ºåŸºç¡€ä¸å¥½ï¼Œé‚£å°±å»ºè®®ä¸è¦çœ‹äº†ï¼ˆå¦ï¼Œè¿™ä¸ª PPT éœ€è¦ç¿»å¢™è§‚çœ‹ï¼‰ã€‚
# åº”ç”¨ 5ï¼šå±‚å³¦å å¶‚ â€”â€” å¸ƒéš†è¿‡æ»¤å™¨

ä¸Šä¸€èŠ‚æˆ‘ä»¬å­¦ä¼šäº†ä½¿ç”¨ HyperLogLog æ•°æ®ç»“æ„æ¥è¿›è¡Œä¼°æ•°ï¼Œå®ƒéå¸¸æœ‰ä»·å€¼ï¼Œå¯ä»¥è§£å†³å¾ˆå¤šç²¾ç¡®åº¦ä¸é«˜çš„ç»Ÿè®¡éœ€æ±‚ã€‚

ä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³çŸ¥é“æŸä¸€ä¸ªå€¼æ˜¯ä¸æ˜¯å·²ç»åœ¨ HyperLogLog ç»“æ„é‡Œé¢äº†ï¼Œå®ƒå°±æ— èƒ½ä¸ºåŠ›äº†ï¼Œå®ƒåªæä¾›äº† pfadd å’Œ pfcount æ–¹æ³•ï¼Œæ²¡æœ‰æä¾› pfcontains è¿™ç§æ–¹æ³•ã€‚

è®²ä¸ªä½¿ç”¨åœºæ™¯ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨ä½¿ç”¨æ–°é—»å®¢æˆ·ç«¯çœ‹æ–°é—»æ—¶ï¼Œå®ƒä¼šç»™æˆ‘ä»¬ä¸åœåœ°æ¨èæ–°çš„å†…å®¹ï¼Œå®ƒæ¯æ¬¡æ¨èæ—¶è¦å»é‡ï¼Œå»æ‰é‚£äº›å·²ç»çœ‹è¿‡çš„å†…å®¹ã€‚é—®é¢˜æ¥äº†ï¼Œæ–°é—»å®¢æˆ·ç«¯æ¨èç³»ç»Ÿå¦‚ä½•å®ç°æ¨é€å»é‡çš„ï¼Ÿ

ä½ ä¼šæƒ³åˆ°æœåŠ¡å™¨è®°å½•äº†ç”¨æˆ·çœ‹è¿‡çš„æ‰€æœ‰å†å²è®°å½•ï¼Œå½“æ¨èç³»ç»Ÿæ¨èæ–°é—»æ—¶ä¼šä»æ¯ä¸ªç”¨æˆ·çš„å†å²è®°å½•é‡Œè¿›è¡Œç­›é€‰ï¼Œè¿‡æ»¤æ‰é‚£äº›å·²ç»å­˜åœ¨çš„è®°å½•ã€‚é—®é¢˜æ˜¯å½“ç”¨æˆ·é‡å¾ˆå¤§ï¼Œæ¯ä¸ªç”¨æˆ·çœ‹è¿‡çš„æ–°é—»åˆå¾ˆå¤šçš„æƒ…å†µä¸‹ï¼Œè¿™ç§æ–¹å¼ï¼Œæ¨èç³»ç»Ÿçš„å»é‡å·¥ä½œåœ¨æ€§èƒ½ä¸Šè·Ÿçš„ä¸Šä¹ˆï¼Ÿ

![](https://user-gold-cdn.xitu.io/2018/7/2/164599f30fae2a7f?w=512&h=100&f=gif&s=237335)

å®é™…ä¸Šï¼Œå¦‚æœå†å²è®°å½•å­˜å‚¨åœ¨å…³ç³»æ•°æ®åº“é‡Œï¼Œå»é‡å°±éœ€è¦é¢‘ç¹åœ°å¯¹æ•°æ®åº“è¿›è¡Œ exists æŸ¥è¯¢ï¼Œå½“ç³»ç»Ÿå¹¶å‘é‡å¾ˆé«˜æ—¶ï¼Œæ•°æ®åº“æ˜¯å¾ˆéš¾æ‰›ä½å‹åŠ›çš„ã€‚

ä½ å¯èƒ½åˆæƒ³åˆ°äº†ç¼“å­˜ï¼Œä½†æ˜¯å¦‚æ­¤å¤šçš„å†å²è®°å½•å…¨éƒ¨ç¼“å­˜èµ·æ¥ï¼Œé‚£å¾—æµªè´¹å¤šå¤§å­˜å‚¨ç©ºé—´å•Šï¼Ÿè€Œä¸”è¿™ä¸ªå­˜å‚¨ç©ºé—´æ˜¯éšç€æ—¶é—´çº¿æ€§å¢é•¿ï¼Œä½ æ’‘å¾—ä½ä¸€ä¸ªæœˆï¼Œä½ èƒ½æ’‘å¾—ä½å‡ å¹´ä¹ˆï¼Ÿä½†æ˜¯ä¸ç¼“å­˜çš„è¯ï¼Œæ€§èƒ½åˆè·Ÿä¸ä¸Šï¼Œè¿™è¯¥æ€ä¹ˆåŠï¼Ÿ

è¿™æ—¶ï¼Œå¸ƒéš†è¿‡æ»¤å™¨ (Bloom Filter)  é—ªäº®ç™»åœºäº†ï¼Œå®ƒå°±æ˜¯ä¸“é—¨ç”¨æ¥è§£å†³è¿™ç§å»é‡é—®é¢˜çš„ã€‚å®ƒåœ¨èµ·åˆ°å»é‡çš„åŒæ—¶ï¼Œåœ¨ç©ºé—´ä¸Šè¿˜èƒ½èŠ‚çœ 90% ä»¥ä¸Šï¼Œåªæ˜¯ç¨å¾®æœ‰é‚£ä¹ˆç‚¹ä¸ç²¾ç¡®ï¼Œä¹Ÿå°±æ˜¯æœ‰ä¸€å®šçš„è¯¯åˆ¤æ¦‚ç‡ã€‚

## å¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä»€ä¹ˆï¼Ÿ

å¸ƒéš†è¿‡æ»¤å™¨å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªä¸æ€ä¹ˆç²¾ç¡®çš„ set ç»“æ„ï¼Œå½“ä½ ä½¿ç”¨å®ƒçš„ contains æ–¹æ³•åˆ¤æ–­æŸä¸ªå¯¹è±¡æ˜¯å¦å­˜åœ¨æ—¶ï¼Œå®ƒå¯èƒ½ä¼šè¯¯åˆ¤ã€‚ä½†æ˜¯å¸ƒéš†è¿‡æ»¤å™¨ä¹Ÿä¸æ˜¯ç‰¹åˆ«ä¸ç²¾ç¡®ï¼Œåªè¦å‚æ•°è®¾ç½®çš„åˆç†ï¼Œå®ƒçš„ç²¾ç¡®åº¦å¯ä»¥æ§åˆ¶çš„ç›¸å¯¹è¶³å¤Ÿç²¾ç¡®ï¼Œåªä¼šæœ‰å°å°çš„è¯¯åˆ¤æ¦‚ç‡ã€‚

å½“å¸ƒéš†è¿‡æ»¤å™¨è¯´æŸä¸ªå€¼å­˜åœ¨æ—¶ï¼Œè¿™ä¸ªå€¼å¯èƒ½ä¸å­˜åœ¨ï¼›å½“å®ƒè¯´ä¸å­˜åœ¨æ—¶ï¼Œé‚£å°±è‚¯å®šä¸å­˜åœ¨ã€‚æ‰“ä¸ªæ¯”æ–¹ï¼Œå½“å®ƒè¯´ä¸è®¤è¯†ä½ æ—¶ï¼Œè‚¯å®šå°±ä¸è®¤è¯†ï¼›å½“å®ƒè¯´è§è¿‡ä½ æ—¶ï¼Œå¯èƒ½æ ¹æœ¬å°±æ²¡è§è¿‡é¢ï¼Œä¸è¿‡å› ä¸ºä½ çš„è„¸è·Ÿå®ƒè®¤è¯†çš„äººä¸­æŸè„¸æ¯”è¾ƒç›¸ä¼¼ (æŸäº›ç†Ÿè„¸çš„ç³»æ•°ç»„åˆ)ï¼Œæ‰€ä»¥è¯¯åˆ¤ä»¥å‰è§è¿‡ä½ ã€‚

å¥—åœ¨ä¸Šé¢çš„ä½¿ç”¨åœºæ™¯ä¸­ï¼Œå¸ƒéš†è¿‡æ»¤å™¨èƒ½å‡†ç¡®è¿‡æ»¤æ‰é‚£äº›å·²ç»çœ‹è¿‡çš„å†…å®¹ï¼Œé‚£äº›æ²¡æœ‰çœ‹è¿‡çš„æ–°å†…å®¹ï¼Œå®ƒä¹Ÿä¼šè¿‡æ»¤æ‰æå°ä¸€éƒ¨åˆ† (è¯¯åˆ¤)ï¼Œä½†æ˜¯ç»å¤§å¤šæ•°æ–°å†…å®¹å®ƒéƒ½èƒ½å‡†ç¡®è¯†åˆ«ã€‚è¿™æ ·å°±å¯ä»¥å®Œå…¨ä¿è¯æ¨èç»™ç”¨æˆ·çš„å†…å®¹éƒ½æ˜¯æ— é‡å¤çš„ã€‚

## Redis ä¸­çš„å¸ƒéš†è¿‡æ»¤å™¨

Redis å®˜æ–¹æä¾›çš„å¸ƒéš†è¿‡æ»¤å™¨åˆ°äº† Redis 4.0 æä¾›äº†æ’ä»¶åŠŸèƒ½ä¹‹åæ‰æ­£å¼ç™»åœºã€‚å¸ƒéš†è¿‡æ»¤å™¨ä½œä¸ºä¸€ä¸ªæ’ä»¶åŠ è½½åˆ° Redis Server ä¸­ï¼Œç»™ Redis æä¾›äº†å¼ºå¤§çš„å¸ƒéš†å»é‡åŠŸèƒ½ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥ä½“éªŒä¸€ä¸‹ Redis 4.0 çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œä¸ºäº†çœå»ç¹çå®‰è£…è¿‡ç¨‹ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨ Docker å§ã€‚

```
> docker pull redislabs/rebloom  # æ‹‰å–é•œåƒ
> docker run -p6379:6379 redislabs/rebloom  # è¿è¡Œå®¹å™¨
> redis-cli  # è¿æ¥å®¹å™¨ä¸­çš„ redis æœåŠ¡
```

å¦‚æœä¸Šé¢ä¸‰æ¡æŒ‡ä»¤æ‰§è¡Œæ²¡æœ‰é—®é¢˜ï¼Œä¸‹é¢å°±å¯ä»¥ä½“éªŒå¸ƒéš†è¿‡æ»¤å™¨äº†ã€‚

## å¸ƒéš†è¿‡æ»¤å™¨åŸºæœ¬ä½¿ç”¨

å¸ƒéš†è¿‡æ»¤å™¨æœ‰äºŒä¸ªåŸºæœ¬æŒ‡ä»¤ï¼Œ`bf.add` æ·»åŠ å…ƒç´ ï¼Œ`bf.exists` æŸ¥è¯¢å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå®ƒçš„ç”¨æ³•å’Œ set é›†åˆçš„ sadd å’Œ sismember å·®ä¸å¤šã€‚æ³¨æ„ `bf.add` åªèƒ½ä¸€æ¬¡æ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœæƒ³è¦ä¸€æ¬¡æ·»åŠ å¤šä¸ªï¼Œå°±éœ€è¦ç”¨åˆ° `bf.madd` æŒ‡ä»¤ã€‚åŒæ ·å¦‚æœéœ€è¦ä¸€æ¬¡æŸ¥è¯¢å¤šä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå°±éœ€è¦ç”¨åˆ° `bf.mexists` æŒ‡ä»¤ã€‚

```
127.0.0.1:6379> bf.add codehole user1
(integer) 1
127.0.0.1:6379> bf.add codehole user2
(integer) 1
127.0.0.1:6379> bf.add codehole user3
(integer) 1
127.0.0.1:6379> bf.exists codehole user1
(integer) 1
127.0.0.1:6379> bf.exists codehole user2
(integer) 1
127.0.0.1:6379> bf.exists codehole user3
(integer) 1
127.0.0.1:6379> bf.exists codehole user4
(integer) 0
127.0.0.1:6379> bf.madd codehole user4 user5 user6
1) (integer) 1
2) (integer) 1
3) (integer) 1
127.0.0.1:6379> bf.mexists codehole user4 user5 user6 user7
1) (integer) 1
2) (integer) 1
3) (integer) 1
4) (integer) 0
```

ä¼¼ä¹å¾ˆå‡†ç¡®å•Šï¼Œä¸€ä¸ªéƒ½æ²¡è¯¯åˆ¤ã€‚ä¸‹é¢æˆ‘ä»¬ç”¨ Python  è„šæœ¬åŠ å…¥å¾ˆå¤šå…ƒç´ ï¼Œçœ‹çœ‹åŠ åˆ°ç¬¬å‡ ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œå¸ƒéš†è¿‡æ»¤å™¨ä¼šå‡ºç°è¯¯åˆ¤ã€‚

```py
# coding: utf-8

import redis

client = redis.StrictRedis()

client.delete("codehole")
for i in range(100000):
    client.execute_command("bf.add", "codehole", "user%d" % i)
    ret = client.execute_command("bf.exists", "codehole", "user%d" % i)
    if ret == 0:
        print i
        break
```
Java å®¢æˆ·ç«¯ Jedis-2.x æ²¡æœ‰æä¾›æŒ‡ä»¤æ‰©å±•æœºåˆ¶ï¼Œæ‰€ä»¥ä½ æ— æ³•ç›´æ¥ä½¿ç”¨ Jedis æ¥è®¿é—® Redis Module æä¾›çš„ bf.xxx æŒ‡ä»¤ã€‚RedisLabs æä¾›äº†ä¸€ä¸ªå•ç‹¬çš„åŒ… [JReBloom](https://github.com/RedisLabs/JReBloom)ï¼Œä½†æ˜¯å®ƒæ˜¯åŸºäº Jedis-3.0ï¼ŒJedis-3.0 è¿™ä¸ªåŒ…ç›®å‰è¿˜æ²¡æœ‰è¿›å…¥ releaseï¼Œæ²¡æœ‰è¿›å…¥ maven çš„ä¸­å¤®ä»“åº“ï¼Œéœ€è¦åœ¨ Github ä¸Šä¸‹è½½ã€‚åœ¨ä½¿ç”¨ä¸Šå¾ˆä¸æ–¹ä¾¿ï¼Œå¦‚æœæ€•éº»çƒ¦ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ [lettuce](https://github.com/lettuce-io/lettuce-core)ï¼Œå®ƒæ˜¯å¦ä¸€ä¸ª Redis çš„å®¢æˆ·ç«¯ï¼Œç›¸æ¯” Jedis è€Œè¨€ï¼Œå®ƒå¾ˆæ—©å°±æ”¯æŒäº†æŒ‡ä»¤æ‰©å±•ã€‚

```java
public class BloomTest {

  public static void main(String[] args) {
    Client client = new Client();

    client.delete("codehole");
    for (int i = 0; i < 100000; i++) {
      client.add("codehole", "user" + i);
      boolean ret = client.exists("codehole", "user" + i);
      if (!ret) {
        System.out.println(i);
        break;
      }
    }

    client.close();
  }

}
```
æ‰§è¡Œä¸Šé¢çš„ä»£ç åï¼Œä½ ä¼šå¼ å¤§äº†å˜´å·´å‘ç°å±…ç„¶æ²¡æœ‰è¾“å‡ºï¼Œå¡è¿›å»äº† 100000 ä¸ªå…ƒç´ ï¼Œè¿˜æ˜¯æ²¡æœ‰è¯¯åˆ¤ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿå¦‚æœä½ ä¸æ­»å¿ƒçš„è¯ï¼Œå¯ä»¥å°†æ•°å­—å†åŠ ä¸€ä¸ª 0 è¯•è¯•ï¼Œä½ ä¼šå‘ç°ä¾ç„¶æ²¡æœ‰è¯¯åˆ¤ã€‚

åŸå› å°±åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨å¯¹äºå·²ç»è§è¿‡çš„å…ƒç´ è‚¯å®šä¸ä¼šè¯¯åˆ¤ï¼Œå®ƒåªä¼šè¯¯åˆ¤é‚£äº›æ²¡è§è¿‡çš„å…ƒç´ ã€‚æ‰€ä»¥æˆ‘ä»¬è¦ç¨å¾®æ”¹ä¸€ä¸‹ä¸Šé¢çš„è„šæœ¬ï¼Œä½¿ç”¨ bf.exists å»æŸ¥æ‰¾æ²¡è§è¿‡çš„å…ƒç´ ï¼Œçœ‹çœ‹å®ƒæ˜¯ä¸æ˜¯ä»¥ä¸ºè‡ªå·±è§è¿‡äº†ã€‚

```py
# coding: utf-8

import redis

client = redis.StrictRedis()

client.delete("codehole")
for i in range(100000):
    client.execute_command("bf.add", "codehole", "user%d" % i)
    # æ³¨æ„ i+1ï¼Œè¿™ä¸ªæ˜¯å½“å‰å¸ƒéš†è¿‡æ»¤å™¨æ²¡è§è¿‡çš„
    ret = client.execute_command("bf.exists", "codehole", "user%d" % (i+1))
    if ret == 1:
        print i
        break
```
Java ç‰ˆ:

```java
public class BloomTest {

  public static void main(String[] args) {
    Client client = new Client();

    client.delete("codehole");
    for (int i = 0; i < 100000; i++) {
      client.add("codehole", "user" + i);
      boolean ret = client.exists("codehole", "user" + (i + 1));
      if (ret) {
        System.out.println(i);
        break;
      }
    }

    client.close();
  }

}
```

è¿è¡Œåï¼Œæˆ‘ä»¬çœ‹åˆ°äº†è¾“å‡ºæ˜¯ 214ï¼Œä¹Ÿå°±æ˜¯åˆ°ç¬¬ 214 çš„æ—¶å€™ï¼Œå®ƒå‡ºç°äº†è¯¯åˆ¤ã€‚

é‚£å¦‚ä½•æ¥æµ‹é‡è¯¯åˆ¤ç‡å‘¢ï¼Ÿæˆ‘ä»¬å…ˆéšæœºå‡ºä¸€å †å­—ç¬¦ä¸²ï¼Œç„¶ååˆ‡åˆ†ä¸º 2 ç»„ï¼Œå°†å…¶ä¸­ä¸€ç»„å¡å…¥å¸ƒéš†è¿‡æ»¤å™¨ï¼Œç„¶åå†åˆ¤æ–­å¦å¤–ä¸€ç»„çš„å­—ç¬¦ä¸²å­˜åœ¨ä¸å¦ï¼Œå–è¯¯åˆ¤çš„ä¸ªæ•°å’Œå­—ç¬¦ä¸²æ€»é‡ä¸€åŠçš„ç™¾åˆ†æ¯”ä½œä¸ºè¯¯åˆ¤ç‡ã€‚

```py
# coding: utf-8

import redis
import random

client = redis.StrictRedis()

CHARS = ''.join([chr(ord('a') + i) for i in range(26)])

def random_string(n):
    chars = []
    for i in range(n):
        idx = random.randint(0, len(CHARS) - 1)
        chars.append(CHARS[idx])
    return ''.join(chars)


users = list(set([random_string(64) for i in range(100000)]))
print 'total users', len(users)
users_train = users[:len(users)/2]
users_test = users[len(users)/2:]

client.delete("codehole")
falses = 0

for user in users_train:
    client.execute_command("bf.add", "codehole", user)
print 'all trained'
for user in users_test:
    ret = client.execute_command("bf.exists", "codehole", user)
    if ret == 1:
        falses += 1

print falses, len(users_test)
```

Java ç‰ˆ:

```java
public class BloomTest {

  private String chars;
  {
    StringBuilder builder = new StringBuilder();
    for (int i = 0; i < 26; i++) {
      builder.append((char) ('a' + i));
    }
    chars = builder.toString();
  }

  private String randomString(int n) {
    StringBuilder builder = new StringBuilder();
    for (int i = 0; i < n; i++) {
      int idx = ThreadLocalRandom.current().nextInt(chars.length());
      builder.append(chars.charAt(idx));
    }
    return builder.toString();
  }

  private List<String> randomUsers(int n) {
    List<String> users = new ArrayList<>();
    for (int i = 0; i < 100000; i++) {
      users.add(randomString(64));
    }
    return users;
  }

  public static void main(String[] args) {
    BloomTest bloomer = new BloomTest();
    List<String> users = bloomer.randomUsers(100000);
    List<String> usersTrain = users.subList(0, users.size() / 2);
    List<String> usersTest = users.subList(users.size() / 2, users.size());

    Client client = new Client();
    client.delete("codehole");
    for (String user : usersTrain) {
      client.add("codehole", user);
    }
    int falses = 0;
    for (String user : usersTest) {
      boolean ret = client.exists("codehole", user);
      if (ret) {
        falses++;
      }
    }
    System.out.printf("%d %d\n", falses, usersTest.size());
    client.close();
  }

}
```
è¿è¡Œä¸€ä¸‹ï¼Œç­‰å¾…å¤§çº¦ä¸€åˆ†é’Ÿï¼Œè¾“å‡º:
```
total users 100000
all trained
628 50000
```
å¯ä»¥çœ‹åˆ°è¯¯åˆ¤ç‡å¤§çº¦ 1% å¤šç‚¹ã€‚ä½ ä¹Ÿè®¸ä¼šé—®è¿™ä¸ªè¯¯åˆ¤ç‡è¿˜æ˜¯æœ‰ç‚¹é«˜å•Šï¼Œæœ‰æ²¡æœ‰åŠæ³•é™ä½ä¸€ç‚¹ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„ã€‚

æˆ‘ä»¬ä¸Šé¢ä½¿ç”¨çš„å¸ƒéš†è¿‡æ»¤å™¨åªæ˜¯é»˜è®¤å‚æ•°çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå®ƒåœ¨æˆ‘ä»¬ç¬¬ä¸€æ¬¡ add çš„æ—¶å€™è‡ªåŠ¨åˆ›å»ºã€‚Redis å…¶å®è¿˜æä¾›äº†è‡ªå®šä¹‰å‚æ•°çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œéœ€è¦æˆ‘ä»¬åœ¨ add ä¹‹å‰ä½¿ç”¨```bf.reserve```æŒ‡ä»¤æ˜¾å¼åˆ›å»ºã€‚å¦‚æœå¯¹åº”çš„ key å·²ç»å­˜åœ¨ï¼Œ```bf.reserve```ä¼šæŠ¥é”™ã€‚```bf.reserve```æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ key, ```error_rate```å’Œ```initial_size```ã€‚é”™è¯¯ç‡è¶Šä½ï¼Œéœ€è¦çš„ç©ºé—´è¶Šå¤§ã€‚```initial_size```å‚æ•°è¡¨ç¤ºé¢„è®¡æ”¾å…¥çš„å…ƒç´ æ•°é‡ï¼Œå½“å®é™…æ•°é‡è¶…å‡ºè¿™ä¸ªæ•°å€¼æ—¶ï¼Œè¯¯åˆ¤ç‡ä¼šä¸Šå‡ã€‚

æ‰€ä»¥éœ€è¦æå‰è®¾ç½®ä¸€ä¸ªè¾ƒå¤§çš„æ•°å€¼é¿å…è¶…å‡ºå¯¼è‡´è¯¯åˆ¤ç‡å‡é«˜ã€‚å¦‚æœä¸ä½¿ç”¨ bf.reserveï¼Œé»˜è®¤çš„```error_rate```æ˜¯ 0.01ï¼Œé»˜è®¤çš„```initial_size```æ˜¯ 100ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ bf.reserve æ”¹é€ ä¸€ä¸‹ä¸Šé¢çš„è„šæœ¬ï¼š
```py
# coding: utf-8

import redis
import random

client = redis.StrictRedis()

CHARS = ''.join([chr(ord('a') + i) for i in range(26)])

def random_string(n):
    chars = []
    for i in range(n):
        idx = random.randint(0, len(CHARS) - 1)
        chars.append(CHARS[idx])
    return ''.join(chars)


users = list(set([random_string(64) for i in range(100000)]))
print 'total users', len(users)
users_train = users[:len(users)/2]
users_test = users[len(users)/2:]


falses = 0
client.delete("codehole")
# å¢åŠ äº†ä¸‹é¢è¿™ä¸€å¥
client.execute_command("bf.reserve", "codehole", 0.001, 50000)
for user in users_train:
    client.execute_command("bf.add", "codehole", user)
print 'all trained'
for user in users_test:
    ret = client.execute_command("bf.exists", "codehole", user)
    if ret == 1:
        falses += 1

print falses, len(users_test)
```
Java ç‰ˆæœ¬ï¼š
```java
public class BloomTest {

  private String chars;
  {
    StringBuilder builder = new StringBuilder();
    for (int i = 0; i < 26; i++) {
      builder.append((char) ('a' + i));
    }
    chars = builder.toString();
  }

  private String randomString(int n) {
    StringBuilder builder = new StringBuilder();
    for (int i = 0; i < n; i++) {
      int idx = ThreadLocalRandom.current().nextInt(chars.length());
      builder.append(chars.charAt(idx));
    }
    return builder.toString();
  }

  private List<String> randomUsers(int n) {
    List<String> users = new ArrayList<>();
    for (int i = 0; i < 100000; i++) {
      users.add(randomString(64));
    }
    return users;
  }

  public static void main(String[] args) {
    BloomTest bloomer = new BloomTest();
    List<String> users = bloomer.randomUsers(100000);
    List<String> usersTrain = users.subList(0, users.size() / 2);
    List<String> usersTest = users.subList(users.size() / 2, users.size());

    Client client = new Client();
    client.delete("codehole");
    // å¯¹åº” bf.reserve æŒ‡ä»¤
    client.createFilter("codehole", 50000, 0.001);
    for (String user : usersTrain) {
      client.add("codehole", user);
    }
    int falses = 0;
    for (String user : usersTest) {
      boolean ret = client.exists("codehole", user);
      if (ret) {
        falses++;
      }
    }
    System.out.printf("%d %d\n", falses, usersTest.size());
    client.close();
  }

}
```

è¿è¡Œä¸€ä¸‹ï¼Œç­‰å¾…çº¦ 1 åˆ†é’Ÿï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š

```
total users 100000
all trained
6 50000
```

æˆ‘ä»¬çœ‹åˆ°äº†è¯¯åˆ¤ç‡å¤§çº¦ 0.012%ï¼Œæ¯”é¢„è®¡çš„ 0.1% ä½å¾ˆå¤šï¼Œä¸è¿‡å¸ƒéš†çš„æ¦‚ç‡æ˜¯æœ‰è¯¯å·®çš„ï¼Œåªè¦ä¸æ¯”é¢„è®¡è¯¯åˆ¤ç‡é«˜å¤ªå¤šï¼Œéƒ½æ˜¯æ­£å¸¸ç°è±¡ã€‚

## æ³¨æ„äº‹é¡¹

å¸ƒéš†è¿‡æ»¤å™¨çš„```initial_size```ä¼°è®¡çš„è¿‡å¤§ï¼Œä¼šæµªè´¹å­˜å‚¨ç©ºé—´ï¼Œä¼°è®¡çš„è¿‡å°ï¼Œå°±ä¼šå½±å“å‡†ç¡®ç‡ï¼Œç”¨æˆ·åœ¨ä½¿ç”¨ä¹‹å‰ä¸€å®šè¦å°½å¯èƒ½åœ°ç²¾ç¡®ä¼°è®¡å¥½å…ƒç´ æ•°é‡ï¼Œè¿˜éœ€è¦åŠ ä¸Šä¸€å®šçš„å†—ä½™ç©ºé—´ä»¥é¿å…å®é™…å…ƒç´ å¯èƒ½ä¼šæ„å¤–é«˜å‡ºä¼°è®¡å€¼å¾ˆå¤šã€‚

å¸ƒéš†è¿‡æ»¤å™¨çš„```error_rate```è¶Šå°ï¼Œéœ€è¦çš„å­˜å‚¨ç©ºé—´å°±è¶Šå¤§ï¼Œå¯¹äºä¸éœ€è¦è¿‡äºç²¾ç¡®çš„åœºåˆï¼Œ```error_rate```è®¾ç½®ç¨å¤§ä¸€ç‚¹ä¹Ÿæ— ä¼¤å¤§é›…ã€‚æ¯”å¦‚åœ¨æ–°é—»å»é‡ä¸Šè€Œè¨€ï¼Œè¯¯åˆ¤ç‡é«˜ä¸€ç‚¹åªä¼šè®©å°éƒ¨åˆ†æ–‡ç« ä¸èƒ½è®©åˆé€‚çš„äººçœ‹åˆ°ï¼Œæ–‡ç« çš„æ•´ä½“é˜…è¯»é‡ä¸ä¼šå› ä¸ºè¿™ç‚¹è¯¯åˆ¤ç‡å°±å¸¦æ¥å·¨å¤§çš„æ”¹å˜ã€‚

## å¸ƒéš†è¿‡æ»¤å™¨çš„åŸç†

å­¦ä¼šäº†å¸ƒéš†è¿‡æ»¤å™¨çš„ä½¿ç”¨ï¼Œä¸‹é¢æœ‰å¿…è¦æŠŠåŸç†è§£é‡Šä¸€ä¸‹ï¼Œä¸ç„¶è¯»è€…è¿˜ä¼šç»§ç»­è’™åœ¨é¼“é‡Œ

![](https://user-gold-cdn.xitu.io/2018/7/4/16464301a0e26416?w=662&h=244&f=png&s=19146)

æ¯ä¸ªå¸ƒéš†è¿‡æ»¤å™¨å¯¹åº”åˆ° Redis çš„æ•°æ®ç»“æ„é‡Œé¢å°±æ˜¯ä¸€ä¸ªå¤§å‹çš„ä½æ•°ç»„å’Œå‡ ä¸ªä¸ä¸€æ ·çš„æ— å hash å‡½æ•°ã€‚æ‰€è°“æ— åå°±æ˜¯èƒ½å¤ŸæŠŠå…ƒç´ çš„ hash å€¼ç®—å¾—æ¯”è¾ƒå‡åŒ€ã€‚

å‘å¸ƒéš†è¿‡æ»¤å™¨ä¸­æ·»åŠ  key æ—¶ï¼Œä¼šä½¿ç”¨å¤šä¸ª hash å‡½æ•°å¯¹ key è¿›è¡Œ hash ç®—å¾—ä¸€ä¸ªæ•´æ•°ç´¢å¼•å€¼ç„¶åå¯¹ä½æ•°ç»„é•¿åº¦è¿›è¡Œå–æ¨¡è¿ç®—å¾—åˆ°ä¸€ä¸ªä½ç½®ï¼Œæ¯ä¸ª hash å‡½æ•°éƒ½ä¼šç®—å¾—ä¸€ä¸ªä¸åŒçš„ä½ç½®ã€‚å†æŠŠä½æ•°ç»„çš„è¿™å‡ ä¸ªä½ç½®éƒ½ç½®ä¸º 1 å°±å®Œæˆäº† add æ“ä½œã€‚

å‘å¸ƒéš†è¿‡æ»¤å™¨è¯¢é—® key æ˜¯å¦å­˜åœ¨æ—¶ï¼Œè·Ÿ add ä¸€æ ·ï¼Œä¹Ÿä¼šæŠŠ hash çš„å‡ ä¸ªä½ç½®éƒ½ç®—å‡ºæ¥ï¼Œçœ‹çœ‹ä½æ•°ç»„ä¸­è¿™å‡ ä¸ªä½ç½®æ˜¯å¦éƒ½ä¸º 1ï¼Œåªè¦æœ‰ä¸€ä¸ªä½ä¸º 0ï¼Œé‚£ä¹ˆè¯´æ˜å¸ƒéš†è¿‡æ»¤å™¨ä¸­è¿™ä¸ª key ä¸å­˜åœ¨ã€‚å¦‚æœéƒ½æ˜¯ 1ï¼Œè¿™å¹¶ä¸èƒ½è¯´æ˜è¿™ä¸ª key å°±ä¸€å®šå­˜åœ¨ï¼Œåªæ˜¯ææœ‰å¯èƒ½å­˜åœ¨ï¼Œå› ä¸ºè¿™äº›ä½è¢«ç½®ä¸º 1 å¯èƒ½æ˜¯å› ä¸ºå…¶å®ƒçš„ key å­˜åœ¨æ‰€è‡´ã€‚å¦‚æœè¿™ä¸ªä½æ•°ç»„æ¯”è¾ƒç¨€ç–ï¼Œåˆ¤æ–­æ­£ç¡®çš„æ¦‚ç‡å°±ä¼šå¾ˆå¤§ï¼Œå¦‚æœè¿™ä¸ªä½æ•°ç»„æ¯”è¾ƒæ‹¥æŒ¤ï¼Œåˆ¤æ–­æ­£ç¡®çš„æ¦‚ç‡å°±ä¼šé™ä½ã€‚å…·ä½“çš„æ¦‚ç‡è®¡ç®—å…¬å¼æ¯”è¾ƒå¤æ‚ï¼Œæ„Ÿå…´è¶£å¯ä»¥é˜…è¯»æ‰©å±•é˜…è¯»ï¼Œéå¸¸çƒ§è„‘ï¼Œä¸å»ºè®®è¯»è€…ç»†çœ‹ã€‚

ä½¿ç”¨æ—¶ä¸è¦è®©å®é™…å…ƒç´ è¿œå¤§äºåˆå§‹åŒ–å¤§å°ï¼Œå½“å®é™…å…ƒç´ å¼€å§‹è¶…å‡ºåˆå§‹åŒ–å¤§å°æ—¶ï¼Œåº”è¯¥å¯¹å¸ƒéš†è¿‡æ»¤å™¨è¿›è¡Œé‡å»ºï¼Œé‡æ–°åˆ†é…ä¸€ä¸ª size æ›´å¤§çš„è¿‡æ»¤å™¨ï¼Œå†å°†æ‰€æœ‰çš„å†å²å…ƒç´ æ‰¹é‡ add è¿›å» (è¿™å°±è¦æ±‚æˆ‘ä»¬åœ¨å…¶å®ƒçš„å­˜å‚¨å™¨ä¸­è®°å½•æ‰€æœ‰çš„å†å²å…ƒç´ )ã€‚å› ä¸º error_rate ä¸ä¼šå› ä¸ºæ•°é‡è¶…å‡ºå°±æ€¥å‰§å¢åŠ ï¼Œè¿™å°±ç»™æˆ‘ä»¬é‡å»ºè¿‡æ»¤å™¨æä¾›äº†è¾ƒä¸ºå®½æ¾çš„æ—¶é—´ã€‚

## ç©ºé—´å ç”¨ä¼°è®¡

å¸ƒéš†è¿‡æ»¤å™¨çš„ç©ºé—´å ç”¨æœ‰ä¸€ä¸ªç®€å•çš„è®¡ç®—å…¬å¼ï¼Œä½†æ˜¯æ¨å¯¼æ¯”è¾ƒç¹çï¼Œè¿™é‡Œå°±çœå»æ¨å¯¼è¿‡ç¨‹äº†ï¼Œç›´æ¥å¼•å‡ºè®¡ç®—å…¬å¼ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥ç‚¹å‡»ã€Œæ‰©å±•é˜…è¯»ã€æ·±å…¥ç†è§£å…¬å¼çš„æ¨å¯¼è¿‡ç¨‹ã€‚

å¸ƒéš†è¿‡æ»¤å™¨æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯é¢„è®¡å…ƒç´ çš„æ•°é‡ nï¼Œç¬¬äºŒä¸ªæ˜¯é”™è¯¯ç‡ fã€‚å…¬å¼æ ¹æ®è¿™ä¸¤ä¸ªè¾“å…¥å¾—åˆ°ä¸¤ä¸ªè¾“å‡ºï¼Œç¬¬ä¸€ä¸ªè¾“å‡ºæ˜¯ä½æ•°ç»„çš„é•¿åº¦ lï¼Œä¹Ÿå°±æ˜¯éœ€è¦çš„å­˜å‚¨ç©ºé—´å¤§å° (bit)ï¼Œç¬¬äºŒä¸ªè¾“å‡ºæ˜¯ hash å‡½æ•°çš„æœ€ä½³æ•°é‡ kã€‚hash å‡½æ•°çš„æ•°é‡ä¹Ÿä¼šç›´æ¥å½±å“åˆ°é”™è¯¯ç‡ï¼Œæœ€ä½³çš„æ•°é‡ä¼šæœ‰æœ€ä½çš„é”™è¯¯ç‡ã€‚

```
k=0.7*(l/n)  # çº¦ç­‰äº
f=0.6185^(l/n)  # ^ è¡¨ç¤ºæ¬¡æ–¹è®¡ç®—ï¼Œä¹Ÿå°±æ˜¯ math.pow
```
ä»å…¬å¼ä¸­å¯ä»¥çœ‹å‡º
1. ä½æ•°ç»„ç›¸å¯¹è¶Šé•¿ (l/n)ï¼Œé”™è¯¯ç‡ f è¶Šä½ï¼Œè¿™ä¸ªå’Œç›´è§‚ä¸Šç†è§£æ˜¯ä¸€è‡´çš„
2. ä½æ•°ç»„ç›¸å¯¹è¶Šé•¿ (l/n)ï¼Œhash å‡½æ•°éœ€è¦çš„æœ€ä½³æ•°é‡ä¹Ÿè¶Šå¤šï¼Œå½±å“è®¡ç®—æ•ˆç‡
3. å½“ä¸€ä¸ªå…ƒç´ å¹³å‡éœ€è¦ 1 ä¸ªå­—èŠ‚ (8bit) çš„æŒ‡çº¹ç©ºé—´æ—¶ (l/n=8)ï¼Œé”™è¯¯ç‡å¤§çº¦ä¸º 2%
4. é”™è¯¯ç‡ä¸º 10%ï¼Œä¸€ä¸ªå…ƒç´ éœ€è¦çš„å¹³å‡æŒ‡çº¹ç©ºé—´ä¸º 4.792 ä¸ª bitï¼Œå¤§çº¦ä¸º 5bit
5. é”™è¯¯ç‡ä¸º 1%ï¼Œä¸€ä¸ªå…ƒç´ éœ€è¦çš„å¹³å‡æŒ‡çº¹ç©ºé—´ä¸º 9.585 ä¸ª bitï¼Œå¤§çº¦ä¸º 10bit
6. é”™è¯¯ç‡ä¸º 0.1%ï¼Œä¸€ä¸ªå…ƒç´ éœ€è¦çš„å¹³å‡æŒ‡çº¹ç©ºé—´ä¸º 14.377 ä¸ª bitï¼Œå¤§çº¦ä¸º 15bit

ä½ ä¹Ÿè®¸ä¼šæƒ³ï¼Œå¦‚æœä¸€ä¸ªå…ƒç´ éœ€è¦å æ® 15 ä¸ª bitï¼Œé‚£ç›¸å¯¹ set é›†åˆçš„ç©ºé—´ä¼˜åŠ¿æ˜¯ä¸æ˜¯å°±æ²¡æœ‰é‚£ä¹ˆæ˜æ˜¾äº†ï¼Ÿè¿™é‡Œéœ€è¦æ˜ç¡®çš„æ˜¯ï¼Œset ä¸­ä¼šå­˜å‚¨æ¯ä¸ªå…ƒç´ çš„å†…å®¹ï¼Œè€Œå¸ƒéš†è¿‡æ»¤å™¨ä»…ä»…å­˜å‚¨å…ƒç´ çš„æŒ‡çº¹ã€‚å…ƒç´ çš„å†…å®¹å¤§å°å°±æ˜¯å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå®ƒä¸€èˆ¬ä¼šæœ‰å¤šä¸ªå­—èŠ‚ï¼Œç”šè‡³æ˜¯å‡ åä¸ªä¸Šç™¾ä¸ªå­—èŠ‚ï¼Œæ¯ä¸ªå…ƒç´ æœ¬èº«è¿˜éœ€è¦ä¸€ä¸ªæŒ‡é’ˆè¢« set é›†åˆæ¥å¼•ç”¨ï¼Œè¿™ä¸ªæŒ‡é’ˆåˆä¼šå å» 4 ä¸ªå­—èŠ‚æˆ– 8 ä¸ªå­—èŠ‚ï¼Œå–å†³äºç³»ç»Ÿæ˜¯ 32bit è¿˜æ˜¯ 64bitã€‚è€ŒæŒ‡çº¹ç©ºé—´åªæœ‰æ¥è¿‘ 2 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å¸ƒéš†è¿‡æ»¤å™¨çš„ç©ºé—´ä¼˜åŠ¿è¿˜æ˜¯éå¸¸æ˜æ˜¾çš„ã€‚

å¦‚æœè¯»è€…è§‰å¾—å…¬å¼è®¡ç®—èµ·æ¥å¤ªéº»çƒ¦ï¼Œä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œæœ‰å¾ˆå¤šç°æˆçš„ç½‘ç«™å·²ç»æ”¯æŒè®¡ç®—ç©ºé—´å ç”¨çš„åŠŸèƒ½äº†ï¼Œæˆ‘ä»¬åªè¦æŠŠå‚æ•°è¾“è¿›å»ï¼Œå°±å¯ä»¥ç›´æ¥çœ‹åˆ°ç»“æœï¼Œæ¯”å¦‚ [å¸ƒéš†è®¡ç®—å™¨](https://krisives.github.io/bloom-calculator/)ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/4/16464885cf1f74c2?w=735&h=541&f=png&s=72897)

## å®é™…å…ƒç´ è¶…å‡ºæ—¶ï¼Œè¯¯åˆ¤ç‡ä¼šæ€æ ·å˜åŒ–

å½“å®é™…å…ƒç´ è¶…å‡ºé¢„è®¡å…ƒç´ æ—¶ï¼Œé”™è¯¯ç‡ä¼šæœ‰å¤šå¤§å˜åŒ–ï¼Œå®ƒä¼šæ€¥å‰§ä¸Šå‡ä¹ˆï¼Œè¿˜æ˜¯å¹³ç¼“åœ°ä¸Šå‡ï¼Œè¿™å°±éœ€è¦å¦å¤–ä¸€ä¸ªå…¬å¼ï¼Œå¼•å…¥å‚æ•° t è¡¨ç¤ºå®é™…å…ƒç´ å’Œé¢„è®¡å…ƒç´ çš„å€æ•° t
```
f=(1-0.5^t)^k  # æé™è¿‘ä¼¼ï¼Œk æ˜¯ hash å‡½æ•°çš„æœ€ä½³æ•°é‡
```
å½“ t å¢å¤§æ—¶ï¼Œé”™è¯¯ç‡ï¼Œf ä¹Ÿä¼šè·Ÿç€å¢å¤§ï¼Œåˆ†åˆ«é€‰æ‹©é”™è¯¯ç‡ä¸º 10%,1%,0.1% çš„ k å€¼ï¼Œç”»å‡ºå®ƒçš„æ›²çº¿è¿›è¡Œç›´è§‚è§‚å¯Ÿ

![](https://user-gold-cdn.xitu.io/2018/7/5/164685454156e8e2?w=944&h=904&f=png&s=101584)

ä»è¿™ä¸ªå›¾ä¸­å¯ä»¥çœ‹å‡ºæ›²çº¿è¿˜æ˜¯æ¯”è¾ƒé™¡å³­çš„

1. é”™è¯¯ç‡ä¸º 10% æ—¶ï¼Œå€æ•°æ¯”ä¸º 2 æ—¶ï¼Œé”™è¯¯ç‡å°±ä¼šå‡è‡³æ¥è¿‘ 40%ï¼Œè¿™ä¸ªå°±æ¯”è¾ƒå±é™©äº†
2. é”™è¯¯ç‡ä¸º 1% æ—¶ï¼Œå€æ•°æ¯”ä¸º 2 æ—¶ï¼Œé”™è¯¯ç‡å‡è‡³ 15%ï¼Œä¹ŸæŒºå¯æ€•çš„
3. é”™è¯¯ç‡ä¸º 0.1%ï¼Œå€æ•°æ¯”ä¸º 2 æ—¶ï¼Œé”™è¯¯ç‡å‡è‡³ 5%ï¼Œä¹Ÿæ¯”è¾ƒæ‚¬äº†

## ç”¨ä¸ä¸Š Redis4.0 æ€ä¹ˆåŠï¼Ÿ

Redis 4.0 ä¹‹å‰ä¹Ÿæœ‰ç¬¬ä¸‰æ–¹çš„å¸ƒéš†è¿‡æ»¤å™¨ lib ä½¿ç”¨ï¼Œåªä¸è¿‡åœ¨å®ç°ä¸Šä½¿ç”¨ redis çš„ä½å›¾æ¥å®ç°çš„ï¼Œæ€§èƒ½ä¸Šä¹Ÿè¦å·®ä¸å°‘ã€‚æ¯”å¦‚ä¸€æ¬¡ exists æŸ¥è¯¢ä¼šæ¶‰åŠåˆ°å¤šæ¬¡ getbit æ“ä½œï¼Œç½‘ç»œå¼€é”€ç›¸æ¯”è€Œè¨€ä¼šé«˜å‡ºä¸å°‘ã€‚å¦å¤–åœ¨å®ç°ä¸Šè¿™äº›ç¬¬ä¸‰æ–¹ lib ä¹Ÿä¸å°½å®Œç¾ï¼Œæ¯”å¦‚ pyrebloom åº“å°±ä¸æ”¯æŒé‡è¿å’Œé‡è¯•ï¼Œåœ¨ä½¿ç”¨æ—¶éœ€è¦å¯¹å®ƒåšä¸€å±‚å°è£…åæ‰èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚

1. [Python Redis Bloom Filter](https://github.com/robinhoodmarkets/pyreBloom)
2. [Java Redis Bloom Filter](https://github.com/Baqend/Orestes-Bloomfilter)

## å¸ƒéš†è¿‡æ»¤å™¨çš„å…¶å®ƒåº”ç”¨

åœ¨çˆ¬è™«ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ URL è¿›è¡Œå»é‡ï¼Œå·²ç»çˆ¬è¿‡çš„ç½‘é¡µå°±å¯ä»¥ä¸ç”¨çˆ¬äº†ã€‚ä½†æ˜¯ URL å¤ªå¤šäº†ï¼Œå‡ åƒä¸‡å‡ ä¸ªäº¿ï¼Œå¦‚æœç”¨ä¸€ä¸ªé›†åˆè£…ä¸‹è¿™äº› URL åœ°å€é‚£æ˜¯éå¸¸æµªè´¹ç©ºé—´çš„ã€‚è¿™æ—¶å€™å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ã€‚å®ƒå¯ä»¥å¤§å¹…é™ä½å»é‡å­˜å‚¨æ¶ˆè€—ï¼Œåªä¸è¿‡ä¹Ÿä¼šä½¿å¾—çˆ¬è™«ç³»ç»Ÿé”™è¿‡å°‘é‡çš„é¡µé¢ã€‚

å¸ƒéš†è¿‡æ»¤å™¨åœ¨ NoSQL æ•°æ®åº“é¢†åŸŸä½¿ç”¨éå¸¸å¹¿æ³›ï¼Œæˆ‘ä»¬å¹³æ—¶ç”¨åˆ°çš„ HBaseã€Cassandra è¿˜æœ‰ LevelDBã€RocksDB å†…éƒ¨éƒ½æœ‰å¸ƒéš†è¿‡æ»¤å™¨ç»“æ„ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å¯ä»¥æ˜¾è‘—é™ä½æ•°æ®åº“çš„ IO è¯·æ±‚æ•°é‡ã€‚å½“ç”¨æˆ·æ¥æŸ¥è¯¢æŸä¸ª row æ—¶ï¼Œå¯ä»¥å…ˆé€šè¿‡å†…å­˜ä¸­çš„å¸ƒéš†è¿‡æ»¤å™¨è¿‡æ»¤æ‰å¤§é‡ä¸å­˜åœ¨çš„ row è¯·æ±‚ï¼Œç„¶åå†å»ç£ç›˜è¿›è¡ŒæŸ¥è¯¢ã€‚

é‚®ç®±ç³»ç»Ÿçš„åƒåœ¾é‚®ä»¶è¿‡æ»¤åŠŸèƒ½ä¹Ÿæ™®éç”¨åˆ°äº†å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå› ä¸ºç”¨äº†è¿™ä¸ªè¿‡æ»¤å™¨ï¼Œæ‰€ä»¥å¹³æ—¶ä¹Ÿä¼šé‡åˆ°æŸäº›æ­£å¸¸çš„é‚®ä»¶è¢«æ”¾è¿›äº†åƒåœ¾é‚®ä»¶ç›®å½•ä¸­ï¼Œè¿™ä¸ªå°±æ˜¯è¯¯åˆ¤æ‰€è‡´ï¼Œæ¦‚ç‡å¾ˆä½ã€‚

## æ‰©å±•é˜…è¯»

å¸ƒéš†è¿‡æ»¤å™¨çš„åŸç†æ¶‰åŠåˆ°è¾ƒä¸ºå¤æ‚çš„æ•°å­¦çŸ¥è¯†ï¼Œæ„Ÿå…´è¶£å¯ä»¥é˜…è¯»ä¸‹é¢çš„é“¾æ¥æ–‡ç« ç»§ç»­æ·±å…¥äº†è§£å†…éƒ¨åŸç†ï¼š[å¸ƒéš†è¿‡æ»¤å™¨](http://www.cnblogs.com/allensun/archive/2011/02/16/1956532.html)ã€‚

åŒæ ·ï¼Œå¦‚æœä½ æ˜¯ä¸ªæ•°å­¦å­¦æ¸£ï¼Œé‚£è€å¸ˆæˆ‘å»ºè®®ä½ è°¨æ…è§‚çœ‹ï¼Œè¦æ³¨æ„ä¿æŠ¤å¥½è‡ªå·±çš„ 24K é’›åˆé‡‘ç‹—çœ¼ï¼Œé¿å…é—ªçã€‚
# åº”ç”¨ 6ï¼šæ–­å°¾æ±‚ç”Ÿ â€”â€” ç®€å•é™æµ

é™æµç®—æ³•åœ¨åˆ†å¸ƒå¼é¢†åŸŸæ˜¯ä¸€ä¸ªç»å¸¸è¢«æèµ·çš„è¯é¢˜ï¼Œå½“ç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›æœ‰é™æ—¶ï¼Œå¦‚ä½•é˜»æ­¢è®¡åˆ’å¤–çš„è¯·æ±‚ç»§ç»­å¯¹ç³»ç»Ÿæ–½å‹ï¼Œè¿™æ˜¯ä¸€ä¸ªéœ€è¦é‡è§†çš„é—®é¢˜ã€‚è€é’±åœ¨è¿™é‡Œç”¨ â€œæ–­å°¾æ±‚ç”Ÿâ€ å½¢å®¹é™æµèƒŒåçš„æ€æƒ³ï¼Œå½“ç„¶è¿˜æœ‰å¾ˆå¤šæˆè¯­ä¹Ÿè¡¨è¾¾äº†ç±»ä¼¼çš„æ„æ€ï¼Œå¦‚å¼ƒå’ä¿è½¦ã€å£®å£«æ–­è…•ç­‰ç­‰ã€‚

é™¤äº†æ§åˆ¶æµé‡ï¼Œé™æµè¿˜æœ‰ä¸€ä¸ªåº”ç”¨ç›®çš„æ˜¯ç”¨äºæ§åˆ¶ç”¨æˆ·è¡Œä¸ºï¼Œé¿å…åƒåœ¾è¯·æ±‚ã€‚æ¯”å¦‚åœ¨ UGC ç¤¾åŒºï¼Œç”¨æˆ·çš„å‘å¸–ã€å›å¤ã€ç‚¹èµç­‰è¡Œä¸ºéƒ½è¦ä¸¥æ ¼å—æ§ï¼Œä¸€èˆ¬è¦ä¸¥æ ¼é™å®šæŸè¡Œä¸ºåœ¨è§„å®šæ—¶é—´å†…å…è®¸çš„æ¬¡æ•°ï¼Œè¶…è¿‡äº†æ¬¡æ•°é‚£å°±æ˜¯éæ³•è¡Œä¸ºã€‚å¯¹éæ³•è¡Œä¸ºï¼Œä¸šåŠ¡å¿…é¡»è§„å®šé€‚å½“çš„æƒ©å¤„ç­–ç•¥ã€‚

## å¦‚ä½•ä½¿ç”¨ Redis æ¥å®ç°ç®€å•é™æµç­–ç•¥ï¼Ÿ

é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå¸¸è§ çš„ç®€å•çš„é™æµç­–ç•¥ã€‚ç³»ç»Ÿè¦é™å®šç”¨æˆ·çš„æŸä¸ªè¡Œä¸ºåœ¨æŒ‡å®šçš„æ—¶é—´é‡Œåªèƒ½å…è®¸å‘ç”Ÿ N æ¬¡ï¼Œå¦‚ä½•ä½¿ç”¨ Redis çš„æ•°æ®ç»“æ„æ¥å®ç°è¿™ä¸ªé™æµçš„åŠŸèƒ½ï¼Ÿ

æˆ‘ä»¬å…ˆå®šä¹‰è¿™ä¸ªæ¥å£ï¼Œç†è§£äº†è¿™ä¸ªæ¥å£çš„å®šä¹‰ï¼Œè¯»è€…å°±åº”è¯¥èƒ½æ˜ç™½æˆ‘ä»¬æœŸæœ›è¾¾åˆ°çš„åŠŸèƒ½ã€‚
```
# æŒ‡å®šç”¨æˆ· user_id çš„æŸä¸ªè¡Œä¸º action_key åœ¨ç‰¹å®šçš„æ—¶é—´å†… period åªå…è®¸å‘ç”Ÿä¸€å®šçš„æ¬¡æ•° max_count
def is_action_allowed(user_id, action_key, period, max_count):
    return True
# è°ƒç”¨è¿™ä¸ªæ¥å£ , ä¸€åˆ†é’Ÿå†…åªå…è®¸æœ€å¤šå›å¤ 5 ä¸ªå¸–å­
can_reply = is_action_allowed("laoqian", "reply", 60, 5)
if can_reply:
    do_reply()
else:
    raise ActionThresholdOverflow()
```

å…ˆä¸è¦ç»§ç»­å¾€åçœ‹ï¼Œæƒ³æƒ³å¦‚æœè®©ä½ æ¥å®ç°ï¼Œä½ è¯¥æ€ä¹ˆåšï¼Ÿ

### è§£å†³æ–¹æ¡ˆ

è¿™ä¸ªé™æµéœ€æ±‚ä¸­å­˜åœ¨ä¸€ä¸ªæ»‘åŠ¨æ—¶é—´çª—å£ï¼Œæƒ³æƒ³ zset æ•°æ®ç»“æ„çš„ score å€¼ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥é€šè¿‡ score æ¥åœˆå‡ºè¿™ä¸ªæ—¶é—´çª—å£æ¥ã€‚è€Œä¸”æˆ‘ä»¬åªéœ€è¦ä¿ç•™è¿™ä¸ªæ—¶é—´çª—å£ï¼Œçª—å£ä¹‹å¤–çš„æ•°æ®éƒ½å¯ä»¥ç æ‰ã€‚é‚£è¿™ä¸ª zset çš„ value å¡«ä»€ä¹ˆæ¯”è¾ƒåˆé€‚å‘¢ï¼Ÿå®ƒåªéœ€è¦ä¿è¯å”¯ä¸€æ€§å³å¯ï¼Œç”¨ uuid ä¼šæ¯”è¾ƒæµªè´¹ç©ºé—´ï¼Œé‚£å°±æ”¹ç”¨æ¯«ç§’æ—¶é—´æˆ³å§ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/10/16483c2609601098?w=711&h=463&f=png&s=21910)

å¦‚å›¾æ‰€ç¤ºï¼Œç”¨ä¸€ä¸ª zset ç»“æ„è®°å½•ç”¨æˆ·çš„è¡Œä¸ºå†å²ï¼Œæ¯ä¸€ä¸ªè¡Œä¸ºéƒ½ä¼šä½œä¸º zset ä¸­çš„ä¸€ä¸ª key ä¿å­˜ä¸‹æ¥ã€‚åŒä¸€ä¸ªç”¨æˆ·åŒä¸€ç§è¡Œä¸ºç”¨ä¸€ä¸ª zset è®°å½•ã€‚

ä¸ºèŠ‚çœå†…å­˜ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿ç•™æ—¶é—´çª—å£å†…çš„è¡Œä¸ºè®°å½•ï¼ŒåŒæ—¶å¦‚æœç”¨æˆ·æ˜¯å†·ç”¨æˆ·ï¼Œæ»‘åŠ¨æ—¶é—´çª—å£å†…çš„è¡Œä¸ºæ˜¯ç©ºè®°å½•ï¼Œé‚£ä¹ˆè¿™ä¸ª zset å°±å¯ä»¥ä»å†…å­˜ä¸­ç§»é™¤ï¼Œä¸å†å ç”¨ç©ºé—´ã€‚

é€šè¿‡ç»Ÿè®¡æ»‘åŠ¨çª—å£å†…çš„è¡Œä¸ºæ•°é‡ä¸é˜ˆå€¼ max_count è¿›è¡Œæ¯”è¾ƒå°±å¯ä»¥å¾—å‡ºå½“å‰çš„è¡Œä¸ºæ˜¯å¦å…è®¸ã€‚ç”¨ä»£ç è¡¨ç¤ºå¦‚ä¸‹ï¼š
```py
# coding: utf8

import time
import redis

client = redis.StrictRedis()

def is_action_allowed(user_id, action_key, period, max_count):
    key = 'hist:%s:%s' % (user_id, action_key)
    now_ts = int(time.time() * 1000)  # æ¯«ç§’æ—¶é—´æˆ³
    with client.pipeline() as pipe:  # client æ˜¯ StrictRedis å®ä¾‹
        # è®°å½•è¡Œä¸º
        pipe.zadd(key, now_ts, now_ts)  # value å’Œ score éƒ½ä½¿ç”¨æ¯«ç§’æ—¶é—´æˆ³
        # ç§»é™¤æ—¶é—´çª—å£ä¹‹å‰çš„è¡Œä¸ºè®°å½•ï¼Œå‰©ä¸‹çš„éƒ½æ˜¯æ—¶é—´çª—å£å†…çš„
        pipe.zremrangebyscore(key, 0, now_ts - period * 1000)
        # è·å–çª—å£å†…çš„è¡Œä¸ºæ•°é‡
        pipe.zcard(key)
        # è®¾ç½® zset è¿‡æœŸæ—¶é—´ï¼Œé¿å…å†·ç”¨æˆ·æŒç»­å ç”¨å†…å­˜
        # è¿‡æœŸæ—¶é—´åº”è¯¥ç­‰äºæ—¶é—´çª—å£çš„é•¿åº¦ï¼Œå†å¤šå®½é™ 1s
        pipe.expire(key, period + 1)
        # æ‰¹é‡æ‰§è¡Œ
        _, _, current_count, _ = pipe.execute()
    # æ¯”è¾ƒæ•°é‡æ˜¯å¦è¶…æ ‡
    return current_count <= max_count


for i in range(20):
    print is_action_allowed("laoqian", "reply", 60, 5)
```
Java ç‰ˆï¼š
```java
public class SimpleRateLimiter {

  private Jedis jedis;

  public SimpleRateLimiter(Jedis jedis) {
    this.jedis = jedis;
  }

  public boolean isActionAllowed(String userId, String actionKey, int period, int maxCount) {
    String key = String.format("hist:%s:%s", userId, actionKey);
    long nowTs = System.currentTimeMillis();
    Pipeline pipe = jedis.pipelined();
    pipe.multi();
    pipe.zadd(key, nowTs, "" + nowTs);
    pipe.zremrangeByScore(key, 0, nowTs - period * 1000);
    Response<Long> count = pipe.zcard(key);
    pipe.expire(key, period + 1);
    pipe.exec();
    pipe.close();
    return count.get() <= maxCount;
  }

  public static void main(String[] args) {
    Jedis jedis = new Jedis();
    SimpleRateLimiter limiter = new SimpleRateLimiter(jedis);
    for(int i=0;i<20;i++) {
      System.out.println(limiter.isActionAllowed("laoqian", "reply", 60, 5));
    }
  }

}
```

è¿™æ®µä»£ç è¿˜æ˜¯ç•¥æ˜¾å¤æ‚ï¼Œéœ€è¦è¯»è€…èŠ±ä¸€å®šçš„æ—¶é—´å¥½å¥½å•ƒã€‚å®ƒçš„æ•´ä½“æ€è·¯å°±æ˜¯ï¼šæ¯ä¸€ä¸ªè¡Œä¸ºåˆ°æ¥æ—¶ï¼Œéƒ½ç»´æŠ¤ä¸€æ¬¡æ—¶é—´çª—å£ã€‚å°†æ—¶é—´çª—å£å¤–çš„è®°å½•å…¨éƒ¨æ¸…ç†æ‰ï¼Œåªä¿ç•™çª—å£å†…çš„è®°å½•ã€‚zset é›†åˆä¸­åªæœ‰ score å€¼éå¸¸é‡è¦ï¼Œvalue å€¼æ²¡æœ‰ç‰¹åˆ«çš„æ„ä¹‰ï¼Œåªéœ€è¦ä¿è¯å®ƒæ˜¯å”¯ä¸€çš„å°±å¯ä»¥äº†ã€‚

å› ä¸ºè¿™å‡ ä¸ªè¿ç»­çš„ Redis æ“ä½œéƒ½æ˜¯é’ˆå¯¹åŒä¸€ä¸ª key çš„ï¼Œä½¿ç”¨ pipeline å¯ä»¥æ˜¾è‘—æå‡ Redis å­˜å–æ•ˆç‡ã€‚ä½†è¿™ç§æ–¹æ¡ˆä¹Ÿæœ‰ç¼ºç‚¹ï¼Œå› ä¸ºå®ƒè¦è®°å½•æ—¶é—´çª—å£å†…æ‰€æœ‰çš„è¡Œä¸ºè®°å½•ï¼Œå¦‚æœè¿™ä¸ªé‡å¾ˆå¤§ï¼Œæ¯”å¦‚é™å®š 60s å†…æ“ä½œä¸å¾—è¶…è¿‡ 100w æ¬¡è¿™æ ·çš„å‚æ•°ï¼Œå®ƒæ˜¯ä¸é€‚åˆåšè¿™æ ·çš„é™æµçš„ï¼Œå› ä¸ºä¼šæ¶ˆè€—å¤§é‡çš„å­˜å‚¨ç©ºé—´ã€‚

## å°ç»“

æœ¬èŠ‚ä»‹ç»çš„æ˜¯é™æµç­–ç•¥çš„ç®€å•åº”ç”¨ï¼Œå®ƒä»ç„¶æœ‰è¾ƒå¤§çš„æå‡ç©ºé—´ï¼Œé€‚ç”¨çš„åœºæ™¯ä¹Ÿæœ‰é™ã€‚ä¸ºäº†è§£å†³ç®€å•é™æµçš„ç¼ºç‚¹ï¼Œä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†å¼•å…¥é«˜çº§é™æµç®—æ³•â€”â€”æ¼æ–—é™æµã€‚
# åº”ç”¨ 7ï¼šä¸€æ¯›ä¸æ‹” â€”â€” æ¼æ–—é™æµ

æ¼æ–—é™æµæ˜¯æœ€å¸¸ç”¨çš„é™æµæ–¹æ³•ä¹‹ä¸€ï¼Œé¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªç®—æ³•çš„çµæ„Ÿæºäºæ¼æ–—ï¼ˆfunnelï¼‰çš„ç»“æ„ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/10/164847a37cfcea2e?w=730&h=320&f=png&s=73710)

æ¼æ–—çš„å®¹é‡æ˜¯æœ‰é™çš„ï¼Œå¦‚æœå°†æ¼å˜´å µä½ï¼Œç„¶åä¸€ç›´å¾€é‡Œé¢çŒæ°´ï¼Œå®ƒå°±ä¼šå˜æ»¡ï¼Œç›´è‡³å†ä¹Ÿè£…ä¸è¿›å»ã€‚å¦‚æœå°†æ¼å˜´æ”¾å¼€ï¼Œæ°´å°±ä¼šå¾€ä¸‹æµï¼Œæµèµ°ä¸€éƒ¨åˆ†ä¹‹åï¼Œå°±åˆå¯ä»¥ç»§ç»­å¾€é‡Œé¢çŒæ°´ã€‚å¦‚æœæ¼å˜´æµæ°´çš„é€Ÿç‡å¤§äºçŒæ°´çš„é€Ÿç‡ï¼Œé‚£ä¹ˆæ¼æ–—æ°¸è¿œéƒ½è£…ä¸æ»¡ã€‚å¦‚æœæ¼å˜´æµæ°´é€Ÿç‡å°äºçŒæ°´çš„é€Ÿç‡ï¼Œé‚£ä¹ˆä¸€æ—¦æ¼æ–—æ»¡äº†ï¼ŒçŒæ°´å°±éœ€è¦æš‚åœå¹¶ç­‰å¾…æ¼æ–—è…¾ç©ºã€‚

![](https://user-gold-cdn.xitu.io/2018/7/11/16487813367a459d?w=483&h=174&f=png&s=30383)

æ‰€ä»¥ï¼Œæ¼æ–—çš„å‰©ä½™ç©ºé—´å°±ä»£è¡¨ç€å½“å‰è¡Œä¸ºå¯ä»¥æŒç»­è¿›è¡Œçš„æ•°é‡ï¼Œæ¼å˜´çš„æµæ°´é€Ÿç‡ä»£è¡¨ç€ç³»ç»Ÿå…è®¸è¯¥è¡Œä¸ºçš„æœ€å¤§é¢‘ç‡ã€‚ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ä»£ç æ¥æè¿°å•æœºæ¼æ–—ç®—æ³•ã€‚

```py
# coding: utf8

import time

class Funnel(object):

    def __init__(self, capacity, leaking_rate):
        self.capacity = capacity  # æ¼æ–—å®¹é‡
        self.leaking_rate = leaking_rate  # æ¼å˜´æµæ°´é€Ÿç‡
        self.left_quota = capacity  # æ¼æ–—å‰©ä½™ç©ºé—´
        self.leaking_ts = time.time()  # ä¸Šä¸€æ¬¡æ¼æ°´æ—¶é—´

    def make_space(self):
        now_ts = time.time()
        delta_ts = now_ts - self.leaking_ts  # è·ç¦»ä¸Šä¸€æ¬¡æ¼æ°´è¿‡å»äº†å¤šä¹…
        delta_quota = delta_ts * self.leaking_rate  # åˆå¯ä»¥è…¾å‡ºä¸å°‘ç©ºé—´äº†
        if delta_quota < 1:  # è…¾çš„ç©ºé—´å¤ªå°‘ï¼Œé‚£å°±ç­‰ä¸‹æ¬¡å§
            return
        self.left_quota += delta_quota  # å¢åŠ å‰©ä½™ç©ºé—´
        self.leaking_ts = now_ts  # è®°å½•æ¼æ°´æ—¶é—´
        if self.left_quota > self.capacity:  # å‰©ä½™ç©ºé—´ä¸å¾—é«˜äºå®¹é‡
            self.left_quota = self.capacity

    def watering(self, quota):
        self.make_space()
        if self.left_quota >= quota:  # åˆ¤æ–­å‰©ä½™ç©ºé—´æ˜¯å¦è¶³å¤Ÿ
            self.left_quota -= quota
            return True
        return False


funnels = {}  # æ‰€æœ‰çš„æ¼æ–—

# capacity  æ¼æ–—å®¹é‡
# leaking_rate æ¼å˜´æµæ°´é€Ÿç‡ quota/s
def is_action_allowed(
        user_id, action_key, capacity, leaking_rate):
    key = '%s:%s' % (user_id, action_key)
    funnel = funnels.get(key)
    if not funnel:
        funnel = Funnel(capacity, leaking_rate)
        funnels[key] = funnel
    return funnel.watering(1)


for i in range(20):
    print is_action_allowed('laoqian', 'reply', 15, 0.5)
```
å†æä¾›ä¸€ä¸ª Java ç‰ˆæœ¬çš„ï¼š
```java
public class FunnelRateLimiter {

  static class Funnel {
    int capacity;
    float leakingRate;
    int leftQuota;
    long leakingTs;

    public Funnel(int capacity, float leakingRate) {
      this.capacity = capacity;
      this.leakingRate = leakingRate;
      this.leftQuota = capacity;
      this.leakingTs = System.currentTimeMillis();
    }

    void makeSpace() {
      long nowTs = System.currentTimeMillis();
      long deltaTs = nowTs - leakingTs;
      int deltaQuota = (int) (deltaTs * leakingRate);
      if (deltaQuota < 0) { // é—´éš”æ—¶é—´å¤ªé•¿ï¼Œæ•´æ•°æ•°å­—è¿‡å¤§æº¢å‡º
        this.leftQuota = capacity;
        this.leakingTs = nowTs;
        return;
      }
      if (deltaQuota < 1) { // è…¾å‡ºç©ºé—´å¤ªå°ï¼Œæœ€å°å•ä½æ˜¯1
        return;
      }
      this.leftQuota += deltaQuota;
      this.leakingTs = nowTs;
      if (this.leftQuota > this.capacity) {
        this.leftQuota = this.capacity;
      }
    }

    boolean watering(int quota) {
      makeSpace();
      if (this.leftQuota >= quota) {
        this.leftQuota -= quota;
        return true;
      }
      return false;
    }
  }

  private Map<String, Funnel> funnels = new HashMap<>();

  public boolean isActionAllowed(String userId, String actionKey, int capacity, float leakingRate) {
    String key = String.format("%s:%s", userId, actionKey);
    Funnel funnel = funnels.get(key);
    if (funnel == null) {
      funnel = new Funnel(capacity, leakingRate);
      funnels.put(key, funnel);
    }
    return funnel.watering(1); // éœ€è¦1ä¸ªquota
  }
}
```
Funnel å¯¹è±¡çš„ make_space æ–¹æ³•æ˜¯æ¼æ–—ç®—æ³•çš„æ ¸å¿ƒï¼Œå…¶åœ¨æ¯æ¬¡çŒæ°´å‰éƒ½ä¼šè¢«è°ƒç”¨ä»¥è§¦å‘æ¼æ°´ï¼Œç»™æ¼æ–—è…¾å‡ºç©ºé—´æ¥ã€‚èƒ½è…¾å‡ºå¤šå°‘ç©ºé—´å–å†³äºè¿‡å»äº†å¤šä¹…ä»¥åŠæµæ°´çš„é€Ÿç‡ã€‚Funnel å¯¹è±¡å æ®çš„ç©ºé—´å¤§å°ä¸å†å’Œè¡Œä¸ºçš„é¢‘ç‡æˆæ­£æ¯”ï¼Œå®ƒçš„ç©ºé—´å ç”¨æ˜¯ä¸€ä¸ªå¸¸é‡ã€‚

é—®é¢˜æ¥äº†ï¼Œåˆ†å¸ƒå¼çš„æ¼æ–—ç®—æ³•è¯¥å¦‚ä½•å®ç°ï¼Ÿèƒ½ä¸èƒ½ä½¿ç”¨ Redis çš„åŸºç¡€æ•°æ®ç»“æ„æ¥æå®šï¼Ÿ

æˆ‘ä»¬è§‚å¯Ÿ Funnel å¯¹è±¡çš„å‡ ä¸ªå­—æ®µï¼Œæˆ‘ä»¬å‘ç°å¯ä»¥å°† Funnel å¯¹è±¡çš„å†…å®¹æŒ‰å­—æ®µå­˜å‚¨åˆ°ä¸€ä¸ª hash ç»“æ„ä¸­ï¼ŒçŒæ°´çš„æ—¶å€™å°† hash ç»“æ„çš„å­—æ®µå–å‡ºæ¥è¿›è¡Œé€»è¾‘è¿ç®—åï¼Œå†å°†æ–°å€¼å›å¡«åˆ° hash ç»“æ„ä¸­å°±å®Œæˆäº†ä¸€æ¬¡è¡Œä¸ºé¢‘åº¦çš„æ£€æµ‹ã€‚

ä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ— æ³•ä¿è¯æ•´ä¸ªè¿‡ç¨‹çš„åŸå­æ€§ã€‚ä» hash ç»“æ„ä¸­å–å€¼ï¼Œç„¶ååœ¨å†…å­˜é‡Œè¿ç®—ï¼Œå†å›å¡«åˆ° hash ç»“æ„ï¼Œè¿™ä¸‰ä¸ªè¿‡ç¨‹æ— æ³•åŸå­åŒ–ï¼Œæ„å‘³ç€éœ€è¦è¿›è¡Œé€‚å½“çš„åŠ é”æ§åˆ¶ã€‚è€Œä¸€æ—¦åŠ é”ï¼Œå°±æ„å‘³ç€ä¼šæœ‰åŠ é”å¤±è´¥ï¼ŒåŠ é”å¤±è´¥å°±éœ€è¦é€‰æ‹©é‡è¯•æˆ–è€…æ”¾å¼ƒã€‚

å¦‚æœé‡è¯•çš„è¯ï¼Œå°±ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚å¦‚æœæ”¾å¼ƒçš„è¯ï¼Œå°±ä¼šå½±å“ç”¨æˆ·ä½“éªŒã€‚åŒæ—¶ï¼Œä»£ç çš„å¤æ‚åº¦ä¹Ÿè·Ÿç€å‡é«˜å¾ˆå¤šã€‚è¿™çœŸæ˜¯ä¸ªè‰°éš¾çš„é€‰æ‹©ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼ŸRedis-Cell æ•‘æ˜Ÿæ¥äº†ï¼

## Redis-Cell

Redis 4.0 æä¾›äº†ä¸€ä¸ªé™æµ Redis æ¨¡å—ï¼Œå®ƒå« redis-cellã€‚è¯¥æ¨¡å—ä¹Ÿä½¿ç”¨äº†æ¼æ–—ç®—æ³•ï¼Œå¹¶æä¾›äº†åŸå­çš„é™æµæŒ‡ä»¤ã€‚æœ‰äº†è¿™ä¸ªæ¨¡å—ï¼Œé™æµé—®é¢˜å°±éå¸¸ç®€å•äº†ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/11/1648780927d6f4ec?w=522&h=202&f=png&s=32765)

è¯¥æ¨¡å—åªæœ‰1æ¡æŒ‡ä»¤```cl.throttle```ï¼Œå®ƒçš„å‚æ•°å’Œè¿”å›å€¼éƒ½ç•¥æ˜¾å¤æ‚ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªæŒ‡ä»¤å…·ä½“è¯¥å¦‚ä½•ä½¿ç”¨ã€‚
```
> cl.throttle laoqian:reply 15 30 60 1
                      â–²     â–²  â–²  â–²  â–²
                      |     |  |  |  â””â”€â”€â”€â”€â”€ need 1 quota (å¯é€‰å‚æ•°ï¼Œé»˜è®¤å€¼ä¹Ÿæ˜¯1)
                      |     |  â””â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€ 30 operations / 60 seconds è¿™æ˜¯æ¼æ°´é€Ÿç‡
                      |     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 15 capacity è¿™æ˜¯æ¼æ–—å®¹é‡
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ key laoqian
```
ä¸Šé¢è¿™ä¸ªæŒ‡ä»¤çš„æ„æ€æ˜¯å…è®¸ã€Œç”¨æˆ·è€é’±å›å¤è¡Œä¸ºã€çš„é¢‘ç‡ä¸ºæ¯ 60s æœ€å¤š 30 æ¬¡(æ¼æ°´é€Ÿç‡)ï¼Œæ¼æ–—çš„åˆå§‹å®¹é‡ä¸º 15ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€å¼€å§‹å¯ä»¥è¿ç»­å›å¤ 15 ä¸ªå¸–å­ï¼Œç„¶åæ‰å¼€å§‹å—æ¼æ°´é€Ÿç‡çš„å½±å“ã€‚æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªæŒ‡ä»¤ä¸­æ¼æ°´é€Ÿç‡å˜æˆäº† 2 ä¸ªå‚æ•°ï¼Œæ›¿ä»£äº†ä¹‹å‰çš„å•ä¸ªæµ®ç‚¹æ•°ã€‚ç”¨ä¸¤ä¸ªå‚æ•°ç›¸é™¤çš„ç»“æœæ¥è¡¨è¾¾æ¼æ°´é€Ÿç‡ç›¸å¯¹å•ä¸ªæµ®ç‚¹æ•°è¦æ›´åŠ ç›´è§‚ä¸€äº›ã€‚
```
> cl.throttle laoqian:reply 15 30 60
1) (integer) 0   # 0 è¡¨ç¤ºå…è®¸ï¼Œ1è¡¨ç¤ºæ‹’ç»
2) (integer) 15  # æ¼æ–—å®¹é‡capacity
3) (integer) 14  # æ¼æ–—å‰©ä½™ç©ºé—´left_quota
4) (integer) -1  # å¦‚æœæ‹’ç»äº†ï¼Œéœ€è¦å¤šé•¿æ—¶é—´åå†è¯•(æ¼æ–—æœ‰ç©ºé—´äº†ï¼Œå•ä½ç§’)
5) (integer) 2   # å¤šé•¿æ—¶é—´åï¼Œæ¼æ–—å®Œå…¨ç©ºå‡ºæ¥(left_quota==capacityï¼Œå•ä½ç§’)
```

åœ¨æ‰§è¡Œé™æµæŒ‡ä»¤æ—¶ï¼Œå¦‚æœè¢«æ‹’ç»äº†ï¼Œå°±éœ€è¦ä¸¢å¼ƒæˆ–é‡è¯•ã€‚cl.throttle æŒ‡ä»¤è€ƒè™‘çš„éå¸¸å‘¨åˆ°ï¼Œè¿é‡è¯•æ—¶é—´éƒ½å¸®ä½ ç®—å¥½äº†ï¼Œç›´æ¥å–è¿”å›ç»“æœæ•°ç»„çš„ç¬¬å››ä¸ªå€¼è¿›è¡Œ sleep å³å¯ï¼Œå¦‚æœä¸æƒ³é˜»å¡çº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥å¼‚æ­¥å®šæ—¶ä»»åŠ¡æ¥é‡è¯•ã€‚

## æ€è€ƒ
æ¼æ–—é™æµæ¨¡å—é™¤äº†åº”ç”¨äº UGCï¼Œè¿˜èƒ½åº”ç”¨äºå“ªäº›åœ°æ–¹ï¼Ÿ

## æ‹“å±•é˜…è¯»

**1. ã€ŠRedis-Cell ä½œè€… Itamar Haber å…¶äººè¶£äº‹ã€‹**

![](https://user-gold-cdn.xitu.io/2018/7/11/164872dc531f1a48?w=865&h=141&f=png&s=56775)

Redis-Cell ä½œè€… Itamar Haber  çš„ä»‹ç»å¾ˆæœ‰æ„æ€â€”â€”ä¸€ä¸ªã€Œè‡ªå°ã€çš„ Redis æå®¢ã€‚è¿˜æœ‰ï¼ŒCell è¿™ä¸ªæ¨¡å—å±…ç„¶æ˜¯ç”¨ Rust ç¼–å†™çš„ã€‚â€”â€” åŸæ¥ Redis æ¨¡å—å¯ä»¥ä½¿ç”¨ Rust ç¼–å†™ï¼Ÿï¼

è¿™æ„å‘³ç€æˆ‘ä»¬ä¸ç”¨å»æå¤è€çš„ C è¯­è¨€äº†ã€‚è€é’±è¡¨ç¤ºè¦é‡æ–°æ‹¾èµ·æ”¾å¼ƒå¾ˆä¹…çš„ Rust è¯­è¨€ã€‚å“ï¼Œå¹²ç¨‹åºå‘˜è¿™ä¸€è¡Œï¼ŒçœŸæ˜¯è¦æ´»åˆ°è€ï¼Œå­¦åˆ°æ­»å•Šï¼ğŸ˜¢

# åº”ç”¨ 8ï¼šè¿‘æ°´æ¥¼å° â€”â€” GeoHash

Redis åœ¨ 3.2 ç‰ˆæœ¬ä»¥åå¢åŠ äº†åœ°ç†ä½ç½® GEO æ¨¡å—ï¼Œæ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Redis æ¥å®ç°æ‘©æ‹œå•è½¦ã€Œé™„è¿‘çš„ Mobikeã€ã€ç¾å›¢å’Œé¥¿äº†ä¹ˆã€Œé™„è¿‘çš„é¤é¦†ã€è¿™æ ·çš„åŠŸèƒ½äº†ã€‚

## ç”¨æ•°æ®åº“æ¥ç®—é™„è¿‘çš„äºº

åœ°å›¾å…ƒç´ çš„ä½ç½®æ•°æ®ä½¿ç”¨äºŒç»´çš„ç»çº¬åº¦è¡¨ç¤ºï¼Œç»åº¦èŒƒå›´ (-180, 180]ï¼Œçº¬åº¦èŒƒå›´ (-90, 90]ï¼Œçº¬åº¦æ­£è´Ÿä»¥èµ¤é“ä¸ºç•Œï¼ŒåŒ—æ­£å—è´Ÿï¼Œç»åº¦æ­£è´Ÿä»¥æœ¬åˆå­åˆçº¿ (è‹±å›½æ ¼æ—å°¼æ²»å¤©æ–‡å°) ä¸ºç•Œï¼Œä¸œæ­£è¥¿è´Ÿã€‚æ¯”å¦‚æ˜é‡‘åŠå…¬å®¤åœ¨æœ›äº¬ SOHOï¼Œå®ƒçš„ç»çº¬åº¦åæ ‡æ˜¯ (116.48105,39.996794)ï¼Œéƒ½æ˜¯æ­£æ•°ï¼Œå› ä¸ºä¸­å›½ä½äºä¸œåŒ—åŠçƒã€‚

å½“ä¸¤ä¸ªå…ƒç´ çš„è·ç¦»ä¸æ˜¯å¾ˆè¿œæ—¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å‹¾è‚¡å®šç†å°±èƒ½ç®—å¾—å…ƒç´ ä¹‹é—´çš„è·ç¦»ã€‚æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„ã€Œé™„è¿‘çš„äººã€çš„åŠŸèƒ½ï¼Œå…ƒç´ è·ç¦»éƒ½ä¸æ˜¯å¾ˆå¤§ï¼Œå‹¾è‚¡å®šç†ç®—è·ç¦»è¶³çŸ£ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»çº¬åº¦åæ ‡çš„å¯†åº¦ä¸ä¸€æ · (åœ°çƒæ˜¯ä¸€ä¸ªæ¤­åœ†)ï¼Œå‹¾è‚¡å®šå¾‹è®¡ç®—å¹³æ–¹å·®æ—¶ä¹‹åå†æ±‚å’Œæ—¶ï¼Œéœ€è¦æŒ‰ä¸€å®šçš„ç³»æ•°æ¯”åŠ æƒæ±‚å’Œï¼Œå¦‚æœä¸æ±‚ç²¾ç¡®çš„è¯ï¼Œä¹Ÿå¯ä»¥ä¸å¿…åŠ æƒã€‚

é—®é¢˜ï¼šç»åº¦æ€»å…±360åº¦ï¼Œç»´åº¦æ€»å…±åªæœ‰180åº¦ï¼Œä¸ºä»€ä¹ˆè·ç¦»å¯†åº¦ä¸æ˜¯2:1ï¼Ÿ

ç°åœ¨ï¼Œå¦‚æœè¦è®¡ç®—ã€Œé™„è¿‘çš„äººã€ï¼Œä¹Ÿå°±æ˜¯ç»™å®šä¸€ä¸ªå…ƒç´ çš„åæ ‡ï¼Œç„¶åè®¡ç®—è¿™ä¸ªåæ ‡é™„è¿‘çš„å…¶å®ƒå…ƒç´ ï¼ŒæŒ‰ç…§è·ç¦»è¿›è¡Œæ’åºï¼Œè¯¥å¦‚ä½•ä¸‹æ‰‹ï¼Ÿ

![](https://user-gold-cdn.xitu.io/2018/7/4/1646385f96a0f91f?w=657&h=334&f=png&s=17950)

å¦‚æœç°åœ¨å…ƒç´ çš„ç»çº¬åº¦åæ ‡ä½¿ç”¨å…³ç³»æ•°æ®åº“ (å…ƒç´  id, ç»åº¦ x, çº¬åº¦ y) å­˜å‚¨ï¼Œä½ è¯¥å¦‚ä½•è®¡ç®—ï¼Ÿ

é¦–å…ˆï¼Œä½ ä¸å¯èƒ½é€šè¿‡éå†æ¥è®¡ç®—æ‰€æœ‰çš„å…ƒç´ å’Œç›®æ ‡å…ƒç´ çš„è·ç¦»ç„¶åå†è¿›è¡Œæ’åºï¼Œè¿™ä¸ªè®¡ç®—é‡å¤ªå¤§äº†ï¼Œæ€§èƒ½æŒ‡æ ‡è‚¯å®šæ— æ³•æ»¡è¶³ã€‚ä¸€èˆ¬çš„æ–¹æ³•éƒ½æ˜¯é€šè¿‡çŸ©å½¢åŒºåŸŸæ¥é™å®šå…ƒç´ çš„æ•°é‡ï¼Œç„¶åå¯¹åŒºåŸŸå†…çš„å…ƒç´ è¿›è¡Œå…¨é‡è·ç¦»è®¡ç®—å†æ’åºã€‚è¿™æ ·å¯ä»¥æ˜æ˜¾å‡å°‘è®¡ç®—é‡ã€‚å¦‚ä½•åˆ’åˆ†çŸ©å½¢åŒºåŸŸå‘¢ï¼Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªåŠå¾„ rï¼Œä½¿ç”¨ä¸€æ¡ SQL å°±å¯ä»¥åœˆå‡ºæ¥ã€‚å½“ç”¨æˆ·å¯¹ç­›å‡ºæ¥çš„ç»“æœä¸æ»¡æ„ï¼Œé‚£å°±æ‰©å¤§åŠå¾„ç»§ç»­ç­›é€‰ã€‚

```
select id from positions where x0-r < x < x0+r and y0-r < y < y0+r
```

ä¸ºäº†æ»¡è¶³é«˜æ€§èƒ½çš„çŸ©å½¢åŒºåŸŸç®—æ³•ï¼Œæ•°æ®è¡¨éœ€è¦åœ¨ç»çº¬åº¦åæ ‡åŠ ä¸ŠåŒå‘å¤åˆç´¢å¼• (x, y)ï¼Œè¿™æ ·å¯ä»¥æœ€å¤§ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ã€‚

ä½†æ˜¯æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½æ¯•ç«Ÿæœ‰é™ï¼Œå¦‚æœã€Œé™„è¿‘çš„äººã€æŸ¥è¯¢è¯·æ±‚éå¸¸å¤šï¼Œåœ¨é«˜å¹¶å‘åœºåˆï¼Œè¿™å¯èƒ½å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ–¹æ¡ˆã€‚

## GeoHash ç®—æ³•

ä¸šç•Œæ¯”è¾ƒé€šç”¨çš„åœ°ç†ä½ç½®è·ç¦»æ’åºç®—æ³•æ˜¯ GeoHash ç®—æ³•ï¼ŒRedis ä¹Ÿä½¿ç”¨ GeoHash ç®—æ³•ã€‚GeoHash ç®—æ³•å°†äºŒç»´çš„ç»çº¬åº¦æ•°æ®æ˜ å°„åˆ°ä¸€ç»´çš„æ•´æ•°ï¼Œè¿™æ ·æ‰€æœ‰çš„å…ƒç´ éƒ½å°†åœ¨æŒ‚è½½åˆ°ä¸€æ¡çº¿ä¸Šï¼Œè·ç¦»é è¿‘çš„äºŒç»´åæ ‡æ˜ å°„åˆ°ä¸€ç»´åçš„ç‚¹ä¹‹é—´è·ç¦»ä¹Ÿä¼šå¾ˆæ¥è¿‘ã€‚å½“æˆ‘ä»¬æƒ³è¦è®¡ç®—ã€Œé™„è¿‘çš„äººæ—¶ã€ï¼Œé¦–å…ˆå°†ç›®æ ‡ä½ç½®æ˜ å°„åˆ°è¿™æ¡çº¿ä¸Šï¼Œç„¶ååœ¨è¿™ä¸ªä¸€ç»´çš„çº¿ä¸Šè·å–é™„è¿‘çš„ç‚¹å°±è¡Œäº†ã€‚

é‚£è¿™ä¸ªæ˜ å°„ç®—æ³•å…·ä½“æ˜¯æ€æ ·çš„å‘¢ï¼Ÿå®ƒå°†æ•´ä¸ªåœ°çƒçœ‹æˆä¸€ä¸ªäºŒç»´å¹³é¢ï¼Œç„¶ååˆ’åˆ†æˆäº†ä¸€ç³»åˆ—æ­£æ–¹å½¢çš„æ–¹æ ¼ï¼Œå°±å¥½æ¯”å›´æ£‹æ£‹ç›˜ã€‚æ‰€æœ‰çš„åœ°å›¾å…ƒç´ åæ ‡éƒ½å°†æ”¾ç½®äºå”¯ä¸€çš„æ–¹æ ¼ä¸­ã€‚æ–¹æ ¼è¶Šå°ï¼Œåæ ‡è¶Šç²¾ç¡®ã€‚ç„¶åå¯¹è¿™äº›æ–¹æ ¼è¿›è¡Œæ•´æ•°ç¼–ç ï¼Œè¶Šæ˜¯é è¿‘çš„æ–¹æ ¼ç¼–ç è¶Šæ˜¯æ¥è¿‘ã€‚é‚£å¦‚ä½•ç¼–ç å‘¢ï¼Ÿä¸€ä¸ªæœ€ç®€å•çš„æ–¹æ¡ˆå°±æ˜¯åˆ‡è›‹ç³•æ³•ã€‚è®¾æƒ³ä¸€ä¸ªæ­£æ–¹å½¢çš„è›‹ç³•æ‘†åœ¨ä½ é¢å‰ï¼ŒäºŒåˆ€ä¸‹å»å‡åˆ†åˆ†æˆå››å—å°æ­£æ–¹å½¢ï¼Œè¿™å››ä¸ªå°æ­£æ–¹å½¢å¯ä»¥åˆ†åˆ«æ ‡è®°ä¸º 00,01,10,11 å››ä¸ªäºŒè¿›åˆ¶æ•´æ•°ã€‚ç„¶åå¯¹æ¯ä¸€ä¸ªå°æ­£æ–¹å½¢ç»§ç»­ç”¨äºŒåˆ€æ³•åˆ‡å‰²ä¸€ä¸‹ï¼Œè¿™æ—¶æ¯ä¸ªå°å°æ­£æ–¹å½¢å°±å¯ä»¥ä½¿ç”¨ 4bit çš„äºŒè¿›åˆ¶æ•´æ•°äºˆä»¥è¡¨ç¤ºã€‚ç„¶åç»§ç»­åˆ‡ä¸‹å»ï¼Œæ­£æ–¹å½¢å°±ä¼šè¶Šæ¥è¶Šå°ï¼ŒäºŒè¿›åˆ¶æ•´æ•°ä¹Ÿä¼šè¶Šæ¥è¶Šé•¿ï¼Œç²¾ç¡®åº¦å°±ä¼šè¶Šæ¥è¶Šé«˜ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/4/1646397a223e2019?w=400&h=400&f=gif&s=172282)

ä¸Šé¢çš„ä¾‹å­ä¸­ä½¿ç”¨çš„æ˜¯äºŒåˆ€æ³•ï¼ŒçœŸå®ç®—æ³•ä¸­è¿˜ä¼šæœ‰å¾ˆå¤šå…¶å®ƒåˆ€æ³•ï¼Œæœ€ç»ˆç¼–ç å‡ºæ¥çš„æ•´æ•°æ•°å­—ä¹Ÿéƒ½ä¸ä¸€æ ·ã€‚

ç¼–ç ä¹‹åï¼Œæ¯ä¸ªåœ°å›¾å…ƒç´ çš„åæ ‡éƒ½å°†å˜æˆä¸€ä¸ªæ•´æ•°ï¼Œé€šè¿‡è¿™ä¸ªæ•´æ•°å¯ä»¥è¿˜åŸå‡ºå…ƒç´ çš„åæ ‡ï¼Œæ•´æ•°è¶Šé•¿ï¼Œè¿˜åŸå‡ºæ¥çš„åæ ‡å€¼çš„æŸå¤±ç¨‹åº¦å°±è¶Šå°ã€‚å¯¹äºã€Œé™„è¿‘çš„äººã€è¿™ä¸ªåŠŸèƒ½è€Œè¨€ï¼ŒæŸå¤±çš„ä¸€ç‚¹ç²¾ç¡®åº¦å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚

GeoHash ç®—æ³•ä¼šç»§ç»­å¯¹è¿™ä¸ªæ•´æ•°åšä¸€æ¬¡ base32 ç¼–ç  (0-9,a-z å»æ‰ a,i,l,o å››ä¸ªå­—æ¯) å˜æˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚åœ¨ Redis é‡Œé¢ï¼Œç»çº¬åº¦ä½¿ç”¨ 52 ä½çš„æ•´æ•°è¿›è¡Œç¼–ç ï¼Œæ”¾è¿›äº† zset é‡Œé¢ï¼Œzset çš„ value æ˜¯å…ƒç´ çš„ keyï¼Œscore æ˜¯ GeoHash çš„ 52 ä½æ•´æ•°å€¼ã€‚zset çš„ score è™½ç„¶æ˜¯æµ®ç‚¹æ•°ï¼Œä½†æ˜¯å¯¹äº 52 ä½çš„æ•´æ•°å€¼ï¼Œå®ƒå¯ä»¥æ— æŸå­˜å‚¨ã€‚

åœ¨ä½¿ç”¨ Redis è¿›è¡Œ Geo æŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬è¦æ—¶åˆ»æƒ³åˆ°å®ƒçš„å†…éƒ¨ç»“æ„å®é™…ä¸Šåªæ˜¯ä¸€ä¸ª zset(skiplist)ã€‚é€šè¿‡ zset çš„ score æ’åºå°±å¯ä»¥å¾—åˆ°åæ ‡é™„è¿‘çš„å…¶å®ƒå…ƒç´  (å®é™…æƒ…å†µè¦å¤æ‚ä¸€äº›ï¼Œä¸è¿‡è¿™æ ·ç†è§£è¶³å¤Ÿäº†)ï¼Œé€šè¿‡å°† score è¿˜åŸæˆåæ ‡å€¼å°±å¯ä»¥å¾—åˆ°å…ƒç´ çš„åŸå§‹åæ ‡ã€‚

## Redis çš„ Geo æŒ‡ä»¤åŸºæœ¬ä½¿ç”¨

Redis æä¾›çš„ Geo æŒ‡ä»¤åªæœ‰ 6 ä¸ªï¼Œè¯»è€…ä»¬ç¬é—´å°±å¯ä»¥æŒæ¡ã€‚ä½¿ç”¨æ—¶ï¼Œè¯»è€…åŠ¡å¿…å†æ¬¡æƒ³èµ·ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæ™®é€šçš„ zset ç»“æ„ã€‚


![](https://user-gold-cdn.xitu.io/2018/7/4/1646429f124a8aac?w=484&h=247&f=png&s=21537)

**å¢åŠ ** 

geoadd æŒ‡ä»¤æºå¸¦é›†åˆåç§°ä»¥åŠå¤šä¸ªç»çº¬åº¦åç§°ä¸‰å…ƒç»„ï¼Œæ³¨æ„è¿™é‡Œå¯ä»¥åŠ å…¥å¤šä¸ªä¸‰å…ƒç»„
```
127.0.0.1:6379> geoadd company 116.48105 39.996794 juejin
(integer) 1
127.0.0.1:6379> geoadd company 116.514203 39.905409 ireader
(integer) 1
127.0.0.1:6379> geoadd company 116.489033 40.007669 meituan
(integer) 1
127.0.0.1:6379> geoadd company 116.562108 39.787602 jd 116.334255 40.027400 xiaomi
(integer) 2
```
ä¹Ÿè®¸ä½ ä¼šé—®ä¸ºä»€ä¹ˆ Redis æ²¡æœ‰æä¾› geo åˆ é™¤æŒ‡ä»¤ï¼Ÿå‰é¢æˆ‘ä»¬æåˆ° geo å­˜å‚¨ç»“æ„ä¸Šä½¿ç”¨çš„æ˜¯ zsetï¼Œæ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ zset ç›¸å…³çš„æŒ‡ä»¤æ¥æ“ä½œ geo æ•°æ®ï¼Œæ‰€ä»¥åˆ é™¤æŒ‡ä»¤å¯ä»¥ç›´æ¥ä½¿ç”¨ zrem æŒ‡ä»¤å³å¯ã€‚

**è·ç¦»** 

geodist æŒ‡ä»¤å¯ä»¥ç”¨æ¥è®¡ç®—ä¸¤ä¸ªå…ƒç´ ä¹‹é—´çš„è·ç¦»ï¼Œæºå¸¦é›†åˆåç§°ã€2 ä¸ªåç§°å’Œè·ç¦»å•ä½ã€‚
```
127.0.0.1:6379> geodist company juejin ireader km
"10.5501"
127.0.0.1:6379> geodist company juejin meituan km
"1.3878"
127.0.0.1:6379> geodist company juejin jd km
"24.2739"
127.0.0.1:6379> geodist company juejin xiaomi km
"12.9606"
127.0.0.1:6379> geodist company juejin juejin km
"0.0000"
```
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ˜é‡‘ç¦»ç¾å›¢æœ€è¿‘ï¼Œå› ä¸ºå®ƒä»¬éƒ½åœ¨æœ›äº¬ã€‚è·ç¦»å•ä½å¯ä»¥æ˜¯ mã€kmã€mlã€ftï¼Œåˆ†åˆ«ä»£è¡¨ç±³ã€åƒç±³ã€è‹±é‡Œå’Œå°ºã€‚

**è·å–å…ƒç´ ä½ç½®** 

geopos æŒ‡ä»¤å¯ä»¥è·å–é›†åˆä¸­ä»»æ„å…ƒç´ çš„ç»çº¬åº¦åæ ‡ï¼Œå¯ä»¥ä¸€æ¬¡è·å–å¤šä¸ªã€‚

```
127.0.0.1:6379> geopos company juejin
1) 1) "116.48104995489120483"
   2) "39.99679348858259686"
127.0.0.1:6379> geopos company ireader
1) 1) "116.5142020583152771"
   2) "39.90540918662494363"
127.0.0.1:6379> geopos company juejin ireader
1) 1) "116.48104995489120483"
   2) "39.99679348858259686"
2) 1) "116.5142020583152771"
   2) "39.90540918662494363"
```
æˆ‘ä»¬è§‚å¯Ÿåˆ°è·å–çš„ç»çº¬åº¦åæ ‡å’Œ geoadd è¿›å»çš„åæ ‡æœ‰è½»å¾®çš„è¯¯å·®ï¼ŒåŸå› æ˜¯ geohash å¯¹äºŒç»´åæ ‡è¿›è¡Œçš„ä¸€ç»´æ˜ å°„æ˜¯æœ‰æŸçš„ï¼Œé€šè¿‡æ˜ å°„å†è¿˜åŸå›æ¥çš„å€¼ä¼šå‡ºç°è¾ƒå°çš„å·®åˆ«ã€‚å¯¹äºã€Œé™„è¿‘çš„äººã€è¿™ç§åŠŸèƒ½æ¥è¯´ï¼Œè¿™ç‚¹è¯¯å·®æ ¹æœ¬ä¸æ˜¯äº‹ã€‚

**è·å–å…ƒç´ çš„ hash å€¼** 

geohash å¯ä»¥è·å–å…ƒç´ çš„ç»çº¬åº¦ç¼–ç å­—ç¬¦ä¸²ï¼Œä¸Šé¢å·²ç»æåˆ°ï¼Œå®ƒæ˜¯ base32 ç¼–ç ã€‚
ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªç¼–ç å€¼å» http://geohash.org/${hash}ä¸­è¿›è¡Œç›´æ¥å®šä½ï¼Œå®ƒæ˜¯ geohash çš„æ ‡å‡†ç¼–ç å€¼ã€‚
```
127.0.0.1:6379> geohash company ireader
1) "wx4g52e1ce0"
127.0.0.1:6379> geohash company juejin
1) "wx4gd94yjn0"
```
è®©æˆ‘ä»¬æ‰“å¼€åœ°å€ http://geohash.org/wx4g52e1ce0ï¼Œè§‚å¯Ÿåœ°å›¾æŒ‡å‘çš„ä½ç½®æ˜¯å¦æ­£ç¡®ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/4/16463ea81a176326?w=716&h=693&f=png&s=307562)

å¾ˆå¥½ï¼Œå°±æ˜¯è¿™ä¸ªä½ç½®ï¼Œéå¸¸å‡†ç¡®ã€‚

**é™„è¿‘çš„å…¬å¸**

georadiusbymember æŒ‡ä»¤æ˜¯æœ€ä¸ºå…³é”®çš„æŒ‡ä»¤ï¼Œå®ƒå¯ä»¥ç”¨æ¥æŸ¥è¯¢æŒ‡å®šå…ƒç´ é™„è¿‘çš„å…¶å®ƒå…ƒç´ ï¼Œå®ƒçš„å‚æ•°éå¸¸å¤æ‚ã€‚
```
# èŒƒå›´ 20 å…¬é‡Œä»¥å†…æœ€å¤š 3 ä¸ªå…ƒç´ æŒ‰è·ç¦»æ­£æ’ï¼Œå®ƒä¸ä¼šæ’é™¤è‡ªèº«
127.0.0.1:6379> georadiusbymember company ireader 20 km count 3 asc
1) "ireader"
2) "juejin"
3) "meituan"
# èŒƒå›´ 20 å…¬é‡Œä»¥å†…æœ€å¤š 3 ä¸ªå…ƒç´ æŒ‰è·ç¦»å€’æ’
127.0.0.1:6379> georadiusbymember company ireader 20 km count 3 desc
1) "jd"
2) "meituan"
3) "juejin"
# ä¸‰ä¸ªå¯é€‰å‚æ•° withcoord withdist withhash ç”¨æ¥æºå¸¦é™„åŠ å‚æ•°
# withdist å¾ˆæœ‰ç”¨ï¼Œå®ƒå¯ä»¥ç”¨æ¥æ˜¾ç¤ºè·ç¦»
127.0.0.1:6379> georadiusbymember company ireader 20 km withcoord withdist withhash count 3 asc
1) 1) "ireader"
   2) "0.0000"
   3) (integer) 4069886008361398
   4) 1) "116.5142020583152771"
      2) "39.90540918662494363"
2) 1) "juejin"
   2) "10.5501"
   3) (integer) 4069887154388167
   4) 1) "116.48104995489120483"
      2) "39.99679348858259686"
3) 1) "meituan"
   2) "11.5748"
   3) (integer) 4069887179083478
   4) 1) "116.48903220891952515"
      2) "40.00766997707732031"
```

é™¤äº† georadiusbymember æŒ‡ä»¤æ ¹æ®å…ƒç´ æŸ¥è¯¢é™„è¿‘çš„å…ƒç´ ï¼ŒRedis è¿˜æä¾›äº†æ ¹æ®åæ ‡å€¼æ¥æŸ¥è¯¢é™„è¿‘çš„å…ƒç´ ï¼Œè¿™ä¸ªæŒ‡ä»¤æ›´åŠ æœ‰ç”¨ï¼Œå®ƒå¯ä»¥æ ¹æ®ç”¨æˆ·çš„å®šä½æ¥è®¡ç®—ã€Œé™„è¿‘çš„è½¦ã€ï¼Œã€Œé™„è¿‘çš„é¤é¦†ã€ç­‰ã€‚å®ƒçš„å‚æ•°å’Œ georadiusbymember åŸºæœ¬ä¸€è‡´ï¼Œé™¤äº†å°†ç›®æ ‡å…ƒç´ æ”¹æˆç»çº¬åº¦åæ ‡å€¼ã€‚
```
127.0.0.1:6379> georadius company 116.514202 39.905409 20 km withdist count 3 asc
1) 1) "ireader"
   2) "0.0000"
2) 1) "juejin"
   2) "10.5501"
3) 1) "meituan"
   2) "11.5748"
```

## å°ç»“ & æ³¨æ„äº‹é¡¹

åœ¨ä¸€ä¸ªåœ°å›¾åº”ç”¨ä¸­ï¼Œè½¦çš„æ•°æ®ã€é¤é¦†çš„æ•°æ®ã€äººçš„æ•°æ®å¯èƒ½ä¼šæœ‰ç™¾ä¸‡åƒä¸‡æ¡ï¼Œå¦‚æœä½¿ç”¨ Redis çš„ Geo æ•°æ®ç»“æ„ï¼Œå®ƒä»¬å°†å…¨éƒ¨æ”¾åœ¨ä¸€ä¸ª zset é›†åˆä¸­ã€‚åœ¨ Redis çš„é›†ç¾¤ç¯å¢ƒä¸­ï¼Œé›†åˆå¯èƒ½ä¼šä»ä¸€ä¸ªèŠ‚ç‚¹è¿ç§»åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœå•ä¸ª key çš„æ•°æ®è¿‡å¤§ï¼Œä¼šå¯¹é›†ç¾¤çš„è¿ç§»å·¥ä½œé€ æˆè¾ƒå¤§çš„å½±å“ï¼Œåœ¨é›†ç¾¤ç¯å¢ƒä¸­å•ä¸ª key å¯¹åº”çš„æ•°æ®é‡ä¸å®œè¶…è¿‡ 1Mï¼Œå¦åˆ™ä¼šå¯¼è‡´é›†ç¾¤è¿ç§»å‡ºç°å¡é¡¿ç°è±¡ï¼Œå½±å“çº¿ä¸ŠæœåŠ¡çš„æ­£å¸¸è¿è¡Œã€‚

æ‰€ä»¥ï¼Œè¿™é‡Œå»ºè®® Geo çš„æ•°æ®ä½¿ç”¨å•ç‹¬çš„ Redis å®ä¾‹éƒ¨ç½²ï¼Œä¸ä½¿ç”¨é›†ç¾¤ç¯å¢ƒã€‚

å¦‚æœæ•°æ®é‡è¿‡äº¿ç”šè‡³æ›´å¤§ï¼Œå°±éœ€è¦å¯¹ Geo æ•°æ®è¿›è¡Œæ‹†åˆ†ï¼ŒæŒ‰å›½å®¶æ‹†åˆ†ã€æŒ‰çœæ‹†åˆ†ï¼ŒæŒ‰å¸‚æ‹†åˆ†ï¼Œåœ¨äººå£ç‰¹å¤§åŸå¸‚ç”šè‡³å¯ä»¥æŒ‰åŒºæ‹†åˆ†ã€‚è¿™æ ·å°±å¯ä»¥æ˜¾è‘—é™ä½å•ä¸ª zset é›†åˆçš„å¤§å°ã€‚
# åº”ç”¨ 9ï¼šå¤§æµ·æé’ˆ â€”â€” Scan

åœ¨å¹³æ—¶çº¿ä¸Š Redis ç»´æŠ¤å·¥ä½œä¸­ï¼Œæœ‰æ—¶å€™éœ€è¦ä» Redis å®ä¾‹æˆåƒä¸Šä¸‡çš„ key ä¸­æ‰¾å‡ºç‰¹å®šå‰ç¼€çš„ key åˆ—è¡¨æ¥æ‰‹åŠ¨å¤„ç†æ•°æ®ï¼Œå¯èƒ½æ˜¯ä¿®æ”¹å®ƒçš„å€¼ï¼Œä¹Ÿå¯èƒ½æ˜¯åˆ é™¤ keyã€‚è¿™é‡Œå°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•ä»æµ·é‡çš„ key ä¸­æ‰¾å‡ºæ»¡è¶³ç‰¹å®šå‰ç¼€çš„ key åˆ—è¡¨æ¥ï¼Ÿ

Redis æä¾›äº†ä¸€ä¸ªç®€å•æš´åŠ›çš„æŒ‡ä»¤ `keys` ç”¨æ¥åˆ—å‡ºæ‰€æœ‰æ»¡è¶³ç‰¹å®šæ­£åˆ™å­—ç¬¦ä¸²è§„åˆ™çš„ keyã€‚

```
127.0.0.1:6379> set codehole1 a
OK
127.0.0.1:6379> set codehole2 b
OK
127.0.0.1:6379> set codehole3 c
OK
127.0.0.1:6379> set code1hole a
OK
127.0.0.1:6379> set code2hole b
OK
127.0.0.1:6379> set code3hole b
OK
127.0.0.1:6379> keys *
1) "codehole1"
2) "code3hole"
3) "codehole3"
4) "code2hole"
5) "codehole2"
6) "code1hole"
127.0.0.1:6379> keys codehole*
1) "codehole1"
2) "codehole3"
3) "codehole2"
127.0.0.1:6379> keys code*hole
1) "code3hole"
2) "code2hole"
3) "code1hole"
```
è¿™ä¸ªæŒ‡ä»¤ä½¿ç”¨éå¸¸ç®€å•ï¼Œæä¾›ä¸€ä¸ªç®€å•çš„æ­£åˆ™å­—ç¬¦ä¸²å³å¯ï¼Œä½†æ˜¯æœ‰å¾ˆæ˜æ˜¾çš„ä¸¤ä¸ª**ç¼ºç‚¹**ã€‚
1. æ²¡æœ‰ offsetã€limit å‚æ•°ï¼Œä¸€æ¬¡æ€§åå‡ºæ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„ keyï¼Œä¸‡ä¸€å®ä¾‹ä¸­æœ‰å‡ ç™¾ w ä¸ª key æ»¡è¶³æ¡ä»¶ï¼Œå½“ä½ çœ‹åˆ°æ»¡å±çš„å­—ç¬¦ä¸²åˆ·çš„æ²¡æœ‰å°½å¤´æ—¶ï¼Œä½ å°±çŸ¥é“éš¾å—äº†ã€‚
2. keys ç®—æ³•æ˜¯éå†ç®—æ³•ï¼Œå¤æ‚åº¦æ˜¯ O(n)ï¼Œå¦‚æœå®ä¾‹ä¸­æœ‰åƒä¸‡çº§ä»¥ä¸Šçš„ keyï¼Œè¿™ä¸ªæŒ‡ä»¤å°±ä¼šå¯¼è‡´ Redis æœåŠ¡å¡é¡¿ï¼Œæ‰€æœ‰è¯»å†™ Redis çš„å…¶å®ƒçš„æŒ‡ä»¤éƒ½ä¼šè¢«å»¶åç”šè‡³ä¼šè¶…æ—¶æŠ¥é”™ï¼Œå› ä¸º Redis æ˜¯å•çº¿ç¨‹ç¨‹åºï¼Œé¡ºåºæ‰§è¡Œæ‰€æœ‰æŒ‡ä»¤ï¼Œå…¶å®ƒæŒ‡ä»¤å¿…é¡»ç­‰åˆ°å½“å‰çš„ keys æŒ‡ä»¤æ‰§è¡Œå®Œäº†æ‰å¯ä»¥ç»§ç»­ã€‚

é¢å¯¹è¿™ä¸¤ä¸ªæ˜¾è‘—çš„ç¼ºç‚¹è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

Redis ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒåœ¨ 2.8 ç‰ˆæœ¬ä¸­åŠ å…¥äº†å¤§æµ·æé’ˆçš„æŒ‡ä»¤â€”â€”`scan`ã€‚`scan` ç›¸æ¯” `keys` å…·å¤‡æœ‰ä»¥ä¸‹ç‰¹ç‚¹:

1. å¤æ‚åº¦è™½ç„¶ä¹Ÿæ˜¯ O(n)ï¼Œä½†æ˜¯å®ƒæ˜¯é€šè¿‡æ¸¸æ ‡åˆ†æ­¥è¿›è¡Œçš„ï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹;
2. æä¾› limit å‚æ•°ï¼Œå¯ä»¥æ§åˆ¶æ¯æ¬¡è¿”å›ç»“æœçš„æœ€å¤§æ¡æ•°ï¼Œlimit åªæ˜¯ä¸€ä¸ª hintï¼Œè¿”å›çš„ç»“æœå¯å¤šå¯å°‘;
3. åŒ keys ä¸€æ ·ï¼Œå®ƒä¹Ÿæä¾›æ¨¡å¼åŒ¹é…åŠŸèƒ½;
4. æœåŠ¡å™¨ä¸éœ€è¦ä¸ºæ¸¸æ ‡ä¿å­˜çŠ¶æ€ï¼Œæ¸¸æ ‡çš„å”¯ä¸€çŠ¶æ€å°±æ˜¯ scan è¿”å›ç»™å®¢æˆ·ç«¯çš„æ¸¸æ ‡æ•´æ•°;
5. è¿”å›çš„ç»“æœå¯èƒ½ä¼šæœ‰é‡å¤ï¼Œéœ€è¦å®¢æˆ·ç«¯å»é‡å¤ï¼Œè¿™ç‚¹éå¸¸é‡è¦;
6. éå†çš„è¿‡ç¨‹ä¸­å¦‚æœæœ‰æ•°æ®ä¿®æ”¹ï¼Œæ”¹åŠ¨åçš„æ•°æ®èƒ½ä¸èƒ½éå†åˆ°æ˜¯ä¸ç¡®å®šçš„;
7. å•æ¬¡è¿”å›çš„ç»“æœæ˜¯ç©ºçš„å¹¶ä¸æ„å‘³ç€éå†ç»“æŸï¼Œè€Œè¦çœ‹è¿”å›çš„æ¸¸æ ‡å€¼æ˜¯å¦ä¸ºé›¶;

## scan åŸºç¡€ä½¿ç”¨
åœ¨ä½¿ç”¨ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å¾€ Redis é‡Œæ’å…¥ 10000 æ¡æ•°æ®æ¥è¿›è¡Œæµ‹è¯•

```
import redis

client = redis.StrictRedis()
for i in range(10000):
    client.set("key%d" % i, i)
```
å¥½ï¼ŒRedis ä¸­ç°åœ¨æœ‰äº† 10000 æ¡æ•°æ®ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ‰¾å‡ºä»¥ key99 å¼€å¤´ key åˆ—è¡¨ã€‚

scan å‚æ•°æä¾›äº†ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯ `cursor æ•´æ•°å€¼`ï¼Œç¬¬äºŒä¸ªæ˜¯ `key çš„æ­£åˆ™æ¨¡å¼`ï¼Œç¬¬ä¸‰ä¸ªæ˜¯`éå†çš„ limit hint`ã€‚ç¬¬ä¸€æ¬¡éå†æ—¶ï¼Œcursor å€¼ä¸º 0ï¼Œç„¶åå°†è¿”å›ç»“æœä¸­ç¬¬ä¸€ä¸ªæ•´æ•°å€¼ä½œä¸ºä¸‹ä¸€æ¬¡éå†çš„ cursorã€‚ä¸€ç›´éå†åˆ°è¿”å›çš„ cursor å€¼ä¸º 0 æ—¶ç»“æŸã€‚
```
127.0.0.1:6379> scan 0 match key99* count 1000
1) "13976"
2)  1) "key9911"
    2) "key9974"
    3) "key9994"
    4) "key9910"
    5) "key9907"
    6) "key9989"
    7) "key9971"
    8) "key99"
    9) "key9966"
   10) "key992"
   11) "key9903"
   12) "key9905"
127.0.0.1:6379> scan 13976 match key99* count 1000
1) "1996"
2)  1) "key9982"
    2) "key9997"
    3) "key9963"
    4) "key996"
    5) "key9912"
    6) "key9999"
    7) "key9921"
    8) "key994"
    9) "key9956"
   10) "key9919"
127.0.0.1:6379> scan 1996 match key99* count 1000
1) "12594"
2) 1) "key9939"
   2) "key9941"
   3) "key9967"
   4) "key9938"
   5) "key9906"
   6) "key999"
   7) "key9909"
   8) "key9933"
   9) "key9992"
......
127.0.0.1:6379> scan 11687 match key99* count 1000
1) "0"
2)  1) "key9969"
    2) "key998"
    3) "key9986"
    4) "key9968"
    5) "key9965"
    6) "key9990"
    7) "key9915"
    8) "key9928"
    9) "key9908"
   10) "key9929"
   11) "key9944"
```
ä»ä¸Šé¢çš„è¿‡ç¨‹å¯ä»¥çœ‹åˆ°è™½ç„¶æä¾›çš„ limit æ˜¯ 1000ï¼Œä½†æ˜¯è¿”å›çš„ç»“æœåªæœ‰ 10 ä¸ªå·¦å³ã€‚å› ä¸ºè¿™ä¸ª limit ä¸æ˜¯é™å®šè¿”å›ç»“æœçš„æ•°é‡ï¼Œè€Œæ˜¯é™å®šæœåŠ¡å™¨å•æ¬¡éå†çš„å­—å…¸æ§½ä½æ•°é‡(çº¦ç­‰äº)ã€‚å¦‚æœå°† limit è®¾ç½®ä¸º 10ï¼Œä½ ä¼šå‘ç°è¿”å›ç»“æœæ˜¯ç©ºçš„ï¼Œä½†æ˜¯æ¸¸æ ‡å€¼ä¸ä¸ºé›¶ï¼Œæ„å‘³ç€éå†è¿˜æ²¡ç»“æŸã€‚

```
127.0.0.1:6379> scan 0 match key99* count 10
1) "3072"
2) (empty list or set)
```

## å­—å…¸çš„ç»“æ„
åœ¨ Redis ä¸­æ‰€æœ‰çš„ key éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªå¾ˆå¤§çš„å­—å…¸ä¸­ï¼Œè¿™ä¸ªå­—å…¸çš„ç»“æ„å’Œ Java ä¸­çš„ HashMap ä¸€æ ·ï¼Œæ˜¯ä¸€ç»´æ•°ç»„ + äºŒç»´é“¾è¡¨ç»“æ„ï¼Œç¬¬ä¸€ç»´æ•°ç»„çš„å¤§å°æ€»æ˜¯ 2^n(n>=0)ï¼Œæ‰©å®¹ä¸€æ¬¡æ•°ç»„å¤§å°ç©ºé—´åŠ å€ï¼Œä¹Ÿå°±æ˜¯ n++ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/5/164695b9f06c757e?w=579&h=277&f=png&s=11839)

scan æŒ‡ä»¤è¿”å›çš„æ¸¸æ ‡å°±æ˜¯ç¬¬ä¸€ç»´æ•°ç»„çš„ä½ç½®ç´¢å¼•ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªä½ç½®ç´¢å¼•ç§°ä¸ºæ§½ (slot)ã€‚å¦‚æœä¸è€ƒè™‘å­—å…¸çš„æ‰©å®¹ç¼©å®¹ï¼Œç›´æ¥æŒ‰æ•°ç»„ä¸‹æ ‡æŒ¨ä¸ªéå†å°±è¡Œäº†ã€‚limit å‚æ•°å°±è¡¨ç¤ºéœ€è¦éå†çš„æ§½ä½æ•°ï¼Œä¹‹æ‰€ä»¥è¿”å›çš„ç»“æœå¯èƒ½å¤šå¯èƒ½å°‘ï¼Œæ˜¯å› ä¸ºä¸æ˜¯æ‰€æœ‰çš„æ§½ä½ä¸Šéƒ½ä¼šæŒ‚æ¥é“¾è¡¨ï¼Œæœ‰äº›æ§½ä½å¯èƒ½æ˜¯ç©ºçš„ï¼Œè¿˜æœ‰äº›æ§½ä½ä¸ŠæŒ‚æ¥çš„é“¾è¡¨ä¸Šçš„å…ƒç´ å¯èƒ½ä¼šæœ‰å¤šä¸ªã€‚æ¯ä¸€æ¬¡éå†éƒ½ä¼šå°† limit æ•°é‡çš„æ§½ä½ä¸ŠæŒ‚æ¥çš„æ‰€æœ‰é“¾è¡¨å…ƒç´ è¿›è¡Œæ¨¡å¼åŒ¹é…è¿‡æ»¤åï¼Œä¸€æ¬¡æ€§è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

## scan éå†é¡ºåº
scan çš„éå†é¡ºåºéå¸¸ç‰¹åˆ«ã€‚å®ƒä¸æ˜¯ä»ç¬¬ä¸€ç»´æ•°ç»„çš„ç¬¬ 0 ä½ä¸€ç›´éå†åˆ°æœ«å°¾ï¼Œè€Œæ˜¯é‡‡ç”¨äº†é«˜ä½è¿›ä½åŠ æ³•æ¥éå†ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨è¿™æ ·ç‰¹æ®Šçš„æ–¹å¼è¿›è¡Œéå†ï¼Œæ˜¯è€ƒè™‘åˆ°å­—å…¸çš„æ‰©å®¹å’Œç¼©å®¹æ—¶é¿å…æ§½ä½çš„éå†é‡å¤å’Œé—æ¼ã€‚

é¦–å…ˆæˆ‘ä»¬ç”¨åŠ¨ç”»æ¼”ç¤ºä¸€ä¸‹æ™®é€šåŠ æ³•å’Œé«˜ä½è¿›ä½åŠ æ³•çš„åŒºåˆ«ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/5/16469760d12e0cbd?w=400&h=200&f=gif&s=70783)

ä»åŠ¨ç”»ä¸­å¯ä»¥çœ‹å‡ºé«˜ä½è¿›ä½æ³•ä»å·¦è¾¹åŠ ï¼Œè¿›ä½å¾€å³è¾¹ç§»åŠ¨ï¼ŒåŒæ™®é€šåŠ æ³•æ­£å¥½ç›¸åã€‚ä½†æ˜¯æœ€ç»ˆå®ƒä»¬éƒ½ä¼šéå†æ‰€æœ‰çš„æ§½ä½å¹¶ä¸”æ²¡æœ‰é‡å¤ã€‚

## å­—å…¸æ‰©å®¹
Java ä¸­çš„ HashMap æœ‰æ‰©å®¹çš„æ¦‚å¿µï¼Œå½“ loadFactor è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œéœ€è¦é‡æ–°åˆ†é…ä¸€ä¸ªæ–°çš„ 2 å€å¤§å°çš„æ•°ç»„ï¼Œç„¶åå°†æ‰€æœ‰çš„å…ƒç´ å…¨éƒ¨ rehash æŒ‚åˆ°æ–°çš„æ•°ç»„ä¸‹é¢ã€‚rehash å°±æ˜¯å°†å…ƒç´ çš„ hash å€¼å¯¹æ•°ç»„é•¿åº¦è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œå› ä¸ºé•¿åº¦å˜äº†ï¼Œæ‰€ä»¥æ¯ä¸ªå…ƒç´ æŒ‚æ¥çš„æ§½ä½å¯èƒ½ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ã€‚åˆå› ä¸ºæ•°ç»„çš„é•¿åº¦æ˜¯ 2^n æ¬¡æ–¹ï¼Œæ‰€ä»¥å–æ¨¡è¿ç®—ç­‰ä»·äºä½ä¸æ“ä½œã€‚

```
a mod 8 = a & (8-1) = a & 7
a mod 16 = a & (16-1) = a & 15
a mod 32 = a & (32-1) = a & 31
```
è¿™é‡Œçš„ 7, 15, 31 ç§°ä¹‹ä¸ºå­—å…¸çš„ mask å€¼ï¼Œmask çš„ä½œç”¨å°±æ˜¯ä¿ç•™ hash å€¼çš„ä½ä½ï¼Œé«˜ä½éƒ½è¢«è®¾ç½®ä¸º 0ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ rehash å‰åå…ƒç´ æ§½ä½çš„å˜åŒ–ã€‚

å‡è®¾å½“å‰çš„å­—å…¸çš„æ•°ç»„é•¿åº¦ç”± 8 ä½æ‰©å®¹åˆ° 16 ä½ï¼Œé‚£ä¹ˆ 3 å·æ§½ä½ 011 å°†ä¼šè¢« rehash åˆ° 3 å·æ§½ä½å’Œ 11 å·æ§½ä½ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥æ§½ä½é“¾è¡¨ä¸­å¤§çº¦æœ‰ä¸€åŠçš„å…ƒç´ è¿˜æ˜¯ 3 å·æ§½ä½ï¼Œå…¶å®ƒçš„å…ƒç´ ä¼šæ”¾åˆ° 11 å·æ§½ä½ï¼Œ11 è¿™ä¸ªæ•°å­—çš„äºŒè¿›åˆ¶æ˜¯ 1011ï¼Œå°±æ˜¯å¯¹ 3 çš„äºŒè¿›åˆ¶ 011 å¢åŠ äº†ä¸€ä¸ªé«˜ä½ 1ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/5/164698cd0d3eec33?w=534&h=268&f=png&s=12978)

æŠ½è±¡ä¸€ç‚¹è¯´ï¼Œå‡è®¾å¼€å§‹æ§½ä½çš„äºŒè¿›åˆ¶æ•°æ˜¯ xxxï¼Œé‚£ä¹ˆè¯¥æ§½ä½ä¸­çš„å…ƒç´ å°†è¢« rehash åˆ° 0xxx å’Œ 1xxx(xxx+8) ä¸­ã€‚
å¦‚æœå­—å…¸é•¿åº¦ç”± 16 ä½æ‰©å®¹åˆ° 32 ä½ï¼Œé‚£ä¹ˆå¯¹äºäºŒè¿›åˆ¶æ§½ä½ xxxx ä¸­çš„å…ƒç´ å°†è¢« rehash åˆ° 0xxxx å’Œ 1xxxx(xxxx+16) ä¸­ã€‚

## å¯¹æ¯”æ‰©å®¹ç¼©å®¹å‰åçš„éå†é¡ºåº

![](https://user-gold-cdn.xitu.io/2018/7/5/164699dae277cc19?w=1428&h=310&f=png&s=48575)

è§‚å¯Ÿè¿™å¼ å›¾ï¼Œæˆ‘ä»¬å‘ç°é‡‡ç”¨é«˜ä½è¿›ä½åŠ æ³•çš„éå†é¡ºåºï¼Œrehash åçš„æ§½ä½åœ¨éå†é¡ºåºä¸Šæ˜¯ç›¸é‚»çš„ã€‚

å‡è®¾å½“å‰è¦å³å°†éå† 110 è¿™ä¸ªä½ç½® (æ©™è‰²)ï¼Œé‚£ä¹ˆæ‰©å®¹åï¼Œå½“å‰æ§½ä½ä¸Šæ‰€æœ‰çš„å…ƒç´ å¯¹åº”çš„æ–°æ§½ä½æ˜¯ 0110 å’Œ 1110(æ·±ç»¿è‰²)ï¼Œä¹Ÿå°±æ˜¯åœ¨æ§½ä½çš„äºŒè¿›åˆ¶æ•°å¢åŠ ä¸€ä¸ªé«˜ä½ 0 æˆ– 1ã€‚è¿™æ—¶æˆ‘ä»¬å¯ä»¥ç›´æ¥ä» 0110 è¿™ä¸ªæ§½ä½å¼€å§‹å¾€åç»§ç»­éå†ï¼Œ0110 æ§½ä½ä¹‹å‰çš„æ‰€æœ‰æ§½ä½éƒ½æ˜¯å·²ç»éå†è¿‡çš„ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…æ‰©å®¹åå¯¹å·²ç»éå†è¿‡çš„æ§½ä½è¿›è¡Œé‡å¤éå†ã€‚

å†è€ƒè™‘ç¼©å®¹ï¼Œå‡è®¾å½“å‰å³å°†éå† 110 è¿™ä¸ªä½ç½® (æ©™è‰²)ï¼Œé‚£ä¹ˆç¼©å®¹åï¼Œå½“å‰æ§½ä½æ‰€æœ‰çš„å…ƒç´ å¯¹åº”çš„æ–°æ§½ä½æ˜¯ 10(æ·±ç»¿è‰²)ï¼Œä¹Ÿå°±æ˜¯å»æ‰æ§½ä½äºŒè¿›åˆ¶æœ€é«˜ä½ã€‚è¿™æ—¶æˆ‘ä»¬å¯ä»¥ç›´æ¥ä» 10 è¿™ä¸ªæ§½ä½ç»§ç»­å¾€åéå†ï¼Œ10 æ§½ä½ä¹‹å‰çš„æ‰€æœ‰æ§½ä½éƒ½æ˜¯å·²ç»éå†è¿‡çš„ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…ç¼©å®¹çš„é‡å¤éå†ã€‚ä¸è¿‡ç¼©å®¹è¿˜æ˜¯ä¸å¤ªä¸€æ ·ï¼Œå®ƒä¼šå¯¹å›¾ä¸­ 010 è¿™ä¸ªæ§½ä½ä¸Šçš„å…ƒç´ è¿›è¡Œé‡å¤éå†ï¼Œå› ä¸ºç¼©èå 10 æ§½ä½çš„å…ƒç´ æ˜¯ 010 å’Œ 110 ä¸ŠæŒ‚æ¥çš„å…ƒç´ çš„èåˆã€‚

## æ¸è¿›å¼ rehash
Java çš„ HashMap åœ¨æ‰©å®¹æ—¶ä¼šä¸€æ¬¡æ€§å°†æ—§æ•°ç»„ä¸‹æŒ‚æ¥çš„å…ƒç´ å…¨éƒ¨è½¬ç§»åˆ°æ–°æ•°ç»„ä¸‹é¢ã€‚å¦‚æœ HashMap ä¸­å…ƒç´ ç‰¹åˆ«å¤šï¼Œçº¿ç¨‹å°±ä¼šå‡ºç°å¡é¡¿ç°è±¡ã€‚Redis ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒé‡‡ç”¨**æ¸è¿›å¼ rehash**ã€‚

å®ƒä¼šåŒæ—¶ä¿ç•™æ—§æ•°ç»„å’Œæ–°æ•°ç»„ï¼Œç„¶ååœ¨å®šæ—¶ä»»åŠ¡ä¸­ä»¥åŠåç»­å¯¹ hash çš„æŒ‡ä»¤æ“ä½œä¸­æ¸æ¸åœ°å°†æ—§æ•°ç»„ä¸­æŒ‚æ¥çš„å…ƒç´ è¿ç§»åˆ°æ–°æ•°ç»„ä¸Šã€‚è¿™æ„å‘³ç€è¦æ“ä½œå¤„äº rehash ä¸­çš„å­—å…¸ï¼Œéœ€è¦åŒæ—¶è®¿é—®æ–°æ—§ä¸¤ä¸ªæ•°ç»„ç»“æ„ã€‚å¦‚æœåœ¨æ—§æ•°ç»„ä¸‹é¢æ‰¾ä¸åˆ°å…ƒç´ ï¼Œè¿˜éœ€è¦å»æ–°æ•°ç»„ä¸‹é¢å»å¯»æ‰¾ã€‚

scan ä¹Ÿéœ€è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜ï¼Œå¯¹ä¸ rehash ä¸­çš„å­—å…¸ï¼Œå®ƒéœ€è¦åŒæ—¶æ‰«ææ–°æ—§æ§½ä½ï¼Œç„¶åå°†ç»“æœèåˆåè¿”å›ç»™å®¢æˆ·ç«¯ã€‚

## æ›´å¤šçš„ scan æŒ‡ä»¤
scan æŒ‡ä»¤æ˜¯ä¸€ç³»åˆ—æŒ‡ä»¤ï¼Œé™¤äº†å¯ä»¥éå†æ‰€æœ‰çš„ key ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å¯¹æŒ‡å®šçš„å®¹å™¨é›†åˆè¿›è¡Œéå†ã€‚æ¯”å¦‚ zscan éå† zset é›†åˆå…ƒç´ ï¼Œhscan éå† hash å­—å…¸çš„å…ƒç´ ã€sscan éå† set é›†åˆçš„å…ƒç´ ã€‚

å®ƒä»¬çš„åŸç†åŒ scan éƒ½ä¼šç±»ä¼¼çš„ï¼Œå› ä¸º hash åº•å±‚å°±æ˜¯å­—å…¸ï¼Œset ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ hash(æ‰€æœ‰çš„ value æŒ‡å‘åŒä¸€ä¸ªå…ƒç´ )ï¼Œzset å†…éƒ¨ä¹Ÿä½¿ç”¨äº†å­—å…¸æ¥å­˜å‚¨æ‰€æœ‰çš„å…ƒç´ å†…å®¹ï¼Œæ‰€ä»¥è¿™é‡Œä¸å†èµ˜è¿°ã€‚

## å¤§ key æ‰«æ
æœ‰æ—¶å€™ä¼šå› ä¸ºä¸šåŠ¡äººå‘˜ä½¿ç”¨ä¸å½“ï¼Œåœ¨ Redis å®ä¾‹ä¸­ä¼šå½¢æˆå¾ˆå¤§çš„å¯¹è±¡ï¼Œæ¯”å¦‚ä¸€ä¸ªå¾ˆå¤§çš„ hashï¼Œä¸€ä¸ªå¾ˆå¤§çš„ zset è¿™éƒ½æ˜¯ç»å¸¸å‡ºç°çš„ã€‚è¿™æ ·çš„å¯¹è±¡å¯¹ Redis çš„é›†ç¾¤æ•°æ®è¿ç§»å¸¦æ¥äº†å¾ˆå¤§çš„é—®é¢˜ï¼Œå› ä¸ºåœ¨é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œå¦‚æœæŸä¸ª key å¤ªå¤§ï¼Œä¼šæ•°æ®å¯¼è‡´è¿ç§»å¡é¡¿ã€‚å¦å¤–åœ¨å†…å­˜åˆ†é…ä¸Šï¼Œå¦‚æœä¸€ä¸ª key å¤ªå¤§ï¼Œé‚£ä¹ˆå½“å®ƒéœ€è¦æ‰©å®¹æ—¶ï¼Œä¼šä¸€æ¬¡æ€§ç”³è¯·æ›´å¤§çš„ä¸€å—å†…å­˜ï¼Œè¿™ä¹Ÿä¼šå¯¼è‡´å¡é¡¿ã€‚å¦‚æœè¿™ä¸ªå¤§ key è¢«åˆ é™¤ï¼Œå†…å­˜ä¼šä¸€æ¬¡æ€§å›æ”¶ï¼Œå¡é¡¿ç°è±¡ä¼šå†ä¸€æ¬¡äº§ç”Ÿã€‚

**åœ¨å¹³æ—¶çš„ä¸šåŠ¡å¼€å‘ä¸­ï¼Œè¦å°½é‡é¿å…å¤§ key çš„äº§ç”Ÿ**ã€‚

å¦‚æœä½ è§‚å¯Ÿåˆ° Redis çš„å†…å­˜å¤§èµ·å¤§è½ï¼Œè¿™ææœ‰å¯èƒ½æ˜¯å› ä¸ºå¤§ key å¯¼è‡´çš„ï¼Œè¿™æ—¶å€™ä½ å°±éœ€è¦å®šä½å‡ºå…·ä½“æ˜¯é‚£ä¸ª keyï¼Œè¿›ä¸€æ­¥å®šä½å‡ºå…·ä½“çš„ä¸šåŠ¡æ¥æºï¼Œç„¶åå†æ”¹è¿›ç›¸å…³ä¸šåŠ¡ä»£ç è®¾è®¡ã€‚

**é‚£å¦‚ä½•å®šä½å¤§ key å‘¢ï¼Ÿ**

ä¸ºäº†é¿å…å¯¹çº¿ä¸Š Redis å¸¦æ¥å¡é¡¿ï¼Œè¿™å°±è¦ç”¨åˆ° scan æŒ‡ä»¤ï¼Œå¯¹äºæ‰«æå‡ºæ¥çš„æ¯ä¸€ä¸ª keyï¼Œä½¿ç”¨ type æŒ‡ä»¤è·å¾— key çš„ç±»å‹ï¼Œç„¶åä½¿ç”¨ç›¸åº”æ•°æ®ç»“æ„çš„ size æˆ–è€… len æ–¹æ³•æ¥å¾—åˆ°å®ƒçš„å¤§å°ï¼Œå¯¹äºæ¯ä¸€ç§ç±»å‹ï¼Œä¿ç•™å¤§å°çš„å‰ N åä½œä¸ºæ‰«æç»“æœå±•ç¤ºå‡ºæ¥ã€‚

ä¸Šé¢è¿™æ ·çš„è¿‡ç¨‹éœ€è¦ç¼–å†™è„šæœ¬ï¼Œæ¯”è¾ƒç¹çï¼Œä¸è¿‡ Redis å®˜æ–¹å·²ç»åœ¨ redis-cli æŒ‡ä»¤ä¸­æä¾›äº†è¿™æ ·çš„æ‰«æåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ‹¿æ¥å³ç”¨ã€‚
```
redis-cli -h 127.0.0.1 -p 7001 â€“-bigkeys
```
å¦‚æœä½ æ‹…å¿ƒè¿™ä¸ªæŒ‡ä»¤ä¼šå¤§å¹…æŠ¬å‡ Redis çš„ ops å¯¼è‡´çº¿ä¸ŠæŠ¥è­¦ï¼Œè¿˜å¯ä»¥å¢åŠ ä¸€ä¸ªä¼‘çœ å‚æ•°ã€‚
```
redis-cli -h 127.0.0.1 -p 7001 â€“-bigkeys -i 0.1
```
ä¸Šé¢è¿™ä¸ªæŒ‡ä»¤æ¯éš” 100 æ¡ scan æŒ‡ä»¤å°±ä¼šä¼‘çœ  0.1sï¼Œops å°±ä¸ä¼šå‰§çƒˆæŠ¬å‡ï¼Œä½†æ˜¯æ‰«æçš„æ—¶é—´ä¼šå˜é•¿ã€‚

## æ‰©å±•é˜…è¯»

æ„Ÿå…´è¶£å¯ä»¥ç»§ç»­æ·±å…¥é˜…è¯» [ç¾å›¢è¿‘æœŸä¿®å¤çš„Scançš„ä¸€ä¸ªbug](https://mp.weixin.qq.com/s/ufoLJiXE0wU4Bc7ZbE9cDQ)
# åŸç† 1ï¼šé­è¾Ÿå…¥é‡Œ â€”â€” çº¿ç¨‹ IO æ¨¡å‹

**Redis æ˜¯ä¸ªå•çº¿ç¨‹ç¨‹åº**ï¼è¿™ç‚¹å¿…é¡»é“­è®°ã€‚

ä¹Ÿè®¸ä½ ä¼šæ€€ç–‘é«˜å¹¶å‘çš„ Redis ä¸­é—´ä»¶æ€ä¹ˆå¯èƒ½æ˜¯å•çº¿ç¨‹ã€‚å¾ˆæŠ±æ­‰ï¼Œå®ƒå°±æ˜¯å•çº¿ç¨‹ï¼Œä½ çš„æ€€ç–‘æš´éœ²äº†ä½ åŸºç¡€çŸ¥è¯†çš„ä¸è¶³ã€‚è«è¦ç§ä¸èµ·å•çº¿ç¨‹ï¼Œé™¤äº† Redis ä¹‹å¤–ï¼ŒNode.js ä¹Ÿæ˜¯å•çº¿ç¨‹ï¼ŒNginx ä¹Ÿæ˜¯å•çº¿ç¨‹ï¼Œä½†æ˜¯å®ƒä»¬éƒ½æ˜¯æœåŠ¡å™¨é«˜æ€§èƒ½çš„å…¸èŒƒã€‚

**Redis å•çº¿ç¨‹ä¸ºä»€ä¹ˆè¿˜èƒ½è¿™ä¹ˆå¿«ï¼Ÿ**

å› ä¸ºå®ƒæ‰€æœ‰çš„æ•°æ®éƒ½åœ¨å†…å­˜ä¸­ï¼Œæ‰€æœ‰çš„è¿ç®—éƒ½æ˜¯å†…å­˜çº§åˆ«çš„è¿ç®—ã€‚æ­£å› ä¸º Redis æ˜¯å•çº¿ç¨‹ï¼Œæ‰€ä»¥è¦å°å¿ƒä½¿ç”¨ Redis æŒ‡ä»¤ï¼Œå¯¹äºé‚£äº›æ—¶é—´å¤æ‚åº¦ä¸º O(n) çº§åˆ«çš„æŒ‡ä»¤ï¼Œä¸€å®šè¦è°¨æ…ä½¿ç”¨ï¼Œä¸€ä¸å°å¿ƒå°±å¯èƒ½ä¼šå¯¼è‡´ Redis å¡é¡¿ã€‚

**Redis å•çº¿ç¨‹å¦‚ä½•å¤„ç†é‚£ä¹ˆå¤šçš„å¹¶å‘å®¢æˆ·ç«¯è¿æ¥ï¼Ÿ**

è¿™ä¸ªé—®é¢˜ï¼Œæœ‰å¾ˆå¤šä¸­é«˜çº§ç¨‹åºå‘˜éƒ½æ— æ³•å›ç­”ï¼Œå› ä¸ºä»–ä»¬æ²¡å¬è¿‡**å¤šè·¯å¤ç”¨**è¿™ä¸ªè¯æ±‡ï¼Œä¸çŸ¥é“ select ç³»åˆ—çš„äº‹ä»¶è½®è¯¢ APIï¼Œæ²¡ç”¨è¿‡éé˜»å¡ IOã€‚

éé˜»å¡ IO
--
å½“æˆ‘ä»¬è°ƒç”¨å¥—æ¥å­—çš„è¯»å†™æ–¹æ³•ï¼Œé»˜è®¤å®ƒä»¬æ˜¯é˜»å¡çš„ï¼Œæ¯”å¦‚```read```æ–¹æ³•è¦ä¼ é€’è¿›å»ä¸€ä¸ªå‚æ•°```n```ï¼Œè¡¨ç¤ºæœ€å¤šè¯»å–è¿™ä¹ˆå¤šå­—èŠ‚åå†è¿”å›ï¼Œå¦‚æœä¸€ä¸ªå­—èŠ‚éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆçº¿ç¨‹å°±ä¼šå¡åœ¨é‚£é‡Œï¼Œç›´åˆ°æ–°çš„æ•°æ®åˆ°æ¥æˆ–è€…è¿æ¥å…³é—­äº†ï¼Œ```read```æ–¹æ³•æ‰å¯ä»¥è¿”å›ï¼Œçº¿ç¨‹æ‰èƒ½ç»§ç»­å¤„ç†ã€‚è€Œ```write```æ–¹æ³•ä¸€èˆ¬æ¥è¯´ä¸ä¼šé˜»å¡ï¼Œé™¤éå†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„å†™ç¼“å†²åŒºå·²ç»æ»¡äº†ï¼Œ```write```æ–¹æ³•å°±ä¼šé˜»å¡ï¼Œç›´åˆ°ç¼“å­˜åŒºä¸­æœ‰ç©ºé—²ç©ºé—´æŒªå‡ºæ¥äº†ã€‚


![](https://user-gold-cdn.xitu.io/2018/8/26/165739c849e21857?w=1850&h=894&f=png&s=194143)

éé˜»å¡ IO åœ¨å¥—æ¥å­—å¯¹è±¡ä¸Šæä¾›äº†ä¸€ä¸ªé€‰é¡¹```Non_Blocking```ï¼Œå½“è¿™ä¸ªé€‰é¡¹æ‰“å¼€æ—¶ï¼Œè¯»å†™æ–¹æ³•ä¸ä¼šé˜»å¡ï¼Œè€Œæ˜¯èƒ½è¯»å¤šå°‘è¯»å¤šå°‘ï¼Œèƒ½å†™å¤šå°‘å†™å¤šå°‘ã€‚èƒ½è¯»å¤šå°‘å–å†³äºå†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„è¯»ç¼“å†²åŒºå†…éƒ¨çš„æ•°æ®å­—èŠ‚æ•°ï¼Œèƒ½å†™å¤šå°‘å–å†³äºå†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„å†™ç¼“å†²åŒºçš„ç©ºé—²ç©ºé—´å­—èŠ‚æ•°ã€‚è¯»æ–¹æ³•å’Œå†™æ–¹æ³•éƒ½ä¼šé€šè¿‡è¿”å›å€¼æ¥å‘ŠçŸ¥ç¨‹åºå®é™…è¯»å†™äº†å¤šå°‘å­—èŠ‚ã€‚

æœ‰äº†éé˜»å¡ IO æ„å‘³ç€çº¿ç¨‹åœ¨è¯»å†™ IO æ—¶å¯ä»¥ä¸å¿…å†é˜»å¡äº†ï¼Œè¯»å†™å¯ä»¥ç¬é—´å®Œæˆç„¶åçº¿ç¨‹å¯ä»¥ç»§ç»­å¹²åˆ«çš„äº‹äº†ã€‚

äº‹ä»¶è½®è¯¢ (å¤šè·¯å¤ç”¨)
--
éé˜»å¡ IO æœ‰ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯çº¿ç¨‹è¦è¯»æ•°æ®ï¼Œç»“æœè¯»äº†ä¸€éƒ¨åˆ†å°±è¿”å›äº†ï¼Œçº¿ç¨‹å¦‚ä½•çŸ¥é“ä½•æ—¶æ‰åº”è¯¥ç»§ç»­è¯»ã€‚ä¹Ÿå°±æ˜¯å½“æ•°æ®åˆ°æ¥æ—¶ï¼Œçº¿ç¨‹å¦‚ä½•å¾—åˆ°é€šçŸ¥ã€‚å†™ä¹Ÿæ˜¯ä¸€æ ·ï¼Œå¦‚æœç¼“å†²åŒºæ»¡äº†ï¼Œå†™ä¸å®Œï¼Œå‰©ä¸‹çš„æ•°æ®ä½•æ—¶æ‰åº”è¯¥ç»§ç»­å†™ï¼Œçº¿ç¨‹ä¹Ÿåº”è¯¥å¾—åˆ°é€šçŸ¥ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/10/164821ee63cfc36f?w=762&h=508&f=png&s=51094)

äº‹ä»¶è½®è¯¢ API å°±æ˜¯ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Œæœ€ç®€å•çš„äº‹ä»¶è½®è¯¢ API æ˜¯```select```å‡½æ•°ï¼Œå®ƒæ˜¯æ“ä½œç³»ç»Ÿæä¾›ç»™ç”¨æˆ·ç¨‹åºçš„ APIã€‚è¾“å…¥æ˜¯è¯»å†™æè¿°ç¬¦åˆ—è¡¨```read_fds & write_fds```ï¼Œè¾“å‡ºæ˜¯ä¸ä¹‹å¯¹åº”çš„å¯è¯»å¯å†™äº‹ä»¶ã€‚åŒæ—¶è¿˜æä¾›äº†ä¸€ä¸ª```timeout```å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•äº‹ä»¶åˆ°æ¥ï¼Œé‚£ä¹ˆå°±æœ€å¤šç­‰å¾…```timeout```æ—¶é—´ï¼Œçº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ã€‚ä¸€æ—¦æœŸé—´æœ‰ä»»ä½•äº‹ä»¶åˆ°æ¥ï¼Œå°±å¯ä»¥ç«‹å³è¿”å›ã€‚æ—¶é—´è¿‡äº†ä¹‹åè¿˜æ˜¯æ²¡æœ‰ä»»ä½•äº‹ä»¶åˆ°æ¥ï¼Œä¹Ÿä¼šç«‹å³è¿”å›ã€‚æ‹¿åˆ°äº‹ä»¶åï¼Œçº¿ç¨‹å°±å¯ä»¥ç»§ç»­æŒ¨ä¸ªå¤„ç†ç›¸åº”çš„äº‹ä»¶ã€‚å¤„ç†å®Œäº†ç»§ç»­è¿‡æ¥è½®è¯¢ã€‚äºæ˜¯çº¿ç¨‹å°±è¿›å…¥äº†ä¸€ä¸ªæ­»å¾ªç¯ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªæ­»å¾ªç¯ç§°ä¸ºäº‹ä»¶å¾ªç¯ï¼Œä¸€ä¸ªå¾ªç¯ä¸ºä¸€ä¸ªå‘¨æœŸã€‚

æ¯ä¸ªå®¢æˆ·ç«¯å¥—æ¥å­—```socket```éƒ½æœ‰å¯¹åº”çš„è¯»å†™æ–‡ä»¶æè¿°ç¬¦ã€‚

```py
read_events, write_events = select(read_fds, write_fds, timeout)
for event in read_events:
    handle_read(event.fd)
for event in write_events:
    handle_write(event.fd)
handle_others()  # å¤„ç†å…¶å®ƒäº‹æƒ…ï¼Œå¦‚å®šæ—¶ä»»åŠ¡ç­‰
```

å› ä¸ºæˆ‘ä»¬é€šè¿‡```select```ç³»ç»Ÿè°ƒç”¨åŒæ—¶å¤„ç†å¤šä¸ªé€šé“æè¿°ç¬¦çš„è¯»å†™äº‹ä»¶ï¼Œå› æ­¤æˆ‘ä»¬å°†è¿™ç±»ç³»ç»Ÿè°ƒç”¨ç§°ä¸ºå¤šè·¯å¤ç”¨ APIã€‚ç°ä»£æ“ä½œç³»ç»Ÿçš„å¤šè·¯å¤ç”¨ API å·²ç»ä¸å†ä½¿ç”¨```select```ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œæ”¹ç”¨```epoll(linux)```å’Œ```kqueue(freebsd & macosx)```ï¼Œå› ä¸º select ç³»ç»Ÿè°ƒç”¨çš„æ€§èƒ½åœ¨æè¿°ç¬¦ç‰¹åˆ«å¤šæ—¶æ€§èƒ½ä¼šéå¸¸å·®ã€‚å®ƒä»¬ä½¿ç”¨èµ·æ¥å¯èƒ½åœ¨å½¢å¼ä¸Šç•¥æœ‰å·®å¼‚ï¼Œä½†æ˜¯æœ¬è´¨ä¸Šéƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ä¸Šé¢çš„ä¼ªä»£ç é€»è¾‘è¿›è¡Œç†è§£ã€‚

æœåŠ¡å™¨å¥—æ¥å­—```serversocket```å¯¹è±¡çš„è¯»æ“ä½œæ˜¯æŒ‡è°ƒç”¨```accept```æ¥å—å®¢æˆ·ç«¯æ–°è¿æ¥ã€‚ä½•æ—¶æœ‰æ–°è¿æ¥åˆ°æ¥ï¼Œä¹Ÿæ˜¯é€šè¿‡```select```ç³»ç»Ÿè°ƒç”¨çš„è¯»äº‹ä»¶æ¥å¾—åˆ°é€šçŸ¥çš„ã€‚

**äº‹ä»¶è½®è¯¢ API å°±æ˜¯ Java è¯­è¨€é‡Œé¢çš„ NIO æŠ€æœ¯**

Java çš„ NIO å¹¶ä¸æ˜¯ Java ç‰¹æœ‰çš„æŠ€æœ¯ï¼Œå…¶å®ƒè®¡ç®—æœºè¯­è¨€éƒ½æœ‰è¿™ä¸ªæŠ€æœ¯ï¼Œåªä¸è¿‡æ¢äº†ä¸€ä¸ªè¯æ±‡ï¼Œä¸å« NIO è€Œå·²ã€‚

æŒ‡ä»¤é˜Ÿåˆ—
--
Redis ä¼šå°†æ¯ä¸ªå®¢æˆ·ç«¯å¥—æ¥å­—éƒ½å…³è”ä¸€ä¸ªæŒ‡ä»¤é˜Ÿåˆ—ã€‚å®¢æˆ·ç«¯çš„æŒ‡ä»¤é€šè¿‡é˜Ÿåˆ—æ¥æ’é˜Ÿè¿›è¡Œé¡ºåºå¤„ç†ï¼Œå…ˆåˆ°å…ˆæœåŠ¡ã€‚

å“åº”é˜Ÿåˆ—
--
Redis åŒæ ·ä¹Ÿä¼šä¸ºæ¯ä¸ªå®¢æˆ·ç«¯å¥—æ¥å­—å…³è”ä¸€ä¸ªå“åº”é˜Ÿåˆ—ã€‚Redis æœåŠ¡å™¨é€šè¿‡å“åº”é˜Ÿåˆ—æ¥å°†æŒ‡ä»¤çš„è¿”å›ç»“æœå›å¤ç»™å®¢æˆ·ç«¯ã€‚
å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œé‚£ä¹ˆæ„å‘³ç€è¿æ¥æš‚æ—¶å¤„äºç©ºé—²çŠ¶æ€ï¼Œä¸éœ€è¦å»è·å–å†™äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å°†å½“å‰çš„å®¢æˆ·ç«¯æè¿°ç¬¦ä»```write_fds```é‡Œé¢ç§»å‡ºæ¥ã€‚ç­‰åˆ°é˜Ÿåˆ—æœ‰æ•°æ®äº†ï¼Œå†å°†æè¿°ç¬¦æ”¾è¿›å»ã€‚é¿å…```select```ç³»ç»Ÿè°ƒç”¨ç«‹å³è¿”å›å†™äº‹ä»¶ï¼Œç»“æœå‘ç°æ²¡ä»€ä¹ˆæ•°æ®å¯ä»¥å†™ã€‚å‡ºè¿™ç§æƒ…å†µçš„çº¿ç¨‹ä¼šé£™é«˜ CPUã€‚

å®šæ—¶ä»»åŠ¡
--
æœåŠ¡å™¨å¤„ç†è¦å“åº” IO äº‹ä»¶å¤–ï¼Œè¿˜è¦å¤„ç†å…¶å®ƒäº‹æƒ…ã€‚æ¯”å¦‚å®šæ—¶ä»»åŠ¡å°±æ˜¯éå¸¸é‡è¦çš„ä¸€ä»¶äº‹ã€‚å¦‚æœçº¿ç¨‹é˜»å¡åœ¨ select ç³»ç»Ÿè°ƒç”¨ä¸Šï¼Œå®šæ—¶ä»»åŠ¡å°†æ— æ³•å¾—åˆ°å‡†æ—¶è°ƒåº¦ã€‚é‚£ Redis æ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼Ÿ

Redis çš„å®šæ—¶ä»»åŠ¡ä¼šè®°å½•åœ¨ä¸€ä¸ªç§°ä¸º```æœ€å°å †```çš„æ•°æ®ç»“æ„ä¸­ã€‚è¿™ä¸ªå †ä¸­ï¼Œæœ€å¿«è¦æ‰§è¡Œçš„ä»»åŠ¡æ’åœ¨å †çš„æœ€ä¸Šæ–¹ã€‚åœ¨æ¯ä¸ªå¾ªç¯å‘¨æœŸï¼ŒRedis éƒ½ä¼šå°†æœ€å°å †é‡Œé¢å·²ç»åˆ°ç‚¹çš„ä»»åŠ¡ç«‹å³è¿›è¡Œå¤„ç†ã€‚å¤„ç†å®Œæ¯•åï¼Œå°†æœ€å¿«è¦æ‰§è¡Œçš„ä»»åŠ¡è¿˜éœ€è¦çš„æ—¶é—´è®°å½•ä¸‹æ¥ï¼Œè¿™ä¸ªæ—¶é—´å°±æ˜¯```select```ç³»ç»Ÿè°ƒç”¨çš„```timeout```å‚æ•°ã€‚å› ä¸º Redis çŸ¥é“æœªæ¥```timeout```æ—¶é—´å†…ï¼Œæ²¡æœ‰å…¶å®ƒå®šæ—¶ä»»åŠ¡éœ€è¦å¤„ç†ï¼Œæ‰€ä»¥å¯ä»¥å®‰å¿ƒç¡çœ ```timeout```çš„æ—¶é—´ã€‚

**Nginx å’Œ Node çš„äº‹ä»¶å¤„ç†åŸç†å’Œ Redis ä¹Ÿæ˜¯ç±»ä¼¼çš„**

## æ‰©å±•é˜…è¯»

è¯·é˜…è¯»è€é’±çš„å¦ä¸€ç¯‡ç«çˆ†çš„æ–‡ç« [ã€Šè·Ÿç€åŠ¨ç”»æ¥å­¦ä¹ TCPä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹ã€‹](https://juejin.im/post/5b29d2c4e51d4558b80b1d8c)
# åŸç† 2ï¼šäº¤å¤´æ¥è€³ â€”â€” é€šä¿¡åè®®

Redis çš„ä½œè€…è®¤ä¸ºæ•°æ®åº“ç³»ç»Ÿçš„ç“¶é¢ˆä¸€èˆ¬ä¸åœ¨äºç½‘ç»œæµé‡ï¼Œè€Œæ˜¯æ•°æ®åº“è‡ªèº«å†…éƒ¨é€»è¾‘å¤„ç†ä¸Šã€‚æ‰€ä»¥å³ä½¿ Redis ä½¿ç”¨äº†æµªè´¹æµé‡çš„æ–‡æœ¬åè®®ï¼Œä¾ç„¶å¯ä»¥å–å¾—æé«˜çš„è®¿é—®æ€§èƒ½ã€‚Redis å°†æ‰€æœ‰æ•°æ®éƒ½æ”¾åœ¨å†…å­˜ï¼Œç”¨ä¸€ä¸ªå•çº¿ç¨‹å¯¹å¤–æä¾›æœåŠ¡ï¼Œå•ä¸ªèŠ‚ç‚¹åœ¨è·‘æ»¡ä¸€ä¸ª CPU æ ¸å¿ƒçš„æƒ…å†µä¸‹å¯ä»¥è¾¾åˆ°äº† 10w/s çš„è¶…é«˜ QPSã€‚

RESP(Redis Serialization Protocol)
--
RESP æ˜¯ Redis åºåˆ—åŒ–åè®®çš„ç®€å†™ã€‚å®ƒæ˜¯ä¸€ç§ç›´è§‚çš„æ–‡æœ¬åè®®ï¼Œä¼˜åŠ¿åœ¨äºå®ç°å¼‚å¸¸ç®€å•ï¼Œè§£ææ€§èƒ½æå¥½ã€‚

Redis åè®®å°†ä¼ è¾“çš„ç»“æ„æ•°æ®åˆ†ä¸º 5 ç§æœ€å°å•å…ƒç±»å‹ï¼Œå•å…ƒç»“æŸæ—¶ç»Ÿä¸€åŠ ä¸Šå›è½¦æ¢è¡Œç¬¦å·`\r\n`ã€‚
1. å•è¡Œå­—ç¬¦ä¸² ä»¥ `+` ç¬¦å·å¼€å¤´ã€‚
2. å¤šè¡Œå­—ç¬¦ä¸² ä»¥ `$` ç¬¦å·å¼€å¤´ï¼Œåè·Ÿå­—ç¬¦ä¸²é•¿åº¦ã€‚
3. æ•´æ•°å€¼ ä»¥ `:` ç¬¦å·å¼€å¤´ï¼Œåè·Ÿæ•´æ•°çš„å­—ç¬¦ä¸²å½¢å¼ã€‚
4. é”™è¯¯æ¶ˆæ¯ ä»¥ `-` ç¬¦å·å¼€å¤´ã€‚
5. æ•°ç»„ ä»¥ `*` å·å¼€å¤´ï¼Œåè·Ÿæ•°ç»„çš„é•¿åº¦ã€‚

**å•è¡Œå­—ç¬¦ä¸²** hello world
```
+hello world\r\n
```

**å¤šè¡Œå­—ç¬¦ä¸²** hello world
```
$11\r\nhello world\r\n
```
å¤šè¡Œå­—ç¬¦ä¸²å½“ç„¶ä¹Ÿå¯ä»¥è¡¨ç¤ºå•è¡Œå­—ç¬¦ä¸²ã€‚

**æ•´æ•°** 1024
```
:1024\r\n
```

**é”™è¯¯** å‚æ•°ç±»å‹é”™è¯¯
```
-WRONGTYPE Operation against a key holding the wrong kind of value\r\n
```

**æ•°ç»„** [1,2,3]
```
*3\r\n:1\r\n:2\r\n:3\r\n
```

**NULL** ç”¨å¤šè¡Œå­—ç¬¦ä¸²è¡¨ç¤ºï¼Œä¸è¿‡é•¿åº¦è¦å†™æˆ-1ã€‚
```
$-1\r\n
```

**ç©ºä¸²** ç”¨å¤šè¡Œå­—ç¬¦ä¸²è¡¨ç¤ºï¼Œé•¿åº¦å¡« 0ã€‚
```
$0\r\n\r\n
```
æ³¨æ„è¿™é‡Œæœ‰ä¸¤ä¸ª`\r\n`ã€‚ä¸ºä»€ä¹ˆæ˜¯ä¸¤ä¸ª?å› ä¸ºä¸¤ä¸ª`\r\n`ä¹‹é—´,éš”çš„æ˜¯ç©ºä¸²ã€‚


å®¢æˆ·ç«¯ -> æœåŠ¡å™¨
--
å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€çš„æŒ‡ä»¤åªæœ‰ä¸€ç§æ ¼å¼ï¼Œå¤šè¡Œå­—ç¬¦ä¸²æ•°ç»„ã€‚æ¯”å¦‚ä¸€ä¸ªç®€å•çš„ set æŒ‡ä»¤```set author codehole```ä¼šè¢«åºåˆ—åŒ–æˆä¸‹é¢çš„å­—ç¬¦ä¸²ã€‚

```
*3\r\n$3\r\nset\r\n$6\r\nauthor\r\n$8\r\ncodehole\r\n
```

åœ¨æ§åˆ¶å°è¾“å‡ºè¿™ä¸ªå­—ç¬¦ä¸²å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹å‡ºè¿™æ˜¯å¾ˆå¥½é˜…è¯»çš„ä¸€ç§æ ¼å¼ã€‚
```
*3
$3
set
$6
author
$8
codehole

```

æœåŠ¡å™¨ -> å®¢æˆ·ç«¯
--
æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å›å¤çš„å“åº”è¦æ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥æ¶ˆæ¯å“åº”åœ¨ç»“æ„ä¸Šè¦å¤æ‚ä¸å°‘ã€‚ä¸è¿‡å†å¤æ‚çš„å“åº”æ¶ˆæ¯ä¹Ÿæ˜¯ä»¥ä¸Š 5 ä¸­åŸºæœ¬ç±»å‹çš„ç»„åˆã€‚

**å•è¡Œå­—ç¬¦ä¸²å“åº”**
```
127.0.0.1:6379> set author codehole
OK
```
è¿™é‡Œçš„ OK å°±æ˜¯å•è¡Œå“åº”ï¼Œæ²¡æœ‰ä½¿ç”¨å¼•å·æ‹¬èµ·æ¥ã€‚
```
+OK

```
**é”™è¯¯å“åº”**
```
127.0.0.1:6379> incr author
(error) ERR value is not an integer or out of range
```
è¯•å›¾å¯¹ä¸€ä¸ªå­—ç¬¦ä¸²è¿›è¡Œè‡ªå¢ï¼ŒæœåŠ¡å™¨æŠ›å‡ºä¸€ä¸ªé€šç”¨çš„é”™è¯¯ã€‚
```
-ERR value is not an integer or out of range

```
**æ•´æ•°å“åº”**
```
127.0.0.1:6379> incr books
(integer) 1
```
è¿™é‡Œçš„```1```å°±æ˜¯æ•´æ•°å“åº”
```
:1

```
**å¤šè¡Œå­—ç¬¦ä¸²å“åº”**
```
127.0.0.1:6379> get author
"codehole"
```
è¿™é‡Œä½¿ç”¨åŒå¼•å·æ‹¬èµ·æ¥çš„å­—ç¬¦ä¸²å°±æ˜¯å¤šè¡Œå­—ç¬¦ä¸²å“åº”
```
$8
codehole

```
**æ•°ç»„å“åº”**
```
127.0.0.1:6379> hset info name laoqian
(integer) 1
127.0.0.1:6379> hset info age 30
(integer) 1
127.0.0.1:6379> hset info sex male
(integer) 1
127.0.0.1:6379> hgetall info
1) "name"
2) "laoqian"
3) "age"
4) "30"
5) "sex"
6) "male"
```
è¿™é‡Œçš„ hgetall å‘½ä»¤è¿”å›çš„å°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç¬¬ 0|2|4 ä½ç½®çš„å­—ç¬¦ä¸²æ˜¯ hash è¡¨çš„ keyï¼Œç¬¬ 1|3|5 ä½ç½®çš„å­—ç¬¦ä¸²æ˜¯ valueï¼Œå®¢æˆ·ç«¯è´Ÿè´£å°†æ•°ç»„ç»„è£…æˆå­—å…¸å†è¿”å›ã€‚
```
*6
$4
name
$6
laoqian
$3
age
$2
30
$3
sex
$4
male

```

**åµŒå¥—**
```
127.0.0.1:6379> scan 0
1) "0"
2) 1) "info"
   2) "books"
   3) "author"
```
scan å‘½ä»¤ç”¨æ¥æ‰«ææœåŠ¡å™¨åŒ…å«çš„æ‰€æœ‰ key åˆ—è¡¨ï¼Œå®ƒæ˜¯ä»¥æ¸¸æ ‡çš„å½¢å¼è·å–ï¼Œä¸€æ¬¡åªè·å–ä¸€éƒ¨åˆ†ã€‚

scan å‘½ä»¤è¿”å›çš„æ˜¯ä¸€ä¸ªåµŒå¥—æ•°ç»„ã€‚æ•°ç»„çš„ç¬¬ä¸€ä¸ªå€¼è¡¨ç¤ºæ¸¸æ ‡çš„å€¼ï¼Œå¦‚æœè¿™ä¸ªå€¼ä¸ºé›¶ï¼Œè¯´æ˜å·²ç»éå†å®Œæ¯•ã€‚å¦‚æœä¸ä¸ºé›¶ï¼Œä½¿ç”¨è¿™ä¸ªå€¼ä½œä¸º scan å‘½ä»¤çš„å‚æ•°è¿›è¡Œä¸‹ä¸€æ¬¡éå†ã€‚æ•°ç»„çš„ç¬¬äºŒä¸ªå€¼åˆæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„å°±æ˜¯ key åˆ—è¡¨ã€‚
```
*2
$1
0
*3
$4
info
$5
books
$6
author
```

å°ç»“
--
Redis åè®®é‡Œæœ‰å¤§é‡å†—ä½™çš„å›è½¦æ¢è¡Œç¬¦ï¼Œä½†æ˜¯è¿™ä¸å½±å“å®ƒæˆä¸ºäº’è”ç½‘æŠ€æœ¯é¢†åŸŸéå¸¸å—æ¬¢è¿çš„ä¸€ä¸ªæ–‡æœ¬åè®®ã€‚æœ‰å¾ˆå¤šå¼€æºé¡¹ç›®ä½¿ç”¨ RESP ä½œä¸ºå®ƒçš„é€šè®¯åè®®ã€‚åœ¨æŠ€æœ¯é¢†åŸŸæ€§èƒ½å¹¶ä¸æ€»æ˜¯ä¸€åˆ‡ï¼Œè¿˜æœ‰ç®€å•æ€§ã€æ˜“ç†è§£æ€§å’Œæ˜“å®ç°æ€§ï¼Œè¿™äº›éƒ½éœ€è¦è¿›è¡Œé€‚å½“æƒè¡¡ã€‚

## æ‰©å±•é˜…è¯»

å¦‚æœä½ æƒ³è‡ªå·±å®ç°ä¸€å¥—Redisåè®®çš„è§£ç å™¨ï¼Œè¯·é˜…è¯»è€é’±çš„å¦ä¸€ç¯‡æ–‡ç« [ã€ŠåŸºäºNettyå®ç°Redisåè®®çš„ç¼–ç è§£ç å™¨ã€‹](https://juejin.im/post/5aaf1e0af265da2381556c0e)
# åŸç† 3ï¼šæœªé›¨ç»¸ç¼ª â€”â€” æŒä¹…åŒ–

Redis çš„æ•°æ®å…¨éƒ¨åœ¨å†…å­˜é‡Œï¼Œå¦‚æœçªç„¶å®•æœºï¼Œæ•°æ®å°±ä¼šå…¨éƒ¨ä¸¢å¤±ï¼Œå› æ­¤å¿…é¡»æœ‰ä¸€ç§æœºåˆ¶æ¥ä¿è¯ Redis çš„æ•°æ®ä¸ä¼šå› ä¸ºæ•…éšœè€Œä¸¢å¤±ï¼Œè¿™ç§æœºåˆ¶å°±æ˜¯ Redis çš„æŒä¹…åŒ–æœºåˆ¶ã€‚

Redis çš„æŒä¹…åŒ–æœºåˆ¶æœ‰ä¸¤ç§ï¼Œç¬¬ä¸€ç§æ˜¯å¿«ç…§ï¼Œç¬¬äºŒç§æ˜¯ AOF æ—¥å¿—ã€‚å¿«ç…§æ˜¯ä¸€æ¬¡å…¨é‡å¤‡ä»½ï¼ŒAOF æ—¥å¿—æ˜¯è¿ç»­çš„å¢é‡å¤‡ä»½ã€‚å¿«ç…§æ˜¯å†…å­˜æ•°æ®çš„äºŒè¿›åˆ¶åºåˆ—åŒ–å½¢å¼ï¼Œåœ¨å­˜å‚¨ä¸Šéå¸¸ç´§å‡‘ï¼Œè€Œ AOF æ—¥å¿—è®°å½•çš„æ˜¯å†…å­˜æ•°æ®ä¿®æ”¹çš„æŒ‡ä»¤è®°å½•æ–‡æœ¬ã€‚AOF æ—¥å¿—åœ¨é•¿æœŸçš„è¿è¡Œè¿‡ç¨‹ä¸­ä¼šå˜çš„æ— æ¯”åºå¤§ï¼Œæ•°æ®åº“é‡å¯æ—¶éœ€è¦åŠ è½½ AOF æ—¥å¿—è¿›è¡ŒæŒ‡ä»¤é‡æ”¾ï¼Œè¿™ä¸ªæ—¶é—´å°±ä¼šæ— æ¯”æ¼«é•¿ã€‚æ‰€ä»¥éœ€è¦å®šæœŸè¿›è¡Œ AOF é‡å†™ï¼Œç»™ AOF æ—¥å¿—è¿›è¡Œç˜¦èº«ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/10/164820eb27b6a97e?w=667&h=259&f=png&s=19059)

å¿«ç…§åŸç†
--
æˆ‘ä»¬çŸ¥é“ Redis æ˜¯å•çº¿ç¨‹ç¨‹åºï¼Œè¿™ä¸ªçº¿ç¨‹è¦åŒæ—¶è´Ÿè´£å¤šä¸ªå®¢æˆ·ç«¯å¥—æ¥å­—çš„å¹¶å‘è¯»å†™æ“ä½œå’Œå†…å­˜æ•°æ®ç»“æ„çš„é€»è¾‘è¯»å†™ã€‚

åœ¨æœåŠ¡çº¿ä¸Šè¯·æ±‚çš„åŒæ—¶ï¼ŒRedis è¿˜éœ€è¦è¿›è¡Œå†…å­˜å¿«ç…§ï¼Œå†…å­˜å¿«ç…§è¦æ±‚ Redis å¿…é¡»è¿›è¡Œæ–‡ä»¶ IO æ“ä½œï¼Œå¯æ–‡ä»¶ IO æ“ä½œæ˜¯ä¸èƒ½ä½¿ç”¨å¤šè·¯å¤ç”¨ APIã€‚

è¿™æ„å‘³ç€å•çº¿ç¨‹åŒæ—¶åœ¨æœåŠ¡çº¿ä¸Šçš„è¯·æ±‚è¿˜è¦è¿›è¡Œæ–‡ä»¶ IO æ“ä½œï¼Œæ–‡ä»¶ IO æ“ä½œä¼šä¸¥é‡æ‹–å®æœåŠ¡å™¨è¯·æ±‚çš„æ€§èƒ½ã€‚è¿˜æœ‰ä¸ª**é‡è¦çš„é—®é¢˜æ˜¯ä¸ºäº†ä¸é˜»å¡çº¿ä¸Šçš„ä¸šåŠ¡ï¼Œå°±éœ€è¦è¾¹æŒä¹…åŒ–è¾¹å“åº”å®¢æˆ·ç«¯è¯·æ±‚**ã€‚æŒä¹…åŒ–çš„åŒæ—¶ï¼Œå†…å­˜æ•°æ®ç»“æ„è¿˜åœ¨æ”¹å˜ï¼Œæ¯”å¦‚ä¸€ä¸ªå¤§å‹çš„ hash å­—å…¸æ­£åœ¨æŒä¹…åŒ–ï¼Œç»“æœä¸€ä¸ªè¯·æ±‚è¿‡æ¥æŠŠå®ƒç»™åˆ æ‰äº†ï¼Œè¿˜æ²¡æŒä¹…åŒ–å®Œå‘¢ï¼Œè¿™å°¼ç›è¦æ€ä¹ˆæï¼Ÿ

**é‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ**

Redis ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„å¤šè¿›ç¨‹ COW(Copy On Write) æœºåˆ¶æ¥å®ç°å¿«ç…§æŒä¹…åŒ–ï¼Œè¿™ä¸ªæœºåˆ¶å¾ˆæœ‰æ„æ€ï¼Œä¹Ÿå¾ˆå°‘äººçŸ¥é“ã€‚å¤šè¿›ç¨‹ COW ä¹Ÿæ˜¯é‰´å®šç¨‹åºå‘˜çŸ¥è¯†å¹¿åº¦çš„ä¸€ä¸ªé‡è¦æŒ‡æ ‡ã€‚

fork(å¤šè¿›ç¨‹)
--
Redis åœ¨æŒä¹…åŒ–æ—¶ä¼šè°ƒç”¨ glibc çš„å‡½æ•°```fork```äº§ç”Ÿä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¿«ç…§æŒä¹…åŒ–å®Œå…¨äº¤ç»™å­è¿›ç¨‹æ¥å¤„ç†ï¼Œçˆ¶è¿›ç¨‹ç»§ç»­å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ã€‚å­è¿›ç¨‹åˆšåˆšäº§ç”Ÿæ—¶ï¼Œå®ƒå’Œçˆ¶è¿›ç¨‹å…±äº«å†…å­˜é‡Œé¢çš„ä»£ç æ®µå’Œæ•°æ®æ®µã€‚è¿™æ—¶ä½ å¯ä»¥å°†çˆ¶å­è¿›ç¨‹æƒ³åƒæˆä¸€ä¸ªè¿ä½“å©´å„¿ï¼Œå…±äº«èº«ä½“ã€‚è¿™æ˜¯ Linux æ“ä½œç³»ç»Ÿçš„æœºåˆ¶ï¼Œä¸ºäº†èŠ‚çº¦å†…å­˜èµ„æºï¼Œæ‰€ä»¥å°½å¯èƒ½è®©å®ƒä»¬å…±äº«èµ·æ¥ã€‚åœ¨è¿›ç¨‹åˆ†ç¦»çš„ä¸€ç¬é—´ï¼Œå†…å­˜çš„å¢é•¿å‡ ä¹æ²¡æœ‰æ˜æ˜¾å˜åŒ–ã€‚

![](https://user-gold-cdn.xitu.io/2018/5/18/163712a9f9d0c3cf?w=493&h=255&f=png&s=212826)

ç”¨ Python è¯­è¨€æè¿°è¿›ç¨‹åˆ†ç¦»çš„é€»è¾‘å¦‚ä¸‹ã€‚```fork```å‡½æ•°ä¼šåœ¨çˆ¶å­è¿›ç¨‹åŒæ—¶è¿”å›ï¼Œåœ¨çˆ¶è¿›ç¨‹é‡Œè¿”å›å­è¿›ç¨‹çš„ pidï¼Œåœ¨å­è¿›ç¨‹é‡Œè¿”å›é›¶ã€‚å¦‚æœæ“ä½œç³»ç»Ÿå†…å­˜èµ„æºä¸è¶³ï¼Œpid å°±ä¼šæ˜¯è´Ÿæ•°ï¼Œè¡¨ç¤º```fork```å¤±è´¥ã€‚

```py
pid = os.fork()
if pid > 0:
    handle_client_requests()  # çˆ¶è¿›ç¨‹ç»§ç»­å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
if pid == 0:
    handle_snapshot_write()  # å­è¿›ç¨‹å¤„ç†å¿«ç…§å†™ç£ç›˜
if pid < 0:
    # fork error
```

å­è¿›ç¨‹åšæ•°æ®æŒä¹…åŒ–ï¼Œå®ƒä¸ä¼šä¿®æ”¹ç°æœ‰çš„å†…å­˜æ•°æ®ç»“æ„ï¼Œå®ƒåªæ˜¯å¯¹æ•°æ®ç»“æ„è¿›è¡Œéå†è¯»å–ï¼Œç„¶ååºåˆ—åŒ–å†™åˆ°ç£ç›˜ä¸­ã€‚ä½†æ˜¯çˆ¶è¿›ç¨‹ä¸ä¸€æ ·ï¼Œå®ƒå¿…é¡»æŒç»­æœåŠ¡å®¢æˆ·ç«¯è¯·æ±‚ï¼Œç„¶åå¯¹å†…å­˜æ•°æ®ç»“æ„è¿›è¡Œä¸é—´æ–­çš„ä¿®æ”¹ã€‚

è¿™ä¸ªæ—¶å€™å°±ä¼šä½¿ç”¨æ“ä½œç³»ç»Ÿçš„ COW æœºåˆ¶æ¥è¿›è¡Œæ•°æ®æ®µé¡µé¢çš„åˆ†ç¦»ã€‚æ•°æ®æ®µæ˜¯ç”±å¾ˆå¤šæ“ä½œç³»ç»Ÿçš„é¡µé¢ç»„åˆè€Œæˆï¼Œå½“çˆ¶è¿›ç¨‹å¯¹å…¶ä¸­ä¸€ä¸ªé¡µé¢çš„æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶ï¼Œä¼šå°†è¢«å…±äº«çš„é¡µé¢å¤åˆ¶ä¸€ä»½åˆ†ç¦»å‡ºæ¥ï¼Œç„¶åå¯¹è¿™ä¸ªå¤åˆ¶çš„é¡µé¢è¿›è¡Œä¿®æ”¹ã€‚è¿™æ—¶å­è¿›ç¨‹ç›¸åº”çš„é¡µé¢æ˜¯æ²¡æœ‰å˜åŒ–çš„ï¼Œè¿˜æ˜¯è¿›ç¨‹äº§ç”Ÿæ—¶é‚£ä¸€ç¬é—´çš„æ•°æ®ã€‚

![](https://user-gold-cdn.xitu.io/2018/5/18/163711de3e2b6cb8?w=461&h=364&f=png&s=20109)

éšç€çˆ¶è¿›ç¨‹ä¿®æ”¹æ“ä½œçš„æŒç»­è¿›è¡Œï¼Œè¶Šæ¥è¶Šå¤šçš„å…±äº«é¡µé¢è¢«åˆ†ç¦»å‡ºæ¥ï¼Œå†…å­˜å°±ä¼šæŒç»­å¢é•¿ã€‚ä½†æ˜¯ä¹Ÿä¸ä¼šè¶…è¿‡åŸæœ‰æ•°æ®å†…å­˜çš„ 2 å€å¤§å°ã€‚å¦å¤–ä¸€ä¸ª Redis å®ä¾‹é‡Œå†·æ•°æ®å çš„æ¯”ä¾‹å¾€å¾€æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œæ‰€ä»¥å¾ˆå°‘ä¼šå‡ºç°æ‰€æœ‰çš„é¡µé¢éƒ½ä¼šè¢«åˆ†ç¦»ï¼Œè¢«åˆ†ç¦»çš„å¾€å¾€åªæœ‰å…¶ä¸­ä¸€éƒ¨åˆ†é¡µé¢ã€‚æ¯ä¸ªé¡µé¢çš„å¤§å°åªæœ‰ 4Kï¼Œä¸€ä¸ª Redis å®ä¾‹é‡Œé¢ä¸€èˆ¬éƒ½ä¼šæœ‰æˆåƒä¸Šä¸‡çš„é¡µé¢ã€‚

å­è¿›ç¨‹å› ä¸ºæ•°æ®æ²¡æœ‰å˜åŒ–ï¼Œå®ƒèƒ½çœ‹åˆ°çš„å†…å­˜é‡Œçš„æ•°æ®åœ¨è¿›ç¨‹äº§ç”Ÿçš„ä¸€ç¬é—´å°±å‡å›ºäº†ï¼Œå†ä¹Ÿä¸ä¼šæ”¹å˜ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Redis çš„æŒä¹…åŒ–å«ã€Œå¿«ç…§ã€çš„åŸå› ã€‚æ¥ä¸‹æ¥å­è¿›ç¨‹å°±å¯ä»¥éå¸¸å®‰å¿ƒçš„éå†æ•°æ®äº†è¿›è¡Œåºåˆ—åŒ–å†™ç£ç›˜äº†ã€‚

AOF åŸç†
--
AOF æ—¥å¿—å­˜å‚¨çš„æ˜¯ Redis æœåŠ¡å™¨çš„é¡ºåºæŒ‡ä»¤åºåˆ—ï¼ŒAOF æ—¥å¿—åªè®°å½•å¯¹å†…å­˜è¿›è¡Œä¿®æ”¹çš„æŒ‡ä»¤è®°å½•ã€‚

å‡è®¾ AOF æ—¥å¿—è®°å½•äº†è‡ª Redis å®ä¾‹åˆ›å»ºä»¥æ¥æ‰€æœ‰çš„ä¿®æ”¹æ€§æŒ‡ä»¤åºåˆ—ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡å¯¹ä¸€ä¸ªç©ºçš„ Redis å®ä¾‹é¡ºåºæ‰§è¡Œæ‰€æœ‰çš„æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯ã€Œé‡æ”¾ã€ï¼Œæ¥æ¢å¤ Redis å½“å‰å®ä¾‹çš„å†…å­˜æ•°æ®ç»“æ„çš„çŠ¶æ€ã€‚

Redis ä¼šåœ¨æ”¶åˆ°å®¢æˆ·ç«¯ä¿®æ”¹æŒ‡ä»¤åï¼Œè¿›è¡Œå‚æ•°æ ¡éªŒè¿›è¡Œé€»è¾‘å¤„ç†åï¼Œå¦‚æœæ²¡é—®é¢˜ï¼Œå°±ç«‹å³å°†è¯¥æŒ‡ä»¤æ–‡æœ¬å­˜å‚¨åˆ° AOF æ—¥å¿—ä¸­ï¼Œä¹Ÿå°±æ˜¯å…ˆæ‰§è¡ŒæŒ‡ä»¤æ‰å°†æ—¥å¿—å­˜ç›˜ã€‚è¿™ç‚¹ä¸åŒäºleveldbã€hbaseç­‰å­˜å‚¨å¼•æ“ï¼Œå®ƒä»¬éƒ½æ˜¯å…ˆå­˜å‚¨æ—¥å¿—å†åšé€»è¾‘å¤„ç†ã€‚

Redis åœ¨é•¿æœŸè¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒAOF çš„æ—¥å¿—ä¼šè¶Šå˜è¶Šé•¿ã€‚å¦‚æœå®ä¾‹å®•æœºé‡å¯ï¼Œé‡æ”¾æ•´ä¸ª AOF æ—¥å¿—ä¼šéå¸¸è€—æ—¶ï¼Œå¯¼è‡´é•¿æ—¶é—´ Redis æ— æ³•å¯¹å¤–æä¾›æœåŠ¡ã€‚æ‰€ä»¥éœ€è¦å¯¹ AOF æ—¥å¿—ç˜¦èº«ã€‚

AOF é‡å†™
--
Redis æä¾›äº† bgrewriteaof æŒ‡ä»¤ç”¨äºå¯¹ AOF æ—¥å¿—è¿›è¡Œç˜¦èº«ã€‚å…¶åŸç†å°±æ˜¯å¼€è¾Ÿä¸€ä¸ªå­è¿›ç¨‹å¯¹å†…å­˜è¿›è¡Œéå†è½¬æ¢æˆä¸€ç³»åˆ— Redis çš„æ“ä½œæŒ‡ä»¤ï¼Œåºåˆ—åŒ–åˆ°ä¸€ä¸ªæ–°çš„ AOF æ—¥å¿—æ–‡ä»¶ä¸­ã€‚åºåˆ—åŒ–å®Œæ¯•åå†å°†æ“ä½œæœŸé—´å‘ç”Ÿçš„å¢é‡ AOF æ—¥å¿—è¿½åŠ åˆ°è¿™ä¸ªæ–°çš„ AOF æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œè¿½åŠ å®Œæ¯•åå°±ç«‹å³æ›¿ä»£æ—§çš„ AOF æ—¥å¿—æ–‡ä»¶äº†ï¼Œç˜¦èº«å·¥ä½œå°±å®Œæˆäº†ã€‚

fsync
--
AOF æ—¥å¿—æ˜¯ä»¥æ–‡ä»¶çš„å½¢å¼å­˜åœ¨çš„ï¼Œå½“ç¨‹åºå¯¹ AOF æ—¥å¿—æ–‡ä»¶è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œå®é™…ä¸Šæ˜¯å°†å†…å®¹å†™åˆ°äº†å†…æ ¸ä¸ºæ–‡ä»¶æè¿°ç¬¦åˆ†é…çš„ä¸€ä¸ªå†…å­˜ç¼“å­˜ä¸­ï¼Œç„¶åå†…æ ¸ä¼šå¼‚æ­¥å°†è„æ•°æ®åˆ·å›åˆ°ç£ç›˜çš„ã€‚

è¿™å°±æ„å‘³ç€å¦‚æœæœºå™¨çªç„¶å®•æœºï¼ŒAOF æ—¥å¿—å†…å®¹å¯èƒ½è¿˜æ²¡æœ‰æ¥å¾—åŠå®Œå…¨åˆ·åˆ°ç£ç›˜ä¸­ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå‡ºç°æ—¥å¿—ä¸¢å¤±ã€‚é‚£è¯¥æ€ä¹ˆåŠï¼Ÿ

Linux çš„```glibc```æä¾›äº†```fsync(int fd)```å‡½æ•°å¯ä»¥å°†æŒ‡å®šæ–‡ä»¶çš„å†…å®¹å¼ºåˆ¶ä»å†…æ ¸ç¼“å­˜åˆ·åˆ°ç£ç›˜ã€‚åªè¦ Redis è¿›ç¨‹å®æ—¶è°ƒç”¨ fsync å‡½æ•°å°±å¯ä»¥ä¿è¯ aof æ—¥å¿—ä¸ä¸¢å¤±ã€‚ä½†æ˜¯ fsync æ˜¯ä¸€ä¸ªç£ç›˜ IO æ“ä½œï¼Œå®ƒå¾ˆæ…¢ï¼å¦‚æœ Redis æ‰§è¡Œä¸€æ¡æŒ‡ä»¤å°±è¦ fsync ä¸€æ¬¡ï¼Œé‚£ä¹ˆ Redis é«˜æ€§èƒ½çš„åœ°ä½å°±ä¸ä¿äº†ã€‚

æ‰€ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒçš„æœåŠ¡å™¨ä¸­ï¼ŒRedis é€šå¸¸æ˜¯æ¯éš” 1s å·¦å³æ‰§è¡Œä¸€æ¬¡ fsync æ“ä½œï¼Œå‘¨æœŸ 1s æ˜¯å¯ä»¥é…ç½®çš„ã€‚è¿™æ˜¯åœ¨æ•°æ®å®‰å…¨æ€§å’Œæ€§èƒ½ä¹‹é—´åšäº†ä¸€ä¸ªæŠ˜ä¸­ï¼Œåœ¨ä¿æŒé«˜æ€§èƒ½çš„åŒæ—¶ï¼Œå°½å¯èƒ½ä½¿å¾—æ•°æ®å°‘ä¸¢å¤±ã€‚

Redis åŒæ ·ä¹Ÿæä¾›äº†å¦å¤–ä¸¤ç§ç­–ç•¥ï¼Œä¸€ä¸ªæ˜¯æ°¸ä¸ fsyncâ€”â€”è®©æ“ä½œç³»ç»Ÿæ¥å†³å®šä½•æ—¶åŒæ­¥ç£ç›˜ï¼Œå¾ˆä¸å®‰å…¨ï¼Œå¦ä¸€ä¸ªæ˜¯æ¥ä¸€ä¸ªæŒ‡ä»¤å°± fsync ä¸€æ¬¡â€”â€”éå¸¸æ…¢ã€‚ä½†æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒåŸºæœ¬ä¸ä¼šä½¿ç”¨ï¼Œäº†è§£ä¸€ä¸‹å³å¯ã€‚

è¿ç»´
--
å¿«ç…§æ˜¯é€šè¿‡å¼€å¯å­è¿›ç¨‹çš„æ–¹å¼è¿›è¡Œçš„ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—èµ„æºçš„æ“ä½œã€‚
1. éå†æ•´ä¸ªå†…å­˜ï¼Œå¤§å—å†™ç£ç›˜ä¼šåŠ é‡ç³»ç»Ÿè´Ÿè½½
2. AOF çš„ fsync æ˜¯ä¸€ä¸ªè€—æ—¶çš„ IO æ“ä½œï¼Œå®ƒä¼šé™ä½ Redis æ€§èƒ½ï¼ŒåŒæ—¶ä¹Ÿä¼šå¢åŠ ç³»ç»Ÿ IO è´Ÿæ‹…

æ‰€ä»¥é€šå¸¸ Redis çš„ä¸»èŠ‚ç‚¹æ˜¯ä¸ä¼šè¿›è¡ŒæŒä¹…åŒ–æ“ä½œï¼ŒæŒä¹…åŒ–æ“ä½œä¸»è¦åœ¨ä»èŠ‚ç‚¹è¿›è¡Œã€‚ä»èŠ‚ç‚¹æ˜¯å¤‡ä»½èŠ‚ç‚¹ï¼Œæ²¡æœ‰æ¥è‡ªå®¢æˆ·ç«¯è¯·æ±‚çš„å‹åŠ›ï¼Œå®ƒçš„æ“ä½œç³»ç»Ÿèµ„æºå¾€å¾€æ¯”è¾ƒå……æ²›ã€‚

ä½†æ˜¯å¦‚æœå‡ºç°ç½‘ç»œåˆ†åŒºï¼Œä»èŠ‚ç‚¹é•¿æœŸè¿ä¸ä¸Šä¸»èŠ‚ç‚¹ï¼Œå°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯åœ¨ç½‘ç»œåˆ†åŒºå‡ºç°çš„æƒ…å†µä¸‹åˆä¸å°å¿ƒä¸»èŠ‚ç‚¹å®•æœºäº†ï¼Œé‚£ä¹ˆæ•°æ®å°±ä¼šä¸¢å¤±ï¼Œæ‰€ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒè¦åšå¥½å®æ—¶ç›‘æ§å·¥ä½œï¼Œä¿è¯ç½‘ç»œç•…é€šæˆ–è€…èƒ½å¿«é€Ÿä¿®å¤ã€‚å¦å¤–è¿˜åº”è¯¥å†å¢åŠ ä¸€ä¸ªä»èŠ‚ç‚¹ä»¥é™ä½ç½‘ç»œåˆ†åŒºçš„æ¦‚ç‡ï¼Œåªè¦æœ‰ä¸€ä¸ªä»èŠ‚ç‚¹æ•°æ®åŒæ­¥æ­£å¸¸ï¼Œæ•°æ®ä¹Ÿå°±ä¸ä¼šè½»æ˜“ä¸¢å¤±ã€‚

Redis 4.0 æ··åˆæŒä¹…åŒ–
--
é‡å¯ Redis æ—¶ï¼Œæˆ‘ä»¬å¾ˆå°‘ä½¿ç”¨ rdb æ¥æ¢å¤å†…å­˜çŠ¶æ€ï¼Œå› ä¸ºä¼šä¸¢å¤±å¤§é‡æ•°æ®ã€‚æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ AOF æ—¥å¿—é‡æ”¾ï¼Œä½†æ˜¯é‡æ”¾ AOF æ—¥å¿—æ€§èƒ½ç›¸å¯¹ rdb æ¥è¯´è¦æ…¢å¾ˆå¤šï¼Œè¿™æ ·åœ¨ Redis å®ä¾‹å¾ˆå¤§çš„æƒ…å†µä¸‹ï¼Œå¯åŠ¨éœ€è¦èŠ±è´¹å¾ˆé•¿çš„æ—¶é—´ã€‚

Redis 4.0 ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¸¦æ¥äº†ä¸€ä¸ªæ–°çš„æŒä¹…åŒ–é€‰é¡¹â€”â€”æ··åˆæŒä¹…åŒ–ã€‚å°† rdb æ–‡ä»¶çš„å†…å®¹å’Œå¢é‡çš„ AOF æ—¥å¿—æ–‡ä»¶å­˜åœ¨ä¸€èµ·ã€‚è¿™é‡Œçš„ AOF æ—¥å¿—ä¸å†æ˜¯å…¨é‡çš„æ—¥å¿—ï¼Œè€Œæ˜¯è‡ªæŒä¹…åŒ–å¼€å§‹åˆ°æŒä¹…åŒ–ç»“æŸçš„è¿™æ®µæ—¶é—´å‘ç”Ÿçš„å¢é‡ AOF æ—¥å¿—ï¼Œé€šå¸¸è¿™éƒ¨åˆ† AOF æ—¥å¿—å¾ˆå°ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/10/164821272ae19ebb?w=816&h=382&f=png&s=21479)

äºæ˜¯åœ¨ Redis é‡å¯çš„æ—¶å€™ï¼Œå¯ä»¥å…ˆåŠ è½½ rdb çš„å†…å®¹ï¼Œç„¶åå†é‡æ”¾å¢é‡ AOF æ—¥å¿—å°±å¯ä»¥å®Œå…¨æ›¿ä»£ä¹‹å‰çš„ AOF å…¨é‡æ–‡ä»¶é‡æ”¾ï¼Œé‡å¯æ•ˆç‡å› æ­¤å¤§å¹…å¾—åˆ°æå‡ã€‚

## æ€è€ƒé¢˜

1. æœ‰äººè¯´ Redis åªé€‚åˆç”¨æ¥åšç¼“å­˜ï¼Œå½“æ•°æ®åº“æ¥ç”¨å¹¶ä¸åˆé€‚ï¼Œä½ æ€ä¹ˆçœ‹ï¼Ÿ
2. ä¸ºä»€ä¹ˆ Redis å…ˆæ‰§è¡ŒæŒ‡ä»¤å†è®°å½•aofæ—¥å¿—è€Œä¸æ˜¯åƒå…¶å®ƒå­˜å‚¨å¼•æ“ä¸€æ ·åè¿‡æ¥å‘¢ï¼Ÿ
# åŸç† 4ï¼šé›·å‰é£è¡Œ â€”â€” ç®¡é“

å¤§å¤šæ•°åŒå­¦ä¸€ç›´ä»¥æ¥å¯¹ Redis ç®¡é“æœ‰ä¸€ä¸ªè¯¯è§£ï¼Œä»–ä»¬ä»¥ä¸ºè¿™æ˜¯ Redis æœåŠ¡å™¨æä¾›çš„ä¸€ç§ç‰¹åˆ«çš„æŠ€æœ¯ï¼Œæœ‰äº†è¿™ç§æŠ€æœ¯å°±å¯ä»¥åŠ é€Ÿ Redis çš„å­˜å–æ•ˆç‡ã€‚ä½†æ˜¯å®é™…ä¸Š Redis ç®¡é“ (Pipeline) æœ¬èº«å¹¶ä¸æ˜¯ Redis æœåŠ¡å™¨ç›´æ¥æä¾›çš„æŠ€æœ¯ï¼Œè¿™ä¸ªæŠ€æœ¯æœ¬è´¨ä¸Šæ˜¯ç”±å®¢æˆ·ç«¯æä¾›çš„ï¼Œè·ŸæœåŠ¡å™¨æ²¡æœ‰ä»€ä¹ˆç›´æ¥çš„å…³ç³»ã€‚ä¸‹é¢æˆ‘ä»¬å¯¹è¿™å—åšä¸€ä¸ªæ·±å…¥æ¢ç©¶ã€‚

Redis çš„æ¶ˆæ¯äº¤äº’
--
å½“æˆ‘ä»¬ä½¿ç”¨å®¢æˆ·ç«¯å¯¹ Redis è¿›è¡Œä¸€æ¬¡æ“ä½œæ—¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå®¢æˆ·ç«¯å°†è¯·æ±‚ä¼ é€ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¤„ç†å®Œæ¯•åï¼Œå†å°†å“åº”å›å¤ç»™å®¢æˆ·ç«¯ã€‚è¿™è¦èŠ±è´¹ä¸€ä¸ªç½‘ç»œæ•°æ®åŒ…æ¥å›çš„æ—¶é—´ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/10/1648204d4930cc08?w=718&h=164&f=png&s=13399)

å¦‚æœè¿ç»­æ‰§è¡Œå¤šæ¡æŒ‡ä»¤ï¼Œé‚£å°±ä¼šèŠ±è´¹å¤šä¸ªç½‘ç»œæ•°æ®åŒ…æ¥å›çš„æ—¶é—´ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](https://user-gold-cdn.xitu.io/2018/7/10/1648205b22725764?w=687&h=218&f=png&s=16830)

å›åˆ°å®¢æˆ·ç«¯ä»£ç å±‚é¢ï¼Œå®¢æˆ·ç«¯æ˜¯ç»å†äº†å†™-è¯»-å†™-è¯»å››ä¸ªæ“ä½œæ‰å®Œæ•´åœ°æ‰§è¡Œäº†ä¸¤æ¡æŒ‡ä»¤ã€‚


![](https://user-gold-cdn.xitu.io/2018/7/10/164820734e963482?w=722&h=83&f=png&s=7258)

ç°åœ¨å¦‚æœæˆ‘ä»¬è°ƒæ•´è¯»å†™é¡ºåºï¼Œæ”¹æˆå†™â€”å†™-è¯»-è¯»ï¼Œè¿™ä¸¤ä¸ªæŒ‡ä»¤åŒæ ·å¯ä»¥æ­£å¸¸å®Œæˆã€‚


![](https://user-gold-cdn.xitu.io/2018/7/10/16482078e3ea3ece?w=745&h=113&f=png&s=7829)

ä¸¤ä¸ªè¿ç»­çš„å†™æ“ä½œå’Œä¸¤ä¸ªè¿ç»­çš„è¯»æ“ä½œæ€»å…±åªä¼šèŠ±è´¹ä¸€æ¬¡ç½‘ç»œæ¥å›ï¼Œå°±å¥½æ¯”è¿ç»­çš„ write æ“ä½œåˆå¹¶äº†ï¼Œè¿ç»­çš„ read æ“ä½œä¹Ÿåˆå¹¶äº†ä¸€æ ·ã€‚


![](https://user-gold-cdn.xitu.io/2018/7/10/1648209937f6d508?w=732&h=207&f=png&s=16994)

è¿™ä¾¿æ˜¯ç®¡é“æ“ä½œçš„æœ¬è´¨ï¼ŒæœåŠ¡å™¨æ ¹æœ¬æ²¡æœ‰ä»»ä½•åŒºåˆ«å¯¹å¾…ï¼Œè¿˜æ˜¯æ”¶åˆ°ä¸€æ¡æ¶ˆæ¯ï¼Œæ‰§è¡Œä¸€æ¡æ¶ˆæ¯ï¼Œå›å¤ä¸€æ¡æ¶ˆæ¯çš„æ­£å¸¸çš„æµç¨‹ã€‚å®¢æˆ·ç«¯é€šè¿‡å¯¹ç®¡é“ä¸­çš„æŒ‡ä»¤åˆ—è¡¨æ”¹å˜è¯»å†™é¡ºåºå°±å¯ä»¥å¤§å¹…èŠ‚çœ IO æ—¶é—´ã€‚ç®¡é“ä¸­æŒ‡ä»¤è¶Šå¤šï¼Œæ•ˆæœè¶Šå¥½ã€‚

ç®¡é“å‹åŠ›æµ‹è¯•
--
æ¥ä¸‹æ¥æˆ‘ä»¬å®è·µä¸€ä¸‹ç®¡é“çš„åŠ›é‡ã€‚

Redis è‡ªå¸¦äº†ä¸€ä¸ªå‹åŠ›æµ‹è¯•å·¥å…·```redis-benchmark```ï¼Œä½¿ç”¨è¿™ä¸ªå·¥å…·å°±å¯ä»¥è¿›è¡Œç®¡é“æµ‹è¯•ã€‚

é¦–å…ˆæˆ‘ä»¬å¯¹ä¸€ä¸ªæ™®é€šçš„ set æŒ‡ä»¤è¿›è¡Œå‹æµ‹ï¼ŒQPS å¤§çº¦ 5w/sã€‚
```
> redis-benchmark -t set -q
SET: 51975.05 requests per second
```
æˆ‘ä»¬åŠ å…¥ç®¡é“é€‰é¡¹```-P```å‚æ•°ï¼Œå®ƒè¡¨ç¤ºå•ä¸ªç®¡é“å†…å¹¶è¡Œçš„è¯·æ±‚æ•°é‡ï¼Œçœ‹ä¸‹é¢```P=2```ï¼ŒQPS è¾¾åˆ°äº† 9w/sã€‚
```
> redis-benchmark -t set -P 2 -q
SET: 91240.88 requests per second
```
å†çœ‹çœ‹```P=3```ï¼ŒQPS è¾¾åˆ°äº† 10w/sã€‚
```
SET: 102354.15 requests per second
```
ä½†å¦‚æœå†ç»§ç»­æå‡ P å‚æ•°ï¼Œå‘ç° QPS å·²ç»ä¸Šä¸å»äº†ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

å› ä¸ºè¿™é‡Œ CPU å¤„ç†èƒ½åŠ›å·²ç»è¾¾åˆ°äº†ç“¶é¢ˆï¼ŒRedis çš„å•çº¿ç¨‹ CPU å·²ç»é£™åˆ°äº† 100%ï¼Œæ‰€ä»¥æ— æ³•å†ç»§ç»­æå‡äº†ã€‚

æ·±å…¥ç†è§£ç®¡é“æœ¬è´¨
--
æ¥ä¸‹æ¥æˆ‘ä»¬æ·±å…¥åˆ†æä¸€ä¸ªè¯·æ±‚äº¤äº’çš„æµç¨‹ï¼ŒçœŸå®çš„æƒ…å†µæ˜¯å®ƒå¾ˆå¤æ‚ï¼Œå› ä¸ºè¦ç»è¿‡ç½‘ç»œåè®®æ ˆï¼Œè¿™ä¸ªå°±å¾—æ·±å…¥å†…æ ¸äº†ã€‚


![](https://user-gold-cdn.xitu.io/2018/8/28/1657e7a5a0a24ce3?w=1850&h=894&f=png&s=194143)

ä¸Šå›¾å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚äº¤äº’æµç¨‹å›¾ã€‚æˆ‘ç”¨æ–‡å­—æ¥ä»”ç»†æè¿°ä¸€éï¼š
1. å®¢æˆ·ç«¯è¿›ç¨‹è°ƒç”¨```write```å°†æ¶ˆæ¯å†™åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„å‘é€ç¼“å†²```send buffer```ã€‚
2. å®¢æˆ·ç«¯æ“ä½œç³»ç»Ÿå†…æ ¸å°†å‘é€ç¼“å†²çš„å†…å®¹å‘é€åˆ°ç½‘å¡ï¼Œç½‘å¡ç¡¬ä»¶å°†æ•°æ®é€šè¿‡ã€Œç½‘é™…è·¯ç”±ã€é€åˆ°æœåŠ¡å™¨çš„ç½‘å¡ã€‚
3. æœåŠ¡å™¨æ“ä½œç³»ç»Ÿå†…æ ¸å°†ç½‘å¡çš„æ•°æ®æ”¾åˆ°å†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„æ¥æ”¶ç¼“å†²```recv buffer```ã€‚
4. æœåŠ¡å™¨è¿›ç¨‹è°ƒç”¨```read```ä»æ¥æ”¶ç¼“å†²ä¸­å–å‡ºæ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚
5. æœåŠ¡å™¨è¿›ç¨‹è°ƒç”¨```write```å°†å“åº”æ¶ˆæ¯å†™åˆ°å†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„å‘é€ç¼“å†²```send buffer```ã€‚
6. æœåŠ¡å™¨æ“ä½œç³»ç»Ÿå†…æ ¸å°†å‘é€ç¼“å†²çš„å†…å®¹å‘é€åˆ°ç½‘å¡ï¼Œç½‘å¡ç¡¬ä»¶å°†æ•°æ®é€šè¿‡ã€Œç½‘é™…è·¯ç”±ã€é€åˆ°å®¢æˆ·ç«¯çš„ç½‘å¡ã€‚
7. å®¢æˆ·ç«¯æ“ä½œç³»ç»Ÿå†…æ ¸å°†ç½‘å¡çš„æ•°æ®æ”¾åˆ°å†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„æ¥æ”¶ç¼“å†²```recv buffer```ã€‚
8. å®¢æˆ·ç«¯è¿›ç¨‹è°ƒç”¨```read```ä»æ¥æ”¶ç¼“å†²ä¸­å–å‡ºæ¶ˆæ¯è¿”å›ç»™ä¸Šå±‚ä¸šåŠ¡é€»è¾‘è¿›è¡Œå¤„ç†ã€‚
9. ç»“æŸã€‚

å…¶ä¸­æ­¥éª¤ 5~8 å’Œ 1~4 æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡æ–¹å‘æ˜¯åè¿‡æ¥çš„ï¼Œä¸€ä¸ªæ˜¯è¯·æ±‚ï¼Œä¸€ä¸ªæ˜¯å“åº”ã€‚

æˆ‘ä»¬å¼€å§‹ä»¥ä¸º `write` æ“ä½œæ˜¯è¦ç­‰åˆ°å¯¹æ–¹æ”¶åˆ°æ¶ˆæ¯æ‰ä¼šè¿”å›ï¼Œä½†å®é™…ä¸Šä¸æ˜¯è¿™æ ·çš„ã€‚`write` æ“ä½œåªè´Ÿè´£å°†æ•°æ®å†™åˆ°æœ¬åœ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„å‘é€ç¼“å†²ç„¶åå°±è¿”å›äº†ã€‚å‰©ä¸‹çš„äº‹äº¤ç»™æ“ä½œç³»ç»Ÿå†…æ ¸å¼‚æ­¥å°†æ•°æ®é€åˆ°ç›®æ ‡æœºå™¨ã€‚ä½†æ˜¯å¦‚æœå‘é€ç¼“å†²æ»¡äº†ï¼Œé‚£ä¹ˆå°±éœ€è¦ç­‰å¾…ç¼“å†²ç©ºå‡ºç©ºé—²ç©ºé—´æ¥ï¼Œè¿™ä¸ªå°±æ˜¯å†™æ“ä½œ IO æ“ä½œçš„çœŸæ­£è€—æ—¶ã€‚

æˆ‘ä»¬å¼€å§‹ä»¥ä¸º `read` æ“ä½œæ˜¯ä»ç›®æ ‡æœºå™¨æ‹‰å–æ•°æ®ï¼Œä½†å®é™…ä¸Šä¸æ˜¯è¿™æ ·çš„ã€‚`read` æ“ä½œåªè´Ÿè´£å°†æ•°æ®ä»æœ¬åœ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„æ¥æ”¶ç¼“å†²ä¸­å–å‡ºæ¥å°±äº†äº‹äº†ã€‚ä½†æ˜¯å¦‚æœç¼“å†²æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆå°±éœ€è¦ç­‰å¾…æ•°æ®åˆ°æ¥ï¼Œè¿™ä¸ªå°±æ˜¯è¯»æ“ä½œ IO æ“ä½œçš„çœŸæ­£è€—æ—¶ã€‚

æ‰€ä»¥å¯¹äº```value = redis.get(key)```è¿™æ ·ä¸€ä¸ªç®€å•çš„è¯·æ±‚æ¥è¯´ï¼Œ```write```æ“ä½œå‡ ä¹æ²¡æœ‰è€—æ—¶ï¼Œç›´æ¥å†™åˆ°å‘é€ç¼“å†²å°±è¿”å›ï¼Œè€Œ```read```å°±ä¼šæ¯”è¾ƒè€—æ—¶äº†ï¼Œå› ä¸ºå®ƒè¦ç­‰å¾…æ¶ˆæ¯ç»è¿‡ç½‘ç»œè·¯ç”±åˆ°ç›®æ ‡æœºå™¨å¤„ç†åçš„å“åº”æ¶ˆæ¯,å†å›é€åˆ°å½“å‰çš„å†…æ ¸è¯»ç¼“å†²æ‰å¯ä»¥è¿”å›ã€‚**è¿™æ‰æ˜¯ä¸€ä¸ªç½‘ç»œæ¥å›çš„çœŸæ­£å¼€é”€**ã€‚

è€Œå¯¹äºç®¡é“æ¥è¯´ï¼Œè¿ç»­çš„```write```æ“ä½œæ ¹æœ¬å°±æ²¡æœ‰è€—æ—¶ï¼Œä¹‹åç¬¬ä¸€ä¸ª```read```æ“ä½œä¼šç­‰å¾…ä¸€ä¸ªç½‘ç»œçš„æ¥å›å¼€é”€ï¼Œç„¶åæ‰€æœ‰çš„å“åº”æ¶ˆæ¯å°±éƒ½å·²ç»å›é€åˆ°å†…æ ¸çš„è¯»ç¼“å†²äº†ï¼Œåç»­çš„ `read` æ“ä½œç›´æ¥å°±å¯ä»¥ä»ç¼“å†²æ‹¿åˆ°ç»“æœï¼Œç¬é—´å°±è¿”å›äº†ã€‚

## å°ç»“

è¿™å°±æ˜¯ç®¡é“çš„æœ¬è´¨äº†ï¼Œå®ƒå¹¶ä¸æ˜¯æœåŠ¡å™¨çš„ä»€ä¹ˆç‰¹æ€§ï¼Œè€Œæ˜¯å®¢æˆ·ç«¯é€šè¿‡æ”¹å˜äº†è¯»å†™çš„é¡ºåºå¸¦æ¥çš„æ€§èƒ½çš„å·¨å¤§æå‡ã€‚
# åŸç† 5ï¼šåŒèˆŸå…±æµ â€”â€” äº‹åŠ¡

ä¸ºäº†ç¡®ä¿è¿ç»­å¤šä¸ªæ“ä½œçš„åŸå­æ€§ï¼Œä¸€ä¸ªæˆç†Ÿçš„æ•°æ®åº“é€šå¸¸éƒ½ä¼šæœ‰äº‹åŠ¡æ”¯æŒï¼ŒRedis ä¹Ÿä¸ä¾‹å¤–ã€‚Redis çš„äº‹åŠ¡ä½¿ç”¨éå¸¸ç®€å•ï¼Œä¸åŒäºå…³ç³»æ•°æ®åº“ï¼Œæˆ‘ä»¬æ— é¡»ç†è§£é‚£ä¹ˆå¤šå¤æ‚çš„äº‹åŠ¡æ¨¡å‹ï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚ä¸è¿‡ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™ç§ç®€å•æ€§ï¼Œå®ƒçš„äº‹åŠ¡æ¨¡å‹å¾ˆä¸ä¸¥æ ¼ï¼Œè¿™è¦æ±‚æˆ‘ä»¬ä¸èƒ½åƒä½¿ç”¨å…³ç³»æ•°æ®åº“çš„äº‹åŠ¡ä¸€æ ·æ¥ä½¿ç”¨ Redisã€‚

Redis äº‹åŠ¡çš„åŸºæœ¬ä½¿ç”¨
--
æ¯ä¸ªäº‹åŠ¡çš„æ“ä½œéƒ½æœ‰ beginã€commit å’Œ rollbackï¼Œbegin æŒ‡ç¤ºäº‹åŠ¡çš„å¼€å§‹ï¼Œcommit æŒ‡ç¤ºäº‹åŠ¡çš„æäº¤ï¼Œrollback æŒ‡ç¤ºäº‹åŠ¡çš„å›æ»šã€‚å®ƒå¤§è‡´çš„å½¢å¼å¦‚ä¸‹ã€‚
```java
begin();
try {
    command1();
    command2();
    ....
    commit();
} catch(Exception e) {
    rollback();
}
```
Redis åœ¨å½¢å¼ä¸Šçœ‹èµ·æ¥ä¹Ÿå·®ä¸å¤šï¼Œåˆ†åˆ«æ˜¯ multi/exec/discardã€‚multi æŒ‡ç¤ºäº‹åŠ¡çš„å¼€å§‹ï¼Œexec æŒ‡ç¤ºäº‹åŠ¡çš„æ‰§è¡Œï¼Œdiscard æŒ‡ç¤ºäº‹åŠ¡çš„ä¸¢å¼ƒã€‚
```
> multi
OK
> incr books
QUEUED
> incr books
QUEUED
> exec
(integer) 1
(integer) 2
```
ä¸Šé¢çš„æŒ‡ä»¤æ¼”ç¤ºäº†ä¸€ä¸ªå®Œæ•´çš„äº‹åŠ¡è¿‡ç¨‹ï¼Œæ‰€æœ‰çš„æŒ‡ä»¤åœ¨ exec ä¹‹å‰ä¸æ‰§è¡Œï¼Œè€Œæ˜¯ç¼“å­˜åœ¨æœåŠ¡å™¨çš„ä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—ä¸­ï¼ŒæœåŠ¡å™¨ä¸€æ—¦æ”¶åˆ° exec æŒ‡ä»¤ï¼Œæ‰å¼€æ‰§è¡Œæ•´ä¸ªäº‹åŠ¡é˜Ÿåˆ—ï¼Œæ‰§è¡Œå®Œæ¯•åä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰æŒ‡ä»¤çš„è¿è¡Œç»“æœã€‚å› ä¸º Redis çš„å•çº¿ç¨‹ç‰¹æ€§ï¼Œå®ƒä¸ç”¨æ‹…å¿ƒè‡ªå·±åœ¨æ‰§è¡Œé˜Ÿåˆ—çš„æ—¶å€™è¢«å…¶å®ƒæŒ‡ä»¤æ‰“æ…ï¼Œå¯ä»¥ä¿è¯ä»–ä»¬èƒ½å¾—åˆ°çš„ã€ŒåŸå­æ€§ã€æ‰§è¡Œã€‚

![](https://user-gold-cdn.xitu.io/2018/7/10/1648203d1d8ec347?w=810&h=386&f=png&s=26366)
ä¸Šå›¾æ˜¾ç¤ºäº†ä»¥ä¸Šäº‹åŠ¡è¿‡ç¨‹å®Œæ•´çš„äº¤äº’æ•ˆæœã€‚QUEUED æ˜¯ä¸€ä¸ªç®€å•å­—ç¬¦ä¸²ï¼ŒåŒ OK æ˜¯ä¸€ä¸ªå½¢å¼ï¼Œå®ƒè¡¨ç¤ºæŒ‡ä»¤å·²ç»è¢«æœåŠ¡å™¨ç¼“å­˜åˆ°é˜Ÿåˆ—é‡Œäº†ã€‚

åŸå­æ€§
--
äº‹åŠ¡çš„åŸå­æ€§æ˜¯æŒ‡è¦ä¹ˆäº‹åŠ¡å…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œé‚£ä¹ˆ Redis äº‹åŠ¡æ‰§è¡Œæ˜¯åŸå­æ€§çš„ä¹ˆï¼Ÿ

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç‰¹åˆ«çš„ä¾‹å­ã€‚
```
> multi
OK
> set books iamastring
QUEUED
> incr books
QUEUED
> set poorman iamdesperate
QUEUED
> exec
1) OK
2) (error) ERR value is not an integer or out of range
3) OK
> get books
"iamastring"
>  get poorman
"iamdesperate
```
ä¸Šé¢çš„ä¾‹å­æ˜¯äº‹åŠ¡æ‰§è¡Œåˆ°ä¸­é—´é‡åˆ°å¤±è´¥äº†ï¼Œå› ä¸ºæˆ‘ä»¬ä¸èƒ½å¯¹ä¸€ä¸ªå­—ç¬¦ä¸²è¿›è¡Œæ•°å­¦è¿ç®—ï¼Œäº‹åŠ¡åœ¨é‡åˆ°æŒ‡ä»¤æ‰§è¡Œå¤±è´¥åï¼Œåé¢çš„æŒ‡ä»¤è¿˜ç»§ç»­æ‰§è¡Œï¼Œæ‰€ä»¥ poorman çš„å€¼èƒ½ç»§ç»­å¾—åˆ°è®¾ç½®ã€‚

åˆ°è¿™é‡Œï¼Œä½ åº”è¯¥æ˜ç™½ Redis çš„äº‹åŠ¡æ ¹æœ¬ä¸èƒ½ç®—ã€ŒåŸå­æ€§ã€ï¼Œè€Œä»…ä»…æ˜¯æ»¡è¶³äº†äº‹åŠ¡çš„ã€Œéš”ç¦»æ€§ã€ï¼Œéš”ç¦»æ€§ä¸­çš„ä¸²è¡ŒåŒ–â€”â€”å½“å‰æ‰§è¡Œçš„äº‹åŠ¡æœ‰ç€ä¸è¢«å…¶å®ƒäº‹åŠ¡æ‰“æ–­çš„æƒåˆ©ã€‚

discard(ä¸¢å¼ƒ)
--
Redis ä¸ºäº‹åŠ¡æä¾›äº†ä¸€ä¸ª discard æŒ‡ä»¤ï¼Œç”¨äºä¸¢å¼ƒäº‹åŠ¡ç¼“å­˜é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æŒ‡ä»¤ï¼Œåœ¨ exec æ‰§è¡Œä¹‹å‰ã€‚
```
> get books
(nil)
> multi
OK
> incr books
QUEUED
> incr books
QUEUED
> discard
OK
> get books
(nil)
```
æˆ‘ä»¬å¯ä»¥çœ‹åˆ° discard ä¹‹åï¼Œé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æŒ‡ä»¤éƒ½æ²¡æ‰§è¡Œï¼Œå°±å¥½åƒ multi å’Œ discard ä¸­é—´çš„æ‰€æœ‰æŒ‡ä»¤ä»æœªå‘ç”Ÿè¿‡ä¸€æ ·ã€‚

ä¼˜åŒ–
--
ä¸Šé¢çš„ Redis äº‹åŠ¡åœ¨å‘é€æ¯ä¸ªæŒ‡ä»¤åˆ°äº‹åŠ¡ç¼“å­˜é˜Ÿåˆ—æ—¶éƒ½è¦ç»è¿‡ä¸€æ¬¡ç½‘ç»œè¯»å†™ï¼Œå½“ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨çš„æŒ‡ä»¤è¾ƒå¤šæ—¶ï¼Œéœ€è¦çš„ç½‘ç»œ IO æ—¶é—´ä¹Ÿä¼šçº¿æ€§å¢é•¿ã€‚æ‰€ä»¥é€šå¸¸ Redis çš„å®¢æˆ·ç«¯åœ¨æ‰§è¡Œäº‹åŠ¡æ—¶éƒ½ä¼šç»“åˆ pipeline ä¸€èµ·ä½¿ç”¨ï¼Œè¿™æ ·å¯ä»¥å°†å¤šæ¬¡ IO æ“ä½œå‹ç¼©ä¸ºå•æ¬¡ IO æ“ä½œã€‚æ¯”å¦‚æˆ‘ä»¬åœ¨ä½¿ç”¨ Python çš„ Redis å®¢æˆ·ç«¯æ—¶æ‰§è¡Œäº‹åŠ¡æ—¶æ˜¯è¦å¼ºåˆ¶ä½¿ç”¨ pipeline çš„ã€‚
```py
pipe = redis.pipeline(transaction=true)
pipe.multi()
pipe.incr("books")
pipe.incr("books")
values = pipe.execute()
```

Watch
--
è€ƒè™‘åˆ°ä¸€ä¸ªä¸šåŠ¡åœºæ™¯ï¼ŒRedis å­˜å‚¨äº†æˆ‘ä»¬çš„è´¦æˆ·ä½™é¢æ•°æ®ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ•´æ•°ã€‚ç°åœ¨æœ‰ä¸¤ä¸ªå¹¶å‘çš„å®¢æˆ·ç«¯è¦å¯¹è´¦æˆ·ä½™é¢è¿›è¡Œä¿®æ”¹æ“ä½œï¼Œè¿™ä¸ªä¿®æ”¹ä¸æ˜¯ä¸€ä¸ªç®€å•çš„ incrby æŒ‡ä»¤ï¼Œè€Œæ˜¯è¦å¯¹ä½™é¢ä¹˜ä»¥ä¸€ä¸ªå€æ•°ã€‚Redis å¯æ²¡æœ‰æä¾› multiplyby è¿™æ ·çš„æŒ‡ä»¤ã€‚æˆ‘ä»¬éœ€è¦å…ˆå–å‡ºä½™é¢ç„¶ååœ¨å†…å­˜é‡Œä¹˜ä»¥å€æ•°ï¼Œå†å°†ç»“æœå†™å› Redisã€‚

è¿™å°±ä¼šå‡ºç°å¹¶å‘é—®é¢˜ï¼Œå› ä¸ºæœ‰å¤šä¸ªå®¢æˆ·ç«¯ä¼šå¹¶å‘è¿›è¡Œæ“ä½œã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ Redis çš„åˆ†å¸ƒå¼é”æ¥é¿å…å†²çªï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆã€‚**åˆ†å¸ƒå¼é”æ˜¯ä¸€ç§æ‚²è§‚é”ï¼Œé‚£æ˜¯ä¸æ˜¯å¯ä»¥ä½¿ç”¨ä¹è§‚é”çš„æ–¹å¼æ¥è§£å†³å†²çªå‘¢ï¼Ÿ**

Redis æä¾›äº†è¿™ç§ watch çš„æœºåˆ¶ï¼Œå®ƒå°±æ˜¯ä¸€ç§ä¹è§‚é”ã€‚æœ‰äº† watch æˆ‘ä»¬åˆå¤šäº†ä¸€ç§å¯ä»¥ç”¨æ¥è§£å†³å¹¶å‘ä¿®æ”¹çš„æ–¹æ³•ã€‚
watch çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š
```py
while True:
    do_watch()
    commands()
    multi()
    send_commands()
    try:
        exec()
        break
    except WatchError:
        continue
```
watch ä¼šåœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰ç›¯ä½ 1 ä¸ªæˆ–å¤šä¸ªå…³é”®å˜é‡ï¼Œå½“äº‹åŠ¡æ‰§è¡Œæ—¶ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡å™¨æ”¶åˆ°äº† exec æŒ‡ä»¤è¦é¡ºåºæ‰§è¡Œç¼“å­˜çš„äº‹åŠ¡é˜Ÿåˆ—æ—¶ï¼ŒRedis ä¼šæ£€æŸ¥å…³é”®å˜é‡è‡ª watch ä¹‹åï¼Œæ˜¯å¦è¢«ä¿®æ”¹äº† (åŒ…æ‹¬å½“å‰äº‹åŠ¡æ‰€åœ¨çš„å®¢æˆ·ç«¯)ã€‚å¦‚æœå…³é”®å˜é‡è¢«äººåŠ¨è¿‡äº†ï¼Œexec æŒ‡ä»¤å°±ä¼šè¿”å› null å›å¤å‘ŠçŸ¥å®¢æˆ·ç«¯äº‹åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œè¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯ä¸€èˆ¬ä¼šé€‰æ‹©é‡è¯•ã€‚
```
> watch books
OK
> incr books  # è¢«ä¿®æ”¹äº†
(integer) 1
> multi
OK
> incr books
QUEUED
> exec  # äº‹åŠ¡æ‰§è¡Œå¤±è´¥
(nil)
```
å½“æœåŠ¡å™¨ç»™ exec æŒ‡ä»¤è¿”å›ä¸€ä¸ª null å›å¤æ—¶ï¼Œå®¢æˆ·ç«¯çŸ¥é“äº†äº‹åŠ¡æ‰§è¡Œæ˜¯å¤±è´¥çš„ï¼Œé€šå¸¸å®¢æˆ·ç«¯ (redis-py) éƒ½ä¼šæŠ›å‡ºä¸€ä¸ª WatchError è¿™ç§é”™è¯¯ï¼Œä¸è¿‡ä¹Ÿæœ‰äº›è¯­è¨€ (jedis) ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯é€šè¿‡åœ¨ exec æ–¹æ³•é‡Œè¿”å›ä¸€ä¸ª nullï¼Œè¿™æ ·å®¢æˆ·ç«¯éœ€è¦æ£€æŸ¥ä¸€ä¸‹è¿”å›ç»“æœæ˜¯å¦ä¸º null æ¥ç¡®å®šäº‹åŠ¡æ˜¯å¦æ‰§è¡Œå¤±è´¥ã€‚

**æ³¨æ„äº‹é¡¹**

Redis ç¦æ­¢åœ¨ multi å’Œ exec ä¹‹é—´æ‰§è¡Œ watch æŒ‡ä»¤ï¼Œè€Œå¿…é¡»åœ¨ multi ä¹‹å‰åšå¥½ç›¯ä½å…³é”®å˜é‡ï¼Œå¦åˆ™ä¼šå‡ºé”™ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ Python è¯­è¨€æ¥å®ç°å¯¹ä½™é¢çš„åŠ å€æ“ä½œã€‚

```py
# -*- coding: utf-8
import redis

def key_for(user_id):
    return "account_{}".format(user_id)

def double_account(client, user_id):
    key = key_for(user_id)
    while True:
        client.watch(key)
        value = int(client.get(key))
        value *= 2  # åŠ å€
        pipe = client.pipeline(transaction=True)
        pipe.multi()
        pipe.set(key, value)
        try:
            pipe.execute()
            break  # æ€»ç®—æˆåŠŸäº†
        except redis.WatchError:
            continue  # äº‹åŠ¡è¢«æ‰“æ–­äº†ï¼Œé‡è¯•
    return int(client.get(key))  # é‡æ–°è·å–ä½™é¢

client = redis.StrictRedis()
user_id = "abc"
client.setnx(key_for(user_id), 5)  # setnx åšåˆå§‹åŒ–
print double_account(client, user_id)
```

ä¸‹é¢æˆ‘ä»¬å†ä½¿ç”¨ Java è¯­è¨€å®ç°ä¸€éã€‚

```java
import java.util.List;
import redis.clients.jedis.Jedis;
import redis.clients.jedis.Transaction;

public class TransactionDemo {

  public static void main(String[] args) {
    Jedis jedis = new Jedis();
    String userId = "abc";
    String key = keyFor(userId);
    jedis.setnx(key, String.valueOf(5));  # setnx åšåˆå§‹åŒ–
    System.out.println(doubleAccount(jedis, userId));
    jedis.close();
  }

  public static int doubleAccount(Jedis jedis, String userId) {
    String key = keyFor(userId);
    while (true) {
      jedis.watch(key);
      int value = Integer.parseInt(jedis.get(key));
      value *= 2; // åŠ å€
      Transaction tx = jedis.multi();
      tx.set(key, String.valueOf(value));
      List<Object> res = tx.exec();
      if (res != null) {
        break; // æˆåŠŸäº†
      }
    }
    return Integer.parseInt(jedis.get(key)); // é‡æ–°è·å–ä½™é¢
  }

  public static String keyFor(String userId) {
    return String.format("account_%s", userId);
  }

}
```

æˆ‘ä»¬å¸¸å¸¸å¬è¯´ Python çš„ä»£ç è¦æ¯” Java ç®€çŸ­å¤ªå¤šï¼Œä½†æ˜¯ä»è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬çœ‹åˆ° Java çš„ä»£ç æ¯” python çš„ä»£ç ä¹Ÿå¤šä¸äº†å¤šå°‘ï¼Œå¤§çº¦åªå¤šå‡º 50%ã€‚

## æ€è€ƒé¢˜

ä¸ºä»€ä¹ˆ Redis çš„äº‹åŠ¡ä¸èƒ½æ”¯æŒå›æ»šï¼Ÿ
# åŸç† 6ï¼šå°é“æ¶ˆæ¯ â€”â€” PubSub

å‰é¢æˆ‘ä»¬è®²äº† Redis æ¶ˆæ¯é˜Ÿåˆ—çš„ä½¿ç”¨æ–¹æ³•ï¼Œä½†æ˜¯æ²¡æœ‰æåˆ° **Redis æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸è¶³ä¹‹å¤„ï¼Œé‚£å°±æ˜¯å®ƒä¸æ”¯æŒæ¶ˆæ¯çš„å¤šæ’­æœºåˆ¶**ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/10/16481fd5b8bff9d0?w=927&h=284&f=png&s=32458)

## æ¶ˆæ¯å¤šæ’­

æ¶ˆæ¯å¤šæ’­å…è®¸ç”Ÿäº§è€…ç”Ÿäº§ä¸€æ¬¡æ¶ˆæ¯ï¼Œä¸­é—´ä»¶è´Ÿè´£å°†æ¶ˆæ¯å¤åˆ¶åˆ°å¤šä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ç”±ç›¸åº”çš„æ¶ˆè´¹ç»„è¿›è¡Œæ¶ˆè´¹ã€‚å®ƒæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿå¸¸ç”¨çš„ä¸€ç§è§£è€¦æ–¹å¼ï¼Œç”¨äºå°†å¤šä¸ªæ¶ˆè´¹ç»„çš„é€»è¾‘è¿›è¡Œæ‹†åˆ†ã€‚æ”¯æŒäº†æ¶ˆæ¯å¤šæ’­ï¼Œå¤šä¸ªæ¶ˆè´¹ç»„çš„é€»è¾‘å°±å¯ä»¥æ”¾åˆ°ä¸åŒçš„å­ç³»ç»Ÿä¸­ã€‚

å¦‚æœæ˜¯æ™®é€šçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå°±å¾—å°†å¤šä¸ªä¸åŒçš„æ¶ˆè´¹ç»„é€»è¾‘ä¸²æ¥èµ·æ¥æ”¾åœ¨ä¸€ä¸ªå­ç³»ç»Ÿä¸­ï¼Œè¿›è¡Œè¿ç»­æ¶ˆè´¹ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/10/16481fe345c36b70?w=857&h=142&f=png&s=16701)

PubSub
--
ä¸ºäº†æ”¯æŒæ¶ˆæ¯å¤šæ’­ï¼ŒRedis ä¸èƒ½å†ä¾èµ–äºé‚£ 5 ç§åŸºæœ¬æ•°æ®ç±»å‹äº†ã€‚å®ƒå•ç‹¬ä½¿ç”¨äº†ä¸€ä¸ªæ¨¡å—æ¥æ”¯æŒæ¶ˆæ¯å¤šæ’­ï¼Œè¿™ä¸ªæ¨¡å—çš„åå­—å«ç€ PubSubï¼Œä¹Ÿå°±æ˜¯ PublisherSubscriberï¼Œå‘å¸ƒè€…è®¢é˜…è€…æ¨¡å‹ã€‚æˆ‘ä»¬ä½¿ç”¨ Python è¯­è¨€æ¥æ¼”ç¤ºä¸€ä¸‹ PubSub å¦‚ä½•ä½¿ç”¨ã€‚
```python
# -*- coding: utf-8 -*-
import time
import redis

client = redis.StrictRedis()
p = client.pubsub()
p.subscribe("codehole")
time.sleep(1)
print p.get_message()
client.publish("codehole", "java comes")
time.sleep(1)
print p.get_message()
client.publish("codehole", "python comes")
time.sleep(1)
print p.get_message()
print p.get_message()
```
```
{'pattern': None, 'type': 'subscribe', 'channel': 'codehole', 'data': 1L}
{'pattern': None, 'type': 'message', 'channel': 'codehole', 'data': 'java comes'}
{'pattern': None, 'type': 'message', 'channel': 'codehole', 'data': 'python comes'}
None
```

![](https://user-gold-cdn.xitu.io/2018/7/10/164820151073c5ce?w=730&h=316&f=png&s=22845)
å®¢æˆ·ç«¯å‘èµ·è®¢é˜…å‘½ä»¤åï¼ŒRedis ä¼šç«‹å³ç»™äºˆä¸€ä¸ªåé¦ˆæ¶ˆæ¯é€šçŸ¥è®¢é˜…æˆåŠŸã€‚å› ä¸ºæœ‰ç½‘ç»œä¼ è¾“å»¶è¿Ÿï¼Œåœ¨ `subscribe` å‘½ä»¤å‘å‡ºåï¼Œéœ€è¦ä¼‘çœ ä¸€ä¼šï¼Œå†é€šè¿‡ `get\_message` æ‰èƒ½æ‹¿åˆ°åé¦ˆæ¶ˆæ¯ã€‚å®¢æˆ·ç«¯æ¥ä¸‹æ¥æ‰§è¡Œå‘å¸ƒå‘½ä»¤ï¼Œå‘å¸ƒäº†ä¸€æ¡æ¶ˆæ¯ã€‚åŒæ ·å› ä¸ºç½‘ç»œå»¶è¿Ÿï¼Œåœ¨ `publish` å‘½ä»¤å‘å‡ºåï¼Œéœ€è¦ä¼‘çœ ä¸€ä¼šï¼Œå†é€šè¿‡ `get\_message` æ‰èƒ½æ‹¿åˆ°å‘å¸ƒçš„æ¶ˆæ¯ã€‚å¦‚æœå½“å‰æ²¡æœ‰æ¶ˆæ¯ï¼Œ`get\_message` ä¼šè¿”å›ç©ºï¼Œå‘ŠçŸ¥å½“å‰æ²¡æœ‰æ¶ˆæ¯ï¼Œæ‰€ä»¥å®ƒä¸æ˜¯é˜»å¡çš„ã€‚

Redis PubSub çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ˜¯ä¸åŒçš„è¿æ¥ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢è¿™ä¸ªä¾‹å­å®é™…ä¸Šä½¿ç”¨äº†ä¸¤ä¸ª Redis çš„è¿æ¥ã€‚è¿™æ˜¯å¿…é¡»çš„ï¼Œå› ä¸º Redis ä¸å…è®¸è¿æ¥åœ¨ subscribe ç­‰å¾…æ¶ˆæ¯æ—¶è¿˜è¦è¿›è¡Œå…¶å®ƒçš„æ“ä½œã€‚

**åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¾ˆå°‘å°†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ”¾åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œ**ã€‚å¦‚æœå®ƒä»¬çœŸè¦åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œï¼Œä½•å¿…é€šè¿‡ä¸­é—´ä»¶æ¥æµè½¬ï¼Œç›´æ¥ä½¿ç”¨å‡½æ•°è°ƒç”¨å°±è¡Œã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å°†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…åˆ†ç¦»ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹åˆ†ç¦»åçš„ä»£ç è¦æ€ä¹ˆå†™ã€‚

**æ¶ˆè´¹è€…**
```py
# -*- coding: utf-8 -*-
import time
import redis

client = redis.StrictRedis()
p = client.pubsub()
p.subscribe("codehole")
while True:
    msg = p.get_message()
    if not msg:
        time.sleep(1)
        continue
    print msg
```
**ç”Ÿäº§è€…**
```py
# -*- coding: utf-8 -*-
import redis

client = redis.StrictRedis()
client.publish("codehole", "python comes")
client.publish("codehole", "java comes")
client.publish("codehole", "golang comes")
```
å¿…é¡»å…ˆå¯åŠ¨æ¶ˆè´¹è€…ï¼Œç„¶åå†æ‰§è¡Œç”Ÿäº§è€…ï¼Œæ¶ˆè´¹è€…æˆ‘ä»¬å¯ä»¥å¯åŠ¨å¤šä¸ªï¼Œpubsub ä¼šä¿è¯å®ƒä»¬æ”¶åˆ°çš„æ˜¯ç›¸åŒçš„æ¶ˆæ¯åºåˆ—ã€‚
```
{'pattern': None, 'type': 'subscribe', 'channel': 'codehole', 'data': 1L}
{'pattern': None, 'type': 'message', 'channel': 'codehole', 'data': 'python comes'}
{'pattern': None, 'type': 'message', 'channel': 'codehole', 'data': 'java comes'}
{'pattern': None, 'type': 'message', 'channel': 'codehole', 'data': 'golang comes'}
```
æˆ‘ä»¬ä»æ¶ˆè´¹è€…çš„æ§åˆ¶å°çª—å£å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„è¾“å‡ºï¼Œæ¯ä¸ªæ¶ˆè´¹è€…çª—å£éƒ½æ˜¯åŒæ ·çš„è¾“å‡ºã€‚ç¬¬ä¸€è¡Œæ˜¯è®¢é˜…æˆåŠŸæ¶ˆæ¯ï¼Œå®ƒå¾ˆå¿«å°±ä¼šè¾“å‡ºï¼Œåé¢çš„ä¸‰è¡Œä¼šåœ¨ç”Ÿäº§è€…è¿›ç¨‹æ‰§è¡Œçš„æ—¶å€™ç«‹å³è¾“å‡ºã€‚
ä¸Šé¢çš„æ¶ˆè´¹è€…æ˜¯é€šè¿‡è½®è¯¢ `get_message` æ¥æ”¶å–æ¶ˆæ¯çš„ï¼Œå¦‚æœæ”¶å–ä¸åˆ°å°±ä¼‘çœ  1sã€‚è¿™è®©æˆ‘ä»¬æƒ³èµ·äº†ç¬¬ 3 èŠ‚çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ blpop æ¥ä»£æ›¿ä¼‘çœ æ¥æé«˜æ¶ˆæ¯å¤„ç†çš„åŠæ—¶æ€§ã€‚

PubSub çš„æ¶ˆè´¹è€…å¦‚æœä½¿ç”¨ä¼‘çœ çš„æ–¹å¼æ¥è½®è¯¢æ¶ˆæ¯ï¼Œä¹Ÿä¼šé­é‡æ¶ˆæ¯å¤„ç†ä¸åŠæ—¶çš„é—®é¢˜ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ listen æ¥é˜»å¡ç›‘å¬æ¶ˆæ¯æ¥è¿›è¡Œå¤„ç†ï¼Œè¿™ç‚¹åŒ blpop åŸç†æ˜¯ä¸€æ ·çš„ã€‚ä¸‹é¢æˆ‘ä»¬æ”¹é€ ä¸€ä¸‹æ¶ˆè´¹è€…

**é˜»å¡æ¶ˆè´¹è€…**
```py
# -*- coding: utf-8 -*-
import time
import redis

client = redis.StrictRedis()
p = client.pubsub()
p.subscribe("codehole")
for msg in p.listen():
    print msg
```
ä»£ç ç®€çŸ­äº†å¾ˆå¤šï¼Œä¸éœ€è¦å†ä¼‘çœ äº†ï¼Œæ¶ˆæ¯å¤„ç†ä¹ŸåŠæ—¶äº†ã€‚

æ¨¡å¼è®¢é˜…
--
ä¸Šé¢æåˆ°çš„è®¢é˜…æ¨¡å¼æ˜¯åŸºäºåç§°è®¢é˜…çš„ï¼Œæ¶ˆè´¹è€…è®¢é˜…ä¸€ä¸ªä¸»é¢˜æ˜¯å¿…é¡»æ˜ç¡®æŒ‡å®šä¸»é¢˜çš„åç§°ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦è®¢é˜…å¤šä¸ªä¸»é¢˜ï¼Œé‚£å°± subscribe å¤šä¸ªåç§°ã€‚
```sh
> subscribe codehole.image codehole.text codehole.blog  # åŒæ—¶è®¢é˜…ä¸‰ä¸ªä¸»é¢˜ï¼Œä¼šæœ‰ä¸‰æ¡è®¢é˜…æˆåŠŸåé¦ˆä¿¡æ¯
1) "subscribe"
2) "codehole.image"
3) (integer) 1
1) "subscribe"
2) "codehole.text"
3) (integer) 2
1) "subscribe"
2) "codehole.blog"
3) (integer) 3
```
è¿™æ ·ç”Ÿäº§è€…å‘è¿™ä¸‰ä¸ªä¸»é¢˜å‘å¸ƒçš„æ¶ˆæ¯ï¼Œè¿™ä¸ªæ¶ˆè´¹è€…éƒ½å¯ä»¥æ¥æ”¶åˆ°ã€‚
```sh
> publish codehole.image https://www.google.com/dudo.png
(integer) 1
> publish codehole.text " ä½ å¥½ï¼Œæ¬¢è¿åŠ å…¥ç æ´ "
(integer) 1
> publish codehole.blog '{"content": "hello, everyone", "title": "welcome"}'
(integer) 1
```
å¦‚æœç°åœ¨è¦å¢åŠ ä¸€ä¸ªä¸»é¢˜```codehole.group```ï¼Œå®¢æˆ·ç«¯å¿…é¡»ä¹Ÿè·Ÿç€å¢åŠ ä¸€ä¸ªè®¢é˜…æŒ‡ä»¤æ‰å¯ä»¥æ”¶åˆ°æ–°å¼€ä¸»é¢˜çš„æ¶ˆæ¯æ¨é€ã€‚

ä¸ºäº†ç®€åŒ–è®¢é˜…çš„ç¹çï¼Œredis æä¾›äº†æ¨¡å¼è®¢é˜…åŠŸèƒ½```Pattern Subscribe```ï¼Œè¿™æ ·å°±å¯ä»¥ä¸€æ¬¡è®¢é˜…å¤šä¸ªä¸»é¢˜ï¼Œå³ä½¿ç”Ÿäº§è€…æ–°å¢åŠ äº†åŒæ¨¡å¼çš„ä¸»é¢˜ï¼Œæ¶ˆè´¹è€…ä¹Ÿå¯ä»¥ç«‹å³æ”¶åˆ°æ¶ˆæ¯
```
> psubscribe codehole.*  # ç”¨æ¨¡å¼åŒ¹é…ä¸€æ¬¡è®¢é˜…å¤šä¸ªä¸»é¢˜ï¼Œä¸»é¢˜ä»¥ codehole. å­—ç¬¦å¼€å¤´çš„æ¶ˆæ¯éƒ½å¯ä»¥æ”¶åˆ°
1) "psubscribe"
2) "codehole.*"
3) (integer) 1
```


æ¶ˆæ¯ç»“æ„
--
å‰é¢çš„æ¶ˆè´¹è€…æ¶ˆæ¯è¾“å‡ºæ—¶éƒ½æ˜¯ä¸‹é¢çš„è¿™æ ·ä¸€ä¸ªå­—å…¸å½¢å¼
```
{'pattern': None, 'type': 'subscribe', 'channel': 'codehole', 'data': 1L}
{'pattern': None, 'type': 'message', 'channel': 'codehole', 'data': 'python comes'}
{'pattern': None, 'type': 'message', 'channel': 'codehole', 'data': 'java comes'}
{'pattern': None, 'type': 'message', 'channel': 'codehole', 'data': 'golang comes'}
```
é‚£è¿™å‡ ä¸ªå­—æ®µæ˜¯ä»€ä¹ˆå«ä¹‰å‘¢ï¼Ÿ

**data**
è¿™ä¸ªæ¯«æ— ç–‘é—®å°±æ˜¯æ¶ˆæ¯çš„å†…å®¹ï¼Œä¸€ä¸ªå­—ç¬¦ä¸²ã€‚

**channel**
è¿™ä¸ªä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå®ƒè¡¨ç¤ºå½“å‰è®¢é˜…çš„ä¸»é¢˜åç§°ã€‚

**type**
å®ƒè¡¨ç¤ºæ¶ˆæ¯çš„ç±»å‹ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªæ™®é€šçš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆç±»å‹å°±æ˜¯ messageï¼Œå¦‚æœæ˜¯æ§åˆ¶æ¶ˆæ¯ï¼Œæ¯”å¦‚è®¢é˜…æŒ‡ä»¤çš„åé¦ˆï¼Œå®ƒçš„ç±»å‹å°±æ˜¯ subscribeï¼Œå¦‚æœæ˜¯æ¨¡å¼è®¢é˜…çš„åé¦ˆï¼Œå®ƒçš„ç±»å‹å°±æ˜¯ psubscribeï¼Œè¿˜æœ‰å–æ¶ˆè®¢é˜…æŒ‡ä»¤çš„åé¦ˆ unsubscribe å’Œ punsubscribeã€‚

**pattern**
å®ƒè¡¨ç¤ºå½“å‰æ¶ˆæ¯æ˜¯ä½¿ç”¨å“ªç§æ¨¡å¼è®¢é˜…åˆ°çš„ï¼Œå¦‚æœæ˜¯é€šè¿‡ subscribe æŒ‡ä»¤è®¢é˜…çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªå­—æ®µå°±æ˜¯ç©ºã€‚

PubSub ç¼ºç‚¹
--
PubSub çš„ç”Ÿäº§è€…ä¼ é€’è¿‡æ¥ä¸€ä¸ªæ¶ˆæ¯ï¼ŒRedis ä¼šç›´æ¥æ‰¾åˆ°ç›¸åº”çš„æ¶ˆè´¹è€…ä¼ é€’è¿‡å»ã€‚å¦‚æœä¸€ä¸ªæ¶ˆè´¹è€…éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆæ¶ˆæ¯ç›´æ¥ä¸¢å¼ƒã€‚å¦‚æœå¼€å§‹æœ‰ä¸‰ä¸ªæ¶ˆè´¹è€…ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…çªç„¶æŒ‚æ‰äº†ï¼Œç”Ÿäº§è€…ä¼šç»§ç»­å‘é€æ¶ˆæ¯ï¼Œå¦å¤–ä¸¤ä¸ªæ¶ˆè´¹è€…å¯ä»¥æŒç»­æ”¶åˆ°æ¶ˆæ¯ã€‚ä½†æ˜¯æŒ‚æ‰çš„æ¶ˆè´¹è€…é‡æ–°è¿ä¸Šçš„æ—¶å€™ï¼Œè¿™æ–­è¿æœŸé—´ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œå¯¹äºè¿™ä¸ªæ¶ˆè´¹è€…æ¥è¯´å°±æ˜¯å½»åº•ä¸¢å¤±äº†ã€‚

å¦‚æœ Redis åœæœºé‡å¯ï¼ŒPubSub çš„æ¶ˆæ¯æ˜¯ä¸ä¼šæŒä¹…åŒ–çš„ï¼Œæ¯•ç«Ÿ Redis å®•æœºå°±ç›¸å½“äºä¸€ä¸ªæ¶ˆè´¹è€…éƒ½æ²¡æœ‰ï¼Œæ‰€æœ‰çš„æ¶ˆæ¯ç›´æ¥è¢«ä¸¢å¼ƒã€‚

æ­£æ˜¯å› ä¸º PubSub æœ‰è¿™äº›ç¼ºç‚¹ï¼Œå®ƒå‡ ä¹æ‰¾ä¸åˆ°åˆé€‚çš„åº”ç”¨åœºæ™¯ã€‚æ‰€ä»¥ Redis çš„ä½œè€…å•ç‹¬å¼€å¯äº†ä¸€ä¸ªé¡¹ç›® Disque ä¸“é—¨ç”¨æ¥åšå¤šæ’­æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¯¥é¡¹ç›®ç›®å‰æ²¡æœ‰æˆç†Ÿï¼Œä¸€ç›´é•¿æœŸå¤„äº Beta ç‰ˆæœ¬ï¼Œä½†æ˜¯ç›¸åº”çš„å®¢æˆ·ç«¯ sdk å·²ç»éå¸¸ä¸°å¯Œäº†ï¼Œå°±å¾… Redis ä½œè€…ä¸´é—¨ä¸€è„šå‘å¸ƒä¸€ä¸ª Release ç‰ˆæœ¬ã€‚å…³äº Disque çš„æ›´å¤šç»†èŠ‚ï¼Œæœ¬å°å†Œä¸ä¼šå¤šåšè¯¦ç»†ä»‹ç»ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å»é˜…è¯»ç›¸å…³æ–‡æ¡£ã€‚

## è¡¥å……

è¿‘æœŸ Redis5.0 æ–°å¢äº† Stream æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªåŠŸèƒ½ç»™ Redis å¸¦æ¥äº†æŒä¹…åŒ–æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»æ­¤ PubSub å¯ä»¥æ¶ˆå¤±äº†ï¼ŒDisqueue ä¼°è®¡ä¹Ÿæ°¸è¿œå‘ä¸å‡ºå®ƒçš„ Release ç‰ˆæœ¬äº†ã€‚å…·ä½“å†…å®¹è¯·è¯»è€…é˜…è¯» Stream ç« èŠ‚å†…å®¹ï¼ˆç¬¬ 23 èŠ‚ï¼‰ã€‚
# åŸç† 7ï¼šå¼€æºèŠ‚æµ â€”â€” å°å¯¹è±¡å‹ç¼©

Redis æ˜¯ä¸€ä¸ªéå¸¸è€—è´¹å†…å­˜çš„æ•°æ®åº“ï¼Œå®ƒæ‰€æœ‰çš„æ•°æ®éƒ½æ”¾åœ¨å†…å­˜é‡Œã€‚å¦‚æœæˆ‘ä»¬ä¸æ³¨æ„èŠ‚çº¦ä½¿ç”¨å†…å­˜ï¼ŒRedis å°±ä¼šå› ä¸ºæˆ‘ä»¬çš„æ— èŠ‚åˆ¶ä½¿ç”¨å‡ºç°å†…å­˜ä¸è¶³è€Œå´©æºƒã€‚Redis ä½œè€…ä¸ºäº†ä¼˜åŒ–æ•°æ®ç»“æ„çš„å†…å­˜å ç”¨ï¼Œä¹Ÿè‹¦å¿ƒå­¤è¯£å¢åŠ äº†éå¸¸å¤šçš„ä¼˜åŒ–ç‚¹ï¼Œè¿™äº›ä¼˜åŒ–ä¹Ÿæ˜¯ä»¥ç‰ºç‰²ä»£ç çš„å¯è¯»æ€§ä¸ºä»£ä»·çš„ï¼Œä½†æ˜¯æ¯«æ— ç–‘é—®è¿™æ˜¯éå¸¸å€¼å¾—çš„ï¼Œå°¤å…¶åƒ Redis è¿™ç§æ•°æ®åº“ã€‚

32bit vs 64bit
--
Redis å¦‚æœä½¿ç”¨ 32bit è¿›è¡Œç¼–è¯‘ï¼Œå†…éƒ¨æ‰€æœ‰æ•°æ®ç»“æ„æ‰€ä½¿ç”¨çš„æŒ‡é’ˆç©ºé—´å ç”¨ä¼šå°‘ä¸€åŠï¼Œå¦‚æœä½ å¯¹ Redis ä½¿ç”¨å†…å­˜ä¸è¶…è¿‡ 4Gï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ 32bit è¿›è¡Œç¼–è¯‘ï¼Œå¯ä»¥èŠ‚çº¦å¤§é‡å†…å­˜ã€‚4G çš„å®¹é‡ä½œä¸ºä¸€äº›å°å‹ç«™ç‚¹çš„ç¼“å­˜æ•°æ®åº“æ˜¯ç»°ç»°æœ‰ä½™äº†ï¼Œå¦‚æœä¸è¶³è¿˜å¯ä»¥é€šè¿‡å¢åŠ å®ä¾‹çš„æ–¹å¼æ¥è§£å†³ã€‚

å°å¯¹è±¡å‹ç¼©å­˜å‚¨ (ziplist)
--
å¦‚æœ Redis å†…éƒ¨ç®¡ç†çš„é›†åˆæ•°æ®ç»“æ„å¾ˆå°ï¼Œå®ƒä¼šä½¿ç”¨ç´§å‡‘å­˜å‚¨å½¢å¼å‹ç¼©å­˜å‚¨ã€‚

è¿™å°±å¥½æ¯” HashMap æœ¬æ¥æ˜¯äºŒç»´ç»“æ„ï¼Œä½†æ˜¯å¦‚æœå†…éƒ¨å…ƒç´ æ¯”è¾ƒå°‘ï¼Œä½¿ç”¨äºŒç»´ç»“æ„åè€Œæµªè´¹ç©ºé—´ï¼Œè¿˜ä¸å¦‚ä½¿ç”¨ä¸€ç»´æ•°ç»„è¿›è¡Œå­˜å‚¨ï¼Œéœ€è¦æŸ¥æ‰¾æ—¶ï¼Œå› ä¸ºå…ƒç´ å°‘è¿›è¡Œéå†ä¹Ÿå¾ˆå¿«ï¼Œç”šè‡³å¯ä»¥æ¯” HashMap æœ¬èº«çš„æŸ¥æ‰¾è¿˜è¦å¿«ã€‚æ¯”å¦‚ä¸‹é¢æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ•°ç»„æ¥æ¨¡æ‹Ÿ HashMap çš„å¢åˆ æ”¹æ“ä½œã€‚

```java
public class ArrayMap<K, V> {

  private List<K> keys = new ArrayList<>();
  private List<V> values = new ArrayList<>();

  public V put(K k, V v) {
    for (int i = 0; i < keys.size(); i++) {
      if (keys.get(i).equals(k)) {
        V oldv = values.get(i);
        values.set(i, v);
        return oldv;
      }
    }
    keys.add(k);
    values.add(v);
    return null;
  }

  public V get(K k) {
    for (int i = 0; i < keys.size(); i++) {
      if (keys.get(i).equals(k)) {
        return values.get(i);
      }
    }
    return null;
  }

  public V delete(K k) {
    for (int i = 0; i < keys.size(); i++) {
      if (keys.get(i).equals(k)) {
        keys.remove(i);
        return values.remove(i);
      }
    }
    return null;
  }

}
```

Redis çš„ ziplist æ˜¯ä¸€ä¸ªç´§å‡‘çš„å­—èŠ‚æ•°ç»„ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ¯ä¸ªå…ƒç´ ä¹‹é—´éƒ½æ˜¯ç´§æŒ¨ç€çš„ã€‚æˆ‘ä»¬ä¸ç”¨è¿‡äºå…³å¿ƒ `zlbytes/zltail` å’Œ `zlend` çš„å«ä¹‰ï¼Œç¨å¾®äº†è§£ä¸€ä¸‹å°±å¥½ã€‚


![](https://user-gold-cdn.xitu.io/2018/7/10/16481f85c83f803e?w=844&h=309&f=png&s=29412)

å¦‚æœå®ƒå­˜å‚¨çš„æ˜¯ hash ç»“æ„ï¼Œé‚£ä¹ˆ key å’Œ value ä¼šä½œä¸ºä¸¤ä¸ª entry ç›¸é‚»å­˜åœ¨ä¸€èµ·ã€‚
```
127.0.0.1:6379> hset hello a 1
(integer) 1
127.0.0.1:6379> hset hello b 2
(integer) 1
127.0.0.1:6379> hset hello c 3
(integer) 1
127.0.0.1:6379> object encoding hello
"ziplist"
```
å¦‚æœå®ƒå­˜å‚¨çš„æ˜¯ zsetï¼Œé‚£ä¹ˆ value å’Œ score ä¼šä½œä¸ºä¸¤ä¸ª entry ç›¸é‚»å­˜åœ¨ä¸€èµ·ã€‚
```
127.0.0.1:6379> zadd world 1 a
(integer) 1
127.0.0.1:6379> zadd world 2 b
(integer) 1
127.0.0.1:6379> zadd world 3 c
(integer) 1
127.0.0.1:6379> object encoding world
"ziplist"
```
å…³äºå‹ç¼©åˆ—è¡¨æ›´å¤šç»†èŠ‚ï¼Œè¯·é˜…è¯»ç¬¬34èŠ‚[ã€Šæåº¦æ·±å¯’ â€”â€” æ¢ç´¢ã€Œåˆ—è¡¨ã€å†…éƒ¨ç»“æ„ã€‹](https://juejin.im/book/5afc2e5f6fb9a07a9b362527/section/5b5c95226fb9a04fa42fc3f6)å’Œç¬¬35èŠ‚[ã€Šæåº¦æ·±å¯’ â€”â€” æ¢ç´¢ã€Œç´§å‡‘åˆ—è¡¨ã€å†…éƒ¨ã€‹](https://juejin.im/book/5afc2e5f6fb9a07a9b362527/section/5b5d3ec0f265da0f91561c33)

Redis çš„ `intset` æ˜¯ä¸€ä¸ªç´§å‡‘çš„æ•´æ•°æ•°ç»„ç»“æ„ï¼Œå®ƒç”¨äºå­˜æ”¾å…ƒç´ éƒ½æ˜¯æ•´æ•°çš„å¹¶ä¸”å…ƒç´ ä¸ªæ•°è¾ƒå°‘çš„ set é›†åˆã€‚

å¦‚æœæ•´æ•°å¯ä»¥ç”¨ uint16 è¡¨ç¤ºï¼Œé‚£ä¹ˆ intset çš„å…ƒç´ å°±æ˜¯ 16 ä½çš„æ•°ç»„ï¼Œå¦‚æœæ–°åŠ å…¥çš„æ•´æ•°è¶…è¿‡äº† uint16 çš„è¡¨ç¤ºèŒƒå›´ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨ uint32 è¡¨ç¤ºï¼Œå¦‚æœæ–°åŠ å…¥çš„å…ƒç´ è¶…è¿‡äº† uint32 çš„è¡¨ç¤ºèŒƒå›´ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨ uint64 è¡¨ç¤ºï¼ŒRedis æ”¯æŒ set é›†åˆåŠ¨æ€ä» uint16 å‡çº§åˆ° uint32ï¼Œå†å‡çº§åˆ° uint64ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/10/16481f959cf105bc?w=742&h=207&f=png&s=16520)

```
127.0.0.1:6379> sadd hello 1 2 3
(integer) 3
127.0.0.1:6379> object encoding hello
"intset"
```
å¦‚æœ set é‡Œå­˜å‚¨çš„æ˜¯å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆ sadd ç«‹å³å‡çº§ä¸º hashtable ç»“æ„ã€‚è¿˜è®°å¾— Java çš„ HashSet ä¹ˆï¼Œå®ƒå†…éƒ¨æ˜¯ä½¿ç”¨ HashMap å®ç°çš„ã€‚

```
127.0.0.1:6379> sadd hello yes no
(integer) 2
127.0.0.1:6379> object encoding hello
"hashtable"
```

**å­˜å‚¨ç•Œé™**
å½“é›†åˆå¯¹è±¡çš„å…ƒç´ ä¸æ–­å¢åŠ ï¼Œæˆ–è€…æŸä¸ª value å€¼è¿‡å¤§ï¼Œè¿™ç§å°å¯¹è±¡å­˜å‚¨ä¹Ÿä¼šè¢«å‡çº§ä¸ºæ ‡å‡†ç»“æ„ã€‚Redis è§„å®šåœ¨å°å¯¹è±¡å­˜å‚¨ç»“æ„çš„é™åˆ¶æ¡ä»¶å¦‚ä¸‹ï¼š
```
hash-max-ziplist-entries 512  # hash çš„å…ƒç´ ä¸ªæ•°è¶…è¿‡ 512 å°±å¿…é¡»ç”¨æ ‡å‡†ç»“æ„å­˜å‚¨
hash-max-ziplist-value 64  # hash çš„ä»»æ„å…ƒç´ çš„ key/value çš„é•¿åº¦è¶…è¿‡ 64 å°±å¿…é¡»ç”¨æ ‡å‡†ç»“æ„å­˜å‚¨
list-max-ziplist-entries 512  # list çš„å…ƒç´ ä¸ªæ•°è¶…è¿‡ 512 å°±å¿…é¡»ç”¨æ ‡å‡†ç»“æ„å­˜å‚¨
list-max-ziplist-value 64  # list çš„ä»»æ„å…ƒç´ çš„é•¿åº¦è¶…è¿‡ 64 å°±å¿…é¡»ç”¨æ ‡å‡†ç»“æ„å­˜å‚¨
zset-max-ziplist-entries 128  # zset çš„å…ƒç´ ä¸ªæ•°è¶…è¿‡ 128 å°±å¿…é¡»ç”¨æ ‡å‡†ç»“æ„å­˜å‚¨
zset-max-ziplist-value 64  # zset çš„ä»»æ„å…ƒç´ çš„é•¿åº¦è¶…è¿‡ 64 å°±å¿…é¡»ç”¨æ ‡å‡†ç»“æ„å­˜å‚¨
set-max-intset-entries 512  # set çš„æ•´æ•°å…ƒç´ ä¸ªæ•°è¶…è¿‡ 512 å°±å¿…é¡»ç”¨æ ‡å‡†ç»“æ„å­˜å‚¨
```
æ¥ä¸‹æ¥æˆ‘ä»¬åšä¸€ä¸ªå°å®éªŒï¼Œçœ‹çœ‹è¿™é‡Œçš„ç•Œé™æ˜¯ä¸æ˜¯çœŸçš„èµ·åˆ°ä½œç”¨äº†ã€‚
```
import redis
client = redis.StrictRedis()
client.delete("hello")
for i in range(512):
    client.hset("hello", str(i), str(i))
print client.object("encoding", "hello")  # è·å–å¯¹è±¡çš„å­˜å‚¨ç»“æ„
client.hset("hello", "512", "512")
print client.object("encoding", "hello") # å†æ¬¡è·å–å¯¹è±¡çš„å­˜å‚¨ç»“æ„
```
è¾“å‡ºï¼š
```
ziplist
hashtable
```
å¯ä»¥çœ‹å‡ºæ¥å½“ hash ç»“æ„çš„å…ƒç´ ä¸ªæ•°è¶…è¿‡ 512 çš„æ—¶å€™ï¼Œå­˜å‚¨ç»“æ„å°±å‘ç”Ÿäº†å˜åŒ–ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å†è¯•è¯•é€’å¢ value çš„é•¿åº¦ï¼Œåœ¨ Python é‡Œé¢å¯¹å­—ç¬¦ä¸²ä¹˜ä»¥ä¸€ä¸ªæ•´æ•° n ç›¸å½“äºé‡å¤ n æ¬¡ã€‚
```
import redis
client = redis.StrictRedis()
client.delete("hello")
for i in range(64):
    client.hset("hello", str(i), "0" * (i+1))
print client.object("encoding", "hello")  # è·å–å¯¹è±¡çš„å­˜å‚¨ç»“æ„
client.hset("hello", "512", "0" * 65)
print client.object("encoding", "hello") # å†æ¬¡è·å–å¯¹è±¡çš„å­˜å‚¨ç»“æ„
```
è¾“å‡ºï¼š
```
ziplist
hashtable
```
å¯ä»¥çœ‹å‡ºæ¥å½“ hash ç»“æ„çš„ä»»æ„ entry çš„ value å€¼è¶…è¿‡äº† 64ï¼Œå­˜å‚¨ç»“æ„å°±å‡çº§æˆæ ‡å‡†ç»“æ„äº†ã€‚

å†…å­˜å›æ”¶æœºåˆ¶
--
Redis å¹¶ä¸æ€»æ˜¯å¯ä»¥å°†ç©ºé—²å†…å­˜ç«‹å³å½’è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚

å¦‚æœå½“å‰ Redis å†…å­˜æœ‰ 10Gï¼Œå½“ä½ åˆ é™¤äº† 1GB çš„ key åï¼Œå†å»è§‚å¯Ÿå†…å­˜ï¼Œä½ ä¼šå‘ç°å†…å­˜å˜åŒ–ä¸ä¼šå¤ªå¤§ã€‚åŸå› æ˜¯æ“ä½œç³»ç»Ÿå›æ”¶å†…å­˜æ˜¯ä»¥é¡µä¸ºå•ä½ï¼Œå¦‚æœè¿™ä¸ªé¡µä¸Šåªè¦æœ‰ä¸€ä¸ª key è¿˜åœ¨ä½¿ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±ä¸èƒ½è¢«å›æ”¶ã€‚Redis è™½ç„¶åˆ é™¤äº† 1GB çš„ keyï¼Œä½†æ˜¯è¿™äº› key åˆ†æ•£åˆ°äº†å¾ˆå¤šé¡µé¢ä¸­ï¼Œæ¯ä¸ªé¡µé¢éƒ½è¿˜æœ‰å…¶å®ƒ key å­˜åœ¨ï¼Œè¿™å°±å¯¼è‡´äº†å†…å­˜ä¸ä¼šç«‹å³è¢«å›æ”¶ã€‚

ä¸è¿‡ï¼Œå¦‚æœä½ æ‰§è¡Œ `flushdb`ï¼Œç„¶åå†è§‚å¯Ÿå†…å­˜ä¼šå‘ç°å†…å­˜ç¡®å®è¢«å›æ”¶äº†ã€‚åŸå› æ˜¯æ‰€æœ‰çš„ key éƒ½å¹²æ‰äº†ï¼Œå¤§éƒ¨åˆ†ä¹‹å‰ä½¿ç”¨çš„é¡µé¢éƒ½å®Œå…¨å¹²å‡€äº†ï¼Œä¼šç«‹å³è¢«æ“ä½œç³»ç»Ÿå›æ”¶ã€‚

Redis è™½ç„¶æ— æ³•ä¿è¯ç«‹å³å›æ”¶å·²ç»åˆ é™¤çš„ key çš„å†…å­˜ï¼Œä½†æ˜¯å®ƒä¼šé‡ç”¨é‚£äº›å°šæœªå›æ”¶çš„ç©ºé—²å†…å­˜ã€‚è¿™å°±å¥½æ¯”ç”µå½±é™¢é‡Œè™½ç„¶äººèµ°äº†ï¼Œä½†æ˜¯åº§ä½è¿˜åœ¨ï¼Œä¸‹ä¸€æ³¢è§‚ä¼—æ¥äº†ï¼Œç›´æ¥åå°±è¡Œã€‚è€Œæ“ä½œç³»ç»Ÿå›æ”¶å†…å­˜å°±å¥½æ¯”æŠŠåº§ä½éƒ½ç»™æ¬èµ°äº†ã€‚è¿™ä¸ªæ¯”å–»æ˜¯ä¸æ˜¯å¾ˆ 6ï¼Ÿ

å†…å­˜åˆ†é…ç®—æ³•
--
å†…å­˜åˆ†é…æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„è¯¾é¢˜ï¼Œéœ€è¦é€‚å½“çš„ç®—æ³•åˆ’åˆ†å†…å­˜é¡µï¼Œéœ€è¦è€ƒè™‘å†…å­˜ç¢ç‰‡ï¼Œéœ€è¦å¹³è¡¡æ€§èƒ½å’Œæ•ˆç‡ã€‚

Redis ä¸ºäº†ä¿æŒè‡ªèº«ç»“æ„çš„ç®€å•æ€§ï¼Œåœ¨å†…å­˜åˆ†é…è¿™é‡Œç›´æ¥åšäº†ç”©æ‰‹æŒæŸœï¼Œå°†å†…å­˜åˆ†é…çš„ç»†èŠ‚ä¸¢ç»™äº†ç¬¬ä¸‰æ–¹å†…å­˜åˆ†é…åº“å»å®ç°ã€‚ç›®å‰ Redis å¯ä»¥ä½¿ç”¨ jemalloc(facebook) åº“æ¥ç®¡ç†å†…å­˜ï¼Œä¹Ÿå¯ä»¥åˆ‡æ¢åˆ°tcmalloc(google)ã€‚å› ä¸º jemalloc ç›¸æ¯” tcmallocçš„æ€§èƒ½è¦ç¨å¥½ä¸€äº›ï¼Œæ‰€ä»¥Redisé»˜è®¤ä½¿ç”¨äº†jemallocã€‚ 
```
127.0.0.1:6379> info memory
# Memory
used_memory:809608
used_memory_human:790.63K
used_memory_rss:8232960
used_memory_peak:566296608
used_memory_peak_human:540.06M
used_memory_lua:36864
mem_fragmentation_ratio:10.17
mem_allocator:jemalloc-3.6.0
```
é€šè¿‡```info memory```æŒ‡ä»¤å¯ä»¥çœ‹åˆ° Redis çš„```mem_allocator```ä½¿ç”¨äº† jemallocã€‚

## æ‰©å±•é˜…è¯»

[jemalloc â€”â€” å†…å­˜åˆ†é…çš„å¥¥ä¹‰](http://tinylab.org/memory-allocation-mystery-%C2%B7-jemalloc-a/)
# åŸç† 8ï¼šæœ‰å¤‡æ— æ‚£ â€”â€” ä¸»ä»åŒæ­¥

å¾ˆå¤šä¼ä¸šéƒ½æ²¡æœ‰ä½¿ç”¨åˆ° Redis çš„é›†ç¾¤ï¼Œä½†æ˜¯è‡³å°‘éƒ½åšäº†ä¸»ä»ã€‚æœ‰äº†ä¸»ä»ï¼Œå½“ master æŒ‚æ‰çš„æ—¶å€™ï¼Œè¿ç»´è®©ä»åº“è¿‡æ¥æ¥ç®¡ï¼ŒæœåŠ¡å°±å¯ä»¥ç»§ç»­ï¼Œå¦åˆ™ master éœ€è¦ç»è¿‡æ•°æ®æ¢å¤å’Œé‡å¯çš„è¿‡ç¨‹ï¼Œè¿™å°±å¯èƒ½ä¼šæ‹–å¾ˆé•¿çš„æ—¶é—´ï¼Œå½±å“çº¿ä¸Šä¸šåŠ¡çš„æŒç»­æœåŠ¡ã€‚

åœ¨äº†è§£ Redis çš„ä¸»ä»å¤åˆ¶ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæ¥ç†è§£ä¸€ä¸‹ç°ä»£åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç†è®ºåŸºçŸ³â€”â€”CAP åŸç†ã€‚

CAP åŸç†
--
CAP åŸç†å°±å¥½æ¯”åˆ†å¸ƒå¼é¢†åŸŸçš„ç‰›é¡¿å®šå¾‹ï¼Œå®ƒæ˜¯åˆ†å¸ƒå¼å­˜å‚¨çš„ç†è®ºåŸºçŸ³ã€‚è‡ªæ‰“ CAP çš„è®ºæ–‡å‘è¡¨ä¹‹åï¼Œåˆ†å¸ƒå¼å­˜å‚¨ä¸­é—´ä»¶çŠ¹å¦‚é›¨åæ˜¥ç¬‹èˆ¬ä¸€ä¸ªä¸€ä¸ªæ¶Œç°å‡ºæ¥ã€‚ç†è§£è¿™ä¸ªåŸç†å…¶å®å¾ˆç®€å•ï¼Œæœ¬èŠ‚æˆ‘ä»¬é¦–å…ˆå¯¹è¿™ä¸ªåŸç†è¿›è¡Œä¸€äº›ç®€å•çš„è®²è§£ã€‚

* **C** - Consistent ï¼Œä¸€è‡´æ€§
* **A** - Availability ï¼Œå¯ç”¨æ€§
* **P** - Partition tolerance ï¼Œåˆ†åŒºå®¹å¿æ€§

åˆ†å¸ƒå¼ç³»ç»Ÿçš„èŠ‚ç‚¹å¾€å¾€éƒ½æ˜¯åˆ†å¸ƒåœ¨ä¸åŒçš„æœºå™¨ä¸Šè¿›è¡Œç½‘ç»œéš”ç¦»å¼€çš„ï¼Œè¿™æ„å‘³ç€å¿…ç„¶ä¼šæœ‰ç½‘ç»œæ–­å¼€çš„é£é™©ï¼Œè¿™ä¸ªç½‘ç»œæ–­å¼€çš„åœºæ™¯çš„ä¸“ä¸šè¯æ±‡å«ç€ã€Œ**ç½‘ç»œåˆ†åŒº**ã€ã€‚

åœ¨ç½‘ç»œåˆ†åŒºå‘ç”Ÿæ—¶ï¼Œä¸¤ä¸ªåˆ†å¸ƒå¼èŠ‚ç‚¹ä¹‹é—´æ— æ³•è¿›è¡Œé€šä¿¡ï¼Œæˆ‘ä»¬å¯¹ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œçš„ä¿®æ”¹æ“ä½œå°†æ— æ³•åŒæ­¥åˆ°å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥æ•°æ®çš„ã€Œ**ä¸€è‡´æ€§**ã€å°†æ— æ³•æ»¡è¶³ï¼Œå› ä¸ºä¸¤ä¸ªåˆ†å¸ƒå¼èŠ‚ç‚¹çš„æ•°æ®ä¸å†ä¿æŒä¸€è‡´ã€‚é™¤éæˆ‘ä»¬ç‰ºç‰²ã€Œ**å¯ç”¨æ€§**ã€ï¼Œä¹Ÿå°±æ˜¯æš‚åœåˆ†å¸ƒå¼èŠ‚ç‚¹æœåŠ¡ï¼Œåœ¨ç½‘ç»œåˆ†åŒºå‘ç”Ÿæ—¶ï¼Œä¸å†æä¾›ä¿®æ”¹æ•°æ®çš„åŠŸèƒ½ï¼Œç›´åˆ°ç½‘ç»œçŠ¶å†µå®Œå…¨æ¢å¤æ­£å¸¸å†ç»§ç»­å¯¹å¤–æä¾›æœåŠ¡ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/4/164642389477ff9e?w=538&h=391&f=png&s=25993)

ä¸€å¥è¯æ¦‚æ‹¬ CAP åŸç†å°±æ˜¯â€”â€”**ç½‘ç»œåˆ†åŒºå‘ç”Ÿæ—¶ï¼Œä¸€è‡´æ€§å’Œå¯ç”¨æ€§ä¸¤éš¾å…¨**ã€‚

æœ€ç»ˆä¸€è‡´
--
Redis çš„ä¸»ä»æ•°æ®æ˜¯å¼‚æ­¥åŒæ­¥çš„ï¼Œæ‰€ä»¥åˆ†å¸ƒå¼çš„ Redis ç³»ç»Ÿå¹¶ä¸æ»¡è¶³ã€Œ**ä¸€è‡´æ€§**ã€è¦æ±‚ã€‚å½“å®¢æˆ·ç«¯åœ¨ Redis çš„ä¸»èŠ‚ç‚¹ä¿®æ”¹äº†æ•°æ®åï¼Œç«‹å³è¿”å›ï¼Œå³ä½¿åœ¨ä¸»ä»ç½‘ç»œæ–­å¼€çš„æƒ…å†µä¸‹ï¼Œä¸»èŠ‚ç‚¹ä¾æ—§å¯ä»¥æ­£å¸¸å¯¹å¤–æä¾›ä¿®æ”¹æœåŠ¡ï¼Œæ‰€ä»¥ Redis æ»¡è¶³ã€Œ**å¯ç”¨æ€§**ã€ã€‚

Redis ä¿è¯ã€Œ**æœ€ç»ˆä¸€è‡´æ€§**ã€ï¼Œä»èŠ‚ç‚¹ä¼šåŠªåŠ›è¿½èµ¶ä¸»èŠ‚ç‚¹ï¼Œæœ€ç»ˆä»èŠ‚ç‚¹çš„çŠ¶æ€ä¼šå’Œä¸»èŠ‚ç‚¹çš„çŠ¶æ€å°†ä¿æŒä¸€è‡´ã€‚å¦‚æœç½‘ç»œæ–­å¼€äº†ï¼Œä¸»ä»èŠ‚ç‚¹çš„æ•°æ®å°†ä¼šå‡ºç°å¤§é‡ä¸ä¸€è‡´ï¼Œä¸€æ—¦ç½‘ç»œæ¢å¤ï¼Œä»èŠ‚ç‚¹ä¼šé‡‡ç”¨å¤šç§ç­–ç•¥åŠªåŠ›è¿½èµ¶ä¸Šè½åçš„æ•°æ®ï¼Œç»§ç»­å°½åŠ›ä¿æŒå’Œä¸»èŠ‚ç‚¹ä¸€è‡´ã€‚

ä¸»ä»åŒæ­¥
--
Redis åŒæ­¥æ”¯æŒä¸»ä»åŒæ­¥å’Œä»ä»åŒæ­¥ï¼Œä»ä»åŒæ­¥åŠŸèƒ½æ˜¯ Redis åç»­ç‰ˆæœ¬å¢åŠ çš„åŠŸèƒ½ï¼Œä¸ºäº†å‡è½»ä¸»åº“çš„åŒæ­¥è´Ÿæ‹…ã€‚åé¢ä¸ºäº†æè¿°ä¸Šçš„æ–¹ä¾¿ï¼Œç»Ÿä¸€ç†è§£ä¸ºä¸»ä»åŒæ­¥ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/4/164641d454a0e67a?w=575&h=238&f=png&s=23174)

å¢é‡åŒæ­¥
--
Redis åŒæ­¥çš„æ˜¯æŒ‡ä»¤æµï¼Œä¸»èŠ‚ç‚¹ä¼šå°†é‚£äº›å¯¹è‡ªå·±çš„çŠ¶æ€äº§ç”Ÿä¿®æ”¹æ€§å½±å“çš„æŒ‡ä»¤è®°å½•åœ¨æœ¬åœ°çš„å†…å­˜ buffer ä¸­ï¼Œç„¶åå¼‚æ­¥å°† buffer ä¸­çš„æŒ‡ä»¤åŒæ­¥åˆ°ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹ä¸€è¾¹æ‰§è¡ŒåŒæ­¥çš„æŒ‡ä»¤æµæ¥è¾¾åˆ°å’Œä¸»èŠ‚ç‚¹ä¸€æ ·çš„çŠ¶æ€ï¼Œä¸€è¾¹å‘ä¸»èŠ‚ç‚¹åé¦ˆè‡ªå·±åŒæ­¥åˆ°å“ªé‡Œäº† (åç§»é‡)ã€‚

å› ä¸ºå†…å­˜çš„ buffer æ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥ Redis ä¸»åº“ä¸èƒ½å°†æ‰€æœ‰çš„æŒ‡ä»¤éƒ½è®°å½•åœ¨å†…å­˜ buffer ä¸­ã€‚Redis çš„å¤åˆ¶å†…å­˜ buffer æ˜¯ä¸€ä¸ªå®šé•¿çš„ç¯å½¢æ•°ç»„ï¼Œå¦‚æœæ•°ç»„å†…å®¹æ»¡äº†ï¼Œå°±ä¼šä»å¤´å¼€å§‹è¦†ç›–å‰é¢çš„å†…å®¹ã€‚
![](https://user-gold-cdn.xitu.io/2018/5/21/16381ba1db76a768?w=217&h=211&f=png&s=22717)

å¦‚æœå› ä¸ºç½‘ç»œçŠ¶å†µä¸å¥½ï¼Œä»èŠ‚ç‚¹åœ¨çŸ­æ—¶é—´å†…æ— æ³•å’Œä¸»èŠ‚ç‚¹è¿›è¡ŒåŒæ­¥ï¼Œé‚£ä¹ˆå½“ç½‘ç»œçŠ¶å†µæ¢å¤æ—¶ï¼ŒRedis çš„ä¸»èŠ‚ç‚¹ä¸­é‚£äº›æ²¡æœ‰åŒæ­¥çš„æŒ‡ä»¤åœ¨ buffer ä¸­æœ‰å¯èƒ½å·²ç»è¢«åç»­çš„æŒ‡ä»¤è¦†ç›–æ‰äº†ï¼Œä»èŠ‚ç‚¹å°†æ— æ³•ç›´æ¥é€šè¿‡æŒ‡ä»¤æµæ¥è¿›è¡ŒåŒæ­¥ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ°æ›´åŠ å¤æ‚çš„åŒæ­¥æœºåˆ¶ â€”â€” å¿«ç…§åŒæ­¥ã€‚

å¿«ç…§åŒæ­¥
--
å¿«ç…§åŒæ­¥æ˜¯ä¸€ä¸ªéå¸¸è€—è´¹èµ„æºçš„æ“ä½œï¼Œå®ƒé¦–å…ˆéœ€è¦åœ¨ä¸»åº“ä¸Šè¿›è¡Œä¸€æ¬¡ bgsave å°†å½“å‰å†…å­˜çš„æ•°æ®å…¨éƒ¨å¿«ç…§åˆ°ç£ç›˜æ–‡ä»¶ä¸­ï¼Œç„¶åå†å°†å¿«ç…§æ–‡ä»¶çš„å†…å®¹å…¨éƒ¨ä¼ é€åˆ°ä»èŠ‚ç‚¹ã€‚ä»èŠ‚ç‚¹å°†å¿«ç…§æ–‡ä»¶æ¥å—å®Œæ¯•åï¼Œç«‹å³æ‰§è¡Œä¸€æ¬¡å…¨é‡åŠ è½½ï¼ŒåŠ è½½ä¹‹å‰å…ˆè¦å°†å½“å‰å†…å­˜çš„æ•°æ®æ¸…ç©ºã€‚åŠ è½½å®Œæ¯•åé€šçŸ¥ä¸»èŠ‚ç‚¹ç»§ç»­è¿›è¡Œå¢é‡åŒæ­¥ã€‚

åœ¨æ•´ä¸ªå¿«ç…§åŒæ­¥è¿›è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¸»èŠ‚ç‚¹çš„å¤åˆ¶ buffer è¿˜åœ¨ä¸åœçš„å¾€å‰ç§»åŠ¨ï¼Œå¦‚æœå¿«ç…§åŒæ­¥çš„æ—¶é—´è¿‡é•¿æˆ–è€…å¤åˆ¶ buffer å¤ªå°ï¼Œéƒ½ä¼šå¯¼è‡´åŒæ­¥æœŸé—´çš„å¢é‡æŒ‡ä»¤åœ¨å¤åˆ¶ buffer ä¸­è¢«è¦†ç›–ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´å¿«ç…§åŒæ­¥å®Œæˆåæ— æ³•è¿›è¡Œå¢é‡å¤åˆ¶ï¼Œç„¶åä¼šå†æ¬¡å‘èµ·å¿«ç…§åŒæ­¥ï¼Œå¦‚æ­¤ææœ‰å¯èƒ½ä¼šé™·å…¥å¿«ç…§åŒæ­¥çš„æ­»å¾ªç¯ã€‚


![](https://user-gold-cdn.xitu.io/2018/7/4/164641fbae932002?w=610&h=258&f=png&s=17606)

æ‰€ä»¥åŠ¡å¿…é…ç½®ä¸€ä¸ªåˆé€‚çš„å¤åˆ¶ buffer å¤§å°å‚æ•°ï¼Œé¿å…å¿«ç…§å¤åˆ¶çš„æ­»å¾ªç¯ã€‚

å¢åŠ ä»èŠ‚ç‚¹
--
å½“ä»èŠ‚ç‚¹åˆšåˆšåŠ å…¥åˆ°é›†ç¾¤æ—¶ï¼Œå®ƒå¿…é¡»å…ˆè¦è¿›è¡Œä¸€æ¬¡å¿«ç…§åŒæ­¥ï¼ŒåŒæ­¥å®Œæˆåå†ç»§ç»­è¿›è¡Œå¢é‡åŒæ­¥ã€‚

æ— ç›˜å¤åˆ¶
--
ä¸»èŠ‚ç‚¹åœ¨è¿›è¡Œå¿«ç…§åŒæ­¥æ—¶ï¼Œä¼šè¿›è¡Œå¾ˆé‡çš„æ–‡ä»¶ IO æ“ä½œï¼Œç‰¹åˆ«æ˜¯å¯¹äºé SSD ç£ç›˜å­˜å‚¨æ—¶ï¼Œå¿«ç…§ä¼šå¯¹ç³»ç»Ÿçš„è´Ÿè½½äº§ç”Ÿè¾ƒå¤§å½±å“ã€‚ç‰¹åˆ«æ˜¯å½“ç³»ç»Ÿæ­£åœ¨è¿›è¡Œ AOF çš„ fsync æ“ä½œæ—¶å¦‚æœå‘ç”Ÿå¿«ç…§ï¼Œfsync å°†ä¼šè¢«æ¨è¿Ÿæ‰§è¡Œï¼Œè¿™å°±ä¼šä¸¥é‡å½±å“ä¸»èŠ‚ç‚¹çš„æœåŠ¡æ•ˆç‡ã€‚

æ‰€ä»¥ä» Redis 2.8.18 ç‰ˆå¼€å§‹æ”¯æŒæ— ç›˜å¤åˆ¶ã€‚æ‰€è°“æ— ç›˜å¤åˆ¶æ˜¯æŒ‡ä¸»æœåŠ¡å™¨ç›´æ¥é€šè¿‡å¥—æ¥å­—å°†å¿«ç…§å†…å®¹å‘é€åˆ°ä»èŠ‚ç‚¹ï¼Œç”Ÿæˆå¿«ç…§æ˜¯ä¸€ä¸ªéå†çš„è¿‡ç¨‹ï¼Œä¸»èŠ‚ç‚¹ä¼šä¸€è¾¹éå†å†…å­˜ï¼Œä¸€è¾¹å°†åºåˆ—åŒ–çš„å†…å®¹å‘é€åˆ°ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹è¿˜æ˜¯è·Ÿä¹‹å‰ä¸€æ ·ï¼Œå…ˆå°†æ¥æ”¶åˆ°çš„å†…å®¹å­˜å‚¨åˆ°ç£ç›˜æ–‡ä»¶ä¸­ï¼Œå†è¿›è¡Œä¸€æ¬¡æ€§åŠ è½½ã€‚

Wait æŒ‡ä»¤
--
Redis çš„å¤åˆ¶æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œwait æŒ‡ä»¤å¯ä»¥è®©å¼‚æ­¥å¤åˆ¶å˜èº«åŒæ­¥å¤åˆ¶ï¼Œç¡®ä¿ç³»ç»Ÿçš„å¼ºä¸€è‡´æ€§ (ä¸ä¸¥æ ¼)ã€‚wait æŒ‡ä»¤æ˜¯ Redis3.0 ç‰ˆæœ¬ä»¥åæ‰å‡ºç°çš„ã€‚
```
> set key value
OK
> wait 1 0
(integer) 1
```
wait æä¾›ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä»åº“çš„æ•°é‡ Nï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ—¶é—´ tï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ã€‚å®ƒè¡¨ç¤ºç­‰å¾… wait æŒ‡ä»¤ä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œåŒæ­¥åˆ° N ä¸ªä»åº“ (ä¹Ÿå°±æ˜¯ç¡®ä¿ N ä¸ªä»åº“çš„åŒæ­¥æ²¡æœ‰æ»å)ï¼Œæœ€å¤šç­‰å¾…æ—¶é—´ tã€‚å¦‚æœæ—¶é—´ t=0ï¼Œè¡¨ç¤ºæ— é™ç­‰å¾…ç›´åˆ° N ä¸ªä»åº“åŒæ­¥å®Œæˆè¾¾æˆä¸€è‡´ã€‚

å‡è®¾æ­¤æ—¶å‡ºç°äº†ç½‘ç»œåˆ†åŒºï¼Œwait æŒ‡ä»¤ç¬¬äºŒä¸ªå‚æ•°æ—¶é—´ t=0ï¼Œä¸»ä»åŒæ­¥æ— æ³•ç»§ç»­è¿›è¡Œï¼Œwait æŒ‡ä»¤ä¼šæ°¸è¿œé˜»å¡ï¼ŒRedis æœåŠ¡å™¨å°†ä¸§å¤±å¯ç”¨æ€§ã€‚

## å°ç»“

ä¸»ä»å¤åˆ¶æ˜¯ Redis åˆ†å¸ƒå¼çš„åŸºç¡€ï¼ŒRedis çš„é«˜å¯ç”¨ç¦»å¼€äº†ä¸»ä»å¤åˆ¶å°†æ— ä»è¿›è¡Œã€‚åé¢çš„ç« èŠ‚æˆ‘ä»¬ä¼šå¼€å§‹è®²è§£ Redis çš„é›†ç¾¤æ¨¡å¼ï¼Œè¿™å‡ ç§é›†ç¾¤æ¨¡å¼éƒ½ä¾èµ–äºæœ¬èŠ‚æ‰€è®²çš„ä¸»ä»å¤åˆ¶ã€‚

ä¸è¿‡å¤åˆ¶åŠŸèƒ½ä¹Ÿä¸æ˜¯å¿…é¡»çš„ï¼Œå¦‚æœä½ å°† Redis åªç”¨æ¥åšç¼“å­˜ï¼Œè·Ÿ memcache ä¸€æ ·æ¥å¯¹å¾…ï¼Œä¹Ÿå°±æ— éœ€è¦ä»åº“åšå¤‡ä»½ï¼ŒæŒ‚æ‰äº†é‡æ–°å¯åŠ¨ä¸€ä¸‹å°±è¡Œã€‚ä½†æ˜¯åªè¦ä½ ä½¿ç”¨äº† Redis çš„æŒä¹…åŒ–åŠŸèƒ½ï¼Œå°±å¿…é¡»è®¤çœŸå¯¹å¾…ä¸»ä»å¤åˆ¶ï¼Œå®ƒæ˜¯ç³»ç»Ÿæ•°æ®å®‰å…¨çš„åŸºç¡€ä¿éšœã€‚
# é›†ç¾¤ 1ï¼šæä»£æ¡ƒåƒµ â€”â€” Sentinel

ç›®å‰æˆ‘ä»¬è®²çš„ Redis è¿˜åªæ˜¯ä¸»ä»æ–¹æ¡ˆï¼Œæœ€ç»ˆä¸€è‡´æ€§ã€‚è¯»è€…ä»¬å¯æ€è€ƒè¿‡ï¼Œå¦‚æœä¸»èŠ‚ç‚¹å‡Œæ™¨ 3 ç‚¹çªå‘å®•æœºæ€ä¹ˆåŠï¼Ÿå°±åç­‰è¿ç»´ä»åºŠä¸Šçˆ¬èµ·æ¥ï¼Œç„¶åæ‰‹å·¥è¿›è¡Œä»ä¸»åˆ‡æ¢ï¼Œå†é€šçŸ¥æ‰€æœ‰çš„ç¨‹åºæŠŠåœ°å€ç»Ÿç»Ÿæ”¹ä¸€éé‡æ–°ä¸Šçº¿ä¹ˆï¼Ÿæ¯«æ— ç–‘é—®ï¼Œè¿™æ ·çš„äººå·¥è¿ç»´æ•ˆç‡å¤ªä½ï¼Œäº‹æ•…å‘ç”Ÿæ—¶ä¼°è®¡å¾—è‡³å°‘ 1 ä¸ªå°æ—¶æ‰èƒ½ç¼“è¿‡æ¥ã€‚å¦‚æœæ˜¯ä¸€ä¸ªå¤§å‹å…¬å¸ï¼Œè¿™æ ·çš„äº‹æ•…è¶³ä»¥ä¸Šæ–°é—»äº†ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/11/164879368601d822?w=275&h=144&f=png&s=14038)

æ‰€ä»¥æˆ‘ä»¬å¿…é¡»æœ‰ä¸€ä¸ªé«˜å¯ç”¨æ–¹æ¡ˆæ¥æŠµæŠ—èŠ‚ç‚¹æ•…éšœï¼Œå½“æ•…éšœå‘ç”Ÿæ—¶å¯ä»¥è‡ªåŠ¨è¿›è¡Œä»ä¸»åˆ‡æ¢ï¼Œç¨‹åºå¯ä»¥ä¸ç”¨é‡å¯ï¼Œè¿ç»´å¯ä»¥ç»§ç»­ç¡å¤§è§‰ï¼Œä»¿ä½›ä»€ä¹ˆäº‹ä¹Ÿæ²¡å‘ç”Ÿä¸€æ ·ã€‚Redis å®˜æ–¹æä¾›äº†è¿™æ ·ä¸€ç§æ–¹æ¡ˆ â€”â€” Redis Sentinel(å“¨å…µ)ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/4/16464072b3430480?w=719&h=404&f=png&s=38461)

æˆ‘ä»¬å¯ä»¥å°† Redis Sentinel é›†ç¾¤çœ‹æˆæ˜¯ä¸€ä¸ª ZooKeeper é›†ç¾¤ï¼Œå®ƒæ˜¯é›†ç¾¤é«˜å¯ç”¨çš„å¿ƒè„ï¼Œå®ƒä¸€èˆ¬æ˜¯ç”± 3ï½5 ä¸ªèŠ‚ç‚¹ç»„æˆï¼Œè¿™æ ·æŒ‚äº†ä¸ªåˆ«èŠ‚ç‚¹é›†ç¾¤è¿˜å¯ä»¥æ­£å¸¸è¿è½¬ã€‚

å®ƒè´Ÿè´£æŒç»­ç›‘æ§ä¸»ä»èŠ‚ç‚¹çš„å¥åº·ï¼Œå½“ä¸»èŠ‚ç‚¹æŒ‚æ‰æ—¶ï¼Œè‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªæœ€ä¼˜çš„ä»èŠ‚ç‚¹åˆ‡æ¢ä¸ºä¸»èŠ‚ç‚¹ã€‚å®¢æˆ·ç«¯æ¥è¿æ¥é›†ç¾¤æ—¶ï¼Œä¼šé¦–å…ˆè¿æ¥ sentinelï¼Œé€šè¿‡ sentinel æ¥æŸ¥è¯¢ä¸»èŠ‚ç‚¹çš„åœ°å€ï¼Œç„¶åå†å»è¿æ¥ä¸»èŠ‚ç‚¹è¿›è¡Œæ•°æ®äº¤äº’ã€‚å½“ä¸»èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œå®¢æˆ·ç«¯ä¼šé‡æ–°å‘ sentinel è¦åœ°å€ï¼Œsentinel ä¼šå°†æœ€æ–°çš„ä¸»èŠ‚ç‚¹åœ°å€å‘Šè¯‰å®¢æˆ·ç«¯ã€‚å¦‚æ­¤åº”ç”¨ç¨‹åºå°†æ— éœ€é‡å¯å³å¯è‡ªåŠ¨å®ŒæˆèŠ‚ç‚¹åˆ‡æ¢ã€‚æ¯”å¦‚ä¸Šå›¾çš„ä¸»èŠ‚ç‚¹æŒ‚æ‰åï¼Œé›†ç¾¤å°†å¯èƒ½è‡ªåŠ¨è°ƒæ•´ä¸ºä¸‹å›¾æ‰€ç¤ºç»“æ„ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/4/164640d92239dacf?w=806&h=464&f=png&s=52086)

ä»è¿™å¼ å›¾ä¸­æˆ‘ä»¬èƒ½çœ‹åˆ°ä¸»èŠ‚ç‚¹æŒ‚æ‰äº†ï¼ŒåŸå…ˆçš„ä¸»ä»å¤åˆ¶ä¹Ÿæ–­å¼€äº†ï¼Œå®¢æˆ·ç«¯å’ŒæŸåçš„ä¸»èŠ‚ç‚¹ä¹Ÿæ–­å¼€äº†ã€‚ä»èŠ‚ç‚¹è¢«æå‡ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå…¶å®ƒä»èŠ‚ç‚¹å¼€å§‹å’Œæ–°çš„ä¸»èŠ‚ç‚¹å»ºç«‹å¤åˆ¶å…³ç³»ã€‚å®¢æˆ·ç«¯é€šè¿‡æ–°çš„ä¸»èŠ‚ç‚¹ç»§ç»­è¿›è¡Œäº¤äº’ã€‚Sentinel ä¼šæŒç»­ç›‘æ§å·²ç»æŒ‚æ‰äº†ä¸»èŠ‚ç‚¹ï¼Œå¾…å®ƒæ¢å¤åï¼Œé›†ç¾¤ä¼šè°ƒæ•´ä¸ºä¸‹é¢è¿™å¼ å›¾ã€‚


![](https://user-gold-cdn.xitu.io/2018/7/4/1646410c0581795a?w=730&h=420&f=png&s=42217)

æ­¤æ—¶åŸå…ˆæŒ‚æ‰çš„ä¸»èŠ‚ç‚¹ç°åœ¨å˜æˆäº†ä»èŠ‚ç‚¹ï¼Œä»æ–°çš„ä¸»èŠ‚ç‚¹é‚£é‡Œå»ºç«‹å¤åˆ¶å…³ç³»ã€‚

æ¶ˆæ¯ä¸¢å¤±
--
Redis ä¸»ä»é‡‡ç”¨å¼‚æ­¥å¤åˆ¶ï¼Œæ„å‘³ç€å½“ä¸»èŠ‚ç‚¹æŒ‚æ‰æ—¶ï¼Œä»èŠ‚ç‚¹å¯èƒ½æ²¡æœ‰æ”¶åˆ°å…¨éƒ¨çš„åŒæ­¥æ¶ˆæ¯ï¼Œè¿™éƒ¨åˆ†æœªåŒæ­¥çš„æ¶ˆæ¯å°±ä¸¢å¤±äº†ã€‚å¦‚æœä¸»ä»å»¶è¿Ÿç‰¹åˆ«å¤§ï¼Œé‚£ä¹ˆä¸¢å¤±çš„æ•°æ®å°±å¯èƒ½ä¼šç‰¹åˆ«å¤šã€‚Sentinel æ— æ³•ä¿è¯æ¶ˆæ¯å®Œå…¨ä¸ä¸¢å¤±ï¼Œä½†æ˜¯ä¹Ÿå°½å¯èƒ½ä¿è¯æ¶ˆæ¯å°‘ä¸¢å¤±ã€‚å®ƒæœ‰ä¸¤ä¸ªé€‰é¡¹å¯ä»¥é™åˆ¶ä¸»ä»å»¶è¿Ÿè¿‡å¤§ã€‚
```
min-slaves-to-write 1
min-slaves-max-lag 10
```
ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºä¸»èŠ‚ç‚¹å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªä»èŠ‚ç‚¹åœ¨è¿›è¡Œæ­£å¸¸å¤åˆ¶ï¼Œå¦åˆ™å°±åœæ­¢å¯¹å¤–å†™æœåŠ¡ï¼Œä¸§å¤±å¯ç”¨æ€§ã€‚

ä½•ä¸ºæ­£å¸¸å¤åˆ¶ï¼Œä½•ä¸ºå¼‚å¸¸å¤åˆ¶ï¼Ÿè¿™ä¸ªå°±æ˜¯ç”±ç¬¬äºŒä¸ªå‚æ•°æ§åˆ¶çš„ï¼Œå®ƒçš„å•ä½æ˜¯ç§’ï¼Œè¡¨ç¤ºå¦‚æœ 10s æ²¡æœ‰æ”¶åˆ°ä»èŠ‚ç‚¹çš„åé¦ˆï¼Œå°±æ„å‘³ç€ä»èŠ‚ç‚¹åŒæ­¥ä¸æ­£å¸¸ï¼Œè¦ä¹ˆç½‘ç»œæ–­å¼€äº†ï¼Œè¦ä¹ˆä¸€ç›´æ²¡æœ‰ç»™åé¦ˆã€‚

Sentinel åŸºæœ¬ä½¿ç”¨
--
æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å®¢æˆ·ç«¯å¦‚ä½•ä½¿ç”¨ sentinelï¼Œæ ‡å‡†çš„æµç¨‹åº”è¯¥æ˜¯å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ sentinel å‘ç°ä¸»ä»èŠ‚ç‚¹çš„åœ°å€ï¼Œç„¶ååœ¨é€šè¿‡è¿™äº›åœ°å€å»ºç«‹ç›¸åº”çš„è¿æ¥æ¥è¿›è¡Œæ•°æ®å­˜å–æ“ä½œã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ Python å®¢æˆ·ç«¯æ˜¯å¦‚ä½•åšçš„ã€‚

```
>>> from redis.sentinel import Sentinel
>>> sentinel = Sentinel([('localhost', 26379)], socket_timeout=0.1)
>>> sentinel.discover_master('mymaster')
('127.0.0.1', 6379)
>>> sentinel.discover_slaves('mymaster')
[('127.0.0.1', 6380)]
```
sentinel çš„é»˜è®¤ç«¯å£æ˜¯ 26379ï¼Œä¸åŒäº Redis çš„é»˜è®¤ç«¯å£ 6379ï¼Œé€šè¿‡ sentinel å¯¹è±¡çš„ discover_xxx æ–¹æ³•å¯ä»¥å‘ç°ä¸»ä»åœ°å€ï¼Œä¸»åœ°å€åªæœ‰ä¸€ä¸ªï¼Œä»åœ°å€å¯ä»¥æœ‰å¤šä¸ªã€‚
```
>>> master = sentinel.master_for('mymaster', socket_timeout=0.1)
>>> slave = sentinel.slave_for('mymaster', socket_timeout=0.1)
>>> master.set('foo', 'bar')
>>> slave.get('foo')
'bar'
```
é€šè¿‡ xxx_for æ–¹æ³•å¯ä»¥ä»è¿æ¥æ± ä¸­æ‹¿å‡ºä¸€ä¸ªè¿æ¥æ¥ä½¿ç”¨ï¼Œå› ä¸ºä»åœ°å€æœ‰å¤šä¸ªï¼Œredis å®¢æˆ·ç«¯å¯¹ä»åœ°å€é‡‡ç”¨è½®è¯¢æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯ RoundRobin è½®ç€æ¥ã€‚

æœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œä½† sentinel è¿›è¡Œä¸»ä»åˆ‡æ¢æ—¶ï¼Œå®¢æˆ·ç«¯å¦‚ä½•çŸ¥é“åœ°å€å˜æ›´äº† ? é€šè¿‡åˆ†ææºç ï¼Œæˆ‘å‘ç° redis-py åœ¨å»ºç«‹è¿æ¥çš„æ—¶å€™è¿›è¡Œäº†ä¸»åº“åœ°å€å˜æ›´åˆ¤æ–­ã€‚

è¿æ¥æ± å»ºç«‹æ–°è¿æ¥æ—¶ï¼Œä¼šå»æŸ¥è¯¢ä¸»åº“åœ°å€ï¼Œç„¶åè·Ÿå†…å­˜ä¸­çš„ä¸»åº“åœ°å€è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœå˜æ›´äº†ï¼Œå°±æ–­å¼€æ‰€æœ‰è¿æ¥ï¼Œé‡æ–°ä½¿ç”¨æ–°åœ°å€å»ºç«‹æ–°è¿æ¥ã€‚å¦‚æœæ˜¯æ—§çš„ä¸»åº“æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆæ‰€æœ‰æ­£åœ¨ä½¿ç”¨çš„è¿æ¥éƒ½ä¼šè¢«å…³é—­ï¼Œç„¶ååœ¨é‡è¿æ—¶å°±ä¼šç”¨ä¸Šæ–°åœ°å€ã€‚

ä½†æ˜¯è¿™æ ·è¿˜ä¸å¤Ÿï¼Œå¦‚æœæ˜¯ sentinel ä¸»åŠ¨è¿›è¡Œä¸»ä»åˆ‡æ¢ï¼Œä¸»åº“å¹¶æ²¡æœ‰æŒ‚æ‰ï¼Œè€Œä¹‹å‰çš„ä¸»åº“è¿æ¥å·²ç»å»ºç«‹äº†åœ¨ä½¿ç”¨äº†ï¼Œæ²¡æœ‰æ–°è¿æ¥éœ€è¦å»ºç«‹ï¼Œé‚£è¿™ä¸ªè¿æ¥æ˜¯ä¸æ˜¯ä¸€è‡´åˆ‡æ¢ä¸äº†ï¼Ÿ

ç»§ç»­æ·±å…¥ç ”ç©¶æºç ï¼Œæˆ‘å‘ç° redis-py åœ¨å¦å¤–ä¸€ä¸ªç‚¹ä¹Ÿåšäº†æ§åˆ¶ã€‚é‚£å°±æ˜¯åœ¨å¤„ç†å‘½ä»¤çš„æ—¶å€™æ•è·äº†ä¸€ä¸ªç‰¹æ®Šçš„å¼‚å¸¸```ReadOnlyError```ï¼Œåœ¨è¿™ä¸ªå¼‚å¸¸é‡Œå°†æ‰€æœ‰çš„æ—§è¿æ¥å…¨éƒ¨å…³é—­äº†ï¼Œåç»­æŒ‡ä»¤å°±ä¼šè¿›è¡Œé‡è¿ã€‚

ä¸»ä»åˆ‡æ¢åï¼Œä¹‹å‰çš„ä¸»åº“è¢«é™çº§åˆ°ä»åº“ï¼Œæ‰€æœ‰çš„ä¿®æ”¹æ€§çš„æŒ‡ä»¤éƒ½ä¼šæŠ›å‡º```ReadonlyError```ã€‚å¦‚æœæ²¡æœ‰ä¿®æ”¹æ€§æŒ‡ä»¤ï¼Œè™½ç„¶è¿æ¥ä¸ä¼šå¾—åˆ°åˆ‡æ¢ï¼Œä½†æ˜¯æ•°æ®ä¸ä¼šè¢«ç ´åï¼Œæ‰€ä»¥å³ä½¿ä¸åˆ‡æ¢ä¹Ÿæ²¡å…³ç³»ã€‚

ä½œä¸š
--
1. å°è¯•è‡ªå·±æ­å»ºä¸€å¥— redis-sentinel é›†ç¾¤ï¼›
2. ä½¿ç”¨ Python æˆ–è€… Java çš„å®¢æˆ·ç«¯å¯¹é›†ç¾¤è¿›è¡Œä¸€äº›å¸¸è§„æ“ä½œï¼›
3. è¯•è¯•ä¸»ä»åˆ‡æ¢ï¼Œä¸»åŠ¨åˆ‡æ¢å’Œè¢«åŠ¨åˆ‡æ¢éƒ½è¯•ä¸€è¯•ï¼Œçœ‹çœ‹å®¢æˆ·ç«¯èƒ½å¦æ­£å¸¸åˆ‡æ¢è¿æ¥ï¼›
# é›†ç¾¤ 2ï¼šåˆ†è€Œæ²»ä¹‹ â€”â€” Codis

åœ¨å¤§æ•°æ®é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå•ä¸ª Redis å®ä¾‹å¾€å¾€ä¼šæ˜¾å¾—æ‰è¥Ÿè§è‚˜ã€‚é¦–å…ˆä½“ç°åœ¨å†…å­˜ä¸Šï¼Œå•ä¸ª Redis çš„å†…å­˜ä¸å®œè¿‡å¤§ï¼Œå†…å­˜å¤ªå¤§ä¼šå¯¼è‡´ rdb æ–‡ä»¶è¿‡å¤§ï¼Œè¿›ä¸€æ­¥å¯¼è‡´ä¸»ä»åŒæ­¥æ—¶å…¨é‡åŒæ­¥æ—¶é—´è¿‡é•¿ï¼Œåœ¨å®ä¾‹é‡å¯æ¢å¤æ—¶ä¹Ÿä¼šæ¶ˆè€—å¾ˆé•¿çš„æ•°æ®åŠ è½½æ—¶é—´ï¼Œç‰¹åˆ«æ˜¯åœ¨äº‘ç¯å¢ƒä¸‹ï¼Œå•ä¸ªå®ä¾‹å†…å­˜å¾€å¾€éƒ½æ˜¯å—é™çš„ã€‚å…¶æ¬¡ä½“ç°åœ¨ CPU çš„åˆ©ç”¨ç‡ä¸Šï¼Œå•ä¸ª Redis å®ä¾‹åªèƒ½åˆ©ç”¨å•ä¸ªæ ¸å¿ƒï¼Œè¿™å•ä¸ªæ ¸å¿ƒè¦å®Œæˆæµ·é‡æ•°æ®çš„å­˜å–å’Œç®¡ç†å·¥ä½œå‹åŠ›ä¼šéå¸¸å¤§ã€‚

æ­£æ˜¯åœ¨è¿™æ ·çš„å¤§æ•°æ®é«˜å¹¶å‘çš„éœ€æ±‚ä¹‹ä¸‹ï¼ŒRedis é›†ç¾¤æ–¹æ¡ˆåº”è¿è€Œç”Ÿã€‚å®ƒå¯ä»¥å°†ä¼—å¤šå°å†…å­˜çš„ Redis å®ä¾‹ç»¼åˆèµ·æ¥ï¼Œå°†åˆ†å¸ƒåœ¨å¤šå°æœºå™¨ä¸Šçš„ä¼—å¤š CPU æ ¸å¿ƒçš„è®¡ç®—èƒ½åŠ›èšé›†åˆ°ä¸€èµ·ï¼Œå®Œæˆæµ·é‡æ•°æ®å­˜å‚¨å’Œé«˜å¹¶å‘è¯»å†™æ“ä½œã€‚

![](https://user-gold-cdn.xitu.io/2018/5/30/163af9facdbecdbc?w=583&h=132&f=png&s=18820)

[Codis](https://github.com/CodisLabs/codis) æ˜¯ Redis é›†ç¾¤æ–¹æ¡ˆä¹‹ä¸€ï¼Œä»¤æˆ‘ä»¬æ„Ÿåˆ°éª„å‚²çš„æ˜¯ï¼Œå®ƒæ˜¯ä¸­å›½äººå¼€å‘å¹¶å¼€æºçš„ï¼Œæ¥è‡ªå‰è±Œè±†èšä¸­é—´ä»¶å›¢é˜Ÿã€‚ç»å¤§å¤šæ•°å›½å†…çš„å¼€æºé¡¹ç›®éƒ½ä¸æ€ä¹ˆé è°±ï¼Œä½†æ˜¯ Codis éå¸¸é è°±ã€‚æœ‰äº† Codis æŠ€æœ¯ç§¯ç´¯ä¹‹åï¼Œé¡¹ç›®ã€Œçªå¤´äººã€åˆ˜å¥‡åˆå¼€å‘å‡ºæ¥ä¸­å›½äººè‡ªå·±çš„å¼€æºåˆ†å¸ƒå¼æ•°æ®åº“ â€”â€” [TiDB](https://github.com/pingcap/tidb)ï¼Œå¯ä»¥è¯´ 6 åˆ°é£èµ·ã€‚ğŸ‘

ä» Redis çš„å¹¿æ³›æµè¡Œåˆ° RedisCluster çš„å¹¿æ³›ä½¿ç”¨ä¹‹é—´ç›¸éš”äº†å¥½å¤šå¹´ï¼ŒCodis å°±æ˜¯åœ¨è¿™æ ·çš„å¸‚åœºç©ºç¼ºçš„æœºé‡ä¸‹å‘å±•å‡ºæ¥çš„ã€‚å¤§å‹å…¬å¸æœ‰æ˜ç¡®çš„ Redis åœ¨çº¿æ‰©å®¹éœ€æ±‚ï¼Œä½†æ˜¯å¸‚é¢ä¸Šæ²¡æœ‰ç‰¹åˆ«å¥½çš„ä¸­é—´ä»¶å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/4/16464134248c9f73?w=639&h=303&f=png&s=26779)

Codis ä½¿ç”¨ Go è¯­è¨€å¼€å‘ï¼Œå®ƒæ˜¯ä¸€ä¸ªä»£ç†ä¸­é—´ä»¶ï¼Œå®ƒå’Œ Redis ä¸€æ ·ä¹Ÿä½¿ç”¨ Redis åè®®å¯¹å¤–æä¾›æœåŠ¡ï¼Œå½“å®¢æˆ·ç«¯å‘ Codis å‘é€æŒ‡ä»¤æ—¶ï¼ŒCodis è´Ÿè´£å°†æŒ‡ä»¤è½¬å‘åˆ°åé¢çš„ Redis å®ä¾‹æ¥æ‰§è¡Œï¼Œå¹¶å°†è¿”å›ç»“æœå†è½¬å›ç»™å®¢æˆ·ç«¯ã€‚

Codis ä¸ŠæŒ‚æ¥çš„æ‰€æœ‰ Redis å®ä¾‹æ„æˆä¸€ä¸ª Redis é›†ç¾¤ï¼Œå½“é›†ç¾¤ç©ºé—´ä¸è¶³æ—¶ï¼Œå¯ä»¥é€šè¿‡åŠ¨æ€å¢åŠ  Redis å®ä¾‹æ¥å®ç°æ‰©å®¹éœ€æ±‚ã€‚

å®¢æˆ·ç«¯æ“çºµ Codis åŒæ“çºµ Redis å‡ ä¹æ²¡æœ‰åŒºåˆ«ï¼Œè¿˜æ˜¯å¯ä»¥ä½¿ç”¨ç›¸åŒçš„å®¢æˆ·ç«¯ SDKï¼Œä¸éœ€è¦ä»»ä½•å˜åŒ–ã€‚

å› ä¸º Codis æ˜¯æ— çŠ¶æ€çš„ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªè½¬å‘ä»£ç†ä¸­é—´ä»¶ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å¯åŠ¨å¤šä¸ª Codis å®ä¾‹ï¼Œä¾›å®¢æˆ·ç«¯ä½¿ç”¨ï¼Œæ¯ä¸ª Codis èŠ‚ç‚¹éƒ½æ˜¯å¯¹ç­‰çš„ã€‚å› ä¸ºå•ä¸ª Codis ä»£ç†èƒ½æ”¯æ’‘çš„ QPS æ¯”è¾ƒæœ‰é™ï¼Œé€šè¿‡å¯åŠ¨å¤šä¸ª Codis ä»£ç†å¯ä»¥æ˜¾è‘—å¢åŠ æ•´ä½“çš„ QPS éœ€æ±‚ï¼Œè¿˜èƒ½èµ·åˆ°å®¹ç¾åŠŸèƒ½ï¼ŒæŒ‚æ‰ä¸€ä¸ª Codis ä»£ç†æ²¡å…³ç³»ï¼Œè¿˜æœ‰å¾ˆå¤š Codis ä»£ç†å¯ä»¥ç»§ç»­æœåŠ¡ã€‚


![](https://user-gold-cdn.xitu.io/2018/7/4/1646414ff83e5846?w=672&h=319&f=png&s=37238)

Codis åˆ†ç‰‡åŸç†
--
Codis è¦è´Ÿè´£å°†ç‰¹å®šçš„ key è½¬å‘åˆ°ç‰¹å®šçš„ Redis å®ä¾‹ï¼Œé‚£ä¹ˆè¿™ç§å¯¹åº”å…³ç³» Codis æ˜¯å¦‚ä½•ç®¡ç†çš„å‘¢ï¼Ÿ

Codis å°†æ‰€æœ‰çš„ key é»˜è®¤åˆ’åˆ†ä¸º 1024 ä¸ªæ§½ä½(slot)ï¼Œå®ƒé¦–å…ˆå¯¹å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„ key è¿›è¡Œ crc32 è¿ç®—è®¡ç®—å“ˆå¸Œå€¼ï¼Œå†å°† hash åçš„æ•´æ•°å€¼å¯¹ 1024 è¿™ä¸ªæ•´æ•°è¿›è¡Œå–æ¨¡å¾—åˆ°ä¸€ä¸ªä½™æ•°ï¼Œè¿™ä¸ªä½™æ•°å°±æ˜¯å¯¹åº” key çš„æ§½ä½ã€‚

![](https://user-gold-cdn.xitu.io/2018/5/30/163b010123791e6a?w=573&h=387&f=png&s=23473)

æ¯ä¸ªæ§½ä½éƒ½ä¼šå”¯ä¸€æ˜ å°„åˆ°åé¢çš„å¤šä¸ª Redis å®ä¾‹ä¹‹ä¸€ï¼ŒCodis ä¼šåœ¨å†…å­˜ç»´æŠ¤æ§½ä½å’Œ Redis å®ä¾‹çš„æ˜ å°„å…³ç³»ã€‚è¿™æ ·æœ‰äº†ä¸Šé¢ key å¯¹åº”çš„æ§½ä½ï¼Œé‚£ä¹ˆå®ƒåº”è¯¥è½¬å‘åˆ°å“ªä¸ª Redis å®ä¾‹å°±å¾ˆæ˜ç¡®äº†ã€‚

```py
hash = crc32(command.key)
slot_index = hash % 1024
redis = slots[slot_index].redis
redis.do(command)
```

æ§½ä½æ•°é‡é»˜è®¤æ˜¯1024ï¼Œå®ƒæ˜¯å¯ä»¥é…ç½®çš„ï¼Œå¦‚æœé›†ç¾¤èŠ‚ç‚¹æ¯”è¾ƒå¤šï¼Œå»ºè®®å°†è¿™ä¸ªæ•°å€¼é…ç½®å¤§ä¸€äº›ï¼Œæ¯”å¦‚2048ã€4096ã€‚

ä¸åŒçš„ Codis å®ä¾‹ä¹‹é—´æ§½ä½å…³ç³»å¦‚ä½•åŒæ­¥ï¼Ÿ
--
å¦‚æœ Codis çš„æ§½ä½æ˜ å°„å…³ç³»åªå­˜å‚¨åœ¨å†…å­˜é‡Œï¼Œé‚£ä¹ˆä¸åŒçš„ Codis å®ä¾‹ä¹‹é—´çš„æ§½ä½å…³ç³»å°±æ— æ³•å¾—åˆ°åŒæ­¥ã€‚æ‰€ä»¥ Codis è¿˜éœ€è¦ä¸€ä¸ªåˆ†å¸ƒå¼é…ç½®å­˜å‚¨æ•°æ®åº“ä¸“é—¨ç”¨æ¥æŒä¹…åŒ–æ§½ä½å…³ç³»ã€‚Codis å¼€å§‹ä½¿ç”¨ ZooKeeperï¼Œåæ¥è¿ etcd ä¹Ÿä¸€å—æ”¯æŒäº†ã€‚


![](https://user-gold-cdn.xitu.io/2018/7/4/16464178c9cc01fd?w=591&h=256&f=png&s=21319)

Codis å°†æ§½ä½å…³ç³»å­˜å‚¨åœ¨ zk ä¸­ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ä¸ª Dashboard å¯ä»¥ç”¨æ¥è§‚å¯Ÿå’Œä¿®æ”¹æ§½ä½å…³ç³»ï¼Œå½“æ§½ä½å…³ç³»å˜åŒ–æ—¶ï¼ŒCodis Proxy ä¼šç›‘å¬åˆ°å˜åŒ–å¹¶é‡æ–°åŒæ­¥æ§½ä½å…³ç³»ï¼Œä»è€Œå®ç°å¤šä¸ª Codis Proxy ä¹‹é—´å…±äº«ç›¸åŒçš„æ§½ä½å…³ç³»é…ç½®ã€‚

æ‰©å®¹
--
åˆšå¼€å§‹ Codis åç«¯åªæœ‰ä¸€ä¸ª Redis å®ä¾‹ï¼Œ1024 ä¸ªæ§½ä½å…¨éƒ¨æŒ‡å‘åŒä¸€ä¸ª Redisã€‚ç„¶åä¸€ä¸ª Redis å®ä¾‹å†…å­˜ä¸å¤Ÿäº†ï¼Œæ‰€ä»¥åˆåŠ äº†ä¸€ä¸ª Redis å®ä¾‹ã€‚è¿™æ—¶å€™éœ€è¦å¯¹æ§½ä½å…³ç³»è¿›è¡Œè°ƒæ•´ï¼Œå°†ä¸€åŠçš„æ§½ä½åˆ’åˆ†åˆ°æ–°çš„èŠ‚ç‚¹ã€‚è¿™æ„å‘³ç€éœ€è¦å¯¹è¿™ä¸€åŠçš„æ§½ä½å¯¹åº”çš„æ‰€æœ‰ key è¿›è¡Œè¿ç§»ï¼Œè¿ç§»åˆ°æ–°çš„ Redis å®ä¾‹ã€‚

**é‚£ Codis å¦‚ä½•æ‰¾åˆ°æ§½ä½å¯¹åº”çš„æ‰€æœ‰ key å‘¢ï¼Ÿ**

Codis å¯¹ Redis è¿›è¡Œäº†æ”¹é€ ï¼Œå¢åŠ äº† SLOTSSCAN æŒ‡ä»¤ï¼Œå¯ä»¥éå†æŒ‡å®š slot ä¸‹æ‰€æœ‰çš„ keyã€‚Codis é€šè¿‡ SLOTSSCAN æ‰«æå‡ºå¾…è¿ç§»æ§½ä½çš„æ‰€æœ‰çš„ keyï¼Œç„¶åæŒ¨ä¸ªè¿ç§»æ¯ä¸ª key åˆ°æ–°çš„ Redis èŠ‚ç‚¹ã€‚

åœ¨è¿ç§»è¿‡ç¨‹ä¸­ï¼ŒCodis è¿˜æ˜¯ä¼šæ¥æ”¶åˆ°æ–°çš„è¯·æ±‚æ‰“åœ¨å½“å‰æ­£åœ¨è¿ç§»çš„æ§½ä½ä¸Šï¼Œå› ä¸ºå½“å‰æ§½ä½çš„æ•°æ®åŒæ—¶å­˜åœ¨äºæ–°æ—§ä¸¤ä¸ªæ§½ä½ä¸­ï¼ŒCodis å¦‚ä½•åˆ¤æ–­è¯¥å°†è¯·æ±‚è½¬å‘åˆ°åé¢çš„å“ªä¸ªå…·ä½“å®ä¾‹å‘¢ï¼Ÿ

Codis æ— æ³•åˆ¤å®šè¿ç§»è¿‡ç¨‹ä¸­çš„ key ç©¶ç«Ÿåœ¨å“ªä¸ªå®ä¾‹ä¸­ï¼Œæ‰€ä»¥å®ƒé‡‡ç”¨äº†å¦ä¸€ç§å®Œå…¨ä¸åŒçš„æ€è·¯ã€‚å½“ Codis æ¥æ”¶åˆ°ä½äºæ­£åœ¨è¿ç§»æ§½ä½ä¸­çš„ key åï¼Œä¼šç«‹å³å¼ºåˆ¶å¯¹å½“å‰çš„å•ä¸ª key è¿›è¡Œè¿ç§»ï¼Œè¿ç§»å®Œæˆåï¼Œå†å°†è¯·æ±‚è½¬å‘åˆ°æ–°çš„ Redis å®ä¾‹ã€‚
```
slot_index = crc32(command.key) % 1024
if slot_index in migrating_slots:
	do_migrate_key(command.key)  # å¼ºåˆ¶æ‰§è¡Œè¿ç§»
	redis = slots[slot_index].new_redis
else:
	redis = slots[slot_index].redis
redis.do(command)
```
æˆ‘ä»¬çŸ¥é“ Redis æ”¯æŒçš„æ‰€æœ‰ Scan æŒ‡ä»¤éƒ½æ˜¯æ— æ³•é¿å…é‡å¤çš„ï¼ŒåŒæ · Codis è‡ªå®šä¹‰çš„ SLOTSSCAN ä¹Ÿæ˜¯ä¸€æ ·ï¼Œä½†æ˜¯è¿™å¹¶ä¸ä¼šå½±å“è¿ç§»ã€‚å› ä¸ºå•ä¸ª key è¢«è¿ç§»ä¸€æ¬¡åï¼Œåœ¨æ—§å®ä¾‹ä¸­å®ƒå°±å½»åº•è¢«åˆ é™¤äº†ï¼Œä¹Ÿå°±ä¸å¯èƒ½ä¼šå†æ¬¡è¢«æ‰«æå‡ºæ¥äº†ã€‚

è‡ªåŠ¨å‡è¡¡
--
Redis æ–°å¢å®ä¾‹ï¼Œæ‰‹å·¥å‡è¡¡slotså¤ªç¹çï¼Œæ‰€ä»¥ Codis æä¾›äº†è‡ªåŠ¨å‡è¡¡åŠŸèƒ½ã€‚è‡ªåŠ¨å‡è¡¡ä¼šåœ¨ç³»ç»Ÿæ¯”è¾ƒç©ºé—²çš„æ—¶å€™è§‚å¯Ÿæ¯ä¸ª Redis å®ä¾‹å¯¹åº”çš„ Slots æ•°é‡ï¼Œå¦‚æœä¸å¹³è¡¡ï¼Œå°±ä¼šè‡ªåŠ¨è¿›è¡Œè¿ç§»ã€‚

Codis çš„ä»£ä»·
--
Codis ç»™ Redis å¸¦æ¥äº†æ‰©å®¹çš„åŒæ—¶ï¼Œä¹ŸæŸå¤±äº†å…¶å®ƒä¸€äº›ç‰¹æ€§ã€‚å› ä¸º Codis ä¸­æ‰€æœ‰çš„ key åˆ†æ•£åœ¨ä¸åŒçš„ Redis å®ä¾‹ä¸­ï¼Œæ‰€ä»¥äº‹åŠ¡å°±ä¸èƒ½å†æ”¯æŒäº†ï¼Œäº‹åŠ¡åªèƒ½åœ¨å•ä¸ª Redis å®ä¾‹ä¸­å®Œæˆã€‚åŒæ · rename æ“ä½œä¹Ÿå¾ˆå±é™©ï¼Œå®ƒçš„å‚æ•°æ˜¯ä¸¤ä¸ª keyï¼Œå¦‚æœè¿™ä¸¤ä¸ª key åœ¨ä¸åŒçš„ Redis å®ä¾‹ä¸­ï¼Œrename æ“ä½œæ˜¯æ— æ³•æ­£ç¡®å®Œæˆçš„ã€‚Codis çš„å®˜æ–¹æ–‡æ¡£ä¸­ç»™å‡ºäº†ä¸€ç³»åˆ—ä¸æ”¯æŒçš„å‘½ä»¤åˆ—è¡¨ã€‚

åŒæ ·ä¸ºäº†æ”¯æŒæ‰©å®¹ï¼Œå•ä¸ª key å¯¹åº”çš„ value ä¸å®œè¿‡å¤§ï¼Œå› ä¸ºé›†ç¾¤çš„è¿ç§»çš„æœ€å°å•ä½æ˜¯ keyï¼Œå¯¹äºä¸€ä¸ª hash ç»“æ„ï¼Œå®ƒä¼šä¸€æ¬¡æ€§ä½¿ç”¨ hgetall æ‹‰å–æ‰€æœ‰çš„å†…å®¹ï¼Œç„¶åä½¿ç”¨ hmset æ”¾ç½®åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ã€‚å¦‚æœ hash å†…éƒ¨çš„ kv å¤ªå¤šï¼Œå¯èƒ½ä¼šå¸¦æ¥è¿ç§»å¡é¡¿ã€‚å®˜æ–¹å»ºè®®å•ä¸ªé›†åˆç»“æ„çš„æ€»å­—èŠ‚å®¹é‡ä¸è¦è¶…è¿‡ 1Mã€‚å¦‚æœæˆ‘ä»¬è¦æ”¾ç½®ç¤¾äº¤å…³ç³»æ•°æ®ï¼Œä¾‹å¦‚ç²‰ä¸åˆ—è¡¨è¿™ç§ï¼Œå°±éœ€è¦æ³¨æ„äº†ï¼Œå¯ä»¥è€ƒè™‘åˆ†æ¡¶å­˜å‚¨ï¼Œåœ¨ä¸šåŠ¡ä¸Šä½œæŠ˜ä¸­ã€‚

Codis å› ä¸ºå¢åŠ äº† Proxy ä½œä¸ºä¸­è½¬å±‚ï¼Œæ‰€æœ‰åœ¨ç½‘ç»œå¼€é”€ä¸Šè¦æ¯”å•ä¸ª Redis å¤§ï¼Œæ¯•ç«Ÿæ•°æ®åŒ…å¤šèµ°äº†ä¸€ä¸ªç½‘ç»œèŠ‚ç‚¹ï¼Œæ•´ä½“åœ¨æ€§èƒ½ä¸Šè¦æ¯”å•ä¸ª Redis çš„æ€§èƒ½æœ‰æ‰€ä¸‹é™ã€‚ä½†æ˜¯è¿™éƒ¨åˆ†æ€§èƒ½æŸè€—ä¸æ˜¯å¤ªæ˜æ˜¾ï¼Œå¯ä»¥é€šè¿‡å¢åŠ  Proxy çš„æ•°é‡æ¥å¼¥è¡¥æ€§èƒ½ä¸Šçš„ä¸è¶³ã€‚

Codis çš„é›†ç¾¤é…ç½®ä¸­å¿ƒä½¿ç”¨ zk æ¥å®ç°ï¼Œæ„å‘³ç€åœ¨éƒ¨ç½²ä¸Šå¢åŠ äº† zk è¿ç»´çš„ä»£ä»·ï¼Œä¸è¿‡å¤§éƒ¨åˆ†äº’è”ç½‘ä¼ä¸šå†…éƒ¨éƒ½æœ‰ zk é›†ç¾¤ï¼Œå¯ä»¥ä½¿ç”¨ç°æœ‰çš„ zk é›†ç¾¤ä½¿ç”¨å³å¯ã€‚

Codis çš„ä¼˜ç‚¹
--
Codis åœ¨è®¾è®¡ä¸Šç›¸æ¯” Redis Cluster å®˜æ–¹é›†ç¾¤æ–¹æ¡ˆè¦ç®€å•å¾ˆå¤šï¼Œå› ä¸ºå®ƒå°†åˆ†å¸ƒå¼çš„é—®é¢˜äº¤ç»™äº†ç¬¬ä¸‰æ–¹ zk/etcd å»è´Ÿè´£ï¼Œè‡ªå·±å°±çœå»äº†å¤æ‚çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ä»£ç çš„ç¼–å†™ç»´æŠ¤å·¥ä½œã€‚è€Œ Redis Cluster çš„å†…éƒ¨å®ç°éå¸¸å¤æ‚ï¼Œå®ƒä¸ºäº†å®ç°å»ä¸­å¿ƒåŒ–ï¼Œæ··åˆä½¿ç”¨äº†å¤æ‚çš„ Raft å’Œ Gossip åè®®ï¼Œè¿˜æœ‰å¤§é‡çš„éœ€è¦è°ƒä¼˜çš„é…ç½®å‚æ•°ï¼Œå½“é›†ç¾¤å‡ºç°æ•…éšœæ—¶ï¼Œç»´æŠ¤äººå‘˜å¾€å¾€ä¸çŸ¥é“ä»ä½•å¤„ç€æ‰‹ã€‚

MGET æŒ‡ä»¤çš„æ“ä½œè¿‡ç¨‹
--

![](https://user-gold-cdn.xitu.io/2018/7/10/16481f2b7825a89f?w=774&h=348&f=png&s=25251)
mget æŒ‡ä»¤ç”¨äºæ‰¹é‡è·å–å¤šä¸ª key çš„å€¼ï¼Œè¿™äº› key å¯èƒ½ä¼šåˆ†å¸ƒåœ¨å¤šä¸ª Redis å®ä¾‹ä¸­ã€‚Codis çš„ç­–ç•¥æ˜¯å°† key æŒ‰ç…§æ‰€åˆ†é…çš„å®ä¾‹æ‰“æ•£åˆ†ç»„ï¼Œç„¶åä¾æ¬¡å¯¹æ¯ä¸ªå®ä¾‹è°ƒç”¨ mget æ–¹æ³•ï¼Œæœ€åå°†ç»“æœæ±‡æ€»ä¸ºä¸€ä¸ªï¼Œå†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

æ¶æ„å˜è¿
--
Codis ä½œä¸ºéå®˜æ–¹ Redis é›†ç¾¤æ–¹æ¡ˆï¼Œè¿‘å‡ å¹´æ¥å®ƒçš„ç»“æ„ä¸€ç›´åœ¨ä¸æ–­å˜åŒ–ï¼Œä¸€æ–¹é¢å½“å®˜æ–¹çš„ Redis æœ‰å˜åŒ–çš„æ—¶å€™å®ƒè¦å®æ—¶å»è·Ÿè¿›ï¼Œå¦ä¸€æ–¹é¢å®ƒä½œä¸º Redis Cluster çš„ç«äº‰æ–¹æ¡ˆä¹‹ä¸€ï¼Œå®ƒè¿˜å¾—æŒç»­æé«˜è‡ªå·±çš„ç«äº‰åŠ›ï¼Œç»™è‡ªå·±å¢åŠ æ›´å¤šçš„å®˜æ–¹é›†ç¾¤æ‰€æ²¡æœ‰çš„ä¾¿æ·åŠŸèƒ½ã€‚

æ¯”å¦‚ Codis æœ‰ä¸ªç‰¹è‰²çš„åœ°æ–¹åœ¨äºå¼ºå¤§çš„ Dashboard åŠŸèƒ½ï¼Œèƒ½å¤Ÿä¾¿æ·åœ°å¯¹ Redis é›†ç¾¤è¿›è¡Œç®¡ç†ã€‚è¿™æ˜¯ Redis å®˜æ–¹æ‰€æ¬ ç¼ºçš„ã€‚å¦å¤– Codis è¿˜å¼€å‘äº†ä¸€ä¸ª Codis-fe(federation è”é‚¦) å·¥å…·ï¼Œå¯ä»¥åŒæ—¶å¯¹å¤šä¸ª Codis é›†ç¾¤è¿›è¡Œç®¡ç†ã€‚åœ¨å¤§å‹ä¼ä¸šï¼ŒCodis é›†ç¾¤å¾€å¾€ä¼šæœ‰å‡ åä¸ªï¼Œæœ‰è¿™æ ·ä¸€ä¸ªä¾¿æ·çš„è”é‚¦å·¥å…·å¯ä»¥é™ä½ä¸å°‘è¿ç»´æˆæœ¬ã€‚

Codis çš„å°´å°¬
--
Codis ä¸æ˜¯ Redis å®˜æ–¹é¡¹ç›®ï¼Œè¿™æ„å‘³ç€å®ƒçš„å‘½è¿ä¼šæ— æ¯”æ›²æŠ˜ï¼Œå®ƒæ€»æ˜¯è¦è¢«å®˜æ–¹ Redis ç‰µç€ç‰›é¼»å­èµ°ã€‚å½“ Redis å®˜æ–¹æä¾›äº†ä»€ä¹ˆåŠŸèƒ½å®ƒæ¬ ç¼ºæ—¶ï¼ŒCodis å°±ä¼šæ„Ÿåˆ°ææƒ§ï¼Œå®³æ€•è‡ªå·±è¢«å¸‚åœºç”©æ‰ï¼Œæ‰€ä»¥å¿…é¡»å®æ—¶ä¿æŒè·Ÿè¿›ã€‚

åŒæ—¶å› ä¸º Codis æ€»æ˜¯è¦æ¯” Redis å®˜æ–¹æ…¢ä¸€æ‹ï¼ŒRedis å®˜æ–¹æä¾›çš„æœ€æ–°åŠŸèƒ½ï¼ŒCodis å¾€å¾€è¦ç­‰å¾ˆä¹…æ‰èƒ½åŒæ­¥ã€‚æ¯”å¦‚ç°åœ¨ Redis å·²ç»è¿›å…¥åˆ° 4.0 é˜¶æ®µï¼Œæä¾›äº†æ’ä»¶åŒ– Redis-Module æ”¯æŒï¼Œç›®å‰ Codis è¿˜æ²¡æœ‰æä¾›è§£å†³æ–¹æ¡ˆã€‚

ç°åœ¨ Redis-Cluster åœ¨ä¸šç•Œå·²ç»é€æ¸æµè¡Œèµ·æ¥ï¼ŒCodis èƒ½å¦æŒç»­ä¿æŒç«äº‰åŠ›æ˜¯ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çœ‹åˆ° Codis åœ¨ä¸æ–­çš„å·®å¼‚åŒ–ç«äº‰ï¼Œç«äº‰çš„æ–¹æ³•å°±ä½“ç°åœ¨å·¥å…·ä¸Šï¼Œè€Œä¸æ˜¯å†…æ ¸ï¼Œè¿™ä¸ªå’Œå®˜æ–¹çš„è·¯çº¿çœŸæ˜¯ç›¸åçš„ï¼Œå®˜æ–¹å¯¹å·¥å…·æ— æš‡é¡¾åŠï¼Œåªæä¾›åŸºæœ¬çš„å·¥å…·ï¼Œå…¶å®ƒå®Œå…¨äº¤ç»™ç¬¬ä¸‰æ–¹å»å¼€å‘ã€‚

Codis çš„åå°ç®¡ç†
--
åå°ç®¡ç†çš„ç•Œé¢éå¸¸å‹å¥½ï¼Œä½¿ç”¨äº†æœ€æ–°çš„ BootStrap å‰ç«¯æ¡†æ¶ã€‚æ¯”è¾ƒé…·ç‚«çš„æ˜¯å¯ä»¥çœ‹åˆ°å®æ—¶çš„ QPS æ³¢åŠ¨æ›²çº¿ã€‚

![](https://user-gold-cdn.xitu.io/2018/5/30/163af25a3336bf5e?w=1180&h=1549&f=png&s=211168)

åŒæ—¶è¿˜æ”¯æŒæœåŠ¡å™¨é›†ç¾¤ç®¡ç†åŠŸèƒ½ï¼Œå¯ä»¥å¢åŠ åˆ†ç»„ã€å¢åŠ èŠ‚ç‚¹ã€æ‰§è¡Œè‡ªåŠ¨å‡è¡¡ç­‰æŒ‡ä»¤ï¼Œè¿˜å¯ä»¥ç›´æ¥æŸ¥çœ‹æ‰€æœ‰ slot çš„çŠ¶æ€ï¼Œæ¯ä¸ª slot è¢«åˆ†é…åˆ°å“ªä¸ª Redis å®ä¾‹ã€‚

æ€è€ƒ & ä½œä¸š
--
1. è¯·è¯»è€…è‡ªå·±å°è¯•æ­å»ºä¸€ä¸ª Codis é›†ç¾¤ã€‚
2. ä½¿ç”¨ Python æˆ–è€… Java å®¢æˆ·ç«¯ä½“éªŒä¸€ä¸‹ Codis é›†ç¾¤çš„å¸¸è§„ Redis æŒ‡ä»¤ã€‚

# é›†ç¾¤ 3ï¼šä¼—å¿—æˆåŸ â€”â€” Cluster

![](https://user-gold-cdn.xitu.io/2018/5/30/163afa911c3118fa?w=299&h=194&f=png&s=27566)
RedisCluster æ˜¯ Redis çš„äº²å„¿å­ï¼Œå®ƒæ˜¯ Redis ä½œè€…è‡ªå·±æä¾›çš„ Redis é›†ç¾¤åŒ–æ–¹æ¡ˆã€‚

ç›¸å¯¹äº Codis çš„ä¸åŒï¼Œå®ƒæ˜¯å»ä¸­å¿ƒåŒ–çš„ï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œè¯¥é›†ç¾¤æœ‰ä¸‰ä¸ª Redis èŠ‚ç‚¹ç»„æˆï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£æ•´ä¸ªé›†ç¾¤çš„ä¸€éƒ¨åˆ†æ•°æ®ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£çš„æ•°æ®å¤šå°‘å¯èƒ½ä¸ä¸€æ ·ã€‚è¿™ä¸‰ä¸ªèŠ‚ç‚¹ç›¸äº’è¿æ¥ç»„æˆä¸€ä¸ªå¯¹ç­‰çš„é›†ç¾¤ï¼Œå®ƒä»¬ä¹‹é—´é€šè¿‡ä¸€ç§ç‰¹æ®Šçš„äºŒè¿›åˆ¶åè®®ç›¸äº’äº¤äº’é›†ç¾¤ä¿¡æ¯ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/10/16481f3bd5ca1577?w=915&h=446&f=png&s=28479)

Redis Cluster å°†æ‰€æœ‰æ•°æ®åˆ’åˆ†ä¸º 16384 çš„ slotsï¼Œå®ƒæ¯” Codis çš„ 1024 ä¸ªæ§½åˆ’åˆ†çš„æ›´ä¸ºç²¾ç»†ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£å…¶ä¸­ä¸€éƒ¨åˆ†æ§½ä½ã€‚æ§½ä½çš„ä¿¡æ¯å­˜å‚¨äºæ¯ä¸ªèŠ‚ç‚¹ä¸­ï¼Œå®ƒä¸åƒ Codisï¼Œå®ƒä¸éœ€è¦å¦å¤–çš„åˆ†å¸ƒå¼å­˜å‚¨æ¥å­˜å‚¨èŠ‚ç‚¹æ§½ä½ä¿¡æ¯ã€‚

å½“ Redis Cluster çš„å®¢æˆ·ç«¯æ¥è¿æ¥é›†ç¾¤æ—¶ï¼Œå®ƒä¹Ÿä¼šå¾—åˆ°ä¸€ä»½é›†ç¾¤çš„æ§½ä½é…ç½®ä¿¡æ¯ã€‚è¿™æ ·å½“å®¢æˆ·ç«¯è¦æŸ¥æ‰¾æŸä¸ª key æ—¶ï¼Œå¯ä»¥ç›´æ¥å®šä½åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚

è¿™ç‚¹ä¸åŒäº Codisï¼ŒCodis éœ€è¦é€šè¿‡ Proxy æ¥å®šä½ç›®æ ‡èŠ‚ç‚¹ï¼ŒRedisCluster æ˜¯ç›´æ¥å®šä½ã€‚å®¢æˆ·ç«¯ä¸ºäº†å¯ä»¥ç›´æ¥å®šä½æŸä¸ªå…·ä½“çš„ key æ‰€åœ¨çš„èŠ‚ç‚¹ï¼Œå®ƒå°±éœ€è¦ç¼“å­˜æ§½ä½ç›¸å…³ä¿¡æ¯ï¼Œè¿™æ ·æ‰å¯ä»¥å‡†ç¡®å¿«é€Ÿåœ°å®šä½åˆ°ç›¸åº”çš„èŠ‚ç‚¹ã€‚åŒæ—¶å› ä¸ºæ§½ä½çš„ä¿¡æ¯å¯èƒ½ä¼šå­˜åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¸ä¸€è‡´çš„æƒ…å†µï¼Œè¿˜éœ€è¦çº æ­£æœºåˆ¶æ¥å®ç°æ§½ä½ä¿¡æ¯çš„æ ¡éªŒè°ƒæ•´ã€‚

å¦å¤–ï¼ŒRedisCluster çš„æ¯ä¸ªèŠ‚ç‚¹ä¼šå°†é›†ç¾¤çš„é…ç½®ä¿¡æ¯æŒä¹…åŒ–åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥å¿…é¡»ç¡®ä¿é…ç½®æ–‡ä»¶æ˜¯å¯å†™çš„ï¼Œè€Œä¸”å°½é‡ä¸è¦ä¾é äººå·¥ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚

æ§½ä½å®šä½ç®—æ³•
--
Cluster é»˜è®¤ä¼šå¯¹ key å€¼ä½¿ç”¨ crc16 ç®—æ³•è¿›è¡Œ hash å¾—åˆ°ä¸€ä¸ªæ•´æ•°å€¼ï¼Œç„¶åç”¨è¿™ä¸ªæ•´æ•°å€¼å¯¹ 16384 è¿›è¡Œå–æ¨¡æ¥å¾—åˆ°å…·ä½“æ§½ä½ã€‚

Cluster è¿˜å…è®¸ç”¨æˆ·å¼ºåˆ¶æŸä¸ª key æŒ‚åœ¨ç‰¹å®šæ§½ä½ä¸Šï¼Œé€šè¿‡åœ¨ key å­—ç¬¦ä¸²é‡Œé¢åµŒå…¥ tag æ ‡è®°ï¼Œè¿™å°±å¯ä»¥å¼ºåˆ¶ key æ‰€æŒ‚åœ¨çš„æ§½ä½ç­‰äº tag æ‰€åœ¨çš„æ§½ä½ã€‚

```ruby
def HASH_SLOT(key)
    s = key.index "{"
    if s
        e = key.index "}",s+1
        if e && e != s+1
            key = key[s+1..e-1]
        end
    end
    crc16(key) % 16384
end
```

è·³è½¬
--
å½“å®¢æˆ·ç«¯å‘ä¸€ä¸ªé”™è¯¯çš„èŠ‚ç‚¹å‘å‡ºäº†æŒ‡ä»¤ï¼Œè¯¥èŠ‚ç‚¹ä¼šå‘ç°æŒ‡ä»¤çš„ key æ‰€åœ¨çš„æ§½ä½å¹¶ä¸å½’è‡ªå·±ç®¡ç†ï¼Œè¿™æ—¶å®ƒä¼šå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªç‰¹æ®Šçš„è·³è½¬æŒ‡ä»¤æºå¸¦ç›®æ ‡æ“ä½œçš„èŠ‚ç‚¹åœ°å€ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯å»è¿è¿™ä¸ªèŠ‚ç‚¹å»è·å–æ•°æ®ã€‚

```
GET x
-MOVED 3999 127.0.0.1:6381
```
MOVED æŒ‡ä»¤çš„ç¬¬ä¸€ä¸ªå‚æ•° 3999 æ˜¯ key å¯¹åº”çš„æ§½ä½ç¼–å·ï¼Œåé¢æ˜¯ç›®æ ‡èŠ‚ç‚¹åœ°å€ã€‚MOVED æŒ‡ä»¤å‰é¢æœ‰ä¸€ä¸ªå‡å·ï¼Œè¡¨ç¤ºè¯¥æŒ‡ä»¤æ˜¯ä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ã€‚

å®¢æˆ·ç«¯æ”¶åˆ° MOVED æŒ‡ä»¤åï¼Œè¦ç«‹å³çº æ­£æœ¬åœ°çš„æ§½ä½æ˜ å°„è¡¨ã€‚åç»­æ‰€æœ‰ key å°†ä½¿ç”¨æ–°çš„æ§½ä½æ˜ å°„è¡¨ã€‚

## è¿ç§»

Redis Cluster æä¾›äº†å·¥å…· redis-trib å¯ä»¥è®©è¿ç»´äººå‘˜æ‰‹åŠ¨è°ƒæ•´æ§½ä½çš„åˆ†é…æƒ…å†µï¼Œå®ƒä½¿ç”¨ Ruby è¯­è¨€è¿›è¡Œå¼€å‘ï¼Œé€šè¿‡ç»„åˆå„ç§åŸç”Ÿçš„ Redis Cluster æŒ‡ä»¤æ¥å®ç°ã€‚è¿™ç‚¹ Codis åšçš„æ›´åŠ äººæ€§åŒ–ï¼Œå®ƒä¸ä½†æä¾›äº† UI ç•Œé¢å¯ä»¥è®©æˆ‘ä»¬æ–¹ä¾¿çš„è¿ç§»ï¼Œè¿˜æä¾›äº†è‡ªåŠ¨åŒ–å¹³è¡¡æ§½ä½å·¥å…·ï¼Œæ— éœ€äººå·¥å¹²é¢„å°±å¯ä»¥å‡è¡¡é›†ç¾¤è´Ÿè½½ã€‚ä¸è¿‡ Redis å®˜æ–¹å‘æ¥çš„ç­–ç•¥å°±æ˜¯æä¾›æœ€å°å¯ç”¨çš„å·¥å…·ï¼Œå…¶å®ƒéƒ½äº¤ç”±ç¤¾åŒºå®Œæˆã€‚

**è¿ç§»è¿‡ç¨‹**

![](https://user-gold-cdn.xitu.io/2018/7/31/164f0ac2cd2a1c9f?w=1256&h=698&f=png&s=121551)

Redis è¿ç§»çš„å•ä½æ˜¯æ§½ï¼ŒRedis ä¸€ä¸ªæ§½ä¸€ä¸ªæ§½è¿›è¡Œè¿ç§»ï¼Œå½“ä¸€ä¸ªæ§½æ­£åœ¨è¿ç§»æ—¶ï¼Œè¿™ä¸ªæ§½å°±å¤„äºä¸­é—´è¿‡æ¸¡çŠ¶æ€ã€‚è¿™ä¸ªæ§½åœ¨åŸèŠ‚ç‚¹çš„çŠ¶æ€ä¸º```migrating```ï¼Œåœ¨ç›®æ ‡èŠ‚ç‚¹çš„çŠ¶æ€ä¸º```importing```ï¼Œè¡¨ç¤ºæ•°æ®æ­£åœ¨ä»æºæµå‘ç›®æ ‡ã€‚

è¿ç§»å·¥å…· redis-trib é¦–å…ˆä¼šåœ¨æºå’Œç›®æ ‡èŠ‚ç‚¹è®¾ç½®å¥½ä¸­é—´è¿‡æ¸¡çŠ¶æ€ï¼Œç„¶åä¸€æ¬¡æ€§è·å–æºèŠ‚ç‚¹æ§½ä½çš„æ‰€æœ‰ key åˆ—è¡¨(keysinslotæŒ‡ä»¤ï¼Œå¯ä»¥éƒ¨åˆ†è·å–)ï¼Œå†æŒ¨ä¸ªkeyè¿›è¡Œè¿ç§»ã€‚æ¯ä¸ª key çš„è¿ç§»è¿‡ç¨‹æ˜¯ä»¥åŸèŠ‚ç‚¹ä½œä¸ºç›®æ ‡èŠ‚ç‚¹çš„ã€Œå®¢æˆ·ç«¯ã€ï¼ŒåŸèŠ‚ç‚¹å¯¹å½“å‰çš„keyæ‰§è¡ŒdumpæŒ‡ä»¤å¾—åˆ°åºåˆ—åŒ–å†…å®¹ï¼Œç„¶åé€šè¿‡ã€Œå®¢æˆ·ç«¯ã€å‘ç›®æ ‡èŠ‚ç‚¹å‘é€æŒ‡ä»¤restoreæºå¸¦åºåˆ—åŒ–çš„å†…å®¹ä½œä¸ºå‚æ•°ï¼Œç›®æ ‡èŠ‚ç‚¹å†è¿›è¡Œååºåˆ—åŒ–å°±å¯ä»¥å°†å†…å®¹æ¢å¤åˆ°ç›®æ ‡èŠ‚ç‚¹çš„å†…å­˜ä¸­ï¼Œç„¶åè¿”å›ã€Œå®¢æˆ·ç«¯ã€OKï¼ŒåŸèŠ‚ç‚¹ã€Œå®¢æˆ·ç«¯ã€æ”¶åˆ°åå†æŠŠå½“å‰èŠ‚ç‚¹çš„keyåˆ é™¤æ‰å°±å®Œæˆäº†å•ä¸ªkeyè¿ç§»çš„æ•´ä¸ªè¿‡ç¨‹ã€‚

**ä»æºèŠ‚ç‚¹è·å–å†…å®¹ => å­˜åˆ°ç›®æ ‡èŠ‚ç‚¹ => ä»æºèŠ‚ç‚¹åˆ é™¤å†…å®¹**ã€‚

æ³¨æ„è¿™é‡Œçš„è¿ç§»è¿‡ç¨‹æ˜¯åŒæ­¥çš„ï¼Œåœ¨ç›®æ ‡èŠ‚ç‚¹æ‰§è¡ŒrestoreæŒ‡ä»¤åˆ°åŸèŠ‚ç‚¹åˆ é™¤keyä¹‹é—´ï¼ŒåŸèŠ‚ç‚¹çš„ä¸»çº¿ç¨‹ä¼šå¤„äºé˜»å¡çŠ¶æ€ï¼Œç›´åˆ°keyè¢«æˆåŠŸåˆ é™¤ã€‚

å¦‚æœè¿ç§»è¿‡ç¨‹ä¸­çªç„¶å‡ºç°ç½‘ç»œæ•…éšœï¼Œæ•´ä¸ªslotçš„è¿ç§»åªè¿›è¡Œäº†ä¸€åŠã€‚è¿™æ—¶ä¸¤ä¸ªèŠ‚ç‚¹ä¾æ—§å¤„äºä¸­é—´è¿‡æ¸¡çŠ¶æ€ã€‚å¾…ä¸‹æ¬¡è¿ç§»å·¥å…·é‡æ–°è¿ä¸Šæ—¶ï¼Œä¼šæç¤ºç”¨æˆ·ç»§ç»­è¿›è¡Œè¿ç§»ã€‚

åœ¨è¿ç§»è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ¯ä¸ªkeyçš„å†…å®¹éƒ½å¾ˆå°ï¼ŒmigrateæŒ‡ä»¤æ‰§è¡Œä¼šå¾ˆå¿«ï¼Œå®ƒå°±å¹¶ä¸ä¼šå½±å“å®¢æˆ·ç«¯çš„æ­£å¸¸è®¿é—®ã€‚å¦‚æœkeyçš„å†…å®¹å¾ˆå¤§ï¼Œå› ä¸ºmigrateæŒ‡ä»¤æ˜¯é˜»å¡æŒ‡ä»¤ä¼šåŒæ—¶å¯¼è‡´åŸèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹å¡é¡¿ï¼Œå½±å“é›†ç¾¤çš„ç¨³å®šå‹ã€‚æ‰€ä»¥åœ¨é›†ç¾¤ç¯å¢ƒä¸‹ä¸šåŠ¡é€»è¾‘è¦å°½å¯èƒ½é¿å…å¤§keyçš„äº§ç”Ÿã€‚

åœ¨è¿ç§»è¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯è®¿é—®çš„æµç¨‹ä¼šæœ‰å¾ˆå¤§çš„å˜åŒ–ã€‚

é¦–å…ˆæ–°æ—§ä¸¤ä¸ªèŠ‚ç‚¹å¯¹åº”çš„æ§½ä½éƒ½å­˜åœ¨éƒ¨åˆ† key æ•°æ®ã€‚å®¢æˆ·ç«¯å…ˆå°è¯•è®¿é—®æ—§èŠ‚ç‚¹ï¼Œå¦‚æœå¯¹åº”çš„æ•°æ®è¿˜åœ¨æ—§èŠ‚ç‚¹é‡Œé¢ï¼Œé‚£ä¹ˆæ—§èŠ‚ç‚¹æ­£å¸¸å¤„ç†ã€‚å¦‚æœå¯¹åº”çš„æ•°æ®ä¸åœ¨æ—§èŠ‚ç‚¹é‡Œé¢ï¼Œé‚£ä¹ˆæœ‰ä¸¤ç§å¯èƒ½ï¼Œè¦ä¹ˆè¯¥æ•°æ®åœ¨æ–°èŠ‚ç‚¹é‡Œï¼Œè¦ä¹ˆæ ¹æœ¬å°±ä¸å­˜åœ¨ã€‚æ—§èŠ‚ç‚¹ä¸çŸ¥é“æ˜¯å“ªç§æƒ…å†µï¼Œæ‰€ä»¥å®ƒä¼šå‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ª```-ASK targetNodeAddr```çš„é‡å®šå‘æŒ‡ä»¤ã€‚å®¢æˆ·ç«¯æ”¶åˆ°è¿™ä¸ªé‡å®šå‘æŒ‡ä»¤åï¼Œå…ˆå»ç›®æ ‡èŠ‚ç‚¹æ‰§è¡Œä¸€ä¸ªä¸å¸¦ä»»ä½•å‚æ•°çš„```asking```æŒ‡ä»¤ï¼Œç„¶ååœ¨ç›®æ ‡èŠ‚ç‚¹å†é‡æ–°æ‰§è¡ŒåŸå…ˆçš„æ“ä½œæŒ‡ä»¤ã€‚

ä¸ºä»€ä¹ˆéœ€è¦æ‰§è¡Œä¸€ä¸ªä¸å¸¦å‚æ•°çš„```asking```æŒ‡ä»¤å‘¢ï¼Ÿ

å› ä¸ºåœ¨è¿ç§»æ²¡æœ‰å®Œæˆä¹‹å‰ï¼ŒæŒ‰ç†è¯´è¿™ä¸ªæ§½ä½è¿˜æ˜¯ä¸å½’æ–°èŠ‚ç‚¹ç®¡ç†çš„ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™å‘ç›®æ ‡èŠ‚ç‚¹å‘é€è¯¥æ§½ä½çš„æŒ‡ä»¤ï¼ŒèŠ‚ç‚¹æ˜¯ä¸è®¤çš„ï¼Œå®ƒä¼šå‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ª```-MOVED```é‡å®šå‘æŒ‡ä»¤å‘Šè¯‰å®ƒå»æºèŠ‚ç‚¹å»æ‰§è¡Œã€‚å¦‚æ­¤å°±ä¼šå½¢æˆ **é‡å®šå‘å¾ªç¯**ã€‚```asking```æŒ‡ä»¤çš„ç›®æ ‡å°±æ˜¯æ‰“å¼€ç›®æ ‡èŠ‚ç‚¹çš„é€‰é¡¹ï¼Œå‘Šè¯‰å®ƒä¸‹ä¸€æ¡æŒ‡ä»¤ä¸èƒ½ä¸ç†ï¼Œè€Œè¦å½“æˆè‡ªå·±çš„æ§½ä½æ¥å¤„ç†ã€‚

ä»ä»¥ä¸Šè¿‡ç¨‹å¯ä»¥çœ‹å‡ºï¼Œè¿ç§»æ˜¯ä¼šå½±å“æœåŠ¡æ•ˆç‡çš„ï¼ŒåŒæ ·çš„æŒ‡ä»¤åœ¨æ­£å¸¸æƒ…å†µä¸‹ä¸€ä¸ª ttl å°±èƒ½å®Œæˆï¼Œè€Œåœ¨è¿ç§»ä¸­å¾— 3 ä¸ª ttl æ‰èƒ½æå®šã€‚

## å®¹é”™

Redis Cluster å¯ä»¥ä¸ºæ¯ä¸ªä¸»èŠ‚ç‚¹è®¾ç½®è‹¥å¹²ä¸ªä»èŠ‚ç‚¹ï¼Œå•ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œé›†ç¾¤ä¼šè‡ªåŠ¨å°†å…¶ä¸­æŸä¸ªä»èŠ‚ç‚¹æå‡ä¸ºä¸»èŠ‚ç‚¹ã€‚å¦‚æœæŸä¸ªä¸»èŠ‚ç‚¹æ²¡æœ‰ä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå½“å®ƒå‘ç”Ÿæ•…éšœæ—¶ï¼Œé›†ç¾¤å°†å®Œå…¨å¤„äºä¸å¯ç”¨çŠ¶æ€ã€‚ä¸è¿‡ Redis ä¹Ÿæä¾›äº†ä¸€ä¸ªå‚æ•°```cluster-require-full-coverage```å¯ä»¥å…è®¸éƒ¨åˆ†èŠ‚ç‚¹æ•…éšœï¼Œå…¶å®ƒèŠ‚ç‚¹è¿˜å¯ä»¥ç»§ç»­æä¾›å¯¹å¤–è®¿é—®ã€‚

## ç½‘ç»œæŠ–åŠ¨

çœŸå®ä¸–ç•Œçš„æœºæˆ¿ç½‘ç»œå¾€å¾€å¹¶ä¸æ˜¯é£å¹³æµªé™çš„ï¼Œå®ƒä»¬ç»å¸¸ä¼šå‘ç”Ÿå„ç§å„æ ·çš„å°é—®é¢˜ã€‚æ¯”å¦‚ç½‘ç»œæŠ–åŠ¨å°±æ˜¯éå¸¸å¸¸è§çš„ä¸€ç§ç°è±¡ï¼Œçªç„¶ä¹‹é—´éƒ¨åˆ†è¿æ¥å˜å¾—ä¸å¯è®¿é—®ï¼Œç„¶åå¾ˆå¿«åˆæ¢å¤æ­£å¸¸ã€‚

ä¸ºè§£å†³è¿™ç§é—®é¢˜ï¼ŒRedis Cluster æä¾›äº†ä¸€ç§é€‰é¡¹```cluster-node-timeout```ï¼Œè¡¨ç¤ºå½“æŸä¸ªèŠ‚ç‚¹æŒç»­ timeout çš„æ—¶é—´å¤±è”æ—¶ï¼Œæ‰å¯ä»¥è®¤å®šè¯¥èŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œéœ€è¦è¿›è¡Œä¸»ä»åˆ‡æ¢ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªé€‰é¡¹ï¼Œç½‘ç»œæŠ–åŠ¨ä¼šå¯¼è‡´ä¸»ä»é¢‘ç¹åˆ‡æ¢ (æ•°æ®çš„é‡æ–°å¤åˆ¶)ã€‚

è¿˜æœ‰å¦å¤–ä¸€ä¸ªé€‰é¡¹```
cluster-slave-validity-factor```ä½œä¸ºå€ä¹˜ç³»æ•°æ¥æ”¾å¤§è¿™ä¸ªè¶…æ—¶æ—¶é—´æ¥å®½æ¾å®¹é”™çš„ç´§æ€¥ç¨‹åº¦ã€‚å¦‚æœè¿™ä¸ªç³»æ•°ä¸ºé›¶ï¼Œé‚£ä¹ˆä¸»ä»åˆ‡æ¢æ˜¯ä¸ä¼šæŠ—æ‹’ç½‘ç»œæŠ–åŠ¨çš„ã€‚å¦‚æœè¿™ä¸ªç³»æ•°å¤§äº 1ï¼Œå®ƒå°±æˆäº†ä¸»ä»åˆ‡æ¢çš„æ¾å¼›ç³»æ•°ã€‚

## å¯èƒ½ä¸‹çº¿ (PFAIL-Possibly Fail) ä¸ç¡®å®šä¸‹çº¿ (Fail)

å› ä¸º Redis Cluster æ˜¯å»ä¸­å¿ƒåŒ–çš„ï¼Œä¸€ä¸ªèŠ‚ç‚¹è®¤ä¸ºæŸä¸ªèŠ‚ç‚¹å¤±è”äº†å¹¶ä¸ä»£è¡¨æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½è®¤ä¸ºå®ƒå¤±è”äº†ã€‚æ‰€ä»¥é›†ç¾¤è¿˜å¾—ç»è¿‡ä¸€æ¬¡åå•†çš„è¿‡ç¨‹ï¼Œåªæœ‰å½“å¤§å¤šæ•°èŠ‚ç‚¹éƒ½è®¤å®šäº†æŸä¸ªèŠ‚ç‚¹å¤±è”äº†ï¼Œé›†ç¾¤æ‰è®¤ä¸ºè¯¥èŠ‚ç‚¹éœ€è¦è¿›è¡Œä¸»ä»åˆ‡æ¢æ¥å®¹é”™ã€‚

Redis é›†ç¾¤èŠ‚ç‚¹é‡‡ç”¨ Gossip åè®®æ¥å¹¿æ’­è‡ªå·±çš„çŠ¶æ€ä»¥åŠè‡ªå·±å¯¹æ•´ä¸ªé›†ç¾¤è®¤çŸ¥çš„æ”¹å˜ã€‚æ¯”å¦‚ä¸€ä¸ªèŠ‚ç‚¹å‘ç°æŸä¸ªèŠ‚ç‚¹å¤±è”äº† (PFail)ï¼Œå®ƒä¼šå°†è¿™æ¡ä¿¡æ¯å‘æ•´ä¸ªé›†ç¾¤å¹¿æ’­ï¼Œå…¶å®ƒèŠ‚ç‚¹ä¹Ÿå°±å¯ä»¥æ”¶åˆ°è¿™ç‚¹å¤±è”ä¿¡æ¯ã€‚å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ”¶åˆ°äº†æŸä¸ªèŠ‚ç‚¹å¤±è”çš„æ•°é‡ (PFail Count) å·²ç»è¾¾åˆ°äº†é›†ç¾¤çš„å¤§å¤šæ•°ï¼Œå°±å¯ä»¥æ ‡è®°è¯¥èŠ‚ç‚¹ä¸ºç¡®å®šä¸‹çº¿çŠ¶æ€ (Fail)ï¼Œç„¶åå‘æ•´ä¸ªé›†ç¾¤å¹¿æ’­ï¼Œå¼ºè¿«å…¶å®ƒèŠ‚ç‚¹ä¹Ÿæ¥æ”¶è¯¥èŠ‚ç‚¹å·²ç»ä¸‹çº¿çš„äº‹å®ï¼Œå¹¶ç«‹å³å¯¹è¯¥å¤±è”èŠ‚ç‚¹è¿›è¡Œä¸»ä»åˆ‡æ¢ã€‚

## Cluster åŸºæœ¬ä½¿ç”¨
redis-py å®¢æˆ·ç«¯ä¸æ”¯æŒ Cluster æ¨¡å¼ï¼Œè¦ä½¿ç”¨ Clusterï¼Œå¿…é¡»å®‰è£…å¦å¤–ä¸€ä¸ªåŒ…ï¼Œè¿™ä¸ªåŒ…æ˜¯ä¾èµ– redis-py åŒ…çš„ã€‚
```
pip install redis-py-cluster
```
ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹ redis-py-cluster å¦‚ä½•ä½¿ç”¨ã€‚
```
>>> from rediscluster import StrictRedisCluster
>>> # Requires at least one node for cluster discovery. Multiple nodes is recommended.
>>> startup_nodes = [{"host": "127.0.0.1", "port": "7000"}]
>>> rc = StrictRedisCluster(startup_nodes=startup_nodes, decode_responses=True)
>>> rc.set("foo", "bar")
True
>>> print(rc.get("foo"))
'bar'
```
Cluster æ˜¯å»ä¸­å¿ƒåŒ–çš„ï¼Œå®ƒæœ‰å¤šä¸ªèŠ‚ç‚¹ç»„æˆï¼Œæ„é€  StrictRedisCluster å®ä¾‹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åªç”¨ä¸€ä¸ªèŠ‚ç‚¹åœ°å€ï¼Œå…¶å®ƒåœ°å€å¯ä»¥è‡ªåŠ¨é€šè¿‡è¿™ä¸ªèŠ‚ç‚¹æ¥å‘ç°ã€‚ä¸è¿‡å¦‚æœæä¾›å¤šä¸ªèŠ‚ç‚¹åœ°å€ï¼Œå®‰å…¨æ€§ä¼šæ›´å¥½ã€‚å¦‚æœåªæä¾›ä¸€ä¸ªèŠ‚ç‚¹åœ°å€ï¼Œé‚£ä¹ˆå½“è¿™ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œå®¢æˆ·ç«¯å°±å¿…é¡»æ›´æ¢åœ°å€æ‰å¯ä»¥ç»§ç»­è®¿é—® Clusterã€‚
ç¬¬äºŒä¸ªå‚æ•° `decode_responses` è¡¨ç¤ºæ˜¯å¦è¦å°†è¿”å›ç»“æœä¸­çš„ byte æ•°ç»„è½¬æ¢æˆ unicodeã€‚

Cluster ä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ï¼Œç”¨èµ·æ¥å’Œæ™®é€šçš„ redis-py å·®åˆ«ä¸å¤§ï¼Œä»…ä»…æ˜¯æ„é€ æ–¹å¼ä¸åŒã€‚ä½†æ˜¯å®ƒä»¬ä¹Ÿæœ‰ç›¸å½“å¤§çš„ä¸ä¸€æ ·ä¹‹å¤„ï¼Œæ¯”å¦‚ Cluster ä¸æ”¯æŒäº‹åŠ¡ï¼ŒCluster çš„ `mget` æ–¹æ³•ç›¸æ¯” Redis è¦æ…¢å¾ˆå¤šï¼Œè¢«æ‹†åˆ†æˆäº†å¤šä¸ª `get` æŒ‡ä»¤ï¼ŒCluster çš„ `rename` æ–¹æ³•ä¸å†æ˜¯åŸå­çš„ï¼Œå®ƒéœ€è¦å°†æ•°æ®ä»åŸèŠ‚ç‚¹è½¬ç§»åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚

##  æ§½ä½è¿ç§»æ„ŸçŸ¥

å¦‚æœ Cluster ä¸­æŸä¸ªæ§½ä½æ­£åœ¨è¿ç§»æˆ–è€…å·²ç»è¿ç§»å®Œäº†ï¼Œclient å¦‚ä½•èƒ½æ„ŸçŸ¥åˆ°æ§½ä½çš„å˜åŒ–å‘¢ï¼Ÿå®¢æˆ·ç«¯ä¿å­˜äº†æ§½ä½å’ŒèŠ‚ç‚¹çš„æ˜ å°„å…³ç³»è¡¨ï¼Œå®ƒéœ€è¦å³æ—¶å¾—åˆ°æ›´æ–°ï¼Œæ‰å¯ä»¥æ­£å¸¸åœ°å°†æŸæ¡æŒ‡ä»¤å‘åˆ°æ­£ç¡®çš„èŠ‚ç‚¹ä¸­ã€‚

æˆ‘ä»¬å‰é¢æåˆ° Cluster æœ‰ä¸¤ä¸ªç‰¹æ®Šçš„ `error` æŒ‡ä»¤ï¼Œä¸€ä¸ªæ˜¯ `moved`ï¼Œä¸€ä¸ªæ˜¯ `asking`ã€‚

ç¬¬ä¸€ä¸ª `moved` æ˜¯ç”¨æ¥çº æ­£æ§½ä½çš„ã€‚å¦‚æœæˆ‘ä»¬å°†æŒ‡ä»¤å‘é€åˆ°äº†é”™è¯¯çš„èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹å‘ç°å¯¹åº”çš„æŒ‡ä»¤æ§½ä½ä¸å½’è‡ªå·±ç®¡ç†ï¼Œå°±ä¼šå°†ç›®æ ‡èŠ‚ç‚¹çš„åœ°å€éšåŒ `moved` æŒ‡ä»¤å›å¤ç»™å®¢æˆ·ç«¯é€šçŸ¥å®¢æˆ·ç«¯å»ç›®æ ‡èŠ‚ç‚¹å»è®¿é—®ã€‚è¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯å°±ä¼šåˆ·æ–°è‡ªå·±çš„æ§½ä½å…³ç³»è¡¨ï¼Œç„¶åé‡è¯•æŒ‡ä»¤ï¼Œåç»­æ‰€æœ‰æ‰“åœ¨è¯¥æ§½ä½çš„æŒ‡ä»¤éƒ½ä¼šè½¬åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚

ç¬¬äºŒä¸ª `asking` æŒ‡ä»¤å’Œ `moved` ä¸ä¸€æ ·ï¼Œå®ƒæ˜¯ç”¨æ¥ä¸´æ—¶çº æ­£æ§½ä½çš„ã€‚å¦‚æœå½“å‰æ§½ä½æ­£å¤„äºè¿ç§»ä¸­ï¼ŒæŒ‡ä»¤ä¼šå…ˆè¢«å‘é€åˆ°æ§½ä½æ‰€åœ¨çš„æ—§èŠ‚ç‚¹ï¼Œå¦‚æœæ—§èŠ‚ç‚¹å­˜åœ¨æ•°æ®ï¼Œé‚£å°±ç›´æ¥è¿”å›ç»“æœäº†ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå®ƒå¯èƒ½çœŸçš„ä¸å­˜åœ¨ä¹Ÿå¯èƒ½åœ¨è¿ç§»ç›®æ ‡èŠ‚ç‚¹ä¸Šã€‚æ‰€ä»¥æ—§èŠ‚ç‚¹ä¼šé€šçŸ¥å®¢æˆ·ç«¯å»æ–°èŠ‚ç‚¹å°è¯•ä¸€ä¸‹æ‹¿æ•°æ®ï¼Œçœ‹çœ‹æ–°èŠ‚ç‚¹æœ‰æ²¡æœ‰ã€‚è¿™æ—¶å€™å°±ä¼šç»™å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ª `asking error` æºå¸¦ä¸Šç›®æ ‡èŠ‚ç‚¹çš„åœ°å€ã€‚å®¢æˆ·ç«¯æ”¶åˆ°è¿™ä¸ª `asking error` åï¼Œå°±ä¼šå»ç›®æ ‡èŠ‚ç‚¹å»å°è¯•ã€‚å®¢æˆ·ç«¯ä¸ä¼šåˆ·æ–°æ§½ä½æ˜ å°„å…³ç³»è¡¨ï¼Œå› ä¸ºå®ƒåªæ˜¯ä¸´æ—¶çº æ­£è¯¥æŒ‡ä»¤çš„æ§½ä½ä¿¡æ¯ï¼Œä¸å½±å“åç»­æŒ‡ä»¤ã€‚

**é‡è¯• 2 æ¬¡**

`moved` å’Œ `asking` æŒ‡ä»¤éƒ½æ˜¯é‡è¯•æŒ‡ä»¤ï¼Œå®¢æˆ·ç«¯ä¼šå› ä¸ºè¿™ä¸¤ä¸ªæŒ‡ä»¤å¤šé‡è¯•ä¸€æ¬¡ã€‚è¯»è€…æœ‰æ²¡æœ‰æƒ³è¿‡ä¼šä¸ä¼šå­˜åœ¨ä¸€ç§æƒ…å†µï¼Œå®¢æˆ·ç«¯æœ‰å¯èƒ½é‡è¯• 2 æ¬¡å‘¢ï¼Ÿè¿™ç§æƒ…å†µæ˜¯å­˜åœ¨çš„ï¼Œæ¯”å¦‚ä¸€æ¡æŒ‡ä»¤è¢«å‘é€åˆ°é”™è¯¯çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹ä¼šå…ˆç»™ä½ ä¸€ä¸ª `moved` é”™è¯¯å‘ŠçŸ¥ä½ å»å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹é‡è¯•ã€‚æ‰€ä»¥å®¢æˆ·ç«¯å°±å»å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹é‡è¯•äº†ï¼Œç»“æœåˆšå¥½è¿™ä¸ªæ—¶å€™è¿ç»´äººå‘˜è¦å¯¹è¿™ä¸ªæ§½ä½è¿›è¡Œè¿ç§»æ“ä½œï¼Œäºæ˜¯ç»™å®¢æˆ·ç«¯å›å¤äº†ä¸€ä¸ª `asking` æŒ‡ä»¤å‘ŠçŸ¥å®¢æˆ·ç«¯å»ç›®æ ‡èŠ‚ç‚¹å»é‡è¯•æŒ‡ä»¤ã€‚æ‰€ä»¥è¿™é‡Œå®¢æˆ·ç«¯é‡è¯•äº† 2 æ¬¡ã€‚

**é‡è¯•å¤šæ¬¡**

åœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯ç”šè‡³ä¼šé‡è¯•å¤šæ¬¡ï¼Œè¯»è€…å¯ä»¥å¼€å‘ä¸€ä¸‹è‡ªå·±çš„è„‘æ´æƒ³ä¸€æƒ³ä»€ä¹ˆæƒ…å†µä¸‹ä¼šé‡è¯•å¤šæ¬¡ã€‚

æ­£æ˜¯å› ä¸ºå­˜åœ¨å¤šæ¬¡é‡è¯•çš„æƒ…å†µï¼Œæ‰€ä»¥å®¢æˆ·ç«¯çš„æºç é‡Œåœ¨æ‰§è¡ŒæŒ‡ä»¤æ—¶éƒ½ä¼šæœ‰ä¸€ä¸ªå¾ªç¯ï¼Œç„¶åä¼šè®¾ç½®ä¸€ä¸ªæœ€å¤§é‡è¯•æ¬¡æ•°ï¼ŒJava å’Œ Python éƒ½æœ‰è¿™ä¸ªå‚æ•°ï¼Œåªæ˜¯è®¾ç½®çš„å€¼ä¸ä¸€æ ·ã€‚å½“é‡è¯•æ¬¡æ•°è¶…è¿‡è¿™ä¸ªå€¼æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šç›´æ¥å‘ä¸šåŠ¡å±‚æŠ›å‡ºå¼‚å¸¸ã€‚

## é›†ç¾¤å˜æ›´æ„ŸçŸ¥

å½“æœåŠ¡å™¨èŠ‚ç‚¹å˜æ›´æ—¶ï¼Œå®¢æˆ·ç«¯åº”è¯¥å³æ—¶å¾—åˆ°é€šçŸ¥ä»¥å®æ—¶åˆ·æ–°è‡ªå·±çš„èŠ‚ç‚¹å…³ç³»è¡¨ã€‚é‚£å®¢æˆ·ç«¯æ˜¯å¦‚ä½•å¾—åˆ°é€šçŸ¥çš„å‘¢ï¼Ÿè¿™é‡Œè¦åˆ† 2 ç§æƒ…å†µï¼š

1. ç›®æ ‡èŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œå®¢æˆ·ç«¯ä¼šæŠ›å‡ºä¸€ä¸ª `ConnectionError`ï¼Œç´§æ¥ç€ä¼šéšæœºæŒ‘ä¸€ä¸ªèŠ‚ç‚¹æ¥é‡è¯•ï¼Œè¿™æ—¶è¢«é‡è¯•çš„èŠ‚ç‚¹ä¼šé€šè¿‡ `moved error` å‘ŠçŸ¥ç›®æ ‡æ§½ä½è¢«åˆ†é…åˆ°çš„æ–°çš„èŠ‚ç‚¹åœ°å€ã€‚
2. è¿ç»´æ‰‹åŠ¨ä¿®æ”¹äº†é›†ç¾¤ä¿¡æ¯ï¼Œå°† master åˆ‡æ¢åˆ°å…¶å®ƒèŠ‚ç‚¹ï¼Œå¹¶å°†æ—§çš„ master ç§»é™¤é›†ç¾¤ã€‚è¿™æ—¶æ‰“åœ¨æ—§èŠ‚ç‚¹ä¸Šçš„æŒ‡ä»¤ä¼šæ”¶åˆ°ä¸€ä¸ª `ClusterDown` çš„é”™è¯¯ï¼Œå‘ŠçŸ¥å½“å‰èŠ‚ç‚¹æ‰€åœ¨é›†ç¾¤ä¸å¯ç”¨ (å½“å‰èŠ‚ç‚¹å·²ç»è¢«å­¤ç«‹äº†ï¼Œå®ƒä¸å†å±äºä¹‹å‰çš„é›†ç¾¤)ã€‚è¿™æ—¶å®¢æˆ·ç«¯å°±ä¼šå…³é—­æ‰€æœ‰çš„è¿æ¥ï¼Œæ¸…ç©ºæ§½ä½æ˜ å°„å…³ç³»è¡¨ï¼Œç„¶åå‘ä¸Šå±‚æŠ›é”™ã€‚å¾…ä¸‹ä¸€æ¡æŒ‡ä»¤è¿‡æ¥æ—¶ï¼Œå°±ä¼šé‡æ–°å°è¯•åˆå§‹åŒ–èŠ‚ç‚¹ä¿¡æ¯ã€‚


## æ€è€ƒ & ä½œä¸š
1. è¯·è¯»è€…è‡ªå·±å°è¯•æ­å»º Cluster é›†ç¾¤ã€‚
2. ä½¿ç”¨å®¢æˆ·ç«¯è¿æ¥é›†ç¾¤è¿›è¡Œä¸€äº›å¸¸è§„æŒ‡ä»¤çš„æ“ä½œä½“éªŒã€‚

# æ‹“å±• 1ï¼šè€³å¬å…«æ–¹ â€”â€” Stream

> è¿™ç¯‡æ–‡ç« çš„ä¸»è¦éƒ¨åˆ†æ˜¯æˆ‘åœ¨ 2018 å¹´ 6 æœˆ 1 æ—¥ å‘è¡¨çš„å†…å®¹ï¼Œå½“æ—¶ Redis5.0 åˆšåˆšè¢« Antirez æ”¾å‡ºæ¥ï¼Œè€é’±æŠ¢å…ˆåˆ†æäº† Redis5.0 æœ€é‡è¦çš„ç‰¹æ€§ Streamï¼Œä¹Ÿè¢«æŠ€æœ¯åœˆå¤§å·ã€Œé«˜å¯ç”¨æ¶æ„ã€æ”¶å½•è½¬è½½ï¼Œå—åˆ°äº†å¹¿æ³›å…³æ³¨ã€‚äº‹åæˆ‘åˆå¯¹æ–‡ç« çš„å†…å®¹åšäº†è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œå¹¶æ•´åˆäº†ä¸€äº›è¯»è€…çš„ç–‘éš¾é—®é¢˜è§£ç­”ã€‚

Redis5.0 è¢«ä½œè€… Antirez çªç„¶æ”¾äº†å‡ºæ¥ï¼Œå¢åŠ äº†å¾ˆå¤šæ–°çš„ç‰¹è‰²åŠŸèƒ½ã€‚è€Œ Redis5.0 æœ€å¤§çš„æ–°ç‰¹æ€§å°±æ˜¯å¤šå‡ºäº†ä¸€ä¸ªæ•°æ®ç»“æ„ **Stream**ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ–°çš„å¼ºå¤§çš„æ”¯æŒå¤šæ’­çš„å¯æŒä¹…åŒ–çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½œè€…å¦è¨€ Redis Stream ç‹ ç‹ åœ°å€Ÿé‰´äº† Kafka çš„è®¾è®¡ã€‚

![](https://user-gold-cdn.xitu.io/2018/6/1/163bae206a809d56?w=880&h=645&f=png&s=55565)

Redis Stream çš„ç»“æ„å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå®ƒæœ‰ä¸€ä¸ªæ¶ˆæ¯é“¾è¡¨ï¼Œå°†æ‰€æœ‰åŠ å…¥çš„æ¶ˆæ¯éƒ½ä¸²èµ·æ¥ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ ID å’Œå¯¹åº”çš„å†…å®¹ã€‚æ¶ˆæ¯æ˜¯æŒä¹…åŒ–çš„ï¼ŒRedis é‡å¯åï¼Œå†…å®¹è¿˜åœ¨ã€‚

æ¯ä¸ª Stream éƒ½æœ‰å”¯ä¸€çš„åç§°ï¼Œå®ƒå°±æ˜¯ Redis çš„ keyï¼Œåœ¨æˆ‘ä»¬é¦–æ¬¡ä½¿ç”¨```xadd```æŒ‡ä»¤è¿½åŠ æ¶ˆæ¯æ—¶è‡ªåŠ¨åˆ›å»ºã€‚

æ¯ä¸ª Stream éƒ½å¯ä»¥æŒ‚å¤šä¸ªæ¶ˆè´¹ç»„ï¼Œæ¯ä¸ªæ¶ˆè´¹ç»„ä¼šæœ‰ä¸ªæ¸¸æ ‡```last_delivered_id```åœ¨ Stream æ•°ç»„ä¹‹ä¸Šå¾€å‰ç§»åŠ¨ï¼Œè¡¨ç¤ºå½“å‰æ¶ˆè´¹ç»„å·²ç»æ¶ˆè´¹åˆ°å“ªæ¡æ¶ˆæ¯äº†ã€‚æ¯ä¸ªæ¶ˆè´¹ç»„éƒ½æœ‰ä¸€ä¸ª Stream å†…å”¯ä¸€çš„åç§°ï¼Œæ¶ˆè´¹ç»„ä¸ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œå®ƒéœ€è¦å•ç‹¬çš„æŒ‡ä»¤```xgroup create```è¿›è¡Œåˆ›å»ºï¼Œéœ€è¦æŒ‡å®šä» Stream çš„æŸä¸ªæ¶ˆæ¯ ID å¼€å§‹æ¶ˆè´¹ï¼Œè¿™ä¸ª ID ç”¨æ¥åˆå§‹åŒ–```last_delivered_id```å˜é‡ã€‚

æ¯ä¸ªæ¶ˆè´¹ç»„ (Consumer Group) çš„çŠ¶æ€éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œç›¸äº’ä¸å—å½±å“ã€‚ä¹Ÿå°±æ˜¯è¯´åŒä¸€ä»½ Stream å†…éƒ¨çš„æ¶ˆæ¯ä¼šè¢«æ¯ä¸ªæ¶ˆè´¹ç»„éƒ½æ¶ˆè´¹åˆ°ã€‚

åŒä¸€ä¸ªæ¶ˆè´¹ç»„ (Consumer Group) å¯ä»¥æŒ‚æ¥å¤šä¸ªæ¶ˆè´¹è€… (Consumer)ï¼Œè¿™äº›æ¶ˆè´¹è€…ä¹‹é—´æ˜¯ç«äº‰å…³ç³»ï¼Œä»»æ„ä¸€ä¸ªæ¶ˆè´¹è€…è¯»å–äº†æ¶ˆæ¯éƒ½ä¼šä½¿æ¸¸æ ‡```last_delivered_id```å¾€å‰ç§»åŠ¨ã€‚æ¯ä¸ªæ¶ˆè´¹è€…æœ‰ä¸€ä¸ªç»„å†…å”¯ä¸€åç§°ã€‚

æ¶ˆè´¹è€… (Consumer) å†…éƒ¨ä¼šæœ‰ä¸ªçŠ¶æ€å˜é‡```pending_ids```ï¼Œå®ƒè®°å½•äº†å½“å‰å·²ç»è¢«å®¢æˆ·ç«¯è¯»å–çš„æ¶ˆæ¯ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰ ackã€‚å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰ ackï¼Œè¿™ä¸ªå˜é‡é‡Œé¢çš„æ¶ˆæ¯ ID ä¼šè¶Šæ¥è¶Šå¤šï¼Œä¸€æ—¦æŸä¸ªæ¶ˆæ¯è¢« ackï¼Œå®ƒå°±å¼€å§‹å‡å°‘ã€‚è¿™ä¸ª pending_ids å˜é‡åœ¨ Redis å®˜æ–¹è¢«ç§°ä¹‹ä¸º```PEL```ï¼Œä¹Ÿå°±æ˜¯```Pending Entries List```ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆæ ¸å¿ƒçš„æ•°æ®ç»“æ„ï¼Œå®ƒç”¨æ¥ç¡®ä¿å®¢æˆ·ç«¯è‡³å°‘æ¶ˆè´¹äº†æ¶ˆæ¯ä¸€æ¬¡ï¼Œè€Œä¸ä¼šåœ¨ç½‘ç»œä¼ è¾“çš„ä¸­é€”ä¸¢å¤±äº†æ²¡å¤„ç†ã€‚


**æ¶ˆæ¯ ID**
--

æ¶ˆæ¯ ID çš„å½¢å¼æ˜¯```timestampInMillis-sequence```ï¼Œä¾‹å¦‚```1527846880572-5```ï¼Œå®ƒè¡¨ç¤ºå½“å‰çš„æ¶ˆæ¯åœ¨æ¯«ç±³æ—¶é—´æˆ³```1527846880572```æ—¶äº§ç”Ÿï¼Œå¹¶ä¸”æ˜¯è¯¥æ¯«ç§’å†…äº§ç”Ÿçš„ç¬¬ 5 æ¡æ¶ˆæ¯ã€‚æ¶ˆæ¯ ID å¯ä»¥ç”±æœåŠ¡å™¨è‡ªåŠ¨ç”Ÿæˆï¼Œä¹Ÿå¯ä»¥ç”±å®¢æˆ·ç«¯è‡ªå·±æŒ‡å®šï¼Œä½†æ˜¯å½¢å¼å¿…é¡»æ˜¯```æ•´æ•°-æ•´æ•°```ï¼Œè€Œä¸”å¿…é¡»æ˜¯åé¢åŠ å…¥çš„æ¶ˆæ¯çš„ ID è¦å¤§äºå‰é¢çš„æ¶ˆæ¯ IDã€‚

**æ¶ˆæ¯å†…å®¹**
--

æ¶ˆæ¯å†…å®¹å°±æ˜¯é”®å€¼å¯¹ï¼Œå½¢å¦‚ hash ç»“æ„çš„é”®å€¼å¯¹ï¼Œè¿™æ²¡ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„ã€‚

**å¢åˆ æ”¹æŸ¥**
--

1. `xadd` è¿½åŠ æ¶ˆæ¯
2. `xdel` åˆ é™¤æ¶ˆæ¯ï¼Œè¿™é‡Œçš„åˆ é™¤ä»…ä»…æ˜¯è®¾ç½®äº†æ ‡å¿—ä½ï¼Œä¸å½±å“æ¶ˆæ¯æ€»é•¿åº¦
3. `xrange` è·å–æ¶ˆæ¯åˆ—è¡¨ï¼Œä¼šè‡ªåŠ¨è¿‡æ»¤å·²ç»åˆ é™¤çš„æ¶ˆæ¯
4. `xlen` æ¶ˆæ¯é•¿åº¦
5. `del` åˆ é™¤ Stream

```
# * å·è¡¨ç¤ºæœåŠ¡å™¨è‡ªåŠ¨ç”Ÿæˆ IDï¼Œåé¢é¡ºåºè·Ÿç€ä¸€å † key/value
#  åå­—å« laoqianï¼Œå¹´é¾„ 30 å²
127.0.0.1:6379> xadd codehole * name laoqian age 30  
1527849609889-0  # ç”Ÿæˆçš„æ¶ˆæ¯ ID
127.0.0.1:6379> xadd codehole * name xiaoyu age 29
1527849629172-0
127.0.0.1:6379> xadd codehole * name xiaoqian age 1
1527849637634-0
127.0.0.1:6379> xlen codehole
(integer) 3
# -è¡¨ç¤ºæœ€å°å€¼ , + è¡¨ç¤ºæœ€å¤§å€¼
127.0.0.1:6379> xrange codehole - +
127.0.0.1:6379> xrange codehole - +
1) 1) 1527849609889-0
   2) 1) "name"
      2) "laoqian"
      3) "age"
      4) "30"
2) 1) 1527849629172-0
   2) 1) "name"
      2) "xiaoyu"
      3) "age"
      4) "29"
3) 1) 1527849637634-0
   2) 1) "name"
      2) "xiaoqian"
      3) "age"
      4) "1"
# æŒ‡å®šæœ€å°æ¶ˆæ¯ ID çš„åˆ—è¡¨
127.0.0.1:6379> xrange codehole 1527849629172-0 +  
1) 1) 1527849629172-0
   2) 1) "name"
      2) "xiaoyu"
      3) "age"
      4) "29"
2) 1) 1527849637634-0
   2) 1) "name"
      2) "xiaoqian"
      3) "age"
      4) "1"
# æŒ‡å®šæœ€å¤§æ¶ˆæ¯ ID çš„åˆ—è¡¨
127.0.0.1:6379> xrange codehole - 1527849629172-0
1) 1) 1527849609889-0
   2) 1) "name"
      2) "laoqian"
      3) "age"
      4) "30"
2) 1) 1527849629172-0
   2) 1) "name"
      2) "xiaoyu"
      3) "age"
      4) "29"
127.0.0.1:6379> xdel codehole 1527849609889-0
(integer) 1
# é•¿åº¦ä¸å—å½±å“
127.0.0.1:6379> xlen codehole
(integer) 3
# è¢«åˆ é™¤çš„æ¶ˆæ¯æ²¡äº†
127.0.0.1:6379> xrange codehole - +
1) 1) 1527849629172-0
   2) 1) "name"
      2) "xiaoyu"
      3) "age"
      4) "29"
2) 1) 1527849637634-0
   2) 1) "name"
      2) "xiaoqian"
      3) "age"
      4) "1"
# åˆ é™¤æ•´ä¸ª Stream
127.0.0.1:6379> del codehole
(integer) 1
```

**ç‹¬ç«‹æ¶ˆè´¹**
--

æˆ‘ä»¬å¯ä»¥åœ¨ä¸å®šä¹‰æ¶ˆè´¹ç»„çš„æƒ…å†µä¸‹è¿›è¡Œ Stream æ¶ˆæ¯çš„ç‹¬ç«‹æ¶ˆè´¹ï¼Œå½“ Stream æ²¡æœ‰æ–°æ¶ˆæ¯æ—¶ï¼Œç”šè‡³å¯ä»¥é˜»å¡ç­‰å¾…ã€‚Redis è®¾è®¡äº†ä¸€ä¸ªå•ç‹¬çš„æ¶ˆè´¹æŒ‡ä»¤```xread```ï¼Œå¯ä»¥å°† Stream å½“æˆæ™®é€šçš„æ¶ˆæ¯é˜Ÿåˆ— (list) æ¥ä½¿ç”¨ã€‚ä½¿ç”¨ `xread` æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®Œå…¨å¿½ç•¥æ¶ˆè´¹ç»„ (Consumer Group) çš„å­˜åœ¨ï¼Œå°±å¥½æ¯” Stream å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„åˆ—è¡¨ (list)ã€‚
```
# ä» Stream å¤´éƒ¨è¯»å–ä¸¤æ¡æ¶ˆæ¯
127.0.0.1:6379> xread count 2 streams codehole 0-0
1) 1) "codehole"
   2) 1) 1) 1527851486781-0
         2) 1) "name"
            2) "laoqian"
            3) "age"
            4) "30"
      2) 1) 1527851493405-0
         2) 1) "name"
            2) "yurui"
            3) "age"
            4) "29"
# ä» Stream å°¾éƒ¨è¯»å–ä¸€æ¡æ¶ˆæ¯ï¼Œæ¯«æ— ç–‘é—®ï¼Œè¿™é‡Œä¸ä¼šè¿”å›ä»»ä½•æ¶ˆæ¯
127.0.0.1:6379> xread count 1 streams codehole $
(nil)
# ä»å°¾éƒ¨é˜»å¡ç­‰å¾…æ–°æ¶ˆæ¯åˆ°æ¥ï¼Œä¸‹é¢çš„æŒ‡ä»¤ä¼šå µä½ï¼Œç›´åˆ°æ–°æ¶ˆæ¯åˆ°æ¥
127.0.0.1:6379> xread block 0 count 1 streams codehole $
# æˆ‘ä»¬ä»æ–°æ‰“å¼€ä¸€ä¸ªçª—å£ï¼Œåœ¨è¿™ä¸ªçª—å£å¾€ Stream é‡Œå¡æ¶ˆæ¯
127.0.0.1:6379> xadd codehole * name youming age 60
1527852774092-0
# å†åˆ‡æ¢åˆ°å‰é¢çš„çª—å£ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°é˜»å¡è§£é™¤äº†ï¼Œè¿”å›äº†æ–°çš„æ¶ˆæ¯å†…å®¹
# è€Œä¸”è¿˜æ˜¾ç¤ºäº†ä¸€ä¸ªç­‰å¾…æ—¶é—´ï¼Œè¿™é‡Œæˆ‘ä»¬ç­‰å¾…äº† 93s
127.0.0.1:6379> xread block 0 count 1 streams codehole $
1) 1) "codehole"
   2) 1) 1) 1527852774092-0
         2) 1) "name"
            2) "youming"
            3) "age"
            4) "60"
(93.11s)
```
å®¢æˆ·ç«¯å¦‚æœæƒ³è¦ä½¿ç”¨ `xread` è¿›è¡Œé¡ºåºæ¶ˆè´¹ï¼Œä¸€å®šè¦è®°ä½å½“å‰æ¶ˆè´¹åˆ°å“ªé‡Œäº†ï¼Œä¹Ÿå°±æ˜¯è¿”å›çš„æ¶ˆæ¯ IDã€‚ä¸‹æ¬¡ç»§ç»­è°ƒç”¨ `xread` æ—¶ï¼Œå°†ä¸Šæ¬¡è¿”å›çš„æœ€åä¸€ä¸ªæ¶ˆæ¯ ID ä½œä¸ºå‚æ•°ä¼ é€’è¿›å»ï¼Œå°±å¯ä»¥ç»§ç»­æ¶ˆè´¹åç»­çš„æ¶ˆæ¯ã€‚

block 0 è¡¨ç¤ºæ°¸è¿œé˜»å¡ï¼Œç›´åˆ°æ¶ˆæ¯åˆ°æ¥ï¼Œblock 1000 è¡¨ç¤ºé˜»å¡ 1sï¼Œå¦‚æœ 1s å†…æ²¡æœ‰ä»»ä½•æ¶ˆæ¯åˆ°æ¥ï¼Œå°±è¿”å› `nil`ã€‚

```
127.0.0.1:6379> xread block 1000 count 1 streams codehole $
(nil)
(1.07s)
```

**åˆ›å»ºæ¶ˆè´¹ç»„**
--
![](https://user-gold-cdn.xitu.io/2018/6/1/163bbe4d6f601f8e?w=1594&h=710&f=png&s=146592)
Stream é€šè¿‡```xgroup create```æŒ‡ä»¤åˆ›å»ºæ¶ˆè´¹ç»„ (Consumer Group)ï¼Œéœ€è¦ä¼ é€’èµ·å§‹æ¶ˆæ¯ ID å‚æ•°ç”¨æ¥åˆå§‹åŒ–```last_delivered_id```å˜é‡ã€‚
```
#  è¡¨ç¤ºä»å¤´å¼€å§‹æ¶ˆè´¹
127.0.0.1:6379> xgroup create codehole cg1 0-0
OK
# $ è¡¨ç¤ºä»å°¾éƒ¨å¼€å§‹æ¶ˆè´¹ï¼Œåªæ¥å—æ–°æ¶ˆæ¯ï¼Œå½“å‰ Stream æ¶ˆæ¯ä¼šå…¨éƒ¨å¿½ç•¥
127.0.0.1:6379> xgroup create codehole cg2 $
OK
# è·å– Stream ä¿¡æ¯
127.0.0.1:6379> xinfo stream codehole
 1) length
 2) (integer) 3  # å…± 3 ä¸ªæ¶ˆæ¯
 3) radix-tree-keys
 4) (integer) 1
 5) radix-tree-nodes
 6) (integer) 2
 7) groups
 8) (integer) 2  # ä¸¤ä¸ªæ¶ˆè´¹ç»„
 9) first-entry  # ç¬¬ä¸€ä¸ªæ¶ˆæ¯
10) 1) 1527851486781-0
    2) 1) "name"
       2) "laoqian"
       3) "age"
       4) "30"
11) last-entry  # æœ€åä¸€ä¸ªæ¶ˆæ¯
12) 1) 1527851498956-0
    2) 1) "name"
       2) "xiaoqian"
       3) "age"
       4) "1"
# è·å– Stream çš„æ¶ˆè´¹ç»„ä¿¡æ¯
127.0.0.1:6379> xinfo groups codehole
1) 1) name
   2) "cg1"
   3) consumers
   4) (integer) 0  # è¯¥æ¶ˆè´¹ç»„è¿˜æ²¡æœ‰æ¶ˆè´¹è€…
   5) pending
   6) (integer) 0  # è¯¥æ¶ˆè´¹ç»„æ²¡æœ‰æ­£åœ¨å¤„ç†çš„æ¶ˆæ¯
2) 1) name
   2) "cg2"
   3) consumers  # è¯¥æ¶ˆè´¹ç»„è¿˜æ²¡æœ‰æ¶ˆè´¹è€…
   4) (integer) 0
   5) pending
   6) (integer) 0  # è¯¥æ¶ˆè´¹ç»„æ²¡æœ‰æ­£åœ¨å¤„ç†çš„æ¶ˆæ¯
```

**æ¶ˆè´¹**
--

Stream æä¾›äº† `xreadgroup` æŒ‡ä»¤å¯ä»¥è¿›è¡Œæ¶ˆè´¹ç»„çš„ç»„å†…æ¶ˆè´¹ï¼Œéœ€è¦æä¾›æ¶ˆè´¹ç»„åç§°ã€æ¶ˆè´¹è€…åç§°å’Œèµ·å§‹æ¶ˆæ¯ IDã€‚å®ƒåŒ `xread` ä¸€æ ·ï¼Œä¹Ÿå¯ä»¥é˜»å¡ç­‰å¾…æ–°æ¶ˆæ¯ã€‚è¯»åˆ°æ–°æ¶ˆæ¯åï¼Œå¯¹åº”çš„æ¶ˆæ¯ ID å°±ä¼šè¿›å…¥æ¶ˆè´¹è€…çš„ PEL(æ­£åœ¨å¤„ç†çš„æ¶ˆæ¯) ç»“æ„é‡Œï¼Œå®¢æˆ·ç«¯å¤„ç†å®Œæ¯•åä½¿ç”¨ `xack` æŒ‡ä»¤é€šçŸ¥æœåŠ¡å™¨ï¼Œæœ¬æ¡æ¶ˆæ¯å·²ç»å¤„ç†å®Œæ¯•ï¼Œè¯¥æ¶ˆæ¯ ID å°±ä¼šä» PEL ä¸­ç§»é™¤ã€‚
```
# > å·è¡¨ç¤ºä»å½“å‰æ¶ˆè´¹ç»„çš„ last_delivered_id åé¢å¼€å§‹è¯»
# æ¯å½“æ¶ˆè´¹è€…è¯»å–ä¸€æ¡æ¶ˆæ¯ï¼Œlast_delivered_id å˜é‡å°±ä¼šå‰è¿›
127.0.0.1:6379> xreadgroup GROUP cg1 c1 count 1 streams codehole >
1) 1) "codehole"
   2) 1) 1) 1527851486781-0
         2) 1) "name"
            2) "laoqian"
            3) "age"
            4) "30"
127.0.0.1:6379> xreadgroup GROUP cg1 c1 count 1 streams codehole >
1) 1) "codehole"
   2) 1) 1) 1527851493405-0
         2) 1) "name"
            2) "yurui"
            3) "age"
            4) "29"
127.0.0.1:6379> xreadgroup GROUP cg1 c1 count 2 streams codehole >
1) 1) "codehole"
   2) 1) 1) 1527851498956-0
         2) 1) "name"
            2) "xiaoqian"
            3) "age"
            4) "1"
      2) 1) 1527852774092-0
         2) 1) "name"
            2) "youming"
            3) "age"
            4) "60"
# å†ç»§ç»­è¯»å–ï¼Œå°±æ²¡æœ‰æ–°æ¶ˆæ¯äº†
127.0.0.1:6379> xreadgroup GROUP cg1 c1 count 1 streams codehole >
(nil)
# é‚£å°±é˜»å¡ç­‰å¾…å§
127.0.0.1:6379> xreadgroup GROUP cg1 c1 block 0 count 1 streams codehole >
# å¼€å¯å¦ä¸€ä¸ªçª—å£ï¼Œå¾€é‡Œå¡æ¶ˆæ¯
127.0.0.1:6379> xadd codehole * name lanying age 61
1527854062442-0
# å›åˆ°å‰ä¸€ä¸ªçª—å£ï¼Œå‘ç°é˜»å¡è§£é™¤ï¼Œæ”¶åˆ°æ–°æ¶ˆæ¯äº†
127.0.0.1:6379> xreadgroup GROUP cg1 c1 block 0 count 1 streams codehole >
1) 1) "codehole"
   2) 1) 1) 1527854062442-0
         2) 1) "name"
            2) "lanying"
            3) "age"
            4) "61"
(36.54s)
# è§‚å¯Ÿæ¶ˆè´¹ç»„ä¿¡æ¯
127.0.0.1:6379> xinfo groups codehole
1) 1) name
   2) "cg1"
   3) consumers
   4) (integer) 1  # ä¸€ä¸ªæ¶ˆè´¹è€…
   5) pending
   6) (integer) 5  # å…± 5 æ¡æ­£åœ¨å¤„ç†çš„ä¿¡æ¯è¿˜æœ‰æ²¡æœ‰ ack
2) 1) name
   2) "cg2"
   3) consumers
   4) (integer) 0  # æ¶ˆè´¹ç»„ cg2 æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œå› ä¸ºå‰é¢æˆ‘ä»¬ä¸€ç›´åœ¨æ“çºµ cg1
   5) pending
   6) (integer) 0
# å¦‚æœåŒä¸€ä¸ªæ¶ˆè´¹ç»„æœ‰å¤šä¸ªæ¶ˆè´¹è€…ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ xinfo consumers æŒ‡ä»¤è§‚å¯Ÿæ¯ä¸ªæ¶ˆè´¹è€…çš„çŠ¶æ€
127.0.0.1:6379> xinfo consumers codehole cg1  # ç›®å‰è¿˜æœ‰ 1 ä¸ªæ¶ˆè´¹è€…
1) 1) name
   2) "c1"
   3) pending
   4) (integer) 5  # å…± 5 æ¡å¾…å¤„ç†æ¶ˆæ¯
   5) idle
   6) (integer) 418715  # ç©ºé—²äº†å¤šé•¿æ—¶é—´ ms æ²¡æœ‰è¯»å–æ¶ˆæ¯äº†
# æ¥ä¸‹æ¥æˆ‘ä»¬ ack ä¸€æ¡æ¶ˆæ¯
127.0.0.1:6379> xack codehole cg1 1527851486781-0
(integer) 1
127.0.0.1:6379> xinfo consumers codehole cg1
1) 1) name
   2) "c1"
   3) pending
   4) (integer) 4  # å˜æˆäº† 5 æ¡
   5) idle
   6) (integer) 668504
# ä¸‹é¢ ack æ‰€æœ‰æ¶ˆæ¯
127.0.0.1:6379> xack codehole cg1 1527851493405-0 1527851498956-0 1527852774092-0 1527854062442-0
(integer) 4
127.0.0.1:6379> xinfo consumers codehole cg1
1) 1) name
   2) "c1"
   3) pending
   4) (integer) 0  # pel ç©ºäº†
   5) idle
   6) (integer) 745505
```

**Stream æ¶ˆæ¯å¤ªå¤šæ€ä¹ˆåŠ?**
--

è¯»è€…å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œè¦æ˜¯æ¶ˆæ¯ç§¯ç´¯å¤ªå¤šï¼ŒStream çš„é“¾è¡¨å²‚ä¸æ˜¯å¾ˆé•¿ï¼Œå†…å®¹ä¼šä¸ä¼šçˆ†æ‰?`xdel` æŒ‡ä»¤åˆä¸ä¼šåˆ é™¤æ¶ˆæ¯ï¼Œå®ƒåªæ˜¯ç»™æ¶ˆæ¯åšäº†ä¸ªæ ‡å¿—ä½ã€‚

Redis è‡ªç„¶è€ƒè™‘åˆ°äº†è¿™ä¸€ç‚¹ï¼Œæ‰€ä»¥å®ƒæä¾›äº†ä¸€ä¸ªå®šé•¿ Stream åŠŸèƒ½ã€‚åœ¨ `xadd` çš„æŒ‡ä»¤æä¾›ä¸€ä¸ªå®šé•¿é•¿åº¦ `maxlen`ï¼Œå°±å¯ä»¥å°†è€çš„æ¶ˆæ¯å¹²æ‰ï¼Œç¡®ä¿æœ€å¤šä¸è¶…è¿‡æŒ‡å®šé•¿åº¦ã€‚

```
127.0.0.1:6379> xlen codehole
(integer) 5
127.0.0.1:6379> xadd codehole maxlen 3 * name xiaorui age 1
1527855160273-0
127.0.0.1:6379> xlen codehole
(integer) 3
```

æˆ‘ä»¬çœ‹åˆ° Stream çš„é•¿åº¦è¢«ç æ‰äº†ã€‚å¦‚æœ Stream åœ¨æœªæ¥å¯ä»¥æä¾›æŒ‰æ—¶é—´æˆ³æ¸…ç†æ¶ˆæ¯çš„è§„åˆ™é‚£å°±æ›´åŠ å®Œç¾äº†ï¼Œä½†æ˜¯ç›®å‰è¿˜æ²¡æœ‰ã€‚

**æ¶ˆæ¯å¦‚æœå¿˜è®° ACK ä¼šæ€æ ·?**
--
Stream åœ¨æ¯ä¸ªæ¶ˆè´¹è€…ç»“æ„ä¸­ä¿å­˜äº†æ­£åœ¨å¤„ç†ä¸­çš„æ¶ˆæ¯ ID åˆ—è¡¨ PELï¼Œå¦‚æœæ¶ˆè´¹è€…æ”¶åˆ°äº†æ¶ˆæ¯å¤„ç†å®Œäº†ä½†æ˜¯æ²¡æœ‰å›å¤ ackï¼Œå°±ä¼šå¯¼è‡´ PEL åˆ—è¡¨ä¸æ–­å¢é•¿ï¼Œå¦‚æœæœ‰å¾ˆå¤šæ¶ˆè´¹ç»„çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ª PEL å ç”¨çš„å†…å­˜å°±ä¼šæ”¾å¤§ã€‚


![](https://user-gold-cdn.xitu.io/2018/7/16/164a2a4cd39eb25e?w=498&h=403&f=png&s=31017)

**PEL å¦‚ä½•é¿å…æ¶ˆæ¯ä¸¢å¤±?**
--
åœ¨å®¢æˆ·ç«¯æ¶ˆè´¹è€…è¯»å– Stream æ¶ˆæ¯æ—¶ï¼ŒRedis æœåŠ¡å™¨å°†æ¶ˆæ¯å›å¤ç»™å®¢æˆ·ç«¯çš„è¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯çªç„¶æ–­å¼€äº†è¿æ¥ï¼Œæ¶ˆæ¯å°±ä¸¢å¤±äº†ã€‚ä½†æ˜¯ PEL é‡Œå·²ç»ä¿å­˜äº†å‘å‡ºå»çš„æ¶ˆæ¯ IDã€‚å¾…å®¢æˆ·ç«¯é‡æ–°è¿ä¸Šä¹‹åï¼Œå¯ä»¥å†æ¬¡æ”¶åˆ° PEL ä¸­çš„æ¶ˆæ¯ ID åˆ—è¡¨ã€‚ä¸è¿‡æ­¤æ—¶ `xreadgroup` çš„èµ·å§‹æ¶ˆæ¯ ID ä¸èƒ½ä¸ºå‚æ•°>ï¼Œè€Œå¿…é¡»æ˜¯ä»»æ„æœ‰æ•ˆçš„æ¶ˆæ¯ IDï¼Œä¸€èˆ¬å°†å‚æ•°è®¾ä¸º 0-0ï¼Œè¡¨ç¤ºè¯»å–æ‰€æœ‰çš„ PEL æ¶ˆæ¯ä»¥åŠè‡ª```last_delivered_id```ä¹‹åçš„æ–°æ¶ˆæ¯ã€‚

**Stream çš„é«˜å¯ç”¨**
--
Stream çš„é«˜å¯ç”¨æ˜¯å»ºç«‹ä¸»ä»å¤åˆ¶åŸºç¡€ä¸Šçš„ï¼Œå®ƒå’Œå…¶å®ƒæ•°æ®ç»“æ„çš„å¤åˆ¶æœºåˆ¶æ²¡æœ‰åŒºåˆ«ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ Sentinel å’Œ Cluster é›†ç¾¤ç¯å¢ƒä¸‹ Stream æ˜¯å¯ä»¥æ”¯æŒé«˜å¯ç”¨çš„ã€‚ä¸è¿‡é‰´äº Redis çš„æŒ‡ä»¤å¤åˆ¶æ˜¯å¼‚æ­¥çš„ï¼Œåœ¨ `failover` å‘ç”Ÿæ—¶ï¼ŒRedis å¯èƒ½ä¼šä¸¢å¤±æå°éƒ¨åˆ†æ•°æ®ï¼Œè¿™ç‚¹ Redis çš„å…¶å®ƒæ•°æ®ç»“æ„ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚

**åˆ†åŒº Partition**
--
Redis çš„æœåŠ¡å™¨æ²¡æœ‰åŸç”Ÿæ”¯æŒåˆ†åŒºèƒ½åŠ›ï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨åˆ†åŒºï¼Œé‚£å°±éœ€è¦åˆ†é…å¤šä¸ª Streamï¼Œç„¶ååœ¨å®¢æˆ·ç«¯ä½¿ç”¨ä¸€å®šçš„ç­–ç•¥æ¥ç”Ÿäº§æ¶ˆæ¯åˆ°ä¸åŒçš„ Streamã€‚ä½ ä¹Ÿè®¸ä¼šè®¤ä¸º Kafka è¦å…ˆè¿›å¾ˆå¤šï¼Œå®ƒæ˜¯åŸç”Ÿæ”¯æŒ Partition çš„ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œæˆ‘å¹¶ä¸è®¤åŒã€‚è®°å¾— Kafka çš„å®¢æˆ·ç«¯ä¹Ÿå­˜åœ¨ HashStrategy ä¹ˆï¼Œå› ä¸ºå®ƒä¹Ÿæ˜¯é€šè¿‡å®¢æˆ·ç«¯çš„ hash ç®—æ³•æ¥å°†ä¸åŒçš„æ¶ˆæ¯å¡å…¥ä¸åŒåˆ†åŒºçš„ã€‚

å¦å¤–,Kafka è¿˜æ”¯æŒåŠ¨æ€å¢åŠ åˆ†åŒºæ•°é‡çš„èƒ½åŠ›ï¼Œä½†æ˜¯è¿™ç§è°ƒæ•´èƒ½åŠ›ä¹Ÿæ˜¯å¾ˆè¹©è„šçš„ï¼Œå®ƒä¸ä¼šæŠŠä¹‹å‰å·²ç»å­˜åœ¨çš„å†…å®¹è¿›è¡Œ rehashï¼Œä¸ä¼šé‡æ–°åˆ†åŒºå†å²æ•°æ®ã€‚è¿™ç§ç®€å•çš„åŠ¨æ€è°ƒæ•´çš„èƒ½åŠ› Redis Stream é€šè¿‡å¢åŠ æ–°çš„ Stream å°±å¯ä»¥åšåˆ°ã€‚

å°ç»“
--
Stream çš„æ¶ˆè´¹æ¨¡å‹å€Ÿé‰´äº† Kafka çš„æ¶ˆè´¹åˆ†ç»„çš„æ¦‚å¿µï¼Œå®ƒå¼¥è¡¥äº† Redis Pub/Sub ä¸èƒ½æŒä¹…åŒ–æ¶ˆæ¯çš„ç¼ºé™·ã€‚ä½†æ˜¯å®ƒåˆä¸åŒäº kafkaï¼ŒKafka çš„æ¶ˆæ¯å¯ä»¥åˆ† partitionï¼Œè€Œ Stream ä¸è¡Œã€‚å¦‚æœéè¦åˆ† parition çš„è¯ï¼Œå¾—åœ¨å®¢æˆ·ç«¯åšï¼Œæä¾›ä¸åŒçš„ Stream åç§°ï¼Œå¯¹æ¶ˆæ¯è¿›è¡Œ hash å–æ¨¡æ¥é€‰æ‹©å¾€å“ªä¸ª Stream é‡Œå¡ã€‚

å¦‚æœè¯»è€…ç¨å¾®ç ”ç©¶è¿‡ Redis ä½œè€…çš„å¦ä¸€ä¸ªå¼€æºé¡¹ç›® Disque çš„è¯ï¼Œè¿™æå¯èƒ½æ˜¯ä½œè€…æ„è¯†åˆ° Disque é¡¹ç›®çš„æ´»è·ƒç¨‹åº¦ä¸å¤Ÿï¼Œæ‰€ä»¥å°† Disque çš„å†…å®¹ç§»æ¤åˆ°äº† Redis é‡Œé¢ã€‚è¿™åªæ˜¯æœ¬äººçš„çŒœæµ‹ï¼Œæœªå¿…æ˜¯ä½œè€…çš„åˆè¡·ã€‚å¦‚æœè¯»è€…æœ‰ä»€ä¹ˆä¸åŒçš„æƒ³æ³•ï¼Œå¯ä»¥åœ¨è¯„è®ºåŒºä¸€èµ·å‚ä¸è®¨è®ºã€‚
# æ‹“å±• 2ï¼šæ— æ‰€ä¸çŸ¥ â€”â€” Info æŒ‡ä»¤

åœ¨ä½¿ç”¨ Redis æ—¶ï¼Œæ—¶å¸¸ä¼šé‡åˆ°å¾ˆå¤šé—®é¢˜éœ€è¦è¯Šæ–­ï¼Œåœ¨è¯Šæ–­ä¹‹å‰éœ€è¦äº†è§£ Redis çš„è¿è¡ŒçŠ¶æ€ï¼Œé€šè¿‡å¼ºå¤§çš„ Info æŒ‡ä»¤ï¼Œä½ å¯ä»¥æ¸…æ™°åœ°çŸ¥é“ Redis å†…éƒ¨ä¸€ç³»åˆ—è¿è¡Œå‚æ•°ã€‚

Info æŒ‡ä»¤æ˜¾ç¤ºçš„ä¿¡æ¯éå¸¸ç¹å¤šï¼Œåˆ†ä¸º 9 å¤§å—ï¼Œæ¯ä¸ªå—éƒ½æœ‰éå¸¸å¤šçš„å‚æ•°ï¼Œè¿™ 9 ä¸ªå—åˆ†åˆ«æ˜¯:
1. Server  æœåŠ¡å™¨è¿è¡Œçš„ç¯å¢ƒå‚æ•°
2. Clients å®¢æˆ·ç«¯ç›¸å…³ä¿¡æ¯
3. Memory æœåŠ¡å™¨è¿è¡Œå†…å­˜ç»Ÿè®¡æ•°æ®
4. Persistence æŒä¹…åŒ–ä¿¡æ¯
5. Stats é€šç”¨ç»Ÿè®¡æ•°æ®
6. Replication ä¸»ä»å¤åˆ¶ç›¸å…³ä¿¡æ¯
7. CPU CPU ä½¿ç”¨æƒ…å†µ
8. Cluster é›†ç¾¤ä¿¡æ¯
9. KeySpace é”®å€¼å¯¹ç»Ÿè®¡æ•°é‡ä¿¡æ¯

Info å¯ä»¥ä¸€æ¬¡æ€§è·å–æ‰€æœ‰çš„ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥æŒ‰å—å–ä¿¡æ¯ã€‚
```
# è·å–æ‰€æœ‰ä¿¡æ¯
> info
# è·å–å†…å­˜ç›¸å…³ä¿¡æ¯
> info memory
# è·å–å¤åˆ¶ç›¸å…³ä¿¡æ¯
> info replication
```
è€ƒè™‘åˆ°å‚æ•°éå¸¸ç¹å¤šï¼Œä¸€ä¸€è¯´æ˜å·¥ä½œé‡å·¨å¤§ï¼Œä¸‹é¢æˆ‘åªæŒ‘ä¸€äº›å…³é”®æ€§çš„ã€éå¸¸å®ç”¨å’Œæœ€å¸¸ç”¨çš„å‚æ•°è¿›è¡Œè¯¦ç»†è®²è§£ã€‚å¦‚æœè¯»è€…æƒ³è¦äº†è§£æ‰€æœ‰çš„å‚æ•°ç»†èŠ‚ï¼Œè¯·å‚è€ƒé˜…è¯» [Redis å®˜ç½‘æ–‡æ¡£](https://redis.io/commands/info)ã€‚

## Redis æ¯ç§’æ‰§è¡Œå¤šå°‘æ¬¡æŒ‡ä»¤ï¼Ÿ

![](https://user-gold-cdn.xitu.io/2018/7/16/164a14ce6633c24a?w=345&h=220&f=png&s=19427)

è¿™ä¸ªä¿¡æ¯åœ¨ Stats å—é‡Œï¼Œå¯ä»¥é€šè¿‡ `info stats` çœ‹åˆ°ã€‚
```
# ops_per_sec: operations per secondï¼Œä¹Ÿå°±æ˜¯æ¯ç§’æ“ä½œæ•°
> redis-cli info stats |grep ops
instantaneous_ops_per_sec:789
```
![](https://user-gold-cdn.xitu.io/2018/7/13/1649181bd00bed33?w=306&h=147&f=png&s=20852)
ä»¥ä¸Šï¼Œè¡¨ç¤º ops æ˜¯ 789ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰å®¢æˆ·ç«¯æ¯ç§’ä¼šå‘é€ 789 æ¡æŒ‡ä»¤åˆ°æœåŠ¡å™¨æ‰§è¡Œã€‚æé™æƒ…å†µä¸‹ï¼ŒRedis å¯ä»¥æ¯ç§’æ‰§è¡Œ 10w æ¬¡æŒ‡ä»¤ï¼ŒCPU å‡ ä¹å®Œå…¨æ¦¨å¹²ã€‚å¦‚æœ qps è¿‡é«˜ï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡ `monitor` æŒ‡ä»¤å¿«é€Ÿè§‚å¯Ÿä¸€ä¸‹ç©¶ç«Ÿæ˜¯å“ªäº› key è®¿é—®æ¯”è¾ƒé¢‘ç¹ï¼Œä»è€Œåœ¨ç›¸åº”çš„ä¸šåŠ¡ä¸Šè¿›è¡Œä¼˜åŒ–ï¼Œä»¥å‡å°‘ IO æ¬¡æ•°ã€‚`monitor` æŒ‡ä»¤ä¼šç¬é—´åå‡ºæ¥å·¨é‡çš„æŒ‡ä»¤æ–‡æœ¬ï¼Œæ‰€ä»¥ä¸€èˆ¬åœ¨æ‰§è¡Œ `monitor` åç«‹å³ `ctrl+c `ä¸­æ–­è¾“å‡ºã€‚

```
> redis-cli monitor
```

## Redis è¿æ¥äº†å¤šå°‘å®¢æˆ·ç«¯ï¼Ÿ

è¿™ä¸ªä¿¡æ¯åœ¨ Clients å—é‡Œï¼Œå¯ä»¥é€šè¿‡ `info clients` çœ‹åˆ°ã€‚
```
> redis-cli info clients
# Clients
connected_clients:124  # è¿™ä¸ªå°±æ˜¯æ­£åœ¨è¿æ¥çš„å®¢æˆ·ç«¯æ•°é‡
client_longest_output_list:0
client_biggest_input_buf:0
blocked_clients:0
```
è¿™ä¸ªä¿¡æ¯ä¹Ÿæ˜¯æ¯”è¾ƒæœ‰ç”¨çš„ï¼Œé€šè¿‡è§‚å¯Ÿè¿™ä¸ªæ•°é‡å¯ä»¥ç¡®å®šæ˜¯å¦å­˜åœ¨æ„æ–™ä¹‹å¤–çš„è¿æ¥ã€‚å¦‚æœå‘ç°è¿™ä¸ªæ•°é‡ä¸å¯¹åŠ²ï¼Œæ¥ç€å°±å¯ä»¥ä½¿ç”¨```client list```æŒ‡ä»¤åˆ—å‡ºæ‰€æœ‰çš„å®¢æˆ·ç«¯é“¾æ¥åœ°å€æ¥ç¡®å®šæºå¤´ã€‚

å…³äºå®¢æˆ·ç«¯çš„æ•°é‡è¿˜æœ‰ä¸ªé‡è¦çš„å‚æ•°éœ€è¦è§‚å¯Ÿï¼Œé‚£å°±æ˜¯```rejected_connections```ï¼Œå®ƒè¡¨ç¤ºå› ä¸ºè¶…å‡ºæœ€å¤§è¿æ¥æ•°é™åˆ¶è€Œè¢«æ‹’ç»çš„å®¢æˆ·ç«¯è¿æ¥æ¬¡æ•°ï¼Œå¦‚æœè¿™ä¸ªæ•°å­—å¾ˆå¤§ï¼Œæ„å‘³ç€æœåŠ¡å™¨çš„æœ€å¤§è¿æ¥æ•°è®¾ç½®çš„è¿‡ä½éœ€è¦è°ƒæ•´ `maxclients` å‚æ•°ã€‚
```
> redis-cli info stats |grep reject
rejected_connections:0
```

## Redis å†…å­˜å ç”¨å¤šå¤§ ?

![](https://user-gold-cdn.xitu.io/2018/7/16/164a14efc8e3e44b?w=362&h=216&f=png&s=13620)

è¿™ä¸ªä¿¡æ¯åœ¨ Memory å—é‡Œï¼Œå¯ä»¥é€šè¿‡ `info memory` çœ‹åˆ°ã€‚
```
> redis-cli info memory | grep used | grep human
used_memory_human:827.46K # å†…å­˜åˆ†é…å™¨ (jemalloc) ä»æ“ä½œç³»ç»Ÿåˆ†é…çš„å†…å­˜æ€»é‡
used_memory_rss_human:3.61M  # æ“ä½œç³»ç»Ÿçœ‹åˆ°çš„å†…å­˜å ç”¨ ,top å‘½ä»¤çœ‹åˆ°çš„å†…å­˜
used_memory_peak_human:829.41K  # Redis å†…å­˜æ¶ˆè€—çš„å³°å€¼
used_memory_lua_human:37.00K # lua è„šæœ¬å¼•æ“å ç”¨çš„å†…å­˜å¤§å°
```
å¦‚æœå•ä¸ª Redis å†…å­˜å ç”¨è¿‡å¤§ï¼Œå¹¶ä¸”åœ¨ä¸šåŠ¡ä¸Šæ²¡æœ‰å¤ªå¤šå‹ç¼©çš„ç©ºé—´çš„è¯ï¼Œå¯ä»¥è€ƒè™‘é›†ç¾¤åŒ–äº†ã€‚

## å¤åˆ¶ç§¯å‹ç¼“å†²åŒºå¤šå¤§ï¼Ÿ

è¿™ä¸ªä¿¡æ¯åœ¨ Replication å—é‡Œï¼Œå¯ä»¥é€šè¿‡ `info replication` çœ‹åˆ°ã€‚
```
> redis-cli info replication |grep backlog
repl_backlog_active:0
repl_backlog_size:1048576  # è¿™ä¸ªå°±æ˜¯ç§¯å‹ç¼“å†²åŒºå¤§å°
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0
```
å¤åˆ¶ç§¯å‹ç¼“å†²åŒºå¤§å°éå¸¸é‡è¦ï¼Œå®ƒä¸¥é‡å½±å“åˆ°ä¸»ä»å¤åˆ¶çš„æ•ˆç‡ã€‚å½“ä»åº“å› ä¸ºç½‘ç»œåŸå› ä¸´æ—¶æ–­å¼€äº†ä¸»åº“çš„å¤åˆ¶ï¼Œç„¶åç½‘ç»œæ¢å¤äº†ï¼Œåˆé‡æ–°è¿ä¸Šçš„æ—¶å€™ï¼Œè¿™æ®µæ–­å¼€çš„æ—¶é—´å†…å‘ç”Ÿåœ¨ master ä¸Šçš„ä¿®æ”¹æ“ä½œæŒ‡ä»¤éƒ½ä¼šæ”¾åœ¨ç§¯å‹ç¼“å†²åŒºä¸­ï¼Œè¿™æ ·ä»åº“å¯ä»¥é€šè¿‡ç§¯å‹ç¼“å†²åŒºæ¢å¤ä¸­æ–­çš„ä¸»ä»åŒæ­¥è¿‡ç¨‹ã€‚

ç§¯å‹ç¼“å†²åŒºæ˜¯ç¯å½¢çš„ï¼Œåæ¥çš„æŒ‡ä»¤ä¼šè¦†ç›–æ‰å‰é¢çš„å†…å®¹ã€‚å¦‚æœä»åº“æ–­å¼€çš„æ—¶é—´è¿‡é•¿ï¼Œæˆ–è€…ç¼“å†²åŒºçš„å¤§å°è®¾ç½®çš„å¤ªå°ï¼Œéƒ½ä¼šå¯¼è‡´ä»åº“æ— æ³•å¿«é€Ÿæ¢å¤ä¸­æ–­çš„ä¸»ä»åŒæ­¥è¿‡ç¨‹ï¼Œå› ä¸ºä¸­é—´çš„ä¿®æ”¹æŒ‡ä»¤è¢«è¦†ç›–æ‰äº†ã€‚è¿™æ—¶å€™ä»åº“å°±ä¼šè¿›è¡Œå…¨é‡åŒæ­¥æ¨¡å¼ï¼Œéå¸¸è€—è´¹ CPU å’Œç½‘ç»œèµ„æºã€‚

å¦‚æœæœ‰å¤šä¸ªä»åº“å¤åˆ¶ï¼Œç§¯å‹ç¼“å†²åŒºæ˜¯å…±äº«çš„ï¼Œå®ƒä¸ä¼šå› ä¸ºä»åº“è¿‡å¤šè€Œçº¿æ€§å¢é•¿ã€‚å¦‚æœå®ä¾‹çš„ä¿®æ”¹æŒ‡ä»¤è¯·æ±‚å¾ˆé¢‘ç¹ï¼Œé‚£å°±æŠŠç§¯å‹ç¼“å†²åŒºè°ƒå¤§ä¸€äº›ï¼Œå‡ åä¸ª M å¤§å°å·®ä¸å¤šäº†ï¼Œå¦‚æœå¾ˆé—²ï¼Œé‚£å°±è®¾ç½®ä¸ºå‡ ä¸ª Mã€‚
```
> redis-cli info stats | grep sync
sync_full:0
sync_partial_ok:0
sync_partial_err:0  # åŠåŒæ­¥å¤±è´¥æ¬¡æ•°
```
é€šè¿‡æŸ¥çœ‹```sync_partial_err```å˜é‡çš„æ¬¡æ•°æ¥å†³å®šæ˜¯å¦éœ€è¦æ‰©å¤§ç§¯å‹ç¼“å†²åŒºï¼Œå®ƒè¡¨ç¤ºä¸»ä»åŠåŒæ­¥å¤åˆ¶å¤±è´¥çš„æ¬¡æ•°ã€‚

## æ€è€ƒ

å¹³æ—¶ä½ ä»¬åœ¨ä½¿ç”¨ Redis æ—¶è¿˜éœ€è¦æŸ¥çœ‹å“ªäº›é‡è¦çš„ä¿¡æ¯ï¼Œèƒ½ä¸èƒ½ç›´æ¥åœ¨ Info ä¿¡æ¯é‡Œè·å–ï¼Ÿ
# æ‹“å±• 3ï¼šæ‹¾é—æ¼è¡¥ â€”â€” å†è°ˆåˆ†å¸ƒå¼é”

åœ¨ç¬¬ä¸‰èŠ‚ï¼Œæˆ‘ä»¬ç»†è‡´è®²è§£äº†åˆ†å¸ƒå¼é”çš„åŸç†ï¼Œå®ƒçš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œä¸€æ¡æŒ‡ä»¤å°±å¯ä»¥å®ŒæˆåŠ é”æ“ä½œã€‚ä¸è¿‡åœ¨é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œè¿™ç§æ–¹å¼æ˜¯æœ‰ç¼ºé™·çš„ï¼Œå®ƒä¸æ˜¯ç»å¯¹å®‰å…¨çš„ã€‚

æ¯”å¦‚åœ¨ Sentinel é›†ç¾¤ä¸­ï¼Œä¸»èŠ‚ç‚¹æŒ‚æ‰æ—¶ï¼Œä»èŠ‚ç‚¹ä¼šå–è€Œä»£ä¹‹ï¼Œå®¢æˆ·ç«¯ä¸Šå´å¹¶æ²¡æœ‰æ˜æ˜¾æ„ŸçŸ¥ã€‚åŸå…ˆç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯åœ¨ä¸»èŠ‚ç‚¹ä¸­ç”³è¯·æˆåŠŸäº†ä¸€æŠŠé”ï¼Œä½†æ˜¯è¿™æŠŠé”è¿˜æ²¡æœ‰æ¥å¾—åŠåŒæ­¥åˆ°ä»èŠ‚ç‚¹ï¼Œä¸»èŠ‚ç‚¹çªç„¶æŒ‚æ‰äº†ã€‚ç„¶åä»èŠ‚ç‚¹å˜æˆäº†ä¸»èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ–°çš„èŠ‚ç‚¹å†…éƒ¨æ²¡æœ‰è¿™ä¸ªé”ï¼Œæ‰€ä»¥å½“å¦ä¸€ä¸ªå®¢æˆ·ç«¯è¿‡æ¥è¯·æ±‚åŠ é”æ—¶ï¼Œç«‹å³å°±æ‰¹å‡†äº†ã€‚è¿™æ ·å°±ä¼šå¯¼è‡´ç³»ç»Ÿä¸­åŒæ ·ä¸€æŠŠé”è¢«ä¸¤ä¸ªå®¢æˆ·ç«¯åŒæ—¶æŒæœ‰ï¼Œä¸å®‰å…¨æ€§ç”±æ­¤äº§ç”Ÿã€‚

![](https://user-gold-cdn.xitu.io/2018/7/16/164a15b65d4cd15a?w=738&h=313&f=png&s=29799)

ä¸è¿‡è¿™ç§ä¸å®‰å…¨ä¹Ÿä»…ä»…æ˜¯åœ¨ä¸»ä»å‘ç”Ÿ failover çš„æƒ…å†µä¸‹æ‰ä¼šäº§ç”Ÿï¼Œè€Œä¸”æŒç»­æ—¶é—´æçŸ­ï¼Œä¸šåŠ¡ç³»ç»Ÿå¤šæ•°æƒ…å†µä¸‹å¯ä»¥å®¹å¿ã€‚

## Redlock ç®—æ³•

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒAntirez å‘æ˜äº† Redlock ç®—æ³•ï¼Œå®ƒçš„æµç¨‹æ¯”è¾ƒå¤æ‚ï¼Œä¸è¿‡å·²ç»æœ‰äº†å¾ˆå¤šå¼€æºçš„ library åšäº†è‰¯å¥½çš„å°è£…ï¼Œç”¨æˆ·å¯ä»¥æ‹¿æ¥å³ç”¨ï¼Œæ¯”å¦‚ redlock-pyã€‚

```py
import redlock

addrs = [{
    "host": "localhost",
    "port": 6379,
    "db": 0
}, {
    "host": "localhost",
    "port": 6479,
    "db": 0
}, {
    "host": "localhost",
    "port": 6579,
    "db": 0
}]
dlm = redlock.Redlock(addrs)
success = dlm.lock("user-lck-laoqian", 5000)
if success:
    print 'lock success'
    dlm.unlock('user-lck-laoqian')
else:
    print 'lock failed'
```
ä¸ºäº†ä½¿ç”¨ Redlockï¼Œéœ€è¦æä¾›å¤šä¸ª Redis å®ä¾‹ï¼Œè¿™äº›å®ä¾‹ä¹‹å‰ç›¸äº’ç‹¬ç«‹æ²¡æœ‰ä¸»ä»å…³ç³»ã€‚åŒå¾ˆå¤šåˆ†å¸ƒå¼ç®—æ³•ä¸€æ ·ï¼Œredlock ä¹Ÿä½¿ç”¨ã€Œå¤§å¤šæ•°æœºåˆ¶ã€ã€‚

åŠ é”æ—¶ï¼Œå®ƒä¼šå‘è¿‡åŠèŠ‚ç‚¹å‘é€ `set(key, value, nx=True, ex=xxx)` æŒ‡ä»¤ï¼Œåªè¦è¿‡åŠèŠ‚ç‚¹ `set` æˆåŠŸï¼Œé‚£å°±è®¤ä¸ºåŠ é”æˆåŠŸã€‚é‡Šæ”¾é”æ—¶ï¼Œéœ€è¦å‘æ‰€æœ‰èŠ‚ç‚¹å‘é€ `del` æŒ‡ä»¤ã€‚ä¸è¿‡ Redlock ç®—æ³•è¿˜éœ€è¦è€ƒè™‘å‡ºé”™é‡è¯•ã€æ—¶é’Ÿæ¼‚ç§»ç­‰å¾ˆå¤šç»†èŠ‚é—®é¢˜ï¼ŒåŒæ—¶å› ä¸º Redlock éœ€è¦å‘å¤šä¸ªèŠ‚ç‚¹è¿›è¡Œè¯»å†™ï¼Œæ„å‘³ç€ç›¸æ¯”å•å®ä¾‹ Redis æ€§èƒ½ä¼šä¸‹é™ä¸€äº›ã€‚

## Redlock ä½¿ç”¨åœºæ™¯

å¦‚æœä½ å¾ˆåœ¨ä¹é«˜å¯ç”¨æ€§ï¼Œå¸Œæœ›æŒ‚äº†ä¸€å° redis å®Œå…¨ä¸å—å½±å“ï¼Œé‚£å°±åº”è¯¥è€ƒè™‘ redlockã€‚ä¸è¿‡ä»£ä»·ä¹Ÿæ˜¯æœ‰çš„ï¼Œéœ€è¦æ›´å¤šçš„ redis å®ä¾‹ï¼Œæ€§èƒ½ä¹Ÿä¸‹é™äº†ï¼Œä»£ç ä¸Šè¿˜éœ€è¦å¼•å…¥é¢å¤–çš„ libraryï¼Œè¿ç»´ä¸Šä¹Ÿéœ€è¦ç‰¹æ®Šå¯¹å¾…ï¼Œè¿™äº›éƒ½æ˜¯éœ€è¦è€ƒè™‘çš„æˆæœ¬ï¼Œä½¿ç”¨å‰è¯·å†ä¸‰æ–Ÿé…Œã€‚

## æ‰©å±•é˜…è¯»

#### 1. [ä½ ä»¥ä¸º Redlock ç®—æ³•çœŸçš„å¾ˆå®Œç¾ï¼Ÿ](http://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html)
#### 2. Redlock-py çš„ä½œè€…å…¶äººè¶£äº‹

![](https://user-gold-cdn.xitu.io/2018/7/16/164a1a0f66dcffb2?w=211&h=211&f=jpeg&s=8166)

çœ‹å¤´åƒéå¸¸é…·ï¼Œè¿™ä½è€å“¥çš„ Github åœ°å€æ˜¯ [https://github.com/optimuspaul](https://github.com/optimuspaul)
# æ‹“å±• 4ï¼šæœç”Ÿæš®æ­» â€”â€” è¿‡æœŸç­–ç•¥

Redis æ‰€æœ‰çš„æ•°æ®ç»“æ„éƒ½å¯ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ—¶é—´ä¸€åˆ°ï¼Œå°±ä¼šè‡ªåŠ¨åˆ é™¤ã€‚ä½ å¯ä»¥æƒ³è±¡ Redis å†…éƒ¨æœ‰ä¸€ä¸ªæ­»ç¥ï¼Œæ—¶åˆ»ç›¯ç€æ‰€æœ‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ keyï¼Œå¯¿å‘½ä¸€åˆ°å°±ä¼šç«‹å³æ”¶å‰²ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/19/164b156918d00bbd?w=526&h=353&f=png&s=25188)

ä½ è¿˜å¯ä»¥è¿›ä¸€æ­¥ç«™åœ¨æ­»ç¥çš„è§’åº¦æ€è€ƒï¼Œä¼šä¸ä¼šå› ä¸ºåŒä¸€æ—¶é—´å¤ªå¤šçš„ key è¿‡æœŸï¼Œä»¥è‡³äºå¿™ä¸è¿‡æ¥ã€‚åŒæ—¶å› ä¸º Redis æ˜¯å•çº¿ç¨‹çš„ï¼Œæ”¶å‰²çš„æ—¶é—´ä¹Ÿä¼šå ç”¨çº¿ç¨‹çš„å¤„ç†æ—¶é—´ï¼Œå¦‚æœæ”¶å‰²çš„å¤ªè¿‡äºç¹å¿™ï¼Œä¼šä¸ä¼šå¯¼è‡´çº¿ä¸Šè¯»å†™æŒ‡ä»¤å‡ºç°å¡é¡¿ã€‚

è¿™äº›é—®é¢˜ Antirez æ—©å°±æƒ³åˆ°äº†ï¼Œæ‰€æœ‰åœ¨è¿‡æœŸè¿™ä»¶äº‹ä¸Šï¼ŒRedis éå¸¸å°å¿ƒã€‚

## è¿‡æœŸçš„ key é›†åˆ

redis ä¼šå°†æ¯ä¸ªè®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key æ”¾å…¥åˆ°ä¸€ä¸ªç‹¬ç«‹çš„å­—å…¸ä¸­ï¼Œä»¥åä¼šå®šæ—¶éå†è¿™ä¸ªå­—å…¸æ¥åˆ é™¤åˆ°æœŸçš„ keyã€‚é™¤äº†å®šæ—¶éå†ä¹‹å¤–ï¼Œå®ƒè¿˜ä¼šä½¿ç”¨æƒ°æ€§ç­–ç•¥æ¥åˆ é™¤è¿‡æœŸçš„ keyï¼Œæ‰€è°“æƒ°æ€§ç­–ç•¥å°±æ˜¯åœ¨å®¢æˆ·ç«¯è®¿é—®è¿™ä¸ª key çš„æ—¶å€™ï¼Œredis å¯¹ key çš„è¿‡æœŸæ—¶é—´è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœè¿‡æœŸäº†å°±ç«‹å³åˆ é™¤ã€‚å®šæ—¶åˆ é™¤æ˜¯é›†ä¸­å¤„ç†ï¼Œæƒ°æ€§åˆ é™¤æ˜¯é›¶æ•£å¤„ç†ã€‚

## å®šæ—¶æ‰«æç­–ç•¥

Redis é»˜è®¤ä¼šæ¯ç§’è¿›è¡Œåæ¬¡è¿‡æœŸæ‰«æï¼Œè¿‡æœŸæ‰«æä¸ä¼šéå†è¿‡æœŸå­—å…¸ä¸­æ‰€æœ‰çš„ keyï¼Œè€Œæ˜¯é‡‡ç”¨äº†ä¸€ç§ç®€å•çš„è´ªå¿ƒç­–ç•¥ã€‚

1. ä»è¿‡æœŸå­—å…¸ä¸­éšæœº 20 ä¸ª keyï¼›
2. åˆ é™¤è¿™ 20 ä¸ª key ä¸­å·²ç»è¿‡æœŸçš„ keyï¼›
3. å¦‚æœè¿‡æœŸçš„ key æ¯”ç‡è¶…è¿‡ 1/4ï¼Œé‚£å°±é‡å¤æ­¥éª¤ 1ï¼›

åŒæ—¶ï¼Œä¸ºäº†ä¿è¯è¿‡æœŸæ‰«æä¸ä¼šå‡ºç°å¾ªç¯è¿‡åº¦ï¼Œå¯¼è‡´çº¿ç¨‹å¡æ­»ç°è±¡ï¼Œç®—æ³•è¿˜å¢åŠ äº†æ‰«ææ—¶é—´çš„ä¸Šé™ï¼Œé»˜è®¤ä¸ä¼šè¶…è¿‡ 25msã€‚

è®¾æƒ³ä¸€ä¸ªå¤§å‹çš„ Redis å®ä¾‹ä¸­æ‰€æœ‰çš„ key åœ¨åŒä¸€æ—¶é—´è¿‡æœŸäº†ï¼Œä¼šå‡ºç°æ€æ ·çš„ç»“æœï¼Ÿ

æ¯«æ— ç–‘é—®ï¼ŒRedis ä¼šæŒç»­æ‰«æè¿‡æœŸå­—å…¸ (å¾ªç¯å¤šæ¬¡)ï¼Œç›´åˆ°è¿‡æœŸå­—å…¸ä¸­è¿‡æœŸçš„ key å˜å¾—ç¨€ç–ï¼Œæ‰ä¼šåœæ­¢ (å¾ªç¯æ¬¡æ•°æ˜æ˜¾ä¸‹é™)ã€‚è¿™å°±ä¼šå¯¼è‡´çº¿ä¸Šè¯»å†™è¯·æ±‚å‡ºç°æ˜æ˜¾çš„å¡é¡¿ç°è±¡ã€‚å¯¼è‡´è¿™ç§å¡é¡¿çš„å¦å¤–ä¸€ç§åŸå› æ˜¯å†…å­˜ç®¡ç†å™¨éœ€è¦é¢‘ç¹å›æ”¶å†…å­˜é¡µï¼Œè¿™ä¹Ÿä¼šäº§ç”Ÿä¸€å®šçš„ CPU æ¶ˆè€—ã€‚

å½“å®¢æˆ·ç«¯è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒæœåŠ¡å™¨å¦‚æœæ­£å¥½è¿›å…¥è¿‡æœŸæ‰«æçŠ¶æ€ï¼Œå®¢æˆ·ç«¯çš„è¯·æ±‚å°†ä¼šç­‰å¾…è‡³å°‘ 25ms åæ‰ä¼šè¿›è¡Œå¤„ç†ï¼Œå¦‚æœå®¢æˆ·ç«¯å°†è¶…æ—¶æ—¶é—´è®¾ç½®çš„æ¯”è¾ƒçŸ­ï¼Œæ¯”å¦‚ 10msï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°å¤§é‡çš„é“¾æ¥å› ä¸ºè¶…æ—¶è€Œå…³é—­ï¼Œä¸šåŠ¡ç«¯å°±ä¼šå‡ºç°å¾ˆå¤šå¼‚å¸¸ã€‚è€Œä¸”è¿™æ—¶ä½ è¿˜æ— æ³•ä» Redis çš„ slowlog ä¸­çœ‹åˆ°æ…¢æŸ¥è¯¢è®°å½•ï¼Œå› ä¸ºæ…¢æŸ¥è¯¢æŒ‡çš„æ˜¯é€»è¾‘å¤„ç†è¿‡ç¨‹æ…¢ï¼Œä¸åŒ…å«ç­‰å¾…æ—¶é—´ã€‚

æ‰€ä»¥ä¸šåŠ¡å¼€å‘äººå‘˜ä¸€å®šè¦æ³¨æ„è¿‡æœŸæ—¶é—´ï¼Œå¦‚æœæœ‰å¤§æ‰¹é‡çš„ key è¿‡æœŸï¼Œè¦ç»™è¿‡æœŸæ—¶é—´è®¾ç½®ä¸€ä¸ªéšæœºèŒƒå›´ï¼Œè€Œä¸å®œå…¨éƒ¨åœ¨åŒä¸€æ—¶é—´è¿‡æœŸï¼Œåˆ†æ•£è¿‡æœŸå¤„ç†çš„å‹åŠ›ã€‚
```py
# åœ¨ç›®æ ‡è¿‡æœŸæ—¶é—´ä¸Šå¢åŠ ä¸€å¤©çš„éšæœºæ—¶é—´
redis.expire_at(key, random.randint(86400) + expire_ts)
```

åœ¨ä¸€äº›æ´»åŠ¨ç³»ç»Ÿä¸­ï¼Œå› ä¸ºæ´»åŠ¨æ˜¯ä¸€æœŸä¸€ä¼šï¼Œä¸‹ä¸€æœŸæ´»åŠ¨ä¸¾åŠæ—¶ï¼Œå‰é¢å‡ æœŸçš„å¾ˆå¤šæ•°æ®éƒ½å¯ä»¥ä¸¢å¼ƒäº†ï¼Œæ‰€ä»¥éœ€è¦ç»™ç›¸å…³çš„æ´»åŠ¨æ•°æ®è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œä»¥å‡å°‘ä¸å¿…è¦çš„ Redis å†…å­˜å ç”¨ã€‚å¦‚æœä¸åŠ æ³¨æ„ï¼Œä½ å¯èƒ½ä¼šå°†è¿‡æœŸæ—¶é—´è®¾ç½®ä¸ºæ´»åŠ¨ç»“æŸæ—¶é—´å†å¢åŠ ä¸€ä¸ªå¸¸é‡çš„å†—ä½™æ—¶é—´ï¼Œå¦‚æœå‚ä¸æ´»åŠ¨çš„äººæ•°å¤ªå¤šï¼Œå°±ä¼šå¯¼è‡´å¤§é‡çš„ key åŒæ—¶è¿‡æœŸã€‚

æŒé˜…æœåŠ¡ç«¯åœ¨å¼€å‘è¿‡ç¨‹ä¸­å°±æ›¾å‡ºç°è¿‡å¤šæ¬¡å› ä¸ºå¤§é‡ key åŒæ—¶è¿‡æœŸå¯¼è‡´çš„å¡é¡¿æŠ¥è­¦ç°è±¡ï¼Œé€šè¿‡å°†è¿‡æœŸæ—¶é—´éšæœºåŒ–æ€»æ˜¯èƒ½å¾ˆå¥½åœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå¸Œæœ›è¯»è€…ä»¬ä»Šåèƒ½å°‘çŠ¯è¿™æ ·çš„é”™è¯¯ã€‚

## ä»åº“çš„è¿‡æœŸç­–ç•¥

ä»åº“ä¸ä¼šè¿›è¡Œè¿‡æœŸæ‰«æï¼Œä»åº“å¯¹è¿‡æœŸçš„å¤„ç†æ˜¯è¢«åŠ¨çš„ã€‚ä¸»åº“åœ¨ key åˆ°æœŸæ—¶ï¼Œä¼šåœ¨ AOF æ–‡ä»¶é‡Œå¢åŠ ä¸€æ¡ `del` æŒ‡ä»¤ï¼ŒåŒæ­¥åˆ°æ‰€æœ‰çš„ä»åº“ï¼Œä»åº“é€šè¿‡æ‰§è¡Œè¿™æ¡ `del` æŒ‡ä»¤æ¥åˆ é™¤è¿‡æœŸçš„ keyã€‚

å› ä¸ºæŒ‡ä»¤åŒæ­¥æ˜¯å¼‚æ­¥è¿›è¡Œçš„ï¼Œæ‰€ä»¥ä¸»åº“è¿‡æœŸçš„ key çš„ `del` æŒ‡ä»¤æ²¡æœ‰åŠæ—¶åŒæ­¥åˆ°ä»åº“çš„è¯ï¼Œä¼šå‡ºç°ä¸»ä»æ•°æ®çš„ä¸ä¸€è‡´ï¼Œä¸»åº“æ²¡æœ‰çš„æ•°æ®åœ¨ä»åº“é‡Œè¿˜å­˜åœ¨ï¼Œæ¯”å¦‚ä¸Šä¸€èŠ‚çš„é›†ç¾¤ç¯å¢ƒåˆ†å¸ƒå¼é”çš„ç®—æ³•æ¼æ´å°±æ˜¯å› ä¸ºè¿™ä¸ªåŒæ­¥å»¶è¿Ÿäº§ç”Ÿçš„ã€‚
# æ‹“å±• 5ï¼šä¼˜èƒœåŠ£æ±° â€”â€” LRU

å½“ Redis å†…å­˜è¶…å‡ºç‰©ç†å†…å­˜é™åˆ¶æ—¶ï¼Œå†…å­˜çš„æ•°æ®ä¼šå¼€å§‹å’Œç£ç›˜äº§ç”Ÿé¢‘ç¹çš„äº¤æ¢ (swap)ã€‚äº¤æ¢ä¼šè®© Redis çš„æ€§èƒ½æ€¥å‰§ä¸‹é™ï¼Œå¯¹äºè®¿é—®é‡æ¯”è¾ƒé¢‘ç¹çš„ Redis æ¥è¯´ï¼Œè¿™æ ·é¾Ÿé€Ÿçš„å­˜å–æ•ˆç‡åŸºæœ¬ä¸Šç­‰äºä¸å¯ç”¨ã€‚

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä»¬æ˜¯ä¸å…è®¸ Redis å‡ºç°äº¤æ¢è¡Œä¸ºçš„ï¼Œä¸ºäº†é™åˆ¶æœ€å¤§ä½¿ç”¨å†…å­˜ï¼ŒRedis æä¾›äº†é…ç½®å‚æ•° `maxmemory` æ¥é™åˆ¶å†…å­˜è¶…å‡ºæœŸæœ›å¤§å°ã€‚

å½“å®é™…å†…å­˜è¶…å‡º `maxmemory` æ—¶ï¼ŒRedis æä¾›äº†å‡ ç§å¯é€‰ç­–ç•¥ (maxmemory-policy) æ¥è®©ç”¨æˆ·è‡ªå·±å†³å®šè¯¥å¦‚ä½•è…¾å‡ºæ–°çš„ç©ºé—´ä»¥ç»§ç»­æä¾›è¯»å†™æœåŠ¡ã€‚

**noeviction**
ä¸ä¼šç»§ç»­æœåŠ¡å†™è¯·æ±‚ (DEL è¯·æ±‚å¯ä»¥ç»§ç»­æœåŠ¡)ï¼Œè¯»è¯·æ±‚å¯ä»¥ç»§ç»­è¿›è¡Œã€‚è¿™æ ·å¯ä»¥ä¿è¯ä¸ä¼šä¸¢å¤±æ•°æ®ï¼Œä½†æ˜¯ä¼šè®©çº¿ä¸Šçš„ä¸šåŠ¡ä¸èƒ½æŒç»­è¿›è¡Œã€‚è¿™æ˜¯é»˜è®¤çš„æ·˜æ±°ç­–ç•¥ã€‚

**volatile-lru**
å°è¯•æ·˜æ±°è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ keyï¼Œæœ€å°‘ä½¿ç”¨çš„ key ä¼˜å…ˆè¢«æ·˜æ±°ã€‚æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´çš„ key ä¸ä¼šè¢«æ·˜æ±°ï¼Œè¿™æ ·å¯ä»¥ä¿è¯éœ€è¦æŒä¹…åŒ–çš„æ•°æ®ä¸ä¼šçªç„¶ä¸¢å¤±ã€‚

**volatile-ttl**
è·Ÿä¸Šé¢ä¸€æ ·ï¼Œé™¤äº†æ·˜æ±°çš„ç­–ç•¥ä¸æ˜¯ LRUï¼Œè€Œæ˜¯ key çš„å‰©ä½™å¯¿å‘½ ttl çš„å€¼ï¼Œttl è¶Šå°è¶Šä¼˜å…ˆè¢«æ·˜æ±°ã€‚

**volatile-random**
è·Ÿä¸Šé¢ä¸€æ ·ï¼Œä¸è¿‡æ·˜æ±°çš„ key æ˜¯è¿‡æœŸ key é›†åˆä¸­éšæœºçš„ keyã€‚

**allkeys-lru**
åŒºåˆ«äº volatile-lruï¼Œè¿™ä¸ªç­–ç•¥è¦æ·˜æ±°çš„ key å¯¹è±¡æ˜¯å…¨ä½“çš„ key é›†åˆï¼Œè€Œä¸åªæ˜¯è¿‡æœŸçš„ key é›†åˆã€‚è¿™æ„å‘³ç€æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´çš„ key ä¹Ÿä¼šè¢«æ·˜æ±°ã€‚

**allkeys-random**
è·Ÿä¸Šé¢ä¸€æ ·ï¼Œä¸è¿‡æ·˜æ±°çš„ç­–ç•¥æ˜¯éšæœºçš„ keyã€‚

volatile-xxx ç­–ç•¥åªä¼šé’ˆå¯¹å¸¦è¿‡æœŸæ—¶é—´çš„ key è¿›è¡Œæ·˜æ±°ï¼Œallkeys-xxx ç­–ç•¥ä¼šå¯¹æ‰€æœ‰çš„ key è¿›è¡Œæ·˜æ±°ã€‚å¦‚æœä½ åªæ˜¯æ‹¿ Redis åšç¼“å­˜ï¼Œé‚£åº”è¯¥ä½¿ç”¨ allkeys-xxxï¼Œå®¢æˆ·ç«¯å†™ç¼“å­˜æ—¶ä¸å¿…æºå¸¦è¿‡æœŸæ—¶é—´ã€‚å¦‚æœä½ è¿˜æƒ³åŒæ—¶ä½¿ç”¨ Redis çš„æŒä¹…åŒ–åŠŸèƒ½ï¼Œé‚£å°±ä½¿ç”¨ volatile-xxx ç­–ç•¥ï¼Œè¿™æ ·å¯ä»¥ä¿ç•™æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´çš„ keyï¼Œå®ƒä»¬æ˜¯æ°¸ä¹…çš„ key ä¸ä¼šè¢« LRU ç®—æ³•æ·˜æ±°ã€‚

## LRU ç®—æ³•

å®ç° LRU ç®—æ³•é™¤äº†éœ€è¦ key/value å­—å…¸å¤–ï¼Œè¿˜éœ€è¦é™„åŠ ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­çš„å…ƒç´ æŒ‰ç…§ä¸€å®šçš„é¡ºåºè¿›è¡Œæ’åˆ—ã€‚å½“ç©ºé—´æ»¡çš„æ—¶å€™ï¼Œä¼šè¸¢æ‰é“¾è¡¨å°¾éƒ¨çš„å…ƒç´ ã€‚å½“å­—å…¸çš„æŸä¸ªå…ƒç´ è¢«è®¿é—®æ—¶ï¼Œå®ƒåœ¨é“¾è¡¨ä¸­çš„ä½ç½®ä¼šè¢«ç§»åŠ¨åˆ°è¡¨å¤´ã€‚æ‰€ä»¥é“¾è¡¨çš„å…ƒç´ æ’åˆ—é¡ºåºå°±æ˜¯å…ƒç´ æœ€è¿‘è¢«è®¿é—®çš„æ—¶é—´é¡ºåºã€‚

ä½äºé“¾è¡¨å°¾éƒ¨çš„å…ƒç´ å°±æ˜¯ä¸è¢«é‡ç”¨çš„å…ƒç´ ï¼Œæ‰€ä»¥ä¼šè¢«è¸¢æ‰ã€‚ä½äºè¡¨å¤´çš„å…ƒç´ å°±æ˜¯æœ€è¿‘åˆšåˆšè¢«äººç”¨è¿‡çš„å…ƒç´ ï¼Œæ‰€ä»¥æš‚æ—¶ä¸ä¼šè¢«è¸¢ã€‚

ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ Python çš„ OrderedDict(åŒå‘é“¾è¡¨ + å­—å…¸) æ¥å®ç°ä¸€ä¸ªç®€å•çš„ LRU ç®—æ³•ã€‚
```py
from collections import OrderedDict

class LRUDict(OrderedDict):

    def __init__(self, capacity):
        self.capacity = capacity
        self.items = OrderedDict()

    def __setitem__(self, key, value):
        old_value = self.items.get(key)
        if old_value is not None:
            self.items.pop(key)
            self.items[key] = value
        elif len(self.items) < self.capacity:
            self.items[key] = value
        else:
            self.items.popitem(last=True)
            self.items[key] = value

    def __getitem__(self, key):
        value = self.items.get(key)
        if value is not None:
            self.items.pop(key)
            self.items[key] = value
        return value

    def __repr__(self):
        return repr(self.items)


d = LRUDict(10)

for i in range(15):
    d[i] = i
print d
```

## è¿‘ä¼¼ LRU ç®—æ³•

Redis ä½¿ç”¨çš„æ˜¯ä¸€ç§è¿‘ä¼¼ LRU ç®—æ³•ï¼Œå®ƒè·Ÿ LRU ç®—æ³•è¿˜ä¸å¤ªä¸€æ ·ã€‚ä¹‹æ‰€ä»¥ä¸ä½¿ç”¨ LRU ç®—æ³•ï¼Œæ˜¯å› ä¸ºéœ€è¦æ¶ˆè€—å¤§é‡çš„é¢å¤–çš„å†…å­˜ï¼Œéœ€è¦å¯¹ç°æœ‰çš„æ•°æ®ç»“æ„è¿›è¡Œè¾ƒå¤§çš„æ”¹é€ ã€‚è¿‘ä¼¼ LRU ç®—æ³•åˆ™å¾ˆç®€å•ï¼Œåœ¨ç°æœ‰æ•°æ®ç»“æ„çš„åŸºç¡€ä¸Šä½¿ç”¨éšæœºé‡‡æ ·æ³•æ¥æ·˜æ±°å…ƒç´ ï¼Œèƒ½è¾¾åˆ°å’Œ LRU ç®—æ³•éå¸¸è¿‘ä¼¼çš„æ•ˆæœã€‚Redis ä¸ºå®ç°è¿‘ä¼¼ LRU ç®—æ³•ï¼Œå®ƒç»™æ¯ä¸ª key å¢åŠ äº†ä¸€ä¸ªé¢å¤–çš„å°å­—æ®µï¼Œè¿™ä¸ªå­—æ®µçš„é•¿åº¦æ˜¯ 24 ä¸ª bitï¼Œä¹Ÿå°±æ˜¯æœ€åä¸€æ¬¡è¢«è®¿é—®çš„æ—¶é—´æˆ³ã€‚

ä¸Šä¸€èŠ‚æåˆ°å¤„ç† key è¿‡æœŸæ–¹å¼åˆ†ä¸ºé›†ä¸­å¤„ç†å’Œæ‡’æƒ°å¤„ç†ï¼ŒLRU æ·˜æ±°ä¸ä¸€æ ·ï¼Œå®ƒçš„å¤„ç†æ–¹å¼åªæœ‰æ‡’æƒ°å¤„ç†ã€‚å½“ Redis æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œå‘ç°å†…å­˜è¶…å‡º maxmemoryï¼Œå°±ä¼šæ‰§è¡Œä¸€æ¬¡ LRU æ·˜æ±°ç®—æ³•ã€‚è¿™ä¸ªç®—æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯éšæœºé‡‡æ ·å‡º 5(å¯ä»¥é…ç½®) ä¸ª keyï¼Œç„¶åæ·˜æ±°æ‰æœ€æ—§çš„ keyï¼Œå¦‚æœæ·˜æ±°åå†…å­˜è¿˜æ˜¯è¶…å‡º maxmemoryï¼Œé‚£å°±ç»§ç»­éšæœºé‡‡æ ·æ·˜æ±°ï¼Œç›´åˆ°å†…å­˜ä½äº maxmemory ä¸ºæ­¢ã€‚

å¦‚ä½•é‡‡æ ·å°±æ˜¯çœ‹ maxmemory-policy çš„é…ç½®ï¼Œå¦‚æœæ˜¯ allkeys å°±æ˜¯ä»æ‰€æœ‰çš„ key å­—å…¸ä¸­éšæœºï¼Œå¦‚æœæ˜¯ volatile å°±ä»å¸¦è¿‡æœŸæ—¶é—´çš„ key å­—å…¸ä¸­éšæœºã€‚æ¯æ¬¡é‡‡æ ·å¤šå°‘ä¸ª key çœ‹çš„æ˜¯ maxmemory_samples çš„é…ç½®ï¼Œé»˜è®¤ä¸º 5ã€‚

ä¸‹é¢æ˜¯éšæœº LRU ç®—æ³•å’Œä¸¥æ ¼ LRU ç®—æ³•çš„æ•ˆæœå¯¹æ¯”å›¾ï¼š

![](https://user-gold-cdn.xitu.io/2018/7/17/164a60daf989f5e2?w=854&h=449&f=png&s=435399)

å›¾ä¸­ç»¿è‰²éƒ¨åˆ†æ˜¯æ–°åŠ å…¥çš„ keyï¼Œæ·±ç°è‰²éƒ¨åˆ†æ˜¯è€æ—§çš„ keyï¼Œæµ…ç°è‰²éƒ¨åˆ†æ˜¯é€šè¿‡ LRU ç®—æ³•æ·˜æ±°æ‰çš„ keyã€‚ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºé‡‡æ ·æ•°é‡è¶Šå¤§ï¼Œè¿‘ä¼¼ LRU ç®—æ³•çš„æ•ˆæœè¶Šæ¥è¿‘ä¸¥æ ¼ LRU ç®—æ³•ã€‚åŒæ—¶ Redis3.0 åœ¨ç®—æ³•ä¸­å¢åŠ äº†æ·˜æ±°æ± ï¼Œè¿›ä¸€æ­¥æå‡äº†è¿‘ä¼¼ LRU ç®—æ³•çš„æ•ˆæœã€‚

æ·˜æ±°æ± æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå®ƒçš„å¤§å°æ˜¯ maxmemory_samplesï¼Œåœ¨æ¯ä¸€æ¬¡æ·˜æ±°å¾ªç¯ä¸­ï¼Œæ–°éšæœºå‡ºæ¥çš„ key åˆ—è¡¨ä¼šå’Œæ·˜æ±°æ± ä¸­çš„ key åˆ—è¡¨è¿›è¡Œèåˆï¼Œæ·˜æ±°æ‰æœ€æ—§çš„ä¸€ä¸ª key ä¹‹åï¼Œä¿ç•™å‰©ä½™è¾ƒæ—§çš„ key åˆ—è¡¨æ”¾å…¥æ·˜æ±°æ± ä¸­ç•™å¾…ä¸‹ä¸€ä¸ªå¾ªç¯ã€‚

## æ‰©å±•é˜…è¯»

- [ã€ŠRedis ä½œä¸º LRU Cache çš„å®ç°ã€‹](https://yq.aliyun.com/articles/63034)
- [ã€ŠRedis LRU å®ç°ç­–ç•¥ã€‹](https://blog.csdn.net/mysqldba23/article/details/68482894)

## æ€è€ƒ & ä½œä¸š

1. å¦‚æœä½ æ˜¯ Java ç”¨æˆ·ï¼Œè¯•ä¸€è¯•ç”¨ LinkedHashMap å®ç°ä¸€ä¸ª LRU å­—å…¸ã€‚
2. å¦‚æœä½ æ˜¯ Golang ç”¨æˆ·ï¼Œé˜…è¯»ä¸€ä¸‹ [golang-lru](https://github.com/hashicorp/golang-lru) çš„æºç ã€‚
# æ‹“å±• 6ï¼šå¹³æ³¢ç¼“è¿› â€”â€” æ‡’æƒ°åˆ é™¤

ä¸€ç›´ä»¥æ¥æˆ‘ä»¬è®¤ä¸º Redis æ˜¯å•çº¿ç¨‹çš„ï¼Œå•çº¿ç¨‹ä¸º Redis å¸¦æ¥äº†ä»£ç çš„ç®€æ´æ€§å’Œä¸°å¯Œå¤šæ ·çš„æ•°æ®ç»“æ„ã€‚ä¸è¿‡Rediså†…éƒ¨å®é™…ä¸Šå¹¶ä¸æ˜¯åªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œå®ƒè¿˜æœ‰å‡ ä¸ªå¼‚æ­¥çº¿ç¨‹ä¸“é—¨ç”¨æ¥å¤„ç†ä¸€äº›è€—æ—¶çš„æ“ä½œã€‚

## Redis ä¸ºä»€ä¹ˆè¦æ‡’æƒ°åˆ é™¤(lazy free)ï¼Ÿ

åˆ é™¤æŒ‡ä»¤ `del` ä¼šç›´æ¥é‡Šæ”¾å¯¹è±¡çš„å†…å­˜ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæŒ‡ä»¤éå¸¸å¿«ï¼Œæ²¡æœ‰æ˜æ˜¾å»¶è¿Ÿã€‚ä¸è¿‡å¦‚æœåˆ é™¤çš„ key æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„å¯¹è±¡ï¼Œæ¯”å¦‚ä¸€ä¸ªåŒ…å«äº†åƒä¸‡å…ƒç´ çš„ hashï¼Œé‚£ä¹ˆåˆ é™¤æ“ä½œå°±ä¼šå¯¼è‡´å•çº¿ç¨‹å¡é¡¿ã€‚

Redis ä¸ºäº†è§£å†³è¿™ä¸ªå¡é¡¿é—®é¢˜ï¼Œåœ¨ 4.0 ç‰ˆæœ¬å¼•å…¥äº† `unlink` æŒ‡ä»¤ï¼Œå®ƒèƒ½å¯¹åˆ é™¤æ“ä½œè¿›è¡Œæ‡’å¤„ç†ï¼Œä¸¢ç»™åå°çº¿ç¨‹æ¥å¼‚æ­¥å›æ”¶å†…å­˜ã€‚
```
> unlink key
OK
```
å¦‚æœæœ‰å¤šçº¿ç¨‹çš„å¼€å‘ç»éªŒï¼Œä½ è‚¯å®šä¼šæ‹…å¿ƒè¿™é‡Œçš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä¼šä¸ä¼šå‡ºç°å¤šä¸ªçº¿ç¨‹åŒæ—¶å¹¶å‘ä¿®æ”¹æ•°æ®ç»“æ„çš„æƒ…å†µå­˜åœ¨ã€‚

å…³äºè¿™ç‚¹ï¼Œæˆ‘æ‰“ä¸ªæ¯”æ–¹ã€‚å¯ä»¥å°†æ•´ä¸ª Redis å†…å­˜é‡Œé¢æ‰€æœ‰æœ‰æ•ˆçš„æ•°æ®æƒ³è±¡æˆä¸€æ£µå¤§æ ‘ã€‚å½“ `unlink` æŒ‡ä»¤å‘å‡ºæ—¶ï¼Œå®ƒåªæ˜¯æŠŠå¤§æ ‘ä¸­çš„ä¸€ä¸ªæ ‘æåˆ«æ–­äº†ï¼Œç„¶åæ‰”åˆ°æ—è¾¹çš„ç«å †é‡Œç„šçƒ§ (å¼‚æ­¥çº¿ç¨‹æ± )ã€‚æ ‘æç¦»å¼€å¤§æ ‘çš„ä¸€ç¬é—´ï¼Œå®ƒå°±å†ä¹Ÿæ— æ³•è¢«ä¸»çº¿ç¨‹ä¸­çš„å…¶å®ƒæŒ‡ä»¤è®¿é—®åˆ°äº†ï¼Œå› ä¸ºä¸»çº¿ç¨‹åªä¼šæ²¿ç€è¿™é¢—å¤§æ ‘æ¥è®¿é—®ã€‚

## flush
Redis æä¾›äº† `flushdb` å’Œ `flushall` æŒ‡ä»¤ï¼Œç”¨æ¥æ¸…ç©ºæ•°æ®åº“ï¼Œè¿™ä¹Ÿæ˜¯æå…¶ç¼“æ…¢çš„æ“ä½œã€‚Redis 4.0 åŒæ ·ç»™è¿™ä¸¤ä¸ªæŒ‡ä»¤ä¹Ÿå¸¦æ¥äº†å¼‚æ­¥åŒ–ï¼Œåœ¨æŒ‡ä»¤åé¢å¢åŠ  `async` å‚æ•°å°±å¯ä»¥å°†æ•´æ£µå¤§æ ‘è¿æ ¹æ‹”èµ·ï¼Œæ‰”ç»™åå°çº¿ç¨‹æ…¢æ…¢ç„šçƒ§ã€‚

```
> flushall async
OK
```

## å¼‚æ­¥é˜Ÿåˆ—
ä¸»çº¿ç¨‹å°†å¯¹è±¡çš„å¼•ç”¨ä»ã€Œå¤§æ ‘ã€ä¸­æ‘˜é™¤åï¼Œä¼šå°†è¿™ä¸ª key çš„å†…å­˜å›æ”¶æ“ä½œåŒ…è£…æˆä¸€ä¸ªä»»åŠ¡ï¼Œå¡è¿›å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œåå°çº¿ç¨‹ä¼šä»è¿™ä¸ªå¼‚æ­¥é˜Ÿåˆ—ä¸­å–ä»»åŠ¡ã€‚ä»»åŠ¡é˜Ÿåˆ—è¢«ä¸»çº¿ç¨‹å’Œå¼‚æ­¥çº¿ç¨‹åŒæ—¶æ“ä½œï¼Œæ‰€ä»¥å¿…é¡»æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—ã€‚

![](https://user-gold-cdn.xitu.io/2018/8/2/164fa17ba5f2d88e?w=771&h=138&f=png&s=18045)

ä¸æ˜¯æ‰€æœ‰çš„ `unlink` æ“ä½œéƒ½ä¼šå»¶åå¤„ç†ï¼Œå¦‚æœå¯¹åº” key æ‰€å ç”¨çš„å†…å­˜å¾ˆå°ï¼Œå»¶åå¤„ç†å°±æ²¡æœ‰å¿…è¦äº†ï¼Œè¿™æ—¶å€™ Redis ä¼šå°†å¯¹åº”çš„ key å†…å­˜ç«‹å³å›æ”¶ï¼Œè·Ÿ `del` æŒ‡ä»¤ä¸€æ ·ã€‚

## AOF Syncä¹Ÿå¾ˆæ…¢
Rediséœ€è¦æ¯ç§’ä¸€æ¬¡(å¯é…ç½®)åŒæ­¥AOFæ—¥å¿—åˆ°ç£ç›˜ï¼Œç¡®ä¿æ¶ˆæ¯å°½é‡ä¸ä¸¢å¤±ï¼Œéœ€è¦è°ƒç”¨syncå‡½æ•°ï¼Œè¿™ä¸ªæ“ä½œä¼šæ¯”è¾ƒè€—æ—¶ï¼Œä¼šå¯¼è‡´ä¸»çº¿ç¨‹çš„æ•ˆç‡ä¸‹é™ï¼Œæ‰€ä»¥Redisä¹Ÿå°†è¿™ä¸ªæ“ä½œç§»åˆ°å¼‚æ­¥çº¿ç¨‹æ¥å®Œæˆã€‚æ‰§è¡ŒAOF Syncæ“ä½œçš„çº¿ç¨‹æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¼‚æ­¥çº¿ç¨‹ï¼Œå’Œå‰é¢çš„æ‡’æƒ°åˆ é™¤çº¿ç¨‹ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼ŒåŒæ ·å®ƒä¹Ÿæœ‰ä¸€ä¸ªå±äºè‡ªå·±çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é‡Œåªç”¨æ¥å­˜æ”¾AOF Syncä»»åŠ¡ã€‚

## æ›´å¤šå¼‚æ­¥åˆ é™¤ç‚¹
Redis å›æ”¶å†…å­˜é™¤äº† `del` æŒ‡ä»¤å’Œ `flush` ä¹‹å¤–ï¼Œè¿˜ä¼šå­˜åœ¨äºåœ¨ key çš„è¿‡æœŸã€LRU æ·˜æ±°ã€rename æŒ‡ä»¤ä»¥åŠä»åº“å…¨é‡åŒæ­¥æ—¶æ¥å—å®Œ rdb æ–‡ä»¶åä¼šç«‹å³è¿›è¡Œçš„ flush æ“ä½œã€‚

Redis4.0 ä¸ºè¿™äº›åˆ é™¤ç‚¹ä¹Ÿå¸¦æ¥äº†å¼‚æ­¥åˆ é™¤æœºåˆ¶ï¼Œæ‰“å¼€è¿™äº›ç‚¹éœ€è¦é¢å¤–çš„é…ç½®é€‰é¡¹ã€‚
1. `slave-lazy-flush`  ä»åº“æ¥å—å®Œ rdb æ–‡ä»¶åçš„ flush æ“ä½œ
2. `lazyfree-lazy-eviction` å†…å­˜è¾¾åˆ° maxmemory æ—¶è¿›è¡Œæ·˜æ±°
3. `lazyfree-lazy-expire key` è¿‡æœŸåˆ é™¤
4. `lazyfree-lazy-server-del` rename æŒ‡ä»¤åˆ é™¤ destKey

## æ‰©å±•é˜…è¯»
 - [Redis æ‡’æƒ°å¤„ç†çš„ç»†èŠ‚](https://yq.aliyun.com/articles/205504)
 # æ‹“å±• 7ï¼šå¦™æ‰‹ä»å¿ƒ â€”â€” ä¼˜é›…åœ°ä½¿ç”¨ Jedis

æœ¬èŠ‚é¢å‘ Java ç”¨æˆ·ï¼Œä¸»é¢˜æ˜¯å¦‚ä½•ä¼˜é›…åœ°ä½¿ç”¨ Jedis ç¼–å†™åº”ç”¨ç¨‹åºï¼Œæ—¢å¯ä»¥è®©ä»£ç çœ‹èµ·æ¥èµå¿ƒæ‚¦ç›®ï¼Œåˆå¯ä»¥é¿å…ä½¿ç”¨è€…çŠ¯é”™ã€‚

Jedis æ˜¯ Java ç”¨æˆ·æœ€å¸¸ç”¨çš„ Redis å¼€æºå®¢æˆ·ç«¯ã€‚å®ƒéå¸¸å°å·§ï¼Œå®ç°åŸç†ä¹Ÿå¾ˆç®€å•ï¼Œæœ€é‡è¦çš„æ˜¯å¾ˆç¨³å®šï¼Œè€Œä¸”ä½¿ç”¨çš„æ–¹æ³•å‚æ•°åç§°å’Œå®˜æ–¹çš„æ–‡æ¡£éå¸¸ matchï¼Œå¦‚æœæœ‰ä»€ä¹ˆæ–¹æ³•ä¸ä¼šç”¨ï¼Œç›´æ¥å‚è€ƒå®˜æ–¹çš„æŒ‡ä»¤æ–‡æ¡£é˜…è¯»ä¸€ä¸‹å°±ä¼šäº†ï¼Œçœå»äº†éå¿…è¦çš„é‡å¤å­¦ä¹ æˆæœ¬ã€‚ä¸åƒæœ‰äº›å®¢æˆ·ç«¯æŠŠæ–¹æ³•åç§°éƒ½æ¢äº†ï¼Œè™½ç„¶è¡¨é¢ä¸Šç»™è¯»è€…å¸¦æ¥äº†ä¾¿æ·ï¼Œä½†æ˜¯éœ€è¦æŒ¨ä¸ªé‡æ–°å­¦ä¹ è¿™äº› APIï¼Œæé«˜äº†å­¦ä¹ æˆæœ¬ã€‚

Java ç¨‹åºä¸€èˆ¬éƒ½æ˜¯å¤šçº¿ç¨‹çš„åº”ç”¨ç¨‹åºï¼Œæ„å‘³ç€æˆ‘ä»¬å¾ˆå°‘ç›´æ¥ä½¿ç”¨ Jedisï¼Œè€Œæ˜¯è¦ç”¨åˆ° Jedis çš„è¿æ¥æ±  â€”â€” JedisPoolã€‚åŒæ—¶å› ä¸º Jedis å¯¹è±¡ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå½“æˆ‘ä»¬è¦ä½¿ç”¨ Jedis å¯¹è±¡æ—¶ï¼Œéœ€è¦ä»è¿æ¥æ± ä¸­æ‹¿å‡ºä¸€ä¸ª Jedis å¯¹è±¡ç‹¬å ï¼Œä½¿ç”¨å®Œæ¯•åå†å°†è¿™ä¸ªå¯¹è±¡è¿˜ç»™è¿æ¥æ± ã€‚

ç”¨ä»£ç è¡¨ç¤ºå¦‚ä¸‹ï¼š
```java
import redis.clients.jedis.Jedis;
import redis.clients.jedis.JedisPool;

public class JedisTest {

  public static void main(String[] args) {
    JedisPool pool = new JedisPool();
    Jedis jedis = pool.getResource(); // æ‹¿å‡º Jedis é“¾æ¥å¯¹è±¡
    doSomething(jedis);
    jedis.close(); // å½’è¿˜é“¾æ¥
  }

  private static void doSomething(Jedis jedis) {
    // code it here
  }

}
```

ä¸Šé¢çš„ä»£ç æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœ `doSomething` æ–¹æ³•æŠ›å‡ºäº†å¼‚å¸¸çš„è¯ï¼Œä»è¿æ¥æ± ä¸­æ‹¿å‡ºæ¥çš„ Jedis å¯¹è±¡å°†æ— æ³•å½’è¿˜ç»™è¿æ¥æ± ã€‚å¦‚æœè¿™æ ·çš„å¼‚å¸¸å‘ç”Ÿäº†å¥½å‡ æ¬¡ï¼Œè¿æ¥æ± ä¸­çš„æ‰€æœ‰é“¾æ¥éƒ½è¢«æŒä¹…å ç”¨äº†ï¼Œæ–°çš„è¯·æ±‚è¿‡æ¥æ—¶å°±ä¼šé˜»å¡ç­‰å¾…ç©ºé—²çš„é“¾æ¥ï¼Œè¿™æ ·çš„é˜»å¡ä¸€èˆ¬ä¼šç›´æ¥å¯¼è‡´åº”ç”¨ç¨‹åºå¡æ­»ã€‚

ä¸ºäº†é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œç¨‹åºå‘˜éœ€è¦åœ¨ä½¿ç”¨ JedisPool é‡Œé¢çš„ Jedis é“¾æ¥æ—¶ï¼Œåº”è¯¥ä½¿ç”¨ `try-with-resource` è¯­å¥æ¥ä¿æŠ¤ Jedis å¯¹è±¡ã€‚

```java
import redis.clients.jedis.Jedis;
import redis.clients.jedis.JedisPool;

public class JedisTest {

  public static void main(String[] args) {
    JedisPool pool = new JedisPool();
    try (Jedis jedis = pool.getResource()) { // ç”¨å®Œè‡ªåŠ¨ close
      doSomething(jedis);
    }
  }

  private static void doSomething(Jedis jedis) {
    // code it here
  }

}
```
è¿™æ · Jedis å¯¹è±¡è‚¯å®šä¼šå½’è¿˜ç»™è¿æ¥æ±  (æ­»å¾ªç¯é™¤å¤–)ï¼Œé¿å…åº”ç”¨ç¨‹åºå¡æ­»çš„æƒ¨å‰§å‘ç”Ÿã€‚

ä½†æ˜¯å½“ä¸€ä¸ªå›¢é˜Ÿå¤Ÿå¤§çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ç¨‹åºå‘˜éƒ½ä¼šéå¸¸æœ‰ç»éªŒï¼Œä»–ä»¬å¯èƒ½å› ä¸ºå„ç§åŸå› å¿˜è®°äº†ä½¿ç”¨ `try-with-resource` è¯­å¥ï¼Œæƒ¨å‰§å°±ä¼šçªç„¶å†’å‡ºæ¥è®©è¿ç»´äººå‘˜æªæ‰‹ä¸åŠã€‚æˆ‘ä»¬éœ€è¦åœ¨ä»£ç ä¸ŠåŠ ä¸Šä¸€å±‚ç¡¬çº¦æŸï¼Œé€šè¿‡è¿™å±‚çº¦æŸï¼Œå½“ç¨‹åºå‘˜æƒ³è¦è®¿é—® Jedis å¯¹è±¡æ—¶ï¼Œä¸ä¼šå†å‡ºç°ä½¿ç”¨äº† Jedis å¯¹è±¡è€Œä¸å½’è¿˜ã€‚
```java
import redis.clients.jedis.Jedis;
import redis.clients.jedis.JedisPool;

interface CallWithJedis {
  public void call(Jedis jedis);
}

class RedisPool {

  private JedisPool pool;

  public RedisPool() {
    this.pool = new JedisPool();
  }

  public void execute(CallWithJedis caller) {
    try (Jedis jedis = pool.getResource()) {
      caller.call(jedis);
    }
  }

}

public class JedisTest {

  public static void main(String[] args) {
    RedisPool redis = new RedisPool();
    redis.execute(new CallWithJedis() {

      @Override
      public void call(Jedis jedis) {
        // do something with jedis
      }

    });
  }

}
```
æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„è‡ªå®šä¹‰çš„ RedisPool å¯¹è±¡å°† JedisPool å¯¹è±¡éšè—èµ·æ¥ï¼Œé¿å…ç¨‹åºå‘˜ç›´æ¥ä½¿ç”¨å®ƒçš„ `getResource` æ–¹æ³•è€Œå¿˜è®°äº†å½’è¿˜ã€‚ç¨‹åºå‘˜ä½¿ç”¨ RedisPool å¯¹è±¡æ—¶éœ€è¦æä¾›ä¸€ä¸ªå›è°ƒç±»æ¥æ‰èƒ½ä½¿ç”¨ Jedis å¯¹è±¡ã€‚

ä½†æ˜¯æ¯æ¬¡è®¿é—® Redis éƒ½éœ€è¦å†™ä¸€ä¸ªå›è°ƒç±»ï¼ŒçœŸæ˜¯ç‰¹åˆ«ç¹çï¼Œä»£ç ä¹Ÿæ˜¾å¾—éå¸¸è‡ƒè‚¿ã€‚å¹¸å¥½ Java8 å¸¦æ¥äº† Lambda è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Lambda è¡¨è¾¾å¼ç®€åŒ–ä¸Šé¢çš„ä»£ç ã€‚

```java
public class JedisTest {

  public static void main(String[] args) {
    Redis redis = new Redis();
    redis.execute(jedis -> {
      // do something with jedis
    });
  }

}
```
è¿™æ ·çœ‹èµ·æ¥å°±ç®€æ´ä¼˜é›…å¤šäº†ã€‚ä½†æ˜¯è¿˜æœ‰ä¸ªé—®é¢˜ï¼ŒJava ä¸å…è®¸åœ¨é—­åŒ…é‡Œä¿®æ”¹é—­åŒ…å¤–é¢çš„å˜é‡ã€‚æ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼Œæˆ‘ä»¬æƒ³ä» Redis é‡Œé¢æ‹¿åˆ°æŸä¸ª zset å¯¹è±¡çš„é•¿åº¦ï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥æŠ¥é”™ã€‚

```java
public class JedisTest {

  public static void main(String[] args) {
    Redis redis = new Redis();
    long count = 0;
    redis.execute(jedis -> {
      count = jedis.zcard("codehole");  // æ­¤å¤„åº”è¯¥æŠ¥é”™
    });
    System.out.println(count);
  }

}
```
ç¼–è¯‘å™¨æš´éœ²å‡ºæ¥çš„é”™è¯¯æ—¶ï¼š`Local variable count defined in an enclosing scope must be final or effectively final`ï¼Œå‘Šè¯‰æˆ‘ä»¬ count å˜é‡å¿…é¡»è®¾ç½®æˆ final ç±»å‹æ‰å¯ä»¥è®©é—­åŒ…æ¥è®¿é—®ã€‚

å¦‚æœè¿™æ—¶æˆ‘ä»¬å°† count è®¾ç½®æˆ final ç±»å‹ï¼Œç»“æœç¼–è¾‘å™¨åˆæŠ¥é”™äº†ï¼š`The final local variable count cannot be assigned. It must be blank and not using a compound assignment`ï¼Œå‘Šè¯‰æˆ‘ä»¬ final ç±»å‹çš„å˜é‡åœ¨é—­åŒ…é‡Œé¢ä¸èƒ½è¢«ä¿®æ”¹ã€‚

é‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

è¿™é‡Œéœ€è¦å®šä¹‰ä¸€ä¸ª Holder ç±»å‹ï¼Œå°†éœ€è¦ä¿®æ”¹çš„å˜é‡åŒ…è£…èµ·æ¥ã€‚
```java
class Holder<T> {
  private T value;

  public Holder() {
  }

  public Holder(T value) {
    this.value = value;
  }

  public void value(T value) {
    this.value = value;
  }

  public T value() {
    return value;
  }
}

public class JedisTest {

  public static void main(String[] args) {
    Redis redis = new Redis();
    Holder<Long> countHolder = new Holder<>();
    redis.execute(jedis -> {
      long count = jedis.zcard("codehole");
      countHolder.value(count);
    });
    System.out.println(countHolder.value());
  }

}
```
æœ‰äº†ä¸Šé¢å®šä¹‰çš„ Holder åŒ…è£…ç±»ï¼Œå°±å¯ä»¥ç»•è¿‡é—­åŒ…å¯¹å˜é‡ä¿®æ”¹çš„é™åˆ¶ã€‚åªä¸è¿‡ä»£ç ä¸Šè¦å¤šä¸€å±‚ç•¥æ˜¾ç¹ççš„å˜é‡åŒ…è£…è¿‡ç¨‹ã€‚è¿™äº›éƒ½æ˜¯å¯¹ç¨‹åºå‘˜çš„ç¡¬çº¦æŸï¼Œä»–ä»¬å¿…é¡»è¿™ä¹ˆåšæ‰å¯ä»¥å¾—åˆ°è‡ªå·±æƒ³è¦çš„æ•°æ®ã€‚

## é‡è¯•

æˆ‘ä»¬çŸ¥é“ Jedis é»˜è®¤æ²¡æœ‰æä¾›é‡è¯•æœºåˆ¶ï¼Œæ„å‘³ç€å¦‚æœç½‘ç»œå‡ºç°äº†æŠ–åŠ¨ï¼Œå°±ä¼šå¤§èŒƒå›´æŠ¥é”™ï¼Œæˆ–è€…ä¸€ä¸ªåå°åº”ç”¨å› ä¸ºé“¾æ¥è¿‡äºç©ºé—²è¢«æœåŠ¡ç«¯å¼ºåˆ¶å…³é—­äº†é“¾æ¥ï¼Œå½“é‡æ–°å‘èµ·æ–°è¯·æ±‚æ—¶å°±ç¬¬ä¸€ä¸ªæŒ‡ä»¤ä¼šå‡ºé”™ã€‚è€Œ Redis çš„ Python å®¢æˆ·ç«¯ redis-py æä¾›äº†è¿™ç§é‡è¯•æœºåˆ¶ï¼Œredis-py åœ¨é‡åˆ°é“¾æ¥é”™è¯¯æ—¶ä¼šå°è¯•è¿›è¡Œé‡è¿ï¼Œç„¶åå†é‡å‘æŒ‡ä»¤ã€‚

é‚£å¦‚æœæˆ‘ä»¬å¸Œæœ›åœ¨ Jedis ä¸Šé¢å¢åŠ é‡è¯•æœºåˆ¶ï¼Œè¯¥å¦‚ä½•åšå‘¢ï¼Ÿæœ‰äº†ä¸Šé¢çš„ RedisPool å¯¹è±¡ï¼Œé‡è¯•å°±éå¸¸å®¹æ˜“è¿›è¡Œäº†ã€‚

```java
class Redis {

  private JedisPool pool;

  public Redis() {
    this.pool = new JedisPool();
  }

  public void execute(CallWithJedis caller) {
    Jedis jedis = pool.getResource();
    try {
      caller.call(jedis);
    } catch (JedisConnectionException e) {
      caller.call(jedis);  // é‡è¯•ä¸€æ¬¡
    } finally {
      jedis.close();
    }
  }

}
```
ä¸Šé¢çš„ä»£ç æˆ‘ä»¬åªé‡è¯•äº†ä¸€æ¬¡ï¼Œå¦‚æœ‰éœ€è¦ä¹Ÿå¯ä»¥é‡è¯•å¤šæ¬¡ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½æ— é™é‡è¯•ï¼Œå°±å¥½æ¯”äººé€ä¸å¯å¤ç”Ÿï¼Œè¦èŠ‚å“€é¡ºå˜ã€‚

## ä½œä¸š

å›¿äºç²¾åŠ›ï¼Œä»¥ä¸Šä»£ç å¹¶æ²¡æœ‰åšåˆ°éå¸¸ç»†è‡´ï¼Œæ¯”å¦‚ Redis çš„é“¾æ¥å‚æ•°éƒ½æ²¡æœ‰æåŠï¼Œè¿æ¥æ± çš„å¤§å°ä»¥åŠè¶…æ—¶å‚æ•°ç­‰ä¹Ÿæ²¡æœ‰é…ç½®ï¼Œè¿™äº›ç»†èŠ‚å·¥ä½œå°±ç•™ç»™è¯»è€…ä»¬ä½œä¸ºæœ¬èŠ‚çš„ä½œä¸šï¼Œè‡ªå·±åŠ¨æ‰‹å®Œæˆä¸€ä¸ªå®Œå–„çš„å°è£…å§ã€‚
# æ‹“å±• 8ï¼šå±…å®‰æ€å± â€”â€” ä¿æŠ¤ Redis

æœ¬èŠ‚æˆ‘ä»¬æ¥è°ˆè°ˆä½¿ç”¨ Redis éœ€è¦æ³¨æ„çš„å®‰å…¨é£é™©ä»¥åŠé˜²èŒƒæªæ–½ï¼Œé¿å…æ•°æ®æ³„éœ²å’Œä¸¢å¤±ï¼Œé¿å…æ‰€åœ¨ä¸»æœºæƒé™è¢«é»‘å®¢çªƒå–ï¼Œä»¥åŠé¿å…äººä¸ºæ“ä½œå¤±è¯¯ã€‚


## æŒ‡ä»¤å®‰å…¨

Redis æœ‰ä¸€äº›éå¸¸å±é™©çš„æŒ‡ä»¤ï¼Œè¿™äº›æŒ‡ä»¤ä¼šå¯¹ Redis çš„ç¨³å®šä»¥åŠæ•°æ®å®‰å…¨é€ æˆéå¸¸ä¸¥é‡çš„å½±å“ã€‚æ¯”å¦‚ `keys` æŒ‡ä»¤ä¼šå¯¼è‡´ Redis å¡é¡¿ï¼Œ`flushdb` å’Œ `flushall` ä¼šè®© Redis çš„æ‰€æœ‰æ•°æ®å…¨éƒ¨æ¸…ç©ºã€‚å¦‚ä½•é¿å…äººä¸ºæ“ä½œå¤±è¯¯å¯¼è‡´è¿™äº›ç¾éš¾æ€§çš„åæœä¹Ÿæ˜¯è¿ç»´äººå‘˜ç‰¹åˆ«éœ€è¦æ³¨æ„çš„é£é™©ç‚¹ä¹‹ä¸€ã€‚

Redis åœ¨é…ç½®æ–‡ä»¶ä¸­æä¾›äº† `rename-command` æŒ‡ä»¤ç”¨äºå°†æŸäº›å±é™©çš„æŒ‡ä»¤ä¿®æ”¹æˆç‰¹åˆ«çš„åç§°ï¼Œç”¨æ¥é¿å…äººä¸ºè¯¯æ“ä½œã€‚æ¯”å¦‚åœ¨é…ç½®æ–‡ä»¶çš„ security å—å¢åŠ ä¸‹é¢çš„å†…å®¹:

```
rename-command keys abckeysabc
```
å¦‚æœè¿˜æƒ³æ‰§è¡Œ keys æ–¹æ³•ï¼Œé‚£å°±ä¸èƒ½ç›´æ¥æ•² `keys` å‘½ä»¤äº†ï¼Œè€Œéœ€è¦é”®å…¥`abckeysabc`ã€‚
å¦‚æœæƒ³å®Œå…¨å°æ€æŸæ¡æŒ‡ä»¤ï¼Œå¯ä»¥å°†æŒ‡ä»¤ `rename` æˆç©ºä¸²ï¼Œå°±æ— æ³•é€šè¿‡ä»»ä½•å­—ç¬¦ä¸²æŒ‡ä»¤æ¥æ‰§è¡Œè¿™æ¡æŒ‡ä»¤äº†ã€‚
```
rename-command flushall ""
```

## ç«¯å£å®‰å…¨

Redis é»˜è®¤ä¼šç›‘å¬ `*:6379`ï¼Œå¦‚æœå½“å‰çš„æœåŠ¡å™¨ä¸»æœºæœ‰å¤–ç½‘åœ°å€ï¼ŒRedis çš„æœåŠ¡å°†ä¼šç›´æ¥æš´éœ²åœ¨å…¬ç½‘ä¸Šï¼Œä»»ä½•ä¸€ä¸ªåˆçº§é»‘å®¢ä½¿ç”¨é€‚å½“çš„å·¥å…·å¯¹ IP åœ°å€è¿›è¡Œç«¯å£æ‰«æå°±å¯ä»¥æ¢æµ‹å‡ºæ¥ã€‚

Redis çš„æœåŠ¡åœ°å€ä¸€æ—¦å¯ä»¥è¢«å¤–ç½‘ç›´æ¥è®¿é—®ï¼Œå†…éƒ¨çš„æ•°æ®å°±å½»åº•ä¸§å¤±äº†å®‰å…¨æ€§ã€‚é«˜çº§ä¸€ç‚¹çš„é»‘å®¢ä»¬å¯ä»¥é€šè¿‡ Redis æ‰§è¡Œ Lua è„šæœ¬æ‹¿åˆ°æœåŠ¡å™¨æƒé™ï¼Œæ¶æ„çš„ç«äº‰å¯¹æ‰‹ä»¬ç”šè‡³ä¼šç›´æ¥æ¸…ç©ºä½ çš„ Redis æ•°æ®åº“ã€‚
```
bind 10.100.20.13
```
æ‰€ä»¥ï¼Œè¿ç»´äººå‘˜åŠ¡å¿…åœ¨ Redis çš„é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šç›‘å¬çš„ IP åœ°å€ï¼Œé¿å…è¿™æ ·çš„æƒ¨å‰§å‘ç”Ÿã€‚æ›´è¿›ä¸€æ­¥ï¼Œè¿˜å¯ä»¥å¢åŠ  Redis çš„å¯†ç è®¿é—®é™åˆ¶ï¼Œå®¢æˆ·ç«¯å¿…é¡»ä½¿ç”¨ `auth` æŒ‡ä»¤ä¼ å…¥æ­£ç¡®çš„å¯†ç æ‰å¯ä»¥è®¿é—® Redisï¼Œè¿™æ ·å³ä½¿åœ°å€æš´éœ²å‡ºå»äº†ï¼Œæ™®é€šé»‘å®¢ä¹Ÿæ— æ³•å¯¹ Redis è¿›è¡Œä»»ä½•æŒ‡ä»¤æ“ä½œã€‚
```
requirepass yoursecurepasswordhereplease
```
å¯†ç æ§åˆ¶ä¹Ÿä¼šå½±å“åˆ°ä»åº“å¤åˆ¶ï¼Œä»åº“å¿…é¡»åœ¨é…ç½®æ–‡ä»¶é‡Œä½¿ç”¨ masterauth æŒ‡ä»¤é…ç½®ç›¸åº”çš„å¯†ç æ‰å¯ä»¥è¿›è¡Œå¤åˆ¶æ“ä½œã€‚
```
masterauth yoursecurepasswordhereplease
```

## Lua è„šæœ¬å®‰å…¨

å¼€å‘è€…å¿…é¡»ç¦æ­¢ Lua è„šæœ¬ç”±ç”¨æˆ·è¾“å…¥çš„å†…å®¹ (UGC) ç”Ÿæˆï¼Œè¿™å¯èƒ½ä¼šè¢«é»‘å®¢åˆ©ç”¨ä»¥æ¤å…¥æ¶æ„çš„æ”»å‡»ä»£ç æ¥å¾—åˆ° Redis çš„ä¸»æœºæƒé™ã€‚

åŒæ—¶ï¼Œæˆ‘ä»¬åº”è¯¥è®© Redis ä»¥æ™®é€šç”¨æˆ·çš„èº«ä»½å¯åŠ¨ï¼Œè¿™æ ·å³ä½¿å­˜åœ¨æ¶æ„ä»£ç é»‘å®¢ä¹Ÿæ— æ³•æ‹¿åˆ° root æƒé™ã€‚

## SSL ä»£ç†

Redis å¹¶ä¸æ”¯æŒ SSL é“¾æ¥ï¼Œæ„å‘³ç€å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´äº¤äº’çš„æ•°æ®ä¸åº”è¯¥ç›´æ¥æš´éœ²åœ¨å…¬ç½‘ä¸Šä¼ è¾“ï¼Œå¦åˆ™ä¼šæœ‰è¢«çªƒå¬çš„é£é™©ã€‚å¦‚æœå¿…é¡»è¦ç”¨åœ¨å…¬ç½‘ä¸Šï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ SSL ä»£ç†ã€‚

SSL ä»£ç†æ¯”è¾ƒå¸¸è§çš„æœ‰ sshï¼Œä¸è¿‡ Redis å®˜æ–¹æ¨èä½¿ç”¨ [spiped](http://www.tarsnap.com/spiped.html) å·¥å…·ï¼Œå¯èƒ½æ˜¯å› ä¸º spiped çš„åŠŸèƒ½ç›¸å¯¹æ¯”è¾ƒå•ä¸€ï¼Œä½¿ç”¨ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ˜“äºç†è§£ã€‚ä¸‹é¢è¿™å¼ å›¾æ˜¯ä½¿ç”¨ spiped å¯¹ ssh é€šé“è¿›è¡ŒäºŒæ¬¡åŠ å¯† (å› ä¸º ssh é€šé“ä¹Ÿå¯èƒ½å­˜åœ¨ bug)ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/24/164cb6b701b80b96?w=711&h=329&f=png&s=54119)

åŒæ · SSL ä»£ç†ä¹Ÿå¯ä»¥ç”¨åœ¨ä¸»ä»å¤åˆ¶ä¸Šï¼Œå¦‚æœ Redis ä¸»ä»å®ä¾‹éœ€è¦è·¨æœºæˆ¿å¤åˆ¶ï¼Œspiped ä¹Ÿå¯ä»¥æ´¾ä¸Šç”¨åœºã€‚

## å°ç»“

æœ¬èŠ‚è®²è§£äº†æœ€åŸºæœ¬çš„ Redis å®‰å…¨é˜²æŠ¤æ€è·¯ï¼Œä¸‹ä¸€èŠ‚æˆ‘ä»¬æ¥è¯¦ç»†è®²è§£ spiped çš„åŸç†å’Œä½¿ç”¨ã€‚

# æ‹“å±• 9ï¼šéš”å¢™æœ‰è€³ â€”â€” Redis å®‰å…¨é€šä¿¡

æƒ³è±¡è¿™æ ·ä¸€ä¸ªåº”ç”¨åœºæ™¯ï¼Œå…¬å¸æœ‰ä¸¤ä¸ªæœºæˆ¿ã€‚å› ä¸ºä¸€ä¸ªç´§æ€¥éœ€æ±‚ï¼Œéœ€è¦è·¨æœºæˆ¿è¯»å– Redis æ•°æ®ã€‚åº”ç”¨éƒ¨ç½²åœ¨ A æœºæˆ¿ï¼Œå­˜å‚¨éƒ¨ç½²åœ¨ B æœºæˆ¿ã€‚å¦‚æœä½¿ç”¨æ™®é€š tcp ç›´æ¥è®¿é—®ï¼Œå› ä¸ºè·¨æœºæˆ¿æ‰€ä»¥ä¼ è¾“æ•°æ®ä¼šæš´éœ²åœ¨å…¬ç½‘ï¼Œè¿™éå¸¸ä¸å®‰å…¨ï¼Œå®¢æˆ·ç«¯æœåŠ¡å™¨äº¤äº’çš„æ•°æ®å­˜åœ¨è¢«çªƒå¬çš„é£é™©ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/24/164cb8fec86c373c?w=813&h=336&f=png&s=34055)

Redis æœ¬èº«å¹¶ä¸æ”¯æŒ SSL å®‰å…¨é“¾æ¥ï¼Œä¸è¿‡æœ‰äº† SSL ä»£ç†è½¯ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥è®©é€šä¿¡æ•°æ®é€æ˜åœ°å¾—åˆ°åŠ å¯†ï¼Œå°±å¥½åƒ Redis ç©¿ä¸Šäº†ä¸€å±‚éšèº«å¤–å¥—ä¸€æ ·ã€‚spiped å°±æ˜¯è¿™æ ·çš„ä¸€æ¬¾ SSL ä»£ç†è½¯ä»¶ï¼Œå®ƒæ˜¯ Redis å®˜æ–¹æ¨èçš„ä»£ç†è½¯ä»¶ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/24/164cbbfbafa6f005?w=783&h=377&f=png&s=41300)

## spiped åŸç†

è®©æˆ‘ä»¬æ”¾å¤§ç»†èŠ‚ï¼Œä»”ç»†è§‚å¯Ÿ spiped å®ç°åŸç†ã€‚spiped ä¼šåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å„å¯åŠ¨ä¸€ä¸ª spiped è¿›ç¨‹ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/24/164cbb6b2ce179eb?w=844&h=319&f=png&s=38059)

å·¦è¾¹çš„ spiped è¿›ç¨‹ A è´Ÿè´£æ¥å—æ¥è‡ª Redis Client å‘é€è¿‡æ¥çš„è¯·æ±‚æ•°æ®ï¼ŒåŠ å¯†åä¼ é€åˆ°å³è¾¹çš„ spiped è¿›ç¨‹ Bã€‚spiped B å°†æ¥æ”¶åˆ°çš„æ•°æ®è§£å¯†åä¼ é€’åˆ° Redis Serverã€‚ç„¶å Redis Server å†èµ°ä¸€ä¸ªåå‘çš„æµç¨‹å°†å“åº”å›å¤ç»™ Redis Clientã€‚

æ¯ä¸€ä¸ª spiped è¿›ç¨‹éƒ½ä¼šæœ‰ä¸€ä¸ªç›‘å¬ç«¯å£ (server socket) ç”¨æ¥æ¥æ”¶æ•°æ®ï¼ŒåŒæ—¶è¿˜ä¼šä½œä¸ºä¸€ä¸ªå®¢æˆ·ç«¯ (socket client) å°†æ•°æ®è½¬å‘åˆ°ç›®æ ‡åœ°å€ã€‚

spiped è¿›ç¨‹éœ€è¦æˆå¯¹å‡ºç°ï¼Œç›¸äº’ä¹‹é—´éœ€è¦ä½¿ç”¨ç›¸åŒçš„å…±äº«å¯†é’¥æ¥åŠ å¯†æ¶ˆæ¯ã€‚

## spiped ä½¿ç”¨å…¥é—¨
å®‰è£… spipedï¼Œæˆ‘ç”¨çš„æ˜¯ Macã€‚
```
> brew install spiped
```
å¦‚æœæ˜¯ Linuxï¼Œå¯ä»¥ä½¿ç”¨ apt-get æˆ–è€… yum å®‰è£…ï¼š
```
> apt-get install spiped
> yum install spiped
```

1. ä½¿ç”¨ Docker å¯åŠ¨ redis-serverï¼Œæ³¨æ„è¦ç»‘å®šæœ¬æœºçš„å›ç¯`127.0.0.1`ï¼›
```
> docker run -d -p127.0.0.1:6379:6379 --name redis-server-6379 redis
12781661ec47faa8a8a967234365192f4da58070b791262afb8d9f64fce61835
> docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED                  STATUS              PORTS                      NAMES
12781661ec47        redis               "docker-entrypoint.sâ€¦"   Less than a second ago   Up 1 second         127.0.0.1:6379->6379/tcp   redis-server-6379
```

2. ç”Ÿæˆéšæœºçš„å¯†é’¥æ–‡ä»¶ï¼›
```
# éšæœºçš„ 32 ä¸ªå­—èŠ‚
> dd if=/dev/urandom bs=32 count=1 of=spiped.key
1+0 records in
1+0 records out
32 bytes transferred in 0.000079 secs (405492 bytes/sec)
> ls -l
rw-r--r--  1 qianwp  staff  32  7 24 18:13 spiped.key
```

3. ä½¿ç”¨å¯†é’¥æ–‡ä»¶å¯åŠ¨æœåŠ¡å™¨ spiped è¿›ç¨‹ï¼Œ`172.16.128.81`æ˜¯æˆ‘æœ¬æœºçš„å…¬ç½‘ IP åœ°å€ï¼›
```
# -d è¡¨ç¤º decrypt(å¯¹è¾“å…¥æ•°æ®è¿›è¡Œè§£å¯†)ï¼Œ-s ä¸ºæºç›‘å¬åœ°å€ï¼Œ-t ä¸ºè½¬å‘ç›®æ ‡åœ°å€
> spiped -d -s '[172.16.128.81]:6479' -t '[127.0.0.1]:6379' -k spiped.key
> ps -ef|grep spiped
501 30673     1   0  7:29 ä¸‹åˆ ??         0:00.04 spiped -d -s [172.16.128.81]:6479 -t [127.0.0.1]:6379 -k spiped.key
```
è¿™ä¸ª spiped è¿›ç¨‹ç›‘å¬å…¬ç½‘ IP çš„ 6479 ç«¯å£æ¥æ”¶å…¬ç½‘ä¸Šçš„æ•°æ®ï¼Œå°†æ•°æ®è§£å¯†åè½¬å‘åˆ°æœ¬æœºå›ç¯åœ°å€çš„ 6379 ç«¯å£ï¼Œä¹Ÿå°±æ˜¯ redis-server ç›‘å¬çš„ç«¯å£ã€‚

4. ä½¿ç”¨å¯†é’¥æ–‡ä»¶å¯åŠ¨å®¢æˆ·ç«¯ spiped è¿›ç¨‹ï¼Œ`172.16.128.81`æ˜¯æˆ‘æœ¬æœºçš„å…¬ç½‘ IP åœ°å€ï¼›
```
# -e è¡¨ç¤º encryptï¼Œå¯¹è¾“å…¥æ•°æ®è¿›è¡ŒåŠ å¯†
> spiped -e -s '[127.0.0.1]:6579' -t '[172.16.128.81]:6479' -k spiped.key
> ps -ef|grep spiped
501 30673     1   0  7:29 ä¸‹åˆ ??         0:00.04 spiped -d -s [172.16.128.81]:6479 -t [127.0.0.1]:6379 -k spiped.key
501 30696     1   0  7:30 ä¸‹åˆ ??         0:00.03 spiped -e -s [127.0.0.1]:6579 -t [172.16.128.81]:6479 -k spiped.key
```
å®¢æˆ·ç«¯ spiped è¿›ç¨‹ç›‘å¬äº†æœ¬åœ°å›ç¯åœ°å€çš„ 6579 ç«¯å£ï¼Œå°†è¯¥ç«¯å£ä¸Šæ”¶åˆ°çš„æ•°æ®åŠ å¯†è½¬å‘åˆ°æœåŠ¡å™¨ spiped è¿›ç¨‹ã€‚

5. å¯åŠ¨å®¢æˆ·ç«¯é“¾æ¥ï¼Œå› ä¸º Docker é‡Œé¢çš„å®¢æˆ·ç«¯ä¸å¥½è®¿é—®å®¿ä¸»æœºçš„å›ç¯åœ°å€ï¼Œæ‰€ä»¥ Redis çš„å®¢æˆ·ç«¯æˆ‘ä»¬ä½¿ç”¨ Python ä»£ç æ¥å¯åŠ¨ï¼›
```py
>> import redis
>> c=redis.StrictRedis(host="localhost", port=6579)
>> c.ping()
>> c.info('cpu')
{'used_cpu_sys': 4.83,
 'used_cpu_sys_children': 0.0,
 'used_cpu_user': 0.93,
 'used_cpu_user_children': 0.0}
```
å¯ä»¥çœ‹å‡ºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å·²ç»é€šäº†ï¼Œå¦‚æœæˆ‘ä»¬å°è¯•ç›´æ¥é“¾æ¥æœåŠ¡å™¨ spiped è¿›ç¨‹ (åŠ å¯†çš„ç«¯å£ 6379)ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚
```
>>> import redis
>>> c=redis.StrictRedis(host="172.16.128.81", port=6479)
>>> c.ping()
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "/Users/qianwp/source/animate/juejin-redis/.py/lib/python2.7/site-packages/redis/client.py", line 777, in ping
    return self.execute_command('PING')
  File "/Users/qianwp/source/animate/juejin-redis/.py/lib/python2.7/site-packages/redis/client.py", line 674, in execute_command
    return self.parse_response(connection, command_name, **options)
  File "/Users/qianwp/source/animate/juejin-redis/.py/lib/python2.7/site-packages/redis/client.py", line 680, in parse_response
    response = connection.read_response()
  File "/Users/qianwp/source/animate/juejin-redis/.py/lib/python2.7/site-packages/redis/connection.py", line 624, in read_response
    response = self._parser.read_response()
  File "/Users/qianwp/source/animate/juejin-redis/.py/lib/python2.7/site-packages/redis/connection.py", line 284, in read_response
    response = self._buffer.readline()
  File "/Users/qianwp/source/animate/juejin-redis/.py/lib/python2.7/site-packages/redis/connection.py", line 216, in readline
    self._read_from_socket()
  File "/Users/qianwp/source/animate/juejin-redis/.py/lib/python2.7/site-packages/redis/connection.py", line 191, in _read_from_socket
    (e.args,))
redis.exceptions.ConnectionError: Error while reading from socket: ('Connection closed by server.',)
```
ä»è¾“å‡ºä¸­å¯ä»¥çœ‹å‡ºæ¥è¯·æ±‚æ˜¯å‘é€è¿‡å»äº†ï¼Œä½†æ˜¯å´å‡ºç°äº†è¯»è¶…æ—¶ï¼Œè¦ä¹ˆæ˜¯æœåŠ¡å™¨åœ¨é»˜è®¤çš„è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰è¿”å›æ•°æ®ï¼Œè¦ä¹ˆæ˜¯æœåŠ¡å™¨æ²¡æœ‰è¿”å›å®¢æˆ·ç«¯æƒ³è¦çš„æ•°æ®ã€‚

spiped å¯ä»¥åŒæ—¶æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯é“¾æ¥çš„æ•°æ®è½¬å‘å·¥ä½œï¼Œå®ƒè¿˜å¯ä»¥é€šè¿‡å‚æ•°æ¥é™å®šå…è®¸çš„æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°ã€‚ä½†æ˜¯å¯¹äºæœåŠ¡å™¨ spipedï¼Œå®ƒä¸èƒ½åŒæ—¶æ”¯æŒå¤šä¸ªæœåŠ¡å™¨ä¹‹é—´çš„è½¬å‘ã€‚æ„å‘³ç€åœ¨é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œéœ€è¦ä¸ºæ¯ä¸€ä¸ª server èŠ‚ç‚¹å¯åŠ¨ä¸€ä¸ª spiped è¿›ç¨‹æ¥ä»£æ”¶æ¶ˆæ¯ï¼Œåœ¨è¿ç»´å®è·µä¸Šè¿™å¯èƒ½ä¼šæ¯”è¾ƒç¹çã€‚

## ä½œä¸š
è¯·è¯»è€…å°† Redis æ›¿æ¢æˆ MySQL æ¥ä½“éªŒä¸€ä¸‹ spiped çš„ç¥å¥‡é­”åŠ›ã€‚
Redis æä¾›äº†éå¸¸ä¸°å¯Œçš„æŒ‡ä»¤é›†ï¼Œä½†æ˜¯ç”¨æˆ·ä¾ç„¶ä¸æ»¡è¶³ï¼Œå¸Œæœ›å¯ä»¥è‡ªå®šä¹‰æ‰©å……è‹¥å¹²æŒ‡ä»¤æ¥å®Œæˆä¸€äº›ç‰¹å®šé¢†åŸŸçš„é—®é¢˜ã€‚Redis ä¸ºè¿™æ ·çš„ç”¨æˆ·åœºæ™¯æä¾›äº† lua è„šæœ¬æ”¯æŒï¼Œç”¨æˆ·å¯ä»¥å‘æœåŠ¡å™¨å‘é€ lua è„šæœ¬æ¥æ‰§è¡Œè‡ªå®šä¹‰åŠ¨ä½œï¼Œè·å–è„šæœ¬çš„å“åº”æ•°æ®ã€‚Redis æœåŠ¡å™¨ä¼šå•çº¿ç¨‹åŸå­æ€§æ‰§è¡Œ lua è„šæœ¬ï¼Œä¿è¯ lua è„šæœ¬åœ¨å¤„ç†çš„è¿‡ç¨‹ä¸­ä¸ä¼šè¢«ä»»æ„å…¶å®ƒè¯·æ±‚æ‰“æ–­ã€‚


![](https://user-gold-cdn.xitu.io/2018/10/23/1669e9fd24688358?w=558&h=192&f=png&s=15922)

æ¯”å¦‚åœ¨åˆ†å¸ƒå¼é”å°èŠ‚ï¼Œæˆ‘ä»¬æåˆ°äº† del_if_equals ä¼ªæŒ‡ä»¤ï¼Œå®ƒå¯ä»¥å°†åŒ¹é… key å’Œåˆ é™¤ key åˆå¹¶åœ¨ä¸€èµ·åŸå­æ€§æ‰§è¡Œï¼ŒRedis åŸç”Ÿæ²¡æœ‰æä¾›è¿™æ ·åŠŸèƒ½çš„æŒ‡ä»¤ï¼Œå®ƒå¯ä»¥ä½¿ç”¨ lua è„šæœ¬æ¥å®Œæˆã€‚
```
if redis.call("get",KEYS[1]) == ARGV[1] then
    return redis.call("del",KEYS[1])
else
    return 0
end
```
é‚£ä¸Šé¢è¿™ä¸ªè„šæœ¬å¦‚ä½•æ‰§è¡Œå‘¢ï¼Ÿä½¿ç”¨ EVAL æŒ‡ä»¤
```
127.0.0.1:6379> set foo bar
OK
127.0.0.1:6379> eval 'if redis.call("get",KEYS[1]) == ARGV[1] then return redis.call("del",KEYS[1]) else return 0 end' 1 foo bar
(integer) 1
127.0.0.1:6379> eval 'if redis.call("get",KEYS[1]) == ARGV[1] then return redis.call("del",KEYS[1]) else return 0 end' 1 foo bar
(integer) 0
```
EVAL æŒ‡ä»¤çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è„šæœ¬å†…å®¹å­—ç¬¦ä¸²ï¼Œä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å°† lua è„šæœ¬å‹ç¼©æˆä¸€è¡Œä»¥å•å¼•å·å›´èµ·æ¥æ˜¯ä¸ºäº†æ–¹ä¾¿å‘½ä»¤è¡Œæ‰§è¡Œã€‚ç„¶åæ˜¯ key çš„æ•°é‡ä»¥åŠæ¯ä¸ª key ä¸²ï¼Œæœ€åæ˜¯ä¸€ç³»åˆ—é™„åŠ å‚æ•°å­—ç¬¦ä¸²ã€‚é™„åŠ å‚æ•°çš„æ•°é‡ä¸éœ€è¦å’Œ key ä¿æŒä¸€è‡´ï¼Œå¯ä»¥å®Œå…¨æ²¡æœ‰é™„åŠ å‚æ•°ã€‚
```
EVAL SCRIPT KEY_NUM KEY1 KEY2 ... KEYN ARG1 ARG2 ....
```
ä¸Šé¢çš„ä¾‹å­ä¸­åªæœ‰ 1 ä¸ª keyï¼Œå®ƒå°±æ˜¯ fooï¼Œç´§æ¥ç€ bar æ˜¯å”¯ä¸€çš„é™„åŠ å‚æ•°ã€‚åœ¨ lua è„šæœ¬ä¸­ï¼Œæ•°ç»„ä¸‹æ ‡æ˜¯ä» 1 å¼€å§‹ï¼Œæ‰€ä»¥é€šè¿‡ KEYS[1] å°±å¯ä»¥å¾—åˆ° ç¬¬ä¸€ä¸ª keyï¼Œé€šè¿‡ ARGV[1] å°±å¯ä»¥å¾—åˆ°ç¬¬ä¸€ä¸ªé™„åŠ å‚æ•°ã€‚redis.call  å‡½æ•°å¯ä»¥è®©æˆ‘ä»¬è°ƒç”¨ Redis çš„åŸç”ŸæŒ‡ä»¤ï¼Œä¸Šé¢çš„ä»£ç åˆ†åˆ«è°ƒç”¨äº† get æŒ‡ä»¤å’Œ del æŒ‡ä»¤ã€‚return è¿”å›çš„ç»“æœå°†ä¼šè¿”å›ç»™å®¢æˆ·ç«¯ã€‚

### SCRIPT LOAD å’Œ EVALSHA æŒ‡ä»¤
åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œè„šæœ¬çš„å†…å®¹å¾ˆçŸ­ã€‚å¦‚æœè„šæœ¬çš„å†…å®¹å¾ˆé•¿ï¼Œè€Œä¸”å®¢æˆ·ç«¯éœ€è¦é¢‘ç¹æ‰§è¡Œï¼Œé‚£ä¹ˆæ¯æ¬¡éƒ½éœ€è¦ä¼ é€’å†—é•¿çš„è„šæœ¬å†…å®¹åŠ¿å¿…æ¯”è¾ƒæµªè´¹ç½‘ç»œæµé‡ã€‚æ‰€ä»¥ Redis è¿˜æä¾›äº† SCRIPT LOAD å’Œ EVALSHA æŒ‡ä»¤æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

![](https://user-gold-cdn.xitu.io/2018/10/23/1669ea023d4b887d?w=581&h=239&f=png&s=25126)
SCRIPT LOAD æŒ‡ä»¤ç”¨äºå°†å®¢æˆ·ç«¯æä¾›çš„ lua è„šæœ¬ä¼ é€’åˆ°æœåŠ¡å™¨è€Œä¸æ‰§è¡Œï¼Œä½†æ˜¯ä¼šå¾—åˆ°è„šæœ¬çš„å”¯ä¸€ IDï¼Œè¿™ä¸ªå”¯ä¸€ ID æ˜¯ç”¨æ¥å”¯ä¸€æ ‡è¯†æœåŠ¡å™¨ç¼“å­˜çš„è¿™æ®µ lua è„šæœ¬ï¼Œå®ƒæ˜¯ç”± Redis ä½¿ç”¨ sha1 ç®—æ³•æ‰æè„šæœ¬å†…å®¹è€Œå¾—åˆ°çš„ä¸€ä¸ªå¾ˆé•¿çš„å­—ç¬¦ä¸²ã€‚æœ‰äº†è¿™ä¸ªå”¯ä¸€ IDï¼Œåé¢å®¢æˆ·ç«¯å°±å¯ä»¥é€šè¿‡ EVALSHA æŒ‡ä»¤åå¤æ‰§è¡Œè¿™ä¸ªè„šæœ¬äº†ã€‚
æˆ‘ä»¬çŸ¥é“ Redis æœ‰ incrby æŒ‡ä»¤å¯ä»¥å®Œæˆæ•´æ•°çš„è‡ªå¢æ“ä½œï¼Œä½†æ˜¯æ²¡æœ‰æä¾›è‡ªä¹˜è¿™æ ·çš„æŒ‡ä»¤ã€‚
```
incrby key value  ==> $key = $key + value
mulby key value ==> $key = $key * value
```
ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ SCRIPT LOAD å’Œ EVALSHA æŒ‡ä»¤æ¥å®Œæˆè‡ªä¹˜è¿ç®—ã€‚
```
local curVal = redis.call("get", KEYS[1])
if curVal == false then
  curVal = 0
else
  curVal = tonumber(curVal)
end
curVal = curVal * tonumber(ARGV[1])
redis.call("set", KEYS[1], curVal)
return curVal
```
å…ˆå°†ä¸Šé¢çš„è„šæœ¬å•è¡ŒåŒ–ï¼Œè¯­å¥ä¹‹é—´ä½¿ç”¨åˆ†å·éš”å¼€
```
local curVal = redis.call("get", KEYS[1]); if curVal == false then curVal = 0 else curVal = tonumber(curVal) end; curVal = curVal * tonumber(ARGV[1]); redis.call("set", KEYS[1], curVal); return curVal
```
åŠ è½½è„šæœ¬
```
127.0.0.1:6379> script load 'local curVal = redis.call("get", KEYS[1]); if curVal == false then curVal = 0 else curVal = tonumber(curVal) end; curVal = curVal * tonumber(ARGV[1]); redis.call("set", KEYS[1], curVal); return curVal'
"be4f93d8a5379e5e5b768a74e77c8a4eb0434441"
```
å‘½ä»¤è¡Œè¾“å‡ºäº†å¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼Œå®ƒå°±æ˜¯è„šæœ¬çš„å”¯ä¸€æ ‡è¯†ï¼Œä¸‹é¢æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªå”¯ä¸€æ ‡è¯†æ¥æ‰§è¡ŒæŒ‡ä»¤
```
127.0.0.1:6379> evalsha be4f93d8a5379e5e5b768a74e77c8a4eb0434441 1 notexistskey 5
(integer) 0
127.0.0.1:6379> evalsha be4f93d8a5379e5e5b768a74e77c8a4eb0434441 1 notexistskey 5
(integer) 0
127.0.0.1:6379> set foo 1
OK
127.0.0.1:6379> evalsha be4f93d8a5379e5e5b768a74e77c8a4eb0434441 1 foo 5
(integer) 5
127.0.0.1:6379> evalsha be4f93d8a5379e5e5b768a74e77c8a4eb0434441 1 foo 5
(integer) 25
```

### é”™è¯¯å¤„ç†
ä¸Šé¢çš„è„šæœ¬å‚æ•°è¦æ±‚ä¼ å…¥çš„é™„åŠ å‚æ•°å¿…é¡»æ˜¯æ•´æ•°ï¼Œå¦‚æœæ²¡æœ‰ä¼ é€’æ•´æ•°ä¼šæ€æ ·å‘¢ï¼Ÿ
```
127.0.0.1:6379> evalsha be4f93d8a5379e5e5b768a74e77c8a4eb0434441 1 foo bar
(error) ERR Error running script (call to f_be4f93d8a5379e5e5b768a74e77c8a4eb0434441): @user_script:1: user_script:1: attempt to perform arithmetic on a nil value
```
å¯ä»¥çœ‹åˆ°å®¢æˆ·ç«¯è¾“å‡ºäº†æœåŠ¡å™¨è¿”å›çš„é€šç”¨é”™è¯¯æ¶ˆæ¯ï¼Œæ³¨æ„è¿™æ˜¯ä¸€ä¸ªåŠ¨æ€æŠ›å‡ºçš„å¼‚å¸¸ï¼ŒRedis ä¼šä¿æŠ¤ä¸»çº¿ç¨‹ä¸ä¼šå› ä¸ºè„šæœ¬çš„é”™è¯¯è€Œå¯¼è‡´æœåŠ¡å™¨å´©æºƒï¼Œè¿‘ä¼¼äºåœ¨è„šæœ¬çš„å¤–å›´æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ try catch è¯­å¥åŒ…è£¹ã€‚åœ¨ lua è„šæœ¬æ‰§è¡Œçš„è¿‡ç¨‹ä¸­é‡åˆ°äº†é”™è¯¯ï¼ŒåŒ redis çš„äº‹åŠ¡ä¸€æ ·ï¼Œé‚£äº›é€šè¿‡  redis.call  å‡½æ•°å·²ç»æ‰§è¡Œè¿‡çš„æŒ‡ä»¤å¯¹æœåŠ¡å™¨çŠ¶æ€äº§ç”Ÿå½±å“æ˜¯æ— æ³•æ’¤é”€çš„ï¼Œåœ¨ç¼–å†™ lua ä»£ç æ—¶ä¸€å®šè¦å°å¿ƒï¼Œé¿å…æ²¡æœ‰è€ƒè™‘åˆ°çš„åˆ¤æ–­æ¡ä»¶å¯¼è‡´è„šæœ¬æ²¡æœ‰å®Œå…¨æ‰§è¡Œã€‚

![](https://user-gold-cdn.xitu.io/2018/10/23/1669ea063212e897?w=388&h=196&f=png&s=15462)
å¦‚æœè¯»è€…å¯¹ lua è¯­è¨€æœ‰æ‰€äº†è§£å°±çŸ¥é“ lua åŸç”Ÿæ²¡æœ‰æä¾› try catch è¯­å¥ï¼Œé‚£ä¸Šé¢æåˆ°çš„å¼‚å¸¸åŒ…è£¹è¯­å¥ç©¶ç«Ÿæ˜¯ç”¨ä»€ä¹ˆæ¥å®ç°çš„å‘¢ï¼Ÿlua çš„æ›¿ä»£æ–¹æ¡ˆæ˜¯å†…ç½®äº† pcall(f) å‡½æ•°è°ƒç”¨ã€‚pcall çš„æ„æ€æ˜¯ protected callï¼Œå®ƒä¼šè®© f å‡½æ•°è¿è¡Œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œf å¦‚æœå‡ºç°äº†é”™è¯¯ï¼Œpcall è°ƒç”¨ä¼šè¿”å› false å’Œé”™è¯¯ä¿¡æ¯ã€‚è€Œæ™®é€šçš„ call(f) è°ƒç”¨åœ¨é‡åˆ°é”™è¯¯æ—¶åªä¼šå‘ä¸ŠæŠ›å‡ºå¼‚å¸¸ã€‚åœ¨ Redis çš„æºç ä¸­å¯ä»¥çœ‹åˆ° lua è„šæœ¬çš„æ‰§è¡Œè¢«åŒ…è£¹åœ¨ pcall å‡½æ•°è°ƒç”¨ä¸­ã€‚
```
// ç¼–è¯‘æœŸ
int luaCreateFunction(client *c, lua_State *lua, char *funcname, robj *body) {
  ...
  if (lua_pcall(lua,0,0,0)) {
    addReplyErrorFormat(c,"Error running script (new function): %s\n",
            lua_tostring(lua,-1));
    lua_pop(lua,1);
    return C_ERR;
  }
  ...
}

// è¿è¡ŒæœŸ
void evalGenericCommand(client *c, int evalsha) {
  ...
  err = lua_pcall(lua,0,1,-2);
  ...
}
```
Redis åœ¨ lua è„šæœ¬ä¸­é™¤äº†æä¾›äº† redis.call å‡½æ•°å¤–ï¼ŒåŒæ ·ä¹Ÿæä¾›äº† redis.pcall å‡½æ•°ã€‚å‰è€…é‡åˆ°é”™è¯¯å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸ï¼Œåè€…ä¼šè¿”å›é”™è¯¯ä¿¡æ¯ã€‚ä½¿ç”¨æ—¶ä¸€å®šè¦æ³¨æ„ call å‡½æ•°å‡ºé”™æ—¶ä¼šä¸­æ–­è„šæœ¬çš„æ‰§è¡Œï¼Œä¸ºäº†ä¿è¯è„šæœ¬çš„åŸå­æ€§ï¼Œè¦è°¨æ…ä½¿ç”¨ã€‚

### é”™è¯¯ä¼ é€’
redis.call å‡½æ•°è°ƒç”¨ä¼šäº§ç”Ÿé”™è¯¯ï¼Œè„šæœ¬é‡åˆ°è¿™ç§é”™è¯¯ä¼šè¿”å›æ€æ ·çš„ä¿¡æ¯å‘¢ï¼Ÿæˆ‘ä»¬å†çœ‹ä¸ªä¾‹å­
```
127.0.0.1:6379> hset foo x 1 y 2
(integer) 2
127.0.0.1:6379> eval 'return redis.call("incr", "foo")' 0
(error) ERR Error running script (call to f_8727c9c34a61783916ca488b366c475cb3a446cc): @user_script:1: WRONGTYPE Operation against a key holding the wrong kind of value
```
å®¢æˆ·ç«¯è¾“å‡ºçš„ä¾ç„¶æ˜¯ä¸€ä¸ªé€šç”¨çš„é”™è¯¯æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯ incr è°ƒç”¨æœ¬åº”è¯¥è¿”å›çš„ WRONGTYPE ç±»å‹çš„é”™è¯¯æ¶ˆæ¯ã€‚Redis å†…éƒ¨åœ¨å¤„ç† redis.call é‡åˆ°é”™è¯¯æ—¶æ˜¯å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸ï¼Œå¤–å›´çš„ç”¨æˆ·çœ‹ä¸è§çš„ pcallè°ƒç”¨æ•è·åˆ°è„šæœ¬å¼‚å¸¸æ—¶ä¼šå‘å®¢æˆ·ç«¯å›å¤é€šç”¨çš„é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœæˆ‘ä»¬å°†ä¸Šé¢çš„ call æ”¹æˆ pcallï¼Œç»“æœå°±ä¼šä¸ä¸€æ ·ï¼Œå®ƒå¯ä»¥å°†å†…éƒ¨æŒ‡ä»¤è¿”å›çš„ç‰¹å®šé”™è¯¯å‘ä¸Šä¼ é€’ã€‚
```
127.0.0.1:6379> eval 'return redis.pcall("incr", "foo")' 0
(error) WRONGTYPE Operation against a key holding the wrong kind of value
```

### è„šæœ¬æ­»å¾ªç¯æ€ä¹ˆåŠï¼Ÿ
Redis çš„æŒ‡ä»¤æ‰§è¡Œæ˜¯ä¸ªå•çº¿ç¨‹ï¼Œè¿™ä¸ªå•çº¿ç¨‹è¿˜è¦æ‰§è¡Œæ¥è‡ªå®¢æˆ·ç«¯çš„ lua è„šæœ¬ã€‚å¦‚æœ lua è„šæœ¬ä¸­æ¥ä¸€ä¸ªæ­»å¾ªç¯ï¼Œæ˜¯ä¸æ˜¯ Redis å°±å®Œè›‹äº†ï¼ŸRedis ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒæä¾›äº† script kill æŒ‡ä»¤ç”¨äºåŠ¨æ€æ€æ­»ä¸€ä¸ªæ‰§è¡Œæ—¶é—´è¶…æ—¶çš„ lua è„šæœ¬ã€‚ä¸è¿‡ script kill çš„æ‰§è¡Œæœ‰ä¸€ä¸ªé‡è¦çš„å‰æï¼Œé‚£å°±æ˜¯å½“å‰æ­£åœ¨æ‰§è¡Œçš„è„šæœ¬æ²¡æœ‰å¯¹ Redis çš„å†…éƒ¨æ•°æ®çŠ¶æ€è¿›è¡Œä¿®æ”¹ï¼Œå› ä¸º Redis ä¸å…è®¸ script kill ç ´åè„šæœ¬æ‰§è¡Œçš„åŸå­æ€§ã€‚æ¯”å¦‚è„šæœ¬å†…éƒ¨ä½¿ç”¨äº† redis.call("set", key, value) ä¿®æ”¹äº†å†…éƒ¨çš„æ•°æ®ï¼Œé‚£ä¹ˆ script kill æ‰§è¡Œæ—¶æœåŠ¡å™¨ä¼šè¿”å›é”™è¯¯ã€‚ä¸‹é¢æˆ‘ä»¬æ¥å°è¯•ä»¥ä¸‹ script kill æŒ‡ä»¤ã€‚
```
127.0.0.1:6379> eval 'while(true) do print("hello") end' 0
```
eval æŒ‡ä»¤æ‰§è¡Œåï¼Œå¯ä»¥æ˜æ˜¾çœ‹å‡ºæ¥ redis å¡æ­»äº†ï¼Œæ­»æ´»æ²¡æœ‰ä»»ä½•å“åº”ï¼Œå¦‚æœå»è§‚å¯Ÿ Redis æœåŠ¡å™¨æ—¥å¿—å¯ä»¥çœ‹åˆ°æ—¥å¿—åœ¨ç–¯ç‹‚è¾“å‡º hello å­—ç¬¦ä¸²ã€‚è¿™æ—¶å€™å°±å¿…é¡»é‡æ–°å¼€å¯ä¸€ä¸ª redis-cli æ¥æ‰§è¡Œ script kill æŒ‡ä»¤ã€‚
```
127.0.0.1:6379> script kill
OK
(2.58s)
```
å†å›è¿‡å¤´çœ‹ eval æŒ‡ä»¤çš„è¾“å‡º
```
127.0.0.1:6379> eval 'while(true) do print("hello") end' 0
(error) ERR Error running script (call to f_d395649372f578b1a0d3a1dc1b2389717cadf403): @user_script:1: Script killed by user with SCRIPT KILL...
(6.99s)
```
çœ‹åˆ°è¿™é‡Œç»†å¿ƒçš„åŒå­¦ä¼šæ³¨æ„åˆ°ä¸¤ä¸ªç–‘ç‚¹ï¼Œç¬¬ä¸€ä¸ªæ˜¯ script kill æŒ‡ä»¤ä¸ºä»€ä¹ˆæ‰§è¡Œäº† 2.58 ç§’ï¼Œç¬¬äºŒä¸ªæ˜¯è„šæœ¬éƒ½å¡æ­»äº†ï¼ŒRedis å“ªé‡Œæ¥çš„é—²åŠŸå¤«æ¥å— script kill æŒ‡ä»¤ã€‚å¦‚æœä½ è‡ªå·±å°è¯•äº†åœ¨ç¬¬äºŒä¸ªçª—å£æ‰§è¡Œ redis-cli å»è¿æ¥æœåŠ¡å™¨ï¼Œä½ è¿˜ä¼šå‘ç°ç¬¬ä¸‰ä¸ªç–‘ç‚¹ï¼Œredis-cli å»ºç«‹è¿æ¥æœ‰ç‚¹æ…¢ï¼Œå¤§çº¦é¡¿äº†æœ‰ 1 ç§’å·¦å³ã€‚

### Script Kill çš„åŸç†
ä¸‹é¢æˆ‘å°±è¦å¼€å§‹æ­ç§˜ kill çš„åŸç†äº†ï¼Œlua è„šæœ¬å¼•æ“åŠŸèƒ½å¤ªå¼ºå¤§äº†ï¼Œå®ƒæä¾›äº†å„å¼å„æ ·çš„é’©å­å‡½æ•°ï¼Œå®ƒå…è®¸åœ¨å†…éƒ¨è™šæ‹Ÿæœºæ‰§è¡ŒæŒ‡ä»¤æ—¶è¿è¡Œé’©å­ä»£ç ã€‚æ¯”å¦‚æ¯æ‰§è¡Œ N æ¡æŒ‡ä»¤æ‰§è¡Œä¸€æ¬¡æŸä¸ªé’©å­å‡½æ•°ï¼ŒRedis æ­£æ˜¯ä½¿ç”¨äº†è¿™ä¸ªé’©å­å‡½æ•°ã€‚

![](https://user-gold-cdn.xitu.io/2018/10/23/1669ea098ad61009?w=519&h=355&f=png&s=17167)
```
void evalGenericCommand(client *c, int evalsha) {
  ...
  // luaå¼•æ“æ¯æ‰§è¡Œ10wæ¡æŒ‡ä»¤ï¼Œæ‰§è¡Œä¸€æ¬¡é’©å­å‡½æ•° luaMaskCountHook
  lua_sethook(lua,luaMaskCountHook,LUA_MASKCOUNT,100000);
  ...
}
```
Redis åœ¨é’©å­å‡½æ•°é‡Œä¼šå¿™é‡Œå·é—²å»å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶ä¸”åªæœ‰åœ¨å‘ç° lua è„šæœ¬æ‰§è¡Œè¶…æ—¶ä¹‹åæ‰ä¼šå»å¤„ç†è¯·æ±‚ï¼Œè¿™ä¸ªè¶…æ—¶æ—¶é—´é»˜è®¤æ˜¯ 5 ç§’ã€‚äºæ˜¯ä¸Šé¢æå‡ºçš„ä¸‰ä¸ªç–‘ç‚¹ä¹Ÿå°±çƒŸæ¶ˆäº‘æ•£äº†ã€‚

### æ€è€ƒé¢˜
åœ¨å»¶æ—¶é˜Ÿåˆ—å°èŠ‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ zrangebyscore  å’Œ zdel ä¸¤æ¡æŒ‡ä»¤æ¥äº‰æŠ¢å»¶æ—¶é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œé€šè¿‡ zdel çš„è¿”å›å€¼æ¥å†³å®šæ˜¯å“ªä¸ªå®¢æˆ·ç«¯æŠ¢åˆ°äº†ä»»åŠ¡ï¼Œè¿™æ„å‘³ç€é‚£äº›æ²¡æœ‰æŠ¢åˆ°ä»»åŠ¡çš„å®¢æˆ·ç«¯ä¼šæœ‰è¿™æ ·ä¸€ç§æ„Ÿå— â€”â€” åˆ°äº†å˜´è¾¹çš„è‚‰(ä»»åŠ¡)æœ€åè¿˜è¢«åˆ«äººæŠ¢èµ°äº†ï¼Œä¼šå¾ˆä¸çˆ½ã€‚å¦‚æœå¯ä»¥ä½¿ç”¨ lua è„šæœ¬æ¥å®ç°äº‰æŠ¢é€»è¾‘ï¼Œå°† zrangebyscore å’Œ zdel æŒ‡ä»¤åŸå­æ€§æ‰§è¡Œå°±ä¸ä¼šå­˜åœ¨è¿™ç§é—®é¢˜ï¼Œè¯»è€…å¯ä»¥å°è¯•ä¸€ä¸‹ã€‚

æ³¨ï¼šå¦‚æœè¯»è€…ä¸ç†Ÿæ‚‰ luaï¼Œå»ºè®®å…ˆå­¦ä¹  lua è¯­è¨€ï¼Œlua è¯­è¨€ç®€å•æ˜“å­¦ï¼Œä½†æ˜¯ä¹Ÿä¸æ˜¯å‡ åˆ†é’Ÿå°±å¯ä»¥å­¦ä¼šçš„äº‹ï¼Œéœ€è¦å†æ¥ä¸€æœ¬å°å†Œçš„å†…å®¹ã€‚æœ¬å°å†Œä¸“æ³¨ Redisï¼Œæ‰€ä»¥å°±ä¸å¼€å¤§ç¯‡å†…å®¹æ¥ç»†è®² lua è¯­è¨€äº†ï¼Œæœ‰éœ€è¦çš„æœ‹å‹å¯ä»¥æœç´¢ç›¸å…³åœ¨çº¿æ•™ç¨‹ã€‚
æˆ‘ä»¬å¤©å¤©éƒ½åœ¨ä½¿ç”¨ Redis å†…ç½®çš„å‘½ä»¤è¡Œå·¥å…· redis-cliï¼Œä¹…è€Œä¹…ä¹‹ä»¥ä¸ºå®ƒå°±æ˜¯ä¸€ä¸ªç®€å•çš„äº¤äº’å¼ Redis æ•°æ®ç»“æ„æ‰‹å·¥æ“ä½œç¨‹åºï¼Œä½†æ˜¯å®ƒèƒŒåå¼ºå¤§çš„åŠŸèƒ½ç»å¤§å¤šæ•°åŒå­¦å¯èƒ½é—»æ‰€æœªé—»ã€‚æœ¬èŠ‚æˆ‘ä»¬ä¸€èµ·æ¥æŒ–æ˜è¿™äº›é²œä¸ºäººçŸ¥çš„æœ‰è¶£ç”¨æ³•ã€‚

### æ‰§è¡Œå•æ¡å‘½ä»¤
å¹³æ—¶åœ¨è®¿é—® Redis æœåŠ¡å™¨ï¼Œä¸€èˆ¬éƒ½ä¼šä½¿ç”¨ redis-cli è¿›å…¥äº¤äº’æ¨¡å¼ï¼Œç„¶åä¸€é—®ä¸€ç­”æ¥è¯»å†™æœåŠ¡å™¨ï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å®ƒçš„ã€Œäº¤äº’æ¨¡å¼ã€ã€‚è¿˜æœ‰å¦å¤–ä¸€ç§ã€Œç›´æ¥æ¨¡å¼ã€ï¼Œé€šè¿‡å°†å‘½ä»¤å‚æ•°ç›´æ¥ä¼ é€’ç»™ redis-cli æ¥æ‰§è¡ŒæŒ‡ä»¤å¹¶è·å–è¾“å‡ºç»“æœã€‚
```
$ redis-cli incrby foo 5
(integer) 5
$ redis-cli incrby foo 5
(integer) 10
```
å¦‚æœè¾“å‡ºçš„å†…å®¹è¾ƒå¤§ï¼Œè¿˜å¯ä»¥å°†è¾“å‡ºé‡å®šå‘åˆ°å¤–éƒ¨æ–‡ä»¶
```
$ redis-cli info > info.txt
$ wc -l info.txt
Â  Â  Â 120 info.txt
```
ä¸Šé¢çš„å‘½ä»¤æŒ‡å‘çš„æœåŠ¡å™¨æ˜¯é»˜è®¤æœåŠ¡å™¨åœ°å€ï¼Œå¦‚æœæƒ³æŒ‡å‘ç‰¹å®šçš„æœåŠ¡å™¨å¯ä»¥è¿™æ ·
```
// -n 2 è¡¨ç¤ºä½¿ç”¨ç¬¬2ä¸ªåº“ï¼Œç›¸å½“äº select 2
$ redis-cli -h localhost -p 6379 -n 2 ping
PONG
```

### æ‰¹é‡æ‰§è¡Œå‘½ä»¤
åœ¨å¹³æ—¶çº¿ä¸Šçš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬å…ä¸äº†è¦æ‰‹å·¥é€ æ•°æ®ï¼Œç„¶åå¯¼å…¥ Redisã€‚é€šå¸¸æˆ‘ä»¬ä¼šç¼–å†™è„šæœ¬ç¨‹åºæ¥åšè¿™ä»¶äº‹ã€‚ä¸è¿‡è¿˜æœ‰å¦å¤–ä¸€ç§æ¯”è¾ƒä¾¿æ·çš„æ–¹å¼ï¼Œé‚£å°±æ˜¯ç›´æ¥ä½¿ç”¨ redis-cli æ¥æ‰¹é‡æ‰§è¡Œä¸€ç³»åˆ—æŒ‡ä»¤ã€‚
```
$ cat cmds.txt
set foo1 bar1
set foo2 bar2
set foo3 bar3
......
$ cat cmds.txt | redis-cli
OK
OK
OK
...
```
ä¸Šé¢çš„æŒ‡ä»¤ä½¿ç”¨äº† Unix ç®¡é“å°† cat æŒ‡ä»¤çš„æ ‡å‡†è¾“å‡ºè¿æ¥åˆ° redis-cli çš„æ ‡å‡†è¾“å…¥ã€‚å…¶å®è¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨è¾“å…¥é‡å®šå‘æ¥æ‰¹é‡æ‰§è¡ŒæŒ‡ä»¤ã€‚
```
$ redis-cli < cmds.txt
OK
OK
OK
...
```

### set å¤šè¡Œå­—ç¬¦ä¸²
å¦‚æœä¸€ä¸ªå­—ç¬¦ä¸²æœ‰å¤šè¡Œï¼Œä½ å¸Œæœ›å°†å®ƒä¼ å…¥ set æŒ‡ä»¤ï¼Œredis-cli è¦å¦‚ä½•åšï¼Ÿå¯ä»¥ä½¿ç”¨ -x é€‰é¡¹ï¼Œè¯¥é€‰é¡¹ä¼šä½¿ç”¨æ ‡å‡†è¾“å…¥çš„å†…å®¹ä½œä¸ºæœ€åä¸€ä¸ªå‚æ•°ã€‚
```
$ cat str.txt
Ernest Hemingway once wrote,
"The world is a fine place and worth fighting for."
I agree with the second part.
$ redis-cli -x set foo < str.txt
OK
$ redis-cli get foo
"Ernest Hemingway once wrote,\n\"The world is a fine place and worth fighting for.\"\nI agree with the second part.\n"
```

### é‡å¤æ‰§è¡ŒæŒ‡ä»¤
redis-cli è¿˜æ”¯æŒé‡å¤æ‰§è¡ŒæŒ‡ä»¤å¤šæ¬¡ï¼Œæ¯æ¡æŒ‡ä»¤æ‰§è¡Œä¹‹é—´è®¾ç½®ä¸€ä¸ªé—´éš”æ—¶é—´ï¼Œå¦‚æ­¤ä¾¿å¯ä»¥è§‚å¯ŸæŸæ¡æŒ‡ä»¤çš„è¾“å‡ºå†…å®¹éšæ—¶é—´å˜åŒ–ã€‚
```
// é—´éš”1sï¼Œæ‰§è¡Œ5æ¬¡ï¼Œè§‚å¯Ÿqpsçš„å˜åŒ–
$ redis-cli -r 5 -i 1 info | grep ops
instantaneous_ops_per_sec:43469
instantaneous_ops_per_sec:47460
instantaneous_ops_per_sec:47699
instantaneous_ops_per_sec:46434
instantaneous_ops_per_sec:47216
```
å¦‚æœå°†æ¬¡æ•°è®¾ç½®ä¸º -1 é‚£å°±æ˜¯é‡å¤æ— æ•°æ¬¡æ°¸è¿œæ‰§è¡Œä¸‹å»ã€‚å¦‚æœä¸æä¾› -i å‚æ•°ï¼Œé‚£å°±æ²¡æœ‰é—´éš”ï¼Œè¿ç»­é‡å¤æ‰§è¡Œã€‚åœ¨äº¤äº’æ¨¡å¼ä¸‹ä¹Ÿå¯ä»¥é‡å¤æ‰§è¡ŒæŒ‡ä»¤ï¼Œå½¢å¼ä¸Šæ¯”è¾ƒæ€ªå¼‚ï¼Œåœ¨æŒ‡ä»¤å‰é¢å¢åŠ æ¬¡æ•°
```
127.0.0.1:6379> 5 ping
PONG
PONG
PONG
PONG
PONG
# ä¸‹é¢çš„æŒ‡ä»¤å¾ˆå¯æ€•ï¼Œä½ çš„å±å¹•è¦æ„¤æ€’äº†
127.0.0.1:6379> 10000 info
.......
```

### å¯¼å‡º csv
redis-cli ä¸èƒ½ä¸€æ¬¡å¯¼å‡ºæ•´ä¸ªåº“çš„å†…å®¹ä¸º csvï¼Œä½†æ˜¯å¯ä»¥å¯¼å‡ºå•æ¡æŒ‡ä»¤çš„è¾“å‡ºä¸º csv æ ¼å¼ã€‚
```
$ redis-cli rpush lfoo a b c d e f g
(integer) 7
$ redis-cli --csv lrange lfoo 0 -1
"a","b","c","d","e","f","g"
$ redis-cli hmset hfoo a 1 b 2 c 3 d 4
OK
$ redis-cli --csv hgetall hfoo
"a","1","b","2","c","3","d","4"
```
å½“ç„¶è¿™ç§å¯¼å‡ºåŠŸèƒ½æ¯”è¾ƒå¼±ï¼Œä»…ä»…æ˜¯ä¸€å †å­—ç¬¦ä¸²ç”¨é€—å·åˆ†å‰²å¼€æ¥ã€‚ä¸è¿‡ä½ å¯ä»¥ç»“åˆå‘½ä»¤çš„æ‰¹é‡æ‰§è¡Œæ¥çœ‹çœ‹å¤šä¸ªæŒ‡ä»¤çš„å¯¼å‡ºæ•ˆæœã€‚
```
$ redis-cli --csv -r 5 hgetall hfoo
"a","1","b","2","c","3","d","4"
"a","1","b","2","c","3","d","4"
"a","1","b","2","c","3","d","4"
"a","1","b","2","c","3","d","4"
"a","1","b","2","c","3","d","4"
```
çœ‹åˆ°è¿™é‡Œè¯»è€…åº”è¯¥æ˜ç™½ --csv å‚æ•°çš„æ•ˆæœå°±æ˜¯å¯¹è¾“å‡ºåšäº†ä¸€æ¬¡è½¬æ¢ï¼Œç”¨é€—å·åˆ†å‰²ï¼Œä»…æ­¤è€Œå·²ã€‚

### æ‰§è¡Œ lua è„šæœ¬
åœ¨ lua è„šæœ¬å°èŠ‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ eval æŒ‡ä»¤æ¥æ‰§è¡Œè„šæœ¬å­—ç¬¦ä¸²ï¼Œæ¯æ¬¡éƒ½æ˜¯å°†è„šæœ¬å†…å®¹å‹ç¼©æˆå•è¡Œå­—ç¬¦ä¸²å†è°ƒç”¨ eval æŒ‡ä»¤ï¼Œè¿™éå¸¸ç¹çï¼Œè€Œä¸”å¯è¯»æ€§å¾ˆå·®ã€‚redis-cli è€ƒè™‘åˆ°äº†è¿™ç‚¹ï¼Œå®ƒå¯ä»¥ç›´æ¥æ‰§è¡Œè„šæœ¬æ–‡ä»¶ã€‚
```
127.0.0.1:6379> eval "return redis.pcall('mset', KEYS[1], ARGV[1], KEYS[2], ARGV[2])" 2 foo1 foo2 bar1 bar2
OK
127.0.0.1:6379> eval "return redis.pcall('mget', KEYS[1], KEYS[2])" 2 foo1 foo2
1) "bar1"
2) "bar2"
```
ä¸‹é¢æˆ‘ä»¬ä»¥è„šæœ¬çš„å½¢å¼æ¥æ‰§è¡Œä¸Šé¢çš„æŒ‡ä»¤ï¼Œå‚æ•°å½¢å¼æœ‰æ‰€ä¸åŒï¼ŒKEY å’Œ ARGV ä¹‹é—´éœ€è¦ä½¿ç”¨é€—å·åˆ†å‰²ï¼Œå¹¶ä¸”ä¸éœ€è¦æä¾› KEY çš„æ•°é‡å‚æ•°
```
$ cat mset.txt
return redis.pcall('mset', KEYS[1], ARGV[1], KEYS[2], ARGV[2])
$ cat mget.txt
return redis.pcall('mget', KEYS[1], KEYS[2])
$ redis-cli --eval mset.txt foo1 foo2 , bar1 bar2
OK
$ redis-cli --eval mget.txt foo1 foo2
1) "bar1"
2) "bar2"
```
å¦‚æœä½ çš„ lua è„šæœ¬å¤ªé•¿ï¼Œ--eval å°†å¤§æœ‰ç”¨å¤„ã€‚

### ç›‘æ§æœåŠ¡å™¨çŠ¶æ€
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ --stat å‚æ•°æ¥å®æ—¶ç›‘æ§æœåŠ¡å™¨çš„çŠ¶æ€ï¼Œé—´éš” 1s å®æ—¶è¾“å‡ºä¸€æ¬¡ã€‚
```
$ redis-cli --stat
------- data ------ --------------------- load -------------------- - child -
keysÂ  Â  Â  Â memÂ  Â  Â  clients blocked requestsÂ  Â  Â  Â  Â  Â  connections
2Â  Â  Â  Â  Â  6.66MÂ  Â  100Â  Â  Â 0Â  Â  Â  Â 11591628 (+0)Â  Â  Â  Â 335
2Â  Â  Â  Â  Â  6.66MÂ  Â  100Â  Â  Â 0Â  Â  Â  Â 11653169 (+61541)Â  Â 335
2Â  Â  Â  Â  Â  6.66MÂ  Â  100Â  Â  Â 0Â  Â  Â  Â 11706550 (+53381)Â  Â 335
2Â  Â  Â  Â  Â  6.54MÂ  Â  100Â  Â  Â 0Â  Â  Â  Â 11758831 (+52281)Â  Â 335
2Â  Â  Â  Â  Â  6.66MÂ  Â  100Â  Â  Â 0Â  Â  Â  Â 11803132 (+44301)Â  Â 335
2Â  Â  Â  Â  Â  6.66MÂ  Â  100Â  Â  Â 0Â  Â  Â  Â 11854183 (+51051)Â  Â 335
```
å¦‚æœä½ è§‰å¾—é—´éš”å¤ªé•¿æˆ–æ˜¯å¤ªçŸ­ï¼Œå¯ä»¥ä½¿ç”¨ -i å‚æ•°è°ƒæ•´è¾“å‡ºé—´éš”ã€‚

### æ‰«æå¤§ KEY
è¿™ä¸ªåŠŸèƒ½å¤ªå®ç”¨äº†ï¼Œæˆ‘å·²ç»åœ¨çº¿ä¸Šè¯•è¿‡æ— æ•°æ¬¡äº†ã€‚æ¯æ¬¡é‡åˆ° Redis å¶ç„¶å¡é¡¿é—®é¢˜ï¼Œç¬¬ä¸€ä¸ªæƒ³åˆ°çš„å°±æ˜¯å®ä¾‹ä¸­æ˜¯å¦å­˜åœ¨å¤§ KEYï¼Œå¤§ KEYçš„å†…å­˜æ‰©å®¹ä»¥åŠé‡Šæ”¾éƒ½ä¼šå¯¼è‡´ä¸»çº¿ç¨‹å¡é¡¿ã€‚å¦‚æœçŸ¥é“é‡Œé¢æœ‰æ²¡æœ‰å¤§ KEYï¼Œå¯ä»¥è‡ªå·±å†™ç¨‹åºæ‰«æï¼Œä¸è¿‡è¿™å¤ªç¹çäº†ã€‚redis-cli æä¾›äº† --bigkeys å‚æ•°å¯ä»¥å¾ˆå¿«æ‰«å‡ºå†…å­˜é‡Œçš„å¤§ KEYï¼Œä½¿ç”¨ -i å‚æ•°æ§åˆ¶æ‰«æé—´éš”ï¼Œé¿å…æ‰«ææŒ‡ä»¤å¯¼è‡´æœåŠ¡å™¨çš„ ops é™¡å¢æŠ¥è­¦ã€‚
```
$ ./redis-cli --bigkeys -i 0.01
# Scanning the entire keyspace to find biggest keys as well as
# average sizes per key type.Â  You can use -i 0.1 to sleep 0.1 sec
# per 100 SCAN commands (not usually needed).

[00.00%] Biggest zsetÂ  Â found so far 'hist:aht:main:async_finish:20180425:17' with 1440 members
[00.00%] Biggest zsetÂ  Â found so far 'hist:qps:async:authorize:20170311:27' with 2465 members
[00.00%] Biggest hashÂ  Â found so far 'job:counters:6ya9ypu6ckcl' with 3 fields
[00.01%] Biggest string found so far 'rt:aht:main:device_online:68:{-4}' with 4 bytes
[00.01%] Biggest zsetÂ  Â found so far 'machine:load:20180709' with 2879 members
[00.02%] Biggest string found so far '6y6fze8kj7cy:{-7}' with 90 bytes

```
redis-cli å¯¹äºæ¯ä¸€ç§å¯¹è±¡ç±»å‹éƒ½ä¼šè®°å½•é•¿åº¦æœ€å¤§çš„ KEYï¼Œå¯¹äºæ¯ä¸€ç§å¯¹è±¡ç±»å‹ï¼Œåˆ·æ–°ä¸€æ¬¡æœ€é«˜è®°å½•å°±ä¼šç«‹å³è¾“å‡ºä¸€æ¬¡ã€‚å®ƒèƒ½ä¿è¯è¾“å‡ºé•¿åº¦ä¸º Top1 çš„ KEYï¼Œä½†æ˜¯ Top2ã€Top3ç­‰ KEY æ˜¯æ— æ³•ä¿è¯å¯ä»¥æ‰«æå‡ºæ¥çš„ã€‚ä¸€èˆ¬çš„å¤„ç†æ–¹æ³•æ˜¯å¤šæ‰«æå‡ æ¬¡ï¼Œæˆ–è€…æ˜¯æ¶ˆç­äº† Top1 çš„ KEY ä¹‹åå†æ‰«æç¡®è®¤è¿˜æœ‰æ²¡æœ‰æ¬¡å¤§çš„ KEYã€‚

### é‡‡æ ·æœåŠ¡å™¨æŒ‡ä»¤
ç°åœ¨çº¿ä¸Šæœ‰ä¸€å° Redis æœåŠ¡å™¨çš„ OPS å¤ªé«˜ï¼Œæœ‰å¾ˆå¤šä¸šåŠ¡æ¨¡å—éƒ½åœ¨ä½¿ç”¨è¿™ä¸ª Redisï¼Œå¦‚ä½•æ‰èƒ½åˆ¤æ–­å‡ºæ¥æ˜¯å“ªä¸ªä¸šåŠ¡å¯¼è‡´äº† OPS å¼‚å¸¸çš„é«˜ã€‚è¿™æ—¶å¯ä»¥å¯¹çº¿ä¸ŠæœåŠ¡å™¨çš„æŒ‡ä»¤è¿›è¡Œé‡‡æ ·ï¼Œè§‚å¯Ÿé‡‡æ ·çš„æŒ‡ä»¤å¤§è‡´å°±å¯ä»¥åˆ†æå‡º OPS å æ¯”é«˜çš„ä¸šåŠ¡ç‚¹ã€‚è¿™æ—¶å°±è¦ä½¿ç”¨ monitor æŒ‡ä»¤ï¼Œå®ƒä¼šå°†æœåŠ¡å™¨ç¬é—´æ‰§è¡Œçš„æŒ‡ä»¤å…¨éƒ¨æ˜¾ç¤ºå‡ºæ¥ã€‚ä¸è¿‡ä½¿ç”¨çš„æ—¶å€™è¦æ³¨æ„å³ä½¿ä½¿ç”¨ ctrl+c ä¸­æ–­ï¼Œå¦åˆ™ä½ çš„æ˜¾ç¤ºå™¨ä¼šå™¼é‡Œå•ªå•¦å¤ªå¤šçš„æŒ‡ä»¤ç¬é—´è®©ä½ çœ¼èŠ±ç¼­ä¹±ã€‚
```
$ redis-cli --host 192.168.x.x --port 6379 monitor
1539853410.458483 [0 10.100.90.62:34365] "GET" "6yax3eb6etq8:{-7}"
1539853410.459212 [0 10.100.90.61:56659] "PFADD" "growth:dau:20181018" "2klxkimass8w"
1539853410.462938 [0 10.100.90.62:20681] "GET" "6yax3eb6etq8:{-7}"
1539853410.467231 [0 10.100.90.61:40277] "PFADD" "growth:dau:20181018" "2kei0to86ps1"
1539853410.470319 [0 10.100.90.62:34365] "GET" "6yax3eb6etq8:{-7}"
1539853410.473927 [0 10.100.90.61:58128] "GET" "6yax3eb6etq8:{-7}"
1539853410.475712 [0 10.100.90.61:40277] "PFADD" "growth:dau:20181018" "2km8sqhlefpc"
1539853410.477053 [0 10.100.90.62:61292] "GET" "6yax3eb6etq8:{-7}"
```

### è¯Šæ–­æœåŠ¡å™¨æ—¶å»¶
å¹³æ—¶æˆ‘ä»¬è¯Šæ–­ä¸¤å°æœºå™¨çš„æ—¶å»¶ä¸€èˆ¬æ˜¯ä½¿ç”¨ Unix çš„ ping æŒ‡ä»¤ã€‚Redis ä¹Ÿæä¾›äº†æ—¶å»¶è¯Šæ–­æŒ‡ä»¤ï¼Œä¸è¿‡å®ƒçš„åŸç†ä¸å¤ªä¸€æ ·ï¼Œå®ƒæ˜¯è¯Šæ–­å½“å‰æœºå™¨å’Œ Redis æœåŠ¡å™¨ä¹‹é—´çš„æŒ‡ä»¤(PINGæŒ‡ä»¤)æ—¶å»¶ï¼Œå®ƒä¸ä»…ä»…æ˜¯ç‰©ç†ç½‘ç»œçš„æ—¶å»¶ï¼Œè¿˜å’Œå½“å‰çš„ Redis ä¸»çº¿ç¨‹æ˜¯å¦å¿™ç¢Œæœ‰å…³ã€‚å¦‚æœä½ å‘ç° Unix çš„ ping æŒ‡ä»¤æ—¶å»¶å¾ˆå°ï¼Œè€Œ Redis çš„æ—¶å»¶å¾ˆå¤§ï¼Œé‚£è¯´æ˜ Redis æœåŠ¡å™¨åœ¨æ‰§è¡ŒæŒ‡ä»¤æ—¶æœ‰å¾®å¼±å¡é¡¿ã€‚
```
$ redis-cli --host 192.168.x.x --port 6379 --latency
min: 0, max: 5, avg: 0.08 (305 samples)
```
æ—¶å»¶å•ä½æ˜¯ msã€‚redis-cli è¿˜èƒ½æ˜¾ç¤ºæ—¶å»¶çš„åˆ†å¸ƒæƒ…å†µï¼Œè€Œä¸”æ˜¯å›¾å½¢åŒ–è¾“å‡ºã€‚
```
$ redis-cli --latency-dist
```


![](https://user-gold-cdn.xitu.io/2018/10/24/166a3cac25bdb6fb?w=518&h=193&f=png&s=30452)

è¿™ä¸ªå›¾å½¢çš„å«ä¹‰ä½œè€…æ²¡æœ‰æè¿°ï¼Œè¯»è€…ä»¬å¯ä»¥å°è¯•ç ´è§£ä¸€ä¸‹ã€‚

### è¿œç¨‹ rdb å¤‡ä»½
æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å°±å¯ä»¥å°†è¿œç¨‹çš„ Redis å®ä¾‹å¤‡ä»½åˆ°æœ¬åœ°æœºå™¨ï¼Œè¿œç¨‹æœåŠ¡å™¨ä¼šæ‰§è¡Œä¸€æ¬¡bgsaveæ“ä½œï¼Œç„¶åå°† rdb æ–‡ä»¶ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚è¿œç¨‹ rdb å¤‡ä»½è®©æˆ‘ä»¬æœ‰ä¸€ç§â€œç§€æ‰ä¸å‡ºé—¨ï¼Œå…¨çŸ¥å¤©ä¸‹äº‹â€çš„æ„Ÿè§‰ã€‚
```
$ ./redis-cli --host 192.168.x.x --port 6379 --rdb ./user.rdb
SYNC sent to master, writing 2501265095 bytes to './user.rdb'
Transfer finished with success.
```

### æ¨¡æ‹Ÿä»åº“
å¦‚æœä½ æƒ³è§‚å¯Ÿä¸»ä»æœåŠ¡å™¨ä¹‹é—´éƒ½åŒæ­¥äº†é‚£äº›æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ redis-cli æ¨¡æ‹Ÿä»åº“ã€‚
```
$ ./redis-cli --host 192.168.x.x --port 6379 --slave
SYNC with master, discarding 51778306 bytes of bulk transfer...
SYNC done. Logging commands from master.
...
```
ä»åº“è¿ä¸Šä¸»åº“çš„ç¬¬ä¸€ä»¶äº‹æ˜¯å…¨é‡åŒæ­¥ï¼Œæ‰€ä»¥çœ‹åˆ°ä¸Šé¢çš„æŒ‡ä»¤å¡é¡¿è¿™å¾ˆæ­£å¸¸ï¼Œå¾…é¦–æ¬¡å…¨é‡åŒæ­¥å®Œæˆåï¼Œå°±ä¼šè¾“å‡ºå¢é‡çš„ aof æ—¥å¿—ã€‚
# æºç  1ï¼šä¸åˆ†ç¼•æ â€”â€” æ¢ç´¢ã€Œå­—ç¬¦ä¸²ã€å†…éƒ¨ç»“æ„

Redis ä¸­çš„å­—ç¬¦ä¸²æ˜¯å¯ä»¥ä¿®æ”¹çš„å­—ç¬¦ä¸²ï¼Œåœ¨å†…å­˜ä¸­å®ƒæ˜¯ä»¥å­—èŠ‚æ•°ç»„çš„å½¢å¼å­˜åœ¨çš„ã€‚æˆ‘ä»¬çŸ¥é“ C è¯­è¨€é‡Œé¢çš„å­—ç¬¦ä¸²æ ‡å‡†å½¢å¼æ˜¯ä»¥ NULL ä½œä¸ºç»“æŸç¬¦ï¼Œä½†æ˜¯åœ¨ Redis é‡Œé¢å­—ç¬¦ä¸²ä¸æ˜¯è¿™ä¹ˆè¡¨ç¤ºçš„ã€‚å› ä¸ºè¦è·å– NULL ç»“å°¾çš„å­—ç¬¦ä¸²çš„é•¿åº¦ä½¿ç”¨çš„æ˜¯ `strlen` æ ‡å‡†åº“å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ç®—æ³•å¤æ‚åº¦æ˜¯ O(n)ï¼Œå®ƒéœ€è¦å¯¹å­—èŠ‚æ•°ç»„è¿›è¡Œéå†æ‰«æï¼Œä½œä¸ºå•çº¿ç¨‹çš„ Redis è¡¨ç¤ºæ‰¿å—ä¸èµ·ã€‚

Redis çš„å­—ç¬¦ä¸²å«ç€ã€ŒSDSã€ï¼Œä¹Ÿå°±æ˜¯`Simple Dynamic String`ã€‚å®ƒçš„ç»“æ„æ˜¯ä¸€ä¸ªå¸¦é•¿åº¦ä¿¡æ¯çš„å­—èŠ‚æ•°ç»„ã€‚
```go
struct SDS<T> {
  T capacity; // æ•°ç»„å®¹é‡
  T len; // æ•°ç»„é•¿åº¦
  byte flags; // ç‰¹æ®Šæ ‡è¯†ä½ï¼Œä¸ç†ç¬å®ƒ
  byte[] content; // æ•°ç»„å†…å®¹
}
```

![](https://user-gold-cdn.xitu.io/2018/7/27/164db13445631ab4?w=572&h=169&f=png&s=8854)

å¦‚ä»£ç æ‰€ç¤ºï¼Œ`content` é‡Œé¢å­˜å‚¨äº†çœŸæ­£çš„å­—ç¬¦ä¸²å†…å®¹ï¼Œé‚£ `capacity` å’Œ `len` è¡¨ç¤ºä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå®ƒæœ‰ç‚¹ç±»ä¼¼äº Java è¯­è¨€çš„ ArrayList ç»“æ„ï¼Œéœ€è¦æ¯”å®é™…çš„å†…å®¹é•¿åº¦å¤šåˆ†é…ä¸€äº›å†—ä½™ç©ºé—´ã€‚`capacity` è¡¨ç¤ºæ‰€åˆ†é…æ•°ç»„çš„é•¿åº¦ï¼Œ`len` è¡¨ç¤ºå­—ç¬¦ä¸²çš„å®é™…é•¿åº¦ã€‚å‰é¢æˆ‘ä»¬æåˆ°å­—ç¬¦ä¸²æ˜¯å¯ä»¥ä¿®æ”¹çš„å­—ç¬¦ä¸²ï¼Œå®ƒè¦æ”¯æŒ `append` æ“ä½œã€‚å¦‚æœæ•°ç»„æ²¡æœ‰å†—ä½™ç©ºé—´ï¼Œé‚£ä¹ˆè¿½åŠ æ“ä½œå¿…ç„¶æ¶‰åŠåˆ°åˆ†é…æ–°æ•°ç»„ï¼Œç„¶åå°†æ—§å†…å®¹å¤åˆ¶è¿‡æ¥ï¼Œå† `append` æ–°å†…å®¹ã€‚å¦‚æœå­—ç¬¦ä¸²çš„é•¿åº¦éå¸¸é•¿ï¼Œè¿™æ ·çš„å†…å­˜åˆ†é…å’Œå¤åˆ¶å¼€é”€å°±ä¼šéå¸¸å¤§ã€‚

```c
/* Append the specified binary-safe string pointed by 't' of 'len' bytes to the
 * end of the specified sds string 's'.
 *
 * After the call, the passed sds string is no longer valid and all the
 * references must be substituted with the new pointer returned by the call. */
sds sdscatlen(sds s, const void *t, size_t len) {
    size_t curlen = sdslen(s);  // åŸå­—ç¬¦ä¸²é•¿åº¦

    // æŒ‰éœ€è°ƒæ•´ç©ºé—´ï¼Œå¦‚æœ capacity ä¸å¤Ÿå®¹çº³è¿½åŠ çš„å†…å®¹ï¼Œå°±ä¼šé‡æ–°åˆ†é…å­—èŠ‚æ•°ç»„å¹¶å¤åˆ¶åŸå­—ç¬¦ä¸²çš„å†…å®¹åˆ°æ–°æ•°ç»„ä¸­
    s = sdsMakeRoomFor(s,len);
    if (s == NULL) return NULL; // å†…å­˜ä¸è¶³
    memcpy(s+curlen, t, len);  // è¿½åŠ ç›®æ ‡å­—ç¬¦ä¸²çš„å†…å®¹åˆ°å­—èŠ‚æ•°ç»„ä¸­
    sdssetlen(s, curlen+len); // è®¾ç½®è¿½åŠ åçš„é•¿åº¦å€¼
    s[curlen+len] = '\0'; // è®©å­—ç¬¦ä¸²ä»¥\0 ç»“å°¾ï¼Œä¾¿äºè°ƒè¯•æ‰“å°ï¼Œè¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨ glibc çš„å­—ç¬¦ä¸²å‡½æ•°è¿›è¡Œæ“ä½œ
    return s;
}
```

ä¸Šé¢çš„ SDS ç»“æ„ä½¿ç”¨äº†èŒƒå‹ `T`ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ `int` å‘¢ï¼Œè¿™æ˜¯å› ä¸ºå½“å­—ç¬¦ä¸²æ¯”è¾ƒçŸ­æ—¶ï¼Œ`len` å’Œ `capacity` å¯ä»¥ä½¿ç”¨ `byte` å’Œ `short` æ¥è¡¨ç¤ºï¼ŒRedis ä¸ºäº†å¯¹å†…å­˜åšæè‡´çš„ä¼˜åŒ–ï¼Œä¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²ä½¿ç”¨ä¸åŒçš„ç»“æ„ä½“æ¥è¡¨ç¤ºã€‚

Redis è§„å®šå­—ç¬¦ä¸²çš„é•¿åº¦ä¸å¾—è¶…è¿‡ 512M å­—èŠ‚ã€‚åˆ›å»ºå­—ç¬¦ä¸²æ—¶ `len` å’Œ `capacity` ä¸€æ ·é•¿ï¼Œä¸ä¼šå¤šåˆ†é…å†—ä½™ç©ºé—´ï¼Œè¿™æ˜¯å› ä¸ºç»å¤§å¤šæ•°åœºæ™¯ä¸‹æˆ‘ä»¬ä¸ä¼šä½¿ç”¨ `append` æ“ä½œæ¥ä¿®æ”¹å­—ç¬¦ä¸²ã€‚

## embstr vs raw
Redis çš„å­—ç¬¦ä¸²æœ‰ä¸¤ç§å­˜å‚¨æ–¹å¼ï¼Œåœ¨é•¿åº¦ç‰¹åˆ«çŸ­æ—¶ï¼Œä½¿ç”¨ `emb` å½¢å¼å­˜å‚¨ (embeded)ï¼Œå½“é•¿åº¦è¶…è¿‡ 44 æ—¶ï¼Œä½¿ç”¨ `raw` å½¢å¼å­˜å‚¨ã€‚

è¿™ä¸¤ç§ç±»å‹æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿä¸ºä»€ä¹ˆåˆ†ç•Œçº¿æ˜¯ 44 å‘¢ï¼Ÿ
```
> set codehole abcdefghijklmnopqrstuvwxyz012345678912345678
OK
> debug object codehole
Value at:0x7fec2de00370 refcount:1 encoding:embstr serializedlength:45 lru:5958906 lru_seconds_idle:1
> set codehole abcdefghijklmnopqrstuvwxyz0123456789123456789
OK
> debug object codehole
Value at:0x7fec2dd0b750 refcount:1 encoding:raw serializedlength:46 lru:5958911 lru_seconds_idle:1
```
æ³¨æ„ä¸Šé¢ `debug object` è¾“å‡ºä¸­æœ‰ä¸ª `encoding` å­—æ®µï¼Œä¸€ä¸ªå­—ç¬¦çš„å·®åˆ«ï¼Œå­˜å‚¨å½¢å¼å°±å‘ç”Ÿäº†å˜åŒ–ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

ä¸ºäº†è§£é‡Šè¿™ç§ç°è±¡ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥äº†è§£ä¸€ä¸‹ Redis å¯¹è±¡å¤´ç»“æ„ä½“ï¼Œæ‰€æœ‰çš„ Redis å¯¹è±¡éƒ½æœ‰ä¸‹é¢çš„è¿™ä¸ªç»“æ„å¤´:
```go
struct RedisObject {
    int4 type; // 4bits
    int4 encoding; // 4bits
    int24 lru; // 24bits
    int32 refcount; // 4bytes
    void *ptr; // 8bytesï¼Œ64-bit system
} robj;
```
ä¸åŒçš„å¯¹è±¡å…·æœ‰ä¸åŒçš„ç±»å‹ `type(4bit)`ï¼ŒåŒä¸€ä¸ªç±»å‹çš„ type ä¼šæœ‰ä¸åŒçš„å­˜å‚¨å½¢å¼ `encoding(4bit)`ï¼Œä¸ºäº†è®°å½•å¯¹è±¡çš„ LRU ä¿¡æ¯ï¼Œä½¿ç”¨äº† 24 ä¸ª bit æ¥è®°å½• LRU ä¿¡æ¯ã€‚æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸ªå¼•ç”¨è®¡æ•°ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸ºé›¶æ—¶ï¼Œå¯¹è±¡å°±ä¼šè¢«é”€æ¯ï¼Œå†…å­˜è¢«å›æ”¶ã€‚`ptr` æŒ‡é’ˆå°†æŒ‡å‘å¯¹è±¡å†…å®¹ (body) çš„å…·ä½“å­˜å‚¨ä½ç½®ã€‚è¿™æ ·ä¸€ä¸ª RedisObject å¯¹è±¡å¤´éœ€è¦å æ® 16 å­—èŠ‚çš„å­˜å‚¨ç©ºé—´ã€‚

æ¥ç€æˆ‘ä»¬å†çœ‹ SDS ç»“æ„ä½“çš„å¤§å°ï¼Œåœ¨å­—ç¬¦ä¸²æ¯”è¾ƒå°æ—¶ï¼ŒSDS å¯¹è±¡å¤´çš„å¤§å°æ˜¯`capacity+3`ï¼Œè‡³å°‘æ˜¯ 3ã€‚æ„å‘³ç€åˆ†é…ä¸€ä¸ªå­—ç¬¦ä¸²çš„æœ€å°ç©ºé—´å ç”¨ä¸º 19 å­—èŠ‚ (16+3)ã€‚
```java
struct SDS {
    int8 capacity; // 1byte
    int8 len; // 1byte
    int8 flags; // 1byte
    byte[] content; // å†…è”æ•°ç»„ï¼Œé•¿åº¦ä¸º capacity
}
```

![](https://user-gold-cdn.xitu.io/2018/7/27/164db4dcdac7e7f9?w=538&h=320&f=png&s=18508)

å¦‚å›¾æ‰€ç¤ºï¼Œ`embstr` å­˜å‚¨å½¢å¼æ˜¯è¿™æ ·ä¸€ç§å­˜å‚¨å½¢å¼ï¼Œå®ƒå°† RedisObject å¯¹è±¡å¤´å’Œ SDS å¯¹è±¡è¿ç»­å­˜åœ¨ä¸€èµ·ï¼Œä½¿ç”¨ `malloc` æ–¹æ³•ä¸€æ¬¡åˆ†é…ã€‚è€Œ `raw` å­˜å‚¨å½¢å¼ä¸ä¸€æ ·ï¼Œå®ƒéœ€è¦ä¸¤æ¬¡ `malloc`ï¼Œä¸¤ä¸ªå¯¹è±¡å¤´åœ¨å†…å­˜åœ°å€ä¸Šä¸€èˆ¬æ˜¯ä¸è¿ç»­çš„ã€‚

è€Œå†…å­˜åˆ†é…å™¨ jemalloc/tcmalloc ç­‰åˆ†é…å†…å­˜å¤§å°çš„å•ä½éƒ½æ˜¯ 2ã€4ã€8ã€16ã€32ã€64 ç­‰ç­‰ï¼Œä¸ºäº†èƒ½å®¹çº³ä¸€ä¸ªå®Œæ•´çš„ `embstr` å¯¹è±¡ï¼Œ`jemalloc` æœ€å°‘ä¼šåˆ†é… 32 å­—èŠ‚çš„ç©ºé—´ï¼Œå¦‚æœå­—ç¬¦ä¸²å†ç¨å¾®é•¿ä¸€ç‚¹ï¼Œé‚£å°±æ˜¯ 64 å­—èŠ‚çš„ç©ºé—´ã€‚å¦‚æœæ€»ä½“è¶…å‡ºäº† 64 å­—èŠ‚ï¼ŒRedis è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªå¤§å­—ç¬¦ä¸²ï¼Œä¸å†ä½¿ç”¨ `emdstr` å½¢å¼å­˜å‚¨ï¼Œè€Œè¯¥ç”¨ `raw` å½¢å¼ã€‚

å½“å†…å­˜åˆ†é…å™¨åˆ†é…äº† 64 ç©ºé—´æ—¶ï¼Œé‚£è¿™ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦æœ€å¤§å¯ä»¥æ˜¯å¤šå°‘å‘¢ï¼Ÿè¿™ä¸ªé•¿åº¦å°±æ˜¯ 44ã€‚é‚£ä¸ºä»€ä¹ˆæ˜¯ 44 å‘¢ï¼Ÿ

å‰é¢æˆ‘ä»¬æåˆ° SDS ç»“æ„ä½“ä¸­çš„ `content` ä¸­çš„å­—ç¬¦ä¸²æ˜¯ä»¥å­—èŠ‚`\0`ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œä¹‹æ‰€ä»¥å¤šå‡ºè¿™æ ·ä¸€ä¸ªå­—èŠ‚ï¼Œæ˜¯ä¸ºäº†ä¾¿äºç›´æ¥ä½¿ç”¨ `glibc` çš„å­—ç¬¦ä¸²å¤„ç†å‡½æ•°ï¼Œä»¥åŠä¸ºäº†ä¾¿äºå­—ç¬¦ä¸²çš„è°ƒè¯•æ‰“å°è¾“å‡ºã€‚

![](https://user-gold-cdn.xitu.io/2018/7/27/164db590af5e8551?w=925&h=175&f=png&s=19908)

çœ‹ä¸Šé¢è¿™å¼ å›¾å¯ä»¥ç®—å‡ºï¼Œç•™ç»™ `content` çš„é•¿åº¦æœ€å¤šåªæœ‰ 45(64-19) å­—èŠ‚äº†ã€‚å­—ç¬¦ä¸²åˆæ˜¯ä»¥`\0`ç»“å°¾ï¼Œæ‰€ä»¥ `embstr` æœ€å¤§èƒ½å®¹çº³çš„å­—ç¬¦ä¸²é•¿åº¦å°±æ˜¯ 44ã€‚

## æ‰©å®¹ç­–ç•¥

å­—ç¬¦ä¸²åœ¨é•¿åº¦å°äº 1M ä¹‹å‰ï¼Œæ‰©å®¹ç©ºé—´é‡‡ç”¨åŠ å€ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯ä¿ç•™ 100% çš„å†—ä½™ç©ºé—´ã€‚å½“é•¿åº¦è¶…è¿‡ 1M ä¹‹åï¼Œä¸ºäº†é¿å…åŠ å€åçš„å†—ä½™ç©ºé—´è¿‡å¤§è€Œå¯¼è‡´æµªè´¹ï¼Œæ¯æ¬¡æ‰©å®¹åªä¼šå¤šåˆ†é… 1M å¤§å°çš„å†—ä½™ç©ºé—´ã€‚

## æ€è€ƒ
ä»€ä¹ˆåœºåˆä¸‹ä¼šç”¨åˆ°å­—ç¬¦ä¸²çš„ `append` æ–¹æ³•ï¼Ÿ
# æºç  2ï¼šå¾ªåºæ¸è¿› â€”â€” æ¢ç´¢ã€Œå­—å…¸ã€å†…éƒ¨

dict æ˜¯ Redis æœåŠ¡å™¨ä¸­å‡ºç°æœ€ä¸ºé¢‘ç¹çš„å¤åˆå‹æ•°æ®ç»“æ„ï¼Œé™¤äº† hash ç»“æ„çš„æ•°æ®ä¼šç”¨åˆ°å­—å…¸å¤–ï¼Œæ•´ä¸ª Redis æ•°æ®åº“çš„æ‰€æœ‰ key å’Œ value ä¹Ÿç»„æˆäº†ä¸€ä¸ªå…¨å±€å­—å…¸ï¼Œè¿˜æœ‰å¸¦è¿‡æœŸæ—¶é—´çš„ key é›†åˆä¹Ÿæ˜¯ä¸€ä¸ªå­—å…¸ã€‚zset é›†åˆä¸­å­˜å‚¨ value å’Œ score å€¼çš„æ˜ å°„å…³ç³»ä¹Ÿæ˜¯é€šè¿‡ dict ç»“æ„å®ç°çš„ã€‚
```c
struct RedisDb {
    dict* dict; // all keys  key=>value
    dict* expires; // all expired keys key=>long(timestamp)
    ...
}

struct zset {
    dict *dict; // all values  value=>score
    zskiplist *zsl;
}
```

## dict å†…éƒ¨ç»“æ„

![](https://user-gold-cdn.xitu.io/2018/7/28/164dc873b2a899a8?w=1566&h=430&f=png&s=54972)
dict ç»“æ„å†…éƒ¨åŒ…å«ä¸¤ä¸ª hashtableï¼Œé€šå¸¸æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ª hashtable æ˜¯æœ‰å€¼çš„ã€‚ä½†æ˜¯åœ¨ dict æ‰©å®¹ç¼©å®¹æ—¶ï¼Œéœ€è¦åˆ†é…æ–°çš„ hashtableï¼Œç„¶åè¿›è¡Œæ¸è¿›å¼æ¬è¿ï¼Œè¿™æ—¶å€™ä¸¤ä¸ª hashtable å­˜å‚¨çš„åˆ†åˆ«æ˜¯æ—§çš„ hashtable å’Œæ–°çš„ hashtableã€‚å¾…æ¬è¿ç»“æŸåï¼Œæ—§çš„ hashtable è¢«åˆ é™¤ï¼Œæ–°çš„ hashtable å–è€Œä»£ä¹‹ã€‚

```c
struct dict {
    ...
    dictht ht[2];
}
```


![](https://user-gold-cdn.xitu.io/2018/7/28/164dcaac6cec3483?w=1244&h=644&f=png&s=74678)

æ‰€ä»¥ï¼Œå­—å…¸æ•°æ®ç»“æ„çš„ç²¾åå°±è½åœ¨äº† hashtable ç»“æ„ä¸Šäº†ã€‚hashtable çš„ç»“æ„å’Œ Java çš„ HashMap å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯é€šè¿‡åˆ†æ¡¶çš„æ–¹å¼è§£å†³ hash å†²çªã€‚ç¬¬ä¸€ç»´æ˜¯æ•°ç»„ï¼Œç¬¬äºŒç»´æ˜¯é“¾è¡¨ã€‚æ•°ç»„ä¸­å­˜å‚¨çš„æ˜¯ç¬¬äºŒç»´é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆã€‚
```c
struct dictEntry {
    void* key;
    void* val;
    dictEntry* next; // é“¾æ¥ä¸‹ä¸€ä¸ª entry
}
struct dictht {
    dictEntry** table; // äºŒç»´
    long size; // ç¬¬ä¸€ç»´æ•°ç»„çš„é•¿åº¦
    long used; // hash è¡¨ä¸­çš„å…ƒç´ ä¸ªæ•°
    ...
}
```

## æ¸è¿›å¼rehash
å¤§å­—å…¸çš„æ‰©å®¹æ˜¯æ¯”è¾ƒè€—æ—¶é—´çš„ï¼Œéœ€è¦é‡æ–°ç”³è¯·æ–°çš„æ•°ç»„ï¼Œç„¶åå°†æ—§å­—å…¸æ‰€æœ‰é“¾è¡¨ä¸­çš„å…ƒç´ é‡æ–°æŒ‚æ¥åˆ°æ–°çš„æ•°ç»„ä¸‹é¢ï¼Œè¿™æ˜¯ä¸€ä¸ªO(n)çº§åˆ«çš„æ“ä½œï¼Œä½œä¸ºå•çº¿ç¨‹çš„Redisè¡¨ç¤ºå¾ˆéš¾æ‰¿å—è¿™æ ·è€—æ—¶çš„è¿‡ç¨‹ã€‚æ­¥å­è¿ˆå¤§äº†ä¼šæ‰¯ç€è›‹ï¼Œæ‰€ä»¥Redisä½¿ç”¨æ¸è¿›å¼rehashå°æ­¥æ¬è¿ã€‚è™½ç„¶æ…¢ä¸€ç‚¹ï¼Œä½†æ˜¯è‚¯å®šå¯ä»¥æ¬å®Œã€‚

```c
dictEntry *dictAddRaw(dict *d, void *key, dictEntry **existing)
{
    long index;
    dictEntry *entry;
    dictht *ht;

    // è¿™é‡Œè¿›è¡Œå°æ­¥æ¬è¿
    if (dictIsRehashing(d)) _dictRehashStep(d);

    /* Get the index of the new element, or -1 if
     * the element already exists. */
    if ((index = _dictKeyIndex(d, key, dictHashKey(d,key), existing)) == -1)
        return NULL;

    /* Allocate the memory and store the new entry.
     * Insert the element in top, with the assumption that in a database
     * system it is more likely that recently added entries are accessed
     * more frequently. */
    // å¦‚æœå­—å…¸å¤„äºæ¬è¿è¿‡ç¨‹ä¸­ï¼Œè¦å°†æ–°çš„å…ƒç´ æŒ‚æ¥åˆ°æ–°çš„æ•°ç»„ä¸‹é¢
    ht = dictIsRehashing(d) ? &d->ht[1] : &d->ht[0];
    entry = zmalloc(sizeof(*entry));
    entry->next = ht->table[index];
    ht->table[index] = entry;
    ht->used++;

    /* Set the hash entry fields. */
    dictSetKey(d, entry, key);
    return entry;
}
```

æ¬è¿æ“ä½œåŸ‹ä¼åœ¨å½“å‰å­—å…¸çš„åç»­æŒ‡ä»¤ä¸­(æ¥è‡ªå®¢æˆ·ç«¯çš„hset/hdelæŒ‡ä»¤ç­‰)ï¼Œä½†æ˜¯æœ‰å¯èƒ½å®¢æˆ·ç«¯é—²ä¸‹æ¥äº†ï¼Œæ²¡æœ‰äº†åç»­æŒ‡ä»¤æ¥è§¦å‘è¿™ä¸ªæ¬è¿ï¼Œé‚£ä¹ˆRediså°±ç½®ä¹‹ä¸ç†äº†ä¹ˆï¼Ÿå½“ç„¶ä¸ä¼šï¼Œä¼˜é›…çš„Redisæ€ä¹ˆå¯èƒ½è®¾è®¡çš„è¿™æ ·æ½¦è‰ã€‚Redisè¿˜ä¼šåœ¨å®šæ—¶ä»»åŠ¡ä¸­å¯¹å­—å…¸è¿›è¡Œä¸»åŠ¨æ¬è¿ã€‚

```c
// æœåŠ¡å™¨å®šæ—¶ä»»åŠ¡
void databaseCron() {
    ...
    if (server.activerehashing) {
        for (j = 0; j < dbs_per_call; j++) {
            int work_done = incrementallyRehash(rehash_db);
            if (work_done) {
                /* If the function did some work, stop here, we'll do
                 * more at the next cron loop. */
                break;
            } else {
                /* If this db didn't need rehash, we'll try the next one. */
                rehash_db++;
                rehash_db %= server.dbnum;
            }
        }
    }
}
```

## æŸ¥æ‰¾è¿‡ç¨‹

æ’å…¥å’Œåˆ é™¤æ“ä½œéƒ½ä¾èµ–äºæŸ¥æ‰¾ï¼Œå…ˆå¿…é¡»æŠŠå…ƒç´ æ‰¾åˆ°ï¼Œæ‰å¯ä»¥è¿›è¡Œæ•°æ®ç»“æ„çš„ä¿®æ”¹æ“ä½œã€‚hashtable çš„å…ƒç´ æ˜¯åœ¨ç¬¬äºŒç»´çš„é“¾è¡¨ä¸Šï¼Œæ‰€ä»¥é¦–å…ˆæˆ‘ä»¬å¾—æƒ³åŠæ³•å®šä½å‡ºå…ƒç´ åœ¨å“ªä¸ªé“¾è¡¨ä¸Šã€‚
```js
func get(key) {
    let index = hash_func(key) % size;
    let entry = table[index];
    while(entry != NULL) {
        if entry.key == target {
            return entry.value;
        }
        entry = entry.next;
    }
}
```
å€¼å¾—æ³¨æ„çš„æ˜¯ä»£ç ä¸­çš„`hash_func`ï¼Œå®ƒä¼šå°† key æ˜ å°„ä¸ºä¸€ä¸ªæ•´æ•°ï¼Œä¸åŒçš„ key ä¼šè¢«æ˜ å°„æˆåˆ†å¸ƒæ¯”è¾ƒå‡åŒ€æ•£ä¹±çš„æ•´æ•°ã€‚åªæœ‰ hash å€¼å‡åŒ€äº†ï¼Œæ•´ä¸ª hashtable æ‰æ˜¯å¹³è¡¡çš„ï¼Œæ‰€æœ‰çš„äºŒç»´é“¾è¡¨çš„é•¿åº¦å°±ä¸ä¼šå·®è·å¾ˆè¿œï¼ŒæŸ¥æ‰¾ç®—æ³•çš„æ€§èƒ½ä¹Ÿå°±æ¯”è¾ƒç¨³å®šã€‚

## hash å‡½æ•°

hashtable çš„æ€§èƒ½å¥½ä¸å¥½å®Œå…¨å–å†³äº hash å‡½æ•°çš„è´¨é‡ã€‚hash å‡½æ•°å¦‚æœå¯ä»¥å°† key æ‰“æ•£çš„æ¯”è¾ƒå‡åŒ€ï¼Œé‚£ä¹ˆè¿™ä¸ª hash å‡½æ•°å°±æ˜¯ä¸ªå¥½å‡½æ•°ã€‚Redis çš„å­—å…¸é»˜è®¤çš„ hash å‡½æ•°æ˜¯ siphashã€‚siphash ç®—æ³•å³ä½¿åœ¨è¾“å…¥ key å¾ˆå°çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥äº§ç”Ÿéšæœºæ€§ç‰¹åˆ«å¥½çš„è¾“å‡ºï¼Œè€Œä¸”å®ƒçš„æ€§èƒ½ä¹Ÿéå¸¸çªå‡ºã€‚å¯¹äº Redis è¿™æ ·çš„å•çº¿ç¨‹æ¥è¯´ï¼Œå­—å…¸æ•°æ®ç»“æ„å¦‚æ­¤æ™®éï¼Œå­—å…¸æ“ä½œä¹Ÿä¼šéå¸¸é¢‘ç¹ï¼Œhash å‡½æ•°è‡ªç„¶ä¹Ÿæ˜¯è¶Šå¿«è¶Šå¥½ã€‚

## hash æ”»å‡»

å¦‚æœ hash å‡½æ•°å­˜åœ¨åå‘æ€§ï¼Œé»‘å®¢å°±å¯èƒ½åˆ©ç”¨è¿™ç§åå‘æ€§å¯¹æœåŠ¡å™¨è¿›è¡Œæ”»å‡»ã€‚å­˜åœ¨åå‘æ€§çš„ hash å‡½æ•°åœ¨ç‰¹å®šæ¨¡å¼ä¸‹çš„è¾“å…¥ä¼šå¯¼è‡´ hash ç¬¬äºŒç»´é“¾è¡¨é•¿åº¦æä¸ºä¸å‡åŒ€ï¼Œç”šè‡³æ‰€æœ‰çš„å…ƒç´ éƒ½é›†ä¸­åˆ°ä¸ªåˆ«é“¾è¡¨ä¸­ï¼Œç›´æ¥å¯¼è‡´æŸ¥æ‰¾æ•ˆç‡æ€¥å‰§ä¸‹é™ï¼Œä»`O(1)`é€€åŒ–åˆ°`O(n)`ã€‚æœ‰é™çš„æœåŠ¡å™¨è®¡ç®—èƒ½åŠ›å°†ä¼šè¢« hashtable çš„æŸ¥æ‰¾æ•ˆç‡å½»åº•æ‹–å®ã€‚è¿™å°±æ˜¯æ‰€è°“ hash æ”»å‡»ã€‚

## æ‰©å®¹æ¡ä»¶
```c
/* Expand the hash table if needed */
static int _dictExpandIfNeeded(dict *d)
{
    /* Incremental rehashing already in progress. Return. */
    if (dictIsRehashing(d)) return DICT_OK;

    /* If the hash table is empty expand it to the initial size. */
    if (d->ht[0].size == 0) return dictExpand(d, DICT_HT_INITIAL_SIZE);

    /* If we reached the 1:1 ratio, and we are allowed to resize the hash
     * table (global setting) or we should avoid it but the ratio between
     * elements/buckets is over the "safe" threshold, we resize doubling
     * the number of buckets. */
    if (d->ht[0].used >= d->ht[0].size &&
        (dict_can_resize ||
         d->ht[0].used/d->ht[0].size > dict_force_resize_ratio))
    {
        return dictExpand(d, d->ht[0].used*2);
    }
    return DICT_OK;
}
```
æ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“ hash è¡¨ä¸­å…ƒç´ çš„ä¸ªæ•°ç­‰äºç¬¬ä¸€ç»´æ•°ç»„çš„é•¿åº¦æ—¶ï¼Œå°±ä¼šå¼€å§‹æ‰©å®¹ï¼Œæ‰©å®¹çš„æ–°æ•°ç»„æ˜¯åŸæ•°ç»„å¤§å°çš„ 2 å€ã€‚ä¸è¿‡å¦‚æœ Redis æ­£åœ¨åš bgsaveï¼Œä¸ºäº†å‡å°‘å†…å­˜é¡µçš„è¿‡å¤šåˆ†ç¦» (Copy On Write)ï¼ŒRedis å°½é‡ä¸å»æ‰©å®¹ (`dict_can_resize`)ï¼Œä½†æ˜¯å¦‚æœ hash è¡¨å·²ç»éå¸¸æ»¡äº†ï¼Œå…ƒç´ çš„ä¸ªæ•°å·²ç»è¾¾åˆ°äº†ç¬¬ä¸€ç»´æ•°ç»„é•¿åº¦çš„ 5 å€ (`dict_force_resize_ratio`)ï¼Œè¯´æ˜ hash è¡¨å·²ç»è¿‡äºæ‹¥æŒ¤äº†ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå¼ºåˆ¶æ‰©å®¹ã€‚

## ç¼©å®¹æ¡ä»¶
```c
int htNeedsResize(dict *dict) {
    long long size, used;

    size = dictSlots(dict);
    used = dictSize(dict);
    return (size > DICT_HT_INITIAL_SIZE &&
            (used*100/size < HASHTABLE_MIN_FILL));
}
```
å½“ hash è¡¨å› ä¸ºå…ƒç´ çš„é€æ¸åˆ é™¤å˜å¾—è¶Šæ¥è¶Šç¨€ç–æ—¶ï¼ŒRedis ä¼šå¯¹ hash è¡¨è¿›è¡Œç¼©å®¹æ¥å‡å°‘ hash è¡¨çš„ç¬¬ä¸€ç»´æ•°ç»„ç©ºé—´å ç”¨ã€‚ç¼©å®¹çš„æ¡ä»¶æ˜¯å…ƒç´ ä¸ªæ•°ä½äºæ•°ç»„é•¿åº¦çš„ 10%ã€‚ç¼©å®¹ä¸ä¼šè€ƒè™‘ Redis æ˜¯å¦æ­£åœ¨åš bgsaveã€‚

## set çš„ç»“æ„

Redis é‡Œé¢ set çš„ç»“æ„åº•å±‚å®ç°ä¹Ÿæ˜¯å­—å…¸ï¼Œåªä¸è¿‡æ‰€æœ‰çš„ value éƒ½æ˜¯ NULLï¼Œå…¶å®ƒçš„ç‰¹æ€§å’Œå­—å…¸ä¸€æ¨¡ä¸€æ ·ã€‚

## æ€è€ƒ

1. ä¸ºä»€ä¹ˆç¼©å®¹ä¸ç”¨è€ƒè™‘ bgsaveï¼Ÿ
2. Java è¯­è¨€å’Œ Python è¯­è¨€å†…ç½®çš„ set å®¹å™¨æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ
# æºç  3ï¼šæŒ¨è‚©è¿­èƒŒ â€”â€” æ¢ç´¢ã€Œå‹ç¼©åˆ—è¡¨ã€å†…éƒ¨

Redis ä¸ºäº†èŠ‚çº¦å†…å­˜ç©ºé—´ä½¿ç”¨ï¼Œzset å’Œ hash å®¹å™¨å¯¹è±¡åœ¨å…ƒç´ ä¸ªæ•°è¾ƒå°‘çš„æ—¶å€™ï¼Œé‡‡ç”¨å‹ç¼©åˆ—è¡¨ (ziplist) è¿›è¡Œå­˜å‚¨ã€‚å‹ç¼©åˆ—è¡¨æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œå…ƒç´ ä¹‹é—´ç´§æŒ¨ç€å­˜å‚¨ï¼Œæ²¡æœ‰ä»»ä½•å†—ä½™ç©ºéš™ã€‚
```
> zadd programmings 1.0 go 2.0 python 3.0 java
(integer) 3
> debug object programmings
Value at:0x7fec2de00020 refcount:1 encoding:ziplist serializedlength:36 lru:6022374 lru_seconds_idle:6
> hmset books go fast python slow java fast
OK
> debug object books
Value at:0x7fec2de000c0 refcount:1 encoding:ziplist serializedlength:48 lru:6022478 lru_seconds_idle:1
```
è¿™é‡Œï¼Œæ³¨æ„è§‚å¯Ÿ debug object è¾“å‡ºçš„ encoding å­—æ®µéƒ½æ˜¯ ziplistï¼Œè¿™å°±è¡¨ç¤ºå†…éƒ¨é‡‡ç”¨å‹ç¼©åˆ—è¡¨ç»“æ„è¿›è¡Œå­˜å‚¨ã€‚
```go
struct ziplist<T> {
    int32 zlbytes; // æ•´ä¸ªå‹ç¼©åˆ—è¡¨å ç”¨å­—èŠ‚æ•°
    int32 zltail_offset; // æœ€åä¸€ä¸ªå…ƒç´ è·ç¦»å‹ç¼©åˆ—è¡¨èµ·å§‹ä½ç½®çš„åç§»é‡ï¼Œç”¨äºå¿«é€Ÿå®šä½åˆ°æœ€åä¸€ä¸ªèŠ‚ç‚¹
    int16 zllength; // å…ƒç´ ä¸ªæ•°
    T[] entries; // å…ƒç´ å†…å®¹åˆ—è¡¨ï¼ŒæŒ¨ä¸ªæŒ¨ä¸ªç´§å‡‘å­˜å‚¨
    int8 zlend; // æ ‡å¿—å‹ç¼©åˆ—è¡¨çš„ç»“æŸï¼Œå€¼æ’ä¸º 0xFF
}
```

![](https://user-gold-cdn.xitu.io/2018/7/28/164df01c1c7579e7?w=1512&h=354&f=png&s=50852)

å‹ç¼©åˆ—è¡¨ä¸ºäº†æ”¯æŒåŒå‘éå†ï¼Œæ‰€ä»¥æ‰ä¼šæœ‰ `ztail_offset` è¿™ä¸ªå­—æ®µï¼Œç”¨æ¥å¿«é€Ÿå®šä½åˆ°æœ€åä¸€ä¸ªå…ƒç´ ï¼Œç„¶åå€’ç€éå†ã€‚

entry å—éšç€å®¹çº³çš„å…ƒç´ ç±»å‹ä¸åŒï¼Œä¹Ÿä¼šæœ‰ä¸ä¸€æ ·çš„ç»“æ„ã€‚
```c
struct entry {
    int<var> prevlen; // å‰ä¸€ä¸ª entry çš„å­—èŠ‚é•¿åº¦
    int<var> encoding; // å…ƒç´ ç±»å‹ç¼–ç 
    optional byte[] content; // å…ƒç´ å†…å®¹
}
```
å®ƒçš„ `prevlen` å­—æ®µè¡¨ç¤ºå‰ä¸€ä¸ª entry çš„å­—èŠ‚é•¿åº¦ï¼Œå½“å‹ç¼©åˆ—è¡¨å€’ç€éå†æ—¶ï¼Œéœ€è¦é€šè¿‡è¿™ä¸ªå­—æ®µæ¥å¿«é€Ÿå®šä½åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ çš„ä½ç½®ã€‚å®ƒæ˜¯ä¸€ä¸ªå˜é•¿çš„æ•´æ•°ï¼Œå½“å­—ç¬¦ä¸²é•¿åº¦å°äº 254(0xFE) æ—¶ï¼Œä½¿ç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºï¼›å¦‚æœè¾¾åˆ°æˆ–è¶…å‡º 254(0xFE) é‚£å°±ä½¿ç”¨ 5 ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºã€‚ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯ 0xFE(254)ï¼Œå‰©ä½™å››ä¸ªå­—èŠ‚è¡¨ç¤ºå­—ç¬¦ä¸²é•¿åº¦ã€‚ä½ å¯èƒ½ä¼šè§‰å¾—ç”¨ 5 ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºå­—ç¬¦ä¸²é•¿åº¦ï¼Œæ˜¯ä¸æ˜¯å¤ªæµªè´¹äº†ã€‚æˆ‘ä»¬å¯ä»¥ç®—ä¸€ä¸‹ï¼Œå½“å­—ç¬¦ä¸²é•¿åº¦æ¯”è¾ƒé•¿çš„æ—¶å€™ï¼Œå…¶å® 5 ä¸ªå­—èŠ‚ä¹Ÿåªå ç”¨äº†ä¸åˆ°`(5/(254+5))<2%`çš„ç©ºé—´ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/30/164ea7e76014e30c?w=891&h=182&f=png&s=21807)

`encoding`å­—æ®µå­˜å‚¨äº†å…ƒç´ å†…å®¹çš„ç¼–ç ç±»å‹ä¿¡æ¯ï¼Œziplist é€šè¿‡è¿™ä¸ªå­—æ®µæ¥å†³å®šåé¢çš„ content å†…å®¹çš„å½¢å¼ã€‚

Redis ä¸ºäº†èŠ‚çº¦å­˜å‚¨ç©ºé—´ï¼Œå¯¹ encoding å­—æ®µè¿›è¡Œäº†ç›¸å½“å¤æ‚çš„è®¾è®¡ã€‚Redis é€šè¿‡è¿™ä¸ªå­—æ®µçš„å‰ç¼€ä½æ¥è¯†åˆ«å…·ä½“å­˜å‚¨çš„æ•°æ®å½¢å¼ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ Redis æ˜¯å¦‚ä½•æ ¹æ®`encoding`çš„å‰ç¼€ä½æ¥åŒºåˆ†å†…å®¹çš„ï¼š

1. `00xxxxxx` æœ€å¤§é•¿åº¦ä½ 63 çš„çŸ­å­—ç¬¦ä¸²ï¼Œåé¢çš„ 6 ä¸ªä½å­˜å‚¨å­—ç¬¦ä¸²çš„ä½æ•°ï¼Œå‰©ä½™çš„å­—èŠ‚å°±æ˜¯å­—ç¬¦ä¸²çš„å†…å®¹ã€‚
2. `01xxxxxx xxxxxxxx` ä¸­ç­‰é•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œåé¢ 14 ä¸ªä½æ¥è¡¨ç¤ºå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå‰©ä½™çš„å­—èŠ‚å°±æ˜¯å­—ç¬¦ä¸²çš„å†…å®¹ã€‚
3. `10000000 aaaaaaaa bbbbbbbb cccccccc dddddddd` ç‰¹å¤§å­—ç¬¦ä¸²ï¼Œéœ€è¦ä½¿ç”¨é¢å¤– 4 ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºé•¿åº¦ã€‚ç¬¬ä¸€ä¸ªå­—èŠ‚å‰ç¼€æ˜¯`10`ï¼Œå‰©ä½™ 6 ä½æ²¡æœ‰ä½¿ç”¨ï¼Œç»Ÿä¸€ç½®ä¸ºé›¶ã€‚åé¢è·Ÿç€å­—ç¬¦ä¸²å†…å®¹ã€‚ä¸è¿‡è¿™æ ·çš„å¤§å­—ç¬¦ä¸²æ˜¯æ²¡æœ‰æœºä¼šä½¿ç”¨çš„ï¼Œå‹ç¼©åˆ—è¡¨é€šå¸¸åªæ˜¯ç”¨æ¥å­˜å‚¨å°æ•°æ®çš„ã€‚
4. `11000000` è¡¨ç¤º int16ï¼Œåè·Ÿä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºæ•´æ•°ã€‚
5. `11010000` è¡¨ç¤º int32ï¼Œåè·Ÿå››ä¸ªå­—èŠ‚è¡¨ç¤ºæ•´æ•°ã€‚
6. `11100000` è¡¨ç¤º int64ï¼Œåè·Ÿå…«ä¸ªå­—èŠ‚è¡¨ç¤ºæ•´æ•°ã€‚
7. `11110000` è¡¨ç¤º int24ï¼Œåè·Ÿä¸‰ä¸ªå­—èŠ‚è¡¨ç¤ºæ•´æ•°ã€‚
8. `11111110` è¡¨ç¤º int8ï¼Œåè·Ÿä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºæ•´æ•°ã€‚
9. `11111111` è¡¨ç¤º ziplist çš„ç»“æŸï¼Œä¹Ÿå°±æ˜¯ zlend çš„å€¼ 0xFFã€‚
9. `1111xxxx` è¡¨ç¤ºæå°æ•´æ•°ï¼Œxxxx çš„èŒƒå›´åªèƒ½æ˜¯ (`0001~1101`), ä¹Ÿå°±æ˜¯`1~13`ï¼Œå› ä¸º`0000ã€1110ã€1111`éƒ½è¢«å ç”¨äº†ã€‚è¯»å–åˆ°çš„ value éœ€è¦å°† xxxx å‡ 1ï¼Œä¹Ÿå°±æ˜¯æ•´æ•°`0~12`å°±æ˜¯æœ€ç»ˆçš„ valueã€‚

æ³¨æ„åˆ° `content` å­—æ®µåœ¨ç»“æ„ä½“ä¸­å®šä¹‰ä¸º optional ç±»å‹ï¼Œè¡¨ç¤ºè¿™ä¸ªå­—æ®µæ˜¯å¯é€‰çš„ï¼Œå¯¹äºå¾ˆå°çš„æ•´æ•°è€Œè¨€ï¼Œå®ƒçš„å†…å®¹å·²ç»å†…è”åˆ° encoding å­—æ®µçš„å°¾éƒ¨äº†ã€‚

## å¢åŠ å…ƒç´ 

å› ä¸º ziplist éƒ½æ˜¯ç´§å‡‘å­˜å‚¨ï¼Œæ²¡æœ‰å†—ä½™ç©ºé—´ (å¯¹æ¯”ä¸€ä¸‹ Redis çš„å­—ç¬¦ä¸²ç»“æ„)ã€‚æ„å‘³ç€æ’å…¥ä¸€ä¸ªæ–°çš„å…ƒç´ å°±éœ€è¦è°ƒç”¨ realloc æ‰©å±•å†…å­˜ã€‚å–å†³äºå†…å­˜åˆ†é…å™¨ç®—æ³•å’Œå½“å‰çš„ ziplist å†…å­˜å¤§å°ï¼Œrealloc å¯èƒ½ä¼šé‡æ–°åˆ†é…æ–°çš„å†…å­˜ç©ºé—´ï¼Œå¹¶å°†ä¹‹å‰çš„å†…å®¹ä¸€æ¬¡æ€§æ‹·è´åˆ°æ–°çš„åœ°å€ï¼Œä¹Ÿå¯èƒ½åœ¨åŸæœ‰çš„åœ°å€ä¸Šè¿›è¡Œæ‰©å±•ï¼Œè¿™æ—¶å°±ä¸éœ€è¦è¿›è¡Œæ—§å†…å®¹çš„å†…å­˜æ‹·è´ã€‚

å¦‚æœ ziplist å æ®å†…å­˜å¤ªå¤§ï¼Œé‡æ–°åˆ†é…å†…å­˜å’Œæ‹·è´å†…å­˜å°±ä¼šæœ‰å¾ˆå¤§çš„æ¶ˆè€—ã€‚æ‰€ä»¥ ziplist ä¸é€‚åˆå­˜å‚¨å¤§å‹å­—ç¬¦ä¸²ï¼Œå­˜å‚¨çš„å…ƒç´ ä¹Ÿä¸å®œè¿‡å¤šã€‚

## çº§è”æ›´æ–°
```c
/* When an entry is inserted, we need to set the prevlen field of the next
 * entry to equal the length of the inserted entry. It can occur that this
 * length cannot be encoded in 1 byte and the next entry needs to be grow
 * a bit larger to hold the 5-byte encoded prevlen. This can be done for free,
 * because this only happens when an entry is already being inserted (which
 * causes a realloc and memmove). However, encoding the prevlen may require
 * that this entry is grown as well. This effect may cascade throughout
 * the ziplist when there are consecutive entries with a size close to
 * ZIP_BIG_PREVLEN, so we need to check that the prevlen can be encoded in
 * every consecutive entry.
 *
 * Note that this effect can also happen in reverse, where the bytes required
 * to encode the prevlen field can shrink. This effect is deliberately ignored,
 * because it can cause a "flapping" effect where a chain prevlen fields is
 * first grown and then shrunk again after consecutive inserts. Rather, the
 * field is allowed to stay larger than necessary, because a large prevlen
 * field implies the ziplist is holding large entries anyway.
 *
 * The pointer "p" points to the first entry that does NOT need to be
 * updated, i.e. consecutive fields MAY need an update. */
unsigned char *__ziplistCascadeUpdate(unsigned char *zl, unsigned char *p) {
    size_t curlen = intrev32ifbe(ZIPLIST_BYTES(zl)), rawlen, rawlensize;
    size_t offset, noffset, extra;
    unsigned char *np;
    zlentry cur, next;

    while (p[0] != ZIP_END) {
        zipEntry(p, &cur);
        rawlen = cur.headersize + cur.len;
        rawlensize = zipStorePrevEntryLength(NULL,rawlen);

        /* Abort if there is no next entry. */
        if (p[rawlen] == ZIP_END) break;
        zipEntry(p+rawlen, &next);

        /* Abort when "prevlen" has not changed. */
        // prevlen çš„é•¿åº¦æ²¡æœ‰å˜ï¼Œä¸­æ–­çº§è”æ›´æ–°
        if (next.prevrawlen == rawlen) break;

        if (next.prevrawlensize < rawlensize) {
            /* The "prevlen" field of "next" needs more bytes to hold
             * the raw length of "cur". */
            // çº§è”æ‰©å±•
            offset = p-zl;
            extra = rawlensize-next.prevrawlensize;
            // æ‰©å¤§å†…å­˜
            zl = ziplistResize(zl,curlen+extra);
            p = zl+offset;

            /* Current pointer and offset for next element. */
            np = p+rawlen;
            noffset = np-zl;

            /* Update tail offset when next element is not the tail element. */
            // æ›´æ–° zltail_offset æŒ‡é’ˆ
            if ((zl+intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))) != np) {
                ZIPLIST_TAIL_OFFSET(zl) =
                    intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+extra);
            }

            /* Move the tail to the back. */
            // ç§»åŠ¨å†…å­˜
            memmove(np+rawlensize,
                np+next.prevrawlensize,
                curlen-noffset-next.prevrawlensize-1);
            zipStorePrevEntryLength(np,rawlen);

            /* Advance the cursor */
            p += rawlen;
            curlen += extra;
        } else {
            if (next.prevrawlensize > rawlensize) {
                /* This would result in shrinking, which we want to avoid.
                 * So, set "rawlen" in the available bytes. */
                // çº§è”æ”¶ç¼©ï¼Œä¸è¿‡è¿™é‡Œå¯ä»¥ä¸ç”¨æ”¶ç¼©äº†ï¼Œå› ä¸º 5 ä¸ªå­—èŠ‚ä¹Ÿæ˜¯å¯ä»¥å­˜å‚¨ 1 ä¸ªå­—èŠ‚çš„å†…å®¹çš„
                // è™½ç„¶æœ‰ç‚¹æµªè´¹ï¼Œä½†æ˜¯çº§è”æ›´æ–°å®åœ¨æ˜¯å¤ªå¯æ€•äº†ï¼Œæ‰€ä»¥æµªè´¹å°±æµªè´¹å§
                zipStorePrevEntryLengthLarge(p+rawlen,rawlen);
            } else {
                // å¤§å°æ²¡å˜ï¼Œæ”¹ä¸ªé•¿åº¦å€¼å°±å®Œäº‹äº†
                zipStorePrevEntryLength(p+rawlen,rawlen);
            }

            /* Stop here, as the raw length of "next" has not changed. */
            break;
        }
    }
    return zl;
}
```

å‰é¢æåˆ°æ¯ä¸ª entry éƒ½ä¼šæœ‰ä¸€ä¸ª `prevlen` å­—æ®µå­˜å‚¨å‰ä¸€ä¸ª entry çš„é•¿åº¦ã€‚å¦‚æœå†…å®¹å°äº 254 å­—èŠ‚ï¼Œ`prevlen` ç”¨ 1 å­—èŠ‚å­˜å‚¨ï¼Œå¦åˆ™å°±æ˜¯ 5 å­—èŠ‚ã€‚è¿™æ„å‘³ç€å¦‚æœæŸä¸ª entry ç»è¿‡äº†ä¿®æ”¹æ“ä½œä» 253 å­—èŠ‚å˜æˆäº† 254 å­—èŠ‚ï¼Œé‚£ä¹ˆå®ƒçš„ä¸‹ä¸€ä¸ª entry çš„ `prevlen` å­—æ®µå°±è¦æ›´æ–°ï¼Œä» 1 ä¸ªå­—èŠ‚æ‰©å±•åˆ° 5 ä¸ªå­—èŠ‚ï¼›å¦‚æœè¿™ä¸ª entry çš„é•¿åº¦æœ¬æ¥ä¹Ÿæ˜¯ 253 å­—èŠ‚ï¼Œé‚£ä¹ˆåé¢ entry çš„ `prevlen` å­—æ®µè¿˜å¾—ç»§ç»­æ›´æ–°ã€‚

å¦‚æœ ziplist é‡Œé¢æ¯ä¸ª entry æ°å¥½éƒ½å­˜å‚¨äº† 253 å­—èŠ‚çš„å†…å®¹ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ª entry å†…å®¹çš„ä¿®æ”¹å°±ä¼šå¯¼è‡´åç»­æ‰€æœ‰ entry çš„çº§è”æ›´æ–°ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—è´¹è®¡ç®—èµ„æºçš„æ“ä½œã€‚

åˆ é™¤ä¸­é—´çš„æŸä¸ªèŠ‚ç‚¹ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´çº§è”æ›´æ–°ï¼Œè¯»è€…å¯ä»¥æ€è€ƒä¸€ä¸‹ä¸ºä»€ä¹ˆï¼Ÿ

## IntSet å°æ•´æ•°é›†åˆ

å½“ set é›†åˆå®¹çº³çš„å…ƒç´ éƒ½æ˜¯æ•´æ•°å¹¶ä¸”å…ƒç´ ä¸ªæ•°è¾ƒå°æ—¶ï¼ŒRedis ä¼šä½¿ç”¨ `intset` æ¥å­˜å‚¨ç»“åˆå…ƒç´ ã€‚`intset` æ˜¯ç´§å‡‘çš„æ•°ç»„ç»“æ„ï¼ŒåŒæ—¶æ”¯æŒ 16 ä½ã€32 ä½å’Œ 64 ä½æ•´æ•°ã€‚
```
struct intset<T> {
    int32 encoding; // å†³å®šæ•´æ•°ä½å®½æ˜¯ 16 ä½ã€32 ä½è¿˜æ˜¯ 64 ä½
    int32 length; // å…ƒç´ ä¸ªæ•°
    int<T> contents; // æ•´æ•°æ•°ç»„ï¼Œå¯ä»¥æ˜¯ 16 ä½ã€32 ä½å’Œ 64 ä½
}
```

![](https://user-gold-cdn.xitu.io/2018/7/29/164e1a049ea6ea41?w=1472&h=230&f=png&s=32748)
è€é’±ä¹Ÿä¸æ˜¯å¾ˆèƒ½ç†è§£ä¸ºä»€ä¹ˆ intset çš„ encoding å­—æ®µå’Œ length å­—æ®µä½¿ç”¨ 32 ä½æ•´æ•°å­˜å‚¨ã€‚æ¯•ç«Ÿå®ƒåªæ˜¯ç”¨æ¥å­˜å‚¨å°æ•´æ•°çš„ï¼Œé•¿åº¦ä¸åº”è¯¥å¾ˆé•¿ï¼Œè€Œä¸” encoding åªæœ‰ 16 ä½ã€32 ä½å’Œ 64 ä½ä¸‰ä¸ªç±»å‹ï¼Œç”¨ä¸€ä¸ªå­—èŠ‚å­˜å‚¨å°±ç»°ç»°æœ‰ä½™ã€‚å…³äºè¿™ç‚¹ï¼Œè¯»è€…ä»¬å¯ä»¥è¿›ä¸€æ­¥è®¨è®ºã€‚
```
> sadd codehole 1 2 3
(integer) 3
> debug object codehole
Value at:0x7fec2dc2bde0 refcount:1 encoding:intset serializedlength:15 lru:6065795 lru_seconds_idle:4
> sadd codehole go java python
(integer) 3
> debug object codehole
Value at:0x7fec2dc2bde0 refcount:1 encoding:hashtable serializedlength:22 lru:6065810 lru_seconds_idle:5
```
æ³¨æ„è§‚å¯Ÿ debug object çš„è¾“å‡ºå­—æ®µ encoding çš„å€¼ï¼Œå¯ä»¥å‘ç°å½“ set é‡Œé¢æ”¾è¿›å»äº†éæ•´æ•°å€¼æ—¶ï¼Œå­˜å‚¨å½¢å¼ç«‹å³ä» intset è½¬å˜æˆäº† hash ç»“æ„ã€‚

## æ€è€ƒ
1. ä¸ºä»€ä¹ˆ set é›†åˆåœ¨æ•°é‡å¾ˆå°çš„æ—¶å€™ä¸ä½¿ç”¨ ziplist æ¥å­˜å‚¨ï¼Ÿ
2. æ‰§è¡Œ`rpush codehole 1 2 3`å‘½ä»¤åï¼Œè¯·å†™å‡ºåˆ—è¡¨å†…å®¹çš„ 16 è¿›åˆ¶å½¢å¼ã€‚
# æºç  4ï¼šé£é©°ç”µæ£ â€”â€” æ¢ç´¢ã€Œå¿«é€Ÿåˆ—è¡¨ã€å†…éƒ¨

Redis æ—©æœŸç‰ˆæœ¬å­˜å‚¨ list åˆ—è¡¨æ•°æ®ç»“æ„ä½¿ç”¨çš„æ˜¯å‹ç¼©åˆ—è¡¨ ziplist å’Œæ™®é€šçš„åŒå‘é“¾è¡¨ linkedlistï¼Œä¹Ÿå°±æ˜¯å…ƒç´ å°‘æ—¶ç”¨ ziplistï¼Œå…ƒç´ å¤šæ—¶ç”¨ linkedlistã€‚

```c
// é“¾è¡¨çš„èŠ‚ç‚¹
struct listNode<T> {
    listNode* prev;
    listNode* next;
    T value;
}
// é“¾è¡¨
struct list {
    listNode *head;
    listNode *tail;
    long length;
}
```
è€ƒè™‘åˆ°é“¾è¡¨çš„é™„åŠ ç©ºé—´ç›¸å¯¹å¤ªé«˜ï¼Œprev å’Œ next æŒ‡é’ˆå°±è¦å å» 16 ä¸ªå­—èŠ‚ (64bit ç³»ç»Ÿçš„æŒ‡é’ˆæ˜¯ 8 ä¸ªå­—èŠ‚)ï¼Œå¦å¤–æ¯ä¸ªèŠ‚ç‚¹çš„å†…å­˜éƒ½æ˜¯å•ç‹¬åˆ†é…ï¼Œä¼šåŠ å‰§å†…å­˜çš„ç¢ç‰‡åŒ–ï¼Œå½±å“å†…å­˜ç®¡ç†æ•ˆç‡ã€‚åç»­ç‰ˆæœ¬å¯¹åˆ—è¡¨æ•°æ®ç»“æ„è¿›è¡Œäº†æ”¹é€ ï¼Œä½¿ç”¨ quicklist ä»£æ›¿äº† ziplist å’Œ linkedlistã€‚
```
> rpush codehole go java python
(integer) 3
> debug object codehole
Value at:0x7fec2dc2bde0 refcount:1 encoding:quicklist serializedlength:31 lru:6101643 lru_seconds_idle:5 ql_nodes:1 ql_avg_node:3.00 ql_ziplist_max:-2 ql_compressed:0 ql_uncompressed_size:29
```
æ³¨æ„è§‚å¯Ÿä¸Šé¢è¾“å‡ºå­—æ®µ encoding çš„å€¼ã€‚quicklist æ˜¯ ziplist å’Œ linkedlist çš„æ··åˆä½“ï¼Œå®ƒå°† linkedlist æŒ‰æ®µåˆ‡åˆ†ï¼Œæ¯ä¸€æ®µä½¿ç”¨ ziplist æ¥ç´§å‡‘å­˜å‚¨ï¼Œå¤šä¸ª ziplist ä¹‹é—´ä½¿ç”¨åŒå‘æŒ‡é’ˆä¸²æ¥èµ·æ¥ã€‚
![](https://user-gold-cdn.xitu.io/2018/7/29/164e3b0b953f2fc7?w=1510&h=542&f=png&s=64217)
```c
struct ziplist {
    ...
}
struct ziplist_compressed {
    int32 size;
    byte[] compressed_data;
}
struct quicklistNode {
    quicklistNode* prev;
    quicklistNode* next;
    ziplist* zl; // æŒ‡å‘å‹ç¼©åˆ—è¡¨
    int32 size; // ziplist çš„å­—èŠ‚æ€»æ•°
    int16 count; // ziplist ä¸­çš„å…ƒç´ æ•°é‡
    int2 encoding; // å­˜å‚¨å½¢å¼ 2bitï¼ŒåŸç”Ÿå­—èŠ‚æ•°ç»„è¿˜æ˜¯ LZF å‹ç¼©å­˜å‚¨
    ...
}
struct quicklist {
    quicklistNode* head;
    quicklistNode* tail;
    long count; // å…ƒç´ æ€»æ•°
    int nodes; // ziplist èŠ‚ç‚¹çš„ä¸ªæ•°
    int compressDepth; // LZF ç®—æ³•å‹ç¼©æ·±åº¦
    ...
}
```
ä¸Šè¿°ä»£ç ç®€å•åœ°è¡¨ç¤ºäº† quicklist çš„å¤§è‡´ç»“æ„ã€‚ä¸ºäº†è¿›ä¸€æ­¥èŠ‚çº¦ç©ºé—´ï¼ŒRedis è¿˜ä¼šå¯¹ ziplist è¿›è¡Œå‹ç¼©å­˜å‚¨ï¼Œä½¿ç”¨ LZF ç®—æ³•å‹ç¼©ï¼Œå¯ä»¥é€‰æ‹©å‹ç¼©æ·±åº¦ã€‚

## æ¯ä¸ª ziplist å­˜å¤šå°‘å…ƒç´ ï¼Ÿ

quicklist å†…éƒ¨é»˜è®¤å•ä¸ª ziplist é•¿åº¦ä¸º 8k å­—èŠ‚ï¼Œè¶…å‡ºäº†è¿™ä¸ªå­—èŠ‚æ•°ï¼Œå°±ä¼šæ–°èµ·ä¸€ä¸ª ziplistã€‚ziplist çš„é•¿åº¦ç”±é…ç½®å‚æ•°`list-max-ziplist-size`å†³å®šã€‚
```
# Lists are also encoded in a special way to save a lot of space.
# The number of entries allowed per internal list node can be specified
# as a fixed maximum size or a maximum number of elements.
# For a fixed maximum size, use -5 through -1, meaning:
# -5: max size: 64 Kb  <-- not recommended for normal workloads
# -4: max size: 32 Kb  <-- not recommended
# -3: max size: 16 Kb  <-- probably not recommended
# -2: max size: 8 Kb   <-- good
# -1: max size: 4 Kb   <-- good
# Positive numbers mean store up to _exactly_ that number of elements
# per list node.
# The highest performing option is usually -2 (8 Kb size) or -1 (4 Kb size),
# but if your use case is unique, adjust the settings as necessary.
list-max-ziplist-size -2
```

## å‹ç¼©æ·±åº¦

![](https://user-gold-cdn.xitu.io/2018/7/29/164e3d168aa62cc9?w=1348&h=532&f=png&s=73235)

quicklist é»˜è®¤çš„å‹ç¼©æ·±åº¦æ˜¯ 0ï¼Œä¹Ÿå°±æ˜¯ä¸å‹ç¼©ã€‚å‹ç¼©çš„å®é™…æ·±åº¦ç”±é…ç½®å‚æ•°`list-compress-depth`å†³å®šã€‚ä¸ºäº†æ”¯æŒå¿«é€Ÿçš„ push/pop æ“ä½œï¼Œquicklist çš„é¦–å°¾ä¸¤ä¸ª ziplist ä¸å‹ç¼©ï¼Œæ­¤æ—¶æ·±åº¦å°±æ˜¯ 1ã€‚å¦‚æœæ·±åº¦ä¸º 2ï¼Œå°±è¡¨ç¤º quicklist çš„é¦–å°¾ç¬¬ä¸€ä¸ª ziplist ä»¥åŠé¦–å°¾ç¬¬äºŒä¸ª ziplist éƒ½ä¸å‹ç¼©ã€‚

## æ‰©å±•é˜…è¯»

- [ã€Šziplistã€linkedlist å’Œ quicklist çš„æ€§èƒ½å¯¹æ¯”ã€‹](https://matt.sh/redis-quicklist)
# æºç  5ï¼šå‡Œæ³¢å¾®æ­¥ â€”â€” æ¢ç´¢ã€Œè·³è·ƒåˆ—è¡¨ã€å†…éƒ¨ç»“æ„

Redis çš„ zset æ˜¯ä¸€ä¸ªå¤åˆç»“æ„ï¼Œä¸€æ–¹é¢å®ƒéœ€è¦ä¸€ä¸ª hash ç»“æ„æ¥å­˜å‚¨ value å’Œ score çš„å¯¹åº”å…³ç³»ï¼Œå¦ä¸€æ–¹é¢éœ€è¦æä¾›æŒ‰ç…§ score æ¥æ’åºçš„åŠŸèƒ½ï¼Œè¿˜éœ€è¦èƒ½å¤ŸæŒ‡å®š score çš„èŒƒå›´æ¥è·å– value åˆ—è¡¨çš„åŠŸèƒ½ï¼Œè¿™å°±éœ€è¦å¦å¤–ä¸€ä¸ªç»“æ„ã€Œè·³è·ƒåˆ—è¡¨ã€ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/27/164d9cd9064b556e?w=338&h=152&f=png&s=9604)

zset çš„å†…éƒ¨å®ç°æ˜¯ä¸€ä¸ª hash å­—å…¸åŠ ä¸€ä¸ªè·³è·ƒåˆ—è¡¨ (skiplist)ã€‚hash ç»“æ„åœ¨è®²å­—å…¸ç»“æ„æ—¶å·²ç»è¯¦ç»†åˆ†æè¿‡äº†ï¼Œå®ƒå¾ˆç±»ä¼¼äº Java è¯­è¨€ä¸­çš„ HashMap ç»“æ„ã€‚æœ¬èŠ‚æˆ‘ä»¬æ¥è®²è·³è·ƒåˆ—è¡¨ï¼Œå®ƒæ¯”è¾ƒå¤æ‚ï¼Œè¯»è€…è¦æœ‰å¿ƒç†å‡†å¤‡ã€‚

## åŸºæœ¬ç»“æ„

![](https://user-gold-cdn.xitu.io/2018/7/27/164d9f96ed4e1a0d?w=1457&h=273&f=png&s=24714)

ä¸Šå›¾å°±æ˜¯è·³è·ƒåˆ—è¡¨çš„ç¤ºæ„å›¾ï¼Œå›¾ä¸­åªç”»äº†å››å±‚ï¼ŒRedis çš„è·³è·ƒè¡¨å…±æœ‰ 64 å±‚ï¼Œå®¹çº³ 2^64 ä¸ªå…ƒç´ åº”è¯¥ä¸æˆé—®é¢˜ã€‚æ¯ä¸€ä¸ª kv å—å¯¹åº”çš„ç»“æ„å¦‚ä¸‹é¢çš„ä»£ç ä¸­çš„`zslnode`ç»“æ„ï¼Œkv header ä¹Ÿæ˜¯è¿™ä¸ªç»“æ„ï¼Œåªä¸è¿‡ value å­—æ®µæ˜¯ null å€¼â€”â€”æ— æ•ˆçš„ï¼Œscore æ˜¯ Double.MIN_VALUEï¼Œç”¨æ¥å«åº•çš„ã€‚kv ä¹‹é—´ä½¿ç”¨æŒ‡é’ˆä¸²èµ·æ¥å½¢æˆäº†åŒå‘é“¾è¡¨ç»“æ„ï¼Œå®ƒä»¬æ˜¯ **æœ‰åº** æ’åˆ—çš„ï¼Œä»å°åˆ°å¤§ã€‚ä¸åŒçš„ kv å±‚é«˜å¯èƒ½ä¸ä¸€æ ·ï¼Œå±‚æ•°è¶Šé«˜çš„ kv è¶Šå°‘ã€‚åŒä¸€å±‚çš„ kv ä¼šä½¿ç”¨æŒ‡é’ˆä¸²èµ·æ¥ã€‚æ¯ä¸€ä¸ªå±‚å…ƒç´ çš„éå†éƒ½æ˜¯ä» kv header å‡ºå‘ã€‚

```c
struct zslnode {
  string value;
  double score;
  zslnode*[] forwards;  // å¤šå±‚è¿æ¥æŒ‡é’ˆ
  zslnode* backward;  // å›æº¯æŒ‡é’ˆ
}

struct zsl {
  zslnode* header; // è·³è·ƒåˆ—è¡¨å¤´æŒ‡é’ˆ
  int maxLevel; // è·³è·ƒåˆ—è¡¨å½“å‰çš„æœ€é«˜å±‚
  map<string, zslnode*> ht; // hash ç»“æ„çš„æ‰€æœ‰é”®å€¼å¯¹
}
```

## æŸ¥æ‰¾è¿‡ç¨‹

è®¾æƒ³å¦‚æœè·³è·ƒåˆ—è¡¨åªæœ‰ä¸€å±‚ä¼šæ€æ ·ï¼Ÿæ’å…¥åˆ é™¤æ“ä½œéœ€è¦å®šä½åˆ°ç›¸åº”çš„ä½ç½®èŠ‚ç‚¹ (å®šä½åˆ°æœ€åä¸€ä¸ªæ¯”ã€Œæˆ‘ã€å°çš„å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªæ¯”ã€Œæˆ‘ã€å¤§çš„å…ƒç´ çš„å‰ä¸€ä¸ª)ï¼Œå®šä½çš„æ•ˆç‡è‚¯å®šæ¯”è¾ƒå·®ï¼Œå¤æ‚åº¦å°†ä¼šæ˜¯ O(n)ï¼Œå› ä¸ºéœ€è¦æŒ¨ä¸ªéå†ã€‚ä¹Ÿè®¸ä½ ä¼šæƒ³åˆ°äºŒåˆ†æŸ¥æ‰¾ï¼Œä½†æ˜¯äºŒåˆ†æŸ¥æ‰¾çš„ç»“æ„åªèƒ½æ˜¯æœ‰åºæ•°ç»„ã€‚è·³è·ƒåˆ—è¡¨æœ‰äº†å¤šå±‚ç»“æ„ä¹‹åï¼Œè¿™ä¸ªå®šä½çš„ç®—æ³•å¤æ‚åº¦å°†ä¼šé™åˆ° O(lg(n))ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/27/164dc52ae7e6444c?w=1912&h=662&f=png&s=119691)

å¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬è¦å®šä½åˆ°é‚£ä¸ªç´«è‰²çš„ kvï¼Œéœ€è¦ä» header çš„æœ€é«˜å±‚å¼€å§‹éå†æ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ (æœ€åä¸€ä¸ªæ¯”ã€Œæˆ‘ã€å°çš„å…ƒç´ )ï¼Œç„¶åä»è¿™ä¸ªèŠ‚ç‚¹å¼€å§‹é™ä¸€å±‚å†éå†æ‰¾åˆ°ç¬¬äºŒä¸ªèŠ‚ç‚¹ (æœ€åä¸€ä¸ªæ¯”ã€Œæˆ‘ã€å°çš„å…ƒç´ )ï¼Œç„¶åä¸€ç›´é™åˆ°æœ€åº•å±‚è¿›è¡Œéå†å°±æ‰¾åˆ°äº†æœŸæœ›çš„èŠ‚ç‚¹ (æœ€åº•å±‚çš„æœ€åä¸€ä¸ªæ¯”æˆ‘ã€Œå°ã€çš„å…ƒç´ )ã€‚

æˆ‘ä»¬å°†ä¸­é—´ç»è¿‡çš„ä¸€ç³»åˆ—èŠ‚ç‚¹ç§°ä¹‹ä¸ºã€Œæœç´¢è·¯å¾„ã€ï¼Œå®ƒæ˜¯ä»æœ€é«˜å±‚ä¸€ç›´åˆ°æœ€åº•å±‚çš„æ¯ä¸€å±‚æœ€åä¸€ä¸ªæ¯”ã€Œæˆ‘ã€å°çš„å…ƒç´ èŠ‚ç‚¹åˆ—è¡¨ã€‚

æœ‰äº†è¿™ä¸ªæœç´¢è·¯å¾„ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ’å…¥è¿™ä¸ªæ–°èŠ‚ç‚¹äº†ã€‚ä¸è¿‡è¿™ä¸ªæ’å…¥è¿‡ç¨‹ä¹Ÿä¸æ˜¯ç‰¹åˆ«ç®€å•ã€‚å› ä¸ºæ–°æ’å…¥çš„èŠ‚ç‚¹åˆ°åº•æœ‰å¤šå°‘å±‚ï¼Œå¾—æœ‰ä¸ªç®—æ³•æ¥åˆ†é…ä¸€ä¸‹ï¼Œè·³è·ƒåˆ—è¡¨ä½¿ç”¨çš„æ˜¯éšæœºç®—æ³•ã€‚

## éšæœºå±‚æ•°

å¯¹äºæ¯ä¸€ä¸ªæ–°æ’å…¥çš„èŠ‚ç‚¹ï¼Œéƒ½éœ€è¦è°ƒç”¨ä¸€ä¸ªéšæœºç®—æ³•ç»™å®ƒåˆ†é…ä¸€ä¸ªåˆç†çš„å±‚æ•°ã€‚ç›´è§‚ä¸ŠæœŸæœ›çš„ç›®æ ‡æ˜¯ 50% çš„ Level1ï¼Œ25% çš„ Level2ï¼Œ12.5% çš„ Level3ï¼Œä¸€ç›´åˆ°æœ€é¡¶å±‚`2^-63`ï¼Œå› ä¸ºè¿™é‡Œæ¯ä¸€å±‚çš„æ™‹å‡æ¦‚ç‡æ˜¯ 50%ã€‚

```c
/* Returns a random level for the new skiplist node we are going to create.
 * The return value of this function is between 1 and ZSKIPLIST_MAXLEVEL
 * (both inclusive), with a powerlaw-alike distribution where higher
 * levels are less likely to be returned. */
int zslRandomLevel(void) {
    int level = 1;
    while ((random()&0xFFFF) < (ZSKIPLIST_P * 0xFFFF))
        level += 1;
    return (level<ZSKIPLIST_MAXLEVEL) ? level : ZSKIPLIST_MAXLEVEL;
}
```
ä¸è¿‡ Redis æ ‡å‡†æºç ä¸­çš„æ™‹å‡æ¦‚ç‡åªæœ‰ 25%ï¼Œä¹Ÿå°±æ˜¯ä»£ç ä¸­çš„ ZSKIPLIST_P çš„å€¼ã€‚æ‰€ä»¥å®˜æ–¹çš„è·³è·ƒåˆ—è¡¨æ›´åŠ çš„æ‰å¹³åŒ–ï¼Œå±‚é«˜ç›¸å¯¹è¾ƒä½ï¼Œåœ¨å•ä¸ªå±‚ä¸Šéœ€è¦éå†çš„èŠ‚ç‚¹æ•°é‡ä¼šç¨å¤šä¸€ç‚¹ã€‚

ä¹Ÿæ­£æ˜¯å› ä¸ºå±‚æ•°ä¸€èˆ¬ä¸é«˜ï¼Œæ‰€ä»¥éå†çš„æ—¶å€™ä»é¡¶å±‚å¼€å§‹å¾€ä¸‹éå†ä¼šéå¸¸æµªè´¹ã€‚è·³è·ƒåˆ—è¡¨ä¼šè®°å½•ä¸€ä¸‹å½“å‰çš„æœ€é«˜å±‚æ•°`maxLevel`ï¼Œéå†æ—¶ä»è¿™ä¸ª maxLevel å¼€å§‹éå†æ€§èƒ½å°±ä¼šæé«˜å¾ˆå¤šã€‚

## æ’å…¥è¿‡ç¨‹
ä¸‹é¢æ˜¯æ’å…¥è¿‡ç¨‹çš„æºç ï¼Œå®ƒç¨å¾®æœ‰ç‚¹é•¿ï¼Œä¸è¿‡æ•´ä½“çš„è¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ã€‚
```c
/* Insert a new node in the skiplist. Assumes the element does not already
 * exist (up to the caller to enforce that). The skiplist takes ownership
 * of the passed SDS string 'ele'. */
zskiplistNode *zslInsert(zskiplist *zsl, double score, sds ele) {
    // å­˜å‚¨æœç´¢è·¯å¾„
    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;
    // å­˜å‚¨ç»è¿‡çš„èŠ‚ç‚¹è·¨åº¦
    unsigned int rank[ZSKIPLIST_MAXLEVEL];
    int i, level;

    serverAssert(!isnan(score));
    x = zsl->header;
    // é€æ­¥é™çº§å¯»æ‰¾ç›®æ ‡èŠ‚ç‚¹ï¼Œå¾—åˆ°ã€Œæœç´¢è·¯å¾„ã€
    for (i = zsl->level-1; i >= 0; i--) {
        /* store rank that is crossed to reach the insert position */
        rank[i] = i == (zsl->level-1) ? 0 : rank[i+1];
        // å¦‚æœscoreç›¸ç­‰ï¼Œè¿˜éœ€è¦æ¯”è¾ƒvalue
        while (x->level[i].forward &&
                (x->level[i].forward->score < score ||
                    (x->level[i].forward->score == score &&
                    sdscmp(x->level[i].forward->ele,ele) < 0)))
        {
            rank[i] += x->level[i].span;
            x = x->level[i].forward;
        }
        update[i] = x;
    }
    // æ­£å¼è¿›å…¥æ’å…¥è¿‡ç¨‹
    /* we assume the element is not already inside, since we allow duplicated
     * scores, reinserting the same element should never happen since the
     * caller of zslInsert() should test in the hash table if the element is
     * already inside or not. */
    // éšæœºä¸€ä¸ªå±‚æ•°
    level = zslRandomLevel();
    // å¡«å……è·¨åº¦
    if (level > zsl->level) {
        for (i = zsl->level; i < level; i++) {
            rank[i] = 0;
            update[i] = zsl->header;
            update[i]->level[i].span = zsl->length;
        }
        // æ›´æ–°è·³è·ƒåˆ—è¡¨çš„å±‚é«˜
        zsl->level = level;
    }
    // åˆ›å»ºæ–°èŠ‚ç‚¹
    x = zslCreateNode(level,score,ele);
    // é‡æ’ä¸€ä¸‹å‰å‘æŒ‡é’ˆ
    for (i = 0; i < level; i++) {
        x->level[i].forward = update[i]->level[i].forward;
        update[i]->level[i].forward = x;

        /* update span covered by update[i] as x is inserted here */
        x->level[i].span = update[i]->level[i].span - (rank[0] - rank[i]);
        update[i]->level[i].span = (rank[0] - rank[i]) + 1;
    }

    /* increment span for untouched levels */
    for (i = level; i < zsl->level; i++) {
        update[i]->level[i].span++;
    }
    // é‡æ’ä¸€ä¸‹åå‘æŒ‡é’ˆ
    x->backward = (update[0] == zsl->header) ? NULL : update[0];
    if (x->level[0].forward)
        x->level[0].forward->backward = x;
    else
        zsl->tail = x;
    zsl->length++;
    return x;
}
```
é¦–å…ˆæˆ‘ä»¬åœ¨æœç´¢åˆé€‚æ’å…¥ç‚¹çš„è¿‡ç¨‹ä¸­å°†ã€Œæœç´¢è·¯å¾„ã€æ‘¸å‡ºæ¥äº†ï¼Œç„¶åå°±å¯ä»¥å¼€å§‹åˆ›å»ºæ–°èŠ‚ç‚¹äº†ï¼Œåˆ›å»ºçš„æ—¶å€™éœ€è¦ç»™è¿™ä¸ªèŠ‚ç‚¹éšæœºåˆ†é…ä¸€ä¸ªå±‚æ•°ï¼Œå†å°†æœç´¢è·¯å¾„ä¸Šçš„èŠ‚ç‚¹å’Œè¿™ä¸ªæ–°èŠ‚ç‚¹é€šè¿‡å‰å‘åå‘æŒ‡é’ˆä¸²èµ·æ¥ã€‚å¦‚æœåˆ†é…çš„æ–°èŠ‚ç‚¹çš„é«˜åº¦é«˜äºå½“å‰è·³è·ƒåˆ—è¡¨çš„æœ€å¤§é«˜åº¦ï¼Œå°±éœ€è¦æ›´æ–°ä¸€ä¸‹è·³è·ƒåˆ—è¡¨çš„æœ€å¤§é«˜åº¦ã€‚

## åˆ é™¤è¿‡ç¨‹

åˆ é™¤è¿‡ç¨‹å’Œæ’å…¥è¿‡ç¨‹ç±»ä¼¼ï¼Œéƒ½éœ€å…ˆæŠŠè¿™ä¸ªã€Œæœç´¢è·¯å¾„ã€æ‰¾å‡ºæ¥ã€‚ç„¶åå¯¹äºæ¯ä¸ªå±‚çš„ç›¸å…³èŠ‚ç‚¹éƒ½é‡æ’ä¸€ä¸‹å‰å‘åå‘æŒ‡é’ˆå°±å¯ä»¥äº†ã€‚åŒæ—¶è¿˜è¦æ³¨æ„æ›´æ–°ä¸€ä¸‹æœ€é«˜å±‚æ•°`maxLevel`ã€‚

## æ›´æ–°è¿‡ç¨‹

å½“æˆ‘ä»¬è°ƒç”¨ zadd æ–¹æ³•æ—¶ï¼Œå¦‚æœå¯¹åº”çš„ value ä¸å­˜åœ¨ï¼Œé‚£å°±æ˜¯æ’å…¥è¿‡ç¨‹ã€‚å¦‚æœè¿™ä¸ª value å·²ç»å­˜åœ¨äº†ï¼Œåªæ˜¯è°ƒæ•´ä¸€ä¸‹ score çš„å€¼ï¼Œé‚£å°±éœ€è¦èµ°ä¸€ä¸ªæ›´æ–°çš„æµç¨‹ã€‚å‡è®¾è¿™ä¸ªæ–°çš„ score å€¼ä¸ä¼šå¸¦æ¥æ’åºä½ç½®ä¸Šçš„æ”¹å˜ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦è°ƒæ•´ä½ç½®ï¼Œç›´æ¥ä¿®æ”¹å…ƒç´ çš„ score å€¼å°±å¯ä»¥äº†ã€‚ä½†æ˜¯å¦‚æœæ’åºä½ç½®æ”¹å˜äº†ï¼Œé‚£å°±è¦è°ƒæ•´ä½ç½®ã€‚é‚£è¯¥å¦‚ä½•è°ƒæ•´ä½ç½®å‘¢ï¼Ÿ
```c
/* Remove and re-insert when score changes. */
    if (score != curscore) {
        zskiplistNode *node;
        serverAssert(zslDelete(zs->zsl,curscore,ele,&node));
        znode = zslInsert(zs->zsl,score,node->ele);
        /* We reused the node->ele SDS string, free the node now
        * since zslInsert created a new one. */
        node->ele = NULL;
        zslFreeNode(node);
        /* Note that we did not removed the original element from
        * the hash table representing the sorted set, so we just
        * update the score. */
        dictGetVal(de) = &znode->score; /* Update score ptr. */
        *flags |= ZADD_UPDATED;
        }
    return 1;
```

ä¸€ä¸ªç®€å•çš„ç­–ç•¥å°±æ˜¯å…ˆåˆ é™¤è¿™ä¸ªå…ƒç´ ï¼Œå†æ’å…¥è¿™ä¸ªå…ƒç´ ï¼Œéœ€è¦ç»è¿‡ä¸¤æ¬¡è·¯å¾„æœç´¢ã€‚Redis å°±æ˜¯è¿™ä¹ˆå¹²çš„ã€‚
ä¸è¿‡ Redis é‡åˆ° score å€¼æ”¹å˜äº†å°±ç›´æ¥åˆ é™¤å†æ’å…¥ï¼Œä¸ä¼šå»åˆ¤æ–­ä½ç½®æ˜¯å¦éœ€è¦è°ƒæ•´ï¼Œä»è¿™ç‚¹çœ‹ï¼ŒRedis çš„ zadd çš„ä»£ç ä¼¼ä¹è¿˜æœ‰ä¼˜åŒ–ç©ºé—´ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œè¯»è€…ä»¬å¯ä»¥ç»§ç»­è®¨è®ºã€‚

## å¦‚æœ score å€¼éƒ½ä¸€æ ·å‘¢ï¼Ÿ

åœ¨ä¸€ä¸ªæç«¯çš„æƒ…å†µä¸‹ï¼Œzset ä¸­æ‰€æœ‰çš„ score å€¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œzset çš„æŸ¥æ‰¾æ€§èƒ½ä¼šé€€åŒ–ä¸º O(n) ä¹ˆï¼ŸRedis ä½œè€…è‡ªç„¶è€ƒè™‘åˆ°äº†è¿™ä¸€ç‚¹ï¼Œæ‰€ä»¥ zset çš„æ’åºå…ƒç´ ä¸åªçœ‹ score å€¼ï¼Œå¦‚æœ score å€¼ç›¸åŒè¿˜éœ€è¦å†æ¯”è¾ƒ value å€¼ (å­—ç¬¦ä¸²æ¯”è¾ƒ)ã€‚

## å…ƒç´ æ’åæ˜¯æ€ä¹ˆç®—å‡ºæ¥çš„ï¼Ÿ

å‰é¢æˆ‘ä»¬å•°å—¦äº†ä¸€å †ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé‡è¦çš„å±æ€§æ²¡æœ‰æåˆ°ï¼Œé‚£å°±æ˜¯ zset å¯ä»¥è·å–å…ƒç´ çš„æ’å rankã€‚é‚£è¿™ä¸ª rank æ˜¯å¦‚ä½•ç®—å‡ºæ¥çš„ï¼Ÿå¦‚æœä»…ä»…ä½¿ç”¨ä¸Šé¢çš„ç»“æ„ï¼Œrank æ˜¯ä¸èƒ½ç®—å‡ºæ¥çš„ã€‚Redis åœ¨ skiplist çš„ forward æŒ‡é’ˆä¸Šè¿›è¡Œäº†ä¼˜åŒ–ï¼Œç»™æ¯ä¸€ä¸ª forward æŒ‡é’ˆéƒ½å¢åŠ äº† span å±æ€§ï¼Œspan æ˜¯ã€Œè·¨åº¦ã€çš„æ„æ€ï¼Œè¡¨ç¤ºä»å‰ä¸€ä¸ªèŠ‚ç‚¹æ²¿ç€å½“å‰å±‚çš„ forward æŒ‡é’ˆè·³åˆ°å½“å‰è¿™ä¸ªèŠ‚ç‚¹ä¸­é—´ä¼šè·³è¿‡å¤šå°‘ä¸ªèŠ‚ç‚¹ã€‚Redis åœ¨æ’å…¥åˆ é™¤æ“ä½œæ—¶ä¼šå°å¿ƒç¿¼ç¿¼åœ°æ›´æ–° span å€¼çš„å¤§å°ã€‚
```java
struct zslforward {
  zslnode* item;
  long span;  // è·¨åº¦
}

struct zsl {
  String value;
  double score;
  zslforward*[] forwards;  // å¤šå±‚è¿æ¥æŒ‡é’ˆ
  zslnode* backward;  // å›æº¯æŒ‡é’ˆ
}
```
è¿™æ ·å½“æˆ‘ä»¬è¦è®¡ç®—ä¸€ä¸ªå…ƒç´ çš„æ’åæ—¶ï¼Œåªéœ€è¦å°†ã€Œæœç´¢è·¯å¾„ã€ä¸Šçš„ç»è¿‡çš„æ‰€æœ‰èŠ‚ç‚¹çš„è·¨åº¦ span å€¼è¿›è¡Œå åŠ å°±å¯ä»¥ç®—å‡ºå…ƒç´ çš„æœ€ç»ˆ rank å€¼ã€‚

## æ€è€ƒ

æ–‡ä¸­æˆ‘ä»¬æåˆ°å½“ score å€¼çš„å˜åŒ–å¾®å°ï¼Œä¸ä¼šå¸¦æ¥ä½ç½®ä¸Šçš„è°ƒæ•´æ—¶ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ç›´æ¥ä¿®æ”¹ score åå°±è¿”å›ï¼Ÿ

è¯·è¯»è€…ä»¬å¯¹è¿™ä¸ªé—®é¢˜è¿›è¡Œè®¨è®ºã€‚å¦‚æœç¡®å®å¦‚æ­¤ï¼Œå¯ä»¥è€ƒè™‘å‘ Redis ä½œè€… Antirez æ issue äº†ã€‚

## åè®°

è€é’±äº 2018 å¹´ 7 æœˆ 28 æ—¥å‘ Redis çš„ Github Repo æäº¤äº†è¿™ä¸ªå°ä¼˜åŒ–çš„å»ºè®® [ã€Šmaybe an optimizable point for zadd operationã€‹](https://github.com/antirez/redis/issues/5179)ï¼Œ5 å¤©åï¼ŒRedis ä½œè€… Antirez æ¥å—äº†è¿™ä¸ªå»ºè®®ï¼Œå¯¹ skiplist çš„ä»£ç åšäº†å°ä¿®æ”¹å¹¶ merge åˆ°äº† masterã€‚

Antirez å‘è€é’±è¡¨è¾¾äº†æ„Ÿè°¢ï¼Œä½œä¸ºå°å­¦ç”Ÿçš„æˆ‘è¡¨ç¤ºå¾ˆæ¿€åŠ¨ï¼Œä»–å‘Šè¯‰æˆ‘è¿™ä¸ªå°ä¼˜åŒ–åœ¨æŸäº›åº”ç”¨åœºæ™¯ä¸‹å¯ä»¥ä¸º zset å¸¦æ¥ 10% ä»¥ä¸Šæ€§èƒ½çš„æå‡ã€‚

![](https://user-gold-cdn.xitu.io/2018/8/5/1650a1dac220f24b?w=1600&h=738&f=png&s=168891)

# æºç  6ï¼šç ´æ—§ç«‹æ–° â€”â€” æ¢ç´¢ã€Œç´§å‡‘åˆ—è¡¨ã€å†…éƒ¨

Redis 5.0 åˆå¼•å…¥äº†ä¸€ä¸ªæ–°çš„æ•°æ®ç»“æ„ listpackï¼Œå®ƒæ˜¯å¯¹ ziplist ç»“æ„çš„æ”¹è¿›ï¼Œåœ¨å­˜å‚¨ç©ºé—´ä¸Šä¼šæ›´åŠ èŠ‚çœï¼Œè€Œä¸”ç»“æ„ä¸Šä¹Ÿæ¯” ziplist è¦ç²¾ç®€ã€‚å®ƒçš„æ•´ä½“å½¢å¼å’Œ ziplist è¿˜æ˜¯æ¯”è¾ƒæ¥è¿‘çš„ï¼Œå¦‚æœä½ è®¤çœŸé˜…è¯»äº† ziplist çš„å†…éƒ¨ç»“æ„åˆ†æï¼Œé‚£ä¹ˆ listpack ä¹Ÿæ˜¯æ¯”è¾ƒå®¹æ˜“ç†è§£çš„ã€‚
```c
struct listpack<T> {
    int32 total_bytes; // å ç”¨çš„æ€»å­—èŠ‚æ•°
    int16 size; // å…ƒç´ ä¸ªæ•°
    T[] entries; // ç´§å‡‘æ’åˆ—çš„å…ƒç´ åˆ—è¡¨
    int8 end; // åŒ zlend ä¸€æ ·ï¼Œæ’ä¸º 0xFF
}
```

![](https://user-gold-cdn.xitu.io/2018/7/29/164e41fa97257519?w=1412&h=480&f=png&s=57895)
é¦–å…ˆè¿™ä¸ª listpack è·Ÿ ziplist çš„ç»“æ„å‡ ä¹ä¸€æ‘¸ä¸€æ ·ï¼Œåªæ˜¯å°‘äº†ä¸€ä¸ª`zltail_offset`å­—æ®µã€‚ziplist é€šè¿‡è¿™ä¸ªå­—æ®µæ¥å®šä½å‡ºæœ€åä¸€ä¸ªå…ƒç´ çš„ä½ç½®ï¼Œç”¨äºé€†åºéå†ã€‚ä¸è¿‡ listpack å¯ä»¥é€šè¿‡å…¶å®ƒæ–¹å¼æ¥å®šä½å‡ºæœ€åä¸€ä¸ªå…ƒç´ çš„ä½ç½®ï¼Œæ‰€ä»¥`zltail_offset`å­—æ®µå°±çœæ‰äº†ã€‚
```c
struct lpentry {
    int<var> encoding;
    optional byte[] content;
    int<var> length;
}
```
å…ƒç´ çš„ç»“æ„å’Œ ziplist çš„å…ƒç´ ç»“æ„ä¹Ÿå¾ˆç±»ä¼¼ï¼Œéƒ½æ˜¯åŒ…å«ä¸‰ä¸ªå­—æ®µã€‚ä¸åŒçš„æ˜¯é•¿åº¦å­—æ®µæ”¾åœ¨äº†å…ƒç´ çš„å°¾éƒ¨ï¼Œè€Œä¸”å­˜å‚¨çš„ä¸æ˜¯ä¸Šä¸€ä¸ªå…ƒç´ çš„é•¿åº¦ï¼Œæ˜¯å½“å‰å…ƒç´ çš„é•¿åº¦ã€‚æ­£æ˜¯å› ä¸ºé•¿åº¦æ”¾åœ¨äº†å°¾éƒ¨ï¼Œæ‰€ä»¥å¯ä»¥çœå»äº†`zltail_offset`å­—æ®µæ¥æ ‡è®°æœ€åä¸€ä¸ªå…ƒç´ çš„ä½ç½®ï¼Œè¿™ä¸ªä½ç½®å¯ä»¥é€šè¿‡`total_bytes`å­—æ®µå’Œæœ€åä¸€ä¸ªå…ƒç´ çš„é•¿åº¦å­—æ®µè®¡ç®—å‡ºæ¥ã€‚

é•¿åº¦å­—æ®µä½¿ç”¨ varint è¿›è¡Œç¼–ç ï¼Œä¸åŒäº skiplist å…ƒç´ é•¿åº¦çš„ç¼–ç ä¸º 1 ä¸ªå­—èŠ‚æˆ–è€… 5 ä¸ªå­—èŠ‚ï¼Œlistpack å…ƒç´ é•¿åº¦çš„ç¼–ç å¯ä»¥æ˜¯ 1ã€2ã€3ã€4ã€5 ä¸ªå­—èŠ‚ã€‚åŒ UTF8 ç¼–ç ä¸€æ ·ï¼Œå®ƒé€šè¿‡å­—èŠ‚çš„æœ€é«˜ä¸ºæ˜¯å¦ä¸º 1 æ¥å†³å®šç¼–ç çš„é•¿åº¦ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/29/164e4256399b6e4a?w=1286&h=618&f=png&s=40994)

åŒæ ·ï¼ŒRedis ä¸ºäº†è®© listpack å…ƒç´ æ”¯æŒå¾ˆå¤šç±»å‹ï¼Œå®ƒå¯¹ encoding å­—æ®µä¹Ÿè¿›è¡Œäº†è¾ƒä¸ºå¤æ‚çš„è®¾è®¡ã€‚
1. `0xxxxxxx` è¡¨ç¤ºéè´Ÿå°æ•´æ•°ï¼Œå¯ä»¥è¡¨ç¤º`0~127`ã€‚
2. `10xxxxxx` è¡¨ç¤ºå°å­—ç¬¦ä¸²ï¼Œé•¿åº¦èŒƒå›´æ˜¯`0~63`ï¼Œ`content`å­—æ®µä¸ºå­—ç¬¦ä¸²çš„å†…å®¹ã€‚
3. `110xxxxx yyyyyyyy` è¡¨ç¤ºæœ‰ç¬¦å·æ•´æ•°ï¼ŒèŒƒå›´æ˜¯`-2048~2047`ã€‚
4. `1110xxxx yyyyyyyy` è¡¨ç¤ºä¸­ç­‰é•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œé•¿åº¦èŒƒå›´æ˜¯`0~4095`ï¼Œ`content`å­—æ®µä¸ºå­—ç¬¦ä¸²çš„å†…å®¹ã€‚
5. `11110000 aaaaaaaa bbbbbbbb cccccccc dddddddd` è¡¨ç¤ºå¤§å­—ç¬¦ä¸²ï¼Œå››ä¸ªå­—èŠ‚è¡¨ç¤ºé•¿åº¦ï¼Œ`content`å­—æ®µä¸ºå­—ç¬¦ä¸²å†…å®¹ã€‚
6. `11110001 aaaaaaaa bbbbbbbb` è¡¨ç¤º 2 å­—èŠ‚æœ‰ç¬¦å·æ•´æ•°ã€‚
7. `11110010 aaaaaaaa bbbbbbbb cccccccc` è¡¨ç¤º 3 å­—èŠ‚æœ‰ç¬¦å·æ•´æ•°ã€‚
8. `11110011 aaaaaaaa bbbbbbbb cccccccc dddddddd` è¡¨ç¤º 4 å­—èŠ‚æœ‰ç¬¦å·æ•´æ•°ã€‚
9. `11110011 aaaaaaaa ... hhhhhhhh` è¡¨ç¤º 8 å­—èŠ‚æœ‰ç¬¦å·æ•´æ•°ã€‚
10. `11111111` è¡¨ç¤º listpack çš„ç»“æŸç¬¦å·ï¼Œä¹Ÿå°±æ˜¯`0xFF`ã€‚

## çº§è”æ›´æ–°

listpack çš„è®¾è®¡å½»åº•æ¶ˆç­äº† ziplist å­˜åœ¨çš„çº§è”æ›´æ–°è¡Œä¸ºï¼Œå…ƒç´ ä¸å…ƒç´ ä¹‹é—´å®Œå…¨ç‹¬ç«‹ï¼Œä¸ä¼šå› ä¸ºä¸€ä¸ªå…ƒç´ çš„é•¿åº¦å˜é•¿å°±å¯¼è‡´åç»­çš„å…ƒç´ å†…å®¹ä¼šå—åˆ°å½±å“ã€‚

## å–ä»£ ziplist

listpack çš„è®¾è®¡çš„ç›®çš„æ˜¯ç”¨æ¥å–ä»£ ziplistï¼Œä¸è¿‡å½“ä¸‹è¿˜æ²¡æœ‰åšå¥½æ›¿æ¢ ziplist çš„å‡†å¤‡ï¼Œå› ä¸ºæœ‰å¾ˆå¤šå…¼å®¹æ€§çš„é—®é¢˜éœ€è¦è€ƒè™‘ï¼Œziplist åœ¨ Redis æ•°æ®ç»“æ„ä¸­ä½¿ç”¨å¤ªå¹¿æ³›äº†ï¼Œæ›¿æ¢èµ·æ¥å¤æ‚åº¦ä¼šéå¸¸ä¹‹é«˜ã€‚å®ƒç›®å‰åªä½¿ç”¨åœ¨äº†æ–°å¢åŠ çš„ Stream æ•°æ®ç»“æ„ä¸­ã€‚

## æ€è€ƒ

ä¸ºä»€ä¹ˆ listpack æ¯” ziplist æ›´åŠ ä¼˜ç§€ï¼Ÿ
# æºç  7ï¼šé‡‘æç‰å¶ â€”â€” æ¢ç´¢ã€ŒåŸºæ•°æ ‘ã€å†…éƒ¨

Rax æ˜¯ Redis å†…éƒ¨æ¯”è¾ƒç‰¹æ®Šçš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå®ƒæ˜¯ä¸€ä¸ªæœ‰åºå­—å…¸æ ‘ (åŸºæ•°æ ‘ Radix Tree)ï¼ŒæŒ‰ç…§ key çš„å­—å…¸åºæ’åˆ—ï¼Œæ”¯æŒå¿«é€Ÿåœ°å®šä½ã€æ’å…¥å’Œåˆ é™¤æ“ä½œã€‚Redis äº”å¤§åŸºç¡€æ•°æ®ç»“æ„é‡Œé¢ï¼Œèƒ½ä½œä¸ºå­—å…¸ä½¿ç”¨çš„æœ‰ hash å’Œ zsetã€‚hash ä¸å…·å¤‡æ’åºåŠŸèƒ½ï¼Œzset åˆ™æ˜¯æŒ‰ç…§ score è¿›è¡Œæ’åºçš„ã€‚rax è·Ÿ zset çš„ä¸åŒåœ¨äºå®ƒæ˜¯æŒ‰ç…§ key è¿›è¡Œæ’åºçš„ã€‚Redis ä½œè€…è®¤ä¸º rax çš„ç»“æ„éå¸¸æ˜“äºç†è§£ï¼Œä½†æ˜¯å®ç°å´æœ‰ç›¸å½“çš„å¤æ‚åº¦ï¼Œéœ€è¦è€ƒè™‘å¾ˆå¤šçš„è¾¹ç•Œæ¡ä»¶ï¼Œéœ€è¦å¤„ç†èŠ‚ç‚¹çš„åˆ†è£‚ã€åˆå¹¶ï¼Œä¸€ä¸å°å¿ƒå°±ä¼šå‡ºé”™ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/29/164e6638d182d063?w=1398&h=428&f=png&s=51175)

## åº”ç”¨

ä½ å¯ä»¥å°†ä¸€æœ¬è‹±è¯­å­—å…¸çœ‹æˆä¸€æ£µ radix treeï¼Œå®ƒæ‰€æœ‰çš„å•è¯éƒ½æ˜¯æŒ‰ç…§å­—å…¸åºè¿›è¡Œæ’åˆ—ï¼Œæ¯ä¸ªè¯æ±‡éƒ½ä¼šé™„å¸¦ä¸€ä¸ªè§£é‡Šï¼Œè¿™ä¸ªè§£é‡Šå°±æ˜¯ key å¯¹åº”çš„ valueã€‚æœ‰äº†è¿™æ£µæ ‘ï¼Œä½ å°±å¯ä»¥å¿«é€Ÿåœ°æ£€ç´¢å•è¯ï¼Œè¿˜å¯ä»¥æŸ¥è¯¢ä»¥æŸä¸ªå‰ç¼€å¼€å¤´çš„å•è¯æœ‰å“ªäº›ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/30/164e913c11c441ec?w=536&h=400&f=png&s=33470)

ä½ ä¹Ÿå¯ä»¥å°†å…¬å®‰å±€çš„äººå‘˜æ¡£æ¡ˆä¿¡æ¯çœ‹æˆä¸€æ£µ radix treeï¼Œå®ƒçš„ key æ˜¯æ¯ä¸ªäººçš„èº«ä»½è¯å·ï¼Œvalue æ˜¯è¿™ä¸ªäººçš„å±¥å†ã€‚å› ä¸ºèº«ä»½è¯å·çš„ç¼–ç çš„å‰ç¼€æ˜¯æŒ‰ç…§åœ°åŒºè¿›è¡Œä¸€çº§ä¸€çº§åˆ’åˆ†çš„ï¼Œè¿™ç‚¹å’Œå•è¯éå¸¸ç±»ä¼¼ã€‚æœ‰äº†è¿™æ£µæ ‘ï¼Œä½ å°±å¯ä»¥å¿«é€Ÿåœ°å®šä½å‡ºäººå‘˜æ¡£æ¡ˆï¼Œè¿˜å¯ä»¥å¿«é€ŸæŸ¥è¯¢å‡ºæŸä¸ªå°ç‰‡åŒºéƒ½æœ‰å“ªäº›äººã€‚

Radix tree è¿˜å¯ä»¥åº”ç”¨äºæ—¶é—´åºåˆ—åº”ç”¨ï¼Œkey ä¸ºæ—¶é—´æˆ³ï¼Œvalue ä¸ºå‘ç”Ÿåœ¨å…·ä½“æ—¶é—´çš„äº‹ä»¶å†…å®¹ã€‚å› ä¸ºæ—¶é—´æˆ³çš„ç¼–ç ä¹Ÿæ˜¯æŒ‰ç…§ã€å¹´æœˆæ—¥æ—¶åˆ†ç§’æ¯«ç§’å¾®ç§’çº³ç§’ã€‘è¿›è¡Œä¸€çº§ä¸€çº§åˆ’åˆ†çš„ï¼Œæ‰€ä»¥å®ƒä¹Ÿå¯ä»¥ä½¿ç”¨å­—å…¸åºæ¥æ’åºã€‚æœ‰äº†è¿™æ£µæ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¿«é€Ÿå®šä½å‡ºæŸä¸ªå…·ä½“æ—¶é—´å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Œä¹Ÿå¯ä»¥æŸ¥è¯¢å‡ºä¸€æ®µæ—¶é—´å†…éƒ½æœ‰å“ªäº›äº‹å‘ç”Ÿã€‚

æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„ Web æœåŠ¡å™¨çš„ Router å®ƒä¹Ÿæ˜¯ä¸€æ£µ radix treeã€‚è¿™æ£µæ ‘ä¸ŠæŒ‚æ»¡äº† URL è§„åˆ™ï¼Œæ¯ä¸ª URL è§„åˆ™ä¸Šéƒ½ä¼šé™„ä¸Šä¸€ä¸ªè¯·æ±‚å¤„ç†å™¨ã€‚å½“ä¸€ä¸ªè¯·æ±‚åˆ°æ¥æ—¶ï¼Œæˆ‘ä»¬æ‹¿è¿™ä¸ªè¯·æ±‚çš„ URL æ²¿ç€æ ‘è¿›è¡Œéå†ï¼Œæ‰¾åˆ°ç›¸åº”çš„è¯·æ±‚å¤„ç†å™¨æ¥å¤„ç†ã€‚å› ä¸º URL ä¸­å¯èƒ½å­˜åœ¨æ­£åˆ™ patternï¼Œè€Œä¸”åŒä¸€å±‚çš„èŠ‚ç‚¹å¯¹é¡ºåºæ²¡æœ‰è¦æ±‚ï¼Œæ‰€ä»¥å®ƒä¸ç®—æ˜¯ä¸€æ£µä¸¥æ ¼çš„ radix treeã€‚
```
# golang çš„ HttpRouter åº“
The router relies on a tree structure which makes heavy use of *common prefixes*
it is basically a *compact* [*prefix tree*](https://en.wikipedia.org/wiki/Trie) 
(or just [*Radix tree*](https://en.wikipedia.org/wiki/Radix_tree)). 
Nodes with a common prefix also share a common parent. 
Here is a short example what the routing tree for the `GET` request method could look like:

Priority   Path             Handle
9          \                *<1>
3          â”œs               nil
2          |â”œearch\         *<2>
1          |â””upport\        *<3>
2          â”œblog\           *<4>
1          |    â””:post      nil
1          |         â””\     *<5>
2          â”œabout-us\       *<6>
1          |        â””team\  *<7>
1          â””contact\        *<8>
```

![](https://user-gold-cdn.xitu.io/2018/7/29/164e677416f3c865?w=1114&h=810&f=png&s=184182)

Rax è¢«ç”¨åœ¨ Redis Stream ç»“æ„é‡Œé¢ç”¨äºå­˜å‚¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåœ¨ Stream é‡Œé¢æ¶ˆæ¯ ID çš„å‰ç¼€æ˜¯æ—¶é—´æˆ³ + åºå·ï¼Œè¿™æ ·çš„æ¶ˆæ¯å¯ä»¥ç†è§£ä¸ºæ—¶é—´åºåˆ—æ¶ˆæ¯ã€‚ä½¿ç”¨ Rax ç»“æ„è¿›è¡Œå­˜å‚¨å°±å¯ä»¥å¿«é€Ÿåœ°æ ¹æ®æ¶ˆæ¯ ID å®šä½åˆ°å…·ä½“çš„æ¶ˆæ¯ï¼Œç„¶åç»§ç»­éå†æŒ‡å®šæ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯ã€‚

Rax è¢«ç”¨åœ¨ Redis Cluster ä¸­ç”¨æ¥è®°å½•æ§½ä½å’Œkeyçš„å¯¹åº”å…³ç³»ï¼Œè¿™ä¸ªå¯¹åº”å…³ç³»çš„å˜é‡åæˆå«ç€`slots_to_keys`ã€‚è¿™ä¸ªraxNodeçš„keyæ˜¯ç”±æ§½ä½ç¼–å·hashslotå’Œkeyç»„åˆè€Œæˆçš„ã€‚æˆ‘ä»¬çŸ¥é“clusterçš„æ§½ä½æ•°é‡æ˜¯16384ï¼Œå®ƒéœ€è¦2ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºï¼Œæ‰€ä»¥raxèŠ‚ç‚¹é‡Œå­˜çš„keyå°±æ˜¯2ä¸ªå­—èŠ‚çš„hashslotå’Œå¯¹è±¡keyæ‹¼æ¥èµ·æ¥çš„å­—ç¬¦ä¸²ã€‚

![](https://user-gold-cdn.xitu.io/2018/8/7/16513a606ebecb05?w=646&h=66&f=png&s=7952)

å› ä¸ºraxçš„keyæ˜¯æŒ‰ç…§keyå‰ç¼€é¡ºåºæŒ‚æ¥çš„ï¼Œæ„å‘³ç€åŒæ ·çš„hashslotçš„å¯¹è±¡keyå°†ä¼šæŒ‚åœ¨åŒä¸€ä¸ªraxNodeä¸‹é¢ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¿«é€Ÿéå†å…·ä½“æŸä¸ªæ§½ä½ä¸‹é¢çš„æ‰€æœ‰å¯¹è±¡keyã€‚


## ç»“æ„

rax ä¸­æœ‰éå¸¸å¤šçš„èŠ‚ç‚¹ï¼Œæ ¹èŠ‚ç‚¹ã€å¶èŠ‚ç‚¹å’Œä¸­é—´èŠ‚ç‚¹ï¼Œæœ‰äº›ä¸­é—´èŠ‚ç‚¹å¸¦æœ‰ valueï¼Œæœ‰äº›ä¸­é—´èŠ‚ç‚¹çº¯ç²¹æ˜¯ç»“æ„æ€§éœ€è¦æ²¡æœ‰å¯¹åº”çš„ valueã€‚

```c
struct raxNode {
    int<1> isKey; // æ˜¯å¦æ²¡æœ‰ keyï¼Œæ²¡æœ‰ key çš„æ˜¯æ ¹èŠ‚ç‚¹
    int<1> isNull; // æ˜¯å¦æ²¡æœ‰å¯¹åº”çš„ valueï¼Œæ— æ„ä¹‰çš„ä¸­é—´èŠ‚ç‚¹
    int<1> isCompressed; // æ˜¯å¦å‹ç¼©å­˜å‚¨ï¼Œè¿™ä¸ªå‹ç¼©çš„æ¦‚å¿µæ¯”è¾ƒç‰¹åˆ«
    int<29> size; // å­èŠ‚ç‚¹çš„æ•°é‡æˆ–è€…æ˜¯å‹ç¼©å­—ç¬¦ä¸²çš„é•¿åº¦ (isCompressed)
    byte[] data; // è·¯ç”±é”®ã€å­èŠ‚ç‚¹æŒ‡é’ˆã€value éƒ½åœ¨è¿™é‡Œ
}
```
rax æ˜¯ä¸€æ£µæ¯”è¾ƒç‰¹æ®Šçš„ radix treeï¼Œå®ƒåœ¨ç»“æ„ä¸Šä¸æ˜¯æ ‡å‡†çš„ radix treeã€‚å¦‚æœä¸€ä¸ªä¸­é—´èŠ‚ç‚¹æœ‰å¤šä¸ªå­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè·¯ç”±é”®å°±åªæ˜¯ä¸€ä¸ªå­—ç¬¦ã€‚å¦‚æœåªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè·¯ç”±é”®å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚åè€…å°±æ˜¯æ‰€è°“çš„ã€Œå‹ç¼©ã€å½¢å¼ï¼Œå¤šä¸ªå­—ç¬¦å‹åœ¨ä¸€èµ·çš„å­—ç¬¦ä¸²ã€‚æ¯”å¦‚å‰é¢çš„é‚£æ£µå­—å…¸æ ‘åœ¨ Rax ç®—æ³•ä¸­å°†å‘ˆç°å‡ºå¦‚ä¸‹ç»“æ„ï¼š

![](https://user-gold-cdn.xitu.io/2018/7/30/164e916ab956ec46?w=497&h=478&f=png&s=37646)

å›¾ä¸­çš„æ·±è“è‰²èŠ‚ç‚¹å°±æ˜¯ã€Œå‹ç¼©ã€èŠ‚ç‚¹ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å†ç»†çœ‹`raxNode.data`é‡Œé¢å­˜å‚¨çš„åˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„ç»“æ„ï¼ŒæŒ‰ç…§å‹ç¼©ä¸å¦åˆ†ä¸ºä¸¤ç§ç»“æ„

**å‹ç¼©ç»“æ„** å­èŠ‚ç‚¹å¦‚æœåªæœ‰ä¸€ä¸ªï¼Œé‚£å°±æ˜¯å‹ç¼©ç»“æ„ï¼Œdata å­—æ®µå¦‚ä¸‹ä¼ªä»£ç æ‰€ç¤ºï¼š
```c
struct data {
    optional struct { // å–å†³äº header çš„ size å­—æ®µæ˜¯å¦ä¸ºé›¶
        byte[] childKey; // è·¯ç”±é”®
        raxNode* childNode; // å­èŠ‚ç‚¹æŒ‡é’ˆ
    } child;
    optional string value; // å–å†³äº header çš„ isNull å­—æ®µ
}
```

![](https://user-gold-cdn.xitu.io/2018/7/30/164e94892c9df020?w=634&h=344&f=png&s=22925)

å¦‚æœæ˜¯å¶å­èŠ‚ç‚¹ï¼Œchild å­—æ®µå°±ä¸å­˜åœ¨ã€‚å¦‚æœæ˜¯æ— æ„ä¹‰çš„ä¸­é—´èŠ‚ç‚¹ (isNull)ï¼Œé‚£ä¹ˆ value å­—æ®µå°±ä¸å­˜åœ¨ã€‚

**éå‹ç¼©èŠ‚ç‚¹** å¦‚æœå­èŠ‚ç‚¹æœ‰å¤šä¸ªï¼Œé‚£å°±ä¸æ˜¯å‹ç¼©ç»“æ„ï¼Œå­˜åœ¨å¤šä¸ªè·¯ç”±é”®ï¼Œä¸€ä¸ªé”®æ˜¯ä¸€ä¸ªå­—ç¬¦ã€‚
```c
struct data {
    byte[] childKeys; // è·¯ç”±é”®å­—ç¬¦åˆ—è¡¨
    raxNode*[] childNodes; // å¤šä¸ªå­èŠ‚ç‚¹æŒ‡é’ˆ
    optional string value; // å–å†³äº header çš„ isNull å­—æ®µ
}
```

![](https://user-gold-cdn.xitu.io/2018/7/30/164e948b0d64b69f?w=755&h=431&f=png&s=29746)

ä¹Ÿè®¸ä½ ä¼šæƒ³åˆ°å¦‚æœå­èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªï¼Œå¹¶ä¸”è·¯ç”±é”®å­—ç¬¦ä¸²çš„é•¿åº¦ä¸º 1 å‘¢ï¼Œé‚£åˆ°åº•ç®—å‹ç¼©è¿˜æ˜¯éå‹ç¼©ï¼Ÿä»”ç»†æ€è€ƒä¸€ä¸‹ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‹ç¼©å’Œéå‹ç¼©åœ¨æ•°æ®ç»“æ„è¡¨ç°å½¢å¼ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œä¸ç®¡ isCompressed æ˜¯ 0 è¿˜å¥½æ˜¯ 1ï¼Œç»“æ„éƒ½æ˜¯ä¸€æ ·çš„ã€‚


## å¢åˆ èŠ‚ç‚¹

Rax çš„å¢åˆ èŠ‚ç‚¹é€»è¾‘éå¸¸å¤æ‚ï¼Œä»£ç é‡Œå……æ–¥äº†å¤ªå¤š`ifelse`é€»è¾‘ï¼Œè€å¸ˆæˆ‘çœ‹çš„æ˜¯æ™•å¤´è½¬å‘ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿå°±ä¸åˆ†æå®ƒçš„æºç äº†ï¼Œä»¥åè¦æ˜¯å½»åº•çœ‹æ‡‚äº†ï¼Œå†æ¥ç»§ç»­è·ŸåŒå­¦ä»¬åˆ†äº«å§ã€‚å¦‚æœå“ªä½åŒå­¦æƒ³æŒ‘æˆ˜ä¸€ä¸‹ï¼Œå¯ä»¥è¯•è¯•çœ‹ï¼

## æ€è€ƒ

è¿˜æœ‰å“ªäº›åœºåˆå¯ä»¥ä½¿ç”¨ radix treeï¼Ÿ
# æºç  8ï¼šç²¾ç›Šæ±‚ç²¾ â€”â€” LFU vs LRU

åœ¨ç¬¬ 27 å°èŠ‚ï¼Œæˆ‘ä»¬è®²åˆ°äº† Redis çš„ LRU æ¨¡å¼ï¼Œå®ƒå¯ä»¥æœ‰æ•ˆçš„æ§åˆ¶ Redis å ç”¨å†…å­˜å¤§å°ï¼Œå°†å†·æ•°æ®ä»å†…å­˜ä¸­æ·˜æ±°å‡ºå»ã€‚Antirez åœ¨ Redis 4.0 é‡Œå¼•å…¥äº†ä¸€ä¸ªæ–°çš„æ·˜æ±°ç­–ç•¥ â€”â€” LFU æ¨¡å¼ï¼Œä½œè€…è®¤ä¸ºå®ƒæ¯” LRU æ›´åŠ ä¼˜ç§€ã€‚

LFU çš„å…¨ç§°æ˜¯`Least Frequently Used`ï¼Œè¡¨ç¤ºæŒ‰æœ€è¿‘çš„è®¿é—®é¢‘ç‡è¿›è¡Œæ·˜æ±°ï¼Œå®ƒæ¯” LRU æ›´åŠ ç²¾å‡†åœ°è¡¨ç¤ºäº†ä¸€ä¸ª key è¢«è®¿é—®çš„çƒ­åº¦ã€‚

å¦‚æœä¸€ä¸ª key é•¿æ—¶é—´ä¸è¢«è®¿é—®ï¼Œåªæ˜¯åˆšåˆšå¶ç„¶è¢«ç”¨æˆ·è®¿é—®äº†ä¸€ä¸‹ï¼Œé‚£ä¹ˆåœ¨ä½¿ç”¨ LRU ç®—æ³•ä¸‹å®ƒæ˜¯ä¸å®¹æ˜“è¢«æ·˜æ±°çš„ï¼Œå› ä¸º LRU ç®—æ³•è®¤ä¸ºå½“å‰è¿™ä¸ª key æ˜¯å¾ˆçƒ­çš„ã€‚è€Œ LFU æ˜¯éœ€è¦è¿½è¸ªæœ€è¿‘ä¸€æ®µæ—¶é—´çš„è®¿é—®é¢‘ç‡ï¼Œå¦‚æœæŸä¸ª key åªæ˜¯å¶ç„¶è¢«è®¿é—®ä¸€æ¬¡æ˜¯ä¸è¶³ä»¥å˜å¾—å¾ˆçƒ­çš„ï¼Œå®ƒéœ€è¦åœ¨è¿‘æœŸä¸€æ®µæ—¶é—´å†…è¢«è®¿é—®å¾ˆå¤šæ¬¡æ‰æœ‰æœºä¼šè¢«è®¤ä¸ºå¾ˆçƒ­ã€‚

## Redis å¯¹è±¡çš„çƒ­åº¦

Redis çš„æ‰€æœ‰å¯¹è±¡ç»“æ„å¤´ä¸­éƒ½æœ‰ä¸€ä¸ª 24bit çš„å­—æ®µï¼Œè¿™ä¸ªå­—æ®µç”¨æ¥è®°å½•å¯¹è±¡çš„ã€Œçƒ­åº¦ã€ã€‚
```c
// redis çš„å¯¹è±¡å¤´
typedef struct redisObject {
    unsigned type:4; // å¯¹è±¡ç±»å‹å¦‚ zset/set/hash ç­‰ç­‰
    unsigned encoding:4; // å¯¹è±¡ç¼–ç å¦‚ ziplist/intset/skiplist ç­‰ç­‰
    unsigned lru:24; // å¯¹è±¡çš„ã€Œçƒ­åº¦ã€
    int refcount; // å¼•ç”¨è®¡æ•°
    void *ptr; // å¯¹è±¡çš„ body
} robj;
```

## LRU æ¨¡å¼

åœ¨ LRU æ¨¡å¼ä¸‹ï¼Œlru å­—æ®µå­˜å‚¨çš„æ˜¯ Redis æ—¶é’Ÿ`server.lruclock`ï¼ŒRedis æ—¶é’Ÿæ˜¯ä¸€ä¸ª 24bit çš„æ•´æ•°ï¼Œé»˜è®¤æ˜¯ Unix æ—¶é—´æˆ³å¯¹ 2^24 å–æ¨¡çš„ç»“æœï¼Œå¤§çº¦ 97 å¤©æ¸…é›¶ä¸€æ¬¡ã€‚å½“æŸä¸ª key è¢«è®¿é—®ä¸€æ¬¡ï¼Œå®ƒçš„å¯¹è±¡å¤´çš„ lru å­—æ®µå€¼å°±ä¼šè¢«æ›´æ–°ä¸º`server.lruclock`ã€‚

é»˜è®¤ Redis æ—¶é’Ÿå€¼æ¯æ¯«ç§’æ›´æ–°ä¸€æ¬¡ï¼Œåœ¨å®šæ—¶ä»»åŠ¡`serverCron`é‡Œä¸»åŠ¨è®¾ç½®ã€‚Redis çš„å¾ˆå¤šå®šæ—¶ä»»åŠ¡éƒ½æ˜¯åœ¨`serverCron`é‡Œé¢å®Œæˆçš„ï¼Œæ¯”å¦‚å¤§å‹ hash è¡¨çš„æ¸è¿›å¼è¿ç§»ã€è¿‡æœŸ key çš„ä¸»åŠ¨æ·˜æ±°ã€è§¦å‘ bgsaveã€bgaofrewrite ç­‰ç­‰ã€‚

å¦‚æœ`server.lruclock`æ²¡æœ‰æŠ˜è¿” (å¯¹ 2^24 å–æ¨¡)ï¼Œå®ƒå°±æ˜¯ä¸€ç›´é€’å¢çš„ï¼Œè¿™æ„å‘³ç€å¯¹è±¡çš„ LRU å­—æ®µä¸ä¼šè¶…è¿‡`server.lruclock`çš„å€¼ã€‚å¦‚æœè¶…è¿‡äº†ï¼Œè¯´æ˜`server.lruclock`æŠ˜è¿”äº†ã€‚é€šè¿‡è¿™ä¸ªé€»è¾‘å°±å¯ä»¥ç²¾å‡†è®¡ç®—å‡ºå¯¹è±¡å¤šé•¿æ—¶é—´æ²¡æœ‰è¢«è®¿é—®â€”â€”å¯¹è±¡çš„ç©ºé—²æ—¶é—´ã€‚

![](https://user-gold-cdn.xitu.io/2018/8/6/1650e756e1ce8b9a?w=1284&h=146&f=png&s=21164)

```c
// è®¡ç®—å¯¹è±¡çš„ç©ºé—²æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰è¢«è®¿é—®çš„æ—¶é—´ï¼Œè¿”å›ç»“æœæ˜¯æ¯«ç§’
unsigned long long estimateObjectIdleTime(robj *o) {
    unsigned long long lruclock = LRU_CLOCK(); // è·å– redis æ—¶é’Ÿï¼Œä¹Ÿå°±æ˜¯ server.lruclock çš„å€¼
    if (lruclock >= o->lru) {
        // æ­£å¸¸é€’å¢
        return (lruclock - o->lru) * LRU_CLOCK_RESOLUTION; // LRU_CLOCK_RESOLUTION é»˜è®¤æ˜¯ 1000
    } else {
        // æŠ˜è¿”äº†
        return (lruclock + (LRU_CLOCK_MAX - o->lru)) * // LRU_CLOCK_MAX æ˜¯ 2^24-1
                    LRU_CLOCK_RESOLUTION;
    }
}
```

æœ‰äº†å¯¹è±¡çš„ç©ºé—²æ—¶é—´ï¼Œå°±å¯ä»¥ç›¸äº’ä¹‹é—´è¿›è¡Œæ¯”è¾ƒè°æ–°è°æ—§ï¼Œéšæœº LRU ç®—æ³•é çš„å°±æ˜¯æ¯”è¾ƒå¯¹è±¡çš„ç©ºé—²æ—¶é—´æ¥å†³å®šè°è¯¥è¢«æ·˜æ±°äº†ã€‚

## LFU æ¨¡å¼

åœ¨ LFU æ¨¡å¼ä¸‹ï¼Œlru å­—æ®µ 24 ä¸ª bit ç”¨æ¥å­˜å‚¨ä¸¤ä¸ªå€¼ï¼Œåˆ†åˆ«æ˜¯`ldt(last decrement time)`å’Œ`logc(logistic counter)`ã€‚

![](https://user-gold-cdn.xitu.io/2018/8/6/1650e8f382f31205?w=601&h=93&f=png&s=10013)

logc æ˜¯ 8 ä¸ª bitï¼Œç”¨æ¥å­˜å‚¨è®¿é—®é¢‘æ¬¡ï¼Œå› ä¸º 8 ä¸ª bit èƒ½è¡¨ç¤ºçš„æœ€å¤§æ•´æ•°å€¼ä¸º 255ï¼Œå­˜å‚¨é¢‘æ¬¡è‚¯å®šè¿œè¿œä¸å¤Ÿï¼Œæ‰€ä»¥è¿™ 8 ä¸ª bit å­˜å‚¨çš„æ˜¯é¢‘æ¬¡çš„å¯¹æ•°å€¼ï¼Œå¹¶ä¸”è¿™ä¸ªå€¼è¿˜ä¼šéšæ—¶é—´è¡°å‡ã€‚å¦‚æœå®ƒçš„å€¼æ¯”è¾ƒå°ï¼Œé‚£ä¹ˆå°±å¾ˆå®¹æ˜“è¢«å›æ”¶ã€‚ä¸ºäº†ç¡®ä¿æ–°åˆ›å»ºçš„å¯¹è±¡ä¸è¢«å›æ”¶ï¼Œæ–°å¯¹è±¡çš„è¿™ 8 ä¸ª bit ä¼šåˆå§‹åŒ–ä¸ºä¸€ä¸ªå¤§äºé›¶çš„å€¼ï¼Œé»˜è®¤æ˜¯`LFU_INIT_VAL=5`ã€‚

![](https://user-gold-cdn.xitu.io/2018/8/6/1650e9c135644d19?w=1298&h=150&f=png&s=23124)

ldt æ˜¯ 16 ä¸ªä½ï¼Œç”¨æ¥å­˜å‚¨ä¸Šä¸€æ¬¡ logc çš„æ›´æ–°æ—¶é—´ï¼Œå› ä¸ºåªæœ‰ 16 ä½ï¼Œæ‰€ä»¥ç²¾åº¦ä¸å¯èƒ½å¾ˆé«˜ã€‚å®ƒå–çš„æ˜¯åˆ†é’Ÿæ—¶é—´æˆ³å¯¹ 2^16 è¿›è¡Œå–æ¨¡ï¼Œå¤§çº¦æ¯éš” 45 å¤©å°±ä¼šæŠ˜è¿”ã€‚åŒ LRU æ¨¡å¼ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªé€»è¾‘è®¡ç®—å‡ºå¯¹è±¡çš„ç©ºé—²æ—¶é—´ï¼Œåªä¸è¿‡ç²¾åº¦æ˜¯åˆ†é’Ÿçº§åˆ«çš„ã€‚å›¾ä¸­çš„ server.unixtime æ˜¯å½“å‰ redis è®°å½•çš„ç³»ç»Ÿæ—¶é—´æˆ³ï¼Œå’Œ server.lruclock ä¸€æ ·ï¼Œå®ƒä¹Ÿæ˜¯æ¯æ¯«ç§’æ›´æ–°ä¸€æ¬¡ã€‚
```c
// nowInMinutes
// server.unixtime ä¸º redis ç¼“å­˜çš„ç³»ç»Ÿæ—¶é—´æˆ³
unsigned long LFUGetTimeInMinutes(void) {
    return (server.unixtime/60) & 65535;
}

// idle_in_minutes
unsigned long LFUTimeElapsed(unsigned long ldt) {
    unsigned long now = LFUGetTimeInMinutes();
    if (now >= ldt) return now-ldt; // æ­£å¸¸æ¯”è¾ƒ
    return 65535-ldt+now; // æŠ˜è¿”æ¯”è¾ƒ
}
```

ldt çš„å€¼å’Œ LRU æ¨¡å¼çš„ lru å­—æ®µä¸ä¸€æ ·çš„æ˜¯ ldt ä¸æ˜¯åœ¨å¯¹è±¡è¢«è®¿é—®æ—¶æ›´æ–°çš„ã€‚å®ƒåœ¨ Redis çš„æ·˜æ±°é€»è¾‘è¿›è¡Œæ—¶è¿›è¡Œæ›´æ–°ï¼Œæ·˜æ±°é€»è¾‘åªä¼šåœ¨å†…å­˜è¾¾åˆ° maxmemory çš„è®¾ç½®æ—¶æ‰ä¼šè§¦å‘ï¼Œåœ¨æ¯ä¸€ä¸ªæŒ‡ä»¤çš„æ‰§è¡Œä¹‹å‰éƒ½ä¼šè§¦å‘ã€‚æ¯æ¬¡æ·˜æ±°éƒ½æ˜¯é‡‡ç”¨éšæœºç­–ç•¥ï¼ŒéšæœºæŒ‘é€‰è‹¥å¹²ä¸ª keyï¼Œæ›´æ–°è¿™ä¸ª key çš„ã€Œçƒ­åº¦ã€ï¼Œæ·˜æ±°æ‰ã€Œçƒ­åº¦ã€æœ€ä½çš„ã€‚å› ä¸º Redis é‡‡ç”¨çš„æ˜¯éšæœºç®—æ³•ï¼Œå¦‚æœ key æ¯”è¾ƒå¤šçš„è¯ï¼Œé‚£ä¹ˆ ldt æ›´æ–°çš„å¯èƒ½ä¼šæ¯”è¾ƒæ…¢ã€‚ä¸è¿‡æ—¢ç„¶å®ƒæ˜¯åˆ†é’Ÿçº§åˆ«çš„ç²¾åº¦ï¼Œä¹Ÿæ²¡æœ‰å¿…è¦æ›´æ–°çš„è¿‡äºé¢‘ç¹ã€‚

ldt æ›´æ–°çš„åŒæ—¶ä¹Ÿä¼šä¸€åŒè¡°å‡ logc çš„å€¼ï¼Œè¡°å‡ä¹Ÿæœ‰ç‰¹å®šçš„ç®—æ³•ã€‚å®ƒå°†ç°æœ‰çš„ logc å€¼å‡å»å¯¹è±¡çš„ç©ºé—²æ—¶é—´ (åˆ†é’Ÿæ•°) é™¤ä»¥ä¸€ä¸ªè¡°å‡ç³»æ•°ï¼Œé»˜è®¤è¿™ä¸ªè¡°å‡ç³»æ•°`lfu_decay_time`æ˜¯ 1ã€‚å¦‚æœè¿™ä¸ªå€¼å¤§äº 1ï¼Œé‚£ä¹ˆå°±ä¼šè¡°å‡çš„æ¯”è¾ƒæ…¢ã€‚å¦‚æœå®ƒç­‰äºé›¶ï¼Œé‚£å°±è¡¨ç¤ºä¸è¡°å‡ï¼Œå®ƒæ˜¯å¯ä»¥é€šè¿‡é…ç½®å‚æ•°`lfu-decay-time`è¿›è¡Œé…ç½®ã€‚
```c
// è¡°å‡ logc
unsigned long LFUDecrAndReturn(robj *o) {
    unsigned long ldt = o->lru >> 8; // å‰ 16bit
    unsigned long counter = o->lru & 255; // å 8bit ä¸º logc
    // num_periods ä¸ºå³å°†è¡°å‡çš„æ•°é‡
    unsigned long num_periods = server.lfu_decay_time ? LFUTimeElapsed(ldt) / server.lfu_decay_time : 0;
    if (num_periods)
        counter = (num_periods > counter) ? 0 : counter - num_periods;
    return counter;
}
```

logc çš„æ›´æ–°å’Œ LRU æ¨¡å¼çš„ lru å­—æ®µä¸€æ ·ï¼Œéƒ½ä¼šåœ¨ key æ¯æ¬¡è¢«è®¿é—®çš„æ—¶å€™æ›´æ–°ï¼Œåªä¸è¿‡å®ƒçš„æ›´æ–°ä¸æ˜¯ç®€å•çš„`+1`ï¼Œè€Œæ˜¯é‡‡ç”¨æ¦‚ç‡æ³•è¿›è¡Œé€’å¢ï¼Œå› ä¸º logc å­˜å‚¨çš„æ˜¯è®¿é—®è®¡æ•°çš„å¯¹æ•°å€¼ï¼Œä¸èƒ½ç›´æ¥`+1`ã€‚
```c
/* Logarithmically increment a counter. The greater is the current counter value
 * the less likely is that it gets really implemented. Saturate it at 255. */
// å¯¹æ•°é€’å¢è®¡æ•°å€¼
uint8_t LFULogIncr(uint8_t counter) {
    if (counter == 255) return 255; // åˆ°æœ€å¤§å€¼äº†ï¼Œä¸èƒ½åœ¨å¢åŠ äº†
    double baseval = counter - LFU_INIT_VAL; // å‡å»æ–°å¯¹è±¡åˆå§‹åŒ–çš„åŸºæ•°å€¼ (LFU_INIT_VAL é»˜è®¤æ˜¯ 5)
    // baseval å¦‚æœå°äºé›¶ï¼Œè¯´æ˜è¿™ä¸ªå¯¹è±¡å¿«ä¸è¡Œäº†ï¼Œä¸è¿‡æœ¬æ¬¡ incr å°†ä¼šå»¶é•¿å®ƒçš„å¯¿å‘½
    if (baseval < 0) baseval = 0; 
    // å½“å‰è®¡æ•°è¶Šå¤§ï¼Œæƒ³è¦ +1 å°±è¶Šå›°éš¾
    // lfu_log_factor ä¸ºå›°éš¾ç³»æ•°ï¼Œé»˜è®¤æ˜¯ 10
    // å½“ baseval ç‰¹åˆ«å¤§æ—¶ï¼Œæœ€å¤§æ˜¯ (255-5)ï¼Œp å€¼ä¼šéå¸¸å°ï¼Œå¾ˆéš¾ä¼šèµ°åˆ° counter++ è¿™ä¸€æ­¥
    // p å°±æ˜¯ counter é€šå¾€ [+1] æƒåŠ›çš„é—¨ç¼ï¼Œbaseval è¶Šå¤§ï¼Œè¿™ä¸ªé—¨ç¼è¶Šçª„ï¼Œé€šè¿‡å°±è¶Šè‰°éš¾
    double p = 1.0/(baseval*server.lfu_log_factor+1);
    // å¼€å§‹éšæœºçœ‹çœ‹èƒ½ä¸èƒ½ä»é—¨ç¼æŒ¤è¿›å»
    double r = (double)rand()/RAND_MAX; // 0 < r < 1
    if (r < p) counter++;
    return counter;
}
```

## ä¸ºä»€ä¹ˆ Redis è¦ç¼“å­˜ç³»ç»Ÿæ—¶é—´æˆ³ï¼Ÿ

æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨ç³»ç»Ÿæ—¶é—´æˆ³æ—¶ï¼Œå¸¸å¸¸æ˜¯ä¸å‡æ€ç´¢åœ°ä½¿ç”¨`System.currentTimeInMillis`æˆ–è€…`time.time()`æ¥è·å–ç³»ç»Ÿçš„æ¯«ç§’æ—¶é—´æˆ³ã€‚Redis ä¸èƒ½è¿™æ ·ï¼Œå› ä¸ºæ¯ä¸€æ¬¡è·å–ç³»ç»Ÿæ—¶é—´æˆ³éƒ½æ˜¯ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œç³»ç»Ÿè°ƒç”¨ç›¸å¯¹æ¥è¯´æ˜¯æ¯”è¾ƒè´¹æ—¶é—´çš„ï¼Œä½œä¸ºå•çº¿ç¨‹çš„ Redis è¡¨ç¤ºæ‰¿å—ä¸èµ·ï¼Œæ‰€ä»¥å®ƒéœ€è¦å¯¹æ—¶é—´è¿›è¡Œç¼“å­˜ï¼Œè·å–æ—¶é—´éƒ½ç›´æ¥ä»ç¼“å­˜ä¸­ç›´æ¥æ‹¿ã€‚

## redis ä¸ºä»€ä¹ˆåœ¨è·å– lruclock æ—¶ä½¿ç”¨åŸå­æ“ä½œï¼Ÿ

æˆ‘ä»¬çŸ¥é“ Redis æ˜¯å•çº¿ç¨‹çš„ï¼Œé‚£ä¸ºä»€ä¹ˆ lruclock è¦ä½¿ç”¨åŸå­æ“ä½œ atomicGet æ¥è·å–å‘¢ï¼Ÿ
```c
unsigned int LRU_CLOCK(void) {
    unsigned int lruclock;
    if (1000/server.hz <= LRU_CLOCK_RESOLUTION) {
        // è¿™é‡ŒåŸå­æ“ä½œï¼Œé€šå¸¸ä¼šèµ°è¿™é‡Œï¼Œæˆ‘ä»¬åªéœ€è¦æ³¨æ„è¿™é‡Œ
        atomicGet(server.lruclock,lruclock);  
    } else {
        // ç›´æ¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨è·å–æ—¶é—´æˆ³ï¼Œhz é…ç½®çš„å¤ªä½ (ä¸€èˆ¬ä¸ä¼šè¿™ä¹ˆå¹²)ï¼Œlruclock æ›´æ–°ä¸åŠæ—¶ï¼Œéœ€è¦å®æ—¶è·å–ç³»ç»Ÿæ—¶é—´æˆ³
        lruclock = getLRUClock(); 
    }
    return lruclock;
}
```
å› ä¸º Redis å®é™…ä¸Šå¹¶ä¸æ˜¯å•çº¿ç¨‹ï¼Œå®ƒèƒŒåè¿˜æœ‰å‡ ä¸ªå¼‚æ­¥çº¿ç¨‹ä¹Ÿåœ¨é»˜é»˜å·¥ä½œã€‚è¿™å‡ ä¸ªçº¿ç¨‹ä¹Ÿè¦è®¿é—® Redis æ—¶é’Ÿï¼Œæ‰€ä»¥ lruclock å­—æ®µæ˜¯éœ€è¦æ”¯æŒå¤šçº¿ç¨‹è¯»å†™çš„ã€‚ä½¿ç”¨ atomic è¯»å†™èƒ½ä¿è¯å¤šçº¿ç¨‹ lruclock æ•°æ®çš„ä¸€è‡´æ€§ã€‚

## å¦‚ä½•æ‰“å¼€ LFU æ¨¡å¼ï¼Ÿ

Redis 4.0 ç»™æ·˜æ±°ç­–ç•¥é…ç½®å‚æ•°`maxmemory-policy`å¢åŠ äº† 2 ä¸ªé€‰é¡¹ï¼Œåˆ†åˆ«æ˜¯ volatile-lfu å’Œ allkeys-lfuï¼Œåˆ†åˆ«æ˜¯å¯¹å¸¦è¿‡æœŸæ—¶é—´çš„ key è¿›è¡Œ lfu æ·˜æ±°ä»¥åŠå¯¹æ‰€æœ‰çš„ key æ‰§è¡Œ lfu æ·˜æ±°ç®—æ³•ã€‚æ‰“å¼€äº†è¿™ä¸ªé€‰é¡¹ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨ `object freq`æŒ‡ä»¤è·å–å¯¹è±¡çš„ lfu è®¡æ•°å€¼äº†ã€‚
```
> config set maxmemory-policy allkeys-lfu
OK
> set codehole yeahyeahyeah
OK
// è·å–è®¡æ•°å€¼ï¼Œåˆå§‹åŒ–ä¸º LFU_INIT_VAL=5
> object freq codehole
(integer) 5
// è®¿é—®ä¸€æ¬¡
> get codehole
"yeahyeahyeah"
// è®¡æ•°å€¼å¢åŠ äº†
> object freq codehole
(integer) 6
```

## æ€è€ƒé¢˜
1. ä½ èƒ½å°è¯•ä½¿ç”¨ py æˆ–è€… Java å†™ä¸€ä¸ªç®€å•çš„ LFU ç®—æ³•ä¹ˆï¼Ÿ
2. å¦‚æœä¸€å¼€å§‹ä½¿ç”¨ LRU æ¨¡å¼ï¼Œçªç„¶æ”¹å˜é…ç½®å˜æˆäº† LFU æ¨¡å¼ï¼Œæƒ³è±¡ä¸€ä¸‹ Redis å¯¹è±¡å¤´çš„ lru å­—æ®µå€¼ï¼Œä¼šå¯¹ç°æœ‰çš„å¯¹è±¡äº§ç”Ÿä»€ä¹ˆå½±å“ï¼Ÿ
# æºç  9: å¦‚å±¥è–„å†° â€”â€” æ‡’æƒ°åˆ é™¤çš„å·¨å¤§ç‰ºç‰²

å‰é¢æˆ‘ä»¬è®²äº† Redis æ‡’æƒ°åˆ é™¤çš„ç‰¹æ€§ï¼Œå®ƒæ˜¯ä½¿ç”¨å¼‚æ­¥çº¿ç¨‹å¯¹å·²åˆ é™¤çš„èŠ‚ç‚¹è¿›è¡Œå†…å­˜å›æ”¶ã€‚ä½†æ˜¯è¿˜ä¸å¤Ÿæ·±å…¥ï¼Œæ‰€ä»¥æœ¬èŠ‚æˆ‘ä»¬è¦å¯¹å¼‚æ­¥çº¿ç¨‹é€»è¾‘å¤„ç†çš„ç»†èŠ‚è¿›è¡Œåˆ†æï¼Œçœ‹çœ‹ Antirez æ˜¯å¦‚ä½•å®ç°å¼‚æ­¥çº¿ç¨‹å¤„ç†çš„ã€‚

å¼‚æ­¥çº¿ç¨‹åœ¨ Redis å†…éƒ¨æœ‰ä¸€ä¸ªç‰¹åˆ«çš„åç§°ï¼Œå®ƒå°±æ˜¯`BIO`ï¼Œå…¨ç§°æ˜¯`Background IO`ï¼Œæ„æ€æ˜¯åœ¨èƒŒåé»˜é»˜å¹²æ´»çš„ IO çº¿ç¨‹ã€‚ä¸è¿‡å†…å­˜å›æ”¶æœ¬èº«å¹¶ä¸æ˜¯ä»€ä¹ˆ IO æ“ä½œï¼Œåªæ˜¯ CPU çš„è®¡ç®—æ¶ˆè€—å¯èƒ½ä¼šæ¯”è¾ƒå¤§è€Œå·²ã€‚

## æ‡’æƒ°åˆ é™¤çš„æœ€åˆå®ç°ä¸æ˜¯å¼‚æ­¥çº¿ç¨‹

Antirez å®ç°æ‡’æƒ°åˆ é™¤æ—¶ï¼Œå®ƒå¹¶ä¸æ˜¯ä¸€å¼€å§‹å°±æƒ³åˆ°äº†å¼‚æ­¥çº¿ç¨‹ã€‚æœ€åˆçš„å°è¯•æ˜¯åœ¨ä¸»çº¿ç¨‹é‡Œï¼Œä½¿ç”¨ç±»ä¼¼äºå­—å…¸æ¸è¿›å¼æ¬è¿é‚£æ ·æ¥å®ç°æ¸è¿›å¼åˆ é™¤å›æ”¶ã€‚æ¯”å¦‚å¯¹äºä¸€ä¸ªéå¸¸å¤§çš„å­—å…¸æ¥è¯´ï¼Œæ‡’æƒ°åˆ é™¤æ˜¯é‡‡ç”¨ç±»ä¼¼äº scan æ“ä½œçš„æ–¹æ³•ï¼Œé€šè¿‡éå†ç¬¬ä¸€ç»´æ•°ç»„æ¥é€æ­¥åˆ é™¤å›æ”¶ç¬¬äºŒç»´é“¾è¡¨çš„å†…å®¹ï¼Œç­‰åˆ°æ‰€æœ‰é“¾è¡¨éƒ½å›æ”¶å®Œäº†ï¼Œå†ä¸€æ¬¡æ€§å›æ”¶ç¬¬ä¸€ç»´æ•°ç»„ã€‚è¿™æ ·ä¹Ÿå¯ä»¥è¾¾åˆ°åˆ é™¤å¤§å¯¹è±¡æ—¶ä¸é˜»å¡ä¸»çº¿ç¨‹çš„æ•ˆæœã€‚

ä½†æ˜¯è¯´èµ·æ¥å®¹æ˜“åšèµ·æ¥å´å¾ˆéš¾ã€‚æ¸è¿›å¼å›æ”¶éœ€è¦ä»”ç»†æ§åˆ¶å›æ”¶é¢‘ç‡ï¼Œå®ƒä¸èƒ½å›æ”¶çš„å¤ªçŒ›ï¼Œè¿™ä¼šå¯¼è‡´ CPU èµ„æºå ç”¨è¿‡å¤šï¼Œä¹Ÿä¸èƒ½å›æ”¶çš„èœ—ç‰›æ…¢ï¼Œå› ä¸ºå†…å­˜å›æ”¶ä¸åŠæ—¶å¯èƒ½å¯¼è‡´å†…å­˜æŒç»­å¢é•¿ã€‚

Antirez éœ€è¦é‡‡ç”¨åˆé€‚çš„è‡ªé€‚åº”ç®—æ³•æ¥æ§åˆ¶å›æ”¶é¢‘ç‡ã€‚ä»–é¦–å…ˆæƒ³åˆ°çš„æ˜¯æ£€æµ‹å†…å­˜å¢é•¿çš„è¶‹åŠ¿æ˜¯å¢é•¿ (+1) è¿˜æ˜¯ä¸‹é™ (-1) æ¥æ¸è¿›å¼è°ƒæ•´å›æ”¶é¢‘ç‡ç³»æ•°ï¼Œè¿™æ ·çš„è‡ªé€‚åº”ç®—æ³•å®ç°ä¹Ÿå¾ˆç®€å•ã€‚ä½†æ˜¯æµ‹è¯•åå‘ç°åœ¨æœåŠ¡ç¹å¿™çš„æ—¶å€™ï¼ŒQPS ä¼šä¸‹é™åˆ°æ­£å¸¸æƒ…å†µä¸‹ 65% çš„æ°´å¹³ï¼Œè¿™ç‚¹éå¸¸è‡´å‘½ã€‚

æ‰€ä»¥ Antirez æ‰ä½¿ç”¨äº†å¦‚ä»Šä½¿ç”¨çš„æ–¹æ¡ˆâ€”â€”å¼‚æ­¥çº¿ç¨‹ã€‚å¼‚æ­¥çº¿ç¨‹è¿™å¥—æ–¹æ¡ˆå°±ç®€å•å¤šäº†ï¼Œé‡Šæ”¾å†…å­˜ä¸ç”¨ä¸ºæ¯ç§æ•°æ®ç»“æ„é€‚é…ä¸€å¥—æ¸è¿›å¼é‡Šæ”¾ç­–ç•¥ï¼Œä¹Ÿä¸ç”¨æä¸ªè‡ªé€‚åº”ç®—æ³•æ¥ä»”ç»†æ§åˆ¶å›æ”¶é¢‘ç‡ã€‚å°†å¯¹è±¡ä»å…¨å±€å­—å…¸ä¸­æ‘˜æ‰ï¼Œç„¶åå¾€é˜Ÿåˆ—é‡Œä¸€æ‰”ï¼Œä¸»çº¿ç¨‹å°±å¹²åˆ«çš„å»äº†ã€‚å¼‚æ­¥çº¿ç¨‹ä»é˜Ÿåˆ—é‡Œå–å‡ºå¯¹è±¡æ¥ï¼Œç›´æ¥èµ°æ­£å¸¸çš„åŒæ­¥é‡Šæ”¾é€»è¾‘å°±å¯ä»¥äº†ã€‚

ä¸è¿‡ä½¿ç”¨å¼‚æ­¥çº¿ç¨‹ä¹Ÿæ˜¯æœ‰ä»£ä»·çš„ï¼Œä¸»çº¿ç¨‹å’Œå¼‚æ­¥çº¿ç¨‹ä¹‹é—´åœ¨å†…å­˜å›æ”¶å™¨ (jemalloc) çš„ä½¿ç”¨ä¸Šå­˜åœ¨ç«äº‰ã€‚è¿™ç‚¹ç«äº‰æ¶ˆè€—æ˜¯å¯ä»¥å¿½ç•¥ä¸è®¡çš„ï¼Œå› ä¸º Redis çš„ä¸»çº¿ç¨‹åœ¨å†…å­˜çš„åˆ†é…ä¸å›æ”¶ä¸ŠèŠ±çš„æ—¶é—´ç›¸å¯¹æ•´ä½“è¿ç®—æ—¶é—´è€Œè¨€æ˜¯æå°‘çš„ã€‚

## å¼‚æ­¥çº¿ç¨‹æ–¹æ¡ˆå…¶å®ä¹Ÿç›¸å½“å¤æ‚

åˆšæ‰ä¸Šé¢è¯´å¼‚æ­¥çº¿ç¨‹æ–¹æ¡ˆå¾ˆç®€å•ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œåˆè¯´å®ƒå¾ˆå¤æ‚å‘¢ï¼Ÿå› ä¸ºæœ‰ä¸€ç‚¹æˆ‘ä»¬ä¹‹å‰æ²¡æœ‰æƒ³åˆ°ã€‚è¿™ç‚¹éå¸¸å¯æ€•ï¼Œä¸¥é‡é˜»ç¢äº†å¼‚æ­¥çº¿ç¨‹æ–¹æ¡ˆçš„æ”¹é€ ï¼Œé‚£å°±æ˜¯ Redis çš„å†…éƒ¨å¯¹è±¡æœ‰å…±äº«æœºåˆ¶ã€‚

æ¯”å¦‚é›†åˆçš„å¹¶é›†æ“ä½œ `sunionstore` ç”¨æ¥å°†å¤šä¸ªé›†åˆåˆå¹¶æˆä¸€ä¸ªæ–°é›†åˆ
```
> sadd src1 value1 value2 value3
(integer) 3
> sadd src2 value3 value4 value5
(integer) 3
> sunionstore dest src1 src2
(integer) 5
> smembers dest
1) "value2"
2) "value3"
3) "value1"
4) "value4"
5) "value5"
```
æˆ‘ä»¬çœ‹åˆ°æ–°çš„é›†åˆåŒ…å«äº†æ—§é›†åˆçš„æ‰€æœ‰å…ƒç´ ã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªæˆ‘ä»¬æ²¡çœ‹åˆ°çš„ trickã€‚é‚£å°±æ˜¯åº•å±‚çš„å­—ç¬¦ä¸²å¯¹è±¡è¢«å…±äº«äº†ã€‚

![](https://user-gold-cdn.xitu.io/2018/8/7/165133443f6216c8?w=697&h=372&f=png&s=29829)

ä¸ºä»€ä¹ˆå¯¹è±¡å…±äº«æ˜¯æ‡’æƒ°åˆ é™¤çš„å·¨å¤§éšœç¢å‘¢ï¼Ÿå› ä¸ºæ‡’æƒ°åˆ é™¤ç›¸å½“äºå½»åº•ç æ‰æŸä¸ªæ ‘æï¼Œå°†å®ƒæ‰”åˆ°å¼‚æ­¥åˆ é™¤é˜Ÿåˆ—é‡Œå»ã€‚æ³¨æ„è¿™é‡Œå¿…é¡»æ˜¯å½»åº•åˆ é™¤ï¼Œè€Œä¸èƒ½è—•æ–­ä¸è¿ã€‚å¦‚æœåº•å±‚å¯¹è±¡æ˜¯å…±äº«çš„ï¼Œé‚£å°±åšä¸åˆ°å½»åº•åˆ é™¤ã€‚

![](https://user-gold-cdn.xitu.io/2018/8/7/165133bdc0df4a14?w=671&h=332&f=png&s=35963)

æ‰€ä»¥ Antirez ä¸ºäº†æ”¯æŒæ‡’æƒ°åˆ é™¤ï¼Œå°†å¯¹è±¡å…±äº«æœºåˆ¶å½»åº•æŠ›å¼ƒï¼Œå®ƒå°†è¿™ç§å¯¹è±¡ç»“æ„ç§°ä¸ºã€Œshare-nothingã€ï¼Œä¹Ÿå°±æ˜¯æ— å…±äº«è®¾è®¡ã€‚ä½†æ˜¯ç”©æ‰å¯¹è±¡å…±äº«è°ˆä½•å®¹æ˜“ï¼è¿™ç§å¯¹è±¡å…±äº«æœºåˆ¶æ•£è½åœ¨æºä»£ç çš„å„ä¸ªè§’è½ï¼Œç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ï¼Œæ”¹èµ·æ¥çŠ¹å¦‚åœ¨å¸ƒæ»¡åœ°é›·çš„é“è·¯ä¸Šå°å¿ƒç¿¼ç¿¼åœ°è¡Œèµ°ã€‚

ä¸è¿‡ Antirez è¿˜æ˜¯å†³å¿ƒæ”¹äº†ï¼Œä»–å°†è¿™ç§æ”¹åŠ¨æè¿°ä¸ºã€Œç»æœ›è€Œç–¯ç‹‚ã€ï¼Œå¯è§æ”¹åŠ¨ä¹‹å¤§ä¹‹æ·±ä¹‹é™©ï¼Œå‰åèŠ±äº†å¥½å‡ å‘¨çš„æ—¶é—´æ‰æ”¹å®Œã€‚ä¸è¿‡æ•ˆæœä¹Ÿæ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œå¯¹è±¡çš„åˆ é™¤æ“ä½œå†ä¹Ÿä¸ä¼šå¯¼è‡´ä¸»çº¿ç¨‹å¡é¡¿äº†ã€‚

## å¼‚æ­¥åˆ é™¤çš„å®ç°

ä¸»çº¿ç¨‹éœ€è¦å°†åˆ é™¤ä»»åŠ¡ä¼ é€’ç»™å¼‚æ­¥çº¿ç¨‹ï¼Œå®ƒæ˜¯é€šè¿‡ä¸€ä¸ªæ™®é€šçš„åŒå‘é“¾è¡¨æ¥ä¼ é€’çš„ã€‚å› ä¸ºé“¾è¡¨éœ€è¦æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘æ“ä½œï¼Œæ‰€ä»¥å®ƒéœ€è¦æœ‰é”æ¥ä¿æŠ¤ã€‚

æ‰§è¡Œæ‡’æƒ°åˆ é™¤æ—¶ï¼ŒRedis å°†åˆ é™¤æ“ä½œçš„ç›¸å…³å‚æ•°å°è£…æˆä¸€ä¸ª`bio_job`ç»“æ„ï¼Œç„¶åè¿½åŠ åˆ°é“¾è¡¨å°¾éƒ¨ã€‚å¼‚æ­¥çº¿ç¨‹é€šè¿‡éå†é“¾è¡¨æ‘˜å– job å…ƒç´ æ¥æŒ¨ä¸ªæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ã€‚

```c
struct bio_job {
    time_t time;  // æ—¶é—´å­—æ®µæš‚æ—¶æ²¡æœ‰ä½¿ç”¨ï¼Œåº”è¯¥æ˜¯é¢„ç•™çš„
    void *arg1, *arg2, *arg3;
};
```

æˆ‘ä»¬æ³¨æ„åˆ°è¿™ä¸ª job ç»“æ„æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œä¸ºä»€ä¹ˆåˆ é™¤å¯¹è±¡éœ€è¦ä¸‰ä¸ªå‚æ•°å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­çœ‹ä»£ç ï¼š

```c
    /* What we free changes depending on what arguments are set:
     * arg1 -> free the object at pointer.
     * arg2 & arg3 -> free two dictionaries (a Redis DB).
     * only arg3 -> free the skiplist. */
    if (job->arg1)
        // é‡Šæ”¾ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œstring/set/zset/hash ç­‰ç­‰ï¼Œç”¨äºæ™®é€šå¯¹è±¡çš„å¼‚æ­¥åˆ é™¤
        lazyfreeFreeObjectFromBioThread(job->arg1);
    else if (job->arg2 && job->arg3)
        // é‡Šæ”¾å…¨å±€ redisDb å¯¹è±¡çš„ dict å­—å…¸å’Œ expires å­—å…¸ï¼Œç”¨äº flushdb
        lazyfreeFreeDatabaseFromBioThread(job->arg2,job->arg3);
    else if (job->arg3)
        // é‡Šæ”¾ Cluster çš„ slots_to_keys å¯¹è±¡ï¼Œå‚è§æºç ç¯‡çš„ã€ŒåŸºæ•°æ ‘ã€å°èŠ‚
        lazyfreeFreeSlotsMapFromBioThread(job->arg3);
```

å¯ä»¥çœ‹åˆ°é€šè¿‡ç»„åˆè¿™ä¸‰ä¸ªå‚æ•°å¯ä»¥å®ç°ä¸åŒç»“æ„çš„é‡Šæ”¾é€»è¾‘ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­è¿½è¸ªæ™®é€šå¯¹è±¡çš„å¼‚æ­¥åˆ é™¤`lazyfreeFreeObjectFromBioThread`æ˜¯å¦‚ä½•è¿›è¡Œçš„ï¼Œè¯·ä»”ç»†é˜…è¯»ä»£ç æ³¨é‡Šã€‚

```c
void lazyfreeFreeObjectFromBioThread(robj *o) {
    decrRefCount(o); // é™ä½å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œå¦‚æœä¸ºé›¶ï¼Œå°±é‡Šæ”¾
    atomicDecr(lazyfree_objects,1); // lazyfree_objects ä¸ºå¾…é‡Šæ”¾å¯¹è±¡çš„æ•°é‡ï¼Œç”¨äºç»Ÿè®¡
}

// å‡å°‘å¼•ç”¨è®¡æ•°
void decrRefCount(robj *o) {
    if (o->refcount == 1) {
        // è¯¥é‡Šæ”¾å¯¹è±¡äº†
        switch(o->type) {
        case OBJ_STRING: freeStringObject(o); break;
        case OBJ_LIST: freeListObject(o); break;
        case OBJ_SET: freeSetObject(o); break;
        case OBJ_ZSET: freeZsetObject(o); break;
        case OBJ_HASH: freeHashObject(o); break;  // é‡Šæ”¾ hash å¯¹è±¡ï¼Œç»§ç»­è¿½è¸ª
        case OBJ_MODULE: freeModuleObject(o); break;
        case OBJ_STREAM: freeStreamObject(o); break;
        default: serverPanic("Unknown object type"); break;
        }
        zfree(o);
    } else {
        if (o->refcount <= 0) serverPanic("decrRefCount against refcount <= 0");
        if (o->refcount != OBJ_SHARED_REFCOUNT) o->refcount--; // å¼•ç”¨è®¡æ•°å‡ 1
    }
}

// é‡Šæ”¾ hash å¯¹è±¡
void freeHashObject(robj *o) {
    switch (o->encoding) {
    case OBJ_ENCODING_HT:
        // é‡Šæ”¾å­—å…¸ï¼Œæˆ‘ä»¬ç»§ç»­è¿½è¸ª
        dictRelease((dict*) o->ptr);
        break;
    case OBJ_ENCODING_ZIPLIST:
        // å¦‚æœæ˜¯å‹ç¼©åˆ—è¡¨å¯ä»¥ç›´æ¥é‡Šæ”¾
        // å› ä¸ºå‹ç¼©åˆ—è¡¨æ˜¯ä¸€æ•´å—å­—èŠ‚æ•°ç»„
        zfree(o->ptr);
        break;
    default:
        serverPanic("Unknown hash encoding type");
        break;
    }
}

// é‡Šæ”¾å­—å…¸ï¼Œå¦‚æœå­—å…¸æ­£åœ¨è¿ç§»ä¸­ï¼Œht[0] å’Œ ht[1] åˆ†åˆ«å­˜å‚¨æ—§å­—å…¸å’Œæ–°å­—å…¸
void dictRelease(dict *d)
{
    _dictClear(d,&d->ht[0],NULL); // ç»§ç»­è¿½è¸ª
    _dictClear(d,&d->ht[1],NULL);
    zfree(d);
}

// è¿™é‡Œè¦é‡Šæ”¾ hashtable äº†
// éœ€è¦éå†ç¬¬ä¸€ç»´æ•°ç»„ï¼Œç„¶åç»§ç»­éå†ç¬¬äºŒç»´é“¾è¡¨ï¼ŒåŒé‡å¾ªç¯
int _dictClear(dict *d, dictht *ht, void(callback)(void *)) {
    unsigned long i;

    /* Free all the elements */
    for (i = 0; i < ht->size && ht->used > 0; i++) {
        dictEntry *he, *nextHe;

        if (callback && (i & 65535) == 0) callback(d->privdata);

        if ((he = ht->table[i]) == NULL) continue;
        while(he) {
            nextHe = he->next;
            dictFreeKey(d, he); // å…ˆé‡Šæ”¾ key
            dictFreeVal(d, he); // å†é‡Šæ”¾ value
            zfree(he); // æœ€åé‡Šæ”¾ entry
            ht->used--;
            he = nextHe;
        }
    }
    /* Free the table and the allocated cache structure */
    zfree(ht->table); // å¯ä»¥å›æ”¶ç¬¬ä¸€ç»´æ•°ç»„äº†
    /* Re-initialize the table */
    _dictReset(ht);
    return DICT_OK; /* never fails */
}
```
è¿™äº›ä»£ç æ•£è½åœ¨å¤šä¸ªä¸åŒçš„æ–‡ä»¶ï¼Œæˆ‘å°†å®ƒä»¬å‡‘åˆ°äº†ä¸€å—ä¾¿äºè¯»è€…é˜…è¯»ã€‚ä»ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é‡Šæ”¾ä¸€ä¸ªå¯¹è±¡è¦æ·±åº¦è°ƒç”¨ä¸€ç³»åˆ—å‡½æ•°ï¼Œæ¯ç§å¯¹è±¡éƒ½æœ‰å®ƒç‹¬ç‰¹çš„å†…å­˜å›æ”¶é€»è¾‘ã€‚

## é˜Ÿåˆ—å®‰å…¨

å‰é¢æåˆ°ä»»åŠ¡é˜Ÿåˆ—æ˜¯ä¸€ä¸ªä¸å®‰å…¨çš„åŒå‘é“¾è¡¨ï¼Œéœ€è¦ä½¿ç”¨é”æ¥ä¿æŠ¤å®ƒã€‚å½“ä¸»çº¿ç¨‹å°†ä»»åŠ¡è¿½åŠ åˆ°é˜Ÿåˆ—ä¹‹å‰å®ƒéœ€è¦åŠ é”ï¼Œè¿½åŠ å®Œæ¯•åï¼Œå†é‡Šæ”¾é”ï¼Œè¿˜éœ€è¦å”¤é†’å¼‚æ­¥çº¿ç¨‹ï¼Œå¦‚æœå®ƒåœ¨ä¼‘çœ çš„è¯ã€‚
```c
void bioCreateBackgroundJob(int type, void *arg1, void *arg2, void *arg3) {
    struct bio_job *job = zmalloc(sizeof(*job));

    job->time = time(NULL);
    job->arg1 = arg1;
    job->arg2 = arg2;
    job->arg3 = arg3;
    pthread_mutex_lock(&bio_mutex[type]); // åŠ é”
    listAddNodeTail(bio_jobs[type],job); // è¿½åŠ ä»»åŠ¡
    bio_pending[type]++; // è®¡æ•°
    pthread_cond_signal(&bio_newjob_cond[type]); // å”¤é†’å¼‚æ­¥çº¿ç¨‹
    pthread_mutex_unlock(&bio_mutex[type]); // é‡Šæ”¾é”
}
```

å¼‚æ­¥çº¿ç¨‹éœ€è¦å¯¹ä»»åŠ¡é˜Ÿåˆ—è¿›è¡Œè½®è®­å¤„ç†ï¼Œä¾æ¬¡ä»é“¾è¡¨è¡¨å¤´æ‘˜å–å…ƒç´ é€ä¸ªå¤„ç†ã€‚æ‘˜å–å…ƒç´ çš„æ—¶å€™ä¹Ÿéœ€è¦åŠ é”ï¼Œæ‘˜å‡ºæ¥ä¹‹åå†è§£é”ã€‚å¦‚æœä¸€ä¸ªå…ƒç´ éƒ½æ²¡æœ‰ï¼Œå®ƒéœ€è¦ç­‰å¾…ï¼Œç›´åˆ°ä¸»çº¿ç¨‹æ¥å”¤é†’å®ƒç»§ç»­å·¥ä½œã€‚

```c
// å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œé€»è¾‘
void *bioProcessBackgroundJobs(void *arg) {
...
    pthread_mutex_lock(&bio_mutex[type]); // å…ˆåŠ é”
    ...
    // å¾ªç¯å¤„ç†
    while(1) {
        listNode *ln;

        /* The loop always starts with the lock hold. */
        if (listLength(bio_jobs[type]) == 0) {
            // å¯¹åˆ—ç©ºï¼Œé‚£å°±ç¡è§‰å§
            pthread_cond_wait(&bio_newjob_cond[type],&bio_mutex[type]);
            continue;
        }
        /* Pop the job from the queue. */
        ln = listFirst(bio_jobs[type]); // è·å–é˜Ÿåˆ—å¤´å…ƒç´ 
        job = ln->value;
        /* It is now possible to unlock the background system as we know have
         * a stand alone job structure to process.*/
        pthread_mutex_unlock(&bio_mutex[type]); // é‡Šæ”¾é”

        // è¿™é‡Œæ˜¯å¤„ç†è¿‡ç¨‹ï¼Œä¸ºäº†çœçº¸ï¼Œå°±ç•¥å»äº†
        ...
        
        // é‡Šæ”¾ä»»åŠ¡å¯¹è±¡
        zfree(job);

        ...
        
        // å†æ¬¡åŠ é”ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªå…ƒç´ 
        pthread_mutex_lock(&bio_mutex[type]);
        // å› ä¸ºä»»åŠ¡å·²ç»å¤„ç†å®Œäº†ï¼Œå¯ä»¥æ”¾å¿ƒä»é“¾è¡¨ä¸­åˆ é™¤èŠ‚ç‚¹äº†
        listDelNode(bio_jobs[type],ln);
        bio_pending[type]--; // è®¡æ•°å‡ 1
    }
```

ç ”ç©¶å®Œè¿™äº›åŠ é”è§£é”çš„ä»£ç åï¼Œæˆ‘å¼€å§‹æœ‰ç‚¹å½“å¿ƒä¸»çº¿ç¨‹çš„æ€§èƒ½ã€‚æˆ‘ä»¬éƒ½çŸ¥é“åŠ é”è§£é”æ˜¯ä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼Œå°¤å…¶æ˜¯æ‚²è§‚é”æœ€ä¸ºè€—æ—¶ã€‚å¦‚æœåˆ é™¤å¾ˆé¢‘ç¹ï¼Œä¸»çº¿ç¨‹å²‚ä¸æ˜¯è¦é¢‘ç¹åŠ é”è§£é”ã€‚æ‰€ä»¥è¿™é‡Œè‚¯å®šè¿˜æœ‰ä¼˜åŒ–ç©ºé—´ï¼ŒJava çš„ ConcurrentLinkQueue å°±æ²¡æœ‰ä½¿ç”¨è¿™æ ·ç²—ç²’åº¦çš„æ‚²è§‚é”ï¼Œå®ƒä¼˜å…ˆä½¿ç”¨ cas æ¥æ§åˆ¶å¹¶å‘ã€‚

## æ€è€ƒ

1. Redis è¿˜æœ‰å…¶å®ƒåœ°æ–¹ç”¨åˆ°äº†å¯¹è±¡å…±äº«æœºåˆ¶ä¹ˆï¼Ÿ
2. Java çš„ ConcurrentLinkQueue å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ
# æºç  10ï¼šè·‹å±±æ¶‰æ°´ â€”â€” æ·±å…¥å­—å…¸éå†

Redis å­—å…¸çš„éå†è¿‡ç¨‹é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œäº’è”ç½‘ä¸Šå¯¹è¿™ä¸€å—çš„åˆ†æè®²è§£éå¸¸å°‘ã€‚æˆ‘ä¹ŸèŠ±äº†ä¸å°‘æ—¶é—´å¯¹æºç çš„ç»†èŠ‚è¿›è¡Œäº†æ•´ç†ï¼Œå°†æˆ‘ä¸ªäººå¯¹å­—å…¸éå†é€»è¾‘çš„ç†è§£å‘ˆç°ç»™å„ä½è¯»è€…ã€‚ä¹Ÿè®¸è¯»è€…ä»¬å¯¹å­—å…¸çš„éå†è¿‡ç¨‹æœ‰æ¯”æˆ‘æ›´å¥½çš„ç†è§£ï¼Œè¿˜è¯·ä¸åæŒ‡æ•™ã€‚


![](https://user-gold-cdn.xitu.io/2018/8/15/1653bd1a8cbe5f4d?w=485&h=370&f=png&s=31214)

## ä¸€è¾¹éå†ä¸€è¾¹ä¿®æ”¹

æˆ‘ä»¬çŸ¥é“ Redis å¯¹è±¡æ ‘çš„ä¸»å¹²æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œå¦‚æœå¯¹è±¡å¾ˆå¤šï¼Œè¿™ä¸ªä¸»å¹²å­—å…¸ä¹Ÿä¼šå¾ˆå¤§ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ `keys` å‘½ä»¤æœå¯»æŒ‡å®šæ¨¡å¼çš„ key æ—¶ï¼Œå®ƒä¼šéå†æ•´ä¸ªä¸»å¹²å­—å…¸ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨éå†çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ»¡è¶³æ¨¡å¼åŒ¹é…æ¡ä»¶çš„ key è¢«æ‰¾åˆ°äº†ï¼Œè¿˜éœ€è¦åˆ¤æ–­ key æŒ‡å‘çš„å¯¹è±¡æ˜¯å¦å·²ç»è¿‡æœŸã€‚å¦‚æœè¿‡æœŸäº†å°±éœ€è¦ä»ä¸»å¹²å­—å…¸ä¸­å°†è¯¥ key åˆ é™¤ã€‚

```c
void keysCommand(client *c) {
    dictIterator *di; // è¿­ä»£å™¨
    dictEntry *de; // è¿­ä»£å™¨å½“å‰çš„entry
    sds pattern = c->argv[1]->ptr; // keysçš„åŒ¹é…æ¨¡å¼å‚æ•°
    int plen = sdslen(pattern);
    int allkeys; // æ˜¯å¦è¦è·å–æ‰€æœ‰keyï¼Œç”¨äºkeys *è¿™æ ·çš„æŒ‡ä»¤
    unsigned long numkeys = 0;
    void *replylen = addDeferredMultiBulkLength(c);

    // why safe? 
    di = dictGetSafeIterator(c->db->dict);
    allkeys = (pattern[0] == '*' && pattern[1] == '\0');
    while((de = dictNext(di)) != NULL) {
        sds key = dictGetKey(de);
        robj *keyobj;

        if (allkeys || stringmatchlen(pattern,plen,key,sdslen(key),0)) {
            keyobj = createStringObject(key,sdslen(key));
            // åˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼Œè¿‡æœŸäº†è¦åˆ é™¤å…ƒç´ 
            if (expireIfNeeded(c->db,keyobj) == 0) {
                addReplyBulk(c,keyobj);
                numkeys++;
            }
            decrRefCount(keyobj);
        }
    }
    dictReleaseIterator(di);
    setDeferredMultiBulkLength(c,replylen,numkeys);
}
```

é‚£ä¹ˆï¼Œä½ æ˜¯å¦æƒ³åˆ°äº†å…¶ä¸­çš„å›°éš¾ä¹‹å¤„ï¼Œåœ¨éå†å­—å…¸çš„æ—¶å€™è¿˜éœ€è¦ä¿®æ”¹å­—å…¸ï¼Œä¼šä¸ä¼šå‡ºç°æŒ‡é’ˆå®‰å…¨é—®é¢˜ï¼Ÿ

## é‡å¤éå†

å­—å…¸åœ¨æ‰©å®¹çš„æ—¶å€™è¦è¿›è¡Œæ¸è¿›å¼è¿ç§»ï¼Œä¼šå­˜åœ¨æ–°æ—§ä¸¤ä¸ª hashtableã€‚éå†éœ€è¦å¯¹è¿™ä¸¤ä¸ª hashtable ä¾æ¬¡è¿›è¡Œï¼Œå…ˆéå†å®Œæ—§çš„ hashtableï¼Œå†ç»§ç»­éå†æ–°çš„ hashtableã€‚å¦‚æœåœ¨éå†çš„è¿‡ç¨‹ä¸­è¿›è¡Œäº† rehashStepï¼Œå°†å·²ç»éå†è¿‡çš„æ—§çš„ hashtable çš„å…ƒç´ è¿ç§»åˆ°äº†æ–°çš„ hashtable ä¸­ï¼Œé‚£ä¹ˆéå†ä¼šä¸ä¼šå‡ºç°å…ƒç´ çš„é‡å¤ï¼Ÿè¿™ä¹Ÿæ˜¯éå†éœ€è¦è€ƒè™‘çš„ç–‘éš¾ä¹‹å¤„ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ Redis æ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚

## è¿­ä»£å™¨çš„ç»“æ„

Redis ä¸ºå­—å…¸çš„éå†æä¾›äº† 2 ç§è¿­ä»£å™¨ï¼Œä¸€ç§æ˜¯å®‰å…¨è¿­ä»£å™¨ï¼Œå¦ä¸€ç§æ˜¯ä¸å®‰å…¨è¿­ä»£å™¨ã€‚

```c
typedef struct dictIterator {
    dict *d; // ç›®æ ‡å­—å…¸å¯¹è±¡
    long index; // å½“å‰éå†çš„æ§½ä½ç½®ï¼Œåˆå§‹åŒ–ä¸º-1
    int table; // ht[0] or ht[1]
    int safe; // è¿™ä¸ªå±æ€§éå¸¸å…³é”®ï¼Œå®ƒè¡¨ç¤ºè¿­ä»£å™¨æ˜¯å¦å®‰å…¨
    dictEntry *entry; // è¿­ä»£å™¨å½“å‰æŒ‡å‘çš„å¯¹è±¡
    dictEntry *nextEntry; // è¿­ä»£å™¨ä¸‹ä¸€ä¸ªæŒ‡å‘çš„å¯¹è±¡
    long long fingerprint; // è¿­ä»£å™¨æŒ‡çº¹ï¼Œæ”¾ç½®è¿­ä»£è¿‡ç¨‹ä¸­å­—å…¸è¢«ä¿®æ”¹
} dictIterator;

// è·å–éå®‰å…¨è¿­ä»£å™¨ï¼Œåªè¯»è¿­ä»£å™¨ï¼Œå…è®¸rehashStep
dictIterator *dictGetIterator(dict *d)
{
    dictIterator *iter = zmalloc(sizeof(*iter));

    iter->d = d;
    iter->table = 0;
    iter->index = -1;
    iter->safe = 0;
    iter->entry = NULL;
    iter->nextEntry = NULL;
    return iter;
}

// è·å–å®‰å…¨è¿­ä»£å™¨ï¼Œå…è®¸è§¦å‘è¿‡æœŸå¤„ç†ï¼Œç¦æ­¢rehashStep
dictIterator *dictGetSafeIterator(dict *d) {
    dictIterator *i = dictGetIterator(d);

    i->safe = 1;
    return i;
}
```

è¿­ä»£å™¨çš„ã€Œå®‰å…¨ã€æŒ‡çš„æ˜¯åœ¨éå†è¿‡ç¨‹ä¸­å¯ä»¥å¯¹å­—å…¸è¿›è¡ŒæŸ¥æ‰¾å’Œä¿®æ”¹ï¼Œä¸ç”¨æ„Ÿåˆ°æ‹…å¿ƒï¼Œå› ä¸ºæŸ¥æ‰¾å’Œä¿®æ”¹ä¼šè§¦å‘è¿‡æœŸåˆ¤æ–­ï¼Œä¼šåˆ é™¤å†…éƒ¨å…ƒç´ ã€‚ã€Œå®‰å…¨ã€çš„å¦ä¸€å±‚æ„æ€æ˜¯è¿­ä»£è¿‡ç¨‹ä¸­ä¸ä¼šå‡ºç°å…ƒç´ é‡å¤ï¼Œä¸ºäº†ä¿è¯ä¸é‡å¤ï¼Œå°±ä¼šç¦æ­¢ rehashStepã€‚

è€Œã€Œä¸å®‰å…¨ã€çš„è¿­ä»£å™¨æ˜¯æŒ‡éå†è¿‡ç¨‹ä¸­å­—å…¸æ˜¯åªè¯»çš„ï¼Œä½ ä¸å¯ä»¥ä¿®æ”¹ï¼Œä½ åªèƒ½è°ƒç”¨ dictNext å¯¹å­—å…¸è¿›è¡ŒæŒç»­éå†ï¼Œä¸å¾—è°ƒç”¨ä»»ä½•å¯èƒ½è§¦å‘è¿‡æœŸåˆ¤æ–­çš„å‡½æ•°ã€‚ä¸è¿‡å¥½å¤„æ˜¯ä¸å½±å“ rehashï¼Œä»£ä»·å°±æ˜¯éå†çš„å…ƒç´ å¯èƒ½ä¼šå‡ºç°é‡å¤ã€‚

å®‰å…¨è¿­ä»£å™¨åœ¨åˆšå¼€å§‹éå†æ—¶ï¼Œä¼šç»™å­—å…¸æ‰“ä¸Šä¸€ä¸ªæ ‡è®°ï¼Œæœ‰äº†è¿™ä¸ªæ ‡è®°ï¼ŒrehashStep å°±ä¸ä¼šæ‰§è¡Œï¼Œéå†æ—¶å…ƒç´ å°±ä¸ä¼šå‡ºç°é‡å¤ã€‚

```c
typedef struct dict {
    dictType *type;
    void *privdata;
    dictht ht[2];
    long rehashidx;
    // è¿™ä¸ªå°±æ˜¯æ ‡è®°ï¼Œå®ƒè¡¨ç¤ºå½“å‰åŠ åœ¨å­—å…¸ä¸Šçš„å®‰å…¨è¿­ä»£å™¨çš„æ•°é‡
    unsigned long iterators;
} dict;

// å¦‚æœå­˜åœ¨å®‰å…¨çš„è¿­ä»£å™¨ï¼Œå°±ç¦æ­¢rehash
static void _dictRehashStep(dict *d) {
    if (d->iterators == 0) dictRehash(d,1);
}
```

## è¿­ä»£è¿‡ç¨‹

å®‰å…¨çš„è¿­ä»£å™¨åœ¨éå†è¿‡ç¨‹ä¸­å…è®¸åˆ é™¤å…ƒç´ ï¼Œæ„å‘³ç€å­—å…¸ç¬¬ä¸€ç»´æ•°ç»„ä¸‹é¢æŒ‚æ¥çš„é“¾è¡¨ä¸­çš„å…ƒç´ å¯èƒ½ä¼šè¢«æ‘˜èµ°ï¼Œå…ƒç´ çš„ next æŒ‡é’ˆå°±ä¼šå‘ç”Ÿå˜åŠ¨ï¼Œè¿™æ˜¯å¦ä¼šå½±å“è¿­ä»£è¿‡ç¨‹å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬ä»”ç»†ç ”ç©¶ä¸€ä¸‹è¿­ä»£å‡½æ•°çš„ä»£ç é€»è¾‘ã€‚

```
dictEntry *dictNext(dictIterator *iter)
{
    while (1) {
        if (iter->entry == NULL) {
            // éå†ä¸€ä¸ªæ–°æ§½ä½ä¸‹é¢çš„é“¾è¡¨ï¼Œæ•°ç»„çš„indexå¾€å‰ç§»åŠ¨äº†
            dictht *ht = &iter->d->ht[iter->table];
            if (iter->index == -1 && iter->table == 0) {
                // ç¬¬ä¸€æ¬¡éå†ï¼Œåˆšåˆšè¿›å…¥éå†è¿‡ç¨‹
                // ä¹Ÿå°±æ˜¯ht[0]æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸‹é¢çš„é“¾è¡¨
                if (iter->safe) {
                  // ç»™å­—å…¸æ‰“å®‰å…¨æ ‡è®°ï¼Œç¦æ­¢å­—å…¸è¿›è¡Œrehash
                  iter->d->iterators++;
                } else {
                  // è®°å½•è¿­ä»£å™¨æŒ‡çº¹ï¼Œå°±å¥½æ¯”å­—å…¸çš„md5å€¼
                  // å¦‚æœéå†è¿‡ç¨‹ä¸­å­—å…¸æœ‰ä»»ä½•å˜åŠ¨ï¼ŒæŒ‡çº¹å°±ä¼šæ”¹å˜
                  iter->fingerprint = dictFingerprint(iter->d);
                }      
            }
            iter->index++; // index=0ï¼Œæ­£å¼è¿›å…¥ç¬¬ä¸€ä¸ªæ§½ä½
            if (iter->index >= (long) ht->size) {
                // æœ€åä¸€ä¸ªæ§½ä½éƒ½éå†å®Œäº†
                if (dictIsRehashing(iter->d) && iter->table == 0) {
                    // å¦‚æœå¤„äºrehashä¸­ï¼Œé‚£å°±ç»§ç»­éå†ç¬¬äºŒä¸ª hashtable
                    iter->table++;
                    iter->index = 0;
                    ht = &iter->d->ht[1];
                } else {
                    // ç»“æŸéå†
                    break;
                }
            }
            // å°†å½“å‰éå†çš„å…ƒç´ è®°å½•åˆ°è¿­ä»£å™¨ä¸­
            iter->entry = ht->table[iter->index];
        } else {
            // ç›´æ¥å°†ä¸‹ä¸€ä¸ªå…ƒç´ è®°å½•ä¸ºæœ¬æ¬¡è¿­ä»£çš„å…ƒç´ 
            iter->entry = iter->nextEntry;
        }
        if (iter->entry) {
            // å°†ä¸‹ä¸€ä¸ªå…ƒç´ ä¹Ÿè®°å½•åˆ°è¿­ä»£å™¨ä¸­ï¼Œè¿™ç‚¹éå¸¸å…³é”®
            // é˜²æ­¢å®‰å…¨è¿­ä»£è¿‡ç¨‹ä¸­å½“å‰å…ƒç´ è¢«è¿‡æœŸåˆ é™¤åï¼Œæ‰¾ä¸åˆ°ä¸‹ä¸€ä¸ªéœ€è¦éå†çš„å…ƒç´ 
            
            // è¯•æƒ³å¦‚æœåé¢å‘ç”Ÿäº†rehashï¼Œå½“å‰éå†çš„é“¾è¡¨è¢«æ‰“æ•£äº†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆ
            // è¿™é‡Œè¦ä½¿åŠ²å‘æŒ¥è‡ªå·±çš„æƒ³è±¡åŠ›æ¥ç†è§£
            // æ—§çš„é“¾è¡¨å°†ä¸€åˆ†ä¸ºäºŒï¼Œæ‰“æ•£åé‡æ–°æŒ‚æ¥åˆ°æ–°æ•°ç»„çš„ä¸¤ä¸ªæ§½ä½ä¸‹
            // ç»“æœå°±æ˜¯ä¼šå¯¼è‡´å½“å‰é“¾è¡¨ä¸Šçš„å…ƒç´ ä¼šé‡å¤éå†
            
            // å¦‚æœrehashçš„é“¾è¡¨æ˜¯indexå‰é¢çš„é“¾è¡¨ï¼Œé‚£ä¹ˆè¿™éƒ¨åˆ†é“¾è¡¨ä¹Ÿä¼šè¢«é‡å¤éå†
            iter->nextEntry = iter->entry->next;
            return iter->entry;
        }
    }
    return NULL;
}

// éå†å®Œæˆåè¦é‡Šæ”¾è¿­ä»£å™¨ï¼Œå®‰å…¨è¿­ä»£å™¨éœ€è¦å»æ‰å­—å…¸çš„ç¦æ­¢rehashçš„æ ‡è®°
// éå®‰å…¨è¿­ä»£å™¨è¿˜éœ€è¦æ£€æŸ¥æŒ‡çº¹ï¼Œå¦‚æœæœ‰å˜åŠ¨ï¼ŒæœåŠ¡å™¨å°±ä¼šå¥”æºƒ(failfast)
void dictReleaseIterator(dictIterator *iter)
{
    if (!(iter->index == -1 && iter->table == 0)) {
        if (iter->safe)
            iter->d->iterators--; // å»æ‰ç¦æ­¢rehashçš„æ ‡è®°
        else
            assert(iter->fingerprint == dictFingerprint(iter->d));
    }
    zfree(iter);
}

// è®¡ç®—å­—å…¸çš„æŒ‡çº¹ï¼Œå°±æ˜¯å°†å­—å…¸çš„å…³é”®å­—æ®µè¿›è¡ŒæŒ‰ä½ç³…åˆåˆ°ä¸€èµ·
// è¿™æ ·åªè¦æœ‰ä»»æ„çš„ç»“æ„å˜åŠ¨ï¼ŒæŒ‡çº¹éƒ½ä¼šå‘ç”Ÿå˜åŒ–
// å¦‚æœåªæ˜¯æŸä¸ªå…ƒç´ çš„valueè¢«ä¿®æ”¹äº†ï¼ŒæŒ‡çº¹ä¸ä¼šå‘ç”Ÿå˜åŠ¨
long long dictFingerprint(dict *d) {
    long long integers[6], hash = 0;
    int j;

    integers[0] = (long) d->ht[0].table;
    integers[1] = d->ht[0].size;
    integers[2] = d->ht[0].used;
    integers[3] = (long) d->ht[1].table;
    integers[4] = d->ht[1].size;
    integers[5] = d->ht[1].used;

    for (j = 0; j < 6; j++) {
        hash += integers[j];
        hash = (~hash) + (hash << 21);
        hash = hash ^ (hash >> 24);
        hash = (hash + (hash << 3)) + (hash << 8);
        hash = hash ^ (hash >> 14);
        hash = (hash + (hash << 2)) + (hash << 4);
        hash = hash ^ (hash >> 28);
        hash = hash + (hash << 31);
    }
    return hash;
}
```

å€¼å¾—æ³¨æ„çš„æ˜¯åœ¨å­—å…¸æ‰©å®¹æ—¶è¿›è¡Œ rehashï¼Œå°†æ—§æ•°ç»„ä¸­çš„é“¾è¡¨è¿ç§»åˆ°æ–°çš„æ•°ç»„ä¸­ã€‚æŸä¸ªå…·ä½“æ§½ä½ä¸‹çš„é“¾è¡¨åªå¯èƒ½ä¼šè¿ç§»åˆ°æ–°æ•°ç»„çš„ä¸¤ä¸ªæ§½ä½ä¸­ã€‚

```
hash mod 2^n = k
hash mod 2^(n+1) = k or k+2^n
```

## è¿­ä»£å™¨çš„é€‰æ‹©

é™¤äº† `keys` æŒ‡ä»¤ä½¿ç”¨äº†å®‰å…¨è¿­ä»£å™¨ï¼Œå› ä¸ºç»“æœä¸å…è®¸é‡å¤ã€‚é‚£è¿˜æœ‰å…¶å®ƒçš„åœ°æ–¹ä½¿ç”¨äº†å®‰å…¨è¿­ä»£å™¨ä¹ˆï¼Œä»€ä¹ˆæƒ…å†µä¸‹éå†é€‚åˆä½¿ç”¨éå®‰å…¨è¿­ä»£å™¨å‘¢ï¼Ÿ

ç®€å•ä¸€ç‚¹è¯´ï¼Œé‚£å°±æ˜¯å¦‚æœéå†è¿‡ç¨‹ä¸­ä¸å…è®¸å‡ºç°é‡å¤ï¼Œé‚£å°±ä½¿ç”¨ `SafeIterator`ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¸¤ç§æƒ…å†µ

1. `bgaofrewrite` éœ€è¦éå†æ‰€æœ‰å¯¹è±¡è½¬æ¢ç§°æ“ä½œæŒ‡ä»¤è¿›è¡ŒæŒä¹…åŒ–ï¼Œç»å¯¹ä¸å…è®¸å‡ºç°é‡å¤
2. `bgsave` ä¹Ÿéœ€è¦éå†æ‰€æœ‰å¯¹è±¡æ¥æŒä¹…åŒ–ï¼ŒåŒæ ·ä¸å…è®¸å‡ºç°é‡å¤

å¦‚æœéå†è¿‡ç¨‹ä¸­éœ€è¦å¤„ç†å…ƒç´ è¿‡æœŸï¼Œéœ€è¦å¯¹å­—å…¸è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹Ÿå¿…é¡»ä½¿ç”¨ `SafeIterator`ï¼Œå› ä¸ºéå®‰å…¨çš„è¿­ä»£å™¨æ˜¯åªè¯»çš„ã€‚

å…¶å®ƒæƒ…å†µä¸‹ï¼Œä¹Ÿå°±æ˜¯å…è®¸éå†è¿‡ç¨‹ä¸­å‡ºç°ä¸ªåˆ«å…ƒç´ é‡å¤ï¼Œä¸éœ€è¦å¯¹å­—å…¸è¿›è¡Œç»“æ„æ€§ä¿®æ”¹çš„æƒ…å†µä¸‹ä¸€å¾‹ä½¿ç”¨éå®‰å…¨è¿­ä»£å™¨ã€‚

## æ€è€ƒ

è¯·ç»§ç»­æ€è€ƒ `rehash` å¯¹éå®‰å…¨éå†è¿‡ç¨‹çš„å½±å“ï¼Œä¼šé‡å¤å“ªäº›å…ƒç´ ï¼Œé‡å¤çš„å…ƒç´ ä¼šéå¸¸å¤šä¹ˆè¿˜æ˜¯åªæ˜¯å°‘é‡é‡å¤ï¼Ÿ
# æºç  11ï¼šè§ç¼æ’é’ˆ â€”â€” æ¢ç´¢ HyperLogLog å†…éƒ¨

HyperLogLogç®—æ³•æ˜¯ä¸€ç§éå¸¸å·§å¦™çš„è¿‘ä¼¼ç»Ÿè®¡æµ·é‡å»é‡å…ƒç´ æ•°é‡çš„ç®—æ³•ã€‚å®ƒå†…éƒ¨ç»´æŠ¤äº† 16384 ä¸ªæ¡¶ï¼ˆbucketï¼‰æ¥è®°å½•å„è‡ªæ¡¶çš„å…ƒç´ æ•°é‡ã€‚å½“ä¸€ä¸ªå…ƒç´ åˆ°æ¥æ—¶ï¼Œå®ƒä¼šæ•£åˆ—åˆ°å…¶ä¸­ä¸€ä¸ªæ¡¶ï¼Œä»¥ä¸€å®šçš„æ¦‚ç‡å½±å“è¿™ä¸ªæ¡¶çš„è®¡æ•°å€¼ã€‚å› ä¸ºæ˜¯æ¦‚ç‡ç®—æ³•ï¼Œæ‰€ä»¥å•ä¸ªæ¡¶çš„è®¡æ•°å€¼å¹¶ä¸å‡†ç¡®ï¼Œä½†æ˜¯å°†æ‰€æœ‰çš„æ¡¶è®¡æ•°å€¼è¿›è¡Œè°ƒåˆå‡å€¼ç´¯åŠ èµ·æ¥ï¼Œç»“æœå°±ä¼šéå¸¸æ¥è¿‘çœŸå®çš„è®¡æ•°å€¼ã€‚


![](https://user-gold-cdn.xitu.io/2018/8/31/1658e5a000b63be7?w=1448&h=604&f=png&s=68760)

ä¸ºäº†ä¾¿äºç†è§£HyperLogLogç®—æ³•ï¼Œæˆ‘ä»¬å…ˆç®€åŒ–å®ƒçš„è®¡æ•°é€»è¾‘ã€‚å› ä¸ºæ˜¯å»é‡è®¡æ•°ï¼Œå¦‚æœæ˜¯å‡†ç¡®çš„å»é‡ï¼Œè‚¯å®šéœ€è¦ç”¨åˆ° set é›†åˆï¼Œä½¿ç”¨é›†åˆæ¥è®°å½•æ‰€æœ‰çš„å…ƒç´ ï¼Œç„¶åä½¿ç”¨ scard æŒ‡ä»¤æ¥è·å–é›†åˆå¤§å°å°±å¯ä»¥å¾—åˆ°æ€»çš„è®¡æ•°ã€‚å› ä¸ºå…ƒç´ ç‰¹åˆ«å¤šï¼Œå•ä¸ªé›†åˆä¼šç‰¹åˆ«å¤§ï¼Œæ‰€ä»¥å°†é›†åˆæ‰“æ•£æˆ 16384 ä¸ªå°é›†åˆã€‚å½“å…ƒç´ åˆ°æ¥æ—¶ï¼Œé€šè¿‡ hash ç®—æ³•å°†è¿™ä¸ªå…ƒç´ åˆ†æ´¾åˆ°å…¶ä¸­çš„ä¸€ä¸ªå°é›†åˆå­˜å‚¨ï¼ŒåŒæ ·çš„å…ƒç´ æ€»æ˜¯ä¼šæ•£åˆ—åˆ°åŒæ ·çš„å°é›†åˆã€‚è¿™æ ·æ€»çš„è®¡æ•°å°±æ˜¯æ‰€æœ‰å°é›†åˆå¤§å°çš„æ€»å’Œã€‚ä½¿ç”¨è¿™ç§æ–¹å¼ç²¾ç¡®è®¡æ•°é™¤äº†å¯ä»¥å¢åŠ å…ƒç´ å¤–ï¼Œè¿˜å¯ä»¥å‡å°‘å…ƒç´ ã€‚

ç”¨ Python ä»£ç æè¿°å¦‚ä¸‹

```py
# coding:utf-8
import hashlib

class ExactlyCounter:

    def __init__(self):
        # å…ˆåˆ†é…16384ä¸ªç©ºé›†åˆ
        self.buckets = []
        for i in range(16384):
            self.buckets.append(set([]))
        # ä½¿ç”¨md5å“ˆå¸Œç®—æ³•
        self.hash = lambda x: int(hashlib.md5(x).hexdigest(), 16)
        self.count = 0

    def add(self, element):
        h = self.hash(element)
        idx = h % len(self.buckets)
        bucket = self.buckets[idx]
        old_len = len(bucket)
        bucket.add(element)
        if len(bucket) > old_len:
            # å¦‚æœæ•°é‡å˜åŒ–äº†ï¼Œæ€»æ•°å°±+1
            self.count += 1

    def remove(self, element):
        h = self.hash(element)
        idx = h % len(self.buckets)
        bucket = self.buckets[idx]
        old_len = len(bucket)
        bucket.remove(element)
        if len(bucket) < old_len:
            # å¦‚æœæ•°é‡å˜åŒ–äº†ï¼Œæ€»æ•°-1
            self.count -= 1


if __name__ == '__main__':
    c = ExactlyCounter()
    for i in range(100000):
        c.add("element_%d" % i)
    print c.count
    for i in range(100000):
        c.remove("element_%d" % i)
    print c.count
```

é›†åˆæ‰“æ•£å¹¶æ²¡æœ‰ä»€ä¹ˆæ˜æ˜¾å¥½å¤„ï¼Œå› ä¸ºæ€»çš„å†…å­˜å ç”¨å¹¶æ²¡æœ‰å‡å°‘ã€‚HyperLogLogè‚¯å®šä¸æ˜¯è¿™ä¸ªç®—æ³•ï¼Œå®ƒéœ€è¦å¯¹è¿™ä¸ªå°é›†åˆè¿›è¡Œä¼˜åŒ–ï¼Œå‹ç¼©å®ƒçš„å­˜å‚¨ç©ºé—´ï¼Œè®©å®ƒçš„å†…å­˜å˜å¾—éå¸¸å¾®å°ã€‚HyperLogLogç®—æ³•ä¸­æ¯ä¸ªæ¡¶æ‰€å ç”¨çš„ç©ºé—´å®é™…ä¸Šåªæœ‰ 6 ä¸ª bitï¼Œè¿™ 6 ä¸ª bit è‡ªç„¶æ˜¯æ— æ³•å®¹çº³æ¡¶ä¸­æ‰€æœ‰å…ƒç´ çš„ï¼Œå®ƒè®°å½•çš„æ˜¯æ¡¶ä¸­å…ƒç´ æ•°é‡çš„å¯¹æ•°å€¼ã€‚

ä¸ºäº†è¯´æ˜è¿™ä¸ªå¯¹æ•°å€¼å…·ä½“æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œæˆ‘ä»¬å…ˆæ¥è€ƒè™‘ä¸€ä¸ªå°é—®é¢˜ã€‚ä¸€ä¸ªéšæœºçš„æ•´æ•°å€¼ï¼Œè¿™ä¸ªæ•´æ•°çš„å°¾éƒ¨æœ‰ä¸€ä¸ª 0 çš„æ¦‚ç‡æ˜¯ 50%ï¼Œè¦ä¹ˆæ˜¯ 0 è¦ä¹ˆæ˜¯ 1ã€‚åŒæ ·ï¼Œå°¾éƒ¨æœ‰ä¸¤ä¸ª 0 çš„æ¦‚ç‡æ˜¯ 25%ï¼Œæœ‰ä¸‰ä¸ªé›¶çš„æ¦‚ç‡æ˜¯ 12.5%ï¼Œä»¥æ­¤ç±»æ¨ï¼Œæœ‰ k ä¸ª 0 çš„æ¦‚ç‡æ˜¯ 2^(-k)ã€‚å¦‚æœæˆ‘ä»¬éšæœºå‡ºäº†å¾ˆå¤šæ•´æ•°ï¼Œæ•´æ•°çš„æ•°é‡æˆ‘ä»¬å¹¶ä¸çŸ¥é“ï¼Œä½†æ˜¯æˆ‘ä»¬è®°å½•äº†æ•´æ•°å°¾éƒ¨è¿ç»­ 0 çš„æœ€å¤§æ•°é‡ Kã€‚æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™ä¸ª K æ¥è¿‘ä¼¼æ¨æ–­å‡ºæ•´æ•°çš„æ•°é‡ï¼Œè¿™ä¸ªæ•°é‡å°±æ˜¯ 2^Kã€‚

å½“ç„¶ç»“æœæ˜¯éå¸¸ä¸å‡†ç¡®çš„ï¼Œå› ä¸ºå¯èƒ½æ¥ä¸‹æ¥ä½ éšæœºäº†éå¸¸å¤šçš„æ•´æ•°ï¼Œä½†æ˜¯æœ«å°¾è¿ç»­é›¶çš„æœ€å¤§æ•°é‡ K æ²¡æœ‰å˜åŒ–ï¼Œä½†æ˜¯ä¼°è®¡å€¼è¿˜æ˜¯ 2^Kã€‚ä½ ä¹Ÿè®¸ä¼šæƒ³åˆ°è¦æ˜¯è¿™ä¸ª K æ˜¯ä¸ªæµ®ç‚¹æ•°å°±å¥½äº†ï¼Œæ¯æ¬¡éšæœºä¸€ä¸ªæ–°å…ƒç´ ï¼Œå®ƒéƒ½å¯ä»¥ç¨å¾®å¾€ä¸Šæ¶¨ä¸€ç‚¹ç‚¹ï¼Œé‚£ä¹ˆä¼°è®¡å€¼åº”è¯¥ä¼šå‡†ç¡®å¾ˆå¤šã€‚

HyperLogLogé€šè¿‡åˆ†é… 16384 ä¸ªæ¡¶ï¼Œç„¶åå¯¹æ‰€æœ‰çš„æ¡¶çš„æœ€å¤§æ•°é‡ K è¿›è¡Œè°ƒåˆå¹³å‡æ¥å¾—åˆ°ä¸€ä¸ªå¹³å‡çš„æœ«å°¾é›¶æœ€å¤§æ•°é‡ K# ï¼ŒK# æ˜¯ä¸€ä¸ªæµ®ç‚¹æ•°ï¼Œä½¿ç”¨å¹³å‡åçš„ 2^K# æ¥ä¼°è®¡å…ƒç´ çš„æ€»é‡ç›¸å¯¹è€Œè¨€å°±ä¼šå‡†ç¡®å¾ˆå¤šã€‚ä¸è¿‡è¿™åªæ˜¯ç®€åŒ–ç®—æ³•ï¼ŒçœŸå®çš„ç®—æ³•è¿˜æœ‰å¾ˆå¤šä¿®æ­£å› å­ï¼Œå› ä¸ºæ¶‰åŠåˆ°çš„æ•°å­¦ç†è®ºçŸ¥è¯†è¿‡äºç¹å¤šï¼Œè¿™é‡Œå°±ä¸å†ç²¾ç¡®æè¿°ã€‚

ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹Redis HyperLogLog ç®—æ³•çš„å…·ä½“å®ç°ã€‚æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªHyperLogLogå®é™…å ç”¨çš„ç©ºé—´å¤§çº¦æ˜¯ 13684 * 6bit / 8 = 12k å­—èŠ‚ã€‚ä½†æ˜¯åœ¨è®¡æ•°æ¯”è¾ƒå°çš„æ—¶å€™ï¼Œå¤§å¤šæ•°æ¡¶çš„è®¡æ•°å€¼éƒ½æ˜¯é›¶ã€‚å¦‚æœ 12k å­—èŠ‚é‡Œé¢å¤ªå¤šçš„å­—èŠ‚éƒ½æ˜¯é›¶ï¼Œé‚£ä¹ˆè¿™ä¸ªç©ºé—´æ˜¯å¯ä»¥é€‚å½“èŠ‚çº¦ä¸€ä¸‹çš„ã€‚Redis  åœ¨è®¡æ•°å€¼æ¯”è¾ƒå°çš„æƒ…å†µä¸‹é‡‡ç”¨äº†ç¨€ç–å­˜å‚¨ï¼Œç¨€ç–å­˜å‚¨çš„ç©ºé—´å ç”¨è¿œè¿œå°äº 12k å­—èŠ‚ã€‚ç›¸å¯¹äºç¨€ç–å­˜å‚¨çš„å°±æ˜¯å¯†é›†å­˜å‚¨ï¼Œå¯†é›†å­˜å‚¨ä¼šæ’å®šå ç”¨ 12k å­—èŠ‚ã€‚

## å¯†é›†å­˜å‚¨ç»“æ„

ä¸è®ºæ˜¯ç¨€ç–å­˜å‚¨è¿˜æ˜¯å¯†é›†å­˜å‚¨ï¼ŒRedis å†…éƒ¨éƒ½æ˜¯ä½¿ç”¨å­—ç¬¦ä¸²ä½å›¾æ¥å­˜å‚¨ HyperLogLog æ‰€æœ‰æ¡¶çš„è®¡æ•°å€¼ã€‚å¯†é›†å­˜å‚¨çš„ç»“æ„éå¸¸ç®€å•ï¼Œå°±æ˜¯è¿ç»­ 16384 ä¸ª 6bit ä¸²æˆçš„å­—ç¬¦ä¸²ä½å›¾ã€‚

![](https://user-gold-cdn.xitu.io/2018/8/31/1658e5b7a96f3b21?w=1820&h=266&f=png&s=34418)

é‚£ä¹ˆç»™å®šä¸€ä¸ªæ¡¶ç¼–å·ï¼Œå¦‚ä½•è·å–å®ƒçš„ 6bit è®¡æ•°å€¼å‘¢ï¼Ÿè¿™ 6bit å¯èƒ½åœ¨ä¸€ä¸ªå­—èŠ‚å†…éƒ¨ï¼Œä¹Ÿå¯èƒ½ä¼šè·¨è¶Šå­—èŠ‚è¾¹ç•Œã€‚æˆ‘ä»¬éœ€è¦å¯¹è¿™ä¸€ä¸ªæˆ–è€…ä¸¤ä¸ªå­—èŠ‚è¿›è¡Œé€‚å½“çš„ç§»ä½æ‹¼æ¥æ‰å¯ä»¥å¾—åˆ°è®¡æ•°å€¼ã€‚

å‡è®¾æ¡¶çš„ç¼–å·ä¸ºidxï¼Œè¿™ä¸ª 6bit è®¡æ•°å€¼çš„èµ·å§‹å­—èŠ‚ä½ç½®åç§»ç”¨ offset_bytesè¡¨ç¤ºï¼Œå®ƒåœ¨è¿™ä¸ªå­—èŠ‚çš„èµ·å§‹æ¯”ç‰¹ä½ç½®åç§»ç”¨ offset_bits è¡¨ç¤ºã€‚æˆ‘ä»¬æœ‰

```py
offset_bytes = (idx * 6) / 8
offset_bits = (idx * 6) % 8
```

å‰è€…æ˜¯å•†ï¼Œåè€…æ˜¯ä½™æ•°ã€‚æ¯”å¦‚ bucket 2 çš„å­—èŠ‚åç§»æ˜¯ 1ï¼Œä¹Ÿå°±æ˜¯ç¬¬ 2 ä¸ªå­—èŠ‚ã€‚å®ƒçš„ä½åç§»æ˜¯4ï¼Œä¹Ÿå°±æ˜¯ç¬¬ 2 ä¸ªå­—èŠ‚çš„ç¬¬ 5 ä¸ªä½å¼€å§‹æ˜¯ bucket 2 çš„è®¡æ•°å€¼ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å­—èŠ‚ä½åºæ˜¯å·¦è¾¹ä½ä½å³è¾¹é«˜ä½ï¼Œè€Œé€šå¸¸æˆ‘ä»¬ä½¿ç”¨çš„å­—èŠ‚éƒ½æ˜¯å·¦è¾¹é«˜ä½å³è¾¹ä½ä½ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è„‘æµ·ä¸­è¿›è¡Œå€’ç½®ã€‚


![](https://user-gold-cdn.xitu.io/2018/8/31/1658e5c734cbb598?w=665&h=266&f=png&s=16211)

å¦‚æœ offset_bits å°äºç­‰äº 2ï¼Œé‚£ä¹ˆè¿™ 6bit  åœ¨ä¸€ä¸ªå­—èŠ‚å†…éƒ¨ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ä¸‹é¢çš„è¡¨è¾¾å¼å¾—åˆ°è®¡æ•°å€¼ val

![](https://user-gold-cdn.xitu.io/2018/8/31/1658e5d7661cc431?w=738&h=316&f=png&s=26669)

```py
val = buffer[offset_bytes] >> offset_bits  # å‘å³ç§»ä½
```

å¦‚æœ offset_bits å¤§äº 2ï¼Œé‚£ä¹ˆå°±ä¼šè·¨è¶Šå­—èŠ‚è¾¹ç•Œï¼Œè¿™æ—¶éœ€è¦æ‹¼æ¥ä¸¤ä¸ªå­—èŠ‚çš„ä½ç‰‡æ®µã€‚

![](https://user-gold-cdn.xitu.io/2018/8/31/1658e5e23c9067d9?w=959&h=570&f=png&s=54531)

```py
# ä½ä½å€¼
low_val = buffer[offset_bytes] >> offset_bits
# ä½ä½ä¸ªæ•°
low_bits = 8 - offset_bits
# æ‹¼æ¥ï¼Œä¿ç•™ä½6ä½
val = (high_val << low_bits | low_val) & 0b111111
```

ä¸è¿‡ä¸‹é¢ Redis çš„æºç è¦æ™¦æ¶©ä¸€ç‚¹ï¼Œçœ‹å½¢å¼å®ƒä¼¼ä¹åªè€ƒè™‘äº†è·¨è¶Šå­—èŠ‚è¾¹ç•Œçš„æƒ…å†µã€‚è¿™æ˜¯å› ä¸ºå¦‚æœ 6bit åœ¨å•ä¸ªå­—èŠ‚å†…ï¼Œä¸Šé¢ä»£ç ä¸­çš„ high_val çš„å€¼æ˜¯é›¶ï¼Œæ‰€ä»¥è¿™ä¸€ä»½ä»£ç å¯ä»¥åŒæ—¶ç…§é¡¾å•å­—èŠ‚å’ŒåŒå­—èŠ‚ã€‚

```c
// è·å–æŒ‡å®šæ¡¶çš„è®¡æ•°å€¼
#define HLL_DENSE_GET_REGISTER(target,p,regnum) do { \
    uint8_t *_p = (uint8_t*) p; \
    unsigned long _byte = regnum*HLL_BITS/8; \ 
    unsigned long _fb = regnum*HLL_BITS&7; \  # %8 = &7
    unsigned long _fb8 = 8 - _fb; \
    unsigned long b0 = _p[_byte]; \
    unsigned long b1 = _p[_byte+1]; \
    target = ((b0 >> _fb) | (b1 << _fb8)) & HLL_REGISTER_MAX; \
} while(0)

// è®¾ç½®æŒ‡å®šæ¡¶çš„è®¡æ•°å€¼
#define HLL_DENSE_SET_REGISTER(p,regnum,val) do { \
    uint8_t *_p = (uint8_t*) p; \
    unsigned long _byte = regnum*HLL_BITS/8; \
    unsigned long _fb = regnum*HLL_BITS&7; \
    unsigned long _fb8 = 8 - _fb; \
    unsigned long _v = val; \
    _p[_byte] &= ~(HLL_REGISTER_MAX << _fb); \
    _p[_byte] |= _v << _fb; \
    _p[_byte+1] &= ~(HLL_REGISTER_MAX >> _fb8); \
    _p[_byte+1] |= _v >> _fb8; \
} while(0)
```

## ç¨€ç–å­˜å‚¨ç»“æ„

ç¨€ç–å­˜å‚¨é€‚ç”¨äºå¾ˆå¤šè®¡æ•°å€¼éƒ½æ˜¯é›¶çš„æƒ…å†µã€‚ä¸‹å›¾è¡¨ç¤ºäº†ä¸€èˆ¬ç¨€ç–å­˜å‚¨è®¡æ•°å€¼çš„çŠ¶æ€ã€‚


![](https://user-gold-cdn.xitu.io/2018/8/31/1658e631c1730628?w=911&h=133&f=png&s=15943)

å½“å¤šä¸ªè¿ç»­æ¡¶çš„è®¡æ•°å€¼éƒ½æ˜¯é›¶æ—¶ï¼ŒRedis ä½¿ç”¨äº†ä¸€ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºæ¥ä¸‹æ¥æœ‰å¤šå°‘ä¸ªæ¡¶çš„è®¡æ•°å€¼éƒ½æ˜¯é›¶ï¼š00xxxxxxã€‚å‰ç¼€ä¸¤ä¸ªé›¶è¡¨ç¤ºæ¥ä¸‹æ¥çš„ 6bit æ•´æ•°å€¼åŠ  1 å°±æ˜¯é›¶å€¼è®¡æ•°å™¨çš„æ•°é‡ï¼Œæ³¨æ„è¿™é‡Œè¦åŠ  1 æ˜¯å› ä¸ºæ•°é‡å¦‚æœä¸ºé›¶æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚æ¯”å¦‚ 00010101è¡¨ç¤ºè¿ç»­ 22 ä¸ªé›¶å€¼è®¡æ•°å™¨ã€‚6bit æœ€å¤šåªèƒ½è¡¨ç¤ºè¿ç»­ 64 ä¸ªé›¶å€¼è®¡æ•°å™¨ï¼Œæ‰€ä»¥ Redis åˆè®¾è®¡äº†è¿ç»­å¤šä¸ªå¤šäº 64 ä¸ªçš„è¿ç»­é›¶å€¼è®¡æ•°å™¨ï¼Œå®ƒä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºï¼š01xxxxxx yyyyyyyyï¼Œåé¢çš„ 14bit å¯ä»¥è¡¨ç¤ºæœ€å¤šè¿ç»­ 16384 ä¸ªé›¶å€¼è®¡æ•°å™¨ã€‚è¿™æ„å‘³ç€ HyperLogLog æ•°æ®ç»“æ„ä¸­ 16384 ä¸ªæ¡¶çš„åˆå§‹çŠ¶æ€ï¼Œæ‰€æœ‰çš„è®¡æ•°å™¨éƒ½æ˜¯é›¶å€¼ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ 2 ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºã€‚

å¦‚æœè¿ç»­å‡ ä¸ªæ¡¶çš„è®¡æ•°å€¼éé›¶ï¼Œé‚£å°±ä½¿ç”¨å½¢å¦‚ 1vvvvvxx è¿™æ ·çš„ä¸€ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºã€‚ä¸­é—´ 5bit è¡¨ç¤ºè®¡æ•°å€¼ï¼Œå°¾éƒ¨ 2bit è¡¨ç¤ºè¿ç»­å‡ ä¸ªæ¡¶ã€‚å®ƒçš„æ„æ€æ˜¯è¿ç»­ ï¼ˆxx +1ï¼‰ ä¸ªè®¡æ•°å€¼éƒ½æ˜¯ ï¼ˆvvvvv + 1ï¼‰ã€‚æ¯”å¦‚ 10101011 è¡¨ç¤ºè¿ç»­ 4 ä¸ªè®¡æ•°å€¼éƒ½æ˜¯ 11ã€‚æ³¨æ„è¿™ä¸¤ä¸ªå€¼éƒ½éœ€è¦åŠ  1ï¼Œå› ä¸ºä»»æ„ä¸€ä¸ªæ˜¯é›¶éƒ½æ„å‘³ç€è¿™ä¸ªè®¡æ•°å€¼ä¸ºé›¶ï¼Œé‚£å°±åº”è¯¥ä½¿ç”¨é›¶è®¡æ•°å€¼çš„å½¢å¼æ¥è¡¨ç¤ºã€‚æ³¨æ„è®¡æ•°å€¼æœ€å¤§åªèƒ½è¡¨ç¤ºåˆ°32ï¼Œè€Œ HyperLogLog çš„å¯†é›†å­˜å‚¨å•ä¸ªè®¡æ•°å€¼ç”¨ 6bit è¡¨ç¤ºï¼Œæœ€å¤§å¯ä»¥è¡¨ç¤ºåˆ° 63ã€‚å½“ç¨€ç–å­˜å‚¨çš„æŸä¸ªè®¡æ•°å€¼éœ€è¦è°ƒæ•´åˆ°å¤§äº 32 æ—¶ï¼ŒRedis å°±ä¼šç«‹å³è½¬æ¢ HyperLogLog çš„å­˜å‚¨ç»“æ„ï¼Œå°†ç¨€ç–å­˜å‚¨è½¬æ¢æˆå¯†é›†å­˜å‚¨ã€‚

![](https://user-gold-cdn.xitu.io/2018/8/31/1658e626c4e3a697?w=792&h=146&f=png&s=17632)

Redis  ä¸ºäº†æ–¹ä¾¿è¡¨è¾¾ç¨€ç–å­˜å‚¨ï¼Œå®ƒå°†ä¸Šé¢ä¸‰ç§å­—èŠ‚è¡¨ç¤ºå½¢å¼åˆ†åˆ«èµ‹äºˆäº†ä¸€æ¡æŒ‡ä»¤ã€‚
1. ZERO:len å•ä¸ªå­—èŠ‚è¡¨ç¤º 00[len-1]ï¼Œè¿ç»­æœ€å¤š64ä¸ªé›¶è®¡æ•°å€¼
2. VAL:value,len å•ä¸ªå­—èŠ‚è¡¨ç¤º 1[value-1][len-1]ï¼Œè¿ç»­ len ä¸ªå€¼ä¸º value çš„è®¡æ•°å€¼
3. XZERO:len åŒå­—èŠ‚è¡¨ç¤º 01[len-1]ï¼Œè¿ç»­æœ€å¤š16384ä¸ªé›¶è®¡æ•°å€¼

```c
#define HLL_SPARSE_XZERO_BIT 0x40 /* 01xxxxxx */
#define HLL_SPARSE_VAL_BIT 0x80 /* 1vvvvvxx */
#define HLL_SPARSE_IS_ZERO(p) (((*(p)) & 0xc0) == 0) /* 00xxxxxx */
#define HLL_SPARSE_IS_XZERO(p) (((*(p)) & 0xc0) == HLL_SPARSE_XZERO_BIT)
#define HLL_SPARSE_IS_VAL(p) ((*(p)) & HLL_SPARSE_VAL_BIT)
#define HLL_SPARSE_ZERO_LEN(p) (((*(p)) & 0x3f)+1)
#define HLL_SPARSE_XZERO_LEN(p) (((((*(p)) & 0x3f) << 8) | (*((p)+1)))+1)
#define HLL_SPARSE_VAL_VALUE(p) ((((*(p)) >> 2) & 0x1f)+1)
#define HLL_SPARSE_VAL_LEN(p) (((*(p)) & 0x3)+1)
#define HLL_SPARSE_VAL_MAX_VALUE 32
#define HLL_SPARSE_VAL_MAX_LEN 4
#define HLL_SPARSE_ZERO_MAX_LEN 64
#define HLL_SPARSE_XZERO_MAX_LEN 16384
```

ä¸Šå›¾å¯ä»¥ä½¿ç”¨æŒ‡ä»¤å½¢å¼è¡¨ç¤ºå¦‚ä¸‹

![](https://user-gold-cdn.xitu.io/2018/8/31/1658e62bae79cfe5?w=766&h=158&f=png&s=22552)

## å­˜å‚¨è½¬æ¢

å½“è®¡æ•°å€¼è¾¾åˆ°ä¸€å®šç¨‹åº¦åï¼Œç¨€ç–å­˜å‚¨å°†ä¼šä¸å¯é€†ä¸€æ¬¡æ€§è½¬æ¢ä¸ºå¯†é›†å­˜å‚¨ã€‚è½¬æ¢çš„æ¡ä»¶æœ‰ä¸¤ä¸ªï¼Œä»»æ„ä¸€ä¸ªæ»¡è¶³å°±ä¼šç«‹å³å‘ç”Ÿè½¬æ¢
1. ä»»æ„ä¸€ä¸ªè®¡æ•°å€¼ä» 32 å˜æˆ 33ï¼Œå› ä¸ºVALæŒ‡ä»¤å·²ç»æ— æ³•å®¹çº³ï¼Œå®ƒèƒ½è¡¨ç¤ºçš„è®¡æ•°å€¼æœ€å¤§ä¸º 32
2. ç¨€ç–å­˜å‚¨å ç”¨çš„æ€»å­—èŠ‚æ•°è¶…è¿‡ 3000 å­—èŠ‚ï¼Œè¿™ä¸ªé˜ˆå€¼å¯ä»¥é€šè¿‡ hll_sparse_max_bytes å‚æ•°è¿›è¡Œè°ƒæ•´ã€‚

## è®¡æ•°ç¼“å­˜

å‰é¢æåˆ° HyperLogLog è¡¨ç¤ºçš„æ€»è®¡æ•°å€¼æ˜¯ç”± 16384 ä¸ªæ¡¶çš„è®¡æ•°å€¼è¿›è¡Œè°ƒå’Œå¹³å‡åå†åŸºäºå› å­ä¿®æ­£å…¬å¼è®¡ç®—å¾—å‡ºæ¥çš„ã€‚å®ƒéœ€è¦éå†æ‰€æœ‰çš„æ¡¶è¿›è¡Œè®¡ç®—æ‰å¯ä»¥å¾—åˆ°è¿™ä¸ªå€¼ï¼Œä¸­é—´è¿˜æ¶‰åŠåˆ°å¾ˆå¤šæµ®ç‚¹è¿ç®—ã€‚è¿™ä¸ªè®¡ç®—é‡ç›¸å¯¹æ¥è¯´è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ã€‚

æ‰€ä»¥ Redis ä½¿ç”¨äº†ä¸€ä¸ªé¢å¤–çš„å­—æ®µæ¥ç¼“å­˜æ€»è®¡æ•°å€¼ï¼Œè¿™ä¸ªå­—æ®µæœ‰ 64bitï¼Œæœ€é«˜ä½å¦‚æœä¸º 1 è¡¨ç¤ºè¯¥å€¼æ˜¯å¦å·²ç»è¿‡æœŸï¼Œå¦‚æœä¸º 0ï¼Œ é‚£ä¹ˆå‰©ä¸‹çš„ 63bit å°±æ˜¯è®¡æ•°å€¼ã€‚

å½“ HyperLogLog ä¸­ä»»æ„ä¸€ä¸ªæ¡¶çš„è®¡æ•°å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°±ä¼šå°†è®¡æ•°ç¼“å­˜è®¾ä¸ºè¿‡æœŸï¼Œä½†æ˜¯ä¸ä¼šç«‹å³è§¦å‘è®¡ç®—ã€‚è€Œæ˜¯è¦ç­‰åˆ°ç”¨æˆ·æ˜¾ç¤ºè°ƒç”¨ pfcount æŒ‡ä»¤æ—¶æ‰ä¼šè§¦å‘é‡æ–°è®¡ç®—åˆ·æ–°ç¼“å­˜ã€‚ç¼“å­˜åˆ·æ–°åœ¨å¯†é›†å­˜å‚¨æ—¶éœ€è¦éå† 16384 ä¸ªæ¡¶çš„è®¡æ•°å€¼è¿›è¡Œè°ƒå’Œå¹³å‡ï¼Œä½†æ˜¯ç¨€ç–å­˜å‚¨æ—¶æ²¡æœ‰è¿™ä¹ˆå¤§çš„è®¡ç®—é‡ã€‚ä¹Ÿå°±æ˜¯è¯´åªæœ‰å½“è®¡æ•°å€¼æ¯”è¾ƒå¤§æ—¶æ‰å¯èƒ½äº§ç”Ÿè¾ƒå¤§çš„è®¡ç®—é‡ã€‚å¦ä¸€æ–¹é¢å¦‚æœè®¡æ•°å€¼æ¯”è¾ƒå¤§ï¼Œé‚£ä¹ˆå¤§éƒ¨åˆ† pfadd æ“ä½œæ ¹æœ¬ä¸ä¼šå¯¼è‡´æ¡¶ä¸­çš„è®¡æ•°å€¼å‘ç”Ÿå˜åŒ–ã€‚

è¿™æ„å‘³ç€åœ¨ä¸€ä¸ªæå…·å˜åŒ–çš„ HLL è®¡æ•°å™¨ä¸­é¢‘ç¹è°ƒç”¨ pfcount æŒ‡ä»¤å¯èƒ½ä¼šæœ‰å°‘è®¸æ€§èƒ½é—®é¢˜ã€‚å…³äºè¿™ä¸ªæ€§èƒ½æ–¹é¢çš„æ‹…å¿§åœ¨ Redis ä½œè€… antirez çš„åšå®¢ä¸­ä¹Ÿæåˆ°äº†ã€‚ä¸è¿‡ä½œè€…åšäº†ä»”ç»†çš„å‹åŠ›çš„æµ‹è¯•ï¼Œå‘ç°è¿™æ˜¯æ— éœ€æ‹…å¿ƒçš„ï¼Œpfcount æŒ‡ä»¤çš„å¹³å‡æ—¶é—´å¤æ‚åº¦å°±æ˜¯ O(1)ã€‚

> After this change even trying to add elements at maximum speed using a pipeline of 32 elements with 50 simultaneous clients, PFCOUNT was able to perform as well as any other O(1) command with very small constant times.

## å¯¹è±¡å¤´

HyperLogLog é™¤äº†éœ€è¦å­˜å‚¨ 16384 ä¸ªæ¡¶çš„è®¡æ•°å€¼ä¹‹å¤–ï¼Œå®ƒè¿˜æœ‰ä¸€äº›é™„åŠ çš„å­—æ®µéœ€è¦å­˜å‚¨ï¼Œæ¯”å¦‚æ€»è®¡æ•°ç¼“å­˜ã€å­˜å‚¨ç±»å‹ã€‚æ‰€ä»¥å®ƒä½¿ç”¨äº†ä¸€ä¸ªé¢å¤–çš„å¯¹è±¡å¤´æ¥è¡¨ç¤ºã€‚

```c
struct hllhdr {
    char magic[4];      /* é­”æœ¯å­—ç¬¦ä¸²"HYLL" */
    uint8_t encoding;   /* å­˜å‚¨ç±»å‹ HLL_DENSE or HLL_SPARSE. */
    uint8_t notused[3]; /* ä¿ç•™ä¸‰ä¸ªå­—èŠ‚æœªæ¥å¯èƒ½ä¼šä½¿ç”¨ */
    uint8_t card[8];    /* æ€»è®¡æ•°ç¼“å­˜ */
    uint8_t registers[]; /* æ‰€æœ‰æ¡¶çš„è®¡æ•°å™¨ */
};
```

æ‰€ä»¥ HyperLogLog æ•´ä½“çš„å†…éƒ¨ç»“æ„å°±æ˜¯ HLL å¯¹è±¡å¤´ åŠ ä¸Š 16384 ä¸ªæ¡¶çš„è®¡æ•°å€¼ä½å›¾ã€‚å®ƒåœ¨ Redis çš„å†…éƒ¨ç»“æ„è¡¨ç°å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ä½å›¾ã€‚ä½ å¯ä»¥æŠŠ HyperLogLog å¯¹è±¡å½“æˆæ™®é€šçš„å­—ç¬¦ä¸²æ¥è¿›è¡Œå¤„ç†ã€‚

```c
127.0.0.1:6379> pfadd codehole python java golang
(integer) 1
127.0.0.1:6379> get codehole
"HYLL\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80C\x03\x84MK\x80P\xb8\x80^\xf3"
```

ä½†æ˜¯ä¸å¯ä»¥ä½¿ç”¨ HyperLogLog æŒ‡ä»¤æ¥æ“çºµæ™®é€šçš„å­—ç¬¦ä¸²ï¼Œå› ä¸ºå®ƒéœ€è¦æ£€æŸ¥å¯¹è±¡å¤´é­”æœ¯å­—ç¬¦ä¸²æ˜¯å¦æ˜¯ "HYLL"ã€‚

```
127.0.0.1:6379> set codehole python
OK
127.0.0.1:6379> pfadd codehole java golang
(error) WRONGTYPE Key is not a valid HyperLogLog string value.
```

ä½†æ˜¯å¦‚æœå­—ç¬¦ä¸²ä»¥ "HYLL\x00" æˆ–è€… "HYLL\x01" å¼€å¤´ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨ HyperLogLog çš„æŒ‡ä»¤ã€‚

```
127.0.0.1:6379> set codehole "HYLL\x01whatmagicthing"
OK
127.0.0.1:6379> get codehole
"HYLL\x01whatmagicthing"
127.0.0.1:6379> pfadd codehole python java golang
(integer) 1
```

ä¹Ÿè®¸ä½ ä¼šæ„Ÿè§‰éå¸¸å¥‡æ€ªï¼Œè¿™æ˜¯å› ä¸º HyperLogLog åœ¨æ‰§è¡ŒæŒ‡ä»¤å‰éœ€è¦å¯¹å†…å®¹è¿›è¡Œæ ¼å¼æ£€æŸ¥ï¼Œè¿™ä¸ªæ£€æŸ¥å°±æ˜¯æŸ¥çœ‹å¯¹è±¡å¤´çš„ magic é­”æœ¯å­—ç¬¦ä¸²æ˜¯å¦æ˜¯ "HYLL" ä»¥åŠ encoding å­—æ®µæ˜¯å¦æ˜¯ HLL_SPARSE=0 æˆ–è€… HLL_DENSE=1 æ¥åˆ¤æ–­å½“å‰çš„å­—ç¬¦ä¸²æ˜¯å¦æ˜¯ HyperLogLog è®¡æ•°å™¨ã€‚å¦‚æœæ˜¯å¯†é›†å­˜å‚¨ï¼Œè¿˜éœ€è¦åˆ¤æ–­å­—ç¬¦ä¸²çš„é•¿åº¦æ˜¯å¦æ°å¥½ç­‰äºå¯†é›†è®¡æ•°å™¨å­˜å‚¨çš„é•¿åº¦ã€‚

```c
int isHLLObjectOrReply(client *c, robj *o) {
    ...
    /* Magic should be "HYLL". */
    if (hdr->magic[0] != 'H' || hdr->magic[1] != 'Y' ||
        hdr->magic[2] != 'L' || hdr->magic[3] != 'L') goto invalid;

    if (hdr->encoding > HLL_MAX_ENCODING) goto invalid;

    if (hdr->encoding == HLL_DENSE &&
        stringObjectLen(o) != HLL_DENSE_SIZE) goto invalid;

    return C_OK;

invalid:
    addReplySds(c,
        sdsnew("-WRONGTYPE Key is not a valid "
               "HyperLogLog string value.\r\n"));
    return C_ERR;
}
```


HyperLogLog å’Œ å­—ç¬¦ä¸²çš„å…³ç³»å°±å¥½æ¯” Geo å’Œ zset çš„å…³ç³»ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä»»æ„ zset çš„æŒ‡ä»¤æ¥è®¿é—® Geo æ•°æ®ç»“æ„ï¼Œå› ä¸º Geo å†…éƒ¨å­˜å‚¨å°±æ˜¯ä½¿ç”¨äº†ä¸€ä¸ªçº¯ç²¹çš„ zsetæ¥è®°å½•å…ƒç´ çš„åœ°ç†ä½ç½®ã€‚
# å°¾å£°ï¼šç™¾å°ºç«¿å¤´ â€”â€” ç»§ç»­æ·±é€ æŒ‡å—


![](https://user-gold-cdn.xitu.io/2018/7/18/164ab7d6ee8ca3b1?w=400&h=320&f=gif&s=1548139)

Redis æ¶‰åŠçš„çŸ¥è¯†ç‚¹æ˜¯éå¸¸ç¹å¤šçš„ï¼Œè™½ç„¶è€é’±å·²ç»ç–¯ç‹‚æ‰©å……äº†ä¸å°‘è¿›é˜¶å’Œå‹ç®±åº•çš„å†…å®¹ï¼Œä½†æœ¬å°å†Œä¾ç„¶æ— æ³•é¡¾åŠåˆ° Redis çš„æ–¹æ–¹é¢é¢ï¼Œå¯¹äºé‚£äº›æ¸´æœ›è¿›ä¸€æ­¥æ‹“å±•çŸ¥è¯†çš„åŒå­¦ï¼Œåœ¨è¿™é‡Œåšä¸€äº›ç²¾å“å­¦ä¹ èµ„æºæ¨èã€‚

## å‚è€ƒèµ„æ–™

### 1. å›½å†… 90 åæŠ€æœ¯å¤§ç¥é»„å¥å®çš„è‘—ä½œ[ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹](http://redisbook.com/)

![](https://user-gold-cdn.xitu.io/2018/7/9/1647e89d39a25ede?w=350&h=350&f=jpeg&s=17529)

é»„å¥å®è€å¸ˆå†™çš„è¿™æœ¬ã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹æ˜¯è€é’±é¦–æ¨çš„ä¸€æœ¬ Redis å‚è€ƒä¹¦ç±ï¼Œå®ƒä¹Ÿæ˜¯æ¯ä¸€ä½æ¥åˆ°æŒé˜…çš„åç«¯å°ä¼™ä¼´å¿…é¡»è¦çœ‹çš„ä¸€æœ¬ä¹¦ã€‚

æŠŠè¿™æœ¬ä¹¦åƒé€åï¼Œä½ ä¼šæ˜æ˜¾æ„Ÿè§‰åˆ°åŠŸåŠ›å¤§å¢ã€‚ä»¥ååœ¨å·¥ä½œä¸­é‡åˆ°äº† Redis ç›¸å…³çš„é—®é¢˜ï¼Œä½ æ€»ä¼šæƒ³ä»è¿™æœ¬ä¹¦ä¸­æ‰¾åˆ°ç­”æ¡ˆã€‚

### 2. Redis å®˜ç½‘ & Redis ä½œè€… Antirez çš„ Blog

æˆ‘è¿˜è¦éš†é‡æ¨èä¸‹ Redis çš„å®˜ç½‘å’Œ Redis ä½œè€… Antirez çš„ Blogï¼Œåœ¨è¿™é‡Œï¼Œä½ å¯ä»¥è·å–å®˜æ–¹æƒå¨èµ„æ–™å’Œæœ€æ–°ä¿¡æ¯ã€‚

#### [Redis å®˜ç½‘](https://redis.io)

Redis å®˜ç½‘æ–‡æ¡£éå¸¸ä¸°å¯Œï¼Œå®ƒçš„æ–‡æ¡£éå¸¸å€¼å¾—å•ƒã€‚å¦‚æœä½ çš„è‹±æ–‡ä¸ä½³ï¼Œå¯ä»¥å»çœ‹çœ‹ä¸­æ–‡ Redis ç½‘ç«™ã€‚Redis å®˜ç½‘çš„ç²¾åæ–‡ç« éƒ½åœ¨é¡¶éƒ¨å¯¼èˆª [Documentation](https://redis.io/documentation) é“¾æ¥ä¸­ã€‚

#### [Antirez åšå®¢](http://antirez.com/latest/0)

Redis ä½œè€… Antirez å¤§ä½¬çš„åšå®¢æœ‰å¾ˆå¤šå…³äº Redis çš„æœ€æ–°æ¶ˆæ¯ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜ä¼šæœ‰ä¸€äº›ä½œè€…æ–°å‘ç°çš„ã€å¥½ç©çš„æŠ€æœ¯çŸ¥è¯†ç‚¹ã€‚

#### [Redis æ‰©å±•æ¨¡å—](https://redis.io/modules)

Redis 4.0 å¢åŠ äº†æ¨¡å—åŒ–ä¹‹åï¼Œè¶Šæ¥è¶Šå¤šçš„ Redis æ¨¡å—é›¨åæ˜¥ç¬‹èˆ¬çš„è¢«å¼€å‘å‡ºæ¥ã€‚è¿™ä¸ªé¡µé¢åŒ…å«äº†å¼€æºå¸‚åœºä¸Šæ‰€æœ‰çš„ Redis æ¨¡å—åˆ—è¡¨ï¼Œæœ‰ä¸€äº›æ¨¡å—æ¯”è¾ƒç¨³å®šï¼Œè¿˜æœ‰ä¸€äº›å¤„äº Alpha é˜¶æ®µã€‚è¯»è€…å¯ä»¥ä»ä¸­æŒ‘é€‰å‡ºè‡ªå·±æ„Ÿå…´è¶£çš„æ¨¡å—ç ”ç©¶å­¦ä¹ ã€‚

### 3. æœ€è¿‘çœ‹åˆ°ä¸€ç¯‡è´¨é‡å¾ˆé«˜çš„åšå®¢æ–‡ç«  [ã€ŠRedis: under the hoodã€‹](https://pauladamsmith.com/articles/redis-under-the-hood.html)
è¿™ç¯‡åšæ–‡æ˜¯è€å¤–å†™çš„ï¼Œå€¼å¾—æœ‰è‹±è¯­èƒ½åŠ›çš„åŒå­¦å­¦ä¹ ã€‚è¿™ç¯‡æ–‡ç« ä¼šå¸¦ä½ ä¸€æ­¥æ­¥å­¦ä¼šå¦‚ä½•é˜…è¯» Redis çš„æºç ï¼Œæœ‰ä¸€å®šçš„éš¾åº¦ï¼Œä¸è¿‡æ•´ä½“æ¥è¯´è¿˜ç®—é€šä¿—æ˜“æ‡‚ã€‚æ–‡ç« ä¸­ vm ç›¸å…³ä»£ç ç‰‡æ®µä¸ç”¨å»ç†ä¼šï¼Œè¿™ä¸ªåŠŸèƒ½å¾ˆæ—©å°±è¢« Redis å®˜æ–¹åºŸå¼ƒäº†ã€‚

### 4. è€é’±çš„å¦ä¸€æœ¬å°å†Œï¼š[ã€Šæ·±å…¥ç†è§£ RPC : åŸºäº Python è‡ªå»ºåˆ†å¸ƒå¼é«˜å¹¶å‘ RPC æœåŠ¡ã€‹](https://juejin.im/book/5af56a3c518825426642e004) 
è¦æˆä¸ºåç«¯é«˜æ‰‹ï¼Œæœ€é«˜æ•ˆçš„è·¯å¾„å°±æ˜¯æŒæ¡ã€Œé€ è½®å­ã€å­¦ä¹ æ³•ã€‚è¿™æœ¬ RPC å°å†Œä¹Ÿæ˜¯è€é’±çš„å¤„å¥³ä½œï¼Œæ•™ä½ é€šè¿‡è‡ªå»º RPC æœåŠ¡ï¼Œæ·±å…¥ç†è§£åˆ†å¸ƒå¼é«˜å¹¶å‘åŸç†ä¸å®è·µï¼Œä¹Ÿæ¨èç»™åç«¯åŒå­¦ã€‚

![](https://user-gold-cdn.xitu.io/2018/6/11/163edff00241d286?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

### 5. è€é’±çš„ä¸“æ 

æœ€åï¼Œå‹æƒ…æ¨èä¸‹è€é’±è‡ªå·±çš„æŠ€æœ¯å…¬ä¼—å·ã€Œç æ´ã€ï¼Œå†…éƒ¨æœ‰éå¸¸å¤šçš„åŸåˆ›æŠ€æœ¯æ–‡ç« å€¼å¾—ä¸€çœ‹ï¼Œè€é’±åç»­çš„æœ€æ–°åŸåˆ›ä¹Ÿä¼šåŒæ­¥åœ¨å¾®ä¿¡å…¬ä¼—å·ä¸­ã€‚ä½¿ç”¨å¾®ä¿¡æ‰«ä¸€æ‰«ä¸‹é¢çš„äºŒç»´ç å³å¯å…¥æ´ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/9/1647e959be074ee0?w=258&h=258&f=jpeg&s=27484)

## äº¤æµäº’åŠ¨

å¦‚æœè¯»è€…è¿˜æœ‰å¾ˆå¤šç–‘é—®ï¼Œå°±å»å°å†Œè¯»è€…ç¾¤é‡Œé¢éšæ„æé—®å§ï¼Œä¸è¯¸å¤šåŒè¡Œè¿›è¡Œå‹å¥½äº¤æµï¼Œç›¸ä¿¡ä½ ä¼šæˆé•¿æ›´å¿«ã€‚



